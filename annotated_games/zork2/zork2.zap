	.INSERT "./annotated_games/zork2/zork2_freq"
	.INSERT "./annotated_games/zork2/zork2_data"

	.FUNCT MAIN-LOOP,TRASH
?L1:	CALL MAIN-LOOP-1 >TRASH
	JUMP ?L1

	.FUNCT MAIN-LOOP-1,ICNT,OCNT,NUM,CNT,OBJ,TBL,V,PTBL,OBJ1,TMP,O,I
	SET 'CNT,0
	SET 'OBJ,0
	SET 'PTBL,1
	CALL PARSER >P-WON
	ZERO? P-WON /?L1
	GET P-PRSI,P-MATCHLEN >ICNT
	GET P-PRSO,P-MATCHLEN >OCNT
	ZERO? P-IT-OBJECT /?L3
	CALL ACCESSIBLE?,P-IT-OBJECT >STACK
	ZERO? STACK /?L3
	SET 'TMP,0
?L5:	IGRTR? 'CNT,ICNT /?L6
	GET P-PRSI,CNT >STACK
	EQUAL? STACK,IT \?L5
	PUT P-PRSI,CNT,P-IT-OBJECT
	SET 'TMP,1
?L6:	ZERO? TMP \?L16
	SET 'CNT,0
?L15:	IGRTR? 'CNT,OCNT /?L16
	GET P-PRSO,CNT >STACK
	EQUAL? STACK,IT \?L15
	PUT P-PRSO,CNT,P-IT-OBJECT
?L16:	SET 'CNT,0
?L3:	ZERO? OCNT \?L25
	SET 'NUM,OCNT
	JUMP ?L32
?L25:	GRTR? OCNT,1 \?L27
	SET 'TBL,P-PRSO
	ZERO? ICNT \?L28
	SET 'OBJ,0
	JUMP ?L30
?L28:	GET P-PRSI,1 >OBJ
?L30:	SET 'NUM,OCNT
	JUMP ?L32
?L27:	GRTR? ICNT,1 \?L31
	SET 'PTBL,0
	SET 'TBL,P-PRSI
	GET P-PRSO,1 >OBJ
	SET 'NUM,ICNT
	JUMP ?L32
?L31:	SET 'NUM,1
?L32:	ZERO? OBJ \?L33
	EQUAL? ICNT,1 \?L33
	GET P-PRSI,1 >OBJ
?L33:	EQUAL? PRSA,V?WALK \?L36
	ZERO? P-WALK-DIR /?L36
	CALL PERFORM,PRSA,PRSO >V
	JUMP ?L52
?L36:	ZERO? NUM \?L38
	GETB P-SYNTAX,P-SBITS >STACK
	BAND STACK,P-SONUMS >STACK
	ZERO? STACK \?L39
	CALL PERFORM,PRSA >V
	SET 'PRSO,0
	JUMP ?L52
?L39:	ZERO? LIT \?L41
	PRINTI "It's too dark to see."
	CRLF
	JUMP ?L52
?L41:	PRINTI "It's not clear what you're referring to."
	CRLF
	SET 'V,0
	JUMP ?L52
?L38:	SET 'P-NOT-HERE,0
	SET 'P-MULT,0
	GRTR? NUM,1 \?L48
	SET 'P-MULT,1
?L48:	SET 'TMP,0
?L51:	IGRTR? 'CNT,NUM \?L53
	GRTR? P-NOT-HERE,0 \?L55
	PRINTI "The "
	EQUAL? P-NOT-HERE,NUM /?L59
	PRINTI "other "
?L59:	PRINTI "object"
	EQUAL? P-NOT-HERE,1 /?L66
	PRINTI "s"
?L66:	PRINTI " that you mentioned "
	EQUAL? P-NOT-HERE,1 /?L73
	PRINTI "are"
	JUMP ?L77
?L73:	PRINTI "is"
?L77:	PRINTI "n't here."
	CRLF
	JUMP ?L52
?L55:	ZERO? TMP \?L52
	PRINTI "There's nothing here you can take."
	CRLF
	JUMP ?L52
?L53:	ZERO? PTBL /?L87
	GET P-PRSO,CNT >OBJ1
	JUMP ?L89
?L87:	GET P-PRSI,CNT >OBJ1
?L89:	ZERO? PTBL /?L90
	SET 'O,OBJ1
	JUMP ?L92
?L90:	SET 'O,OBJ
?L92:	ZERO? PTBL /?L93
	SET 'I,OBJ
	JUMP ?L95
?L93:	SET 'I,OBJ1
?L95:	GRTR? NUM,1 /?L98
	GET P-ITBL,P-NC1 >STACK
	GET STACK,0 >STACK
	EQUAL? STACK,W?ALL \?L105
?L98:	LOC WINNER >V
	EQUAL? O,NOT-HERE-OBJECT \?L99
	INC 'P-NOT-HERE
	JUMP ?L51
?L99:	EQUAL? PRSA,V?TAKE \?L101
	ZERO? I /?L101
	GET P-ITBL,P-NC1 >STACK
	GET STACK,0 >STACK
	EQUAL? STACK,W?ALL \?L101
	IN? O,I \?L51
?L101:	EQUAL? P-GETFLAGS,P-ALL \?L102
	EQUAL? PRSA,V?TAKE \?L102
	LOC O >STACK
	EQUAL? STACK,WINNER,HERE,V /?L104
	LOC O >STACK
	EQUAL? STACK,I /?L104
	LOC O >STACK
	FSET? STACK,SURFACEBIT \?L51
?L104:	FSET? O,TAKEBIT /?L102
	FSET? O,TRYTAKEBIT \?L51
?L102:	EQUAL? OBJ1,IT \?L106
	PRINTD P-IT-OBJECT
	JUMP ?L108
?L106:	PRINTD OBJ1
?L108:	PRINTI ": "
?L105:	SET 'PRSO,O
	SET 'PRSI,I
	SET 'TMP,1
	CALL PERFORM,PRSA,PRSO,PRSI >V
	EQUAL? V,M-FATAL \?L51
?L52:	EQUAL? V,M-FATAL /?L129
	LOC WINNER >STACK
	GETP STACK,P?ACTION >STACK
	CALL STACK,M-END >V
	EQUAL? V,M-FATAL \?L121
?L129:	SET 'P-CONT,0
	JUMP ?L121
?L1:	SET 'P-CONT,0
?L121:	CALL NULL-F
	ZERO? P-WON /FALSE
	EQUAL? PRSA,V?SUPER-BRIEF,V?BRIEF,V?TELL /TRUE
	EQUAL? PRSA,V?VERSION,V?SAVE,V?VERBOSE /TRUE
	EQUAL? PRSA,V?SCORE,V?RESTART,V?QUIT /TRUE
	EQUAL? PRSA,V?RESTORE,V?UNSCRIPT,V?SCRIPT /TRUE
	CALL CLOCKER >V
	RETURN V

	.FUNCT PERFORM,A,O=0,I=0,V,OA,OO,OI
	SET 'OA,PRSA
	SET 'OO,PRSO
	SET 'OI,PRSI
	EQUAL? IT,I,O \?L1
	CALL ACCESSIBLE?,P-IT-OBJECT >STACK
	ZERO? STACK \?L1
	PRINTI "I don't see what you are referring to."
	CRLF
	RETURN 2
?L1:	EQUAL? O,IT \?L8
	SET 'O,P-IT-OBJECT
?L8:	EQUAL? I,IT \?L11
	SET 'I,P-IT-OBJECT
?L11:	SET 'PRSA,A
	SET 'PRSO,O
	ZERO? PRSO /?L14
	EQUAL? PRSI,IT /?L14
	EQUAL? PRSA,V?WALK /?L14
	SET 'P-IT-OBJECT,PRSO
?L14:	SET 'PRSI,I
	EQUAL? NOT-HERE-OBJECT,PRSO,PRSI \?L17
	CALL NOT-HERE-OBJECT-F >V
	ZERO? V \?L27
?L17:	SET 'O,PRSO
	SET 'I,PRSI
	GETP WINNER,P?ACTION >STACK
	CALL STACK >V
	ZERO? V \?L27
	LOC WINNER >STACK
	GETP STACK,P?ACTION >STACK
	CALL STACK,M-BEG >V
	ZERO? V \?L27
	GET PREACTIONS,A >STACK
	CALL STACK >V
	ZERO? V \?L27
	ZERO? I /?L24
	GETP I,P?ACTION >STACK
	CALL STACK >V
	ZERO? V \?L27
?L24:	ZERO? O /?L26
	EQUAL? A,V?WALK /?L25
	LOC O >STACK
	ZERO? STACK /?L25
	LOC O >STACK
	GETP STACK,P?CONTFCN >STACK
	CALL STACK >V
	ZERO? V \?L27
?L25:	ZERO? O /?L26
	EQUAL? A,V?WALK /?L26
	GETP O,P?ACTION >STACK
	CALL STACK >V
	ZERO? V \?L27
?L26:	GET ACTIONS,A >STACK
	CALL STACK >V
	ZERO? V /?L27
?L27:	SET 'PRSA,OA
	SET 'PRSO,OO
	SET 'PRSI,OI
	RETURN V

	.FUNCT QUEUE,RTN,TICK,CINT
	CALL INT,RTN >CINT
	PUT CINT,C-TICK,TICK
	RETURN CINT

	.FUNCT INT,RTN,DEMON=0,E,C,INT?1
	ADD C-TABLE,C-TABLELEN >E
	ADD C-TABLE,C-INTS >C
?L1:	EQUAL? C,E \?L3
	SUB C-INTS,C-INTLEN >C-INTS
	ZERO? DEMON /?L5
	SUB C-DEMONS,C-INTLEN >C-DEMONS
?L5:	ADD C-TABLE,C-INTS >INT?1
	PUT INT?1,C-RTN,RTN
	RETURN INT?1
?L3:	GET C,C-RTN >STACK
	EQUAL? STACK,RTN \?L7
	RETURN C
?L7:	ADD C,C-INTLEN >C
	JUMP ?L1

	.FUNCT CLOCKER,C,E,TICK,FLG=0
	ZERO? CLOCK-WAIT /?L1
	SET 'CLOCK-WAIT,0
	RFALSE
?L1:	ZERO? P-WON /?L4
	PUSH C-INTS
	JUMP ?L6
?L4:	PUSH C-DEMONS
?L6:	ADD C-TABLE,STACK >C
	ADD C-TABLE,C-TABLELEN >E
?L7:	EQUAL? C,E \?L9
	INC 'MOVES
	RETURN FLG
?L9:	GET C,C-ENABLED? >STACK
	ZERO? STACK /?L15
	GET C,C-TICK >TICK
	ZERO? TICK /?L15
	SUB TICK,1 >STACK
	PUT C,C-TICK,STACK
	GRTR? TICK,1 /?L15
	GET C,C-RTN >STACK
	CALL STACK >STACK
	ZERO? STACK /?L15
	SET 'FLG,1
?L15:	ADD C,C-INTLEN >C
	JUMP ?L7

	.FUNCT PARSER,PTR=P-LEXSTART,WRD,VAL=0,VERB=0,OF-FLAG=0,OWINNER,OMERGED,LEN,DIR=0,NW=0,LW=0,CNT=-1
?L1:	IGRTR? 'CNT,P-ITBLLEN /?L2
	ZERO? P-OFLAG \?L6
	GET P-ITBL,CNT >STACK
	PUT P-OTBL,CNT,STACK
?L6:	PUT P-ITBL,CNT,0
	JUMP ?L1
?L2:	SET 'OWINNER,WINNER
	SET 'OMERGED,P-MERGED
	SET 'P-ADVERB,0
	SET 'P-MERGED,0
	SET 'P-END-ON-PREP,0
	PUT P-PRSO,P-MATCHLEN,0
	PUT P-PRSI,P-MATCHLEN,0
	PUT P-BUTS,P-MATCHLEN,0
	ZERO? QUOTE-FLAG \?L9
	EQUAL? WINNER,PLAYER /?L9
	SET 'WINNER,PLAYER
	CALL META-LOC,PLAYER >HERE
	CALL LIT?,HERE >LIT
?L9:	ZERO? RESERVE-PTR /?L12
	SET 'PTR,RESERVE-PTR
	CALL STUFF,RESERVE-LEXV,P-LEXV
	ZERO? SUPER-BRIEF \?L14
	EQUAL? PLAYER,WINNER \?L14
	CRLF
?L14:	SET 'RESERVE-PTR,0
	SET 'P-CONT,0
	JUMP ?L21
?L12:	ZERO? P-CONT /?L17
	SET 'PTR,P-CONT
	ZERO? SUPER-BRIEF \?L18
	EQUAL? PLAYER,WINNER \?L18
	EQUAL? PRSA,V?SAY /?L18
	CRLF
?L18:	SET 'P-CONT,0
	JUMP ?L21
?L17:	SET 'WINNER,PLAYER
	SET 'QUOTE-FLAG,0
	LOC WINNER >STACK
	FSET? STACK,VEHBIT /?L22
	LOC WINNER >HERE
?L22:	CALL LIT?,HERE >LIT
	ZERO? SUPER-BRIEF \?L25
	CRLF
?L25:	PRINTI ">"
	READ P-INBUF,P-LEXV
?L21:	GETB P-LEXV,P-LEXWORDS >P-LEN
	ZERO? P-LEN \?L30
	PRINTI "I beg your pardon?"
	CRLF
	RFALSE
?L30:	GET P-LEXV,PTR >WRD
	EQUAL? WRD,W?OOPS \?L35
	ADD PTR,P-LEXELEN >STACK
	GET P-LEXV,STACK >STACK
	EQUAL? STACK,W?$PERIOD,W?$COMMA \?L37
	ADD PTR,P-LEXELEN >PTR
	DEC 'P-LEN
?L37:	GRTR? P-LEN,1 /?L40
	PRINTI "I can't help your clumsiness."
	CRLF
	RFALSE
?L40:	GET OOPS-TABLE,O-PTR >STACK
	ZERO? STACK /?L44
	GRTR? P-LEN,2 \?L49
	ADD PTR,P-LEXELEN >STACK
	GET P-LEXV,STACK >STACK
	EQUAL? STACK,W?$QUOTE \?L45
	PRINTI "Sorry, you can't correct mistakes in quoted text."
	CRLF
	RFALSE
?L45:	GRTR? P-LEN,2 \?L49
	PRINTI "Warning: only the first word after OOPS is used."
	CRLF
?L49:	ADD PTR,P-LEXELEN >STACK
	GET P-LEXV,STACK >STACK
	GET OOPS-TABLE,O-PTR >STACK
	PUT AGAIN-LEXV,STACK,STACK
	SET 'WINNER,OWINNER
	GET OOPS-TABLE,O-PTR >STACK
	MUL STACK,P-LEXELEN >STACK
	ADD STACK,3 >STACK
	MUL PTR,P-LEXELEN >STACK
	ADD STACK,7 >STACK
	GETB P-LEXV,STACK >STACK
	MUL PTR,P-LEXELEN >STACK
	ADD STACK,6 >STACK
	GETB P-LEXV,STACK >STACK
	CALL INBUF-ADD,STACK,STACK,STACK
	CALL STUFF,AGAIN-LEXV,P-LEXV
	GETB P-LEXV,P-LEXWORDS >P-LEN
	GET OOPS-TABLE,O-START >PTR
	CALL INBUF-STUFF,OOPS-INBUF,P-INBUF
	JUMP ?L56
?L44:	PUT OOPS-TABLE,O-END,0
	PRINTI "There was no word to replace!"
	CRLF
	RFALSE
?L35:	EQUAL? WRD,W?AGAIN,W?G /?L57
	SET 'P-NUMBER,0
?L57:	PUT OOPS-TABLE,O-END,0
?L56:	GET P-LEXV,PTR >STACK
	EQUAL? STACK,W?AGAIN,W?G \?L60
	GETB OOPS-INBUF,1 >STACK
	ZERO? STACK \?L62
	PRINTI "Beg pardon?"
	CRLF
	RFALSE
?L62:	ZERO? P-OFLAG /?L66
	PRINTI "It's difficult to repeat fragments."
	CRLF
	RFALSE
?L66:	ZERO? P-WON \?L69
	PRINTI "That would just repeat a mistake."
	CRLF
	RFALSE
?L69:	GRTR? P-LEN,1 \?L72
	ADD PTR,P-LEXELEN >STACK
	GET P-LEXV,STACK >STACK
	EQUAL? STACK,W?$PERIOD,W?$COMMA,W?THEN /?L75
	ADD PTR,P-LEXELEN >STACK
	GET P-LEXV,STACK >STACK
	EQUAL? STACK,W?AND \?L73
?L75:	ADD PTR,4 >PTR
	GETB P-LEXV,P-LEXWORDS >STACK
	SUB STACK,2 >STACK
	PUTB P-LEXV,P-LEXWORDS,STACK
	JUMP ?L79
?L73:	PRINTI "I couldn't understand that sentence."
	CRLF
	RFALSE
?L72:	ADD PTR,P-LEXELEN >PTR
	GETB P-LEXV,P-LEXWORDS >STACK
	DEC 'STACK
	PUTB P-LEXV,P-LEXWORDS,STACK
?L79:	GETB P-LEXV,P-LEXWORDS >STACK
	GRTR? STACK,0 \?L80
	CALL STUFF,P-LEXV,RESERVE-LEXV
	SET 'RESERVE-PTR,PTR
	JUMP ?L82
?L80:	SET 'RESERVE-PTR,0
?L82:	SET 'WINNER,OWINNER
	SET 'P-MERGED,OMERGED
	CALL INBUF-STUFF,OOPS-INBUF,P-INBUF
	CALL STUFF,AGAIN-LEXV,P-LEXV
	SET 'CNT,-1
	SET 'DIR,AGAIN-DIR
?L83:	IGRTR? 'CNT,P-ITBLLEN /?L90
	GET P-OTBL,CNT >STACK
	PUT P-ITBL,CNT,STACK
	JUMP ?L83
?L60:	CALL STUFF,P-LEXV,AGAIN-LEXV
	CALL INBUF-STUFF,P-INBUF,OOPS-INBUF
	PUT OOPS-TABLE,O-START,PTR
	MUL 4,P-LEN >STACK
	PUT OOPS-TABLE,O-LENGTH,STACK
	GETB P-LEXV,P-LEXWORDS >STACK
	MUL P-LEXELEN,STACK >STACK
	ADD PTR,STACK >STACK
	MUL 2,STACK >LEN
	SUB LEN,2 >STACK
	GETB P-LEXV,STACK >STACK
	SUB LEN,1 >STACK
	GETB P-LEXV,STACK >STACK
	ADD STACK,STACK >STACK
	PUT OOPS-TABLE,O-END,STACK
	SET 'RESERVE-PTR,0
	SET 'LEN,P-LEN
	SET 'P-DIR,0
	SET 'P-NCN,0
	SET 'P-GETFLAGS,0
?L89:	DLESS? 'P-LEN,0 \?L91
	SET 'QUOTE-FLAG,0
	JUMP ?L90
?L91:	GET P-LEXV,PTR >WRD
	ZERO? WRD \?L94
	CALL NUMBER?,PTR >WRD
	ZERO? WRD /?L93
?L94:	ZERO? P-LEN \?L95
	SET 'NW,0
	JUMP ?L97
?L95:	ADD PTR,P-LEXELEN >STACK
	GET P-LEXV,STACK >NW
?L97:	EQUAL? WRD,W?TO \?L98
	EQUAL? VERB,ACT?TELL \?L98
	SET 'WRD,W?$QUOTE
	JUMP ?L103
?L98:	EQUAL? WRD,W?THEN \?L103
	GRTR? P-LEN,0 \?L103
	ZERO? VERB \?L103
	ZERO? QUOTE-FLAG \?L103
	EQUAL? LW,0,W?$PERIOD \?L101
	SET 'WRD,W?THE
	JUMP ?L103
?L101:	PUT P-ITBL,P-VERB,ACT?TELL
	PUT P-ITBL,P-VERBN,0
	SET 'WRD,W?$QUOTE
?L103:	EQUAL? WRD,W?THEN,W?$PERIOD,W?$QUOTE \?L105
	EQUAL? WRD,W?$QUOTE \?L111
	ZERO? QUOTE-FLAG /?L109
	SET 'QUOTE-FLAG,0
	JUMP ?L111
?L109:	SET 'QUOTE-FLAG,1
?L111:	ZERO? P-LEN /?L113
	ADD PTR,P-LEXELEN >P-CONT
?L113:	PUTB P-LEXV,P-LEXWORDS,P-LEN
	JUMP ?L90
?L105:	CALL WT?,WRD,PS?DIRECTION,P1?DIRECTION >VAL
	ZERO? VAL /?L115
	EQUAL? VERB,0,ACT?WALK \?L115
	EQUAL? LEN,1 /?L116
	EQUAL? LEN,2 \?L117
	EQUAL? VERB,ACT?WALK /?L116
?L117:	EQUAL? NW,W?THEN,W?$PERIOD,W?$QUOTE \?L118
	LESS? LEN,2 \?L116
?L118:	ZERO? QUOTE-FLAG /?L119
	EQUAL? LEN,2 \?L119
	EQUAL? NW,W?$QUOTE /?L116
?L119:	GRTR? LEN,2 \?L115
	EQUAL? NW,W?$COMMA,W?AND \?L115
?L116:	SET 'DIR,VAL
	EQUAL? NW,W?$COMMA,W?AND \?L120
	ADD PTR,P-LEXELEN >STACK
	PUT P-LEXV,STACK,W?THEN
?L120:	GRTR? LEN,2 /?L155
	SET 'QUOTE-FLAG,0
	JUMP ?L90
?L115:	CALL WT?,WRD,PS?VERB,P1?VERB >VAL
	ZERO? VAL /?L126
	ZERO? VERB \?L126
	SET 'VERB,VAL
	PUT P-ITBL,P-VERB,VAL
	PUT P-ITBL,P-VERBN,P-VTBL
	PUT P-VTBL,0,WRD
	MUL PTR,2 >STACK
	ADD STACK,2 >CNT
	GETB P-LEXV,CNT >STACK
	PUTB P-VTBL,2,STACK
	ADD CNT,1 >STACK
	GETB P-LEXV,STACK >STACK
	PUTB P-VTBL,3,STACK
	JUMP ?L155
?L126:	CALL WT?,WRD,PS?PREPOSITION,0 >VAL
	ZERO? VAL \?L128
	EQUAL? WRD,W?ALL,W?ONE /?L128
	CALL WT?,WRD,PS?ADJECTIVE >STACK
	ZERO? STACK \?L128
	CALL WT?,WRD,PS?OBJECT >STACK
	ZERO? STACK /?L127
?L128:	GRTR? P-LEN,1 \?L129
	EQUAL? NW,W?OF \?L129
	ZERO? VAL \?L165
	EQUAL? WRD,W?ALL,W?ONE,W?A /?L129
	SET 'OF-FLAG,1
	JUMP ?L155
?L129:	ZERO? VAL /?L131
?L165:	ZERO? P-LEN /?L132
	EQUAL? NW,W?THEN,W?$PERIOD \?L131
?L132:	SET 'P-END-ON-PREP,1
	LESS? P-NCN,2 \?L155
	PUT P-ITBL,P-PREP1,VAL
	PUT P-ITBL,P-PREP1N,WRD
	JUMP ?L155
?L131:	EQUAL? P-NCN,2 \?L136
	PRINTI "There were too many nouns in that sentence."
	CRLF
	RFALSE
?L136:	INC 'P-NCN
	SET 'P-ACT,VERB
	CALL CLAUSE,PTR,VAL,WRD >PTR
	ZERO? PTR /FALSE
	LESS? PTR,0 \?L155
	SET 'QUOTE-FLAG,0
	JUMP ?L90
?L127:	EQUAL? WRD,W?OF \?L145
	ZERO? OF-FLAG /?L148
	EQUAL? NW,W?$PERIOD,W?THEN \?L146
?L148:	CALL CANT-USE,PTR
	RFALSE
?L146:	SET 'OF-FLAG,0
	JUMP ?L155
?L145:	CALL WT?,WRD,PS?BUZZ-WORD >STACK
	ZERO? STACK \?L155
	EQUAL? VERB,ACT?TELL \?L151
	CALL WT?,WRD,PS?VERB,P1?VERB >STACK
	ZERO? STACK /?L151
	EQUAL? WINNER,PLAYER \?L151
	PRINTI "Please consult your manual for the correct way to talk to other people or creatures."
	CRLF
	RFALSE
?L151:	CALL CANT-USE,PTR
	RFALSE
?L93:	CALL UNKNOWN-WORD,PTR
	RFALSE
?L155:	SET 'LW,WRD
	ADD PTR,P-LEXELEN >PTR
	JUMP ?L89
?L90:	PUT OOPS-TABLE,O-PTR,0
	ZERO? DIR /?L156
	SET 'PRSA,V?WALK
	SET 'PRSO,DIR
	SET 'P-OFLAG,0
	SET 'P-WALK-DIR,DIR
	SET 'AGAIN-DIR,DIR
	RETURN AGAIN-DIR
?L156:	ZERO? P-OFLAG /?L159
	CALL ORPHAN-MERGE
?L159:	SET 'P-WALK-DIR,0
	SET 'AGAIN-DIR,0
	CALL SYNTAX-CHECK >STACK
	ZERO? STACK /FALSE
	CALL SNARF-OBJECTS >STACK
	ZERO? STACK /FALSE
	CALL MANY-CHECK >STACK
	ZERO? STACK /FALSE
	CALL TAKE-CHECK >STACK
	ZERO? STACK \TRUE
	RFALSE

	.FUNCT STUFF,SRC,DEST,MAX=29,PTR=P-LEXSTART,CTR=1,BPTR
	GETB SRC,0 >STACK
	PUTB DEST,0,STACK
	GETB SRC,1 >STACK
	PUTB DEST,1,STACK
?L1:	GET SRC,PTR >STACK
	PUT DEST,PTR,STACK
	MUL PTR,2 >STACK
	ADD STACK,2 >BPTR
	GETB SRC,BPTR >STACK
	PUTB DEST,BPTR,STACK
	MUL PTR,2 >STACK
	ADD STACK,3 >BPTR
	GETB SRC,BPTR >STACK
	PUTB DEST,BPTR,STACK
	ADD PTR,P-LEXELEN >PTR
	IGRTR? 'CTR,MAX \?L1
	RTRUE

	.FUNCT INBUF-STUFF,SRC,DEST,CNT
	GETB SRC,0 >STACK
	SUB STACK,1 >CNT
?L1:	GETB SRC,CNT >STACK
	PUTB DEST,CNT,STACK
	DLESS? 'CNT,0 \?L1
	RTRUE

	.FUNCT INBUF-ADD,LEN,BEG,SLOT?1,DBEG,CTR=0,TMP,?TMP
	GET OOPS-TABLE,O-END >TMP
	ZERO? TMP /?L1
	SET 'DBEG,TMP
	JUMP ?L3
?L1:	GET OOPS-TABLE,O-LENGTH >TMP
	GETB AGAIN-LEXV,TMP >?TMP
	ADD TMP,1 >STACK
	GETB AGAIN-LEXV,STACK >STACK
	ADD ?TMP,STACK >DBEG
?L3:	ADD DBEG,LEN >STACK
	PUT OOPS-TABLE,O-END,STACK
?L4:	ADD BEG,CTR >STACK
	GETB P-INBUF,STACK >STACK
	ADD DBEG,CTR >STACK
	PUTB OOPS-INBUF,STACK,STACK
	INC 'CTR
	EQUAL? CTR,LEN \?L4
	PUTB AGAIN-LEXV,SLOT?1,DBEG
	SUB SLOT?1,1 >STACK
	PUTB AGAIN-LEXV,STACK,LEN
	RTRUE

	.FUNCT WT?,PTR,BIT,B1=5,OFFS=P-P1OFF,TYP
	GETB PTR,P-PSOFF >TYP
	BTST TYP,BIT \FALSE
	GRTR? B1,4 /TRUE
	BAND TYP,P-P1BITS >TYP
	EQUAL? TYP,B1 /?L6
	INC 'OFFS
?L6:	GETB PTR,OFFS >STACK
	RSTACK

	.FUNCT CLAUSE,PTR,VAL,WRD,OFF,NUM,ANDFLG=0,FIRST??=1,NW,LW=0
	SUB P-NCN,1 >STACK
	MUL STACK,2 >OFF
	ZERO? VAL /?L1
	ADD P-PREP1,OFF >NUM
	PUT P-ITBL,NUM,VAL
	ADD NUM,1 >STACK
	PUT P-ITBL,STACK,WRD
	ADD PTR,P-LEXELEN >PTR
	JUMP ?L3
?L1:	INC 'P-LEN
?L3:	ZERO? P-LEN \?L4
	DEC 'P-NCN
	RETURN -1
?L4:	ADD P-NC1,OFF >NUM
	MUL PTR,2 >STACK
	ADD P-LEXV,STACK >STACK
	PUT P-ITBL,NUM,STACK
	GET P-LEXV,PTR >STACK
	EQUAL? STACK,W?THE,W?A,W?AN \?L7
	GET P-ITBL,NUM >STACK
	ADD STACK,4 >STACK
	PUT P-ITBL,NUM,STACK
?L7:	DLESS? 'P-LEN,0 \?L12
	MUL PTR,2 >STACK
	ADD P-LEXV,STACK >STACK
	ADD NUM,1 >STACK
	PUT P-ITBL,STACK,STACK
	RETURN -1
?L12:	GET P-LEXV,PTR >WRD
	ZERO? WRD \?L17
	CALL NUMBER?,PTR >WRD
	ZERO? WRD /?L15
?L17:	ZERO? P-LEN \?L18
	SET 'NW,0
	JUMP ?L20
?L18:	ADD PTR,P-LEXELEN >STACK
	GET P-LEXV,STACK >NW
?L20:	EQUAL? WRD,W?AND,W?$COMMA \?L21
	SET 'ANDFLG,1
	JUMP ?L42
?L21:	EQUAL? WRD,W?ALL,W?ONE \?L23
	EQUAL? NW,W?OF \?L42
	DEC 'P-LEN
	ADD PTR,P-LEXELEN >PTR
	JUMP ?L42
?L23:	EQUAL? WRD,W?THEN,W?$PERIOD /?L28
	CALL WT?,WRD,PS?PREPOSITION >STACK
	ZERO? STACK /?L27
	GET P-ITBL,P-VERB >STACK
	ZERO? STACK /?L27
	ZERO? FIRST?? \?L27
?L28:	INC 'P-LEN
	MUL PTR,2 >STACK
	ADD P-LEXV,STACK >STACK
	ADD NUM,1 >STACK
	PUT P-ITBL,STACK,STACK
	SUB PTR,P-LEXELEN >STACK
	RSTACK
?L27:	CALL WT?,WRD,PS?OBJECT >STACK
	ZERO? STACK /?L29
	GRTR? P-LEN,0 \?L30
	EQUAL? NW,W?OF \?L30
	EQUAL? WRD,W?ALL,W?ONE \?L42
?L30:	CALL WT?,WRD,PS?ADJECTIVE,P1?ADJECTIVE >STACK
	ZERO? STACK /?L32
	ZERO? NW /?L32
	CALL WT?,NW,PS?OBJECT >STACK
	ZERO? STACK \?L42
?L32:	ZERO? ANDFLG \?L33
	EQUAL? NW,W?BUT,W?EXCEPT,W?AND /?L33
	EQUAL? NW,W?$COMMA /?L33
	ADD PTR,2 >STACK
	MUL STACK,2 >STACK
	ADD P-LEXV,STACK >STACK
	ADD NUM,1 >STACK
	PUT P-ITBL,STACK,STACK
	RETURN PTR
?L33:	SET 'ANDFLG,0
	JUMP ?L42
?L29:	ZERO? P-MERGED \?L36
	ZERO? P-OFLAG \?L36
	GET P-ITBL,P-VERB >STACK
	ZERO? STACK /?L35
?L36:	CALL WT?,WRD,PS?ADJECTIVE >STACK
	ZERO? STACK \?L42
	CALL WT?,WRD,PS?BUZZ-WORD >STACK
	ZERO? STACK \?L42
?L35:	ZERO? ANDFLG /?L38
	CALL WT?,WRD,PS?DIRECTION >STACK
	ZERO? STACK \?L39
	CALL WT?,WRD,PS?VERB >STACK
	ZERO? STACK /?L38
?L39:	SUB PTR,4 >PTR
	ADD PTR,2 >STACK
	PUT P-LEXV,STACK,W?THEN
	ADD P-LEN,2 >P-LEN
	JUMP ?L42
?L38:	CALL WT?,WRD,PS?PREPOSITION >STACK
	ZERO? STACK \?L42
	CALL CANT-USE,PTR
	RFALSE
?L15:	CALL UNKNOWN-WORD,PTR
	RFALSE
?L42:	SET 'LW,WRD
	SET 'FIRST??,0
	ADD PTR,P-LEXELEN >PTR
	JUMP ?L7

	.FUNCT NUMBER?,PTR,CNT,BPTR,CHR,SUM=0,TIM=0
	MUL PTR,2 >STACK
	ADD P-LEXV,STACK >STACK
	GETB STACK,2 >CNT
	MUL PTR,2 >STACK
	ADD P-LEXV,STACK >STACK
	GETB STACK,3 >BPTR
?L1:	DLESS? 'CNT,0 /?L2
	GETB P-INBUF,BPTR >CHR
	EQUAL? CHR,58 \?L6
	SET 'TIM,SUM
	SET 'SUM,0
	JUMP ?L10
?L6:	GRTR? SUM,10000 /FALSE
	LESS? CHR,58 \FALSE
	GRTR? CHR,47 \FALSE
	SUB CHR,48 >STACK
	MUL SUM,10 >STACK
	ADD STACK,STACK >SUM
?L10:	INC 'BPTR
	JUMP ?L1
?L2:	PUT P-LEXV,PTR,W?INTNUM
	GRTR? SUM,1000 /FALSE
	ZERO? TIM /?L13
	LESS? TIM,8 \?L14
	ADD TIM,12 >TIM
	JUMP ?L16
?L14:	GRTR? TIM,23 /FALSE
?L16:	MUL TIM,60 >STACK
	ADD SUM,STACK >SUM
?L13:	SET 'P-NUMBER,SUM
	RETURN W?INTNUM

	.FUNCT ORPHAN-MERGE,CNT=-1,TEMP,VERB,BEG,END,ADJ=0,WRD,?TMP
	SET 'P-OFLAG,0
	GET P-ITBL,P-VERBN >STACK
	GET STACK,0 >WRD
	CALL WT?,WRD,PS?VERB,P1?VERB >?TMP
	GET P-OTBL,P-VERB >STACK
	EQUAL? ?TMP,STACK /?L3
	CALL WT?,WRD,PS?ADJECTIVE >STACK
	ZERO? STACK /?L1
?L3:	SET 'ADJ,1
	JUMP ?L4
?L1:	CALL WT?,WRD,PS?OBJECT,P1?OBJECT >STACK
	ZERO? STACK /?L4
	ZERO? P-NCN \?L4
	PUT P-ITBL,P-VERB,0
	PUT P-ITBL,P-VERBN,0
	ADD P-LEXV,2 >STACK
	PUT P-ITBL,P-NC1,STACK
	ADD P-LEXV,6 >STACK
	PUT P-ITBL,P-NC1L,STACK
	SET 'P-NCN,1
?L4:	GET P-ITBL,P-VERB >VERB
	ZERO? VERB /?L6
	ZERO? ADJ \?L6
	GET P-OTBL,P-VERB >STACK
	EQUAL? VERB,STACK \FALSE
?L6:	EQUAL? P-NCN,2 /FALSE
	GET P-OTBL,P-NC1 >STACK
	EQUAL? STACK,1 \?L9
	GET P-ITBL,P-PREP1 >TEMP
	GET P-OTBL,P-PREP1 >STACK
	EQUAL? TEMP,STACK /?L12
	ZERO? TEMP \FALSE
?L12:	ZERO? ADJ /?L13
	ADD P-LEXV,2 >STACK
	PUT P-OTBL,P-NC1,STACK
	GET P-ITBL,P-NC1L >STACK
	ZERO? STACK \?L15
	ADD P-LEXV,6 >STACK
	PUT P-ITBL,P-NC1L,STACK
?L15:	ZERO? P-NCN \?L21
	SET 'P-NCN,1
	JUMP ?L21
?L13:	GET P-ITBL,P-NC1 >STACK
	PUT P-OTBL,P-NC1,STACK
?L21:	GET P-ITBL,P-NC1L >STACK
	PUT P-OTBL,P-NC1L,STACK
	JUMP ?L42
?L9:	GET P-OTBL,P-NC2 >STACK
	EQUAL? STACK,1 \?L23
	GET P-ITBL,P-PREP1 >TEMP
	GET P-OTBL,P-PREP2 >STACK
	EQUAL? TEMP,STACK /?L26
	ZERO? TEMP \FALSE
?L26:	ZERO? ADJ /?L29
	ADD P-LEXV,2 >STACK
	PUT P-ITBL,P-NC1,STACK
	GET P-ITBL,P-NC1L >STACK
	ZERO? STACK \?L29
	ADD P-LEXV,6 >STACK
	PUT P-ITBL,P-NC1L,STACK
?L29:	GET P-ITBL,P-NC1 >STACK
	PUT P-OTBL,P-NC2,STACK
	GET P-ITBL,P-NC1L >STACK
	PUT P-OTBL,P-NC2L,STACK
	SET 'P-NCN,2
	JUMP ?L42
?L23:	ZERO? P-ACLAUSE /?L42
	EQUAL? P-NCN,1 /?L35
	ZERO? ADJ \?L35
	SET 'P-ACLAUSE,0
	RFALSE
?L35:	GET P-ITBL,P-NC1 >BEG
	ZERO? ADJ /?L38
	ADD P-LEXV,2 >BEG
	SET 'ADJ,0
?L38:	GET P-ITBL,P-NC1L >END
?L41:	GET BEG,0 >WRD
	EQUAL? BEG,END \?L43
	ZERO? ADJ /?L45
	CALL ACLAUSE-WIN,ADJ
	JUMP ?L42
?L45:	SET 'P-ACLAUSE,0
	RFALSE
?L43:	ZERO? ADJ \?L48
	GETB WRD,P-PSOFF >STACK
	BTST STACK,PS?ADJECTIVE /?L49
	EQUAL? WRD,W?ALL,W?ONE \?L48
?L49:	SET 'ADJ,WRD
	JUMP ?L51
?L48:	EQUAL? WRD,W?ONE \?L50
	CALL ACLAUSE-WIN,ADJ
	JUMP ?L42
?L50:	GETB WRD,P-PSOFF >STACK
	BTST STACK,PS?OBJECT \?L51
	EQUAL? WRD,P-ANAM \?L52
	CALL ACLAUSE-WIN,ADJ
	JUMP ?L42
?L52:	CALL NCLAUSE-WIN
	JUMP ?L42
?L51:	ADD BEG,P-WORDLEN >BEG
	ZERO? END \?L41
	SET 'END,BEG
	SET 'P-NCN,1
	SUB BEG,4 >STACK
	PUT P-ITBL,P-NC1,STACK
	PUT P-ITBL,P-NC1L,BEG
	JUMP ?L41
?L42:	GET P-OVTBL,0 >STACK
	PUT P-VTBL,0,STACK
	GETB P-OVTBL,2 >STACK
	PUTB P-VTBL,2,STACK
	GETB P-OVTBL,3 >STACK
	PUTB P-VTBL,3,STACK
	PUT P-OTBL,P-VERBN,P-VTBL
	PUTB P-VTBL,2,0
?L60:	IGRTR? 'CNT,P-ITBLLEN \?L62
	SET 'P-MERGED,1
	RTRUE
?L62:	GET P-OTBL,CNT >STACK
	PUT P-ITBL,CNT,STACK
	JUMP ?L60

	.FUNCT ACLAUSE-WIN,ADJ
	GET P-OTBL,P-VERB >STACK
	PUT P-ITBL,P-VERB,STACK
	PUT P-CCTBL,CC-SBPTR,P-ACLAUSE
	ADD P-ACLAUSE,1 >STACK
	PUT P-CCTBL,CC-SEPTR,STACK
	PUT P-CCTBL,CC-DBPTR,P-ACLAUSE
	ADD P-ACLAUSE,1 >STACK
	PUT P-CCTBL,CC-DEPTR,STACK
	CALL CLAUSE-COPY,P-OTBL,P-OTBL,ADJ
	GET P-OTBL,P-NC2 >STACK
	ZERO? STACK /?L1
	SET 'P-NCN,2
?L1:	SET 'P-ACLAUSE,0
	RTRUE

	.FUNCT NCLAUSE-WIN
	PUT P-CCTBL,CC-SBPTR,P-NC1
	PUT P-CCTBL,CC-SEPTR,P-NC1L
	PUT P-CCTBL,CC-DBPTR,P-ACLAUSE
	ADD P-ACLAUSE,1 >STACK
	PUT P-CCTBL,CC-DEPTR,STACK
	CALL CLAUSE-COPY,P-ITBL,P-OTBL
	GET P-OTBL,P-NC2 >STACK
	ZERO? STACK /?L1
	SET 'P-NCN,2
?L1:	SET 'P-ACLAUSE,0
	RTRUE

	.FUNCT WORD-PRINT,CNT,BUF
?L1:	DLESS? 'CNT,0 /TRUE
	GETB P-INBUF,BUF >STACK
	PRINTC STACK
	INC 'BUF
	JUMP ?L1

	.FUNCT UNKNOWN-WORD,PTR,BUF,?TMP
	PUT OOPS-TABLE,O-PTR,PTR
	EQUAL? PRSA,V?SAY \?L1
	PRINTI "Nothing happens."
	CRLF
	RFALSE
?L1:	PRINTI "I don't know the word """
	MUL PTR,2 >BUF
	ADD P-LEXV,BUF >STACK
	GETB STACK,2 >?TMP
	ADD P-LEXV,BUF >STACK
	GETB STACK,3 >STACK
	CALL WORD-PRINT,?TMP,STACK
	PRINTI """."
	CRLF
	SET 'QUOTE-FLAG,0
	SET 'P-OFLAG,0
	RETURN P-OFLAG

	.FUNCT CANT-USE,PTR,BUF,?TMP
	EQUAL? PRSA,V?SAY \?L1
	PRINTI "Nothing happens."
	CRLF
	RFALSE
?L1:	PRINTI "You used the word """
	MUL PTR,2 >BUF
	ADD P-LEXV,BUF >STACK
	GETB STACK,2 >?TMP
	ADD P-LEXV,BUF >STACK
	GETB STACK,3 >STACK
	CALL WORD-PRINT,?TMP,STACK
	PRINTI """ in a way that I don't understand."
	CRLF
	SET 'QUOTE-FLAG,0
	SET 'P-OFLAG,0
	RETURN P-OFLAG

	.FUNCT SYNTAX-CHECK,SYN,LEN,NUM,OBJ,DRIVE1=0,DRIVE2=0,PREP,VERB,TMP
	GET P-ITBL,P-VERB >VERB
	ZERO? VERB \?L1
	PRINTI "There was no verb in that sentence!"
	CRLF
	RFALSE
?L1:	SUB 255,VERB >STACK
	GET VERBS,STACK >SYN
	GETB SYN,0 >LEN
	INC 'SYN
?L6:	GETB SYN,P-SBITS >STACK
	BAND STACK,P-SONUMS >NUM
	GRTR? P-NCN,NUM /?L15
	LESS? NUM,1 /?L10
	ZERO? P-NCN \?L10
	GET P-ITBL,P-PREP1 >PREP
	ZERO? PREP /?L11
	GETB SYN,P-SPREP1 >STACK
	EQUAL? PREP,STACK \?L10
?L11:	SET 'DRIVE1,SYN
	JUMP ?L15
?L10:	GET P-ITBL,P-PREP1 >STACK
	GETB SYN,P-SPREP1 >STACK
	EQUAL? STACK,STACK \?L15
	EQUAL? NUM,2 \?L13
	EQUAL? P-NCN,1 \?L13
	SET 'DRIVE2,SYN
	JUMP ?L15
?L13:	GET P-ITBL,P-PREP2 >STACK
	GETB SYN,P-SPREP2 >STACK
	EQUAL? STACK,STACK \?L15
	CALL SYNTAX-FOUND,SYN
	RTRUE
?L15:	DLESS? 'LEN,1 \?L18
	ZERO? DRIVE1 \?L53
	ZERO? DRIVE2 \?L7
	PRINTI "That sentence isn't one I recognize."
	CRLF
	RFALSE
?L18:	ADD SYN,P-SYNLEN >SYN
	JUMP ?L6
?L7:	ZERO? DRIVE1 /?L27
?L53:	GETB DRIVE1,P-SPREP1 >STACK
	GETB DRIVE1,P-SLOC1 >STACK
	GETB DRIVE1,P-SFWIM1 >STACK
	CALL GWIM,STACK,STACK,STACK >OBJ
	ZERO? OBJ /?L27
	PUT P-PRSO,P-MATCHLEN,1
	PUT P-PRSO,1,OBJ
	CALL SYNTAX-FOUND,DRIVE1 >STACK
	RSTACK
?L27:	ZERO? DRIVE2 /?L29
	GETB DRIVE2,P-SPREP2 >STACK
	GETB DRIVE2,P-SLOC2 >STACK
	GETB DRIVE2,P-SFWIM2 >STACK
	CALL GWIM,STACK,STACK,STACK >OBJ
	ZERO? OBJ /?L29
	PUT P-PRSI,P-MATCHLEN,1
	PUT P-PRSI,1,OBJ
	CALL SYNTAX-FOUND,DRIVE2 >STACK
	RSTACK
?L29:	EQUAL? VERB,ACT?FIND \?L30
	PRINTI "That question can't be answered."
	CRLF
	RFALSE
?L30:	EQUAL? WINNER,PLAYER /?L33
	CALL CANT-ORPHAN >STACK
	RSTACK
?L33:	CALL ORPHAN,DRIVE1,DRIVE2
	PRINTI "What do you want to "
	GET P-OTBL,P-VERBN >TMP
	ZERO? TMP \?L37
	PRINTI "tell"
	JUMP ?L42
?L37:	GETB P-VTBL,2 >STACK
	ZERO? STACK \?L41
	GET TMP,0 >STACK
	PRINTB STACK
	JUMP ?L42
?L41:	GETB TMP,3 >STACK
	GETB TMP,2 >STACK
	CALL WORD-PRINT,STACK,STACK
	PUTB P-VTBL,2,0
?L42:	ZERO? DRIVE2 /?L43
	PRINTI " "
	CALL THING-PRINT,1,1
?L43:	SET 'P-OFLAG,1
	ZERO? DRIVE1 /?L48
	GETB DRIVE1,P-SPREP1 >STACK
	JUMP ?L50
?L48:	GETB DRIVE2,P-SPREP2 >STACK
?L50:	CALL PREP-PRINT,STACK
	PRINTI "?"
	CRLF
	RFALSE

	.FUNCT CANT-ORPHAN
	PRINTI """I don't understand! What are you referring to?"""
	CRLF
	RFALSE

	.FUNCT ORPHAN,D1,D2,CNT=-1
	ZERO? P-MERGED \?L1
	PUT P-OCLAUSE,P-MATCHLEN,0
?L1:	GET P-VTBL,0 >STACK
	PUT P-OVTBL,0,STACK
	GETB P-VTBL,2 >STACK
	PUTB P-OVTBL,2,STACK
	GETB P-VTBL,3 >STACK
	PUTB P-OVTBL,3,STACK
?L4:	IGRTR? 'CNT,P-ITBLLEN /?L5
	GET P-ITBL,CNT >STACK
	PUT P-OTBL,CNT,STACK
	JUMP ?L4
?L5:	EQUAL? P-NCN,2 \?L9
	PUT P-CCTBL,CC-SBPTR,P-NC2
	PUT P-CCTBL,CC-SEPTR,P-NC2L
	PUT P-CCTBL,CC-DBPTR,P-NC2
	PUT P-CCTBL,CC-DEPTR,P-NC2L
	CALL CLAUSE-COPY,P-ITBL,P-OTBL
?L9:	LESS? P-NCN,1 /?L12
	PUT P-CCTBL,CC-SBPTR,P-NC1
	PUT P-CCTBL,CC-SEPTR,P-NC1L
	PUT P-CCTBL,CC-DBPTR,P-NC1
	PUT P-CCTBL,CC-DEPTR,P-NC1L
	CALL CLAUSE-COPY,P-ITBL,P-OTBL
?L12:	ZERO? D1 /?L15
	GETB D1,P-SPREP1 >STACK
	PUT P-OTBL,P-PREP1,STACK
	PUT P-OTBL,P-NC1,1
	RTRUE
?L15:	ZERO? D2 /FALSE
	GETB D2,P-SPREP2 >STACK
	PUT P-OTBL,P-PREP2,STACK
	PUT P-OTBL,P-NC2,1
	RTRUE

	.FUNCT THING-PRINT,PRSO?,THE?=0,BEG,END
	ZERO? PRSO? /?L1
	GET P-ITBL,P-NC1 >BEG
	GET P-ITBL,P-NC1L >END
	JUMP ?L3
?L1:	GET P-ITBL,P-NC2 >BEG
	GET P-ITBL,P-NC2L >END
?L3:	CALL BUFFER-PRINT,BEG,END,THE? >STACK
	RSTACK

	.FUNCT BUFFER-PRINT,BEG,END,CP,NOSP=1,WRD,FIRST??=1,PN=0,Q?=0
?L1:	EQUAL? BEG,END /TRUE
	GET BEG,0 >WRD
	EQUAL? WRD,W?$COMMA \?L6
	PRINTI ", "
	JUMP ?L11
?L6:	ZERO? NOSP /?L10
	SET 'NOSP,0
	JUMP ?L11
?L10:	PRINTI " "
?L11:	EQUAL? WRD,W?$PERIOD,W?$COMMA \?L14
	SET 'NOSP,1
	JUMP ?L18
?L14:	EQUAL? WRD,W?ME \?L16
	PRINTD ME
	SET 'PN,1
	JUMP ?L18
?L16:	EQUAL? WRD,W?INTNUM \?L17
	PRINTN P-NUMBER
	SET 'PN,1
	JUMP ?L18
?L17:	ZERO? FIRST?? /?L19
	ZERO? PN \?L19
	ZERO? CP /?L19
	PRINTI "the "
?L19:	ZERO? P-OFLAG \?L26
	ZERO? P-MERGED /?L24
?L26:	PRINTB WRD
	JUMP ?L28
?L24:	EQUAL? WRD,W?IT \?L27
	CALL ACCESSIBLE?,P-IT-OBJECT >STACK
	ZERO? STACK /?L27
	PRINTD P-IT-OBJECT
	JUMP ?L28
?L27:	GETB BEG,3 >STACK
	GETB BEG,2 >STACK
	CALL WORD-PRINT,STACK,STACK
?L28:	SET 'FIRST??,0
?L18:	ADD BEG,P-WORDLEN >BEG
	JUMP ?L1

	.FUNCT PREP-PRINT,PREP,WRD
	ZERO? PREP /FALSE
	PRINTI " "
	CALL PREP-FIND,PREP >WRD
	PRINTB WRD
	RTRUE

	.FUNCT CLAUSE-COPY,SRC,DEST,INSRT=0,BEG,END
	GET P-CCTBL,CC-SBPTR >STACK
	GET SRC,STACK >BEG
	GET P-CCTBL,CC-SEPTR >STACK
	GET SRC,STACK >END
	GET P-OCLAUSE,P-MATCHLEN >STACK
	MUL STACK,P-LEXELEN >STACK
	ADD STACK,2 >STACK
	ADD P-OCLAUSE,STACK >STACK
	GET P-CCTBL,CC-DBPTR >STACK
	PUT DEST,STACK,STACK
?L1:	EQUAL? BEG,END \?L3
	GET P-OCLAUSE,P-MATCHLEN >STACK
	MUL STACK,P-LEXELEN >STACK
	ADD STACK,2 >STACK
	ADD P-OCLAUSE,STACK >STACK
	GET P-CCTBL,CC-DEPTR >STACK
	PUT DEST,STACK,STACK
	RTRUE
?L3:	ZERO? INSRT /?L6
	GET BEG,0 >STACK
	EQUAL? P-ANAM,STACK \?L6
	CALL CLAUSE-ADD,INSRT
?L6:	GET BEG,0 >STACK
	CALL CLAUSE-ADD,STACK
	ADD BEG,P-WORDLEN >BEG
	JUMP ?L1

	.FUNCT CLAUSE-ADD,WRD,PTR
	GET P-OCLAUSE,P-MATCHLEN >STACK
	ADD STACK,2 >PTR
	SUB PTR,1 >STACK
	PUT P-OCLAUSE,STACK,WRD
	PUT P-OCLAUSE,PTR,0
	PUT P-OCLAUSE,P-MATCHLEN,PTR
	RTRUE

	.FUNCT PREP-FIND,PREP,CNT=0,SIZE
	GET PREPOSITIONS,0 >STACK
	MUL STACK,2 >SIZE
?L1:	IGRTR? 'CNT,SIZE /FALSE
	GET PREPOSITIONS,CNT >STACK
	EQUAL? STACK,PREP \?L1
	SUB CNT,1 >STACK
	GET PREPOSITIONS,STACK >STACK
	RSTACK

	.FUNCT SYNTAX-FOUND,SYN
	SET 'P-SYNTAX,SYN
	GETB SYN,P-SACTION >PRSA
	RETURN PRSA

	.FUNCT GWIM,GBIT,LBIT,PREP,OBJ
	EQUAL? GBIT,RMUNGBIT \?L1
	RETURN ROOMS
?L1:	SET 'P-GWIMBIT,GBIT
	SET 'P-SLOCBITS,LBIT
	PUT P-MERGE,P-MATCHLEN,0
	CALL GET-OBJECT,P-MERGE,0 >STACK
	ZERO? STACK /?L4
	SET 'P-GWIMBIT,0
	GET P-MERGE,P-MATCHLEN >STACK
	EQUAL? STACK,1 \FALSE
	GET P-MERGE,1 >OBJ
	PRINTI "("
	ZERO? PREP /?L10
	ZERO? P-END-ON-PREP \?L10
	CALL PREP-FIND,PREP >PREP
	PRINTB PREP
	EQUAL? PREP,W?OUT \?L12
	PRINTI " of"
?L12:	PRINTI " "
	EQUAL? OBJ,HANDS \?L19
	PRINTI "your hands"
	JUMP ?L23
?L19:	PRINTI "the "
	PRINTD OBJ
?L23:	PRINTI ")"
	CRLF
	RETURN OBJ
?L10:	PRINTD OBJ
	PRINTI ")"
	CRLF
	RETURN OBJ
?L4:	SET 'P-GWIMBIT,0
	RFALSE

	.FUNCT SNARF-OBJECTS,OPTR,IPTR,L
	PUT P-BUTS,P-MATCHLEN,0
	GET P-ITBL,P-NC2 >IPTR
	ZERO? IPTR /?L3
	GETB P-SYNTAX,P-SLOC2 >P-SLOCBITS
	GET P-ITBL,P-NC2L >STACK
	CALL SNARFEM,IPTR,STACK,P-PRSI >STACK
	ZERO? STACK /FALSE
?L3:	GET P-ITBL,P-NC1 >OPTR
	ZERO? OPTR /?L8
	GETB P-SYNTAX,P-SLOC1 >P-SLOCBITS
	GET P-ITBL,P-NC1L >STACK
	CALL SNARFEM,OPTR,STACK,P-PRSO >STACK
	ZERO? STACK /FALSE
?L8:	GET P-BUTS,P-MATCHLEN >STACK
	ZERO? STACK /TRUE
	GET P-PRSO,P-MATCHLEN >L
	ZERO? OPTR /?L13
	CALL BUT-MERGE,P-PRSO >P-PRSO
?L13:	ZERO? IPTR /TRUE
	ZERO? OPTR /?L18
	GET P-PRSO,P-MATCHLEN >STACK
	EQUAL? L,STACK \TRUE
?L18:	CALL BUT-MERGE,P-PRSI >P-PRSI
	RTRUE

	.FUNCT BUT-MERGE,TBL,LEN,BUTLEN,CNT=1,MATCHES=0,OBJ,NTBL
	GET TBL,P-MATCHLEN >LEN
	PUT P-MERGE,P-MATCHLEN,0
?L1:	DLESS? 'LEN,0 /?L2
	GET TBL,CNT >OBJ
	CALL ZMEMQ,OBJ,P-BUTS >STACK
	ZERO? STACK \?L6
	ADD MATCHES,1 >STACK
	PUT P-MERGE,STACK,OBJ
	INC 'MATCHES
?L6:	INC 'CNT
	JUMP ?L1
?L2:	PUT P-MERGE,P-MATCHLEN,MATCHES
	SET 'NTBL,P-MERGE
	SET 'P-MERGE,TBL
	RETURN NTBL

	.FUNCT SNARFEM,PTR,EPTR,TBL,BUT=0,LEN,WV,WRD,NW,WAS-ALL=0
	SET 'P-AND,0
	EQUAL? P-GETFLAGS,P-ALL \?L1
	SET 'WAS-ALL,1
?L1:	SET 'P-GETFLAGS,0
	PUT TBL,P-MATCHLEN,0
	GET PTR,0 >WRD
?L4:	EQUAL? PTR,EPTR \?L6
?L57:	ZERO? BUT /?L9
	PUSH BUT
	JUMP ?L8
?L9:	PUSH TBL
?L8:	CALL GET-OBJECT,STACK >WV
	ZERO? WAS-ALL /?L10
	SET 'P-GETFLAGS,P-ALL
?L10:	RETURN WV
?L6:	ADD PTR,P-WORDLEN >STACK
	EQUAL? EPTR,STACK \?L14
	SET 'NW,0
	JUMP ?L16
?L14:	GET PTR,P-LEXELEN >NW
?L16:	EQUAL? WRD,W?ALL \?L17
	SET 'P-GETFLAGS,P-ALL
	EQUAL? NW,W?OF \?L52
	ADD PTR,P-WORDLEN >PTR
	JUMP ?L52
?L17:	EQUAL? WRD,W?BUT,W?EXCEPT \?L22
	ZERO? BUT /?L26
	PUSH BUT
	JUMP ?L25
?L26:	PUSH TBL
?L25:	CALL GET-OBJECT,STACK >STACK
	ZERO? STACK /FALSE
	SET 'BUT,P-BUTS
	PUT BUT,P-MATCHLEN,0
	JUMP ?L52
?L22:	EQUAL? WRD,W?A,W?ONE \?L27
	ZERO? P-ADJ \?L28
	SET 'P-GETFLAGS,P-ONE
	EQUAL? NW,W?OF \?L52
	ADD PTR,P-WORDLEN >PTR
	JUMP ?L52
?L28:	SET 'P-NAM,P-ONEOBJ
	ZERO? BUT /?L37
	PUSH BUT
	JUMP ?L36
?L37:	PUSH TBL
?L36:	CALL GET-OBJECT,STACK >STACK
	ZERO? STACK /FALSE
	ZERO? NW /TRUE
	JUMP ?L52
?L27:	EQUAL? WRD,W?AND,W?$COMMA \?L40
	EQUAL? NW,W?AND,W?$COMMA /?L40
	SET 'P-AND,1
	ZERO? BUT /?L44
	PUSH BUT
	JUMP ?L43
?L44:	PUSH TBL
?L43:	CALL GET-OBJECT,STACK >STACK
	ZERO? STACK /FALSE
	JUMP ?L52
?L40:	CALL WT?,WRD,PS?BUZZ-WORD >STACK
	ZERO? STACK \?L52
	EQUAL? WRD,W?AND,W?$COMMA /?L52
	EQUAL? WRD,W?OF \?L47
	ZERO? P-GETFLAGS \?L52
	SET 'P-GETFLAGS,P-INHIBIT
	JUMP ?L52
?L47:	CALL WT?,WRD,PS?ADJECTIVE,P1?ADJECTIVE >WV
	ZERO? WV /?L51
	ZERO? P-ADJ \?L51
	SET 'P-ADJ,WV
	SET 'P-ADJN,WRD
	JUMP ?L52
?L51:	CALL WT?,WRD,PS?OBJECT,P1?OBJECT >STACK
	ZERO? STACK /?L52
	SET 'P-NAM,WRD
	SET 'P-ONEOBJ,WRD
?L52:	EQUAL? PTR,EPTR /?L57
	ADD PTR,P-WORDLEN >PTR
	SET 'WRD,NW
	JUMP ?L4

	.FUNCT GET-OBJECT,TBL,VRB=1,BITS,LEN,XBITS,TLEN,GCHECK=0,OLEN=0,OBJ
	SET 'XBITS,P-SLOCBITS
	GET TBL,P-MATCHLEN >TLEN
	BTST P-GETFLAGS,P-INHIBIT /TRUE
	ZERO? P-NAM \?L11
	ZERO? P-ADJ /?L8
	CALL WT?,P-ADJN,PS?OBJECT,P1?OBJECT >STACK
	ZERO? STACK /?L6
	SET 'P-NAM,P-ADJN
	SET 'P-ADJ,0
	JUMP ?L8
?L6:	CALL NULL-F >STACK
	ZERO? STACK /?L8
?L8:	ZERO? P-NAM \?L11
	ZERO? P-ADJ \?L11
	EQUAL? P-GETFLAGS,P-ALL /?L73
	ZERO? P-GWIMBIT \?L11
	ZERO? VRB /FALSE
	PRINTI "There seems to be a noun missing in that sentence!"
	CRLF
	RFALSE
?L11:	EQUAL? P-GETFLAGS,P-ALL \?L21
?L73:	ZERO? P-SLOCBITS \?L19
?L21:	SET 'P-SLOCBITS,-1
?L19:	SET 'P-TABLE,TBL
?L23:	ZERO? GCHECK /?L25
	CALL GLOBAL-CHECK,TBL
	JUMP ?L27
?L25:	ZERO? LIT /?L28
	FCLEAR PLAYER,TRANSBIT
	CALL DO-SL,HERE,SOG,SIR
	FSET PLAYER,TRANSBIT
?L28:	CALL DO-SL,PLAYER,SH,SC
?L27:	GET TBL,P-MATCHLEN >STACK
	SUB STACK,TLEN >LEN
	BTST P-GETFLAGS,P-ALL /?L45
	BTST P-GETFLAGS,P-ONE \?L33
	ZERO? LEN /?L33
	EQUAL? LEN,1 /?L34
	RANDOM LEN >STACK
	GET TBL,STACK >STACK
	PUT TBL,1,STACK
	PRINTI "(How about the "
	GET TBL,1 >STACK
	PRINTD STACK
	PRINTI "?)"
	CRLF
?L34:	PUT TBL,P-MATCHLEN,1
	JUMP ?L45
?L33:	GRTR? LEN,1 /?L42
	ZERO? LEN \?L71
	EQUAL? P-SLOCBITS,-1 /?L45
?L42:	EQUAL? P-SLOCBITS,-1 \?L43
	SET 'P-SLOCBITS,XBITS
	SET 'OLEN,LEN
	GET TBL,P-MATCHLEN >STACK
	SUB STACK,LEN >STACK
	PUT TBL,P-MATCHLEN,STACK
	JUMP ?L23
?L43:	ZERO? LEN \?L46
	SET 'LEN,OLEN
?L46:	EQUAL? WINNER,PLAYER /?L49
	CALL CANT-ORPHAN
	RFALSE
?L49:	ZERO? VRB /?L55
	ZERO? P-NAM /?L51
	CALL WHICH-PRINT,TLEN,LEN,TBL
	EQUAL? TBL,P-PRSO \?L52
	SET 'P-ACLAUSE,P-NC1
	JUMP ?L54
?L52:	SET 'P-ACLAUSE,P-NC2
?L54:	SET 'P-AADJ,P-ADJ
	SET 'P-ANAM,P-NAM
	CALL ORPHAN,0,0
	SET 'P-OFLAG,1
	JUMP ?L55
?L51:	ZERO? VRB /?L55
	PRINTI "There seems to be a noun missing in that sentence!"
	CRLF
?L55:	SET 'P-NAM,0
	SET 'P-ADJ,0
	RFALSE
?L45:	ZERO? LEN \?L71
	ZERO? GCHECK /?L60
	ZERO? VRB /?L67
	SET 'P-SLOCBITS,XBITS
	ZERO? LIT \?L66
	EQUAL? PRSA,V?TELL \?L64
?L66:	CALL OBJ-FOUND,NOT-HERE-OBJECT,TBL
	SET 'P-XNAM,P-NAM
	SET 'P-XADJ,P-ADJ
	SET 'P-XADJN,P-ADJN
	SET 'P-NAM,0
	SET 'P-ADJ,0
	SET 'P-ADJN,0
	RTRUE
?L64:	PRINTI "It's too dark to see!"
	CRLF
?L67:	SET 'P-NAM,0
	SET 'P-ADJ,0
	RFALSE
?L60:	ZERO? LEN \?L71
	SET 'GCHECK,1
	JUMP ?L23
?L71:	SET 'P-SLOCBITS,XBITS
	SET 'P-NAM,0
	SET 'P-ADJ,0
	RTRUE

	.FUNCT WHICH-PRINT,TLEN,LEN,TBL,OBJ,RLEN
	SET 'RLEN,LEN
	PRINTI "Which "
	ZERO? P-OFLAG \?L5
	ZERO? P-MERGED \?L5
	ZERO? P-AND /?L3
?L5:	ZERO? P-NAM /?L6
	PUSH P-NAM
	JUMP ?L9
?L6:	ZERO? P-ADJ /?L8
	PUSH P-ADJN
	JUMP ?L9
?L8:	PUSH W?ONE
?L9:	PRINTB STACK
	JUMP ?L10
?L3:	EQUAL? TBL,P-PRSO /?L11
	PUSH 0
	JUMP ?L12
?L11:	PUSH 1
?L12:	CALL THING-PRINT,STACK
?L10:	PRINTI " do you mean, "
?L15:	INC 'TLEN
	GET TBL,TLEN >OBJ
	PRINTI "the "
	PRINTD OBJ
	EQUAL? LEN,2 \?L19
	EQUAL? RLEN,2 /?L21
	PRINTI ","
?L21:	PRINTI " or "
	JUMP ?L28
?L19:	GRTR? LEN,2 \?L28
	PRINTI ", "
?L28:	DLESS? 'LEN,1 \?L15
	PRINTR "?"

	.FUNCT GLOBAL-CHECK,TBL,LEN,RMG,RMGL,CNT=0,OBJ,OBITS,FOO
	GET TBL,P-MATCHLEN >LEN
	SET 'OBITS,P-SLOCBITS
	GETPT HERE,P?GLOBAL >RMG
	ZERO? RMG /?L4
	PTSIZE RMG >STACK
	SUB STACK,1 >RMGL
?L3:	GETB RMG,CNT >OBJ
	CALL THIS-IT?,OBJ,TBL >STACK
	ZERO? STACK /?L5
	CALL OBJ-FOUND,OBJ,TBL
?L5:	IGRTR? 'CNT,RMGL \?L3
?L4:	GETPT HERE,P?PSEUDO >RMG
	ZERO? RMG /?L15
	PTSIZE RMG >STACK
	DIV STACK,4 >STACK
	SUB STACK,1 >RMGL
	SET 'CNT,0
?L14:	MUL CNT,2 >STACK
	GET RMG,STACK >STACK
	EQUAL? P-NAM,STACK \?L16
	MUL CNT,2 >STACK
	INC 'STACK
	GET RMG,STACK >STACK
	PUTP PSEUDO-OBJECT,P?ACTION,STACK
	GETPT PSEUDO-OBJECT,P?ACTION >STACK
	SUB STACK,5 >FOO
	GET P-NAM,0 >STACK
	PUT FOO,0,STACK
	GET P-NAM,1 >STACK
	PUT FOO,1,STACK
	CALL OBJ-FOUND,PSEUDO-OBJECT,TBL
	JUMP ?L15
?L16:	IGRTR? 'CNT,RMGL \?L14
?L15:	GET TBL,P-MATCHLEN >STACK
	EQUAL? STACK,LEN \FALSE
	SET 'P-SLOCBITS,-1
	SET 'P-TABLE,TBL
	CALL DO-SL,GLOBAL-OBJECTS,1,1
	SET 'P-SLOCBITS,OBITS
	GET TBL,P-MATCHLEN >STACK
	ZERO? STACK \FALSE
	EQUAL? PRSA,V?LOOK-INSIDE,V?SEARCH,V?EXAMINE \FALSE
	CALL DO-SL,ROOMS,1,1 >STACK
	RSTACK

	.FUNCT DO-SL,OBJ,BIT1,BIT2,BTS
	ADD BIT1,BIT2 >STACK
	BTST P-SLOCBITS,STACK \?L1
	CALL SEARCH-LIST,OBJ,P-TABLE,P-SRCALL >STACK
	RSTACK
?L1:	BTST P-SLOCBITS,BIT1 \?L4
	CALL SEARCH-LIST,OBJ,P-TABLE,P-SRCTOP >STACK
	RSTACK
?L4:	BTST P-SLOCBITS,BIT2 \TRUE
	CALL SEARCH-LIST,OBJ,P-TABLE,P-SRCBOT >STACK
	RSTACK

	.FUNCT SEARCH-LIST,OBJ,TBL,LVL,FLS,NOBJ
	FIRST? OBJ >OBJ \FALSE
?L3:	EQUAL? LVL,P-SRCBOT /?L5
	GETPT OBJ,P?SYNONYM >STACK
	ZERO? STACK /?L5
	CALL THIS-IT?,OBJ,TBL >STACK
	ZERO? STACK /?L5
	CALL OBJ-FOUND,OBJ,TBL
?L5:	EQUAL? LVL,P-SRCTOP \?L10
	FSET? OBJ,SEARCHBIT /?L10
	FSET? OBJ,SURFACEBIT \?L8
?L10:	FIRST? OBJ >NOBJ \?L8
	FSET? OBJ,OPENBIT /?L11
	FSET? OBJ,TRANSBIT \?L8
?L11:	FSET? OBJ,SURFACEBIT \?L12
	PUSH P-SRCALL
	JUMP ?L15
?L12:	FSET? OBJ,SEARCHBIT \?L14
	PUSH P-SRCALL
	JUMP ?L15
?L14:	PUSH P-SRCTOP
?L15:	CALL SEARCH-LIST,OBJ,TBL,STACK >FLS
?L8:	NEXT? OBJ >OBJ /?L3
	RTRUE

	.FUNCT OBJ-FOUND,OBJ,TBL,PTR
	GET TBL,P-MATCHLEN >PTR
	ADD PTR,1 >STACK
	PUT TBL,STACK,OBJ
	ADD PTR,1 >STACK
	PUT TBL,P-MATCHLEN,STACK
	RTRUE

	.FUNCT TAKE-CHECK
	GETB P-SYNTAX,P-SLOC1 >STACK
	CALL ITAKE-CHECK,P-PRSO,STACK >STACK
	ZERO? STACK /FALSE
	GETB P-SYNTAX,P-SLOC2 >STACK
	CALL ITAKE-CHECK,P-PRSI,STACK >STACK
	RSTACK

	.FUNCT ITAKE-CHECK,TBL,IBITS,PTR,OBJ,TAKEN
	GET TBL,P-MATCHLEN >PTR
	ZERO? PTR /TRUE
	BTST IBITS,SHAVE /?L3
	BTST IBITS,STAKE \TRUE
?L3:	DLESS? 'PTR,0 /TRUE
	ADD PTR,1 >STACK
	GET TBL,STACK >OBJ
	EQUAL? OBJ,IT \?L15
	CALL ACCESSIBLE?,P-IT-OBJECT >STACK
	ZERO? STACK \?L11
	PRINTI "I don't see what you're referring to."
	CRLF
	RFALSE
?L11:	SET 'OBJ,P-IT-OBJECT
?L15:	CALL HELD?,OBJ >STACK
	ZERO? STACK \?L3
	EQUAL? OBJ,HANDS,ME /?L3
	SET 'PRSO,OBJ
	FSET? OBJ,TRYTAKEBIT \?L19
	SET 'TAKEN,1
	JUMP ?L23
?L19:	EQUAL? WINNER,ADVENTURER /?L21
	SET 'TAKEN,0
	JUMP ?L23
?L21:	BTST IBITS,STAKE \?L22
	CALL ITAKE,0 >STACK
	EQUAL? STACK,1 \?L22
	SET 'TAKEN,0
	JUMP ?L23
?L22:	SET 'TAKEN,1
?L23:	ZERO? TAKEN /?L41
	BTST IBITS,SHAVE \?L24
	EQUAL? WINNER,ADVENTURER \?L24
	EQUAL? OBJ,NOT-HERE-OBJECT \?L26
	PRINTI "You don't have that!"
	CRLF
	RFALSE
?L26:	PRINTI "You don't have the "
	PRINTD OBJ
	PRINTI "."
	CRLF
	RFALSE
?L24:	ZERO? TAKEN \?L3
?L41:	EQUAL? WINNER,ADVENTURER \?L3
	PRINTI "(Taken)"
	CRLF
	JUMP ?L3

	.FUNCT MANY-CHECK,LOSS=0,TMP
	GET P-PRSO,P-MATCHLEN >STACK
	GRTR? STACK,1 \?L1
	GETB P-SYNTAX,P-SLOC1 >STACK
	BTST STACK,SMANY /?L1
	SET 'LOSS,1
	JUMP ?L3
?L1:	GET P-PRSI,P-MATCHLEN >STACK
	GRTR? STACK,1 \?L3
	GETB P-SYNTAX,P-SLOC2 >STACK
	BTST STACK,SMANY /?L3
	SET 'LOSS,2
?L3:	ZERO? LOSS /TRUE
	PRINTI "You can't use multiple "
	EQUAL? LOSS,2 \?L9
	PRINTI "in"
?L9:	PRINTI "direct objects with """
	GET P-ITBL,P-VERBN >TMP
	ZERO? TMP \?L16
	PRINTI "tell"
	JUMP ?L22
?L16:	ZERO? P-OFLAG \?L21
	ZERO? P-MERGED /?L20
?L21:	GET TMP,0 >STACK
	PRINTB STACK
	JUMP ?L22
?L20:	GETB TMP,3 >STACK
	GETB TMP,2 >STACK
	CALL WORD-PRINT,STACK,STACK
?L22:	PRINTI """."
	CRLF
	RFALSE

	.FUNCT ZMEMQ,ITM,TBL,SIZE=-1,CNT=1
	ZERO? TBL /FALSE
	LESS? SIZE,0 /?L4
	SET 'CNT,0
	JUMP ?L6
?L4:	GET TBL,0 >SIZE
?L6:	GET TBL,CNT >STACK
	EQUAL? ITM,STACK \?L9
	MUL CNT,2 >STACK
	ADD TBL,STACK >STACK
	RSTACK
?L9:	IGRTR? 'CNT,SIZE \?L6
	RFALSE

	.FUNCT ZMEMQB,ITM,TBL,SIZE,CNT=0
?L1:	GETB TBL,CNT >STACK
	EQUAL? ITM,STACK /TRUE
	IGRTR? 'CNT,SIZE \?L1
	RFALSE

	.FUNCT LIT?,RM,RMBIT=1,OHERE,LIT?1=0
	ZERO? ALWAYS-LIT /?L1
	EQUAL? WINNER,PLAYER /TRUE
?L1:	SET 'P-GWIMBIT,ONBIT
	SET 'OHERE,HERE
	SET 'HERE,RM
	ZERO? RMBIT /?L4
	FSET? RM,ONBIT \?L4
	SET 'LIT?1,1
	JUMP ?L13
?L4:	PUT P-MERGE,P-MATCHLEN,0
	SET 'P-TABLE,P-MERGE
	SET 'P-SLOCBITS,-1
	EQUAL? OHERE,RM \?L9
	CALL DO-SL,WINNER,1,1
	EQUAL? WINNER,PLAYER /?L9
	IN? PLAYER,RM \?L9
	CALL DO-SL,PLAYER,1,1
?L9:	CALL DO-SL,RM,1,1
	GET P-TABLE,P-MATCHLEN >STACK
	GRTR? STACK,0 \?L13
	SET 'LIT?1,1
?L13:	SET 'HERE,OHERE
	SET 'P-GWIMBIT,0
	RETURN LIT?1

	.FUNCT THIS-IT?,OBJ,TBL,SYNS
	FSET? OBJ,INVISIBLE /FALSE
	ZERO? P-NAM /?L3
	GETPT OBJ,P?SYNONYM >SYNS
	PTSIZE SYNS >STACK
	DIV STACK,2 >STACK
	DEC 'STACK
	CALL ZMEMQ,P-NAM,SYNS,STACK >STACK
	ZERO? STACK /FALSE
?L3:	ZERO? P-ADJ /?L4
	GETPT OBJ,P?ADJECTIVE >SYNS
	ZERO? SYNS /FALSE
	PTSIZE SYNS >STACK
	DEC 'STACK
	CALL ZMEMQB,P-ADJ,SYNS,STACK >STACK
	ZERO? STACK /FALSE
?L4:	ZERO? P-GWIMBIT /TRUE
	FSET? OBJ,P-GWIMBIT /TRUE
	RFALSE

	.FUNCT ACCESSIBLE?,OBJ,L,?TMP
	LOC OBJ >L
	FSET? OBJ,INVISIBLE /FALSE
	ZERO? L /FALSE
	EQUAL? L,GLOBAL-OBJECTS /TRUE
	EQUAL? L,LOCAL-GLOBALS \?L5
	CALL GLOBAL-IN?,OBJ,HERE >STACK
	ZERO? STACK \TRUE
?L5:	CALL META-LOC,OBJ >?TMP
	LOC WINNER >STACK
	EQUAL? ?TMP,HERE,STACK \FALSE
	LOC WINNER >STACK
	EQUAL? L,WINNER,HERE,STACK /TRUE
	FSET? L,OPENBIT \FALSE
	CALL ACCESSIBLE?,L >STACK
	ZERO? STACK /FALSE
	RTRUE

	.FUNCT META-LOC,OBJ
?L1:	ZERO? OBJ /FALSE
	IN? OBJ,GLOBAL-OBJECTS \?L5
	RETURN GLOBAL-OBJECTS
?L5:	IN? OBJ,ROOMS \?L7
	RETURN OBJ
?L7:	LOC OBJ >OBJ
	JUMP ?L1

	.FUNCT ZPROB,BASE
	ZERO? LUCKY /?L1
	RANDOM 100 >STACK
	GRTR? BASE,STACK /TRUE
	RFALSE
?L1:	RANDOM 300 >STACK
	GRTR? BASE,STACK \FALSE
	RTRUE

	.FUNCT RANDOM-ELEMENT,FROB
	GET FROB,0 >STACK
	RANDOM STACK >STACK
	GET FROB,STACK >STACK
	RSTACK

	.FUNCT PICK-ONE,FROB,L,CNT,RND,MSG,RFROB
	GET FROB,0 >L
	GET FROB,1 >CNT
	DEC 'L
	ADD FROB,2 >FROB
	MUL CNT,2 >STACK
	ADD FROB,STACK >RFROB
	SUB L,CNT >STACK
	RANDOM STACK >RND
	GET RFROB,RND >MSG
	GET RFROB,1 >STACK
	PUT RFROB,RND,STACK
	PUT RFROB,1,MSG
	INC 'CNT
	EQUAL? CNT,L \?L1
	SET 'CNT,0
?L1:	PUT FROB,0,CNT
	RETURN MSG

	.FUNCT V-VERBOSE
	SET 'VERBOSE,1
	SET 'SUPER-BRIEF,0
	PRINTR "Maximum verbosity."

	.FUNCT V-BRIEF
	SET 'VERBOSE,0
	SET 'SUPER-BRIEF,0
	PRINTR "Brief descriptions."

	.FUNCT V-SUPER-BRIEF
	SET 'SUPER-BRIEF,1
	PRINTR "Superbrief descriptions."

	.FUNCT V-INVENTORY
	FIRST? WINNER >STACK \?L1
	CALL PRINT-CONT,WINNER >STACK
	RSTACK
?L1:	PRINTR "You are empty-handed."

	.FUNCT FINISH,WRD
	CALL V-SCORE
?L1:	CRLF
	PRINTI "[EVENT: GAME OVER]Would you like to restart the game from the beginning, restore a saved game position, or end this session of the game?
(Type RESTART, RESTORE, or QUIT):
>"
	READ P-INBUF,P-LEXV
	GET P-LEXV,1 >WRD
	EQUAL? WRD,W?RESTART \?L5
	RESTART
?L5:	EQUAL? WRD,W?RESTORE \?L9
	RESTORE \?L10
	PRINTI "Ok."
	CRLF
	JUMP ?L1
?L10:	PRINTI "Failed."
	CRLF
	JUMP ?L1
?L9:	EQUAL? WRD,W?QUIT,W?Q \?L1
	QUIT

	.FUNCT V-QUIT,SCOR
	CALL V-SCORE
	PRINTI "Do you wish to leave the game? (Y is affirmative): "
	CALL YES? >STACK
	ZERO? STACK /?L3
	QUIT
?L3:	PRINTR "Ok."

	.FUNCT V-RESTART
	CALL V-SCORE,1
	PRINTI "Do you wish to restart? (Y is affirmative): "
	CALL YES? >STACK
	ZERO? STACK /FALSE
	PRINTI "Restarting."
	CRLF
	RESTART

	.FUNCT V-RESTORE
	RESTORE \?L1
	PRINTI "Ok."
	CRLF
	CALL V-FIRST-LOOK >STACK
	RSTACK
?L1:	PRINTR "Failed."

	.FUNCT V-SAVE
	SAVE \?L1
	PRINTR "Ok."
?L1:	PRINTR "Failed."

	.FUNCT V-SCRIPT
	GET 0,8 >STACK
	BOR STACK,1 >STACK
	PUT 0,8,STACK
	PRINTI "Here begins a transcript of interaction with"
	CRLF
	CALL V-VERSION
	RTRUE

	.FUNCT V-UNSCRIPT
	PRINTI "Here ends a transcript of interaction with"
	CRLF
	CALL V-VERSION
	GET 0,8 >STACK
	BAND STACK,-2 >STACK
	PUT 0,8,STACK
	RTRUE

	.FUNCT V-VERSION,CNT=17
	PRINTI "ZORK II: The Wizard of Frobozz
Infocom interactive fiction - a fantasy story
Copyright (c) 1981, 1982, 1983, 1986"
	PRINTI " Infocom, Inc. All rights reserved."
	CRLF
	PRINTI "ZORK is a registered trademark of Infocom, Inc.
Release "
	GET 0,1 >STACK
	BAND STACK,2047 >STACK
	PRINTN STACK
	PRINTI " / Serial number "
?L9:	IGRTR? 'CNT,23 /?L10
	GETB 0,CNT >STACK
	PRINTC STACK
	JUMP ?L9
?L10:	CRLF
	RTRUE

	.FUNCT V-VERIFY
	PRINTI "Verifying disk..."
	CRLF
	VERIFY \?L3
	PRINTR "The disk is correct."
?L3:	CRLF
	PRINTR "** Disk Failure **"

	.FUNCT V-COMMAND-FILE
	DIRIN 1
	RTRUE

	.FUNCT V-RANDOM
	EQUAL? PRSO,INTNUM /?L1
	PRINTR "Illegal call to #RND."
?L1:	SUB 0,P-NUMBER >STACK
	RANDOM STACK >STACK
	RTRUE

	.FUNCT V-RECORD
	DIROUT 4
	RTRUE

	.FUNCT V-UNRECORD
	DIROUT -4
	RTRUE

	.FUNCT V-ADVENT
	PRINTR "A hollow voice says ""Fool."""

	.FUNCT V-ALARM
	FSET? PRSO,ACTORBIT \?L1
	CALL NULL-F >STACK
	ZERO? STACK \TRUE
	PRINTR "He's wide awake, or haven't you noticed..."
?L1:	PRINTI "The "
	PRINTD PRSO
	PRINTR " isn't sleeping."

	.FUNCT V-ANSWER
	PRINTI "Nobody seems to be awaiting your answer."
	CRLF
	SET 'P-CONT,0
	SET 'QUOTE-FLAG,0
	RTRUE

	.FUNCT V-ATTACK
	FSET? PRSO,ACTORBIT /?L1
	PRINTI "I've known strange people, but fighting a "
	PRINTD PRSO
	PRINTI "?"
	CRLF
	CALL IS-OBJECT-OR-PROPERTY? >STACK
	CALL PRINT-ID,STR?2,STACK
	CALL IS-ANIMAL? >STACK
	CALL PRINT-ID,STR?3,STACK >STACK
	RSTACK
?L1:	ZERO? PRSI /?L6
	EQUAL? PRSI,HANDS \?L5
?L6:	PRINTI "Trying to attack a "
	PRINTD PRSO
	PRINTI " with your bare hands is suicidal."
	CRLF
	CALL PRINT-ID,STR?4 >STACK
	RSTACK
?L5:	IN? PRSI,WINNER /?L9
	PRINTI "You aren't even holding the "
	PRINTD PRSI
	PRINTI "."
	CRLF
	CALL PRINT-ID,STR?5 >STACK
	RSTACK
?L9:	FSET? PRSI,WEAPONBIT /?L12
	PRINTI "Trying to attack the "
	PRINTD PRSO
	PRINTI " with a "
	PRINTD PRSI
	PRINTI " is suicidal."
	CRLF
	CALL PRINT-ID,STR?6 >STACK
	RSTACK
?L12:	PRINTR "You can't."

	.FUNCT V-BACK
	PRINTR "Sorry, my memory is poor. Please give a direction."

	.FUNCT V-BLAST
	PRINTI "You can't blast anything by using words."
	CRLF
	CALL BOMB?,PRSI >STACK
	ZERO? STACK \?L4
	PUSH 0
	JUMP ?L3
?L4:	CALL IS-PERSON? >STACK
?L3:	CALL PRINT-ID,STR?7,STACK
	CALL BOMB?,PRSI >STACK
	ZERO? STACK \?L6
	PUSH 0
	JUMP ?L5
?L6:	CALL IS-OBJ-PROP-ANIMAL? >STACK
?L5:	CALL PRINT-ID,STR?8,STACK
	CALL BOMB?,PRSI >STACK
	ZERO? STACK \?L8
	PUSH 0
	JUMP ?L7
?L8:	CALL IS-SELF? >STACK
?L7:	CALL PRINT-ID,STR?9,STACK >STACK
	RSTACK

	.FUNCT PRE-BOARD,AV
	LOC WINNER >AV
	CALL NULL-F >STACK
	ZERO? STACK \TRUE
	FSET? PRSO,VEHBIT \?L3
	IN? PRSO,HERE /?L4
	PRINTI "The "
	PRINTD PRSO
	PRINTI " must be on the ground to be boarded."
	CRLF
	RETURN 2
?L4:	FSET? AV,VEHBIT \FALSE
	PRINTI "You are already in the "
	PRINTD AV
	PRINTI "!"
	CRLF
	RETURN 2
?L3:	EQUAL? PRSO,WATER,GLOBAL-WATER \?L12
	CALL PERFORM,V?SWIM,PRSO
	RTRUE
?L12:	PRINTI "You have a theory on how to board a "
	PRINTD PRSO
	PRINTI ", perhaps?"
	CRLF
	RETURN 2

	.FUNCT V-BOARD,AV
	PRINTI "You are now in the "
	PRINTD PRSO
	PRINTI "."
	CRLF
	MOVE WINNER,PRSO
	GETP PRSO,P?ACTION >STACK
	CALL STACK,M-ENTER >STACK
	RTRUE

	.FUNCT V-BREATHE
	CALL PERFORM,V?INFLATE,PRSO,LUNGS >STACK
	RSTACK

	.FUNCT V-BRUSH
	PRINTI "If you wish, but heaven only knows why."
	CRLF
	CALL IS-OBJECT-OR-PROPERTY? >STACK
	CALL PRINT-ID,STR?10,STACK >STACK
	RSTACK

	.FUNCT V-BUG
	PRINTR "Bug? Not in a flawless program like this! (Cough, cough)."

	.FUNCT TELL-NO-PRSI
	PRINTR "You didn't say with what!"

	.FUNCT PRE-BURN
	ZERO? PRSI \?L1
	CALL TELL-NO-PRSI
	CALL IS-PERSON? >STACK
	CALL PRINT-ID,STR?11,STACK
	CALL IS-OBJ-PROP-ANIMAL? >STACK
	CALL PRINT-ID,STR?12,STACK
	CALL IS-PART-OF-SELF-OR-SELF? >STACK
	CALL PRINT-ID,STR?13,STACK >STACK
	RSTACK
?L1:	FSET? PRSI,FLAMEBIT \?L3
	FSET? PRSI,ONBIT /FALSE
?L3:	PRINTI "With a "
	PRINTD PRSI
	PRINTI "??!?"
	CRLF
	CALL IS-PERSON? >STACK
	CALL PRINT-ID,STR?14,STACK
	CALL IS-OBJ-PROP-ANIMAL? >STACK
	CALL PRINT-ID,STR?15,STACK
	CALL IS-PART-OF-SELF-OR-SELF? >STACK
	CALL PRINT-ID,STR?16,STACK >STACK
	RSTACK

	.FUNCT V-BURN
	LOC PRSO >STACK
	EQUAL? STACK,RECEPTACLE \?L1
	CALL BALLOON-BURN
	RTRUE
?L1:	FSET? PRSO,BURNBIT \?L3
	IN? PRSO,WINNER /?L6
	IN? WINNER,PRSO \?L4
?L6:	CALL REMOVE-CAREFULLY,PRSO
	PRINTI "The "
	PRINTD PRSO
	PRINTI " catches fire. Unfortunately, you were "
	IN? WINNER,PRSO \?L11
	PRINTI "in"
	JUMP ?L15
?L11:	PRINTI "holding"
	CALL PRINT-ID,STR?17
?L15:	CALL JIGS-UP,STR?18 >STACK
	RSTACK
?L4:	CALL REMOVE-CAREFULLY,PRSO
	PRINTI "The "
	PRINTD PRSO
	PRINTI " catches fire and is consumed."
	CRLF
	CALL PRINT-ID,STR?19 >STACK
	RSTACK
?L3:	PRINTI "You can't burn a "
	PRINTD PRSO
	PRINTI "."
	CRLF
	CALL IS-PERSON? >STACK
	CALL PRINT-ID,STR?20,STACK
	CALL IS-OBJ-PROP-ANIMAL? >STACK
	CALL PRINT-ID,STR?21,STACK
	CALL IS-PART-OF-SELF-OR-SELF? >STACK
	CALL PRINT-ID,STR?22,STACK >STACK
	RSTACK

	.FUNCT V-CHOMP
	PRINTR "Preposterous!"

	.FUNCT V-CLIMB-DOWN
	CALL V-CLIMB-UP,P?DOWN,PRSO >STACK
	RSTACK

	.FUNCT V-CLIMB-FOO
	CALL V-CLIMB-UP,P?UP,PRSO >STACK
	RSTACK

	.FUNCT V-CLIMB-ON
	FSET? PRSO,VEHBIT \?L1
	CALL PERFORM,V?BOARD,PRSO
	RTRUE
?L1:	PRINTI "You can't climb onto the "
	PRINTD PRSO
	PRINTR "."

	.FUNCT V-CLIMB-UP,DIR=P?UP,OBJ=0,X,TX
	ZERO? OBJ /?L1
	EQUAL? PRSO,ROOMS /?L1
	SET 'OBJ,PRSO
?L1:	GETPT HERE,DIR >TX
	ZERO? TX /?L4
	ZERO? OBJ /?L8
	PTSIZE TX >X
	EQUAL? X,NEXIT /?L10
	EQUAL? X,CEXIT,DEXIT,UEXIT \?L8
	GETB TX,0 >STACK
	CALL GLOBAL-IN?,PRSO,STACK >STACK
	ZERO? STACK \?L8
?L10:	PRINTI "The "
	PRINTD OBJ
	PRINTI " do"
	EQUAL? OBJ,STAIRS /?L13
	PRINTI "es"
?L13:	PRINTI "n't lead "
	EQUAL? DIR,P?UP \?L20
	PRINTI "up"
	JUMP ?L24
?L20:	PRINTI "down"
?L24:	PRINTR "ward."
?L8:	CALL DO-WALK,DIR
	RTRUE
?L4:	ZERO? OBJ /?L31
	GETPT PRSO,P?SYNONYM >X
	PTSIZE X >STACK
	CALL ZMEMQ,W?WALL,X,STACK >STACK
	ZERO? STACK /?L31
	PRINTR "Climbing the walls is to no avail."
?L31:	CALL NULL-F >STACK
	ZERO? STACK /?L34
	PRINTR "There are no climbable trees here."
?L34:	EQUAL? OBJ,0,ROOMS \?L37
	PRINTR "You can't go that way."
?L37:	PRINTR "You can't do that!"

	.FUNCT V-CLOSE
	FSET? PRSO,CONTBIT /?L1
	FSET? PRSO,DOORBIT /?L1
	PRINTI "You must tell me how to do that to a "
	PRINTD PRSO
	PRINTR "."
?L1:	FSET? PRSO,SURFACEBIT /?L5
	GETP PRSO,P?CAPACITY >STACK
	ZERO? STACK /?L5
	FSET? PRSO,OPENBIT \?L6
	FCLEAR PRSO,OPENBIT
	PRINTI "Closed."
	CRLF
	ZERO? LIT /TRUE
	CALL LIT?,HERE >LIT
	ZERO? LIT \TRUE
	PRINTR "It is now pitch black."
?L6:	PRINTR "It is already closed."
?L5:	FSET? PRSO,DOORBIT \?L18
	FSET? PRSO,OPENBIT \?L19
	FCLEAR PRSO,OPENBIT
	PRINTI "The "
	PRINTD PRSO
	PRINTR " is now closed."
?L19:	PRINTR "It is already closed."
?L18:	PRINTR "You cannot close that."

	.FUNCT V-COMMAND
	FSET? PRSO,ACTORBIT \?L1
	PRINTI "The "
	PRINTD PRSO
	PRINTR " pays no attention."
?L1:	PRINTR "You cannot talk to that!"

	.FUNCT V-COUNT
	EQUAL? PRSO,BLESSINGS \?L1
	PRINTR "Well, for one, you are playing Zork..."
?L1:	PRINTR "You have lost your mind."

	.FUNCT V-CROSS
	PRINTR "You can't cross that!"

	.FUNCT V-CURSES
	ZERO? PRSO /?L1
	FSET? PRSO,ACTORBIT \?L3
	PRINTI "Insults of this nature won't help you."
	CRLF
	CALL PRINT-ID,STR?23
	CALL PRINT-ID,STR?24 >STACK
	RSTACK
?L3:	PRINTI "What a loony!"
	CRLF
	CALL PRINT-ID,STR?25 >STACK
	RSTACK
?L1:	PRINTI "Such language in a high-class establishment like this!"
	CRLF
	CALL PRINT-ID,STR?26 >STACK
	RSTACK

	.FUNCT V-CUT
	FSET? PRSO,ACTORBIT \?L1
	CALL PERFORM,V?ATTACK,PRSO,PRSI >STACK
	RSTACK
?L1:	FSET? PRSO,BURNBIT \?L3
	FSET? PRSI,WEAPONBIT \?L12
	IN? WINNER,PRSO \?L4
	PRINTI "Not a bright idea, especially since you're in it."
	CRLF
	CALL PRINT-ID,STR?27
	RTRUE
?L4:	CALL REMOVE-CAREFULLY,PRSO
	PRINTI "Your skillful "
	PRINTD PRSI
	PRINTI "smanship slices the "
	PRINTD PRSO
	PRINTI " into innumerable slivers which blow away."
	CRLF
	CALL PRINT-ID,STR?28 >STACK
	RSTACK
?L3:	FSET? PRSI,WEAPONBIT /?L11
?L12:	PRINTI "The ""cutting edge"" of a "
	PRINTD PRSI
	PRINTI " is hardly adequate."
	CRLF
	CALL PRINT-ID,STR?29 >STACK
	RSTACK
?L11:	PRINTI "Strange concept, cutting the "
	PRINTD PRSO
	PRINTI "...."
	CRLF
	CALL PRINT-ID,STR?30 >STACK
	RSTACK

	.FUNCT V-DEFLATE
	PRINTR "Come on, now!"

	.FUNCT V-DIG
	ZERO? PRSI \?L1
	SET 'PRSI,HANDS
?L1:	FSET? PRSI,TOOLBIT \?L4
	PRINTI "Digging with the "
	PRINTD PRSI
	PRINTR " is slow and tedious."
?L4:	PRINTI "Digging with a "
	PRINTD PRSI
	PRINTR " is silly."

	.FUNCT V-DISEMBARK
	EQUAL? PRSO,ROOMS \?L1
	LOC WINNER >STACK
	FSET? STACK,VEHBIT \?L1
	LOC WINNER >STACK
	CALL PERFORM,V?DISEMBARK,STACK
	RTRUE
?L1:	LOC WINNER >STACK
	EQUAL? STACK,PRSO /?L3
	PRINTI "You're not in that!"
	CRLF
	RETURN 2
?L3:	FSET? HERE,RLANDBIT \?L8
	PRINTI "You are on your own feet again."
	CRLF
	MOVE WINNER,HERE
	RTRUE
?L8:	PRINTI "You realize that getting out here would be fatal."
	CRLF
	RETURN 2

	.FUNCT V-DISENCHANT
	IN? PRSO,HERE \TRUE
	EQUAL? SPELL-USED,W?FEEBLE,W?FUMBLE,W?FEAR /?L4
	EQUAL? SPELL-USED,W?FREEZE,W?FALL,W?FERMENT /?L4
	EQUAL? SPELL-USED,W?FIERCE,W?FENCE,W?FANTASIZE \?L3
?L4:	FSET? PRSO,ACTORBIT \FALSE
	EQUAL? SPELL-USED,W?FEEBLE \?L7
	PRINTI "The "
	PRINTD PRSO
	PRINTR " seems stronger now."
?L7:	EQUAL? SPELL-USED,W?FUMBLE \?L11
	PRINTI "The "
	PRINTD PRSO
	PRINTR " no longer appears clumsy."
?L11:	EQUAL? SPELL-USED,W?FEAR \?L14
	PRINTI "The "
	PRINTD PRSO
	PRINTR " no longer appears afraid."
?L14:	EQUAL? SPELL-USED,W?FREEZE \?L17
	PRINTI "The "
	PRINTD PRSO
	PRINTR " moves again."
?L17:	EQUAL? SPELL-USED,W?FERMENT \?L20
	PRINTI "The "
	PRINTD PRSO
	PRINTR " stops swaying."
?L20:	EQUAL? SPELL-USED,W?FIERCE \FALSE
	PRINTI "The "
	PRINTD PRSO
	PRINTR " appears more peaceful."
?L3:	EQUAL? SPELL-USED,W?FLOAT \?L28
	PRINTI "The "
	PRINTD PRSO
	PRINTR " sinks to the ground."
?L28:	EQUAL? SPELL-USED,W?FUDGE \FALSE
	PRINTR "The sweet smell has dispersed."

	.FUNCT V-DRINK
	CALL V-EAT >STACK
	RSTACK

	.FUNCT V-DRINK-FROM
	PRINTR "How peculiar!"

	.FUNCT PRE-DROP
	LOC WINNER >STACK
	EQUAL? PRSO,STACK \FALSE
	CALL PERFORM,V?DISEMBARK,PRSO
	RTRUE

	.FUNCT V-DROP
	CALL IDROP >STACK
	ZERO? STACK /FALSE
	PRINTR "Dropped."

	.FUNCT V-EAT,EAT?=0,DRINK?=0,NOBJ=0,?TMP
	FSET? PRSO,FOODBIT /?L3
	SET 'EAT?,0
	JUMP ?L1
?L3:	SET 'EAT?,1
	IN? PRSO,WINNER /?L5
	LOC PRSO >STACK
	IN? STACK,WINNER /?L5
	PRINTI "You're not holding that."
	CRLF
	CRLF
	RTRUE
?L5:	EQUAL? PRSA,V?DRINK \?L9
	PRINTR "How can you drink that?"
?L9:	PRINTI "Thank you very much. It really hit the spot."
	CALL REMOVE-CAREFULLY,PRSO
	CRLF
	RTRUE
?L1:	FSET? PRSO,DRINKBIT \?L15
	SET 'DRINK?,1
	LOC PRSO >NOBJ
	IN? PRSO,GLOBAL-OBJECTS /?L18
	CALL GLOBAL-IN?,GLOBAL-WATER,HERE >STACK
	ZERO? STACK \?L18
	EQUAL? PRSO,PSEUDO-OBJECT \?L16
?L18:	CALL HIT-SPOT >STACK
	RSTACK
?L16:	ZERO? NOBJ /?L20
	CALL ACCESSIBLE?,NOBJ >STACK
	ZERO? STACK \?L19
?L20:	PRINTR "There isn't any water here."
?L19:	CALL ACCESSIBLE?,NOBJ >STACK
	ZERO? STACK /?L23
	IN? NOBJ,WINNER /?L23
	PRINTI "You have to be holding the "
	PRINTD NOBJ
	PRINTR " first."
?L23:	FSET? NOBJ,OPENBIT /?L26
	PRINTI "You'll have to open the "
	PRINTD NOBJ
	PRINTR " first."
?L26:	CALL HIT-SPOT >STACK
	RSTACK
?L15:	ZERO? EAT? \FALSE
	ZERO? DRINK? \FALSE
	PRINTI "I don't think that the "
	PRINTD PRSO
	PRINTI " would agree with you."
	CRLF
	CALL DANGEROUS-FOOD? >?TMP
	ZERO? ?TMP /?L34
	PUSH ?TMP
	JUMP ?L33
?L34:	CALL DANGEROUS-DRINK? >STACK
?L33:	CALL PRINT-ID,STR?31,STACK >STACK
	RSTACK

	.FUNCT HIT-SPOT
	EQUAL? PRSO,WATER \?L1
	CALL GLOBAL-IN?,GLOBAL-WATER,HERE >STACK
	ZERO? STACK \?L1
	CALL REMOVE-CAREFULLY,PRSO
?L1:	PRINTR "Thank you very much. I was rather thirsty (from all this talking, probably)."

	.FUNCT V-ECHO,LST,MAX,ECH=0,CNT
	PRINTR "echo echo ..."

	.FUNCT V-ENCHANT
	ZERO? WAND-ON /?L1
	SET 'SPELL-VICTIM,WAND-ON
?L1:	ZERO? SPELL-VICTIM /?L4
	ZERO? SPELL-USED \?L6
	PRINTR "You must be more specific."
?L6:	EQUAL? SPELL-USED,W?FEEBLE,W?FUMBLE,W?FEAR /?L13
	EQUAL? SPELL-USED,W?FREEZE,W?FALL,W?FERMENT /?L13
	EQUAL? SPELL-USED,W?FIERCE,W?FENCE,W?FANTASIZE \?L11
?L13:	FSET? PRSO,ACTORBIT \?L14
	PRINTR "The wand stops glowing, but there is no other obvious effect."
?L14:	PRINTI "That might have done something, but it's hard to tell with a "
	PRINTD PRSO
	PRINTR "."
?L11:	EQUAL? SPELL-USED,W?FUDGE \?L21
	PRINTR "A strong odor of chocolate permeates the room."
?L21:	EQUAL? SPELL-USED,W?FLUORESCE \?L24
	FSET PRSO,LIGHTBIT
	FSET PRSO,ONBIT
	SET 'LIT,1
	PRINTI "The "
	PRINTD PRSO
	PRINTR " begins to glow."
?L24:	EQUAL? SPELL-USED,W?FILCH \?L27
	SET 'SPELL-HANDLED?,1
	FSET? PRSO,TAKEBIT \?L28
	MOVE PRSO,WINNER
	CALL SCORE-OBJ,PRSO
	PRINTR "Filched!"
?L28:	PRINTI "You can't filch the "
	PRINTD PRSO
	PRINTR "!"
?L27:	EQUAL? SPELL-USED,W?FLOAT \?L35
	FSET? PRSO,TAKEBIT \?L35
	EQUAL? SPELL-VICTIM,COLLAR \?L36
	IN? COLLAR,CERBERUS \?L36
	SET 'SPELL-VICTIM,CERBERUS
?L36:	PRINTI "The "
	PRINTD PRSO
	PRINTR " floats serenely in midair."
?L35:	EQUAL? SPELL-USED,W?FRY \?L41
	FSET? PRSO,TAKEBIT \?L41
	SET 'SPELL-HANDLED?,1
	CALL REMOVE-CAREFULLY,PRSO
	PRINTI "The "
	PRINTD PRSO
	PRINTR " goes up in a puff of smoke."
?L41:	SET 'SPELL-VICTIM,0
	PRINTR "The wand stops glowing, but there is no other apparent effect."
?L4:	SET 'SPELL-VICTIM,0
	PRINTR "Nothing happens."

	.FUNCT REMOVE-CAREFULLY,OBJ,OLIT
	EQUAL? OBJ,P-IT-OBJECT \?L1
	SET 'P-IT-OBJECT,0
?L1:	SET 'OLIT,LIT
	REMOVE OBJ
	CALL LIT?,HERE >LIT
	EQUAL? OLIT,0,LIT /TRUE
	PRINTR "You are left in the dark..."

	.FUNCT V-ENTER
	CALL DO-WALK,P?IN >STACK
	RSTACK

	.FUNCT V-EXAMINE
	GETP PRSO,P?TEXT >STACK
	ZERO? STACK /?L1
	GETP PRSO,P?TEXT >STACK
	PRINT STACK
	CRLF
	RTRUE
?L1:	FSET? PRSO,CONTBIT /?L6
	FSET? PRSO,DOORBIT \?L5
?L6:	CALL V-LOOK-INSIDE >STACK
	RSTACK
?L5:	PRINTI "There's nothing special about the "
	PRINTD PRSO
	PRINTR "."

	.FUNCT V-EXIT
	EQUAL? PRSO,0,ROOMS \?L1
	LOC WINNER >STACK
	FSET? STACK,VEHBIT \?L1
	LOC WINNER >STACK
	CALL PERFORM,V?DISEMBARK,STACK
	RTRUE
?L1:	ZERO? PRSO /?L3
	IN? WINNER,PRSO \?L3
	CALL PERFORM,V?DISEMBARK,PRSO
	RTRUE
?L3:	CALL DO-WALK,P?OUT >STACK
	RSTACK

	.FUNCT V-EXORCISE
	PRINTR "What a bizarre concept!"

	.FUNCT PRE-FILL,TX
	ZERO? PRSI \?L6
	GETPT HERE,P?GLOBAL >TX
	ZERO? TX /?L3
	PTSIZE TX >STACK
	DEC 'STACK
	CALL ZMEMQB,GLOBAL-WATER,TX,STACK >STACK
	ZERO? STACK /?L3
	CALL PERFORM,V?FILL,PRSO,GLOBAL-WATER
	RTRUE
?L3:	LOC WINNER >STACK
	IN? WATER,STACK \?L5
	CALL PERFORM,V?FILL,PRSO,WATER
	RTRUE
?L5:	PRINTR "There is nothing to fill it with."
?L6:	EQUAL? PRSI,WATER,GLOBAL-WATER /FALSE
	CALL PERFORM,V?PUT,PRSI,PRSO
	RTRUE

	.FUNCT V-FILL
	ZERO? PRSI \?L1
	CALL GLOBAL-IN?,GLOBAL-WATER,HERE >STACK
	ZERO? STACK /?L3
	CALL PERFORM,V?FILL,PRSO,GLOBAL-WATER
	RTRUE
?L3:	LOC WINNER >STACK
	IN? WATER,STACK \?L5
	CALL PERFORM,V?FILL,PRSO,WATER
	RTRUE
?L5:	PRINTR "There's nothing to fill it with."
?L1:	PRINTR "You may know how to do that, but I don't."

	.FUNCT V-FIND,L
	LOC PRSO >L
	EQUAL? PRSO,HANDS,LUNGS \?L1
	PRINTR "Within six feet of your head, assuming you haven't left that somewhere."
?L1:	EQUAL? PRSO,ME \?L5
	PRINTR "You're around here somewhere..."
?L5:	EQUAL? L,GLOBAL-OBJECTS \?L8
	PRINTR "You find it."
?L8:	IN? PRSO,WINNER \?L11
	PRINTR "You have it."
?L11:	IN? PRSO,HERE /?L15
	CALL GLOBAL-IN?,PRSO,HERE >STACK
	ZERO? STACK \?L15
	EQUAL? PRSO,PSEUDO-OBJECT \?L14
?L15:	PRINTR "It's right here."
?L14:	FSET? L,ACTORBIT \?L18
	PRINTI "The "
	PRINTD L
	PRINTR " has it."
?L18:	FSET? L,SURFACEBIT \?L21
	PRINTI "It's on the "
	PRINTD L
	PRINTR "."
?L21:	FSET? L,CONTBIT \?L24
	PRINTI "It's in the "
	PRINTD L
	PRINTR "."
?L24:	PRINTR "Beats me."

	.FUNCT V-FOLLOW
	PRINTR "You're nuts!"

	.FUNCT V-FROBOZZ
	PRINTR "The FROBOZZ Corporation created, owns, and operates this dungeon."

	.FUNCT PRE-GIVE
	CALL HELD?,PRSO >STACK
	ZERO? STACK \FALSE
	PRINTI "That's easy for you to say since you don't even have the "
	PRINTD PRSO
	PRINTR "."

	.FUNCT V-GIVE
	FSET? PRSI,ACTORBIT /?L1
	PRINTI "You can't give a "
	PRINTD PRSO
	PRINTI " to a "
	PRINTD PRSI
	PRINTR "!"
?L1:	PRINTI "The "
	PRINTD PRSI
	PRINTR " refuses it politely."

	.FUNCT V-HATCH
	PRINTR "Bizarre!"

	.FUNCT V-HELLO
	ZERO? PRSO /?L1
	FSET? PRSO,ACTORBIT \?L3
	PRINTI "The "
	PRINTD PRSO
	PRINTR " bows his head to you in greeting."
?L3:	PRINTI "It's a well known fact that only schizophrenics say ""Hello"" to a "
	PRINTD PRSO
	PRINTR "."
?L1:	CALL PICK-ONE,HELLOS >STACK
	PRINT STACK
	CRLF
	RTRUE

	.FUNCT V-INCANT
	ZERO? SPELL-USED /?L1
	PRINTI "Nothing happens."
	CRLF
	JUMP ?L8
?L1:	ZERO? WAND-ON /?L5
	SET 'SPELL-VICTIM,WAND-ON
	GET P-LEXV,P-CONT >SPELL-USED
	PRINTI "The wand glows very brightly for a moment."
	CRLF
	RANDOM 10 >STACK
	ADD 10,STACK >STACK
	CALL QUEUE,I-SPELL,STACK >STACK
	PUT STACK,0,1
	SET 'WAND-ON,0
	CALL PERFORM,V?ENCHANT,SPELL-VICTIM
	JUMP ?L8
?L5:	PRINTI "The incantation echoes back faintly, but nothing else happens."
	CRLF
?L8:	SET 'QUOTE-FLAG,0
	SET 'P-CONT,0
	RTRUE

	.FUNCT V-INFLATE
	PRINTR "How can you inflate that?"

	.FUNCT V-KICK,?TMP
	CALL IS-PERSON? >?TMP
	ZERO? ?TMP /?L2
	PUSH ?TMP
	JUMP ?L1
?L2:	CALL IS-OBJ-PROP-ANIMAL? >STACK
?L1:	CALL PRINT-ID,STR?32,STACK
	CALL IS-PART-OF-SELF-OR-SELF? >STACK
	CALL PRINT-ID,STR?33,STACK
	CALL HACK-HACK,STR?34 >STACK
	RSTACK

	.FUNCT V-KISS
	PRINTI "I'd sooner kiss a pig."
	CRLF
	CALL IS-PERSON? >STACK
	CALL PRINT-ID,STR?35,STACK >STACK
	RSTACK

	.FUNCT V-KNOCK
	FSET? PRSO,DOORBIT \?L1
	PRINTR "Nobody's home."
?L1:	PRINTI "Why knock on a "
	PRINTD PRSO
	PRINTR "?"

	.FUNCT V-LAMP-OFF
	FSET? PRSO,LIGHTBIT \?L1
	FSET? PRSO,ONBIT /?L3
	PRINTR "It is already off."
?L3:	FCLEAR PRSO,ONBIT
	ZERO? LIT /?L8
	CALL LIT?,HERE >LIT
?L8:	PRINTI "The "
	PRINTD PRSO
	PRINTI " is now off."
	CRLF
	ZERO? LIT \TRUE
	PRINTR "It is now pitch black."
?L1:	PRINTR "You can't turn that off."

	.FUNCT V-LAMP-ON
	FSET? PRSO,LIGHTBIT \?L1
	FSET? PRSO,ONBIT \?L3
	PRINTR "It is already on."
?L3:	FSET PRSO,ONBIT
	PRINTI "The "
	PRINTD PRSO
	PRINTI " is now on."
	CRLF
	ZERO? LIT \TRUE
	CALL LIT?,HERE >LIT
	CRLF
	CALL V-LOOK
	RTRUE
?L1:	FSET? PRSO,BURNBIT \?L13
	PRINTI "If you wish to burn the "
	PRINTD PRSO
	PRINTI ", you should say so."
	CRLF
	CALL IS-OBJECT-OR-PROPERTY? >STACK
	CALL PRINT-ID,STR?36,STACK
	RTRUE
?L13:	PRINTR "You can't turn that on."

	.FUNCT V-LAUNCH
	FSET? PRSO,VEHBIT \?L1
	PRINTR "You can't launch that by saying ""launch""!"
?L1:	PRINTR "That's pretty weird."

	.FUNCT V-LEAN-ON
	PRINTR "Getting tired?"

	.FUNCT V-LEAP,TX,S
	ZERO? PRSO /?L1
	IN? PRSO,HERE \?L3
	FSET? PRSO,ACTORBIT \?L5
	PRINTI "The "
	PRINTD PRSO
	PRINTR " is too big to jump over."
?L5:	CALL V-SKIP >STACK
	RSTACK
?L3:	PRINTR "That would be a good trick."
?L1:	GETPT HERE,P?DOWN >TX
	ZERO? TX /?L13
	PTSIZE TX >S
	EQUAL? S,2 /?L16
	EQUAL? S,4 \?L14
	GETB TX,1 >STACK
	VALUE STACK >STACK
	ZERO? STACK \?L14
?L16:	PRINTI "This was not a very safe place to try jumping."
	CRLF
	CALL PRINT-ID,STR?37
	CALL PICK-ONE,JUMPLOSS >STACK
	CALL JIGS-UP,STACK >STACK
	RSTACK
?L14:	CALL NULL-F >STACK
	ZERO? STACK \TRUE
	CALL V-SKIP >STACK
	RSTACK
?L13:	CALL V-SKIP >STACK
	RSTACK

	.FUNCT V-LEAVE
	CALL DO-WALK,P?OUT >STACK
	RSTACK

	.FUNCT V-LISTEN
	PRINTI "The "
	PRINTD PRSO
	PRINTR " makes no sound."

	.FUNCT V-LOCK
	PRINTR "It doesn't seem to work."

	.FUNCT V-LOOK
	CALL DESCRIBE-ROOM,1 >STACK
	ZERO? STACK /FALSE
	CALL DESCRIBE-OBJECTS,1 >STACK
	RSTACK

	.FUNCT V-LOOK-BEHIND
	PRINTI "There is nothing behind the "
	PRINTD PRSO
	PRINTR "."

	.FUNCT V-LOOK-INSIDE
	FSET? PRSO,DOORBIT \?L1
	FSET? PRSO,OPENBIT \?L3
	PRINTI "The "
	PRINTD PRSO
	PRINTR " is open, but I can't tell what's beyond it."
?L3:	PRINTI "The "
	PRINTD PRSO
	PRINTR " is closed."
?L1:	FSET? PRSO,CONTBIT \?L10
	FSET? PRSO,ACTORBIT \?L11
	PRINTR "There is nothing special to be seen."
?L11:	CALL SEE-INSIDE?,PRSO >STACK
	ZERO? STACK /?L15
	FIRST? PRSO >STACK \?L16
	CALL PRINT-CONT,PRSO >STACK
	ZERO? STACK \TRUE
?L16:	CALL NULL-F >STACK
	ZERO? STACK \TRUE
	PRINTI "The "
	PRINTD PRSO
	PRINTR " is empty."
?L15:	PRINTI "The "
	PRINTD PRSO
	PRINTR " is closed."
?L10:	PRINTI "You can't look inside a "
	PRINTD PRSO
	PRINTR "."

	.FUNCT V-LOOK-ON
	FSET? PRSO,SURFACEBIT \?L1
	CALL PERFORM,V?LOOK-INSIDE,PRSO
	RTRUE
?L1:	PRINTI "Look on a "
	PRINTD PRSO
	PRINTR "???"

	.FUNCT V-LOOK-UNDER
	PRINTR "There is nothing but dust there."

	.FUNCT V-LOWER
	CALL HACK-HACK,STR?38 >STACK
	RSTACK

	.FUNCT V-MAKE
	PRINTR "You can't do that."

	.FUNCT V-MELT
	PRINTI "It's not clear that a "
	PRINTD PRSO
	PRINTI " can be melted."
	CRLF
	CALL IS-PERSON? >STACK
	CALL PRINT-ID,STR?39,STACK
	CALL IS-OBJ-PROP-ANIMAL? >STACK
	CALL PRINT-ID,STR?40,STACK
	CALL IS-PART-OF-SELF-OR-SELF? >STACK
	CALL PRINT-ID,STR?41,STACK >STACK
	RSTACK

	.FUNCT PRE-MOVE
	CALL HELD?,PRSO >STACK
	ZERO? STACK /FALSE
	PRINTR "You aren't an accomplished enough juggler."

	.FUNCT V-MOVE
	FSET? PRSO,TAKEBIT \?L1
	PRINTI "Moving the "
	PRINTD PRSO
	PRINTR " reveals nothing."
?L1:	PRINTI "You can't move the "
	PRINTD PRSO
	PRINTR "."

	.FUNCT V-MUMBLE
	PRINTR "You'll have to speak up if you expect me to hear you!"

	.FUNCT PRE-MUNG
	CALL NULL-F >STACK
	ZERO? STACK \TRUE
	ZERO? PRSI /?L4
	FSET? PRSI,WEAPONBIT /FALSE
?L4:	PRINTI "Trying to destroy the "
	PRINTD PRSO
	PRINTI " with "
	CALL IS-PERSON? >STACK
	CALL PRINT-ID,STR?42,STACK
	CALL IS-OBJ-PROP-ANIMAL? >STACK
	CALL PRINT-ID,STR?43,STACK
	CALL IS-PART-OF-SELF-OR-SELF? >STACK
	CALL PRINT-ID,STR?44,STACK
	ZERO? PRSI \?L7
	PRINTI "your bare hands"
	JUMP ?L11
?L7:	PRINTI "a "
	PRINTD PRSI
?L11:	PRINTR " is futile."

	.FUNCT V-MUNG
	FSET? PRSO,ACTORBIT \?L1
	CALL PERFORM,V?ATTACK,PRSO,PRSI
	RTRUE
?L1:	PRINTI "Nice try."
	CRLF
	CALL IS-OBJECT-OR-PROPERTY? >STACK
	CALL PRINT-ID,STR?45,STACK >STACK
	RSTACK

	.FUNCT V-ODYSSEUS
	CALL NULL-F >STACK
	ZERO? STACK \TRUE
	PRINTR "Wasn't he a sailor?"

	.FUNCT V-OIL
	PRINTR "You probably put spinach in your gas tank, too."

	.FUNCT V-OPEN,F,STR
	FSET? PRSO,CONTBIT \?L1
	GETP PRSO,P?CAPACITY >STACK
	ZERO? STACK /?L1
	FSET? PRSO,OPENBIT \?L3
	PRINTR "It is already open."
?L3:	FSET PRSO,OPENBIT
	FSET PRSO,TOUCHBIT
	FIRST? PRSO >STACK \?L10
	FSET? PRSO,TRANSBIT \?L8
?L10:	PRINTR "Opened."
?L8:	FIRST? PRSO >F \?L13
	NEXT? F >STACK /?L13
	FSET? F,TOUCHBIT /?L13
	GETP F,P?FDESC >STR
	ZERO? STR /?L13
	PRINTI "The "
	PRINTD PRSO
	PRINTI " opens."
	CRLF
	PRINT STR
	CRLF
	RTRUE
?L13:	PRINTI "Opening the "
	PRINTD PRSO
	PRINTI " reveals "
	CALL PRINT-CONTENTS,PRSO
	PRINTR "."
?L1:	FSET? PRSO,DOORBIT \?L23
	FSET? PRSO,OPENBIT \?L24
	PRINTR "It is already open."
?L24:	PRINTI "The "
	PRINTD PRSO
	PRINTI " opens."
	CRLF
	FSET PRSO,OPENBIT
	RTRUE
?L23:	PRINTI "You must tell me how to do that to a "
	PRINTD PRSO
	PRINTR "."

	.FUNCT V-OVERBOARD,LOCN
	CALL NULL-F >STACK
	ZERO? STACK \TRUE
	LOC WINNER >STACK
	FSET? STACK,VEHBIT \?L3
	CALL PERFORM,V?THROW,PRSO
	RTRUE
?L3:	PRINTR "Huh?"

	.FUNCT V-PICK
	PRINTI "You can't pick that."
	CRLF
	CALL IS-BAD-TO-PICK? >STACK
	CALL PRINT-ID,STR?46,STACK >STACK
	RSTACK

	.FUNCT V-PLAY
	FSET? PRSO,ACTORBIT \?L1
	PRINTI "You become so engrossed in the role of the "
	PRINTD PRSO
	PRINTI " that you kill yourself, just as he might have done!"
	CRLF
	CALL PRINT-ID,STR?47
	CALL JIGS-UP,STR?48 >STACK
	RSTACK
?L1:	PRINTR "That's silly!"

	.FUNCT V-PLUG
	PRINTR "This has no effect."

	.FUNCT V-POUR-ON
	EQUAL? PRSO,WATER \?L1
	CALL REMOVE-CAREFULLY,PRSO
	FSET? PRSI,FLAMEBIT \?L3
	FSET? PRSI,ONBIT \?L3
	PRINTI "The "
	PRINTD PRSI
	PRINTI " is extinguished."
	CRLF
	EQUAL? PRSI,BINF-FLAG \?L7
	SET 'BINF-FLAG,0
?L7:	FCLEAR PRSI,ONBIT
	FCLEAR PRSI,FLAMEBIT
	RTRUE
?L3:	PRINTI "The water spills over the "
	PRINTD PRSI
	PRINTR ", to the floor, and evaporates."
?L1:	CALL NULL-F >STACK
	ZERO? STACK \TRUE
	PRINTR "You can't pour that."

	.FUNCT V-PRAY
	CALL NULL-F >STACK
	ZERO? STACK \TRUE
	PRINTR "If you pray enough, your prayers may be answered."

	.FUNCT V-PUMP
	CALL NULL-F >STACK
	ZERO? STACK \TRUE
	CALL NULL-F >STACK
	ZERO? STACK \TRUE
	PRINTR "It's really not clear how."

	.FUNCT V-PUSH
	CALL HACK-HACK,STR?49 >STACK
	RSTACK

	.FUNCT V-PUSH-TO
	PRINTR "You can't push things to that."

	.FUNCT PRE-PUT
	CALL NULL-F >STACK
	ZERO? STACK \FALSE
	CALL PRE-GIVE >STACK
	RSTACK

	.FUNCT V-PUT,?TMP
	FSET? PRSI,OPENBIT /?L7
	FSET? PRSI,DOORBIT /?L4
	FSET? PRSI,CONTBIT /?L4
	FSET? PRSI,VEHBIT /?L4
	PRINTR "You can't do that."
?L4:	FSET? PRSI,OPENBIT /?L7
	PRINTI "The "
	PRINTD PRSI
	PRINTI " isn't open."
	CRLF
	CALL THIS-IS-IT,PRSI >STACK
	RSTACK
?L7:	EQUAL? PRSI,PRSO \?L11
	PRINTR "How can you do that?"
?L11:	IN? PRSO,PRSI \?L14
	PRINTI "The "
	PRINTD PRSO
	PRINTI " is already in the "
	PRINTD PRSI
	PRINTR "."
?L14:	CALL WEIGHT,PRSI >?TMP
	CALL WEIGHT,PRSO >STACK
	ADD ?TMP,STACK >?TMP
	GETP PRSI,P?SIZE >STACK
	SUB ?TMP,STACK >?TMP
	GETP PRSI,P?CAPACITY >STACK
	GRTR? ?TMP,STACK \?L17
	PRINTR "There's no room."
?L17:	CALL HELD?,PRSO >STACK
	ZERO? STACK \?L20
	FSET? PRSO,TRYTAKEBIT \?L20
	PRINTI "You don't have the "
	PRINTD PRSO
	PRINTR "."
?L20:	CALL HELD?,PRSO >STACK
	ZERO? STACK \?L23
	CALL ITAKE >STACK
	ZERO? STACK /TRUE
?L23:	MOVE PRSO,PRSI
	FSET PRSO,TOUCHBIT
	CALL SCORE-OBJ,PRSO
	PRINTR "Done."

	.FUNCT V-PUT-BEHIND
	PRINTR "That hiding place is too obvious."

	.FUNCT V-PUT-ON
	EQUAL? PRSI,GROUND \?L1
	CALL PERFORM,V?DROP,PRSO
	RTRUE
?L1:	FSET? PRSI,SURFACEBIT \?L3
	CALL V-PUT >STACK
	RSTACK
?L3:	PRINTI "There's no good surface on the "
	PRINTD PRSI
	PRINTR "."

	.FUNCT V-PUT-UNDER
	PRINTR "You can't do that."

	.FUNCT V-RAISE
	CALL V-LOWER >STACK
	RSTACK

	.FUNCT V-RAPE
	PRINTI "What a (ahem!) strange idea."
	CRLF
	CALL IS-PERSON? >STACK
	CALL PRINT-ID,STR?50,STACK
	CALL IS-ANIMAL? >STACK
	CALL PRINT-ID,STR?51,STACK >STACK
	RSTACK

	.FUNCT PRE-READ
	ZERO? LIT \?L1
	PRINTR "It is impossible to read in the dark."
?L1:	ZERO? PRSI /FALSE
	FSET? PRSI,TRANSBIT /FALSE
	PRINTI "How does one look through a "
	PRINTD PRSI
	PRINTR "?"

	.FUNCT V-READ
	FSET? PRSO,READBIT /?L1
	PRINTI "How does one read a "
	PRINTD PRSO
	PRINTR "?"
?L1:	GETP PRSO,P?TEXT >STACK
	PRINT STACK
	CRLF
	RTRUE

	.FUNCT V-READ-PAGE
	CALL PERFORM,V?READ,PRSO
	RTRUE

	.FUNCT V-REPENT
	PRINTR "It could very well be too late!"

	.FUNCT V-REPLY
	PRINTI "It is hardly likely that the "
	PRINTD PRSO
	PRINTI " is interested."
	CRLF
	SET 'P-CONT,0
	SET 'QUOTE-FLAG,0
	RTRUE

	.FUNCT V-RING
	PRINTR "How, exactly, can you ring that?"

	.FUNCT V-RUB
	CALL IS-PERSON? >STACK
	CALL PRINT-ID,STR?52,STACK
	CALL HACK-HACK,STR?53 >STACK
	RSTACK

	.FUNCT V-SAY,V
	ZERO? SPELL-USED \?L3
	ZERO? WAND-ON /?L1
?L3:	CALL PERFORM,V?INCANT
	RTRUE
?L1:	SET 'QUOTE-FLAG,0
	CALL FIND-IN,HERE,ACTORBIT >V
	ZERO? V /?L5
	PRINTI "You must address the "
	PRINTD V
	PRINTI " directly."
	CRLF
	SET 'P-CONT,0
	RTRUE
?L5:	GET P-LEXV,P-CONT >STACK
	EQUAL? STACK,W?HELLO /TRUE
	SET 'P-CONT,0
	PRINTR "Talking to yourself is a sign of impending mental collapse."

	.FUNCT V-SEARCH
	PRINTR "You find nothing unusual."

	.FUNCT V-SEND
	FSET? PRSO,ACTORBIT \?L1
	PRINTI "Why would you send for the "
	PRINTD PRSO
	PRINTR "?"
?L1:	PRINTR "That doesn't make sends."

	.FUNCT PRE-SGIVE
	CALL PERFORM,V?GIVE,PRSI,PRSO
	RTRUE

	.FUNCT V-SGIVE
	PRINTR "Foo!"

	.FUNCT V-SHAKE
	FSET? PRSO,ACTORBIT \?L1
	PRINTR "This seems to have no effect."
?L1:	FSET? PRSO,TAKEBIT /?L5
	PRINTR "You can't take it; thus, you can't shake it!"
?L5:	FSET? PRSO,CONTBIT \?L8
	FSET? PRSO,OPENBIT \?L9
	FIRST? PRSO >STACK \?L11
	CALL SHAKE-LOOP
	PRINTI "The contents of the "
	PRINTD PRSO
	PRINTI " spill "
	FSET? HERE,RLANDBIT /?L15
	PRINTI "out and disappear"
	JUMP ?L19
?L15:	PRINTI "to the ground"
?L19:	PRINTR "."
?L11:	PRINTR "Shaken."
?L9:	FIRST? PRSO >STACK \?L28
	PRINTI "It sounds like there is something inside the "
	PRINTD PRSO
	PRINTR "."
?L28:	PRINTI "The "
	PRINTD PRSO
	PRINTR " sounds empty."
?L8:	PRINTR "Shaken."

	.FUNCT SHAKE-LOOP,X
?L1:	FIRST? PRSO >X \TRUE
	FSET X,TOUCHBIT
	EQUAL? X,WATER \?L5
	PUSH PSEUDO-OBJECT
	JUMP ?L8
?L5:	FSET? HERE,RLANDBIT /?L7
	PUSH PSEUDO-OBJECT
	JUMP ?L8
?L7:	PUSH HERE
?L8:	MOVE X,STACK
	JUMP ?L1

	.FUNCT V-SKIP
	CALL PICK-ONE,WHEEEEE >STACK
	PRINT STACK
	CRLF
	RTRUE

	.FUNCT V-SMELL
	PRINTI "It smells like a "
	PRINTD PRSO
	PRINTR "."

	.FUNCT V-SPIN
	PRINTR "You can't spin that!"

	.FUNCT V-SPRAY
	CALL V-SQUEEZE >STACK
	RSTACK

	.FUNCT V-SQUEEZE
	FSET? PRSO,ACTORBIT \?L1
	PRINTI "The "
	PRINTD PRSO
	PRINTR " does not understand this."
?L1:	PRINTR "How singularly useless."

	.FUNCT V-SSPRAY
	CALL PERFORM,V?SPRAY,PRSI,PRSO >STACK
	RSTACK

	.FUNCT V-STAB,W
	CALL FIND-WEAPON,WINNER >W
	ZERO? W /?L1
	CALL PERFORM,V?ATTACK,PRSO,W
	RTRUE
?L1:	PRINTI "No doubt you propose to stab the "
	PRINTD PRSO
	PRINTI " with your pinky?"
	CRLF
	CALL IS-PERSON? >STACK
	CALL PRINT-ID,STR?54,STACK
	CALL IS-OBJ-PROP-ANIMAL? >STACK
	CALL PRINT-ID,STR?55,STACK
	CALL IS-PART-OF-SELF-OR-SELF? >STACK
	CALL PRINT-ID,STR?56,STACK >STACK
	RSTACK

	.FUNCT V-STAND
	LOC WINNER >STACK
	FSET? STACK,VEHBIT \?L1
	LOC WINNER >STACK
	CALL PERFORM,V?DISEMBARK,STACK
	RTRUE
?L1:	PRINTR "You are already standing, I think."

	.FUNCT V-STAY
	PRINTR "You will be lost without me!"

	.FUNCT V-STRIKE
	FSET? PRSO,ACTORBIT \?L1
	PRINTI "Since you aren't versed in hand-to-hand combat, you'd better attack the "
	PRINTD PRSO
	PRINTI " with a weapon."
	CRLF
	CALL PRINT-ID,STR?57 >STACK
	RSTACK
?L1:	CALL PERFORM,V?LAMP-ON,PRSO
	RTRUE

	.FUNCT V-SWIM
	CALL GLOBAL-IN?,GLOBAL-WATER,HERE >STACK
	ZERO? STACK /?L1
	PRINTI "Swimming isn't usually allowed in the "
	EQUAL? PRSO,WATER,GLOBAL-WATER /?L5
	PRINTD PRSO
	PRINTR "."
?L5:	PRINTR "dungeon."
?L1:	CALL NULL-F >STACK
	ZERO? STACK \FALSE
	PRINTR "Go jump in a lake!"

	.FUNCT V-SWING
	ZERO? PRSI \?L1
	PRINTR "Whoosh!"
?L1:	CALL PERFORM,V?ATTACK,PRSI,PRSO >STACK
	RSTACK

	.FUNCT PRE-TAKE
	IN? PRSO,WINNER \?L1
	FSET? PRSO,WEARBIT \?L3
	PRINTR "You are already wearing it."
?L3:	PRINTR "You already have that!"
?L1:	LOC PRSO >STACK
	FSET? STACK,CONTBIT \?L10
	LOC PRSO >STACK
	FSET? STACK,OPENBIT /?L10
	PRINTR "You can't reach something that's inside a closed container."
?L10:	ZERO? PRSI /?L13
	EQUAL? PRSI,GROUND \?L14
	SET 'PRSI,0
	RFALSE
?L14:	EQUAL? PRSO,DOOR-KEEPER \?L17
	SET 'PRSI,0
	RFALSE
?L17:	LOC PRSO >STACK
	EQUAL? PRSI,STACK /?L20
	PRINTI "The "
	PRINTD PRSO
	PRINTI " isn't in the "
	PRINTD PRSI
	PRINTR "."
?L20:	SET 'PRSI,0
	RFALSE
?L13:	LOC WINNER >STACK
	EQUAL? PRSO,STACK \FALSE
	PRINTR "You're inside of it!"

	.FUNCT V-TAKE
	CALL ITAKE >STACK
	EQUAL? STACK,1 \FALSE
	FSET? PRSO,WEARBIT \?L3
	PRINTI "You are now wearing the "
	PRINTD PRSO
	PRINTR "."
?L3:	PRINTI "Taken."
	CRLF
	CALL IS-THEFT? >STACK
	CALL PRINT-ID,STR?58,STACK >STACK
	RSTACK

	.FUNCT V-TELL
	FSET? PRSO,ACTORBIT \?L1
	ZERO? P-CONT /?L3
	SET 'WINNER,PRSO
	LOC WINNER >HERE
	RETURN HERE
?L3:	PRINTI "The "
	PRINTD PRSO
	PRINTR " pauses for a moment, perhaps thinking that you should reread the manual."
?L1:	PRINTI "You can't talk to the "
	PRINTD PRSO
	PRINTI "!"
	CRLF
	SET 'QUOTE-FLAG,0
	SET 'P-CONT,0
	RETURN 2

	.FUNCT V-THROUGH,OBJ=0,M,?TMP
	FSET? PRSO,DOORBIT \?L1
	CALL OTHER-SIDE,PRSO >M
	ZERO? M /?L1
	CALL DO-WALK,M
	RTRUE
?L1:	ZERO? OBJ \?L5
	FSET? PRSO,VEHBIT \?L3
	CALL PERFORM,V?BOARD,PRSO
	RTRUE
?L3:	ZERO? OBJ \?L5
	FSET? PRSO,TAKEBIT /?L4
?L5:	ZERO? SCOL-ROOM /?L6
	ZERO? OBJ \?L8
	EQUAL? PRSO,CURTAIN \?L6
?L8:	CALL SCOL-GO,OBJ
	RTRUE
?L6:	EQUAL? HERE,DEPOSITORY \?L9
	EQUAL? PRSO,SNWL \?L9
	ZERO? SCOL-ROOM /?L9
	CALL SCOL-GO,OBJ
	RTRUE
?L9:	EQUAL? HERE,SCOL-ACTIVE \?L10
	SET '?TMP,PRSO
	CALL GET-WALL,HERE >M
	GET M,1 >STACK
	EQUAL? ?TMP,STACK \?L10
	GET M,2 >SCOL-ROOM
	GETP PRSO,P?SIZE >PRSO
	ZERO? OBJ /?L11
	CALL SCOL-OBJ,OBJ,0,DEPOSITORY
	RTRUE
?L11:	CALL SCOL-THROUGH,0,DEPOSITORY
	RTRUE
?L10:	EQUAL? PRSO,CURTAIN \?L14
	PRINTR "You can't go more than part way through the curtain."
?L14:	PRINTI "You hit your head against the "
	PRINTD PRSO
	PRINTI " as you attempt this feat."
	CRLF
	CALL IS-OBJECT-OR-PROPERTY? >STACK
	CALL PRINT-ID,STR?59,STACK >STACK
	RSTACK
?L4:	IN? PRSO,WINNER \?L20
	PRINTR "That would involve quite a contortion!"
?L20:	CALL PICK-ONE,YUKS >STACK
	PRINT STACK
	CRLF
	RTRUE

	.FUNCT V-THROW
	CALL IDROP >STACK
	ZERO? STACK /?L1
	EQUAL? PRSI,ME \?L3
	PRINTI "A terrific throw! The "
	PRINTD PRSO
	SET 'WINNER,PLAYER
	CALL PRINT-ID,STR?60
	CALL JIGS-UP,STR?61 >STACK
	RSTACK
?L3:	ZERO? PRSI /?L7
	FSET? PRSI,ACTORBIT \?L7
	PRINTI "The "
	PRINTD PRSI
	PRINTI " ducks as the "
	PRINTD PRSO
	PRINTI " flies by and crashes to the ground."
	CRLF
	FSET? PRSO,WEAPONBIT /?L10
	PUSH 0
	JUMP ?L11
?L10:	PUSH 1
?L11:	CALL PRINT-ID,STR?62,STACK >STACK
	RSTACK
?L7:	PRINTR "Thrown."
?L1:	PRINTR "Huh?"

	.FUNCT V-THROW-OFF
	PRINTR "You can't throw anything off of that!"

	.FUNCT V-TIE
	EQUAL? PRSI,WINNER \?L1
	PRINTR "You can't tie anything to yourself."
?L1:	PRINTI "You can't tie the "
	PRINTD PRSO
	PRINTI " to that."
	CRLF
	CALL IS-PERSON? >STACK
	CALL PRINT-ID,STR?63,STACK >STACK
	RSTACK

	.FUNCT V-TIE-UP
	PRINTI "You could certainly never tie it with that!"
	CRLF
	CALL IS-PERSON? >STACK
	CALL PRINT-ID,STR?64,STACK >STACK
	RSTACK

	.FUNCT V-TREASURE
	CALL NULL-F >STACK
	ZERO? STACK \TRUE
	CALL NULL-F >STACK
	ZERO? STACK \TRUE
	PRINTR "Nothing happens."

	.FUNCT PRE-TURN
	EQUAL? PRSI,0,ROOMS \?L1
	PRINTR "Your bare hands don't appear to be enough."
?L1:	FSET? PRSO,TURNBIT /FALSE
	PRINTR "You can't turn that!"

	.FUNCT V-TURN
	PRINTR "This has no effect."

	.FUNCT V-UNLOCK
	CALL V-LOCK >STACK
	RSTACK

	.FUNCT V-UNTIE
	PRINTR "This cannot be tied, so it cannot be untied!"

	.FUNCT V-WAIT,NUM=3
	PRINTI "Time passes..."
	CRLF
?L3:	DLESS? 'NUM,0 /?L4
	CALL CLOCKER >STACK
	ZERO? STACK /?L3
?L4:	SET 'CLOCK-WAIT,1
	RETURN CLOCK-WAIT

	.FUNCT V-WALK,PT,PTS,STR,OBJ,RM
	ZERO? P-WALK-DIR \?L1
	CALL PERFORM,V?WALK-TO,PRSO
	RTRUE
?L1:	GETPT HERE,PRSO >PT
	ZERO? PT /?L3
	PTSIZE PT >PTS
	EQUAL? PTS,UEXIT \?L4
	GETB PT,REXIT >STACK
	CALL GOTO,STACK >STACK
	RSTACK
?L4:	EQUAL? PTS,NEXIT \?L6
	GET PT,NEXITSTR >STACK
	PRINT STACK
	CRLF
	RETURN 2
?L6:	EQUAL? PTS,FEXIT \?L11
	GET PT,FEXITFCN >STACK
	CALL STACK >RM
	ZERO? RM /?L12
	CALL GOTO,RM >STACK
	RSTACK
?L12:	CALL NULL-F >STACK
	ZERO? STACK \FALSE
	RETURN 2
?L11:	EQUAL? PTS,CEXIT \?L18
	GETB PT,CEXITFLAG >STACK
	VALUE STACK >STACK
	ZERO? STACK /?L19
	GETB PT,REXIT >STACK
	CALL GOTO,STACK >STACK
	RSTACK
?L19:	GET PT,CEXITSTR >STR
	ZERO? STR /?L21
	PRINT STR
	CRLF
	RETURN 2
?L21:	PRINTI "You can't go that way."
	CRLF
	RETURN 2
?L18:	EQUAL? PTS,DEXIT \FALSE
	GETB PT,DEXITOBJ >OBJ
	FSET? OBJ,OPENBIT \?L32
	GETB PT,REXIT >STACK
	CALL GOTO,STACK >STACK
	RSTACK
?L32:	GET PT,DEXITSTR >STR
	ZERO? STR /?L34
	PRINT STR
	CRLF
	RETURN 2
?L34:	PRINTI "The "
	PRINTD OBJ
	PRINTI " is closed."
	CRLF
	CALL THIS-IS-IT,OBJ
	RETURN 2
?L3:	ZERO? LIT \?L45
	RANDOM 100 >STACK
	GRTR? 80,STACK \?L45
	EQUAL? WINNER,ADVENTURER \?L45
	FSET? HERE,NONLANDBIT /?L45
	ZERO? SPRAYED? /?L46
	PRINTI "There are odd noises in the darkness, and there is no exit in that direction."
	CRLF
	RETURN 2
?L46:	CALL NULL-F >STACK
	ZERO? STACK \FALSE
	CALL JIGS-UP,STR?65 >STACK
	RSTACK
?L45:	PRINTI "You can't go that way."
	CRLF
	RETURN 2

	.FUNCT V-WALK-AROUND
	PRINTR "Use compass directions for movement."

	.FUNCT V-WALK-TO
	ZERO? PRSO /?L1
	IN? PRSO,HERE /?L3
	CALL GLOBAL-IN?,PRSO,HERE >STACK
	ZERO? STACK /?L1
?L3:	PRINTR "It's here!"
?L1:	PRINTR "You should supply a direction!"

	.FUNCT V-WAVE
	CALL HACK-HACK,STR?66 >STACK
	RSTACK

	.FUNCT V-WEAR
	FSET? PRSO,WEARBIT /?L1
	PRINTI "You can't wear the "
	PRINTD PRSO
	PRINTR "."
?L1:	CALL PERFORM,V?TAKE,PRSO
	RTRUE

	.FUNCT V-WIN
	PRINTR "Naturally!"

	.FUNCT V-WIND
	PRINTI "You cannot wind up a "
	PRINTD PRSO
	PRINTR "."

	.FUNCT V-WISH
	CALL PERFORM,V?MAKE,WISH >STACK
	RSTACK

	.FUNCT V-YELL
	PRINTI "Aaaarrrrgggghhhh!"
	CRLF
	CALL PRINT-ID,STR?67 >STACK
	RSTACK

	.FUNCT V-ZORK
	PRINTR "At your service!"

	.FUNCT V-FIRST-LOOK
	CALL DESCRIBE-ROOM >STACK
	ZERO? STACK /FALSE
	ZERO? SUPER-BRIEF \FALSE
	CALL DESCRIBE-OBJECTS >STACK
	RSTACK

	.FUNCT DESCRIBE-ROOM,LOOK?=0,V?,STR,AV
	SET 'V?,LOOK?
	ZERO? V? \?L1
	SET 'V?,VERBOSE
?L1:	ZERO? LIT \?L3
	PRINTI "It is pitch black."
	ZERO? SPRAYED? \?L7
	PRINTI " You are likely to be eaten by a grue."
?L7:	CRLF
	CALL NULL-F
	RFALSE
?L3:	FSET? HERE,TOUCHBIT /?L13
	FSET HERE,TOUCHBIT
	SET 'V?,1
?L13:	CALL NULL-F
	IN? HERE,ROOMS \?L16
	PRINTD HERE
	LOC WINNER >AV
	FSET? AV,VEHBIT \?L20
	PRINTI ", in the "
	PRINTD AV
?L20:	CRLF
?L16:	ZERO? LOOK? \?L28
	ZERO? SUPER-BRIEF /?L28
	EQUAL? HERE,ZORK3 \TRUE
?L28:	LOC WINNER >AV
	ZERO? V? /?L31
	GETP HERE,P?ACTION >STACK
	CALL STACK,M-LOOK >STACK
	ZERO? STACK \TRUE
	ZERO? V? /?L31
	GETP HERE,P?LDESC >STR
	ZERO? STR /?L31
	PRINT STR
	CRLF
	JUMP ?L34
?L31:	GETP HERE,P?ACTION >STACK
	CALL STACK,M-FLASH >STACK
?L34:	EQUAL? HERE,AV /TRUE
	FSET? AV,VEHBIT \TRUE
	GETP AV,P?ACTION >STACK
	CALL STACK,M-LOOK >STACK
	RTRUE

	.FUNCT DESCRIBE-OBJECTS,V?=0
	ZERO? LIT /?L1
	FIRST? HERE >STACK \FALSE
	ZERO? V? \?L5
	SET 'V?,VERBOSE
?L5:	CALL PRINT-CONT,HERE,V?,-1 >STACK
	RSTACK
?L1:	PRINTR "Only bats can see in the dark. And you're not one."

	.FUNCT DESCRIBE-OBJECT,OBJ,V?,LEVEL,STR=0,AV
	SET 'DESC-OBJECT,OBJ
	ZERO? LEVEL \?L8
	GETP OBJ,P?DESCFCN >STACK
	CALL STACK,M-OBJDESC >STACK
	ZERO? STACK \TRUE
	ZERO? LEVEL \?L8
	FSET? OBJ,TOUCHBIT /?L5
	GETP OBJ,P?FDESC >STR
	ZERO? STR \?L4
?L5:	GETP OBJ,P?LDESC >STR
	ZERO? STR /?L3
?L4:	PRINT STR
	JUMP ?L27
?L3:	ZERO? LEVEL \?L8
	PRINTI "There is a "
	PRINTD OBJ
	PRINTI " here"
	FSET? OBJ,ONBIT \?L11
	PRINTI " (providing light)"
?L11:	PRINTI "."
	JUMP ?L27
?L8:	GET INDENTS,LEVEL >STACK
	PRINT STACK
	PRINTI "A "
	PRINTD OBJ
	FSET? OBJ,ONBIT \?L23
	PRINTI " (providing light)"
	JUMP ?L27
?L23:	FSET? OBJ,WEARBIT \?L27
	IN? OBJ,WINNER \?L27
	PRINTI " (being worn)"
?L27:	EQUAL? OBJ,SPELL-VICTIM \?L31
	EQUAL? SPELL-USED,W?FLOAT \?L31
	PRINTI " (floating in midair)"
?L31:	ZERO? LEVEL \?L36
	LOC WINNER >AV
	ZERO? AV /?L36
	FSET? AV,VEHBIT \?L36
	PRINTI " (outside the "
	PRINTD AV
	PRINTI ")"
?L36:	CRLF
	CALL SEE-INSIDE?,OBJ >STACK
	ZERO? STACK /FALSE
	FIRST? OBJ >STACK \FALSE
	CALL PRINT-CONT,OBJ,V?,LEVEL >STACK
	RSTACK

	.FUNCT PRINT-CONTENTS,OBJ,F,N,1ST?=1,IT?=0,TWO?=0
	FIRST? OBJ >F \FALSE
?L3:	NEXT? F >N /?L5
?L5:	ZERO? 1ST? /?L6
	SET '1ST?,0
	JUMP ?L11
?L6:	PRINTI ", "
	ZERO? N \?L11
	PRINTI "and "
?L11:	PRINTI "a "
	PRINTD F
	ZERO? IT? \?L18
	ZERO? TWO? \?L18
	SET 'IT?,F
	JUMP ?L20
?L18:	SET 'TWO?,1
	SET 'IT?,0
?L20:	SET 'F,N
	ZERO? F \?L3
	ZERO? IT? /TRUE
	ZERO? TWO? \TRUE
	CALL THIS-IS-IT,IT?
	RTRUE

	.FUNCT PRINT-CONT,OBJ,V?=0,LEVEL=0,Y,1ST?,SHIT,AV,STR,PV?=0,INV?=0
	FIRST? OBJ >Y \TRUE
	LOC WINNER >AV
	ZERO? AV /?L4
	FSET? AV,VEHBIT /?L6
?L4:	SET 'AV,0
?L6:	SET '1ST?,1
	SET 'SHIT,1
	LOC OBJ >STACK
	EQUAL? WINNER,OBJ,STACK \?L7
	SET 'INV?,1
	JUMP ?L11
?L7:	ZERO? Y \?L12
?L68:	ZERO? LEVEL \?L11
	EQUAL? SPELL?,S-FANTASIZE \?L11
	RANDOM 100 >STACK
	GRTR? 20,STACK \?L11
	PRINTI "There is a "
	CALL PICK-ONE,FANTASIES >STACK
	PRINT STACK
	PRINTI " here."
	CRLF
	SET '1ST?,0
	JUMP ?L11
?L12:	EQUAL? Y,AV \?L19
	SET 'PV?,1
	JUMP ?L29
?L19:	EQUAL? Y,WINNER /?L29
	FSET? Y,INVISIBLE /?L29
	FSET? Y,TOUCHBIT /?L29
	GETP Y,P?FDESC >STR
	ZERO? STR /?L29
	FSET? Y,NDESCBIT /?L22
	PRINT STR
	CRLF
	SET 'SHIT,0
?L22:	CALL SEE-INSIDE?,Y >STACK
	ZERO? STACK /?L29
	LOC Y >STACK
	GETP STACK,P?DESCFCN >STACK
	ZERO? STACK \?L29
	FIRST? Y >STACK \?L29
	CALL PRINT-CONT,Y,V?,0 >STACK
	ZERO? STACK /?L29
	SET '1ST?,0
?L29:	NEXT? Y >Y /?L12
	JUMP ?L68
?L11:	FIRST? OBJ >Y /?L38
?L67:	ZERO? PV? /?L37
	ZERO? AV /?L37
	FIRST? AV >STACK \?L37
	INC 'LEVEL
	CALL PRINT-CONT,AV,V?,LEVEL
	JUMP ?L37
?L38:	EQUAL? Y,AV,ADVENTURER /?L60
	FSET? Y,INVISIBLE /?L60
	ZERO? INV? \?L45
	FSET? Y,TOUCHBIT /?L45
	GETP Y,P?FDESC >STACK
	ZERO? STACK \?L60
?L45:	FSET? Y,NDESCBIT /?L46
	ZERO? 1ST? /?L48
	CALL FIRSTER,OBJ,LEVEL >STACK
	ZERO? STACK /?L52
	LESS? LEVEL,0 \?L52
	SET 'LEVEL,0
?L52:	INC 'LEVEL
	SET '1ST?,0
?L48:	LESS? LEVEL,0 \?L57
	SET 'LEVEL,0
?L57:	CALL DESCRIBE-OBJECT,Y,V?,LEVEL
	JUMP ?L60
?L46:	FIRST? Y >STACK \?L60
	CALL SEE-INSIDE?,Y >STACK
	ZERO? STACK /?L60
	INC 'LEVEL
	CALL PRINT-CONT,Y,V?,LEVEL
	DEC 'LEVEL
?L60:	NEXT? Y >Y /?L38
	JUMP ?L67
?L37:	ZERO? 1ST? /TRUE
	ZERO? SHIT /TRUE
	RFALSE

	.FUNCT FIRSTER,OBJ,LEVEL
	CALL NULL-F >STACK
	ZERO? STACK \TRUE
	EQUAL? OBJ,WINNER \?L3
	PRINTR "You are carrying:"
?L3:	IN? OBJ,ROOMS /FALSE
	GRTR? LEVEL,0 \?L7
	GET INDENTS,LEVEL >STACK
	PRINT STACK
?L7:	FSET? OBJ,SURFACEBIT \?L12
	PRINTI "Sitting on the "
	PRINTD OBJ
	PRINTR " is: "
?L12:	FSET? OBJ,ACTORBIT \?L16
	PRINTI "The "
	PRINTD OBJ
	PRINTR " is holding: "
?L16:	PRINTI "The "
	PRINTD OBJ
	PRINTR " contains:"

	.FUNCT SEE-INSIDE?,OBJ
	FSET? OBJ,INVISIBLE /FALSE
	FSET? OBJ,TRANSBIT /TRUE
	FSET? OBJ,OPENBIT /TRUE
	RFALSE

	.FUNCT SCORE-UPD,NUM
	ADD BASE-SCORE,NUM >BASE-SCORE
	ADD SCORE,NUM >SCORE
	CALL NULL-F
	RTRUE

	.FUNCT SCORE-OBJ,OBJ,TEMP
	GETP OBJ,P?VALUE >TEMP
	GRTR? TEMP,0 \FALSE
	CALL SCORE-UPD,TEMP
	PUTP OBJ,P?VALUE,0
	RTRUE

	.FUNCT YES?
	PRINTI ">"
	READ P-INBUF,P-LEXV
	GET P-LEXV,1 >STACK
	EQUAL? STACK,W?YES,W?Y \FALSE
	RTRUE

	.FUNCT ITAKE,VB=1,CNT,OBJ,?TMP
	CALL NULL-F >STACK
	ZERO? STACK \FALSE
	FSET? PRSO,TAKEBIT /?L3
	ZERO? VB /FALSE
	CALL PICK-ONE,YUKS >STACK
	PRINT STACK
	CRLF
	RFALSE
?L3:	EQUAL? PRSO,SPELL-VICTIM \?L9
	EQUAL? SPELL-USED,W?FLOAT,W?FREEZE \?L9
	EQUAL? SPELL-USED,W?FLOAT \?L10
	PRINTI "You can't reach that. It's floating above your head."
	CRLF
	RFALSE
?L10:	PRINTI "It seems rooted to the spot."
	CRLF
	RFALSE
?L9:	LOC PRSO >STACK
	FSET? STACK,CONTBIT \?L17
	LOC PRSO >STACK
	FSET? STACK,OPENBIT \FALSE
?L17:	LOC PRSO >STACK
	IN? STACK,WINNER /?L18
	CALL WEIGHT,PRSO >?TMP
	CALL WEIGHT,WINNER >STACK
	ADD ?TMP,STACK >STACK
	GRTR? STACK,LOAD-ALLOWED \?L18
	ZERO? VB /?L19
	PRINTI "Your load is too heavy"
	LESS? LOAD-ALLOWED,LOAD-MAX \?L23
	PRINTI ", especially in light of your condition."
	JUMP ?L27
?L23:	PRINTI "."
?L27:	CRLF
?L19:	RETURN 2
?L18:	EQUAL? PRSA,V?TAKE \?L33
	CALL CCOUNT,WINNER >CNT
	GRTR? CNT,FUMBLE-NUMBER \?L33
	MUL CNT,FUMBLE-PROB >?TMP
	RANDOM 100 >STACK
	GRTR? ?TMP,STACK \?L33
	PRINTI "You're holding too many things already!"
	CRLF
	RFALSE
?L33:	MOVE PRSO,WINNER
	FCLEAR PRSO,NDESCBIT
	FSET PRSO,TOUCHBIT
	EQUAL? SPELL?,S-FILCH \?L39
	CALL RIPOFF,PRSO,WIZARD-CASE >STACK
	ZERO? STACK /?L39
	PRINTI "When you touch the "
	PRINTD PRSO
	PRINTI " it immediately disappears!"
	CRLF
	RFALSE
?L39:	CALL SCORE-OBJ,PRSO
	RTRUE

	.FUNCT IDROP
	IN? PRSO,WINNER /?L5
	LOC PRSO >STACK
	IN? STACK,WINNER /?L1
	PRINTI "You're not carrying the "
	PRINTD PRSO
	PRINTI "."
	CRLF
	RFALSE
?L1:	IN? PRSO,WINNER /?L5
	LOC PRSO >STACK
	FSET? STACK,OPENBIT /?L5
	PRINTI "The "
	PRINTD PRSO
	PRINTI " is closed."
	CRLF
	RFALSE
?L5:	LOC WINNER >STACK
	MOVE PRSO,STACK
	RTRUE

	.FUNCT CCOUNT,OBJ,CNT=0,X
	FIRST? OBJ >X \?L4
?L3:	FSET? X,WEARBIT /?L5
	INC 'CNT
?L5:	NEXT? X >X /?L3
?L4:	RETURN CNT

	.FUNCT WEIGHT,OBJ,CONT,WT=0
	FIRST? OBJ >CONT \?L4
?L3:	EQUAL? OBJ,PLAYER \?L5
	FSET? CONT,WEARBIT \?L5
	INC 'WT
	JUMP ?L7
?L5:	CALL WEIGHT,CONT >STACK
	ADD WT,STACK >WT
?L7:	NEXT? CONT >CONT /?L3
?L4:	GETP OBJ,P?SIZE >STACK
	ADD WT,STACK >STACK
	RSTACK

	.FUNCT HACK-HACK,STR
	IN? PRSO,GLOBAL-OBJECTS \?L1
	EQUAL? PRSA,V?LOWER,V?RAISE,V?WAVE \?L1
	PRINTI "The "
	PRINTD PRSO
	PRINTR " isn't here!"
?L1:	PRINT STR
	PRINTD PRSO
	CALL PICK-ONE,HO-HUM >STACK
	PRINT STACK
	CRLF
	RTRUE

	.FUNCT NO-GO-TELL,AV,WLOC
	ZERO? AV /?L1
	PRINTI "You can't go there in a "
	PRINTD WLOC
	PRINTR "."
?L1:	PRINTR "You can't go there without a vehicle."

	.FUNCT GOTO,RM,V?=1,LB,WLOC,AV=0,OLIT,OHERE
	FSET? RM,RLANDBIT /?L1
	SET 'LB,0
	JUMP ?L2
?L1:	SET 'LB,1
?L2:	LOC WINNER >WLOC
	SET 'OLIT,LIT
	SET 'OHERE,HERE
	FSET? WLOC,VEHBIT \?L3
	GETP WLOC,P?VTYPE >AV
?L3:	ZERO? LB \?L8
	ZERO? AV \?L6
	CALL NO-GO-TELL,AV,WLOC
	RFALSE
?L6:	ZERO? LB \?L8
	FSET? RM,AV /?L8
	CALL NO-GO-TELL,AV,WLOC
	RFALSE
?L8:	FSET? HERE,RLANDBIT \?L9
	ZERO? LB /?L9
	EQUAL? AV,0,RLANDBIT /?L9
	FSET? RM,AV /?L9
	CALL NO-GO-TELL,AV,WLOC
	RFALSE
?L9:	FSET? RM,RMUNGBIT \?L10
	GETP RM,P?LDESC >STACK
	PRINT STACK
	CRLF
	RFALSE
?L10:	ZERO? LB /?L20
	FSET? HERE,RLANDBIT /?L20
	ZERO? DEAD \?L20
	FSET? WLOC,VEHBIT \?L20
	EQUAL? WLOC,BALLOON \?L16
	PRINTI "The balloon lands."
	CRLF
	JUMP ?L20
?L16:	FSET? WLOC,VEHBIT \?L20
	PRINTI "The "
	PRINTD WLOC
	PRINTI " comes to a stop."
	CRLF
	CRLF
?L20:	ZERO? AV /?L25
	MOVE WLOC,RM
	JUMP ?L27
?L25:	MOVE WINNER,RM
?L27:	SET 'HERE,RM
	CALL LIT?,HERE >LIT
	ZERO? OLIT \?L35
	ZERO? LIT \?L46
	RANDOM 100 >STACK
	GRTR? 80,STACK \?L35
	ZERO? SPRAYED? /?L30
	PRINTI "There are sinister gurgling noises in the darkness all around you!"
	CRLF
	JUMP ?L35
?L30:	CALL NULL-F >STACK
	ZERO? STACK \FALSE
	PRINTI "Oh, no! A lurking grue slithered into the "
	LOC WINNER >STACK
	FSET? STACK,VEHBIT \?L38
	LOC WINNER >STACK
	PRINTD STACK
	JUMP ?L42
?L38:	PRINTI "room"
?L42:	CALL JIGS-UP,STR?68
	RTRUE
?L35:	ZERO? LIT \?L46
	EQUAL? WINNER,ADVENTURER \?L46
	PRINTI "You have moved into a dark place."
	CRLF
	SET 'P-CONT,0
?L46:	GETP HERE,P?ACTION >STACK
	CALL STACK,M-ENTER >STACK
	CALL SCORE-OBJ,RM
	EQUAL? HERE,RM \TRUE
	EQUAL? ADVENTURER,WINNER /?L53
	IN? ADVENTURER,OHERE \?L53
	PRINTI "The "
	PRINTD WINNER
	PRINTR " leaves the room."
?L53:	CALL NULL-F >STACK
	ZERO? STACK \TRUE
	ZERO? V? /TRUE
	EQUAL? WINNER,ADVENTURER \TRUE
	CALL V-FIRST-LOOK
	RTRUE

	.FUNCT LKP,ITM,TBL,CNT=0,LEN
	GET TBL,0 >LEN
?L1:	IGRTR? 'CNT,LEN /FALSE
	GET TBL,CNT >STACK
	EQUAL? STACK,ITM \?L1
	EQUAL? CNT,LEN /FALSE
	ADD CNT,1 >STACK
	GET TBL,STACK >STACK
	RSTACK

	.FUNCT DO-WALK,DIR
	SET 'P-WALK-DIR,DIR
	CALL PERFORM,V?WALK,DIR >STACK
	RSTACK

	.FUNCT GLOBAL-IN?,OBJ1,OBJ2,TX
	GETPT OBJ2,P?GLOBAL >TX
	ZERO? TX /FALSE
	PTSIZE TX >STACK
	DEC 'STACK
	CALL ZMEMQB,OBJ1,TX,STACK >STACK
	RSTACK

	.FUNCT FIND-IN,WHERE,WHAT,W
	FIRST? WHERE >W \FALSE
?L2:	FSET? W,WHAT \?L7
	EQUAL? W,ADVENTURER /?L7
	RETURN W
?L7:	NEXT? W >W /?L2
	RFALSE

	.FUNCT HELD?,CAN
?L1:	LOC CAN >CAN
	ZERO? CAN /FALSE
	EQUAL? CAN,WINNER \?L1
	RTRUE

	.FUNCT OTHER-SIDE,DOBJ,P=0,TX
?L1:	NEXTP HERE,P >P
	LESS? P,P?CROSS /FALSE
	GETPT HERE,P >TX
	PTSIZE TX >STACK
	EQUAL? STACK,DEXIT \?L1
	GETB TX,DEXITOBJ >STACK
	EQUAL? STACK,DOBJ \?L1
	RETURN P

	.FUNCT MUNG-ROOM,RM,STR
	EQUAL? RM,INSIDE-BARROW /FALSE
	FSET RM,RMUNGBIT
	PUTP RM,P?LDESC,STR
	RTRUE

	.FUNCT THIS-IS-IT,OBJ
	SET 'P-IT-OBJECT,OBJ
	RETURN P-IT-OBJECT

	.FUNCT NOT-HERE-OBJECT-F,TBL,PRSO?=1,OBJ
	EQUAL? PRSO,NOT-HERE-OBJECT \?L5
	EQUAL? PRSI,NOT-HERE-OBJECT \?L1
	PRINTR "Those things aren't here!"
?L1:	EQUAL? PRSO,NOT-HERE-OBJECT \?L5
	SET 'TBL,P-PRSO
	JUMP ?L6
?L5:	SET 'TBL,P-PRSI
	SET 'PRSO?,0
?L6:	SET 'P-CONT,0
	SET 'QUOTE-FLAG,0
	EQUAL? WINNER,PLAYER \?L7
	PRINTI "You can't see any "
	CALL NOT-HERE-PRINT,PRSO?
	PRINTR " here!"
?L7:	PRINTI "The "
	PRINTD WINNER
	PRINTI " seems confused. ""I don't see any "
	CALL NOT-HERE-PRINT,PRSO?
	PRINTR " here!"""

	.FUNCT NOT-HERE-PRINT,PRSO?
	ZERO? P-OFLAG /?L1
	ZERO? P-XADJ /?L3
	PRINTB P-XADJN
?L3:	ZERO? P-XNAM /FALSE
	PRINTB P-XNAM
	RTRUE
?L1:	ZERO? PRSO? /?L9
	GET P-ITBL,P-NC1L >STACK
	GET P-ITBL,P-NC1 >STACK
	CALL BUFFER-PRINT,STACK,STACK,0 >STACK
	RSTACK
?L9:	GET P-ITBL,P-NC2L >STACK
	GET P-ITBL,P-NC2 >STACK
	CALL BUFFER-PRINT,STACK,STACK,0 >STACK
	RSTACK

	.FUNCT NULL-F,A1,A2
	RFALSE

	.FUNCT STAIRS-F
	EQUAL? PRSA,V?THROUGH \FALSE
	PRINTR "You should say whether you want to go up or down."

	.FUNCT SAILOR-FCN
	EQUAL? PRSA,V?TELL \?L1
	SET 'P-CONT,0
	SET 'QUOTE-FLAG,0
	PRINTR "You can't talk to the sailor that way."
?L1:	EQUAL? PRSA,V?EXAMINE \?L5
	PRINTR "There is no sailor to be seen."
?L5:	EQUAL? PRSA,V?HELLO \FALSE
	INC 'HS
	MOD HS,20 >STACK
	ZERO? STACK \?L9
	PRINTR "You seem to be repeating yourself."
?L9:	MOD HS,10 >STACK
	ZERO? STACK \?L13
	PRINTR "I think that phrase is getting a bit worn out."
?L13:	PRINTR "Nothing happens here."

	.FUNCT GROUND-FUNCTION
	EQUAL? PRSA,V?PUT-ON,V?PUT \?L1
	EQUAL? PRSI,GROUND \?L1
	CALL PERFORM,V?DROP,PRSO
	RTRUE
?L1:	CALL NULL-F >STACK
	ZERO? STACK \FALSE
	EQUAL? PRSA,V?DIG \FALSE
	PRINTR "The ground is too hard for digging here."

	.FUNCT GRUE-FUNCTION
	EQUAL? PRSA,V?EXAMINE \?L1
	PRINTR "The grue is a sinister, lurking presence in the dark places of the earth. Its favorite diet is adventurers, but its insatiable appetite is tempered by its fear of light. No grue has ever been seen by the light of day, and few have survived its fearsome jaws to tell the tale."
?L1:	EQUAL? PRSA,V?FIND \?L5
	PRINTR "There is no grue here, but I'm sure there is at least one lurking in the darkness nearby. I wouldn't let my light go out if I were you!"
?L5:	EQUAL? PRSA,V?LISTEN \FALSE
	PRINTR "It makes no sound but is always lurking in the darkness nearby."

	.FUNCT CRETIN-FCN
	EQUAL? PRSA,V?TELL \?L1
	SET 'P-CONT,0
	SET 'QUOTE-FLAG,0
	PRINTR "Talking to yourself is said to be a sign of impending mental collapse."
?L1:	EQUAL? PRSA,V?GIVE \?L5
	EQUAL? PRSI,ME \?L5
	CALL PERFORM,V?TAKE,PRSO
	RTRUE
?L5:	EQUAL? PRSA,V?MAKE \?L6
	PRINTR "Only you can do that."
?L6:	EQUAL? PRSA,V?DISEMBARK \?L9
	PRINTR "You'll have to do that on your own."
?L9:	EQUAL? PRSA,V?EAT \?L12
	PRINTI "Auto-cannibalism is not the answer."
	CRLF
	CALL PRINT-ID,STR?69 >STACK
	RSTACK
?L12:	EQUAL? PRSA,V?MUNG,V?ATTACK \?L15
	ZERO? PRSI /?L16
	FSET? PRSI,WEAPONBIT \?L16
	CALL PRINT-ID,STR?70
	CALL JIGS-UP,STR?71 >STACK
	RSTACK
?L16:	PRINTI "Suicide is not the answer."
	CRLF
	CALL PRINT-ID,STR?72 >STACK
	RSTACK
?L15:	EQUAL? PRSA,V?THROW \?L21
	EQUAL? PRSO,ME \FALSE
	PRINTR "Why don't you just walk like normal people?"
?L21:	EQUAL? PRSA,V?TAKE \?L27
	PRINTR "How romantic!"
?L27:	EQUAL? PRSA,V?EXAMINE \FALSE
	CALL NULL-F >STACK
	ZERO? STACK \TRUE
	PRINTR "That's difficult unless your eyes are prehensile."

	.FUNCT PATH-OBJECT
	EQUAL? PRSA,V?FOLLOW,V?TAKE \?L1
	PRINTR "You must specify a direction to go."
?L1:	EQUAL? PRSA,V?FIND \?L5
	PRINTR "I can't help you there...."
?L5:	EQUAL? PRSA,V?DIG \FALSE
	PRINTR "Not a chance."

	.FUNCT ZORKMID-FUNCTION
	EQUAL? PRSA,V?EXAMINE \?L1
	PRINTR "The zorkmid is the unit of currency of the Great Underground Empire."
?L1:	EQUAL? PRSA,V?FIND \FALSE
	PRINTR "The best way to find zorkmids is to go out and look for them."

	.FUNCT PRINT-DESC1,OBJ
	ZERO? OBJ /FALSE
	PRINTD OBJ
	RTRUE

	.FUNCT PRINT-ID,ID,CONDITION=1
	ZERO? CONDITION /FALSE
	PRINTI "[ID: "
	PRINT ID
	PRINTI ", PRSO: "
	CALL PRINT-DESC1,PRSO
	PRINTI ", PRSI: "
	CALL PRINT-DESC1,PRSI
	PRINTI "]"
	RTRUE

	.FUNCT PRINT-DEBUG,TEXT,CONDITION=1
	ZERO? CONDITION /FALSE
	PRINTI "DEBUG FLAG: "
	PRINT TEXT
	RTRUE

	.FUNCT IS-THEFT?
	EQUAL? PRSO,ALICE-TABLE,ARCANA,BALLOON-LABEL /TRUE
	EQUAL? PRSO,BILLS,BRICK,CAGE /TRUE
	EQUAL? PRSO,CHEST,CLOTH-BAG,COIN /TRUE
	EQUAL? PRSO,COLLAR,CROWN,CUBE /TRUE
	EQUAL? PRSO,DEGREE,DEPOSIT-BOX,FUSE /TRUE
	EQUAL? PRSO,GAZEBO-TABLE,GLOBAL-PALANTIR,GLOBAL-WIZARD-CASE /TRUE
	EQUAL? PRSO,GOLD-KEY,IRON-BOX,LETTER-OPENER /TRUE
	EQUAL? PRSO,NEWSPAPER,PALANTIR-1,PALANTIR-2 /TRUE
	EQUAL? PRSO,PALANTIR-3,PALANTIR-4,PEARL /TRUE
	EQUAL? PRSO,PLACE-MAT,PORTRAIT,PTABLE /TRUE
	EQUAL? PRSO,RIBBON,ROUND-BUTTON,RUBY /TRUE
	EQUAL? PRSO,SAFE,STAMP,STAND-1 /TRUE
	EQUAL? PRSO,STAND-2,STAND-3,STAND-4 /TRUE
	EQUAL? PRSO,STATUETTE,TEAPOT,TRIANGULAR-BUTTON /TRUE
	EQUAL? PRSO,TROPHY-BOTTLES,TROPHY-SWORD,VIOLIN /TRUE
	EQUAL? PRSO,WAND,WANDS,WARNING-LABEL /TRUE
	EQUAL? PRSO,WIZARD-CASE,WORKBENCH \FALSE
	RTRUE

	.FUNCT IS-OBJECT-OR-PROPERTY?
	EQUAL? PRSO,ALICE-TABLE,AQUARIUM,ARCANA /TRUE
	EQUAL? PRSO,BALLOON,BALLOON-LABEL,BANK-BROCHURE /TRUE
	EQUAL? PRSO,BILLS,BLUE-BOOK,BLUE-ICING /TRUE
	EQUAL? PRSO,ORANGE-ICING,RED-ICING,BRAIDED-WIRE /TRUE
	EQUAL? PRSO,BRICK,BRIDGE,BUCKET /TRUE
	EQUAL? PRSO,CAGE,CANDY,CARD /TRUE
	EQUAL? PRSO,CHEST,CLOTH-BAG,COIN /TRUE
	EQUAL? PRSO,COLLAR,CROWN,CRYPT /TRUE
	EQUAL? PRSO,CUBE,CURTAIN,DEGREE /TRUE
	EQUAL? PRSO,DEPOSIT-BOX,DIM-DOOR,EAT-ME-CAKE /TRUE
	EQUAL? PRSO,FLASK,FOOT-BRIDGE,FUSE /TRUE
	EQUAL? PRSO,GAZEBO,GAZEBO-TABLE,GLOBAL-PALANTIR /TRUE
	EQUAL? PRSO,GLOBAL-WIZARD-CASE,GOLD-KEY,GREEN-BOOK /TRUE
	EQUAL? PRSO,HEADS,HEDGES,HOOK-1 /TRUE
	EQUAL? PRSO,HOOK-2,IRON-BOX,KEY /TRUE
	EQUAL? PRSO,LAMP,LETTER-OPENER,LID-1 /TRUE
	EQUAL? PRSO,LID-2,MATCH,MENHIR /TRUE
	EQUAL? PRSO,MOSS,GLOBAL-MENHIR,NEWSPAPER /TRUE
	EQUAL? PRSO,PALANTIR-1,PALANTIR-2,PALANTIR-3 /TRUE
	EQUAL? PRSO,PALANTIR-4,PEARL,PLACE-MAT /TRUE
	EQUAL? PRSO,PORTRAIT,POSTS,PTABLE /TRUE
	EQUAL? PRSO,PURPLE-BOOK,PWINDOW,RECEPTACLE /TRUE
	EQUAL? PRSO,REPELLENT,RIBBON,ROSE-BUSH /TRUE
	EQUAL? PRSO,ROUND-BUTTON,RUBY,SAFE /TRUE
	EQUAL? PRSO,STAMP,STAND-1,STAND-2 /TRUE
	EQUAL? PRSO,STAND-3,STAND-4,STATUETTE /TRUE
	EQUAL? PRSO,STONE-BRIDGE,TEAPOT,TRIANGULAR-BUTTON /TRUE
	EQUAL? PRSO,TROPHY-BOTTLES,TROPHY-SWORD,VIOLIN /TRUE
	EQUAL? PRSO,WAND,WANDS,WARNING-LABEL /TRUE
	EQUAL? PRSO,WELL,WIZARD-CASE,WORKBENCH /TRUE
	EQUAL? PRSO,WIZ-DOOR \FALSE
	RTRUE

	.FUNCT IS-PERSON?
	EQUAL? PRSO,DRAGON,GLOBAL-PRINCESS,PRINCESS /TRUE
	EQUAL? PRSO,GNOME,GNOME-OF-ZURICH,GENIE /TRUE
	EQUAL? PRSO,WIZARD \FALSE
	RTRUE

	.FUNCT BALLOON-IN-AIR?
	EQUAL? BLOC,VAIR-1,VAIR-2,VAIR-3 /TRUE
	EQUAL? BLOC,VAIR-4 \FALSE
	RTRUE

	.FUNCT IS-BAD-TO-PICK?
	RFALSE

	.FUNCT DANGEROUS-DRINK?
	EQUAL? PRSO,FLASK \FALSE
	RTRUE

	.FUNCT DANGEROUS-FOOD?,?TMP
	CALL IS-PART-OF-SELF? >?TMP
	ZERO? ?TMP /?L2
	RETURN ?TMP
?L2:	CALL IS-OBJECT-OR-PROPERTY? >STACK
	RSTACK

	.FUNCT IS-ANIMAL?
	EQUAL? PRSO,GLOBAL-UNICORN,UNICORN,CERBERUS /TRUE
	EQUAL? PRSO,SERPENT,ROBOT,GRUE \FALSE
	RTRUE

	.FUNCT IS-OBJ-PROP-ANIMAL?,?TMP
	CALL IS-OBJECT-OR-PROPERTY? >?TMP
	ZERO? ?TMP /?L2
	RETURN ?TMP
?L2:	CALL IS-ANIMAL? >STACK
	RSTACK

	.FUNCT IS-SELF?
	EQUAL? PRSO,ME \FALSE
	RTRUE

	.FUNCT IS-PART-OF-SELF?
	EQUAL? PRSO,HANDS \FALSE
	RTRUE

	.FUNCT IS-PART-OF-SELF-OR-SELF?,?TMP
	CALL IS-SELF? >?TMP
	ZERO? ?TMP /?L2
	RETURN ?TMP
?L2:	CALL IS-PART-OF-SELF? >STACK
	RSTACK

	.FUNCT GO
START::
?L0:	PUTB P-LEXV,0,59
	CALL QUEUE,I-WIZARD,4 >STACK
	PUT STACK,0,1
	CALL QUEUE,I-LANTERN,200
	PUTP BALLOON,P?VTYPE,NONLANDBIT
	PUTP BUCKET,P?VTYPE,NONLANDBIT
	PUTP SEWL,P?SIZE,P?EAST
	PUTP SWWL,P?SIZE,P?WEST
	PUTP SSWL,P?SIZE,P?SOUTH
	PUTP SNWL,P?SIZE,P?NORTH
	SET 'LIT,1
	SET 'WINNER,ADVENTURER
	SET 'PLAYER,ADVENTURER
	SET 'HERE,INSIDE-BARROW
	SET 'P-IT-OBJECT,0
	FSET? HERE,TOUCHBIT /?L1
	CALL V-VERSION
	CRLF
?L1:	MOVE WINNER,HERE
	CALL V-LOOK
	CALL MAIN-LOOP
	JUMP ?L0

	.FUNCT HEDGES-F
	EQUAL? PRSA,V?EXAMINE \FALSE
	PRINTR "The hedges are shaped like various animals: dogs, serpents, dragons, and the like, and they are vaguely troubling to look at."

	.FUNCT LT-CRACK-PSEUDO
	EQUAL? PRSA,V?THROUGH,V?BOARD \?L1
	CALL DO-WALK,P?SOUTH
	RTRUE
?L1:	CALL CC-CRACK-PSEUDO >STACK
	RSTACK

	.FUNCT CC-CRACK-PSEUDO
	EQUAL? PRSA,V?BOARD,V?THROUGH \?L1
	CALL DO-WALK,P?NORTH
	RTRUE
?L1:	PRINTR "The crack is fairly wide. You should be able to get into it."

	.FUNCT GLOBAL-MENHIR-F
	PRINTR "It's not here."

	.FUNCT GLOBAL-CERBERUS-F
	PRINTR "He's not here."

	.FUNCT CRACK-PSEUDO
	EQUAL? PRSA,V?EXAMINE \FALSE
	PRINTR "It is a small crack (as advertised) with no redeeming value."

	.FUNCT ALICE-HOLE
	EQUAL? PRSA,V?EXAMINE \?L1
	PRINTR "The hole is very small. You could never enter it."
?L1:	EQUAL? PRSA,V?LOOK-INSIDE \?L5
	PRINTR "You can't see what's beyond the hole from here."
?L5:	EQUAL? PRSA,V?PUT \FALSE
	EQUAL? PRSI,PSEUDO-OBJECT \FALSE
	PRINTR "It doesn't fit through the hole."

	.FUNCT SLOT-F
	EQUAL? PRSA,V?LOOK-INSIDE \?L1
	FIRST? SLOT >STACK /?L1
	PRINTR "There's nothing in the hole."
?L1:	EQUAL? PRSA,V?EXAMINE \FALSE
	PRINTR "The oblong hole has been chipped out of the box, probably by someone wanting whatever is inside the box. The attempt was a pathetic failure, however."

	.FUNCT TEAPOT-F
	EQUAL? PRSA,V?CLOSE \FALSE
	PRINTR "The teapot has no lid."

	.FUNCT ROSE-F
	EQUAL? PRSA,V?SMELL \?L1
	PRINTR "Unlike your efforts here, it comes out smelling like a rose."
?L1:	EQUAL? PRSA,V?EXAMINE \FALSE
	PRINTR "A rose is a rose is a rose...."

	.FUNCT FOOTPAD-F
	EQUAL? PRSA,V?EXAMINE \FALSE
	PRINTR "A footpad is a thief."

	.FUNCT COMPASS-F
	EQUAL? PRSA,V?FIND \?L1
	PRINTR "It's on your person. And lucky for you, or you would become hopelessly lost."
?L1:	EQUAL? PRSA,V?OVERBOARD,V?THROW,V?DROP \?L5
	PRINTI "You can't get rid of it. It is an extension of yourself."
	CRLF
	CALL PRINT-ID,STR?73 >STACK
	RSTACK
?L5:	EQUAL? PRSA,V?EXAMINE \?L8
	PRINTR "It's one of those gizmos with a needle and a card with the eight major compass directions. Simple, but effective."
?L8:	EQUAL? PRSA,V?READ \?L11
	PRINTR "It doesn't make very interesting reading - just the compass directions."
?L11:	PRINTR "You can't do that. And don't bother to ask why."

	.FUNCT SWORD-FCN
	EQUAL? PRSA,V?TAKE \FALSE
	EQUAL? WINNER,ADVENTURER \FALSE
	CALL QUEUE,I-SWORD,-1 >STACK
	PUT STACK,0,1
	RFALSE

	.FUNCT I-SWORD,DEM,NG=0,G,P,TX,L
	CALL INT,I-SWORD >DEM
	SET 'G,SWORD-GLOW
	IN? SWORD,ADVENTURER \?L1
	CALL INFESTED?,HERE >STACK
	ZERO? STACK /?L3
	SET 'NG,2
	JUMP ?L7
?L3:	SET 'P,0
?L6:	NEXTP HERE,P >P
	ZERO? P /?L7
	LESS? P,P?CROSS /?L6
	GETPT HERE,P >TX
	PTSIZE TX >L
	EQUAL? L,UEXIT,CEXIT,DEXIT \?L6
	GETB TX,0 >STACK
	CALL INFESTED?,STACK >STACK
	ZERO? STACK /?L6
	SET 'NG,1
?L7:	EQUAL? NG,G /FALSE
	EQUAL? NG,2 \?L20
	PRINTI "Your sword has begun to glow very brightly."
	CRLF
	JUMP ?L26
?L20:	EQUAL? NG,1 \?L23
	PRINTI "Your sword is glowing with a faint blue glow."
	CRLF
	JUMP ?L26
?L23:	ZERO? NG \?L26
	PRINTI "Your sword is no longer glowing."
	CRLF
?L26:	SET 'SWORD-GLOW,NG
	RTRUE
?L1:	PUT DEM,C-ENABLED?,0
	RFALSE

	.FUNCT INFESTED?,R,F
	FIRST? R >F \FALSE
?L4:	FSET? F,ACTORBIT \?L6
	FSET? F,INVISIBLE /?L6
	EQUAL? F,ROBOT /?L6
	RETURN F
?L6:	NEXT? F >F /?L4
	RFALSE

	.FUNCT CAROUSEL-ROOM-FCN,RARG
	EQUAL? RARG,M-LOOK \?L1
	PRINTI "You are in a large circular room whose high ceiling is lost in gloom. Eight identical passages leave the room."
	CRLF
	ZERO? CAROUSEL-FLIP-FLAG \TRUE
	PRINTR "A loud whirring sound comes from all around, and you feel sort of disoriented in here."
?L1:	ZERO? CAROUSEL-FLIP-FLAG \FALSE
	EQUAL? RARG,M-BEG \FALSE
	EQUAL? PRSA,V?WALK \FALSE
	EQUAL? PRSO,P?UP,P?DOWN /FALSE
	EQUAL? PRSO,P?OUT \?L14
	PRINTI "Feeling dizzy, you pick a direction at random."
	CRLF
	CRLF
	SET 'PRSO,P?EAST
	JUMP ?L18
?L14:	PRINTI "You're not sure which direction is which. This room is very disorienting."
	CRLF
	CRLF
?L18:	EQUAL? PRSO,P?WEST /?L23
	RANDOM 100 >STACK
	GRTR? 80,STACK \?L21
?L23:	RANDOM 7 >STACK
	DEC 'STACK
	GET EIGHT-DIRECTIONS,STACK >PRSO
?L21:	CALL V-WALK
	RTRUE

	.FUNCT VIOLIN-FCN
	EQUAL? PRSA,V?PLAY \FALSE
	EQUAL? PRSO,VIOLIN \FALSE
	PRINTR "An amazingly offensive noise issues from the violin."

	.FUNCT OPEN-CLOSE,OBJ,STROPN,STRCLS
	EQUAL? PRSA,V?OPEN \?L1
	FSET? OBJ,OPENBIT \?L3
	CALL RANDOM-ELEMENT,DUMMY >STACK
	PRINT STACK
	CRLF
	RTRUE
?L3:	PRINT STROPN
	EQUAL? OBJ,WIZ-DOOR /?L10
	PUSH 0
	JUMP ?L11
?L10:	PUSH 1
?L11:	CALL PRINT-ID,STR?74,STACK
	FSET OBJ,OPENBIT
	CRLF
	RTRUE
?L1:	EQUAL? PRSA,V?CLOSE \FALSE
	FSET? OBJ,OPENBIT \?L13
	PRINT STRCLS
	FCLEAR OBJ,OPENBIT
	CRLF
	RTRUE
?L13:	CALL RANDOM-ELEMENT,DUMMY >STACK
	PRINT STACK
	CRLF
	CRLF
	RTRUE

	.FUNCT BALLOON-FCN,RARG=0,M,R,RC
	EQUAL? RARG,M-LOOK \?L1
	ZERO? BINF-FLAG /?L3
	PRINTI "The cloth bag is inflated and "
	FSET? RECEPTACLE,OPENBIT \?L7
	PRINTI "there is a "
	PRINTD BINF-FLAG
	PRINTI " burning in the receptacle."
	JUMP ?L14
?L7:	PRINTI "some smoke is leaking out of the closed receptacle."
	JUMP ?L14
?L3:	PRINTI "The cloth bag is draped over the side of the basket. Directly in the middle of the basket is a metal receptacle which is "
	FSET? RECEPTACLE,OPENBIT \?L17
	PRINTI "open"
	FIRST? RECEPTACLE >RC \?L30
	PRINTI ". A "
	PRINTD RC
	PRINTI " is "
	EQUAL? BINF-FLAG,RC \?L26
	PUSH STR?75
	JUMP ?L28
?L26:	PUSH STR?76
?L28:	PRINT STACK
	PRINTI " inside"
	JUMP ?L30
?L17:	PRINTI "closed"
?L30:	PRINTI "."
?L14:	ZERO? BTIE-FLAG /?L35
	PRINTR " The balloon is tied to a hook by the braided wire."
?L35:	PRINTR " A braided wire is dangling over the side of the basket."
?L1:	EQUAL? RARG,M-OBJDESC \?L42
	PRINTI "There is a large and extremely heavy wicker basket here. An enormous cloth bag "
	ZERO? BINF-FLAG /?L45
	PRINTI "attached to the basket is inflated. A metal receptacle is fastened to the center of the basket. "
	FSET? RECEPTACLE,OPENBIT \?L49
	PRINTI "In it is a burning "
	PRINTD BINF-FLAG
	JUMP ?L56
?L49:	PRINTI "Some smoke leaks out around its closed lid"
	JUMP ?L56
?L45:	PRINTI "is draped over the side and is firmly attached to the basket. A metal receptacle is fastened to the center of the basket"
?L56:	ZERO? BTIE-FLAG /?L59
	PRINTR ". A piece of wire tied to a hook holds the balloon in place."
?L59:	PRINTR ". Dangling from the basket is a piece of braided wire."
?L42:	EQUAL? RARG,M-BEG \FALSE
	EQUAL? PRSA,V?WALK \?L67
	GETPT HERE,PRSO >M
	ZERO? M /?L69
	ZERO? BTIE-FLAG /?L71
	PRINTR "You are tied to the ledge."
?L71:	PTSIZE M >STACK
	EQUAL? STACK,1 \?L76
	GETB M,0 >R
	FSET? R,RMUNGBIT /?L76
	SET 'BLOC,R
?L76:	CALL QUEUE,I-BALLOON,3 >STACK
	PUT STACK,0,1
	RFALSE
?L69:	PRINTR "You can't control the balloon this way."
?L67:	EQUAL? PRSA,V?OPEN \?L82
	ZERO? BINF-FLAG /?L82
	EQUAL? PRSO,RECEPTACLE \?L82
	FIRST? RECEPTACLE >STACK \?L82
	PRINTI "Opening it reveals a burning "
	PRINTD BINF-FLAG
	PRINTI "."
	CRLF
	FSET RECEPTACLE,OPENBIT
	RTRUE
?L82:	EQUAL? PRSA,V?TAKE \?L85
	EQUAL? BINF-FLAG,PRSO \?L85
	PRINTI "You don't really want to hold a burning "
	PRINTD PRSO
	PRINTI "."
	CRLF
	CALL PRINT-ID,STR?77
	RTRUE
?L85:	EQUAL? PRSA,V?PUT \?L91
	EQUAL? PRSI,RECEPTACLE \?L88
	FIRST? RECEPTACLE >STACK \?L88
	PRINTR "The receptacle is already occupied."
?L88:	EQUAL? PRSA,V?PUT \?L91
	EQUAL? PRSI,RECEPTACLE \?L91
	FSET PRSO,NDESCBIT
	RFALSE
?L91:	EQUAL? PRSA,V?INFLATE \FALSE
	PRINTR "It takes more than words to inflate a balloon."

	.FUNCT I-BALLOON
	FSET? RECEPTACLE,OPENBIT \?L1
	ZERO? BINF-FLAG /?L1
	CALL RISE-AND-SHINE >STACK
	RSTACK
?L1:	EQUAL? HERE,LEDGE-1,LEDGE-2 \?L3
	CALL RISE-AND-SHINE >STACK
	RSTACK
?L3:	CALL DECLINE-AND-FALL >STACK
	RSTACK

	.FUNCT BALLOON-BURN
	PRINTI "The "
	PRINTD PRSO
	PRINTI " burns inside the receptacle."
	CRLF
	GETP PRSO,P?SIZE >STACK
	MUL STACK,20 >STACK
	CALL QUEUE,I-BURNUP,STACK >STACK
	PUT STACK,0,1
	FSET PRSO,FLAMEBIT
	FSET PRSO,ONBIT
	FCLEAR PRSO,TAKEBIT
	FCLEAR PRSO,READBIT
	ZERO? BINF-FLAG \TRUE
	PRINTI "The cloth bag inflates as it fills with hot air."
	CRLF
	ZERO? BLAB-FLAG \?L8
	PRINTI "A small label drops from the bag into the basket."
	CRLF
	MOVE BALLOON-LABEL,BALLOON
?L8:	SET 'BLAB-FLAG,1
	SET 'BINF-FLAG,PRSO
	CALL QUEUE,I-BALLOON,3 >STACK
	PUT STACK,0,1
	RTRUE

	.FUNCT PUT-BALLOON,THERE,STR
	EQUAL? HERE,LEDGE-1,LEDGE-2,VOLCANO-BOTTOM \?L1
	PRINTI "You watch as the balloon slowly "
	PRINT STR
	CRLF
?L1:	MOVE BALLOON,THERE
	SET 'BLOC,THERE
	RETURN BLOC

	.FUNCT RISE-AND-SHINE,IN,R
	IN? WINNER,BALLOON /?L1
	SET 'IN,0
	JUMP ?L2
?L1:	SET 'IN,1
?L2:	CALL QUEUE,I-BALLOON,3 >STACK
	PUT STACK,0,1
	EQUAL? BLOC,VAIR-4 \?L3
	CALL INT,I-BURNUP >STACK
	PUT STACK,0,0
	CALL INT,I-BALLOON >STACK
	PUT STACK,0,0
	REMOVE BALLOON
	ZERO? IN /?L5
	CALL JIGS-UP,STR?78
	JUMP ?L7
?L5:	EQUAL? HERE,LEDGE-1,LEDGE-2,VOLCANO-BOTTOM \?L7
	PRINTI "You watch the balloon drift out over the rim and away on the wind."
	CRLF
?L7:	SET 'BLOC,VOLCANO-BOTTOM
	RETURN BLOC
?L3:	CALL LKP,BLOC,BALLOON-UPS >R
	ZERO? R /?L11
	ZERO? IN /?L12
	PRINTI "The balloon ascends."
	CRLF
	CRLF
	SET 'BLOC,R
	CALL GOTO,R >STACK
	RSTACK
?L12:	CALL PUT-BALLOON,R,STR?79 >STACK
	RSTACK
?L11:	CALL LKP,BLOC,BALLOON-FLOATS >R
	ZERO? R /?L17
	ZERO? IN /?L18
	PRINTI "The balloon leaves the ledge."
	CRLF
	CRLF
	SET 'BLOC,R
	CALL GOTO,R >STACK
	RSTACK
?L18:	CALL QUEUE,I-GNOME,10 >STACK
	PUT STACK,0,1
	CALL PUT-BALLOON,R,STR?80
	FSET RECEPTACLE,OPENBIT
	RTRUE
?L17:	ZERO? IN /?L23
	SET 'BLOC,VAIR-1
	PRINTI "The balloon rises slowly from the ground."
	CRLF
	CRLF
	CALL GOTO,VAIR-1 >STACK
	RSTACK
?L23:	CALL PUT-BALLOON,VAIR-1,STR?81 >STACK
	RSTACK

	.FUNCT DECLINE-AND-FALL,IN,R
	IN? WINNER,BALLOON /?L1
	SET 'IN,0
	JUMP ?L2
?L1:	SET 'IN,1
?L2:	CALL QUEUE,I-BALLOON,3 >STACK
	PUT STACK,0,1
	EQUAL? BLOC,VAIR-1 \?L3
	ZERO? IN /?L5
	SET 'BLOC,VOLCANO-BOTTOM
	ZERO? BINF-FLAG /?L7
	PRINTI "The balloon has landed."
	CRLF
	CRLF
	CALL GOTO,VOLCANO-BOTTOM >STACK
	RSTACK
?L7:	REMOVE BALLOON
	MOVE DEAD-BALLOON,BLOC
	MOVE WINNER,HERE
	CALL INT,I-BALLOON >STACK
	PUT STACK,0,0
	PRINTI "You have landed, but the balloon did not survive."
	CRLF
	CRLF
	CALL GOTO,VOLCANO-BOTTOM >STACK
	RSTACK
?L5:	CALL PUT-BALLOON,VOLCANO-BOTTOM,STR?82 >STACK
	RSTACK
?L3:	CALL LKP,BLOC,BALLOON-DOWNS >R
	ZERO? R /FALSE
	ZERO? IN /?L16
	PRINTI "The balloon descends."
	CRLF
	CRLF
	SET 'BLOC,R
	CALL GOTO,R >STACK
	RSTACK
?L16:	CALL PUT-BALLOON,R,STR?83 >STACK
	RSTACK

	.FUNCT BCONTENTS
	EQUAL? PRSA,V?TAKE \?L1
	PRINTI "The "
	PRINTD PRSO
	PRINTI " is an integral part of the basket and cannot be removed."
	IN? WINNER,BALLOON /?L6
	PUSH 0
	JUMP ?L5
?L6:	CALL BALLOON-IN-AIR? >STACK
?L5:	CALL PRINT-ID,STR?84,STACK
	EQUAL? PRSO,BRAIDED-WIRE \?L7
	PRINTI " The wire might possibly be tied, though."
?L7:	CRLF
	RTRUE
?L1:	EQUAL? PRSO,CLOTH-BAG \?L12
	EQUAL? PRSA,V?OPEN,V?LOOK-INSIDE \?L12
	EQUAL? PRSA,V?OPEN \?L13
	PRINTR "The bag is enormous. The concept of opening it here is ludicrous."
?L13:	PRINTR "It doesn't appear that there's anything inside."
?L12:	EQUAL? PRSA,V?EXAMINE \?L20
	EQUAL? PRSO,RECEPTACLE \?L20
	PRINTI "The receptacle is "
	FSET? PRSO,OPENBIT \?L23
	PRINTR "open."
?L23:	PRINTR "closed."
?L20:	EQUAL? PRSA,V?EXAMINE,V?FIND \FALSE
	PRINTI "The "
	PRINTD PRSO
	PRINTR " is part of the basket. It may be manipulated within the basket but cannot be removed."

	.FUNCT WIRE-FCN
	EQUAL? PRSA,V?EXAMINE,V?FIND,V?TAKE \?L1
	CALL BCONTENTS >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?TIE \?L3
	EQUAL? PRSO,BRAIDED-WIRE \FALSE
	EQUAL? PRSI,HOOK-1,HOOK-2 \FALSE
	SET 'BTIE-FLAG,PRSI
	FSET PRSI,NDESCBIT
	CALL INT,I-BALLOON >STACK
	PUT STACK,0,0
	PRINTR "The balloon is fastened to the hook."
?L3:	EQUAL? PRSA,V?UNTIE \FALSE
	EQUAL? PRSO,BRAIDED-WIRE \FALSE
	ZERO? BTIE-FLAG /?L10
	CALL QUEUE,I-BALLOON,3 >STACK
	PUT STACK,0,1
	FCLEAR BTIE-FLAG,NDESCBIT
	SET 'BTIE-FLAG,0
	PRINTR "The wire falls off of the hook."
?L10:	PRINTR "The wire is not tied to anything."

	.FUNCT I-BURNUP,OBJ
	FIRST? RECEPTACLE >OBJ /?L1
?L1:	EQUAL? HERE,BLOC \?L2
	PRINTI "The "
	PRINTD OBJ
	PRINTI " has now burned out, and the cloth bag starts to deflate."
	CRLF
?L2:	REMOVE OBJ
	SET 'BINF-FLAG,0
	RTRUE

	.FUNCT SAFE-ROOM-FCN,RARG
	EQUAL? RARG,M-LOOK \FALSE
	PRINTI "You are in a dusty old room which is featureless, except for an exit on the north side."
	CRLF
	ZERO? SAFE-FLAG \?L5
	PRINTR "Imbedded in the far wall is a rusty box. It appears to be somewhat damaged, since an oblong hole has been chipped out of the front of it."
?L5:	PRINTR "On the far wall is a rusty box, whose door has been blown off."

	.FUNCT SAFE-FCN
	EQUAL? PRSA,V?TAKE \?L1
	EQUAL? PRSO,SAFE \?L1
	PRINTR "The box is imbedded in the wall."
?L1:	EQUAL? PRSA,V?OPEN \?L5
	ZERO? SAFE-FLAG /?L6
	PRINTR "The box has no door!"
?L6:	PRINTR "The box is rusted and will not open."
?L5:	EQUAL? PRSA,V?CLOSE \FALSE
	ZERO? SAFE-FLAG /?L14
	PRINTR "The box has no door!"
?L14:	PRINTR "The box isn't open!"

	.FUNCT BRICK-FCN
	EQUAL? PRSA,V?BURN \FALSE
	REMOVE BRICK
	CALL PRINT-ID,STR?85
	CALL JIGS-UP,OTHER-PROPERTIES >STACK
	RSTACK

	.FUNCT FUSE-FCN
	EQUAL? PRSA,V?BURN /?L3
	EQUAL? PRSA,V?LAMP-ON \FALSE
	IN? MATCH,WINNER \FALSE
	FSET? MATCH,ONBIT \FALSE
?L3:	PRINTI "The string starts to burn."
	CRLF
	CALL QUEUE,I-FUSE,2 >STACK
	PUT STACK,0,1
	RTRUE

	.FUNCT I-FUSE,BRICK-ROOM,F
	LOC BRICK >BRICK-ROOM
	IN? FUSE,BRICK \?L1
?L3:	ZERO? BRICK-ROOM /FALSE
	IN? BRICK-ROOM,ROOMS /?L4
	LOC BRICK-ROOM >BRICK-ROOM
	JUMP ?L3
?L4:	MOVE EXPLOSION,BRICK-ROOM
	FCLEAR BRICK-ROOM,TOUCHBIT
	EQUAL? BRICK-ROOM,HERE \?L9
	CALL MUNG-ROOM,BRICK-ROOM,STR?86
	CALL PRINT-ID,STR?87
	CALL JIGS-UP,OTHER-PROPERTIES
	JUMP ?L23
?L9:	EQUAL? BRICK-ROOM,SAFE-ROOM \?L11
	CALL QUEUE,I-SAFE,5 >STACK
	PUT STACK,0,1
	SET 'MUNGED-ROOM,SAFE-ROOM
	PRINTI "There is an explosion nearby."
	CRLF
	IN? BRICK,SLOT \?L23
	FSET SLOT,INVISIBLE
	FSET SAFE,OPENBIT
	FCLEAR SAFE-ROOM,TOUCHBIT
	SET 'SAFE-FLAG,1
	JUMP ?L23
?L11:	PRINTI "There is an explosion nearby."
	CRLF
	CALL QUEUE,I-SAFE,5 >STACK
	PUT STACK,0,1
	SET 'MUNGED-ROOM,BRICK-ROOM
	FIRST? BRICK-ROOM >F \?L23
?L22:	FSET? F,TAKEBIT \?L24
	FSET F,INVISIBLE
?L24:	NEXT? F >F /?L22
?L23:	REMOVE BRICK
	JUMP ?L31
?L1:	LOC FUSE >STACK
	EQUAL? STACK,WINNER,HERE \?L31
	PRINTI "The string rapidly burns into nothingness."
	CRLF
?L31:	REMOVE FUSE
	RTRUE

	.FUNCT I-SAFE
	EQUAL? HERE,MUNGED-ROOM \?L1
	CALL PRINT-ID,STR?88
	CALL JIGS-UP,STR?89
	JUMP ?L6
?L1:	ZERO? DEAD \?L6
	PRINTI "You may recall that recent explosion. Probably as a result of it, you hear an ominous rumbling, as if a nearby room had collapsed."
	CRLF
	CALL PRINT-ID,STR?90
	EQUAL? MUNGED-ROOM,SAFE-ROOM \?L6
	CALL QUEUE,I-LEDGE,8 >STACK
	PUT STACK,0,1
?L6:	CALL MUNG-ROOM,MUNGED-ROOM,STR?86 >STACK
	RSTACK

	.FUNCT I-LEDGE,RM=LEDGE-2
	EQUAL? HERE,LEDGE-2 \?L1
	IN? WINNER,BALLOON \?L3
	ZERO? BTIE-FLAG /?L5
	SET 'BLOC,VOLCANO-BOTTOM
	REMOVE BALLOON
	MOVE DEAD-BALLOON,VOLCANO-BOTTOM
	SET 'BTIE-FLAG,0
	SET 'BINF-FLAG,0
	CALL INT,I-BALLOON >STACK
	PUT STACK,0,0
	CALL INT,I-BURNUP >STACK
	PUT STACK,0,0
	CALL PRINT-ID,STR?91
	CALL JIGS-UP,STR?92
	JUMP ?L11
?L5:	PRINTI "The ledge collapses, leaving you with no place to land."
	CRLF
	CALL PRINT-ID,STR?93
	JUMP ?L11
?L3:	CALL PRINT-ID,STR?94
	CALL JIGS-UP,STR?95
	JUMP ?L11
?L1:	ZERO? DEAD \?L11
	PRINTI "The ledge collapses. (That was a narrow escape!)"
	CRLF
	CALL PRINT-ID,STR?96
?L11:	CALL MUNG-ROOM,RM,STR?97 >STACK
	RSTACK

	.FUNCT LEDGE-FCN,RARG
	EQUAL? RARG,M-LOOK \FALSE
	PRINTI "You are on a wide ledge high in the volcano. The rim of the volcano is about 200 feet above and there is a precipitous drop to the bottom."
	FSET? SAFE-ROOM,RMUNGBIT \?L5
	PRINTR " The way to the south is blocked by rubble."
?L5:	PRINTR " There is a small door to the south."

	.FUNCT I-GNOME
	EQUAL? HERE,LEDGE-1,LEDGE-2 \?L1
	PRINTI "A volcano gnome seems to walk straight out of the wall and "
	IN? WAND,WINNER \?L5
	PRINTR "noticing the wand, straight back in."
?L5:	PRINTI "says ""I have a busy appointment schedule and little time to waste on trespassers, but for a small fee I'll show you the way out."" You notice the gnome nervously glancing at his watch."
	CRLF
	MOVE GNOME,HERE
	RTRUE
?L1:	CALL QUEUE,I-GNOME,1 >STACK
	PUT STACK,0,1
	RFALSE

	.FUNCT GNOME-FCN
	EQUAL? PRSA,V?TELL \?L1
	SET 'P-CONT,0
	SET 'QUOTE-FLAG,0
	ZERO? GNOME-FLAG \?L3
	CALL QUEUE,I-NERVOUS,5 >STACK
	PUT STACK,0,1
?L3:	SET 'GNOME-FLAG,1
	PRINTR "The gnome appears increasingly nervous."
?L1:	EQUAL? PRSA,V?THROW,V?GIVE \?L8
	EQUAL? PRSI,GNOME \?L8
	GETPT PRSO,P?VALUE >STACK
	ZERO? STACK /?L9
	PRINTI """Thank you very much for the "
	PRINTD PRSO
	PRINTI ". I don't believe I've ever seen one as beautiful. Follow me,"" he says, and a door appears on the west end of the ledge. Through the door, you can see a narrow chimney sloping steeply downward. The gnome moves quickly, and disappears from sight."
	CRLF
	CALL PRINT-ID,STR?98
	REMOVE PRSO
	REMOVE GNOME
	SET 'GNOME-DOOR-FLAG,1
	RETURN GNOME-DOOR-FLAG
?L9:	CALL BOMB?,PRSO >STACK
	ZERO? STACK /?L13
	MOVE BRICK,HERE
	CALL PRINT-ID,STR?99
	REMOVE GNOME
	CALL INT,I-GNOME >STACK
	PUT STACK,0,0
	CALL INT,I-NERVOUS >STACK
	PUT STACK,0,0
	PRINTR """That certainly wasn't what I had in mind,"" he says, and disappears."
?L13:	CALL REMOVE-CAREFULLY,PRSO
	PRINTI """That wasn't quite what I had in mind,"" he says, crunching the "
	PRINTD PRSO
	PRINTI " in his rock-hard hands."
	CRLF
	CALL PRINT-ID,STR?100 >STACK
	RSTACK
?L8:	PRINTI "The gnome appears increasingly nervous."
	CRLF
	ZERO? GNOME-FLAG \?L22
	CALL QUEUE,I-NERVOUS,5 >STACK
	PUT STACK,0,1
?L22:	SET 'GNOME-FLAG,1
	RETURN GNOME-FLAG

	.FUNCT I-NERVOUS
	IN? GNOME,HERE \?L1
	PRINTI "The gnome glances at his watch. ""Oops. I'm late for an appointment!"" He disappears, leaving you alone on the ledge."
	CRLF
	CALL PRINT-ID,STR?101
?L1:	REMOVE GNOME
	RTRUE

	.FUNCT PURPLE-BOOK-FCN
	EQUAL? PRSA,V?READ \?L1
	IN? STAMP,PURPLE-BOOK \?L1
	FSET? PURPLE-BOOK,OPENBIT /?L1
	GETP PURPLE-BOOK,P?TEXT >STACK
	PRINT STACK
	CRLF
	CALL PERFORM,V?OPEN,PURPLE-BOOK
	RTRUE
?L1:	CALL RANDOM-BOOK >STACK
	RSTACK

	.FUNCT RANDOM-BOOK
	EQUAL? PRSA,V?PUT,V?MOVE,V?TAKE \FALSE
	FSET WHITE-BOOK,TOUCHBIT
	FSET PURPLE-BOOK,TOUCHBIT
	FSET GREEN-BOOK,TOUCHBIT
	FSET BLUE-BOOK,TOUCHBIT
	RFALSE

	.FUNCT HEAD-FCN
	EQUAL? PRSA,V?HELLO \?L1
	PRINTR "The Flatheads are dead; therefore they do not respond."
?L1:	EQUAL? PRSA,V?RUB,V?ATTACK,V?KICK /?L6
	EQUAL? PRSA,V?BURN,V?TAKE,V?OPEN \FALSE
?L6:	CALL PRINT-ID,STR?102
	CALL JIGS-UP,STR?103 >STACK
	RSTACK

	.FUNCT CRYPT-ANTEROOM-FCN,RARG
	EQUAL? RARG,M-LOOK \FALSE
	PRINTI "The anteroom is large and empty. Marble bas reliefs depict the stirring times and afterlife of the Flatheads (the latter a bit optimistically). The exit is to the west. A huge marble door stands to the south. "
	PRINTI "The door is "
	FSET? CRYPT-DOOR,OPENBIT \?L7
	PRINTI "open."
	JUMP ?L11
?L7:	PRINTI "closed."
?L11:	PRINTR " Above the door is the cryptic inscription: ""Feel Free""."

	.FUNCT CRYPT-ROOM-FCN,RARG,CLIT?
	EQUAL? RARG,M-LOOK \?L1
	FCLEAR HERE,ONBIT
	CALL LIT?,HERE >STACK
	ZERO? STACK /?L3
	PRINTI "The room contains the earthly remains of the mighty Flatheads, twelve somewhat flat heads mounted securely on poles. While the room might be expected to contain funerary urns or other evidence of the ritual practices of the ancient Zorkers, it is empty of all such objects. There is writing carved on the crypt. The only apparent exit is to the north through the door to the anteroom. The door is "
	FSET? CRYPT-DOOR,OPENBIT \?L7
	PRINTI "open."
	JUMP ?L11
?L7:	PRINTI "closed."
?L11:	CRLF
	FSET? DIM-DOOR,INVISIBLE /?L19
	PRINTI "Looking closely at the south wall, you can see the dim outline of a secret door labelled with the letter ""F""."
	CRLF
	JUMP ?L19
?L3:	CALL DIM-DOOR-APPEARS
?L19:	FSET HERE,ONBIT
	RTRUE
?L1:	EQUAL? RARG,M-END \FALSE
	SET 'CLIT?,CRYPT-LIT?
	FCLEAR CRYPT-ROOM,ONBIT
	CALL LIT?,CRYPT-ROOM >CRYPT-LIT?
	ZERO? CLIT? /?L21
	ZERO? CRYPT-LIT? \?L21
	CALL DIM-DOOR-APPEARS
?L21:	FSET CRYPT-ROOM,ONBIT
	RTRUE

	.FUNCT DIM-DOOR-APPEARS
	PRINTI "It is dark, but on the south wall is a faint outline of a rectangle, as though light were shining around a doorway. You can also make out a faintly glowing letter in the center of this area. It might be an ""F""."
	CRLF
	FCLEAR DIM-DOOR,INVISIBLE
	RTRUE

	.FUNCT CRYPT-OBJECT
	EQUAL? PRSA,V?OPEN \?L1
	PRINTR "The crypt is sealed for all time."
?L1:	EQUAL? PRSA,V?RUB \FALSE
	PRINTR "The marble is cool."

	.FUNCT CRYPT-DOOR-FCN
	EQUAL? PRSA,V?CLOSE,V?OPEN \FALSE
	CALL OPEN-CLOSE,PRSO,STR?105,STR?104 >STACK
	RSTACK

	.FUNCT TOMB-PSEUDO
	EQUAL? PRSA,V?THROUGH \FALSE
	CALL DO-WALK,P?EAST
	RTRUE

	.FUNCT DIM-DOOR-FCN
	EQUAL? PRSA,V?KNOCK \?L1
	PRINTR "A hollow echo responds."
?L1:	EQUAL? PRSA,V?CLOSE,V?OPEN \FALSE
	EQUAL? PRSA,V?OPEN \?L6
	SET 'DIM-DOOR-FLAG,1
	JUMP ?L8
?L6:	SET 'DIM-DOOR-FLAG,0
?L8:	CALL OPEN-CLOSE,PRSO,STR?107,STR?106 >STACK
	RSTACK

	.FUNCT REPELLENT-FCN
	EQUAL? PRSA,V?SHAKE \?L1
	ZERO? SPRAY-USED? /?L3
	PRINTR "The can seems empty."
?L3:	PRINTR "There is a sloshing sound from inside."
?L1:	EQUAL? PRSA,V?PUT,V?SPRAY \FALSE
	EQUAL? PRSO,REPELLENT \FALSE
	ZERO? SPRAY-USED? /?L11
	PRINTR "The repellent is all gone."
?L11:	ZERO? PRSI \?L15
	SET 'SPRAY-USED?,1
	PRINTR "The spray stinks amazingly for a few moments, then drifts away."
?L15:	EQUAL? PRSI,ME \?L19
	CALL QUEUE,I-SPRAY,8 >STACK
	PUT STACK,0,1
	SET 'SPRAYED?,1
?L19:	SET 'SPRAY-USED?,1
	PRINTR "The spray smells like a mixture of old socks and burning rubber. If I were a grue I'd sure stay clear!"

	.FUNCT I-SPRAY
	SET 'SPRAYED?,0
	PRINTR "That horrible smell is much less pungent now."

	.FUNCT ZORK3-FCN,RARG
	EQUAL? RARG,M-LOOK \FALSE
	PRINTI "Beyond the door is a roughly hewn staircase leading down into darkness. The landing on which you stand is covered with carefully drawn magical runes like those sketched upon the workbench of the Wizard of Frobozz. These have been overlaid with sweeping green lines of enormous power, which undulate back and forth across the landing. "
	IN? WAND,WINNER \?L5
	PRINTI "The wand begins to vibrate in harmony with the motion of the lines. You feel yourself compelled downward, and you yield, stepping onto the staircase. As you pass the green lines, they flare and disappear with a burst of light, and you tumble down the staircase!

At the bottom, a vast red-lit hall stretches off into the distance. Sinister statues guard the entrance to a dimly visible room far ahead. With courage and cunning you have conquered the Wizard of Frobozz and become the master of his domain, but the final challenge awaits!

(The ultimate adventure concludes in ""Zork III: The Dungeon Master"".)

"
	CRLF
	SET 'WON-FLAG,1
	CALL SCORE-UPD,10
	CALL FINISH >STACK
	RSTACK
?L5:	CALL PRINT-ID,STR?108
	CALL JIGS-UP,STR?109 >STACK
	RSTACK

	.FUNCT I-BUCKET
	IN? WATER,BUCKET \FALSE
	SET 'EVAPORATED,1
	REMOVE WATER
	RFALSE

	.FUNCT WATER-FCN,AV,W,PI?
	EQUAL? PRSA,V?SGIVE /FALSE
	EQUAL? PRSA,V?THROUGH \?L3
	CALL PERFORM,V?SWIM,PRSO
	RTRUE
?L3:	EQUAL? PRSA,V?FILL \?L4
	SET 'W,PRSI
	SET 'PRSA,V?PUT
	SET 'PRSI,PRSO
	SET 'PRSO,W
	SET 'PI?,0
	JUMP ?L6
?L4:	EQUAL? PRSO,GLOBAL-WATER,WATER \?L5
	SET 'W,PRSO
	SET 'PI?,0
	JUMP ?L6
?L5:	ZERO? PRSI /?L6
	SET 'W,PRSI
	SET 'PI?,1
?L6:	EQUAL? W,GLOBAL-WATER \?L10
	SET 'W,WATER
	EQUAL? PRSA,V?PUT,V?TAKE \?L10
	REMOVE W
?L10:	ZERO? PI? /?L14
	SET 'PRSI,W
	JUMP ?L16
?L14:	SET 'PRSO,W
?L16:	LOC WINNER >AV
	FSET? AV,VEHBIT /?L17
	SET 'AV,0
?L17:	EQUAL? PRSA,V?PUT,V?TAKE \?L20
	ZERO? PI? \?L44
	ZERO? AV /?L24
	EQUAL? AV,PRSI \?L22
	CALL PUDDLE,AV >STACK
	RSTACK
?L22:	ZERO? AV /?L24
	ZERO? PRSI \?L61
	IN? W,AV /?L24
	CALL PUDDLE,AV >STACK
	RSTACK
?L24:	ZERO? PRSI /?L25
?L61:	EQUAL? PRSI,TEAPOT /?L25
	PRINTI "The water leaks out of the "
	PRINTD PRSI
	PRINTI " and evaporates immediately."
	CRLF
	REMOVE W
	RTRUE
?L25:	IN? TEAPOT,WINNER \?L28
	FIRST? TEAPOT >STACK /?L29
	EQUAL? HERE,POOL-ROOM \?L31
	MOVE SALTY-WATER,TEAPOT
	JUMP ?L33
?L31:	MOVE WATER,TEAPOT
?L33:	PRINTR "The teapot is now full of water."
?L29:	PRINTR "The teapot isn't currently empty."
?L28:	IN? PRSO,TEAPOT \?L39
	EQUAL? PRSA,V?TAKE \?L39
	ZERO? PRSI \?L39
	SET 'PRSO,TEAPOT
	CALL ITAKE
	SET 'PRSO,W
	RETURN PRSO
?L39:	PRINTR "The water slips through your fingers."
?L20:	ZERO? PI? /?L43
?L44:	PRINTR "Nice try."
?L43:	EQUAL? PRSA,V?GIVE,V?DROP \?L46
	EQUAL? PRSO,WATER \?L47
	CALL HELD?,WATER >STACK
	ZERO? STACK \?L47
	PRINTR "You don't have any water."
?L47:	REMOVE WATER
	ZERO? AV /?L52
	CALL PUDDLE,AV >STACK
	RSTACK
?L52:	PRINTI "The water spills to the floor and evaporates."
	CRLF
	REMOVE WATER
	RTRUE
?L46:	EQUAL? PRSA,V?THROW \FALSE
	PRINTI "The water splashes on the walls and evaporates."
	CRLF
	REMOVE WATER
	RTRUE

	.FUNCT PUDDLE,AV
	PRINTI "There is now a puddle in the bottom of the "
	PRINTD AV
	PRINTI "."
	CRLF
	MOVE PRSO,AV
	RTRUE

	.FUNCT BUCKET-FCN,RARG=M-BEG
	EQUAL? RARG,M-BEG \?L1
	EQUAL? PRSA,V?BURN \?L3
	EQUAL? PRSO,BUCKET \?L3
	PRINTR "The bucket is fireproof, and won't burn."
?L3:	EQUAL? PRSA,V?PUT,V?DROP \?L7
	EQUAL? PRSO,WATER \?L7
	EQUAL? PRSI,BUCKET \?L7
	IN? BUCKET,WELL-BOTTOM \?L7
	IN? WINNER,BUCKET /?L7
	PRINTI "The bucket swiftly rises up, and is gone."
	CRLF
	MOVE BUCKET,WELL-TOP
	MOVE WATER,BUCKET
	SET 'BUCKET-TOP-FLAG,1
	CALL QUEUE,I-BUCKET,100 >STACK
	PUT STACK,0,1
	RTRUE
?L7:	EQUAL? PRSA,V?KICK \FALSE
	CALL PRINT-ID,STR?110
	CALL JIGS-UP,STR?111 >STACK
	RSTACK
?L1:	EQUAL? RARG,M-END \?L12
	IN? WATER,BUCKET \?L13
	ZERO? BUCKET-TOP-FLAG \?L28
	PRINTI "The bucket rises and comes to a stop."
	CRLF
	CRLF
	SET 'BUCKET-TOP-FLAG,1
	SET 'EVAPORATED,0
	CALL PASS-THE-BUCKET,WELL-TOP
	CALL QUEUE,I-BUCKET,100 >STACK
	PUT STACK,0,1
	RTRUE
?L13:	ZERO? BUCKET-TOP-FLAG /FALSE
?L28:	IN? WATER,BUCKET /FALSE
	ZERO? EVAPORATED /?L18
	PRINTI "The last of the water evaporates, and the bucket descends."
	CRLF
	CRLF
	JUMP ?L22
?L18:	PRINTI "The bucket descends and comes to a stop."
	CRLF
	CRLF
?L22:	SET 'BUCKET-TOP-FLAG,0
	CALL PASS-THE-BUCKET,WELL-BOTTOM >STACK
	RSTACK
?L12:	EQUAL? PRSA,V?CLIMB-ON \FALSE
	CALL PERFORM,V?BOARD,PRSO
	RTRUE

	.FUNCT PASS-THE-BUCKET,R
	MOVE BUCKET,R
	IN? WINNER,BUCKET \FALSE
	CALL GOTO,R >STACK
	RSTACK

	.FUNCT POSTS-ROOM-FCN,RARG
	EQUAL? RARG,M-BEG \FALSE
	EQUAL? PRSA,V?TAKE \FALSE
	FSET? PRSO,NONLANDBIT \FALSE
	PRINTI "The "
	PRINTD PRSO
	PRINTR " is now much larger than you are. You have no hope of taking it."

	.FUNCT EATME-FCN,F,N
	EQUAL? PRSA,V?EAT \?L1
	EQUAL? PRSO,EAT-ME-CAKE \?L1
	EQUAL? HERE,TEA-ROOM \?L1
	PRINTI "Suddenly, the room appears to have become very large (although everything you are carrying seems to be its normal size)."
	CRLF
	CRLF
	REMOVE EAT-ME-CAKE
	FSET ROBOT,INVISIBLE
	FSET ALICE-TABLE,INVISIBLE
	FIRST? HERE >F /?L8
	JUMP ?L7
?L5:	ZERO? F /?L7
?L8:	NEXT? F >N /?L11
?L11:	EQUAL? F,ADVENTURER /?L12
	FSET? F,TAKEBIT \?L12
	FSET F,NONLANDBIT
	FSET F,TRYTAKEBIT
	MOVE F,POSTS-ROOM
?L12:	SET 'F,N
	JUMP ?L5
?L7:	CALL GOTO,POSTS-ROOM >STACK
	RSTACK
?L1:	CALL CAKE-CRUMBLE >STACK
	RSTACK

	.FUNCT CAKE-CRUMBLE,CAKE
	FSET? PRSO,FOODBIT \?L1
	SET 'CAKE,PRSO
	JUMP ?L3
?L1:	SET 'CAKE,PRSI
?L3:	EQUAL? HERE,TEA-ROOM,POSTS-ROOM,POOL-ROOM /FALSE
	EQUAL? HERE,MACHINE-ROOM,MAGNET-ROOM,CAGE-ROOM /FALSE
	EQUAL? HERE,WELL-TOP,IN-CAGE /FALSE
	REMOVE CAKE
	PRINTI "The "
	PRINTD CAKE
	PRINTR " has crumbled to dust."

	.FUNCT CAKE-FCN,F,N
	EQUAL? PRSA,V?READ \?L1
	FSET? PRSO,NONLANDBIT \?L3
	PRINTR "The cake is much too tall now for you to read the lettering."
?L3:	ZERO? PRSI /?L7
	EQUAL? PRSI,PALANTIR-1,PALANTIR-2,PALANTIR-3 \?L8
	CALL PERFORM,V?LOOK-INSIDE,PRSI >STACK
	RSTACK
?L8:	EQUAL? PRSI,FLASK \?L10
	PRINTI "The letters, now visible, say """
	EQUAL? PRSO,RED-ICING \?L13
	PRINTI "Evaporate"
	JUMP ?L20
?L13:	EQUAL? PRSO,ORANGE-ICING \?L17
	PRINTI "Explode"
	JUMP ?L20
?L17:	PRINTI "Enlarge"
?L20:	PRINTR """."
?L10:	PRINTR "You can't see through that!"
?L7:	PRINTR "The first letter is a capital E. The rest is too small to read."
?L1:	EQUAL? PRSA,V?EAT \?L31
	EQUAL? HERE,TEA-ROOM,POSTS-ROOM,POOL-ROOM \?L31
	EQUAL? PRSO,ORANGE-ICING \?L32
	REMOVE PRSO
	CALL PRINT-ID,STR?112
	CALL ICEBOOM >STACK
	RSTACK
?L32:	EQUAL? PRSO,RED-ICING \?L34
	REMOVE PRSO
	CALL PRINT-ID,STR?113
	CALL JIGS-UP,STR?114 >STACK
	RSTACK
?L34:	EQUAL? PRSO,BLUE-ICING \FALSE
	REMOVE PRSO
	PRINTI "The room around you seems to be getting smaller."
	CRLF
	CRLF
	EQUAL? HERE,POSTS-ROOM \?L38
	FCLEAR ROBOT,INVISIBLE
	FCLEAR ALICE-TABLE,INVISIBLE
	FSET POSTS,INVISIBLE
	FIRST? HERE >F /?L43
	JUMP ?L42
?L40:	ZERO? F /?L42
?L43:	NEXT? F >N /?L46
?L46:	EQUAL? F,ADVENTURER /?L47
	FSET? F,TAKEBIT \?L47
	FCLEAR F,NONLANDBIT
	FCLEAR F,TRYTAKEBIT
	MOVE F,TEA-ROOM
?L47:	SET 'F,N
	JUMP ?L40
?L42:	CALL GOTO,TEA-ROOM >STACK
	RSTACK
?L38:	CALL PRINT-ID,STR?115
	CALL JIGS-UP,STR?116 >STACK
	RSTACK
?L31:	EQUAL? PRSA,V?PUT,V?THROW \?L53
	EQUAL? PRSO,ORANGE-ICING \?L52
	EQUAL? HERE,TEA-ROOM,POSTS-ROOM,POOL-ROOM \?L52
	REMOVE PRSO
	CALL ICEBOOM >STACK
	RSTACK
?L52:	EQUAL? PRSA,V?PUT,V?THROW \?L53
	EQUAL? PRSO,RED-ICING,BLUE-ICING,ORANGE-ICING \?L53
	EQUAL? PRSI,POOL \?L53
	EQUAL? PRSO,BLUE-ICING,ORANGE-ICING \?L54
	PRINTI "The cake sinks majestically into the pool."
	CRLF
	REMOVE PRSO
	RTRUE
?L54:	MOVE PRSO,HERE
	REMOVE PRSI
	PRINTI "Most of the pool evaporates, revealing a (slightly damp but still valuable) package of rare candies. The red cake must be pretty strong stuff, since it remains intact!"
	CRLF
	FCLEAR CANDY,INVISIBLE
	RTRUE
?L53:	CALL CAKE-CRUMBLE >STACK
	RSTACK

	.FUNCT CANDY-FCN
	EQUAL? PRSA,V?READ,V?EXAMINE \?L1
	CALL FIXED-FONT-ON
	PRINTI "       Frobozz Magic Candy Company
         >>Special Assortment<<
          Candied Grasshoppers
             Chocolated Ants
              Worms Glacee
(By Appointment to His Majesty, Dimwit I)
"
	CALL FIXED-FONT-OFF
	RTRUE
?L1:	EQUAL? PRSA,V?OPEN,V?EAT \FALSE
	PRINTR "Such rich food would probably not be good for you."

	.FUNCT TOP-ETCHINGS-F
	EQUAL? PRSA,V?READ,V?EXAMINE \FALSE
	CALL FIXED-FONT-ON
	PRINTI "       o  b  o
   r             z
f   M  A  G  I  C   z
c    W  E   L  L    y
   o             n
       m  p  a
"
	CALL FIXED-FONT-OFF
	RTRUE

	.FUNCT BOTTOM-ETCHINGS-F
	EQUAL? PRSA,V?READ,V?EXAMINE \FALSE
	CALL FIXED-FONT-ON
	PRINTI "       o  b  o

       A  G  I
        E   L

       m  p  a
"
	CALL FIXED-FONT-OFF
	RTRUE

	.FUNCT CUBE-F
	EQUAL? PRSA,V?READ,V?EXAMINE \FALSE
	CALL FIXED-FONT-ON
	PRINTI "              Bank of Zork
                   VAULT
                 *722 GUE*
        Frobozz Magic Vault Company
"
	CALL FIXED-FONT-OFF
	RTRUE

	.FUNCT FIXED-FONT-ON
	GET 0,8 >STACK
	BOR STACK,2 >STACK
	PUT 0,8,STACK
	RTRUE

	.FUNCT FIXED-FONT-OFF
	GET 0,8 >STACK
	BAND STACK,-3 >STACK
	PUT 0,8,STACK
	RTRUE

	.FUNCT POOL-FCN
	EQUAL? PRSA,V?DRINK \?L1
	PRINTI "The water is extremely salty."
	CRLF
	CALL PRINT-ID,STR?117 >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?LOOK-UNDER \?L5
	PRINTR "You'd probably have to enter the pool to see what's below the surface."
?L5:	EQUAL? PRSA,V?THROUGH \FALSE
	CALL PRINT-ID,STR?118
	CALL JIGS-UP,STR?119 >STACK
	RSTACK

	.FUNCT FLASK-FCN
	EQUAL? PRSA,V?LOOK-INSIDE \?L1
	PRINTR "You notice that objects behind the flask appear to be magnified. You might try looking at something through the flask."
?L1:	EQUAL? PRSA,V?READ \?L5
	EQUAL? PRSI,FLASK \?L5
	PRINTI "The flask distorts and magnifies the "
	PRINTD PRSO
	PRINTI ", showing details not noticed earlier."
	CRLF
	RFALSE
?L5:	EQUAL? PRSA,V?OPEN \?L8
	CALL MUNG-ROOM,HERE,STR?120
	CALL PRINT-ID,STR?121
	CALL JIGS-UP,FATAL-VAPORS >STACK
	RSTACK
?L8:	EQUAL? PRSA,V?THROW,V?MUNG \FALSE
	PRINTI "The flask breaks into pieces."
	CRLF
	REMOVE PRSO
	CALL PRINT-ID,STR?122
	CALL JIGS-UP,FATAL-VAPORS >STACK
	RSTACK

	.FUNCT PLEAK
	EQUAL? PRSA,V?TAKE \?L1
	CALL PICK-ONE,YUKS >STACK
	PRINT STACK
	CRLF
	RTRUE
?L1:	EQUAL? PRSA,V?PLUG \FALSE
	PRINTR "The leak is too high above you to reach."

	.FUNCT ICEBOOM
	CALL MUNG-ROOM,HERE,STR?123
	CALL JIGS-UP,STR?124 >STACK
	RSTACK

	.FUNCT MAGNET-ROOM-FCN,RARG
	EQUAL? RARG,M-LOOK \?L1
	PRINTR "You are in a circular room with a low ceiling. There are exits to the east and southeast."
?L1:	EQUAL? RARG,M-ENTER \FALSE
	ZERO? CAROUSEL-FLIP-FLAG /FALSE
	ZERO? CAROUSEL-ZOOM-FLAG /?L6
	EQUAL? ADVENTURER,WINNER \?L8
	PUSH STR?125
	JUMP ?L10
?L8:	PUSH STR?126
?L10:	CALL JIGS-UP,STACK >STACK
	RSTACK
?L6:	EQUAL? WINNER,ADVENTURER \FALSE
	PRINTI "As you enter, your compass starts spinning wildly."
	CRLF
	ZERO? COMPASS-KLUDGE \?L14
	PRINTI "What compass, you ask? The one which allows you to specify compass directions for movement."
	CALL PRINT-ID,STR?127
	SET 'COMPASS-KLUDGE,1
?L14:	CRLF
	RTRUE

	.FUNCT MAGNET-ROOM-EXIT
	ZERO? CAROUSEL-FLIP-FLAG /?L1
	EQUAL? WINNER,ADVENTURER \?L1
	PRINTI "You cannot get your bearings..."
	CRLF
	CRLF
	RANDOM 100 >STACK
	GRTR? 50,STACK \?L5
	RETURN MACHINE-ROOM
?L5:	RETURN TEA-ROOM
?L1:	EQUAL? PRSO,P?EAST \?L8
	RETURN MACHINE-ROOM
?L8:	EQUAL? PRSO,P?SE /?L10
	EQUAL? PRSO,P?OUT \?L9
?L10:	RETURN TEA-ROOM
?L9:	PRINTI "You can't go that way."
	CRLF
	RFALSE

	.FUNCT BUTTONS
	EQUAL? PRSA,V?PUSH \FALSE
	EQUAL? WINNER,ADVENTURER \?L3
	CALL PRINT-ID,STR?128
	CALL JIGS-UP,STR?129 >STACK
	RSTACK
?L3:	EQUAL? PRSO,SQUARE-BUTTON \?L5
	ZERO? CAROUSEL-ZOOM-FLAG /?L6
	PRINTR "Nothing seems to happen."
?L6:	SET 'CAROUSEL-ZOOM-FLAG,1
	PRINTR "The whirring increases in intensity."
?L5:	EQUAL? PRSO,ROUND-BUTTON \?L13
	ZERO? CAROUSEL-ZOOM-FLAG /?L14
	SET 'CAROUSEL-ZOOM-FLAG,0
	PRINTR "The whirring decreases in intensity."
?L14:	PRINTR "Nothing seems to happen."
?L13:	EQUAL? PRSO,TRIANGULAR-BUTTON \FALSE
	ZERO? CAROUSEL-FLIP-FLAG \?L22
	SET 'CAROUSEL-FLIP-FLAG,1
	JUMP ?L23
?L22:	SET 'CAROUSEL-FLIP-FLAG,0
?L23:	IN? IRON-BOX,CAROUSEL-ROOM \?L24
	PRINTI "A dull thump is heard in the distance."
	CRLF
	FSET? IRON-BOX,INVISIBLE \?L28
	FCLEAR IRON-BOX,INVISIBLE
	JUMP ?L30
?L28:	FSET IRON-BOX,INVISIBLE
?L30:	FSET? IRON-BOX,INVISIBLE /TRUE
	FCLEAR CAROUSEL-ROOM,TOUCHBIT
	RTRUE
?L24:	PRINTR "Click."

	.FUNCT SPHERE-FCN,FL
	ZERO? CAGE-SOLVE-FLAG \?L1
	EQUAL? PRSA,V?PUT,V?MOVE,V?TAKE \?L1
	SET 'FL,1
	JUMP ?L3
?L1:	SET 'FL,0
?L3:	ZERO? FL /?L11
	EQUAL? ADVENTURER,WINNER \?L4
	PRINTI "As you reach for the sphere, a solid steel cage falls from the ceiling to entrap you. To make matters worse, poisonous gas starts coming into the room."
	CRLF
	CRLF
	CALL PRINT-ID,STR?130
	IN? ROBOT,HERE \?L8
	MOVE ROBOT,IN-CAGE
	FSET ROBOT,NDESCBIT
?L8:	CALL GOTO,IN-CAGE
	MOVE CAGE,HERE
	FSET CAGE,NDESCBIT
	FCLEAR CAGE,INVISIBLE
	CALL QUEUE,I-SPHERE,6 >STACK
	PUT STACK,0,1
	RTRUE
?L4:	ZERO? FL /?L11
	FSET PALANTIR-1,INVISIBLE
	REMOVE ROBOT
	FSET PRSO,INVISIBLE
	MOVE CAGE,CAGE-ROOM
	FCLEAR CAGE,INVISIBLE
	CALL PRINT-ID,STR?131
	CALL JIGS-UP,STR?132
	RTRUE
?L11:	EQUAL? PRSA,V?EXAMINE,V?LOOK-INSIDE \FALSE
	CALL PALANTIR >STACK
	RSTACK

	.FUNCT I-SPHERE
	EQUAL? HERE,CAGE-ROOM,IN-CAGE \FALSE
	FSET PALANTIR-1,INVISIBLE
	CALL MUNG-ROOM,CAGE-ROOM,STR?133
	CALL PRINT-ID,STR?134
	CALL JIGS-UP,STR?135 >STACK
	RSTACK

	.FUNCT IN-CAGE-FCN,RARG
	ZERO? CAGE-SOLVE-FLAG /FALSE
	SET 'HERE,CAGE-ROOM
	RETURN HERE

	.FUNCT ROBOT-FCN,RARG=M-OBJECT
	EQUAL? WINNER,ROBOT \?L1
	EQUAL? PRSA,V?SGIVE /FALSE
	EQUAL? PRSA,V?FOLLOW \?L5
	PRINTR """My memory circuits are not that advanced. I can move as directed, though."""
?L5:	EQUAL? PRSA,V?MOVE,V?TAKE,V?RAISE \?L8
	EQUAL? PRSO,CAGE \?L8
	PRINTI "The cage shakes and is hurled across the room. It's hard to say, but the robot appears to be smiling."
	CRLF
	CRLF
	CALL INT,I-SPHERE >STACK
	PUT STACK,0,0
	SET 'WINNER,ADVENTURER
	CALL GOTO,CAGE-ROOM
	MOVE MANGLED-CAGE,CAGE-ROOM
	FCLEAR ROBOT,NDESCBIT
	FSET PALANTIR-1,TAKEBIT
	MOVE ROBOT,CAGE-ROOM
	SET 'CAGE-SOLVE-FLAG,1
	RETURN CAGE-SOLVE-FLAG
?L8:	EQUAL? PRSA,V?DRINK,V?EAT \?L11
	IN? ADVENTURER,HERE \TRUE
	PRINTR """I am sorry but that is difficult for a being with no mouth."""
?L11:	RANDOM 100 >STACK
	GRTR? 2,STACK \?L17
	CALL META-LOC,ADVENTURER >STACK
	EQUAL? STACK,HERE \?L17
	PRINTR """Buzz! Buzz! Buzz! My circuits are getting rusty. Try again."""
?L17:	EQUAL? PRSA,V?EXAMINE,V?READ \?L20
	CALL META-LOC,ADVENTURER >STACK
	EQUAL? STACK,HERE \TRUE
	PRINTR """My vision is not sufficiently acute to do that."""
?L20:	EQUAL? PRSA,V?THROW,V?PUT,V?DROP \?L26
	CALL META-LOC,ADVENTURER >STACK
	EQUAL? STACK,HERE \FALSE
	IN? PRSO,ROBOT \?L29
	PRINTI """Whirr, buzz, click!"""
	CRLF
	RFALSE
?L29:	PRINTR """Click! I don't have that. Buzz! Whirr!"""
?L26:	EQUAL? PRSA,V?WALK /?L36
	EQUAL? PRSA,V?TURN,V?PUSH,V?TAKE \?L35
	FSET? PRSO,ACTORBIT /?L35
?L36:	CALL META-LOC,ADVENTURER >STACK
	EQUAL? STACK,HERE \FALSE
	RANDOM 100 >STACK
	GRTR? 80,STACK \?L39
	PRINTI """Whirr, buzz, click!"""
	CRLF
	RFALSE
?L39:	PRINTI """Buzz, click, whirr!"""
	CRLF
	RFALSE
?L35:	CALL META-LOC,ADVENTURER >STACK
	EQUAL? STACK,HERE \TRUE
	PRINTR """My programming is insufficient to allow me to perform that task."""
?L1:	EQUAL? PRSA,V?CLOSE,V?LOOK-INSIDE,V?OPEN \?L51
	PRINTR "There's no access panel or door on the robot."
?L51:	EQUAL? PRSA,V?GIVE \?L54
	EQUAL? PRSI,ROBOT \?L54
	MOVE PRSO,ROBOT
	PRINTI "The robot gladly takes the "
	PRINTD PRSO
	PRINTR " and nods his head-like appendage in thanks."
?L54:	EQUAL? PRSA,V?MUNG,V?THROW \FALSE
	PRINTI "The robot falls to the ground and (being of shoddy construction) disintegrates before your eyes."
	CRLF
	CALL PRINT-ID,STR?136
	EQUAL? PRSA,V?THROW \?L60
	PUSH PRSI
	JUMP ?L61
?L60:	ZERO? PRSO /?L62
	PUSH 1
	JUMP ?L61
?L62:	PUSH 0
?L61:	REMOVE STACK
	RTRUE

	.FUNCT BILLS-OBJECT
	SET 'BANK-SOLVE-FLAG,1
	EQUAL? PRSA,V?BURN \?L1
	PRINTI "Nothing like having money to burn!"
	CRLF
	CALL PRINT-ID,STR?137
	RFALSE
?L1:	EQUAL? PRSA,V?EAT \FALSE
	PRINTI "Talk about eating rich foods!"
	CRLF
	CALL PRINT-ID,STR?138 >STACK
	RSTACK

	.FUNCT BKLEAVEE,RM=TELLER-EAST
	CALL HELD?,BILLS >STACK
	ZERO? STACK \?L3
	CALL HELD?,PORTRAIT >STACK
	ZERO? STACK /?L1
?L3:	PRINTI "An alarm rings briefly, and an invisible force bars your way."
	CRLF
	CALL PRINT-ID,STR?139
	RFALSE
?L1:	RETURN RM

	.FUNCT BKLEAVEW
	CALL BKLEAVEE,TELLER-WEST >STACK
	RSTACK

	.FUNCT DEPOSITORY-FCN,RARG
	EQUAL? RARG,M-ENTER \FALSE
	CALL PRINT-ID,STR?140
	CALL LKP,PRSO,SCOL-ROOMS >SCOL-ROOM
	RETURN SCOL-ROOM

	.FUNCT TELLER-ROOM,RARG
	EQUAL? RARG,M-LOOK \FALSE
	PRINTI "You are in a small room, which was used by a bank officer who retrieved safety deposit boxes for the customer. On the north side of the room is a sign which reads  ""Viewing Room"". On the "
	EQUAL? HERE,TELLER-WEST \?L5
	PRINTI "west"
	JUMP ?L9
?L5:	PRINTI "east"
?L9:	PRINTR " side of the room, above an open door, is a sign reading:

          BANK PERSONNEL ONLY
"

	.FUNCT SCOL-OBJECT,OBJ=0
	EQUAL? PRSA,V?TAKE,V?MOVE,V?PUSH /?L3
	EQUAL? PRSA,V?RUB \?L1
?L3:	PRINTR "As you try, your hand seems to go through it."
?L1:	EQUAL? PRSA,V?ATTACK \?L6
	ZERO? PRSI /?L6
	PRINTI "The "
	PRINTD PRSI
	PRINTI " goes through it."
	CRLF
	CALL PRINT-ID,STR?141 >STACK
	RSTACK
?L6:	EQUAL? PRSA,V?OVERBOARD,V?THROW \FALSE
	EQUAL? PRSI,CURTAIN,OBJ \FALSE
	IN? PRSO,WINNER \?L10
	CALL V-THROUGH,PRSO >STACK
	RSTACK
?L10:	PRINTR "You don't have that!"

	.FUNCT GET-WALL,RM,W
	SET 'W,SCOL-WALLS
?L1:	GET W,0 >STACK
	EQUAL? STACK,RM \?L3
	RETURN W
?L3:	ADD W,6 >W
	JUMP ?L1

	.FUNCT SCOLWALL,?TMP
	EQUAL? PRSA,V?PUT,V?OVERBOARD,V?THROW \FALSE
	EQUAL? HERE,SCOL-ACTIVE \FALSE
	SET '?TMP,PRSI
	CALL GET-WALL,HERE >STACK
	GET STACK,1 >STACK
	EQUAL? ?TMP,STACK \FALSE
	CALL SCOL-OBJECT,PRSI >STACK
	RSTACK

	.FUNCT SCOL-GO,OBJ
	SET 'SCOL-ACTIVE,SCOL-ROOM
	ZERO? OBJ /?L1
	CALL SCOL-OBJ,OBJ,0,SCOL-ROOM >STACK
	RSTACK
?L1:	CALL SCOL-THROUGH,12,SCOL-ROOM >STACK
	RSTACK

	.FUNCT SCOL-OBJ,OBJ,CINT,RM
	CALL QUEUE,I-CURTAIN,CINT >STACK
	PUT STACK,0,1
	MOVE OBJ,RM
	EQUAL? RM,DEPOSITORY \?L1
	PRINTI "The "
	PRINTD OBJ
	PRINTR " passes through the wall and vanishes."
?L1:	PRINTI "The curtain dims slightly as the "
	PRINTD OBJ
	PRINTI " passes through."
	CRLF
	SET 'SCOL-ROOM,0
	RTRUE

	.FUNCT SCOL-THROUGH,CINT,RM
	CALL QUEUE,I-CURTAIN,CINT >STACK
	PUT STACK,0,1
	PRINTI "You feel somewhat disoriented as you pass through..."
	CRLF
	CRLF
	CALL GOTO,RM >STACK
	RSTACK

	.FUNCT I-CURTAIN
	SET 'SCOL-ACTIVE,0
	EQUAL? HERE,VAULT \?L1
	CALL PRINT-ID,STR?142
	CALL JIGS-UP,STR?143 >STACK
	RSTACK
?L1:	EQUAL? HERE,VIEWING-EAST,VIEWING-WEST,SMALL-ROOM \FALSE
	PRINTI "You hear a faint voice say ""Curtain Door Closed."""
	CRLF
	EQUAL? HERE,SMALL-ROOM \FALSE
	ZERO? ZGNOME-FLAG \TRUE
	CALL QUEUE,I-ZGNOME,3 >STACK
	PUT STACK,0,1
	SET 'ZGNOME-FLAG,1
	RETURN ZGNOME-FLAG

	.FUNCT I-ZGNOME
	EQUAL? HERE,SMALL-ROOM \FALSE
	CALL QUEUE,I-ZGNOME-OUT,12 >STACK
	PUT STACK,0,1
	PRINTI "An epicene gnome of Zurich wearing a three-piece suit and carrying a safety deposit box materializes in the room."
	IN? WAND,WINNER \?L5
	PRINTR " He notices the wand and dematerializes speedily."
?L5:	PRINTI " ""You seem to have forgotten to deposit your valuables,"" he says, tapping the lid of the box impatiently. ""We don't usually allow customers to use the boxes here, but we can make this ONE exception, I suppose..."" He looks askance at you over his wire-rimmed bifocals."
	CRLF
	MOVE GNOME-OF-ZURICH,HERE
	RTRUE

	.FUNCT BOX-F
	PRINTI "The gnome clutches it possessively."
	CRLF
	EQUAL? PRSA,V?BURN,V?MUNG,V?TAKE /?L5
	EQUAL? PRSA,V?MELT,V?ATTACK,V?STAB /?L5
	EQUAL? PRSA,V?SWING,V?STRIKE /?L7
	PUSH 0
	JUMP ?L3
?L7:	PUSH 1
	JUMP ?L3
?L5:	PUSH 1
?L3:	CALL PRINT-ID,STR?144,STACK >STACK
	RSTACK

	.FUNCT ZGNOME-FCN
	EQUAL? PRSA,V?TELL \?L1
	SET 'P-CONT,0
	SET 'QUOTE-FLAG,0
	PRINTR "The gnome appears increasingly impatient."
?L1:	EQUAL? PRSA,V?THROW,V?GIVE \?L5
	EQUAL? PRSI,GNOME-OF-ZURICH \?L5
	GETPT PRSO,P?VALUE >STACK
	ZERO? STACK /?L6
	PRINTI "The gnome carefully places the "
	PRINTD PRSO
	PRINTI " in the deposit box. ""Let me show you the way out,"" he says, making it clear he will be pleased to see the last of you. Then, you are momentarily disoriented, and when you recover you are back at the Bank Entrance."
	CRLF
	CALL PRINT-ID,STR?145
	REMOVE GNOME-OF-ZURICH
	REMOVE PRSO
	CALL INT,I-ZGNOME-OUT >STACK
	PUT STACK,0,0
	CALL GOTO,BANK-ENTRANCE
	RTRUE
?L6:	CALL BOMB?,PRSO >STACK
	ZERO? STACK /?L10
	REMOVE GNOME-OF-ZURICH
	MOVE PRSO,HERE
	CALL INT,I-ZGNOME >STACK
	PUT STACK,0,0
	CALL INT,I-ZGNOME-OUT >STACK
	PUT STACK,0,0
	PRINTI """You are so very gracious. I really cannot accept."" he says. He disappears, a wry smile on his lips."
	CRLF
	CALL PRINT-ID,STR?146 >STACK
	RSTACK
?L10:	PRINTI """I wouldn't put THAT in a safety deposit box,"" remarks the gnome with disdain, tossing it over his shoulder, where it disappears with an understated ""pop""."
	CRLF
	CALL PRINT-ID,STR?147
	CALL REMOVE-CAREFULLY,PRSO
	RTRUE
?L5:	EQUAL? PRSA,V?ATTACK \?L16
	PRINTI "The gnome says ""Well, I never..."" and disappears with a snap of his fingers, leaving you alone."
	CRLF
	CALL PRINT-ID,STR?148
	REMOVE GNOME-OF-ZURICH
	CALL INT,I-ZGNOME-OUT >STACK
	PUT STACK,0,0
	RTRUE
?L16:	PRINTR "The gnome appears increasingly impatient."

	.FUNCT I-ZGNOME-OUT
	REMOVE GNOME-OF-ZURICH
	EQUAL? HERE,SMALL-ROOM \FALSE
	PRINTI "The gnome looks impatient: ""I may have another customer waiting; you'll just have to fend for yourself, I'm afraid."" He disappears, leaving you alone."
	CRLF
	CALL PRINT-ID,STR?149 >STACK
	RSTACK

	.FUNCT BOMB?,O
	EQUAL? O,BRICK \FALSE
	IN? FUSE,BRICK \FALSE
	CALL INT,I-FUSE >STACK
	GET STACK,C-ENABLED? >STACK
	ZERO? STACK /FALSE
	RTRUE

	.FUNCT GO$0026LOOK,RM,OHERE,OLIT,OSEEN=0
	SET 'OHERE,HERE
	FSET? OHERE,TOUCHBIT \?L1
	SET 'OSEEN,1
?L1:	SET 'OLIT,LIT
	SET 'HERE,RM
	CALL LIT?,RM >LIT
	CALL PERFORM,V?LOOK
	ZERO? OSEEN \?L4
	FCLEAR OHERE,TOUCHBIT
?L4:	SET 'HERE,OHERE
	SET 'LIT,OLIT
	RTRUE

	.FUNCT TINY-ROOM-FCN,RARG
	EQUAL? RARG,M-LOOK \?L1
	PRINTI "This is a tiny room carved out of the wall of the ravine. There is an exit down a precarious climb. "
	CALL P-DOOR,STR?150,LID-1,KEYHOLE-1
	RTRUE
?L1:	EQUAL? PRSA,V?LOOK /FALSE
	CALL PCHECK
	RFALSE

	.FUNCT DREARY-ROOM-FCN,RARG
	EQUAL? RARG,M-LOOK \?L1
	PRINTI "This is a small and rather dreary room, eerily illuminated by a red glow emanating from a crack in one wall. The light falls upon a dusty wooden table in the center of the room. "
	CALL P-DOOR,STR?151,LID-2,KEYHOLE-2
	RTRUE
?L1:	CALL PCHECK
	RFALSE

	.FUNCT PCHECK,LID
	CALL PLID >LID
	SET 'PLOOK-FLAG,0
	IN? KEY,KEYHOLE-1 /?L3
	IN? KEY,KEYHOLE-2 \?L1
?L3:	FSET KEY,NDESCBIT
	JUMP ?L4
?L1:	FCLEAR KEY,NDESCBIT
?L4:	CALL HELD?,PLACE-MAT >STACK
	ZERO? STACK /?L5
	SET 'MUD-FLAG,0
?L5:	ZERO? MUD-FLAG /?L8
	MOVE PLACE-MAT,HERE
	FSET PLACE-MAT,NDESCBIT
	RTRUE
?L8:	FCLEAR PLACE-MAT,NDESCBIT
	RTRUE

	.FUNCT P-DOOR,STR,LID,KEYHOLE,F
	ZERO? PLOOK-FLAG /?L1
	SET 'PLOOK-FLAG,0
	RFALSE
?L1:	PRINTI "On the "
	PRINT STR
	PRINTI " side of the room is a massive wooden door, which has a small window barred with iron. A formidable bolt lock is set within the door frame. A keyhole "
	FSET? LID,OPENBIT /?L6
	PRINTI "covered by a thin metal lid "
?L6:	PRINTI "lies within the lock."
	FIRST? KEYHOLE >F \?L13
	PRINTI " A "
	PRINTD F
	PRINTI " is in place within the keyhole."
?L13:	ZERO? MUD-FLAG /?L22
	PRINTI " The edge of a place mat is visible under the door."
	ZERO? MATOBJ /?L22
	PRINTI " Lying on the place mat is a "
	PRINTD MATOBJ
	PRINTI "."
?L22:	CRLF
	RTRUE

	.FUNCT PLID,OBJ1=LID-1,OBJ2=LID-2
	IN? OBJ1,HERE \?L1
	RETURN OBJ1
?L1:	RETURN OBJ2

	.FUNCT PKH,KEYHOLE,THIS=0
	EQUAL? KEYHOLE,KEYHOLE-1 \?L5
	ZERO? THIS \?L1
	RETURN KEYHOLE-2
?L1:	EQUAL? KEYHOLE,KEYHOLE-1 /?L3
?L5:	ZERO? THIS /?L3
	RETURN KEYHOLE-2
?L3:	RETURN KEYHOLE-1

	.FUNCT PKH-FCN,OBJ,KH
	EQUAL? PRSA,V?LOOK-INSIDE \?L1
	FSET? LID-1,OPENBIT \?L3
	FSET? LID-2,OPENBIT \?L3
	FIRST? KEYHOLE-1 >STACK /?L3
	FIRST? KEYHOLE-2 >STACK /?L3
	EQUAL? HERE,DREARY-ROOM \?L5
	PUSH TINY-ROOM
	JUMP ?L7
?L5:	PUSH DREARY-ROOM
?L7:	CALL LIT?,STACK >STACK
	ZERO? STACK /?L3
	PRINTR "You can see a lighted room at the other end."
?L3:	PRINTR "No light can be seen through the keyhole."
?L1:	EQUAL? PRSA,V?PUT \FALSE
	CALL PLID >STACK
	FSET? STACK,OPENBIT \?L14
	CALL PKH,PRSI,1 >STACK
	FIRST? STACK >STACK \?L16
	PRINTR "The keyhole is blocked."
?L16:	EQUAL? PRSO,LETTER-OPENER,KEY \?L20
	CALL PKH,PRSI >KH
	FIRST? KH >STACK \FALSE
	PRINTI "There is a faint noise from behind the door and a small cloud of dust rises from beneath it."
	CRLF
	FIRST? KH >OBJ /?L25
?L25:	REMOVE OBJ
	ZERO? MUD-FLAG /FALSE
	SET 'MATOBJ,OBJ
	RFALSE
?L20:	PRINTI "The "
	PRINTD PRSO
	PRINTR " doesn't fit."
?L14:	PRINTR "The lid is in the way."

	.FUNCT PLID-FCN
	EQUAL? PRSA,V?MOVE,V?RAISE,V?OPEN \?L1
	FSET? PRSO,OPENBIT \?L3
	CALL RANDOM-ELEMENT,DUMMY >STACK
	PRINT STACK
	CRLF
	JUMP ?L7
?L3:	PRINTI "The lid is now open."
	CRLF
?L7:	FSET PRSO,OPENBIT
	RTRUE
?L1:	EQUAL? PRSA,V?LOWER,V?CLOSE \?L10
	EQUAL? HERE,DREARY-ROOM \?L13
	PUSH KEYHOLE-2
	JUMP ?L15
?L13:	PUSH KEYHOLE-1
?L15:	FIRST? STACK >STACK \?L11
	PRINTR "The keyhole is occupied."
?L11:	PRINTI "The lid covers the keyhole."
	CRLF
	FCLEAR PRSO,OPENBIT
	RTRUE
?L10:	EQUAL? PRSA,V?LOOK-BEHIND \FALSE
	PRINTR "There's a keyhole behind the lid."

	.FUNCT ROOM?,OBJ,NOBJ
?L1:	LOC OBJ >NOBJ
	EQUAL? NOBJ,0,WINNER /FALSE
	EQUAL? NOBJ,ROOMS \?L6
	RETURN OBJ
?L6:	SET 'OBJ,NOBJ
	JUMP ?L1

	.FUNCT PALANTIR
	EQUAL? PRSA,V?LOOK-INSIDE \?L1
	EQUAL? PRSO,PALANTIR-1 \?L3
	PUSH PALANTIR-2
	JUMP ?L7
?L3:	EQUAL? PRSO,PALANTIR-2 \?L5
	PUSH PALANTIR-3
	JUMP ?L7
?L5:	EQUAL? PRSO,PALANTIR-3 \?L6
	PUSH PALANTIR-1
	JUMP ?L7
?L6:	PUSH PALANTIR-4
?L7:	CALL PALANTIR-LOOK,STACK >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?EXAMINE \?L8
	PRINTR "There is something misty in the sphere. Perhaps if you were to look into it..."
?L8:	EQUAL? PRSA,V?TAKE \FALSE
	EQUAL? PRSO,PALANTIR-3 \FALSE
	PUTP PRSO,P?LDESC,0
	RFALSE

	.FUNCT DEAD-PALANTIR,RARG,P
	EQUAL? RARG,M-LOOK \?L1
	PRINTI "You are inside a huge crystalline sphere filled with thin "
	EQUAL? HERE,DEAD-PALANTIR-1 \?L5
	SET 'P,PALANTIR-1
	PUSH STR?152
	JUMP ?L8
?L5:	EQUAL? HERE,DEAD-PALANTIR-2 \?L7
	SET 'P,PALANTIR-2
	PUSH STR?153
	JUMP ?L8
?L7:	SET 'P,PALANTIR-3
	PUSH STR?154
?L8:	PRINT STACK
	PRINTI " mist. The mist becomes "
	EQUAL? HERE,DEAD-PALANTIR-1 \?L9
	PUSH STR?153
	JUMP ?L12
?L9:	EQUAL? HERE,DEAD-PALANTIR-2 \?L11
	PUSH STR?154
	JUMP ?L12
?L11:	PUSH STR?155
?L12:	PRINT STACK
	PRINTI " to the west."
	CRLF
	PRINTI "You strain to look out through the mist... "
	CRLF
	FSET? P,TOUCHBIT \?L15
	CALL PALANTIR-LOOK,P,1
	RTRUE
?L15:	EQUAL? P,PALANTIR-1 \?L17
	PRINTR "You see a small room with a sign on the wall, but it is too blurry to read."
?L17:	EQUAL? P,PALANTIR-2 \?L20
	PRINTR "You look out into a large, dreary room with a great door and a huge table. There is an odd glow to the mist."
?L20:	EQUAL? P,PALANTIR-3 \TRUE
	PRINTI "A strange blurry room is barely visible."
	IN? SERPENT,AQUARIUM \?L26
	RANDOM 100 >STACK
	GRTR? 25,STACK \?L26
	PRINTI " An odd sinuous shadow crosses the mist as you look."
?L26:	CRLF
	RTRUE
?L1:	EQUAL? RARG,M-ENTER \FALSE
	EQUAL? HERE,DEAD-PALANTIR-4 \FALSE
	PRINTI "You follow a corridor of black mist into a black walled spherical room."
	IN? GENIE,PENTAGRAM-ROOM \?L35
	PRINTI " The room is empty. A huge face looks down on you from outside and laughs sardonically. It doesn't look like you're getting out of this predicament!"
	CRLF
	CALL PRINT-ID,STR?156
	CALL FINISH
?L35:	PRINTI " As you enter, a huge and horrible face materializes out of the mist.

""What brings you here to trouble my imprisonment, wanderer?"" it asks. Hearing no immediate answer, it studies you for a moment."
	CRLF
	LESS? DEATHS,3 /?L42
	PRINTI """Not you again! This is getting tedious. You'll obviously never be much help to me. Better luck next time, oh wondrous adventurer."" The face disappears and everything goes black."
	CRLF
	CALL PRINT-ID,STR?157
	CALL FINISH >STACK
	RSTACK
?L42:	PRINTI """Perhaps you may be of some use to me in gaining my freedom from this place. Return to your foolish quest! I shall not destroy you this time. Mayhap you will repay this favor in kind someday."" The face vanishes and the mist begins to swirl. When it clears you are returned to the world of life."
	CRLF
	CALL PRINT-ID,STR?158
	SET 'DEAD,0
	CALL GOTO,INSIDE-BARROW
	RTRUE

	.FUNCT GLOBAL-PALANTIRS
	EQUAL? PRSA,V?EXAMINE,V?LOOK-INSIDE \?L1
	CALL DEAD-PALANTIR,M-LOOK >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?MUNG \FALSE
	PRINTR "The sphere is unbreakable."

	.FUNCT PALANTIR-LOOK,OBJ,INSIDE?=0,RM,OHERE
	EQUAL? OBJ,PALANTIR-4 \?L1
	PRINTR "As you peer into the sphere, a strange vision takes shape...a huge and fearful face with yellow eyes. The face peers out at you expectantly."
?L1:	EQUAL? HERE,OBJ /?L6
	SET 'RM,0
	JUMP ?L7
?L6:	SET 'RM,1
?L7:	ZERO? RM /?L10
	CALL LIT?,RM >STACK
	ZERO? STACK \?L8
?L10:	PRINTR "You see only darkness."
?L8:	IN? OBJ,RM /?L14
	LOC OBJ >STACK
	CALL SEE-INSIDE?,STACK >STACK
	ZERO? STACK /?L13
?L14:	SET 'OHERE,HERE
	ZERO? INSIDE? /?L15
	PRINTI "As you peer through the mist, a strangely colored vision of a huge room takes shape..."
	CRLF
	CRLF
	JUMP ?L19
?L15:	PRINTI "As you peer into the sphere, a strange vision takes shape of a distant room, which can be described clearly...."
	CRLF
	CRLF
?L19:	FSET OBJ,INVISIBLE
	CALL GO$0026LOOK,RM
	EQUAL? OHERE,RM \?L22
	PRINTI "An astonished adventurer is staring into a crystal sphere."
	CRLF
?L22:	FCLEAR OBJ,INVISIBLE
	ZERO? INSIDE? \TRUE
	PRINTR "The vision fades, revealing only an ordinary crystal sphere."
?L13:	PRINTR "You see only darkness."

	.FUNCT PWINDOW-FCN
	EQUAL? PRSA,V?LOOK-INSIDE \?L1
	SET 'PLOOK-FLAG,1
	FSET? PDOOR,OPENBIT \?L3
	PRINTR "The door is open, dummy."
?L3:	EQUAL? HERE,DREARY-ROOM \?L7
	CALL GO$0026LOOK,TINY-ROOM >STACK
	RSTACK
?L7:	CALL GO$0026LOOK,DREARY-ROOM >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?THROUGH \FALSE
	PRINTR "Perhaps if you were diced...."

	.FUNCT PDOOR-FCN,K
	EQUAL? PRSA,V?LOOK-UNDER \?L1
	ZERO? MUD-FLAG /?L1
	PRINTR "The place mat is under the door."
?L1:	EQUAL? PRSA,V?UNLOCK \?L5
	EQUAL? PRSI,KEY \?L6
	CALL PLID,KEYHOLE-1,KEYHOLE-2 >STACK
	FIRST? STACK >K \?L8
	EQUAL? K,KEY /?L8
	PRINTR "The keyhole is blocked."
?L8:	PRINTI "The door is now unlocked."
	CRLF
	SET 'PUNLOCK-FLAG,1
	RETURN PUNLOCK-FLAG
?L6:	EQUAL? PRSI,GOLD-KEY \?L15
	PRINTR "It doesn't fit the lock."
?L15:	PRINTR "It can't be unlocked with that."
?L5:	EQUAL? PRSA,V?LOCK \?L21
	EQUAL? PRSI,KEY \?L22
	PRINTI "The door is locked."
	CRLF
	SET 'PUNLOCK-FLAG,0
	RTRUE
?L22:	EQUAL? PRSI,GOLD-KEY \?L26
	PRINTR "It doesn't fit the lock."
?L26:	PRINTR "It can't be locked with that."
?L21:	EQUAL? PRSA,V?PUT-UNDER \?L32
	EQUAL? PRSO,ROBOT-LABEL \?L33
	PRINTI "The paper is very small and vanishes under the door."
	CRLF
	EQUAL? HERE,TINY-ROOM \?L37
	PUSH DREARY-ROOM
	JUMP ?L39
?L37:	PUSH TINY-ROOM
?L39:	MOVE PRSO,STACK
	RTRUE
?L33:	EQUAL? PRSO,NEWSPAPER \FALSE
	PRINTR "The newspaper crumples up and won't go under the door."
?L32:	EQUAL? PRSA,V?CLOSE,V?OPEN \FALSE
	ZERO? PUNLOCK-FLAG /?L45
	CALL OPEN-CLOSE,PRSO,STR?160,STR?159 >STACK
	RSTACK
?L45:	PRINTR "The door is locked."

	.FUNCT PKEY-FCN
	EQUAL? PRSA,V?TURN \FALSE
	ZERO? PUNLOCK-FLAG /?L3
	CALL PERFORM,V?LOCK,PDOOR,PRSO >STACK
	RSTACK
?L3:	CALL PERFORM,V?UNLOCK,PDOOR,PRSO >STACK
	RSTACK

	.FUNCT PLACE-MAT-FCN
	EQUAL? PRSA,V?PUT-UNDER \?L1
	EQUAL? PRSI,PDOOR \?L3
	PRINTI "The place mat fits easily under the door."
	CRLF
	MOVE PRSO,HERE
	SET 'MUD-FLAG,1
	RETURN MUD-FLAG
?L3:	EQUAL? PRSI,WIZ-DOOR,RIDDLE-DOOR,CRYPT-DOOR \FALSE
	PRINTR "There's not enough room under this door."
?L1:	EQUAL? PRSA,V?MOVE,V?TAKE \FALSE
	ZERO? MATOBJ /FALSE
	MOVE MATOBJ,HERE
	PRINTI "As the place mat is moved, a "
	PRINTD MATOBJ
	PRINTI " falls from it and onto the floor."
	CRLF
	SET 'MATOBJ,0
	SET 'MUD-FLAG,0
	RTRUE

	.FUNCT WISH-FCN
	EQUAL? PRSA,V?MAKE \FALSE
	EQUAL? HERE,WELL-BOTTOM \?L3
	IN? COIN,HERE \?L3
	PRINTI "A whispering voice replies: ""Water makes the bucket go."" Unfortunately, wishing makes the coin go...."
	CRLF
	REMOVE COIN
	RTRUE
?L3:	PRINTR "No one is listening."

	.FUNCT WELL-FCN
	FSET? PRSO,TAKEBIT \?L1
	EQUAL? PRSA,V?DROP,V?PUT,V?THROW \?L1
	PRINTI "The "
	PRINTD PRSO
	PRINTI " is now sitting at the bottom of the well."
	CRLF
	MOVE PRSO,WELL-BOTTOM
	RTRUE
?L1:	EQUAL? PRSA,V?CLIMB-FOO,V?CLIMB-DOWN,V?CLIMB-UP \FALSE
	PRINTR "You can't climb the well."

	.FUNCT MATCH-FCN,CNT
	EQUAL? PRSA,V?BURN,V?LAMP-ON \?L1
	EQUAL? PRSO,MATCH \?L1
	GRTR? MATCH-COUNT,0 \?L8
	DEC 'MATCH-COUNT
	GRTR? MATCH-COUNT,0 /?L6
?L8:	PRINTR "I'm afraid you have run out of matches."
?L6:	FSET MATCH,FLAMEBIT
	FSET MATCH,ONBIT
	CALL QUEUE,I-MATCH,2 >STACK
	PUT STACK,0,1
	PRINTR "One of the matches starts to burn."
?L1:	EQUAL? PRSA,V?LAMP-OFF \?L13
	FSET? MATCH,FLAMEBIT \?L13
	PRINTI "The match is out."
	CRLF
	FCLEAR MATCH,FLAMEBIT
	FCLEAR MATCH,ONBIT
	CALL QUEUE,I-MATCH,0
	RTRUE
?L13:	EQUAL? PRSA,V?COUNT \?L16
	PRINTI "You have "
	SUB MATCH-COUNT,1 >CNT
	PRINTN CNT
	PRINTI " match"
	EQUAL? CNT,1 /?L21
	PRINTR "es."
?L21:	PRINTR "."
?L16:	EQUAL? PRSA,V?EXAMINE \FALSE
	FSET? MATCH,ONBIT \?L29
	PRINTR "A match is burning."
?L29:	PRINTR "No match is burning."

	.FUNCT I-MATCH
	PRINTI "The match has gone out."
	CRLF
	FCLEAR MATCH,FLAMEBIT
	FCLEAR MATCH,ONBIT
	RTRUE

	.FUNCT LANTERN
	EQUAL? PRSA,V?THROW \?L1
	EQUAL? PRSO,LAMP \?L1
	PRINTI "The lamp has smashed into the floor, and the light has gone out."
	CRLF
	CALL INT,I-LANTERN >STACK
	PUT STACK,0,0
	REMOVE LAMP
	MOVE BROKEN-LAMP,HERE
	RTRUE
?L1:	EQUAL? PRSA,V?LAMP-ON \?L5
	FSET? LAMP,RMUNGBIT \?L6
	PRINTR "A burned-out lamp won't light."
?L6:	CALL INT,I-LANTERN >STACK
	PUT STACK,0,1
	RFALSE
?L5:	EQUAL? PRSA,V?LAMP-OFF \?L11
	FSET? LAMP,RMUNGBIT \?L12
	PRINTR "The lamp has already burned out."
?L12:	CALL INT,I-LANTERN >STACK
	PUT STACK,0,0
	RFALSE
?L11:	EQUAL? PRSA,V?EXAMINE \FALSE
	FSET? LAMP,RMUNGBIT \?L18
	PRINTR "The lamp has burned out."
?L18:	FSET? LAMP,ONBIT \?L22
	PRINTR "The lamp is on."
?L22:	PRINTR "The lamp is turned off."

	.FUNCT I-LANTERN,TICK,TBL
	SET 'TBL,LAMP-TABLE
	GET TBL,0 >TICK
	CALL QUEUE,I-LANTERN,TICK >STACK
	PUT STACK,0,1
	CALL LIGHT-INT,LAMP,TBL,TICK
	ZERO? TICK /FALSE
	ADD TBL,4 >LAMP-TABLE
	RETURN LAMP-TABLE

	.FUNCT LIGHT-INT,OBJ,TBL,TICK
	ZERO? TICK \?L1
	FCLEAR OBJ,ONBIT
	FSET OBJ,RMUNGBIT
?L1:	CALL HELD?,OBJ >STACK
	ZERO? STACK \?L6
	IN? OBJ,HERE \FALSE
?L6:	ZERO? TICK \?L7
	PRINTI "You'd better have more light than from the "
	PRINTD OBJ
	PRINTR "."
?L7:	GET TBL,1 >STACK
	PRINT STACK
	CRLF
	RTRUE

	.FUNCT RIDDLE-ROOM-FCN,RARG
	EQUAL? RARG,M-LOOK \?L1
	PRINTI "This is a room which is bare on all sides. There is an exit down in the northwest corner of the room. To the east is a great "
	FSET? RIDDLE-DOOR,OPENBIT \?L5
	PRINTI "open"
	JUMP ?L9
?L5:	PRINTI "closed"
?L9:	PRINTI " door made of stone. Above the stone, the following words are written: ""No man shall pass this door without solving this riddle:

  What is tall as a house,
    round as a cup,
      and all the king's horses
        can't draw it up?""
"
	RTRUE
?L1:	EQUAL? RARG,M-BEG \FALSE
	EQUAL? PRSA,V?SAY,V?ANSWER \FALSE
	FSET? RIDDLE-DOOR,OPENBIT /FALSE
	GET P-LEXV,P-CONT >STACK
	EQUAL? STACK,W?WELL /?L20
	ADD P-CONT,2 >STACK
	GET P-LEXV,STACK >STACK
	EQUAL? STACK,W?WELL \?L19
?L20:	PRINTI "There is a deafening clap of thunder and the stone door quietly swings open to reveal a passageway beyond."
	CRLF
	CALL SCORE-UPD,5
	FSET RIDDLE-DOOR,OPENBIT
	JUMP ?L23
?L19:	PRINTI "A hollow laugh seems to come from the stone door."
	CRLF
?L23:	SET 'P-CONT,0
	SET 'QUOTE-FLAG,0
	RTRUE

	.FUNCT RIDDLE-DOOR-FCN
	EQUAL? PRSA,V?OPEN \?L1
	FSET? RIDDLE-DOOR,OPENBIT \?L3
	PRINTR "It is open!"
?L3:	PRINTR "The door can only be opened by answering the riddle."
?L1:	EQUAL? PRSA,V?CLOSE \FALSE
	FSET? RIDDLE-DOOR,OPENBIT \?L11
	PRINTR "Not a chance. The door weighs many tons."
?L11:	PRINTR "It is closed!"

	.FUNCT RIDDLE-PSEUDO
	EQUAL? PRSA,V?EXAMINE \FALSE
	PRINTR "Use the ""Look"" command."

	.FUNCT MAGIC-ACTOR,V
	ZERO? SPELL? /FALSE
	EQUAL? SPELL?,S-FALL \?L3
	EQUAL? PRSA,V?CROSS,V?CLIMB-DOWN,V?CLIMB-UP /?L7
	EQUAL? PRSA,V?WALK \?L5
	GETPT HERE,P?DOWN >STACK
	ZERO? STACK /?L5
?L7:	GETPT HERE,P?GLOBAL >V
	PTSIZE V >STACK
	CALL ZMEMQB,BRIDGE,V,STACK >STACK
	ZERO? STACK /?L8
	CALL PRINT-ID,STR?161
	CALL JIGS-UP,STR?162 >STACK
	RSTACK
?L8:	RANDOM 100 >STACK
	GRTR? 25,STACK \?L10
	CALL PRINT-ID,STR?163
	CALL JIGS-UP,STR?164 >STACK
	RSTACK
?L10:	PRINTR "You just tripped on an invisible cord, or perhaps your own feet. But this must be your lucky day, as you managed to regain your balance before what could have been a fatal fall."
?L5:	EQUAL? PRSA,V?BOARD \FALSE
	PRINTI "You get in the "
	PRINTD PRSO
	PRINTR " but you fall out again, almost as though an invisible hand had tipped it over."
?L3:	EQUAL? SPELL?,S-FLOAT \?L18
	EQUAL? PRSA,V?WAIT,V?DIAGNOSE /FALSE
	EQUAL? PRSA,V?WALK \?L21
	PRINTR "I suppose you plan to do that by flapping your arms?"
?L21:	EQUAL? PRSA,V?DROP \?L24
	MOVE PRSO,HERE
	PRINTI "The "
	PRINTD PRSO
	PRINTR " drops to the ground."
?L24:	EQUAL? PRSA,V?TAKE \FALSE
	IN? PRSO,HERE \FALSE
	PRINTR "You can't reach that! It's on the ground."
?L18:	EQUAL? SPELL?,S-FREEZE \?L31
	EQUAL? PRSA,V?WAIT,V?DIAGNOSE /FALSE
	PRINTR "You are frozen solid. You might as well wait it out, because you can't do anything else in this state."
?L31:	EQUAL? SPELL?,S-FENCE \?L37
	EQUAL? PRSA,V?WALK \?L37
	PRINTR "An invisible fence of magical force bars your way."
?L37:	EQUAL? SPELL?,S-FIERCE \?L40
	CALL INFESTED?,HERE >V
	ZERO? V /?L40
	EQUAL? PRSA,V?MUNG,V?ATTACK /FALSE
	CALL FORCE-FIGHT,V
	RTRUE
?L40:	EQUAL? SPELL?,S-FERMENT \?L44
	EQUAL? PRSA,V?WALK \?L44
	IN? WINNER,HERE \?L44
	PRINTI "Oops, you seem a little unsteady... I'm not sure you got where you intended going."
	CRLF
	CRLF
	CALL RANDOM-WALK >STACK
	RSTACK
?L44:	EQUAL? SPELL?,S-FEAR \FALSE
	CALL INFESTED?,HERE >V
	ZERO? V /FALSE
	PRINTI "All at once, you are overcome by fear! There's is a "
	PRINTD V
	PRINTI " in here! Maybe it's after you! "
	LOC WINNER >STACK
	FSET? STACK,VEHBIT \?L50
	PRINTR "You huddle in the corner, terrified."
?L50:	PRINTI "You run from the room screaming in terror!"
	CRLF
	CRLF
	CALL RANDOM-WALK >STACK
	RSTACK

	.FUNCT RANDOM-WALK,P,TX,L,S,D=0
	SET 'P,0
?L1:	NEXTP HERE,P >P
	LESS? P,P?CROSS \?L3
	ZERO? D /TRUE
	SET 'S,SPELL?
	SET 'SPELL?,0
	SET 'WINNER,ADVENTURER
	MOVE WINNER,HERE
	CALL DO-WALK,D
	SET 'SPELL?,S
	RTRUE
?L3:	GETPT HERE,P >TX
	PTSIZE TX >L
	EQUAL? L,UEXIT /?L11
	EQUAL? L,CEXIT \?L12
	GETB TX,CEXITFLAG >STACK
	VALUE STACK >STACK
	ZERO? STACK \?L11
?L12:	EQUAL? L,DEXIT \?L1
	GETB TX,DEXITOBJ >STACK
	FSET? STACK,OPENBIT \?L1
?L11:	ZERO? D \?L13
	SET 'D,P
	JUMP ?L1
?L13:	RANDOM 100 >STACK
	GRTR? 50,STACK \?L1
	SET 'D,P
	JUMP ?L1

	.FUNCT FORCE-FIGHT,V,W
	CALL FIND-IN,ADVENTURER,WEAPONBIT >W
	ZERO? W \?L1
	SET 'W,HANDS
?L1:	PRINTI "You are maddened by an overwhelming ferocity, and attack the "
	PRINTD V
	PRINTI " instead."
	CRLF
	CALL PRINT-ID,STR?165
	CALL PERFORM,V?ATTACK,V,W >STACK
	RSTACK

	.FUNCT DWINDOW-DESC
	PRINTI "On the floor is a very small diamond shaped window which is "
	ZERO? DIAMOND-SOLVE /?L3
	PRINTI "glowing serenely"
	JUMP ?L7
?L3:	GET DWDESCS,DIAMOND-COUNT >STACK
	PRINT STACK
?L7:	PRINTR "."

	.FUNCT DWINDOW-FCN
	EQUAL? PRSA,V?TAKE \?L1
	PRINTR "The window is an integral part of the floor."
?L1:	EQUAL? PRSA,V?MUNG \?L5
	PRINTR "The window is diamond-hard and cannot be broken."
?L5:	EQUAL? PRSA,V?LOOK-INSIDE,V?EXAMINE \FALSE
	CALL DWINDOW-DESC >STACK
	RSTACK

	.FUNCT DIAMOND-MOTION,RARG,DC,DIR,RM
	EQUAL? RARG,M-LOOK \?L1
	PRINTI "This is a room with oddly angled walls and passages in all directions. The walls are made of some glassy substance."
	CRLF
	EQUAL? HERE,DIAMOND-5 \?L5
	PRINTI "A marble stairway leads upward."
	ZERO? DIAMOND-SOLVE /?L9
	PRINTI " The floor has swung down at the end of the stairway to reveal a secret passage leading down into unrelieved darkness."
?L9:	CRLF
	RTRUE
?L5:	CALL DWINDOW-DESC
	RTRUE
?L1:	EQUAL? RARG,M-FLASH \?L15
	CALL DWINDOW-DESC
	RTRUE
?L15:	EQUAL? RARG,M-BEG \FALSE
	EQUAL? PRSA,V?WALK \FALSE
	ZERO? DIAMOND-SOLVE \FALSE
	EQUAL? HERE,DIAMOND-2,DIAMOND-4 /?L19
	EQUAL? HERE,DIAMOND-6,DIAMOND-8 \?L17
?L19:	SUB DIAMOND-COUNT,1 >STACK
	GET DIDIRS,STACK >DIR
	EQUAL? PRSO,DIR \?L20
	IGRTR? 'DIAMOND-COUNT,DIAMOND-BASE \?L22
	SET 'DIAMOND-BASE,DIAMOND-COUNT
	SET 'DIAMOND-MOVES,0
?L22:	EQUAL? DIAMOND-COUNT,5 \?L25
	PRINTI "You hear a strange rusty squeal echoing in the distance."
	CRLF
	FCLEAR DIAMOND-5,TOUCHBIT
	CALL SCORE-UPD,5
	SET 'DIAMOND-SOLVE,1
?L25:	EQUAL? HERE,DIAMOND-2 \?L30
	SET 'DIR,DIAMOND-4
	JUMP ?L34
?L30:	EQUAL? HERE,DIAMOND-4 \?L32
	SET 'DIR,DIAMOND-8
	JUMP ?L34
?L32:	EQUAL? HERE,DIAMOND-8 \?L33
	SET 'DIR,DIAMOND-6
	JUMP ?L34
?L33:	EQUAL? HERE,DIAMOND-6 \?L34
	SET 'DIR,DIAMOND-2
?L34:	CALL GOTO,DIR
	RTRUE
?L20:	CALL DIAMOND-LOSS
	RTRUE
?L17:	EQUAL? HERE,DIAMOND-5 \?L37
	EQUAL? PRSO,P?UP /FALSE
?L37:	SET 'DIAMOND-COUNT,0
	RANDOM 100 >STACK
	GRTR? 33,STACK \?L39
	PRINTR "There is no way to go in that direction."
?L39:	RANDOM 100 >STACK
	GRTR? 25,STACK \?L43
	CALL DIAMOND-LOSS
	RTRUE
?L43:	SET 'DIAMOND-COUNT,1
	GRTR? DIAMOND-COUNT,DIAMOND-BASE \?L45
	SET 'DIAMOND-BASE,DIAMOND-COUNT
	SET 'DIAMOND-MOVES,0
?L45:	RANDOM 4 >STACK
	DEC 'STACK
	GET DIAMOND-ROOMS,STACK >RM
	FSET? BAT,INVISIBLE \?L48
	FCLEAR BAT,INVISIBLE
	MOVE BAT,RM
?L48:	CALL GOTO,RM
	RTRUE

	.FUNCT DIAMOND-LOSS
	INC 'DIAMOND-MOVES
	EQUAL? DIAMOND-MOVES,20 \?L1
	PRINTI "As you thrash about in the maze, the mirthful voice of the Wizard taunts you: ""Fool! You'll never get past "
	GET BASES,DIAMOND-BASE >STACK
	PRINT STACK
	PRINTI " base at this rate!"""
	CRLF
?L1:	RANDOM 5 >STACK
	ADD 3,STACK >STACK
	GET DIAMOND-ROOMS,STACK >STACK
	CALL GOTO,STACK >STACK
	RSTACK

	.FUNCT CERBERUS-FCN
	EQUAL? PRSA,V?RAISE,V?RUB,V?WAVE \?L1
	EQUAL? PRSO,WAND \?L1
	PRINTI "The dog looks puzzled."
	CRLF
	RFALSE
?L1:	ZERO? WAND-ON /?L5
	EQUAL? PRSA,V?INCANT,V?SAY /FALSE
?L5:	CALL HELLO?,CERBERUS >STACK
	ZERO? STACK /?L6
	ZERO? CERBERUS-LEASHED /?L7
	PRINTR """Arf! Arf! Arf!"""
?L7:	PRINTR """Grrrr!"""
?L6:	EQUAL? PRSA,V?STAB,V?MUNG,V?ATTACK \?L14
	ZERO? CERBERUS-LEASHED /?L15
	REMOVE CERBERUS
	PRINTI "With a quiet bark of disappointment, the creature expires. Its six eyes look at you reproachfully. As it dies, it collapses into a small pile of dust which blows away into nothing."
	CRLF
	CALL PRINT-ID,STR?166 >STACK
	RSTACK
?L15:	RANDOM 100 >STACK
	GRTR? 50,STACK \?L19
	CALL PRINT-ID,STR?167
	CALL JIGS-UP,STR?168 >STACK
	RSTACK
?L19:	PRINTI "The maddened dog-thing snaps viciously at you."
	CRLF
	CALL PRINT-ID,STR?169 >STACK
	RSTACK
?L14:	EQUAL? PRSA,V?PUT-ON,V?PUT \?L23
	EQUAL? PRSO,COLLAR \?L23
	MOVE COLLAR,CERBERUS
	FSET COLLAR,NDESCBIT
	FSET COLLAR,TRYTAKEBIT
	PUTP CERBERUS,P?LDESC,STR?170
	SET 'CERBERUS-LEASHED,1
	PRINTR "The creature whines happily, then the center head licks your face (which is roughly like experiencing a sandpaper washcloth). The other two heads look about, as though the monster felt a sudden need to find a pair of slippers somewhere. Its huge tail wags enthusiastically, knocking small rocks around and almost blowing you over from the breeze it creates."
?L23:	EQUAL? PRSA,V?ENCHANT \?L26
	EQUAL? SPELL-USED,W?FLOAT \?L27
	SET 'SPELL-HANDLED?,1
	PRINTR "The huge dog rises about an inch off the ground, for a moment."
?L27:	EQUAL? SPELL-USED,W?FIERCE \?L31
	SET 'SPELL-HANDLED?,1
	CALL PRINT-ID,STR?171
	CALL JIGS-UP,STR?172 >STACK
	RSTACK
?L31:	EQUAL? SPELL-USED,W?FEEBLE \FALSE
	PRINTR "What an effect! He now has the strength of just one elephant, rather than ten!"
?L26:	ZERO? CERBERUS-LEASHED \?L43
	PRINTR "The three-headed dog snaps at you viciously!"
?L43:	EQUAL? PRSA,V?RUB \FALSE
	PRINTI "The dog is now insanely happy, slobbering all over the place and whining with uncontained doggish joy."
	CRLF
	CALL PRINT-ID,STR?173 >STACK
	RSTACK

	.FUNCT COLLAR-FCN
	EQUAL? PRSA,V?TAKE \?L1
	ZERO? CERBERUS-LEASHED /?L1
	CALL PRINT-ID,STR?174
	CALL JIGS-UP,STR?175 >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?ENCHANT \FALSE
	EQUAL? SPELL-USED,W?FLOAT \FALSE
	CALL PERFORM,V?ENCHANT,CERBERUS
	RTRUE

	.FUNCT GLACIER-FCN
	EQUAL? PRSA,V?MELT \FALSE
	PRINTI "This is a big glacier; you'll need a lot of heat."
	CRLF
	CALL PRINT-ID,STR?176 >STACK
	RSTACK

	.FUNCT GLACIER-ROOM-FCN,RARG
	EQUAL? RARG,M-LOOK \FALSE
	PRINTI "This is a large hall of ancient lava, since worn smooth by the movement of a glacier. A large passage exits to the east and an upward lava tube is at the top of a jumble of fallen rocks."
	CRLF
	ZERO? ICE-MELTED /TRUE
	PRINTR "A damp and scorched passage leads west. It is still partly full of steam."

	.FUNCT DRAGON-FCN
	CALL QUEUE,I-DRAGON,-1 >STACK
	PUT STACK,0,1
	CALL HELLO?,DRAGON >STACK
	ZERO? STACK /?L1
	PRINTI "The dragon looks amused. He speaks in a voice so deep you feel it rather than hear it, but the tongue is unknown to you. You find yourself almost hypnotized."
	CRLF
	ADD DRAGON-ANGER,2 >DRAGON-ANGER
	RETURN DRAGON-ANGER
?L1:	EQUAL? PRSA,V?EXAMINE \?L5
	PRINTI "He turns and looks back at you, his cat's eyes yellow in the gloom. You start to feel weak, and quickly turn away."
	CRLF
	INC 'DRAGON-ANGER
	RETURN DRAGON-ANGER
?L5:	EQUAL? PRSA,V?KICK,V?MUNG,V?ATTACK /?L9
	EQUAL? PRSA,V?LAMP-ON \?L8
?L9:	EQUAL? PRSA,V?LAMP-ON /?L12
	EQUAL? PRSA,V?ATTACK \?L10
	ZERO? PRSI \?L10
?L12:	PRINTI "With your bare hands? I doubt the dragon even noticed."
	CRLF
	CALL PRINT-ID,STR?177
	JUMP ?L15
?L10:	CALL RANDOM-ELEMENT,DRAGON-ATTACKS >STACK
	PRINT STACK
	CRLF
	CALL PRINT-ID,STR?178
?L15:	ADD DRAGON-ANGER,4 >DRAGON-ANGER
	RETURN DRAGON-ANGER
?L8:	EQUAL? PRSA,V?GIVE \?L18
	EQUAL? PRSI,DRAGON \?L18
	INC 'DRAGON-ANGER
	GETPT PRSO,P?VALUE >STACK
	ZERO? STACK /?L19
	MOVE PRSO,CHEST
	PRINTR "The dragon is pleased by your gift, excuses himself for a moment, and returns without it."
?L19:	CALL BOMB?,PRSO >STACK
	ZERO? STACK /?L23
	ADD DRAGON-ANGER,2 >DRAGON-ANGER
	REMOVE BRICK
	PRINTI "The dragon snakes his long red tongue around the bomb and politely swallows it. A few moments later he belches and smoke curls out of his nostrils."
	CRLF
	CALL PRINT-ID,STR?179 >STACK
	RSTACK
?L23:	PRINTR "The dragon refuses your gift."
?L18:	EQUAL? PRSA,V?WALK \FALSE
	EQUAL? HERE,DRAGON-ROOM \FALSE
	EQUAL? PRSO,P?NORTH \FALSE
	ADD DRAGON-ANGER,3 >DRAGON-ANGER
	PRINTR "The dragon puts out a claw, grins (all of his sword-sharp teeth glinting in the light), and blocks your way."

	.FUNCT HELLO?,WHO
	EQUAL? WINNER,WHO /?L4
	EQUAL? PRSA,V?REPLY,V?ANSWER,V?TELL /?L4
	EQUAL? PRSA,V?INCANT,V?HELLO,V?SAY \FALSE
?L4:	EQUAL? PRSA,V?SAY,V?ANSWER,V?TELL /?L7
	EQUAL? PRSA,V?REPLY,V?INCANT \TRUE
?L7:	SET 'P-CONT,0
	SET 'QUOTE-FLAG,0
	RTRUE

	.FUNCT FIND-TARGET,TARGET,P,TX,L,ROOM
	IN? TARGET,HERE \?L1
	RETURN HERE
?L1:	SET 'P,0
?L4:	NEXTP HERE,P >P
	ZERO? P /FALSE
	LESS? P,P?CROSS /?L4
	GETPT HERE,P >TX
	PTSIZE TX >L
	EQUAL? L,UEXIT,CEXIT,DEXIT \?L4
	GETB TX,0 >ROOM
	IN? TARGET,ROOM \?L4
	RETURN ROOM

	.FUNCT I-DRAGON,ROOM
	GRTR? DRAGON-ANGER,6 \?L1
	PRINTI "The dragon tires of this game. With an almost bored yawn, he opens his mouth and "
	EQUAL? SPELL?,S-FIREPROOF \?L5
	PRINTI "blasts you with a great gout of fire, but it washes over you harmlessly."
	CRLF
	JUMP ?L59
?L5:	CALL DRAGON-LEAVES
	CALL PRINT-ID,STR?180
	CALL JIGS-UP,STR?181
	JUMP ?L59
?L1:	IN? WINNER,DRAGON-ROOM \?L10
	IN? DRAGON,DRAGON-ROOM /?L10
	MOVE DRAGON,DRAGON-ROOM
	PRINTI "The dragon doubles back and charges into the room, maddened by your attempt to sneak past him. His eyes glow with a white heat of anger."
	CRLF
	EQUAL? SPELL?,S-FIREPROOF \?L13
	CALL JIGS-UP,STR?182
	JUMP ?L59
?L13:	CALL PRINT-ID,STR?183
	CALL JIGS-UP,STR?184
	JUMP ?L59
?L10:	GRTR? DRAGON-ANGER,0 /?L16
	RANDOM 100 >STACK
	GRTR? 50,STACK \?L17
	IN? DRAGON,HERE \?L17
	PRINTI "The dragon looks bored."
	CRLF
	JUMP ?L59
?L17:	CALL DRAGON-LEAVES
	EQUAL? HERE,GLACIER-ROOM \?L22
	PRINTI "The dragon is no longer around. He must have become bored with you."
	CRLF
	JUMP ?L59
?L22:	EQUAL? HERE,OLD-HERE \?L59
	PRINTI "The dragon seems to have lost interest in you."
	EQUAL? OLD-HERE,DRAGON-ROOM \?L29
	CRLF
	JUMP ?L59
?L29:	PRINTI " He wanders off."
	CRLF
	JUMP ?L59
?L16:	CALL FIND-TARGET,WINNER >ROOM
	ZERO? ROOM \?L36
	RANDOM 100 >STACK
	GRTR? 25,STACK \?L59
	CALL DRAGON-LEAVES
	JUMP ?L59
?L36:	EQUAL? ROOM,CAROUSEL-ROOM,TINY-ROOM /?L42
	EQUAL? ROOM,RAVINE-LEDGE,FRESCO-ROOM \?L41
?L42:	RANDOM 100 >STACK
	GRTR? 25,STACK \?L43
	CALL DRAGON-LEAVES
?L43:	PRINTI "The dragon will follow no further."
	CRLF
	JUMP ?L59
?L41:	EQUAL? ROOM,GLACIER-ROOM \?L48
	CRLF
	PRINTI "As the dragon enters, he sees his reflection on the icy surface of the glacier at its western end. He becomes enraged: There is another dragon here, behind that glass, he thinks! Dragons are smart, but sometimes naive, and this one has never seen ice before. He rears up to his full height to challenge this intruder into his territory. He roars a challenge! The intruder responds! The dragon takes a deep breath, and out of his mouth pours a massive gout of flame. It washes over the ice, which melts rapidly, sending out torrents of water and a huge cloud of steam! You manage to clamber up to a small shelf, but the dragon is terrified! A huge splash goes down his throat! There is a muffled explosion and the dragon, a puzzled expression on his face, dies. He is carried away by the water.

When the flood recedes you climb gingerly down. While no trace of the dragon can be found, the melting of the ice has revealed a passage leading west."
	CRLF
	CALL PRINT-ID,STR?185
	REMOVE DRAGON
	REMOVE ICE
	MOVE DEAD-DRAGON,DEEP-FORD
	CALL INT,I-DRAGON >STACK
	PUT STACK,0,0
	CALL SCORE-UPD,5
	SET 'ICE-MELTED,1
	JUMP ?L59
?L48:	EQUAL? ROOM,OLD-HERE /?L52
	MOVE DRAGON,ROOM
	PRINTI "The dragon follows you, out of mingled curiosity and anger."
	CRLF
	JUMP ?L56
?L52:	PRINTI "The dragon continues to watch you carefully."
	CRLF
?L56:	GRTR? DRAGON-ANGER,0 /?L59
	SET 'DRAGON-ANGER,0
	CALL INT,I-DRAGON >STACK
	PUT STACK,0,0
?L59:	LOC DRAGON >OLD-HERE
	SUB DRAGON-ANGER,2 >DRAGON-ANGER
	LESS? DRAGON-ANGER,0 \TRUE
	SET 'DRAGON-ANGER,0
	RTRUE

	.FUNCT DRAGON-LEAVES
	LOC DEAD-DRAGON >STACK
	ZERO? STACK \FALSE
	MOVE DRAGON,DRAGON-ROOM
	SET 'DRAGON-ANGER,0
	CALL INT,I-DRAGON >STACK
	PUT STACK,0,0
	RTRUE

	.FUNCT I-GARDEN
	EQUAL? HERE,GARDEN-NORTH,GAZEBO-ROOM /?L3
	EQUAL? HERE,TOPIARY-ROOM,FORMAL-GARDEN \?L1
?L3:	IN? UNICORN,GARDEN-NORTH \?L4
	RANDOM 100 >STACK
	GRTR? 33,STACK \?L4
	REMOVE UNICORN
	EQUAL? HERE,TOPIARY-ROOM /FALSE
	PRINTR "The unicorn bounds lightly away."
?L4:	IN? PRINCESS,DRAGON-LAIR \?L11
	IN? UNICORN,GARDEN-NORTH /?L11
	RANDOM 100 >STACK
	GRTR? 25,STACK \?L11
	EQUAL? HERE,TOPIARY-ROOM /?L34
	ZERO? UNICORN-FRIGHTENED /?L12
	SET 'UNICORN-FRIGHTENED,0
	RFALSE
?L12:	MOVE UNICORN,GARDEN-NORTH
	EQUAL? HERE,GARDEN-NORTH \?L15
	CALL RANDOM-ELEMENT,UNICORN-MSGS >STACK
	PRINT STACK
	CRLF
	RTRUE
?L15:	PRINTR "A unicorn is peacefully cropping grass at the north end of the garden. There is something hanging around its neck."
?L11:	EQUAL? HERE,TOPIARY-ROOM \FALSE
?L34:	ZERO? TOPIARY-MOVED \?L35
	RANDOM 100 >STACK
	GRTR? 12,STACK \?L23
	SET 'TOPIARY-MOVED,1
	PRINTR "You look around, and strangely, the topiary animals seem to have changed position slightly."
?L23:	ZERO? TOPIARY-MOVED /?L27
?L35:	ZERO? TOPIARY-NEAR \?L36
	RANDOM 100 >STACK
	GRTR? 8,STACK \?L27
	SET 'TOPIARY-NEAR,1
	PRINTR "The topiary animals seem to close in on you. You turn and they are very close. They seem to be leering at you."
?L27:	ZERO? TOPIARY-NEAR /FALSE
?L36:	RANDOM 100 >STACK
	GRTR? 4,STACK \FALSE
	SET 'TOPIARY-MOVED,0
	SET 'TOPIARY-NEAR,0
	CALL PRINT-ID,STR?186
	CALL JIGS-UP,STR?187 >STACK
	RSTACK
?L1:	REMOVE UNICORN
	CALL INT,I-GARDEN >STACK
	PUT STACK,0,0
	RFALSE

	.FUNCT GARDEN-ROOM-FCN,RARG
	EQUAL? RARG,M-ENTER \FALSE
	CALL QUEUE,I-GARDEN,-1 >STACK
	PUT STACK,0,1
	RTRUE

	.FUNCT GLOBAL-UNICORN-FCN
	IN? UNICORN,GARDEN-NORTH \?L1
	PRINTR "The unicorn is way up at the north end of the garden."
?L1:	EQUAL? PRSA,V?FOLLOW,V?FIND \?L5
	FSET? UNICORN,TOUCHBIT \?L6
	PRINTR "I don't know where it is now."
?L6:	PRINTR "The unicorn is a mythical beast."
?L5:	PRINTR "Unicorn? What unicorn?"

	.FUNCT UNICORN-FCN
	CALL HELLO?,UNICORN >STACK
	ZERO? STACK /?L1
	PRINTR "The unicorn listens distractedly, then goes back to cropping grass."
?L1:	EQUAL? PRSA,V?FOLLOW \?L5
	PRINTR "The unicorn shies away as you approach."
?L5:	EQUAL? PRSA,V?EXAMINE \?L11
	EQUAL? PRSO,UNICORN \?L8
	PRINTR "The unicorn shies away as you approach for a closer look, but you do notice a tiny gold key hanging from a red satin ribbon looped around the animal's neck."
?L8:	EQUAL? PRSA,V?EXAMINE \?L11
	PRINTR "The unicorn shies away as you approach."
?L11:	EQUAL? PRSA,V?RUB,V?PUT,V?TAKE /?L15
	EQUAL? PRSA,V?ATTACK,V?MUNG \FALSE
?L15:	REMOVE UNICORN
	SET 'UNICORN-FRIGHTENED,1
	PRINTI "The unicorn, unsurprised by this evidence that you are indeed the uncouth sort of vagabond it suspected you were, melts into the hedges and is gone."
	CRLF
	CALL PRINT-ID,STR?188 >STACK
	RSTACK

	.FUNCT GAZEBO-FCN
	EQUAL? HERE,GARDEN-NORTH \?L1
	EQUAL? PRSA,V?THROUGH \?L1
	CALL DO-WALK,P?IN
	RTRUE
?L1:	EQUAL? HERE,GAZEBO-ROOM \FALSE
	EQUAL? PRSA,V?THROUGH \?L3
	PRINTR "You're already in it."
?L3:	EQUAL? HERE,GAZEBO-ROOM \FALSE
	EQUAL? PRSA,V?EXIT,V?LEAVE \FALSE
	CALL DO-WALK,P?OUT
	RTRUE

	.FUNCT CHEST-FCN
	EQUAL? PRSA,V?OPEN \FALSE
	RANDOM 100 >STACK
	GRTR? 25,STACK \?L3
	CALL V-OPEN
	IN? PRINCESS,HERE \?L10
	ZERO? PRINCESS-AWAKE \?L10
	PRINTI "The opening of the squeaky lid startles the young woman."
	CRLF
	JUMP ?L10
?L3:	PRINTI "The hinges are very rusty, but they seem to be starting to give. You can probably open it if you try again. There is something bumping around inside."
	IN? PRINCESS,HERE \?L13
	ZERO? PRINCESS-AWAKE \?L13
	PRINTI " All this rummaging around has startled the young woman."
?L13:	CRLF
?L10:	PUTP CHEST,P?ACTION,0
	IN? PRINCESS,HERE \TRUE
	ZERO? PRINCESS-AWAKE \TRUE
	CALL PERFORM,V?ALARM,PRINCESS
	RTRUE

	.FUNCT PRINCESS-FCN,DEM
	CALL INT,I-PRINCESS >DEM
	EQUAL? PRSA,V?FOLLOW \?L1
	IN? PRINCESS,HERE \?L3
	PRINTR "You can't follow her until she leaves..."
?L3:	ZERO? PRFOLLOW /?L7
	CALL DO-WALK,PRFOLLOW
	RTRUE
?L7:	PRINTR "I seem to have lost track of her."
?L1:	IN? PRINCESS,HERE /?L11
	PRINTR "There is no princess here."
?L11:	EQUAL? PRSA,V?RAPE,V?MUNG,V?ATTACK \?L14
	REMOVE PRINCESS
	PRINTI "The princess screams as you approach. ""Won't someone deliver me from this awful fate?"" she cries. "
	CALL PRINT-ID,STR?189
	IN? WIZARD,HERE \?L17
	PRINTI "Shocked, the Wizard of Frobozz turns toward you."
	JUMP ?L21
?L17:	PRINTI "Just in time, the Wizard of Frobozz appears, seeming to unroll himself out of nothing like a window shade."
?L21:	PRINTI " ""Fry!"" he intones, and a massive bolt of lightning reduces you to a pile of smoking ashes. (Serves you right, too, if you ask me.)"
	CALL JIGS-UP >STACK
	RSTACK
?L14:	CALL HELLO?,PRINCESS >STACK
	ZERO? STACK \?L28
	EQUAL? PRSA,V?EXAMINE,V?KISS,V?ALARM /?L28
	EQUAL? PRSA,V?RUB \?L26
?L28:	IN? PRINCESS,DRAGON-LAIR \?L29
	GET DEM,C-ENABLED? >STACK
	ZERO? STACK \?L29
	PUTP PRINCESS,P?LDESC,STR?190
	CALL QUEUE,I-PRINCESS,2 >STACK
	PUT STACK,0,1
	SET 'PRINCESS-AWAKE,1
	PRINTI "The princess (for she is obviously one) shakes herself awake, then notices you for the first time. She smiles. ""Thank you for rescuing me from that horrid worm,"" she says. ""I must depart. My parents will be worried about me."" With that, she arises, looking purposefully out of the lair."
	CRLF
	EQUAL? PRSA,V?RUB,V?KISS /?L33
	PUSH 0
	JUMP ?L34
?L33:	PUSH 1
?L34:	CALL PRINT-ID,STR?191,STACK
	EQUAL? PRSA,V?ALARM /?L35
	PUSH 0
	JUMP ?L36
?L35:	PUSH 1
?L36:	CALL PRINT-ID,STR?192,STACK >STACK
	RSTACK
?L29:	PRINTI "The princess ignores you. She looks about the room, but her eyes fix on the "
	CALL PRINT-ID,STR?193
	CALL PRINT-ID,STR?194
	EQUAL? HERE,GAZEBO-ROOM \?L40
	PRINTI "garden outside"
	JUMP ?L50
?L40:	EQUAL? HERE,GARDEN-NORTH \?L44
	PRINTI "gazebo"
	JUMP ?L50
?L44:	EQUAL? HERE,RAVINE-LEDGE \?L47
	PRINTI "ledge"
	JUMP ?L50
?L47:	MUL PRCOUNT,4 >STACK
	GET PRDIRS,STACK >STACK
	PRINT STACK
?L50:	PRINTR "."
?L26:	ZERO? PRINCESS-AWAKE \FALSE
	PRINTR "She's in a trance!"

	.FUNCT I-PRINCESS,DEM,OLDP,PC
	CALL INT,I-PRINCESS >DEM
	LOC PRINCESS >OLDP
	MUL PRCOUNT,4 >PC
	ADD PC,1 >STACK
	GET PRDIRS,STACK >STACK
	MOVE PRINCESS,STACK
	SET 'PRFOLLOW,0
	IN? PRINCESS,STREAM-PATH \?L8
	IN? WINNER,MARBLE-HALL \?L1
	PRINTI "The princess presses a loose piece of marble in the wall and a large section of the wall slides away, revealing a passage to the east. She enters it."
	CRLF
	IN? WINNER,OLDP \?L5
	ADD PC,3 >STACK
	GET PRDIRS,STACK >PRFOLLOW
?L5:	SET 'SECRET-DOOR,1
	JUMP ?L41
?L1:	IN? PRINCESS,STREAM-PATH \?L8
	IN? WINNER,STREAM-PATH \?L8
	SET 'SECRET-DOOR,1
	PRINTI "The princess appears from behind some rocks, as though she had walked through a wall."
	CRLF
	JUMP ?L41
?L8:	IN? WINNER,OLDP \?L11
	ADD PC,3 >STACK
	GET PRDIRS,STACK >PRFOLLOW
	EQUAL? OLDP,GARDEN-NORTH \?L12
	PRINTI "The princess enters the gazebo"
	FSET? GAZEBO-ROOM,RMUNGBIT \?L16
	PRINTI ", although you would never get past the debris. She must be magically protected."
?L16:	PRINTI "."
	CRLF
	JUMP ?L41
?L12:	EQUAL? OLDP,RAVINE-LEDGE \?L23
	PRINTI "The princess climbs daintily down the rock face."
	CRLF
	JUMP ?L41
?L23:	PRINTI "The princess walks "
	GET PRDIRS,PC >STACK
	PRINT STACK
	PRINTI ". She glances back at you as she goes."
	CRLF
	JUMP ?L41
?L11:	IN? PRINCESS,HERE \?L41
	EQUAL? HERE,GAZEBO-ROOM \?L34
	PRINTI "The princess joins you in the gazebo."
	CRLF
	JUMP ?L41
?L34:	EQUAL? HERE,DEEP-FORD \?L38
	PRINTI "The princess climbs down the rock wall onto the beach."
	CRLF
	JUMP ?L41
?L38:	PRINTI "The princess enters from the "
	ADD 2,PC >STACK
	GET PRDIRS,STACK >STACK
	PRINT STACK
	PRINTI ". She seems surprised to see you."
	CRLF
?L41:	IN? PRINCESS,GAZEBO-ROOM \?L49
	PUT DEM,0,0
	CALL QUEUE,I-UNICORN,6 >STACK
	PUT STACK,0,1
	RTRUE
?L49:	INC 'PRCOUNT
	RANDOM 100 >STACK
	GRTR? 75,STACK \?L52
	PUSH 1
	JUMP ?L54
?L52:	PUSH 2
?L54:	CALL QUEUE,I-PRINCESS,STACK >STACK
	PUT STACK,0,1
	RTRUE

	.FUNCT I-UNICORN
	EQUAL? HERE,GAZEBO-ROOM,GARDEN-NORTH \?L1
	MOVE ROSE,WINNER
	FCLEAR GOLD-KEY,NDESCBIT
	MOVE GOLD-KEY,WINNER
	CALL SCORE-OBJ,GOLD-KEY
	PUTP GOLD-KEY,P?ACTION,0
	PRINTI "Shyly, a unicorn peeks out of the hedges. It notices the princess and seems captivated. It approaches her and bows its head as though curtseying to her. Around its neck is a red satin ribbon on which is strung a delicate gold key. The princess takes the ribbon and uses it to tie up her hair. She looks at you and then, smiling, hands you the key and a fresh rose which she plucks from the arbor. ""You may have use of such a thing,"" she says. ""It is the least I can do for one who rescued me from a fate I dare not contemplate."" With that, she mounts the unicorn (side-saddle, of course) and rides off into the gloom."
	CRLF
	REMOVE PRINCESS
	RTRUE
?L1:	REMOVE PRINCESS
	MOVE ROSE,GAZEBO-ROOM
	RFALSE

	.FUNCT MENHIR-ROOM-FCN,RARG
	EQUAL? RARG,M-FLASH \?L1
	ZERO? MENHIR-POSITION /?L1
	CALL DESCRIBE-MENHIR >STACK
	RSTACK
?L1:	EQUAL? RARG,M-LOOK \FALSE
	PRINTI "This is a large room which was evidently used once as a quarry. Many large limestone chunks lie helter-skelter around the room. Some are rough-hewn and unworked, others smooth and well-finished. One side of the room appears to have been used to quarry building blocks, the other to produce menhirs (standing stones). Obvious passages lead north and south."
	CRLF
	IN? MENHIR,LOCAL-GLOBALS \TRUE
	CALL DESCRIBE-MENHIR
	RTRUE

	.FUNCT DESCRIBE-MENHIR
	EQUAL? HERE,MENHIR-ROOM \?L1
	ZERO? MENHIR-POSITION \?L3
	PRINTI "One particularly large menhir, at least twenty feet tall and eight feet thick, is leaning against the wall blocking a dark opening leading southwest. On this side of the menhir is carved an ornate letter ""F""."
	CRLF
	JUMP ?L16
?L3:	EQUAL? MENHIR-POSITION,1 \?L7
	PRINTI "There is a huge menhir lying on the floor near a southwest passage."
	CRLF
	JUMP ?L16
?L7:	EQUAL? MENHIR-POSITION,2 \?L10
	PRINTI "A dark opening leads southwest."
	CRLF
	JUMP ?L16
?L10:	EQUAL? MENHIR-POSITION,3 \?L13
	PRINTI "There is a huge menhir here."
	CRLF
	JUMP ?L16
?L13:	PRINTI "There is a huge menhir floating like a feather in midair here. A passage to the southwest opens beneath it."
	CRLF
?L16:	EQUAL? HERE,MUNGED-ROOM \TRUE
	PRINTR "The explosion appears to have had no effect on the menhir."
?L1:	PRINTR "A dark opening leads southwest."

	.FUNCT MENHIR-FCN
	EQUAL? PRSA,V?LOOK-BEHIND,V?LOOK-UNDER \?L1
	ZERO? MENHIR-POSITION /?L3
	PRINTR "Behind the menhir is some air and then a wall."
?L3:	PRINTR "The gap between the menhir and the wall is very narrow, but it is clear that there is a sizeable room in there. Your light only reveals a part of the far wall."
?L1:	EQUAL? PRSA,V?TURN,V?MOVE,V?TAKE \?L10
	PRINTR "The menhir weighs many tons and is eight feet wide. You can't even get a grip on it, much less move it."
?L10:	EQUAL? PRSA,V?READ \?L13
	PRINTR """F"""
?L13:	EQUAL? PRSA,V?EXAMINE \?L16
	PRINTR "It is nicely finished, and the letter ""F"" on it is particularly well carved."
?L16:	EQUAL? PRSA,V?ENCHANT \?L19
	EQUAL? SPELL-USED,W?FLOAT \?L19
	PRINTI "The menhir floats majestically into the air, rising about ten feet. The passage beneath it beckons invitingly."
	CRLF
	SET 'MENHIR-POSITION,3
	RETURN MENHIR-POSITION
?L19:	EQUAL? PRSA,V?DISENCHANT \FALSE
	EQUAL? SPELL-USED,W?FLOAT \FALSE
	SET 'MENHIR-POSITION,0
	EQUAL? HERE,MENHIR-ROOM,KENNEL \FALSE
	PRINTR "The menhir sinks to the ground."

	.FUNCT DOOR-KEEPER-FCN
	EQUAL? PRSA,V?ALARM \?L1
	ZERO? GUARDIAN-FED /?L1
	PRINTR "Try as you may, you can't wake it."
?L1:	EQUAL? PRSA,V?GIVE \?L5
	EQUAL? PRSI,DOOR-KEEPER \?L5
	ZERO? GUARDIAN-FED /?L6
	PRINTR "He is asleep, at least for the moment."
?L6:	EQUAL? PRSO,CANDY \?L10
	SET 'GUARDIAN-FED,1
	REMOVE CANDY
	PRINTR "The guardian greedily wolfs down the candy, including the package. (It seemed to enjoy the grasshoppers particularly.) It then becomes quiet and its eyes close. (Lizards are known to sleep a long time while digesting their meals.)"
?L10:	EQUAL? PRSO,FLASK \?L13
	PRINTI "The lizard sniffs it experimentally, then looks at you angrily, hissing and snapping."
	CRLF
	CALL PRINT-ID,STR?195 >STACK
	RSTACK
?L13:	CALL BOMB?,PRSO >STACK
	ZERO? STACK /?L16
	REMOVE PRSO
	PRINTI "The guardian greedily wolfs it down. After a while, you hear a very small pop and the guardian's eyes bulge out. It hisses nastily at you."
	CRLF
	CALL PRINT-ID,STR?196 >STACK
	RSTACK
?L16:	EQUAL? PRSO,PALANTIR-1,PALANTIR-2,PALANTIR-3 \?L19
	PRINTI "The guardian greedily gobbles the sphere, but finds it unchewable. He then tries repeatedly to swallow it whole, with disappointing results. Finally, he spits it on the ground."
	CRLF
	MOVE PRSO,HERE
	RTRUE
?L19:	REMOVE PRSO
	PRINTI "The lizard wolfs down the "
	PRINTD PRSO
	PRINTR ", crunching greedily."
?L5:	EQUAL? PRSA,V?MUNG,V?ATTACK \FALSE
	PRINTI "The guardian seems impervious to your attack. In fact, your blows don't even seem to be landing."
	CRLF
	CALL PRINT-ID,STR?197 >STACK
	RSTACK

	.FUNCT WIZ-DOOR-FCN
	ZERO? GUARDIAN-FED \?L1
	EQUAL? PRSA,V?OPEN \?L3
	PRINTR "The lizard comes to life and snaps at you as you reach for the handle."
?L3:	EQUAL? PRSA,V?UNLOCK \FALSE
	PRINTI "The lizard door keeper comes awake and bites at your hand. You jerk away just in time."
	EQUAL? PRSI,GOLD-KEY \?L10
	RANDOM 100 >STACK
	GRTR? 5,STACK \?L10
	REMOVE GOLD-KEY
	PRINTR " The guardian does get the key, though. It grins maniacally."
?L10:	RANDOM 100 >STACK
	GRTR? 20,STACK \?L14
	MOVE GOLD-KEY,HERE
	PRINTR " You drop the key, though."
?L14:	CRLF
	RTRUE
?L1:	EQUAL? PRSA,V?UNLOCK \?L19
	ZERO? WIZ-DOOR-FLAG /?L20
	PRINTR "It is already!"
?L20:	EQUAL? PRSI,GOLD-KEY \?L24
	SET 'WIZ-DOOR-FLAG,1
	PRINTR "The key turns and the bolt clicks. The door is unlocked."
?L24:	SET 'WIZ-DOOR-FLAG,0
	PRINTR "That won't unlock it."
?L19:	EQUAL? PRSA,V?LOCK \?L30
	ZERO? WIZ-DOOR-FLAG \?L31
	PRINTR "It is locked already."
?L31:	EQUAL? PRSI,GOLD-KEY \?L35
	PRINTI "The door is now locked."
	CRLF
	SET 'WIZ-DOOR-FLAG,0
	RTRUE
?L35:	PRINTR "That won't lock it."
?L30:	EQUAL? PRSA,V?CLOSE,V?OPEN \FALSE
	ZERO? WIZ-DOOR-FLAG /?L42
	CALL OPEN-CLOSE,PRSO,STR?199,STR?198 >STACK
	RSTACK
?L42:	EQUAL? PRSA,V?OPEN \FALSE
	PRINTR "The door is locked!"

	.FUNCT GUARDIAN-ROOM-FCN,RARG
	EQUAL? RARG,M-LOOK \FALSE
	PRINTI "This room is cobwebby and musty, but tracks in the dust show that it has seen visitors recently. At the south end of the room is a stained and battered (but very strong-looking) door. To the north, a corridor exits."
	CRLF
	FSET? WIZ-DOOR,OPENBIT \?L5
	PRINTI "The door is open."
	CRLF
?L5:	ZERO? GUARDIAN-FED \?L10
	PRINTI "Imbedded in the door is a nasty-looking lizard head, with sharp teeth and beady eyes. "
	IN? CANDY,WINNER \?L14
	PRINTR "The lizard is sniffing at you."
?L14:	PRINTR "The eyes move to watch you approach."
?L10:	PRINTR "A sleepy-looking lizard head is mounted on the door."

	.FUNCT WORKSHOP-FCN,RARG
	EQUAL? RARG,M-LOOK \FALSE
	PRINTI "You are standing in the entry hall of the Wizard's Workshop. Dark corridors lead west and south from here. The corridor to the west smells slightly of incense or candle smoke."
	FSET? WIZ-DOOR,OPENBIT \?L5
	PRINTI " The workshop door is open."
?L5:	CRLF
	RTRUE

	.FUNCT ARCANA-PSEUDO
	EQUAL? PRSA,V?TAKE \FALSE
	PRINTI "The stuff on the bench appears to be so much junk, and you decide that it would only get in your way if you took it."
	CRLF
	CALL PRINT-ID,STR?200 >STACK
	RSTACK

	.FUNCT TROPHY-PSEUDO
	EQUAL? PRSA,V?READ /FALSE
	EQUAL? PRSA,V?RUB,V?TAKE \FALSE
	PRINTI "As your fingers near it, you get a nasty shock (but fortunately not a fatal one)."
	CRLF
	EQUAL? PRSA,V?TAKE /?L6
	PUSH 0
	JUMP ?L7
?L6:	PUSH 1
?L7:	CALL PRINT-ID,STR?201,STACK
	EQUAL? PRSA,V?RUB /?L8
	PUSH 0
	JUMP ?L9
?L8:	PUSH 1
?L9:	CALL PRINT-ID,STR?202,STACK >STACK
	RSTACK

	.FUNCT STAND-FCN
	EQUAL? PRSA,V?TAKE \?L1
	PRINTI "The "
	PRINTD PRSO
	PRINTI " is firmly attached to the bench."
	CRLF
	CALL PRINT-ID,STR?203 >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?PUT-ON,V?PUT \FALSE
	EQUAL? PRSO,PALANTIR-1,PALANTIR-2,PALANTIR-3 \FALSE
	EQUAL? PRSI,STAND-1,STAND-2,STAND-3 \FALSE
	CALL V-PUT
	IN? PALANTIR-1,STAND-1 \TRUE
	IN? PALANTIR-2,STAND-2 \TRUE
	IN? PALANTIR-3,STAND-3 \TRUE
	REMOVE PALANTIR-1
	REMOVE PALANTIR-2
	REMOVE PALANTIR-3
	MOVE STAND-4,WORKBENCH
	PRINTI "As you place the "
	PRINTD PRSO
	PRINTI " in the "
	PRINTD PRSI
	PRINTR ", a low humming noise begins, and you can feel the hairs on the back of your neck begin to stand up. The three spheres begin to vibrate, faster and faster, as the noise becomes higher and higher pitched. Three puffs of smoke, one red, one blue, one white, rise up from empty stands. The spheres are gone! But in the center of the triangle formed by the stands is now a black stand of obsidian in which rests a strange black sphere."

	.FUNCT IN-AQUARIUM-FCN,RARG
	EQUAL? RARG,M-LOOK \?L1
	PRINTI "There is a sandy floor here, and your vision seems murky and blurred. The wall you are looking at is nicely dressed stone."
	CRLF
	IN? SERPENT,AQUARIUM \TRUE
	RANDOM 100 >STACK
	GRTR? 25,STACK \?L7
	PRINTR "While you watch a shadow seems to pass overhead."
?L7:	RANDOM 100 >STACK
	GRTR? 5,STACK \TRUE
	PRINTR "The head of some horrible serpent pokes into view, its beady green eyes almost seeming to see you."
?L1:	EQUAL? RARG,M-ENTER \FALSE
	IN? SERPENT,AQUARIUM \?L17
	CALL PRINT-ID,STR?204
	CALL JIGS-UP,STR?205 >STACK
	RSTACK
?L17:	CALL PRINT-ID,STR?206
	CALL JIGS-UP,STR?207 >STACK
	RSTACK

	.FUNCT AQUARIUM-FCN,OBJ
	EQUAL? PRSA,V?THROUGH,V?BOARD \?L1
	CALL DO-WALK,P?IN
	RTRUE
?L1:	EQUAL? PRSA,V?LOOK-INSIDE \?L3
	IN? SERPENT,AQUARIUM \?L3
	PRINTR "In the aquarium is a baby sea-serpent who eyes you suspiciously. His scaly body writhes about in the huge tank."
?L3:	EQUAL? PRSA,V?ATTACK,V?MUNG \?L8
	EQUAL? PRSO,AQUARIUM /?L36
?L8:	EQUAL? PRSA,V?THROW \FALSE
	EQUAL? PRSI,AQUARIUM \FALSE
	EQUAL? PRSO,AQUARIUM \?L9
?L36:	ZERO? PRSI /FALSE
	SET 'OBJ,PRSI
	JUMP ?L14
?L9:	SET 'OBJ,PRSO
?L14:	MOVE OBJ,HERE
	IN? DEAD-SERPENT,HERE \?L15
	PRINTR "The aquarium is already broken!"
?L15:	EQUAL? OBJ,FLASK \?L19
	CALL PRINT-ID,STR?208
	CALL JIGS-UP,STR?209
	RTRUE
?L19:	CALL BOMB?,OBJ >STACK
	ZERO? STACK /?L20
	CALL INT,I-FUSE >STACK
	PUT STACK,0,0
	RTRUE
?L20:	FSET? OBJ,WEAPONBIT /?L22
	GETP OBJ,P?SIZE >STACK
	GRTR? STACK,10 \?L21
?L22:	REMOVE SERPENT
	MOVE PALANTIR-3,AQUARIUM
	FCLEAR PALANTIR-3,NDESCBIT
	PUTP AQUARIUM,P?LDESC,STR?210
	MOVE DEAD-SERPENT,HERE
	PRINTI "The "
	PRINTD OBJ
	PRINTI " shatters the glass wall of the aquarium, spilling out an impressive amount of salt water and wet sand. It also spills out an extremely annoyed sea serpent who bites angrily at the "
	PRINTD OBJ
	PRINTI ", and then at you. He is having difficulty breathing, and he seems to hold you responsible for his current problem."
	CALL PRINT-ID,STR?211
	EQUAL? PRSA,V?MUNG \?L25
	PRINTI " He manages to rend you limb from limb before he drowns in the air."
	CRLF
	CALL PRINT-ID,STR?212
	CALL JIGS-UP,STR?213 >STACK
	RSTACK
?L25:	PRINTR " He tries to slither across the stone floor towards you. Fortunately, he expires mere inches away from biting off your foot. A clear crystal sphere sits amid the sand and broken glass on the bottom of the aquarium."
?L21:	PRINTI "The "
	PRINTD OBJ
	PRINTR " bounces harmlessly off the glass."

	.FUNCT SERPENT-FCN
	EQUAL? SERPENT,WINNER \?L1
	PRINTR "The serpent only stares hungrily at you."
?L1:	EQUAL? PRSA,V?MUNG,V?ATTACK \?L5
	PRINTI "He swims towards you with a powerful stroke of his flippers, dagger-like teeth dripping. Fortunately, he doesn't want to crash into the aquarium wall, and contents himself with splashing you with water."
	CRLF
	CALL PRINT-ID,STR?214 >STACK
	RSTACK
?L5:	EQUAL? PRSA,V?PUT \?L8
	EQUAL? PRSO,SERPENT \?L8
	PRINTR "Impossible for many reasons."
?L8:	EQUAL? PRSA,V?GIVE,V?TAKE \FALSE
	CALL PRINT-ID,STR?215
	CALL JIGS-UP,STR?216 >STACK
	RSTACK

	.FUNCT DEAD-SERPENT-FCN
	EQUAL? PRSA,V?TAKE \FALSE
	PRINTR "This may only be a baby sea serpent, but it's as big as a small whale."

	.FUNCT GENIE-FCN,RARG=M-OBJECT,V,HOARD,?TMP
	EQUAL? PRSA,V?HELLO \?L1
	PRINTR "The genie grins demonically, but says nothing."
?L1:	EQUAL? WINNER,GENIE \?L5
	ZERO? GENIE-READY? \?L6
	PRINTI """My fee is not paid! I perform no tasks for free! We demons have a strong union these days."""
	CRLF
	RETURN 2
?L6:	EQUAL? PRSA,V?SGIVE /FALSE
	GET P-PRSO,0 >STACK
	GRTR? STACK,1 /?L14
	GET P-PRSI,0 >STACK
	GRTR? STACK,1 \?L13
?L14:	PRINTI """I will do one thing only, oh gracious master!"""
	CRLF
	RETURN 2
?L13:	EQUAL? PRSA,V?MOVE \?L19
	EQUAL? PRSO,GLOBAL-MENHIR \?L19
	SET 'MENHIR-POSITION,1
	PRINTI "The demon is gone for a moment. ""A trifle... My little finger alone was enough."""
	CRLF
	CALL GENIE-LEAVES >STACK
	RSTACK
?L19:	EQUAL? PRSA,V?TAKE \?L22
	EQUAL? PRSO,GLOBAL-MENHIR \?L23
	REMOVE MENHIR
	SET 'MENHIR-POSITION,2
	PRINTI "The demon flashes away for a second. ""I have little use for such a thing, but perhaps as a doorstop..."""
	CRLF
	CALL GENIE-LEAVES >STACK
	RSTACK
?L23:	EQUAL? PRSO,WAND \?L27
	PRINTI """This I do gladly, oh fool!"" cackles the demon gleefully. He stretches out an enormous hand towards the wand and taking it like a toothpick (this is a large demon), points it at himself. ""Free!"" he commands, and the demon and his wand vanish forever."
	CRLF
	CALL PRINT-ID,STR?217
	CALL GENIE-LEAVES,0
	REMOVE WAND
	RTRUE
?L27:	FSET? PRSO,TAKEBIT \?L30
	CALL GENIE-LEAVES,0
	REMOVE PRSO
	PRINTI "The demon snaps his fingers, the "
	PRINTD PRSO
	PRINTI " spins wildly in the air in front of him, then he and it depart."
	CRLF
	CALL PRINT-ID,STR?218 >STACK
	RSTACK
?L30:	PRINTR """I fear that I cannot take such a thing."""
?L22:	EQUAL? PRSA,V?GIVE \?L36
	EQUAL? PRSI,ME \?L36
	EQUAL? PRSO,WAND \?L37
	PRINTI """I hear and obey!"" says the demon. He stretches out an enormous hand towards the wand. The Wizard is unsure what to do, pointing it threateningly at the demon, then at you. ""Fudge!"" he cries, but aside from a strong odor of chocolate in the air, there is no effect. The demon plucks the wand out of his hand (it's about toothpick-size to him) and gingerly lays it before you. He fades into the smoke, which disperses. The wizard runs from the room in terror."
	CRLF
	REMOVE WIZARD
	CALL GENIE-LEAVES,0
	FCLEAR WAND,NDESCBIT
	MOVE WAND,HERE
	RTRUE
?L37:	EQUAL? PRSO,GLOBAL-MENHIR \?L41
	MOVE MENHIR,PENTAGRAM-ROOM
	FCLEAR MENHIR,NDESCBIT
	FCLEAR MENHIR,TAKEBIT
	SET 'MENHIR-POSITION,3
	PRINTI "He waves his hands, and the menhir drops softly at your feet."
	CRLF
	CALL GENIE-LEAVES >STACK
	RSTACK
?L41:	FSET? PRSO,TAKEBIT \?L44
	MOVE PRSO,PENTAGRAM-ROOM
	PRINTI "The "
	PRINTD PRSO
	PRINTI " appears before you and settles to the ground."
	CRLF
	CALL GENIE-LEAVES >STACK
	RSTACK
?L44:	PRINTR """Were it possible, this would be my fondest wish, but alas..."""
?L36:	EQUAL? PRSA,V?ATTACK \?L50
	EQUAL? PRSO,GLOBAL-CERBERUS \?L51
	PRINTI """This may prove taxing, but we'll see. Perhaps I'll tame him for a pup instead."" The demon disappears for an instant, then reappears. He looks rather gnawed and scratched. He winces. ""Too much for me. Puppy dog, indeed. You're welcome to him. Never did like dogs anyway... Any other orders, oh beneficent one?"""
	CRLF
	CALL PRINT-ID,STR?219 >STACK
	RSTACK
?L51:	EQUAL? PRSO,WIZARD \?L55
	PRINTI "The demon grins hideously. ""This has been my desire e'er since this charlatan bent me to his service. I perform this deed with pleasure!"" The demon forms himself back into a cloud of greasy smoke. The cloud envelops the Wizard, who waves his wand fruitlessly, mumbling various phrases which begin with ""F"". A horrible scream is heard, and the smoke begins to clear. Nothing remains of the Wizard but his wand."
	CRLF
	CALL PRINT-ID,STR?220
	REMOVE WIZARD
	FCLEAR WAND,NDESCBIT
	MOVE WAND,HERE
	CALL GENIE-LEAVES >STACK
	RSTACK
?L55:	EQUAL? PRSO,ME \?L58
	CALL GENIE-LEAVES,0
	SET 'WINNER,ADVENTURER
	CALL PRINT-ID,STR?221
	CALL JIGS-UP,STR?222 >STACK
	RSTACK
?L58:	PRINTI """I know no way to kill a "
	PRINTD PRSO
	PRINTR "."""
?L50:	EQUAL? PRSA,V?EXAMINE,V?FIND \?L62
	PRINTI """I am not permitted to "
	EQUAL? PRSA,V?FIND \?L65
	PRINTI "answer questions"
	JUMP ?L69
?L65:	PRINTI "perform such menial tasks"
?L69:	PRINTR ". The terms of my contract are explicit on this matter, learned one. Surely you would not wish to violate my contract?"" He licks his lips with a forked tongue like a snake's. ""The penalty clauses are ... hmm ... devilish."""
?L62:	PRINTR """Apologies, oh master, but even for such a one as I this is not possible."" He seems somewhat chagrined to have to admit this."
?L5:	EQUAL? PRSA,V?MUNG,V?ATTACK,V?EXORCISE \?L77
	PRINTI "The demon laughs uproariously."
	CRLF
	EQUAL? PRSA,V?EXORCISE,V?ATTACK /?L80
	PUSH 0
	JUMP ?L81
?L80:	PUSH 1
?L81:	CALL PRINT-ID,STR?223,STACK
	EQUAL? PRSA,V?MUNG /?L82
	PUSH 0
	JUMP ?L83
?L82:	PUSH 1
?L83:	CALL PRINT-ID,STR?224,STACK >STACK
	RSTACK
?L77:	EQUAL? PRSA,V?GIVE \FALSE
	EQUAL? PRSI,GENIE \FALSE
	EQUAL? PRSO,IRON-BOX \?L85
	IN? VIOLIN,PRSO \?L85
	PRINTI "The genie frowns briefly, then "
	FSET? PRSO,OPENBIT \?L89
	PRINTI "looks inside"
	JUMP ?L93
?L89:	PRINTI "opens"
?L93:	PRINTI " the box. He smiles horribly."
	CRLF
	CALL REMOVE-CAREFULLY,IRON-BOX
	SET 'PRSO,VIOLIN
?L85:	GETPT PRSO,P?VALUE >STACK
	ZERO? STACK /?L99
	EQUAL? PRSO,SWORD /?L99
	CALL REMOVE-CAREFULLY,PRSO
	INC 'GENIE-HOARD
	CALL SCORE-UPD,2
	SET '?TMP,GENIE-HOARD
	CALL CASE-WORTH >STACK
	ADD ?TMP,STACK >HOARD
	LESS? HOARD,TREASURES-MAX /?L101
	SET 'GENIE-READY?,1
	PUTP WIZARD,P?LDESC,STR?225
	PRINTI """This will do for my fee. 'Tis a paltry hoard, but as you have done me a small service by loosing me from this wizard, it will suffice."""
	CRLF
	CALL PRINT-ID,STR?226 >STACK
	RSTACK
?L101:	PRINTI """"
	GET GENIE-THANKS,HOARD >STACK
	PRINT STACK
	PRINTI """"
	CRLF
	EQUAL? HOARD,8 \TRUE
	PRINTR "The Wizard looks at you as if you are a madman. He tears his beard and stares at you fearfully."
?L99:	CALL BOMB?,PRSO >STACK
	ZERO? STACK /?L113
	CALL GENIE-LEAVES,0
	PRINTI """I fear that this violates my contract, oh foolish one. Thus, I am free to depart."""
	CRLF
	CALL PRINT-ID,STR?227 >STACK
	RSTACK
?L113:	CALL REMOVE-CAREFULLY,PRSO
	PRINTI "The demon gladly takes the "
	PRINTD PRSO
	PRINTR " and smiles balefully, revealing enormous fangs."

	.FUNCT GENIE-LEAVES,NOISY?=1
	FSET GENIE,INVISIBLE
	ZERO? NOISY? /?L1
	PRINTI "The genie departs, his agreement fulfilled."
	CRLF
?L1:	SET 'P-CONT,0
	RETURN 2

	.FUNCT CASE-WORTH,F,W=0
	FIRST? WIZARD-CASE >F /?L4
	RETURN W
?L4:	GETPT F,P?VALUE >STACK
	ZERO? STACK /?L7
	INC 'W
?L7:	NEXT? F >F /?L4
	RETURN W

	.FUNCT PENTAGRAM-FCN,RARG=M-BEG
	EQUAL? RARG,M-BEG \FALSE
	EQUAL? PRSA,V?BOARD,V?THROUGH \?L3
	PRINTR "You try to enter the pentagram, but are forced back by an invisible power."
?L3:	EQUAL? PRSA,V?PUT-ON,V?PUT \FALSE
	EQUAL? PRSO,PALANTIR-4 \FALSE
	REMOVE PALANTIR-4
	FCLEAR GENIE,INVISIBLE
	MOVE GENIE,PENTAGRAM-ROOM
	PRINTR "A cold wind blows outward from the sphere. The candles flicker, and a low moan, almost inaudible, is heard. It rises in volume and pitch until it becomes a high-pitched keening. A dim shape becomes visible in the air above the sphere. The shape resolves into a large and somewhat formidable looking demon. He looks around, tests the walls of the pentagram experimentally, then sees you! ""Hmm, a new master..."" he says under his breath. ""Greetings, oh master! Wouldst desire a service, as our contract stateth? For some pittance of wealth, some trifle, I will gratify thy desires to the utmost limit of my powers, and they are not inconsiderable."" He makes a pass with his massive arms and the walls begin to shake a little. Another pass and the shaking stops. ""A nice effect... I find it makes for a better relationship to give such a demonstration early on."" He grins vilely."

	.FUNCT WIZARD-FCN,RARG=M-OBJECT,OLIT
	EQUAL? WINNER,WIZARD \?L1
	EQUAL? PRSA,V?GIVE \?L3
	PRINTR "The Wizard replies ""Foolishment!"""
?L3:	PRINTR "The Wizard considers your statement carefully. His expression indicates he regards it as fanciful."
?L1:	EQUAL? PRSA,V?GIVE \?L10
	EQUAL? PRSI,WIZARD \?L10
	SET 'OLIT,LIT
	CALL REMOVE-CAREFULLY,PRSO
	CALL BOMB?,PRSO >STACK
	ZERO? STACK /?L11
	IN? GENIE,PENTAGRAM-ROOM \?L13
	MOVE PRSO,HERE
	PRINTI "The wizard accepts this final folly resignedly."
	CRLF
	CALL PRINT-ID,STR?228 >STACK
	RSTACK
?L13:	REMOVE WIZARD
	PRINTI """Hmm..."" The Wizard mutters something, then waves his wand over the bomb. It transforms into a bouquet of flowers. Both Wizard and flowers disappear."
	CRLF
	CALL PRINT-ID,STR?229 >STACK
	RSTACK
?L11:	ZERO? OLIT /?L20
	ZERO? LIT \?L20
	PRINTI """Thank you."" As the Wizard places the "
	PRINTD PRSO
	PRINTR " under his robe, the room becomes dark."
?L20:	PRINTI """Thank you."""
	CRLF
	CALL PRINT-ID,STR?230 >STACK
	RSTACK
?L10:	CALL HELLO?,WIZARD >STACK
	ZERO? STACK /?L26
	PRINTR "The Wizard seems surprised, much as you might be if a dog talked."
?L26:	EQUAL? PRSA,V?MUNG,V?ATTACK \FALSE
	REMOVE WIZARD
	IN? WAND,WIZARD \?L30
	PRINTI "The Wizard retreats, waving his wand and chanting. He says ""Fear!"" "
	CALL PRINT-ID,STR?231
	JUMP ?L34
?L30:	PRINTI "The Wizard tries to cast the ""Fear!"" spell, but without his wand! "
	CALL PRINT-ID,STR?232
?L34:	FSET? GENIE,INVISIBLE /?L37
	PRINTR "Nothing happens! With a terrified glance at the demon, the wizard runs past you and out of the room."
?L37:	PRINTI "You are suddenly terrified. The Wizard seems huge and terrible, looming over you. You flee, terrified. He chuckles, snaps his fingers, and disappears."
	CRLF
	CRLF
	SET 'SPELL?,S-FEAR
	PUTP ADVENTURER,P?ACTION,MAGIC-ACTOR
	CALL QUEUE,I-WIZARD,10 >STACK
	PUT STACK,0,1
	CALL RANDOM-WALK >STACK
	RSTACK

	.FUNCT I-WIZARD,CAST-PROB,PCNT=0,F,WLOC
	LOC WINNER >WLOC
	CALL QUEUE,I-WIZARD,4 >STACK
	PUT STACK,0,1
	ZERO? DEAD \FALSE
	ZERO? SPELL? /?L3
	EQUAL? SPELL?,S-FLOAT \?L4
	EQUAL? HERE,WELL-TOP \?L6
	CALL PRINT-ID,STR?233
	CALL JIGS-UP,STR?234
	RTRUE
?L6:	FSET? HERE,NONLANDBIT \?L12
	EQUAL? HERE,WELL-BOTTOM,VOLCANO-BOTTOM /?L12
	CALL PRINT-ID,STR?235
	CALL JIGS-UP,STR?236
	RTRUE
?L4:	EQUAL? SPELL?,S-FEEBLE \?L10
	SET 'LOAD-ALLOWED,LOAD-MAX
	JUMP ?L12
?L10:	EQUAL? SPELL?,S-FIERCE \?L11
	SET 'SWORD-GLOW,0
	JUMP ?L12
?L11:	EQUAL? SPELL?,S-FUMBLE \?L12
	SET 'FUMBLE-NUMBER,7
	SET 'FUMBLE-PROB,8
?L12:	GET SPELL-STOPS,SPELL? >STACK
	ZERO? STACK /?L14
	GET SPELL-STOPS,SPELL? >STACK
	PRINT STACK
	CRLF
?L14:	PUTP ADVENTURER,P?ACTION,0
	SET 'SPELL?,0
	RTRUE
?L3:	IN? GENIE,PENTAGRAM-ROOM \?L20
	CALL INT,I-WIZARD >STACK
	PUT STACK,0,0
	IN? WIZARD,PENTAGRAM-ROOM /TRUE
	MOVE WIZARD,PENTAGRAM-ROOM
	IN? WINNER,PENTAGRAM-ROOM \TRUE
	PRINTR "Suddenly the Wizard materializes in the room. He is astonished by what he sees: his servant in deep conversation with a common adventurer! He draws forth his wand, waves it frantically, and incants ""Frobizz! Frobozzle! Frobnoid!"" The demon laughs heartily. ""You no longer control the Black Crystal, hedge-wizard! Your wand is powerless! Your doom is sealed!"" The demon turns to you, expectantly."
?L20:	ZERO? LIT \?L31
	FSET? LAMP,RMUNGBIT \?L31
	GRTR? SCORE,200 \?L31
	SET 'ALWAYS-LIT,1
	SET 'LIT,1
	PRINTR "In the darkness you hear the voice of the Wizard. ""Dear me, you seem to have gotten into quite a pickle."" He chuckles. ""Fluoresce!"" he incants. It is no longer dark."
?L31:	LOC WIZARD >STACK
	ZERO? STACK /?L36
	RANDOM 100 >STACK
	GRTR? 80,STACK \?L36
	ZERO? LIT /?L38
	IN? WIZARD,HERE \?L38
	PRINTI "The Wizard vanishes."
	CRLF
?L38:	REMOVE WIZARD
	RTRUE
?L36:	RANDOM 100 >STACK
	GRTR? 10,STACK \FALSE
	ZERO? LIT \?L46
	PRINTI "You feel a slight outrush of air as something moves nearby."
	CRLF
	JUMP ?L56
?L46:	EQUAL? HERE,POSTS-ROOM,POOL-ROOM \?L50
	PRINTI "A huge and terrible wizard appears before you, as large as the largest tree! He looks down on you as you would look upon a gnat!"
	CRLF
	JUMP ?L56
?L50:	FSET? HERE,NONLANDBIT \?L53
	PRINTI "The Wizard appears, floating nonchalantly in the air beside you. He grins sideways at you."
	CRLF
	JUMP ?L56
?L53:	PRINTI "A strange little man in a long cloak appears suddenly in the room. He is wearing a high pointed hat embroidered with astrological signs. He has a long, stringy, and unkempt beard."
	CRLF
?L56:	IN? PALANTIR-4,ADVENTURER \?L59
	ZERO? LIT /?L61
	PRINTI "The Wizard notices that you carry the Black Crystal, and with an unseemly haste, he disappears."
	CRLF
	JUMP ?L65
?L61:	PRINTI "You feel a sudden inrush of air as though something disappeared."
	CRLF
?L65:	REMOVE WIZARD
	RTRUE
?L59:	RANDOM 100 >STACK
	GRTR? 20,STACK \?L68
	ZERO? LIT /?L69
	PRINTI "He mutters something (muffled by his beard) and disappears as suddenly as he came."
	CRLF
	JUMP ?L73
?L69:	PRINTI "You hear low, confused muttering."
	CRLF
?L73:	REMOVE WIZARD
	RTRUE
?L68:	IN? PALANTIR-1,ADVENTURER \?L77
	INC 'PCNT
?L77:	IN? PALANTIR-2,ADVENTURER \?L80
	INC 'PCNT
?L80:	IN? PALANTIR-3,ADVENTURER \?L83
	INC 'PCNT
?L83:	MUL PCNT,20 >STACK
	SUB 80,STACK >CAST-PROB
	ZERO? LIT /?L86
	PRINTI "The Wizard draws forth his wand and waves it in your direction. It begins to glow with a faint blue glow."
	CRLF
	JUMP ?L90
?L86:	PRINTI "Suddenly, illuminated by the faint blue glow of a magic wand pointed in your direction, you see the Wizard!"
	CRLF
?L90:	RANDOM 100 >STACK
	GRTR? CAST-PROB,STACK \?L93
	MOVE WIZARD,HERE
	RANDOM SPELLS >SPELL?
	PUTP ADVENTURER,P?ACTION,MAGIC-ACTOR
	MUL 5,PCNT >STACK
	SUB 30,STACK >STACK
	RANDOM STACK >STACK
	ADD 5,STACK >STACK
	CALL QUEUE,I-WIZARD,STACK >STACK
	PUT STACK,0,1
	RANDOM 100 >STACK
	GRTR? 75,STACK \?L95
	PRINTI "The Wizard, in a deep and resonant voice, speaks the word """
	GET SPELL-NAMES,SPELL? >STACK
	PRINT STACK
	PRINTI "!"" He then vanishes, cackling gleefully."
	CRLF
	JUMP ?L99
?L95:	PRINTI "The Wizard, almost inaudibly, whispers a word beginning with ""F,"" and then disappears, chuckling nastily."
	CRLF
?L99:	REMOVE WIZARD
	GET SPELL-HINTS,SPELL? >STACK
	ZERO? STACK /?L102
	GET SPELL-HINTS,SPELL? >STACK
	PRINT STACK
	CRLF
?L102:	EQUAL? SPELL?,S-FALL \?L107
	FSET? WLOC,VEHBIT \TRUE
	PRINTI "You suddenly fall headlong out of the "
	PRINTD WLOC
	PRINTI " as though someone had flipped it over."
	CRLF
	EQUAL? HERE,WELL-TOP \?L113
	CALL PRINT-ID,STR?237
	CALL JIGS-UP,STR?238
	RTRUE
?L113:	FSET? HERE,NONLANDBIT \?L115
	EQUAL? HERE,VOLCANO-BOTTOM,WELL-BOTTOM /?L115
	CALL PRINT-ID,STR?239
	CALL JIGS-UP,STR?240
	RTRUE
?L115:	MOVE WINNER,HERE
	RTRUE
?L107:	EQUAL? SPELL?,S-FLOAT \?L118
	FSET? WLOC,VEHBIT \?L119
	PRINTI " You rise majestically out of the "
	PRINTD WLOC
	PRINTI ", coming to a stop about five feet above it and to one side."
	CRLF
	MOVE WINNER,HERE
	RTRUE
?L119:	PRINTR "Slowly, you and all your belongings rise into the air, stopping after about five feet."
?L118:	EQUAL? SPELL?,S-FEEBLE \?L126
	SET 'LOAD-ALLOWED,50
	FIRST? WINNER >F \TRUE
	PRINTI "In fact, you feel so weak that you drop the "
	PRINTD F
	PRINTI "."
	CRLF
	MOVE F,WLOC
	RTRUE
?L126:	EQUAL? SPELL?,S-FEAR \?L132
	FSET? WLOC,VEHBIT \?L133
	PRINTI "You cower in the corner of the "
	PRINTD WLOC
	PRINTR ", hoping the wizard won't see you."
?L133:	CRLF
	CALL RANDOM-WALK
	RTRUE
?L132:	EQUAL? SPELL?,S-FUMBLE \?L138
	SET 'FUMBLE-NUMBER,3
	SET 'FUMBLE-PROB,25
	FIRST? ADVENTURER >F \TRUE
	PRINTI "Ooops! You dropped the "
	PRINTD F
	PRINTI "."
	CRLF
	MOVE F,WLOC
	RTRUE
?L138:	EQUAL? SPELL?,S-FILCH \?L144
	CALL ROB,WINNER,WIZARD-CASE >STACK
	ZERO? STACK /TRUE
	PRINTR "Something you are carrying has disappeared!"
?L144:	EQUAL? SPELL?,S-FIERCE \TRUE
	PRINTR "The Wizard mumbles something under his breath, and just before you reach him, he vanishes."
?L93:	RANDOM 100 >STACK
	GRTR? 50,STACK \?L154
	REMOVE WIZARD
	PRINTR "There is a loud crackling noise. Blue smoke rises from out of the Wizard's sleeve. He sighs and disappears."
?L154:	RANDOM 100 >STACK
	GRTR? 50,STACK \?L157
	REMOVE WIZARD
	PRINTI "The Wizard incants """
	CALL RANDOM-ELEMENT,SPELL-NAMES >STACK
	PRINT STACK
	PRINTR "!"" but nothing happens. He shakes the wand. Nothing happens. With a slightly embarrassed glance in your direction, he vanishes."
?L157:	MOVE WIZARD,HERE
	PRINTR "The Wizard seems about to say something, but thinks better of it, and peers at you from under his bushy eyebrows."

	.FUNCT ROB,WHO,WHERE,N,X,ROBBED?=0
	FIRST? WHO >X /?L4
	RETURN ROBBED?
?L1:	ZERO? X \?L4
	RETURN ROBBED?
?L4:	NEXT? X >N /?L7
?L7:	CALL RIPOFF,X,WHERE >STACK
	ZERO? STACK /?L8
	SET 'ROBBED?,1
?L8:	SET 'X,N
	JUMP ?L1

	.FUNCT RIPOFF,X,WHERE
	FSET? X,INVISIBLE /FALSE
	GETPT X,P?VALUE >STACK
	ZERO? STACK /FALSE
	EQUAL? X,PALANTIR-1,PALANTIR-2,PALANTIR-3 /FALSE
	EQUAL? X,GOLD-KEY,CANDY /FALSE
	MOVE X,WHERE
	FSET X,TOUCHBIT
	RTRUE

	.FUNCT WIZARD-CASE-FCN
	EQUAL? WINNER,GENIE \?L1
	EQUAL? PRSA,V?OPEN,V?MUNG \FALSE
	REMOVE WIZARD-CASE
	MOVE BROKEN-CASE,TROPHY-ROOM
	PRINTI "The demon smashes the case into smithereens. Everything in it smashes as well."
	CRLF
	CALL PRINT-ID,STR?241 >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?ENCHANT \?L8
	EQUAL? SPELL-USED,W?FILCH \?L8
	CALL PRINT-ID,STR?242
	CALL ROB,WIZARD-CASE,HERE
	SET 'SPELL-HANDLED?,1
	PRINTR "The contents of the case are arrayed at your feet."
?L8:	EQUAL? PRSA,V?CLOSE,V?MUNG,V?OPEN /?L12
	EQUAL? PRSA,V?TAKE \FALSE
?L12:	PRINTI "The case is protected by a fearful spell. You cannot touch it in any way."
	CRLF
	EQUAL? PRSA,V?MUNG /?L15
	PUSH 0
	JUMP ?L16
?L15:	PUSH 1
?L16:	CALL PRINT-ID,STR?243,STACK >STACK
	RSTACK

	.FUNCT WAND-FCN
	EQUAL? PRSA,V?GIVE,V?PUT,V?TAKE \?L1
	IN? WAND,WIZARD \?L1
	EQUAL? WINNER,ADVENTURER \?L3
	PRINTI "The Wizard snatches it away."
	CRLF
	EQUAL? PRSA,V?TAKE /?L7
	PUSH 0
	JUMP ?L8
?L7:	PUSH 1
?L8:	CALL PRINT-ID,STR?244,STACK
	EQUAL? PRSA,V?GIVE,V?PUT /?L9
	PUSH 0
	JUMP ?L10
?L9:	PUSH 1
?L10:	CALL PRINT-ID,STR?245,STACK >STACK
	RSTACK
?L3:	EQUAL? WINNER,ROBOT \FALSE
	CALL JIGS-UP,STR?246 >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?WAVE \?L13
	EQUAL? PRSI,GRUE \?L13
	PRINTR "There is no grue in sight, but a hissing sound issues forth from the darkness."
?L13:	EQUAL? PRSA,V?RAISE,V?RUB,V?WAVE \FALSE
	EQUAL? PRSO,WAND \?L17
	IN? WAND,WINNER /?L17
	PRINTR "You don't have the wand!"
?L17:	ZERO? WAND-ON \?L22
	ZERO? SPELL-USED \?L22
	ZERO? SPELL-VICTIM /?L21
?L22:	RANDOM 100 >STACK
	GRTR? 5,STACK \?L23
	CALL PRINT-ID,STR?247
	CALL JIGS-UP,STR?248
	RTRUE
?L23:	PRINTR "A lot you know about magic! A magic wand takes a while to recharge after use! You might cause it to short-circuit!"
?L21:	EQUAL? PRSA,V?WAVE \?L28
	EQUAL? PRSO,WAND \?L29
	ZERO? PRSI /?L29
	SET 'WAND-ON,PRSI
	SET 'WAND-ON-LOC,HERE
	JUMP ?L40
?L29:	PRINTR "At what?"
?L28:	EQUAL? PRSA,V?RUB \?L34
	EQUAL? PRSI,WAND \?L35
	ZERO? PRSO /?L35
	SET 'WAND-ON,PRSO
	JUMP ?L40
?L35:	PRINTR "Touch what?"
?L34:	EQUAL? PRSA,V?RAISE \?L40
	PRINTR "The wand grows warm and seems to vibrate."
?L40:	ZERO? WAND-ON /TRUE
	SET 'SPELL-USED,0
	SET 'SPELL-VICTIM,0
	EQUAL? WAND-ON,ME,WAND \?L46
	SET 'WAND-ON,0
	PRINTI "Fortunately a safety interlock prevents the fatal feedback loop that this would cause."
	CRLF
	JUMP ?L50
?L46:	PRINTI "The wand grows warm, the "
	PRINTD WAND-ON
	PRINTI " seems to glow dimly with magical essences, and you feel suffused with power."
	CRLF
?L50:	CALL QUEUE,I-WAND,2 >STACK
	PUT STACK,0,1
	RTRUE

	.FUNCT I-WAND
	ZERO? WAND-ON /?L1
	EQUAL? WAND-ON-LOC,HERE /?L3
	IN? WAND-ON,WINNER \?L1
?L3:	PRINTI "The "
	PRINTD WAND-ON
	PRINTI " stops glowing and the power within you weakens."
	CRLF
	SET 'WAND-ON,0
	RTRUE
?L1:	SET 'WAND-ON,0
	RFALSE

	.FUNCT WIZARD-QUARTERS-FCN,RARG,PICK,L
	EQUAL? RARG,M-LOOK,M-FLASH \FALSE
	PRINTI "This is where the Wizard of Frobozz lives. The room is "
	GET WIZQDESCS,0 >L
	RANDOM L >PICK
	EQUAL? PICK,WIZQLAST \?L9
	EQUAL? PICK,L \?L7
	DEC 'PICK
	JUMP ?L9
?L7:	INC 'PICK
?L9:	SET 'WIZQLAST,PICK
	GET WIZQDESCS,PICK >STACK
	PRINT STACK
	CRLF
	RTRUE

	.FUNCT BRIDGE-FCN
	EQUAL? PRSA,V?CROSS \?L1
	CALL DO-WALK,P?CROSS >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?LEAP \FALSE
	CALL PRINT-ID,STR?249
	CALL JIGS-UP,STR?250 >STACK
	RSTACK

	.FUNCT STREAM-FCN
	EQUAL? PRSA,V?THROUGH,V?SWIM \?L1
	PRINTR "You can't swim in the stream."
?L1:	EQUAL? PRSA,V?CROSS \FALSE
	PRINTR "You'll have to find a ford or a bridge."

	.FUNCT CHASM-FCN
	EQUAL? PRSA,V?LEAP /?L3
	EQUAL? PRSA,V?PUT \?L1
	EQUAL? PRSO,ME \?L1
?L3:	PRINTI "For a change, you look before leaping. You realize you would never survive."
	CRLF
	CALL PRINT-ID,STR?251 >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?CROSS \?L6
	PRINTR "You'll have to find a bridge."
?L6:	EQUAL? PRSA,V?PUT \FALSE
	EQUAL? PRSI,PSEUDO-OBJECT \FALSE
	PRINTI "The "
	PRINTD PRSO
	PRINTI " drops out of sight into the chasm."
	CRLF
	REMOVE PRSO
	RTRUE

	.FUNCT TUNNEL-OBJECT
	EQUAL? PRSA,V?THROUGH \?L1
	GETPT HERE,P?IN >STACK
	ZERO? STACK /?L1
	CALL DO-WALK,P?IN
	RTRUE
?L1:	CALL PATH-OBJECT >STACK
	RSTACK

	.FUNCT STALA-PSEUDO
	EQUAL? PRSA,V?MUNG,V?TAKE \FALSE
	PRINTI "The only ones you can reach are too large to successfully break off."
	CRLF
	CALL PRINT-ID,STR?252 >STACK
	RSTACK

	.FUNCT MOSS-FCN
	EQUAL? PRSA,V?RUB,V?TAKE \FALSE
	PRINTR "Some of the moss rubs off on you, but it stops glowing very quickly once plucked from its environment."

	.FUNCT ROSE-BUSH-FCN
	EQUAL? PRSA,V?TAKE \FALSE
	PRINTI "You prick your finger trying to take a rose, and jump back annoyed. The rose almost seemed to move its thorns into your path."
	CRLF
	CALL PRINT-ID,STR?253 >STACK
	RSTACK

	.FUNCT I-SPELL
	ZERO? SPELL-HANDLED? \?L1
	ZERO? SPELL-VICTIM /?L1
	CALL PERFORM,V?DISENCHANT,SPELL-VICTIM
?L1:	SET 'SPELL-HANDLED?,0
	SET 'WAND-ON,0
	SET 'SPELL-USED,0
	SET 'SPELL-VICTIM,0
	RETURN SPELL-VICTIM

	.FUNCT V-DIAGNOSE
	ZERO? DEAD /?L1
	PRINTI "You are dead."
	JUMP ?L17
?L1:	EQUAL? SPELL?,S-FERMENT \?L5
	PRINTI "You are drunk."
	JUMP ?L17
?L5:	EQUAL? SPELL?,S-FEEBLE \?L8
	PRINTI "You seem unusually weak right now."
	JUMP ?L17
?L8:	EQUAL? SPELL?,S-FLOAT \?L11
	PRINTI "You seem somewhat light."
	JUMP ?L17
?L11:	EQUAL? SPELL?,S-FREEZE \?L14
	PRINTI "You are frozen stiff."
	JUMP ?L17
?L14:	PRINTI "You are in perfect health."
?L17:	CRLF
	ZERO? DEATHS /FALSE
	PRINTI "You have been killed "
	EQUAL? DEATHS,1 \?L24
	PRINTR "once."
?L24:	EQUAL? DEATHS,2 \?L28
	PRINTR "twice."
?L28:	PRINTR "an awful lot."

	.FUNCT V-SCORE,ASK?=1
	PRINTI "Your score "
	ZERO? ASK? /?L3
	PRINTI "would be "
	JUMP ?L7
?L3:	PRINTI "is "
?L7:	PRINTN SCORE
	PRINTI " (total of 410 points), in "
	PRINTN MOVES
	EQUAL? MOVES,1 \?L16
	PRINTI " move."
	JUMP ?L20
?L16:	PRINTI " moves."
?L20:	CRLF
	PRINTI "This score gives you the rank of "
	GRTR? SCORE,399 \?L25
	PRINTI "Master Adventurer"
	ZERO? WON-FLAG \?L52
	PRINTI ", but somehow you don't feel done"
	JUMP ?L52
?L25:	GRTR? SCORE,360 \?L34
	PRINTI "Wizard"
	JUMP ?L52
?L34:	GRTR? SCORE,320 \?L37
	PRINTI "Master"
	JUMP ?L52
?L37:	GRTR? SCORE,240 \?L40
	PRINTI "Adventurer"
	JUMP ?L52
?L40:	GRTR? SCORE,160 \?L43
	PRINTI "Junior Adventurer"
	JUMP ?L52
?L43:	GRTR? SCORE,80 \?L46
	PRINTI "Novice Adventurer"
	JUMP ?L52
?L46:	GRTR? SCORE,40 \?L49
	PRINTI "Amateur Adventurer"
	JUMP ?L52
?L49:	PRINTI "Beginner"
?L52:	PRINTI "."
	CRLF
	RETURN SCORE

	.FUNCT JIGS-UP,DESC=0,PLAYER?=0
	ZERO? DESC /?L1
	PRINT DESC
	CRLF
?L1:	EQUAL? ADVENTURER,WINNER /?L6
	PRINTI " 
   ****  The "
	PRINTD WINNER
	PRINTI " has died  **** 

"
	REMOVE WINNER
	SET 'WINNER,ADVENTURER
	LOC WINNER >HERE
	RETURN 2
?L6:	CALL SCORE-UPD,-10
	PRINTI " 
   ****  You have died  **** 

"
	SET 'DEAD,1
	SET 'SPELL?,0
	PUTP ADVENTURER,P?ACTION,0
	INC 'DEATHS
	MOVE WINNER,HERE
	PRINTI "Now, let's take a look here... Well, you probably deserve another chance. I can't quite fix you up completely, but you can't have everything."
	CRLF
	CRLF
	FCLEAR DEAD-PALANTIR-1,TOUCHBIT
	FCLEAR DEAD-PALANTIR-2,TOUCHBIT
	FCLEAR DEAD-PALANTIR-3,TOUCHBIT
	CALL RANDOMIZE-OBJECTS
	CALL GOTO,DEAD-PALANTIR-1
	SET 'P-CONT,0
	CALL KILL-INTERRUPTS
	RETURN 2

	.FUNCT RANDOMIZE-OBJECTS,R=0,F,N,L
	IN? LAMP,WINNER \?L1
	MOVE LAMP,INSIDE-BARROW
?L1:	FIRST? WINNER >N /?L4
?L4:	SET 'F,N
	ZERO? F /TRUE
	NEXT? F >N /?L10
?L10:	EQUAL? F,BILLS,PORTRAIT \?L11
	EQUAL? HERE,VAULT,DEPOSITORY,OFFICE /?L13
	EQUAL? HERE,SMALL-ROOM \?L11
?L13:	MOVE F,HERE
	JUMP ?L4
?L11:	EQUAL? F,GOLD-KEY,CANDY,PALANTIR-1 /?L15
	EQUAL? F,PALANTIR-2 /?L15
	EQUAL? F,PALANTIR-3 \?L14
?L15:	MOVE F,CAROUSEL-ROOM
	JUMP ?L4
?L14:	FSET? F,STAGGERED \?L16
	MOVE F,WIZARD-CASE
	JUMP ?L4
?L16:	MOVE F,GAZEBO-ROOM
	JUMP ?L4

	.FUNCT KILL-INTERRUPTS
	CALL INT,I-GNOME >STACK
	PUT STACK,0,0
	CALL INT,I-LEDGE >STACK
	PUT STACK,0,0
	CALL INT,I-NERVOUS >STACK
	PUT STACK,0,0
	CALL INT,I-ZGNOME-OUT >STACK
	PUT STACK,0,0
	CALL INT,I-ZGNOME >STACK
	PUT STACK,0,0
	CALL DRAGON-LEAVES
	CALL INT,I-MATCH >STACK
	PUT STACK,0,0
	RTRUE

	.FUNCT FIND-WEAPON,O,W
	FIRST? O >W \FALSE
?L2:	EQUAL? W,SWORD \?L7
	RETURN W
?L7:	NEXT? W >W /?L2
	RFALSE

	.FUNCT BUCKET-CONT
	EQUAL? PRSA,V?TAKE \FALSE
	IN? WINNER,BUCKET /FALSE
	PRINTR "You'll need to get in the bucket to reach it."

	.INSERT "./annotated_games/zork2/zork2_str"
	.END
