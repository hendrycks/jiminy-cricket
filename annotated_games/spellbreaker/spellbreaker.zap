	.INSERT "./annotated_games/spellbreaker/spellbreaker_freq"
	.INSERT "./annotated_games/spellbreaker/spellbreaker_data"

	.FUNCT V-$0024COMMAND
	DIRIN 1
	RTRUE

	.FUNCT V-$0024RANDOM
	EQUAL? PRSO,INTNUM /?L1
	PRINTR "Illegal call to #RANDOM."
?L1:	SUB 0,P-NUMBER >STACK
	RANDOM STACK >STACK
	RTRUE

	.FUNCT V-$0024RECORD
	DIROUT D-RECORD-ON
	RTRUE

	.FUNCT V-$0024UNRECORD
	DIROUT D-RECORD-OFF
	RTRUE

	.FUNCT CTHE-PRINT-PRSO
	CALL THE-PRINT,PRSO,1 >STACK
	RSTACK

	.FUNCT CTHE-PRINT-PRSI
	CALL THE-PRINT,PRSI,1 >STACK
	RSTACK

	.FUNCT CTHE-PRINT,O
	CALL THE-PRINT,O,1 >STACK
	RSTACK

	.FUNCT THE-PRINT-PRSO
	CALL THE-PRINT,PRSO >STACK
	RSTACK

	.FUNCT THE-PRINT-PRSI
	CALL THE-PRINT,PRSI >STACK
	RSTACK

	.FUNCT THE-PRINT,O,CAP?=0
	FSET? O,NOTHEBIT /?L1
	PUSH 1
	JUMP ?L2
?L1:	PUSH 0
?L2:	CALL DPRINT,O,CAP?,STACK >STACK
	RSTACK

	.FUNCT PRINTA-PRSO
	CALL PRINTA,PRSO >STACK
	RSTACK

	.FUNCT PRINTA-PRSI
	CALL PRINTA,PRSI >STACK
	RSTACK

	.FUNCT PRINTA,O
	FSET? O,THE \?L1
	PRINTI "the "
	JUMP ?L6
?L1:	FSET? O,NOABIT /?L6
	FSET? O,AN \?L4
	PRINTI "an "
	JUMP ?L6
?L4:	PRINTI "a "
?L6:	CALL IPRINT,O >STACK
	RSTACK

	.FUNCT DPRINT,O,CAP?=0,THE?=0,S
	ZERO? THE? \?L3
	FSET? O,THE \?L6
?L3:	ZERO? CAP? /?L4
	PRINTI "The "
	JUMP ?L6
?L4:	PRINTI "the "
?L6:	CALL IPRINT,O >STACK
	RSTACK

	.FUNCT IPRINT,O
	EQUAL? O,PSEUDO-OBJECT \?L1
	ZERO? P-MERGED \?L1
	EQUAL? O,PRSO,PRSI \?L1
	CALL THING-PRINT,PSEUDO-PRSO >STACK
	RSTACK
?L1:	EQUAL? O,WEED \?L3
	FSET? O,RWATERBIT \?L3
	PRINTI "weed cutting"
	RTRUE
?L3:	EQUAL? O,SPELL-COPY \?L4
	PRINTD O
	PRINTI " "
	GETP O,P?WALLS >STACK
	PRINTD STACK
	RTRUE
?L4:	GETP O,P?NAME >STACK
	ZERO? STACK /?L6
	CALL CUBE-NAME,O
	PRINTI " "
	JUMP ?L8
?L6:	FSET? O,RWATERBIT \?L8
	GETPT O,P?COUNT >STACK
	ZERO? STACK /?L8
	PRINTI "duplicate "
?L8:	PRINTD O
	RTRUE

	.FUNCT PICK-ONE,FROB,L,CNT,RND,MSG,RFROB
	GET FROB,0 >L
	GET FROB,1 >CNT
	DEC 'L
	ADD FROB,2 >FROB
	MUL CNT,2 >STACK
	ADD FROB,STACK >RFROB
	SUB L,CNT >STACK
	RANDOM STACK >RND
	GET RFROB,RND >MSG
	GET RFROB,1 >STACK
	PUT RFROB,RND,STACK
	PUT RFROB,1,MSG
	INC 'CNT
	EQUAL? CNT,L \?L1
	SET 'CNT,0
?L1:	PUT FROB,0,CNT
	RETURN MSG

	.FUNCT RANDOM-ELEMENT,FROB
	GET FROB,0 >STACK
	RANDOM STACK >STACK
	GET FROB,STACK >STACK
	RSTACK

	.FUNCT GO
START::
?L0:	CALL INITIALIZE-CUBES
	PUTB P-LEXV,0,59
	ADD C-TABLE,C-TABLELEN >CLOCK-HAND
	CALL QUEUE,I-TIRED,80
	CALL QUEUE,I-ORATION,-1
	SET 'MAGIC-BOX-CUBE,WATER-CUBE
	SET 'WINNER,PLAYER
	SET 'HERE,COUNCIL-CHAMBER
	CALL LIT?,HERE >LIT
	SET 'ORATOR,SNEFFLE
	CALL V-VERSION
	CRLF
	CALL V-LOOK
	CALL MAIN-LOOP
	JUMP ?L0

	.FUNCT MAIN-LOOP,TRASH
?L1:	CALL MAIN-LOOP-1 >TRASH
	JUMP ?L1

	.FUNCT MAIN-LOOP-1,ICNT,OCNT,NUM,CNT,OBJ,TBL,V=0,PTBL,OBJ1,TMP
	SET 'CNT,0
	SET 'OBJ,0
	SET 'PTBL,1
	CALL PARSER >P-WON
	ZERO? P-WON /?L1
	GET P-PRSI,P-MATCHLEN >ICNT
	GET P-PRSO,P-MATCHLEN >OCNT
	ZERO? P-IT-OBJECT /?L3
	CALL ACCESSIBLE?,P-IT-OBJECT >STACK
	ZERO? STACK /?L3
	SET 'TMP,0
?L5:	IGRTR? 'CNT,ICNT /?L6
	GET P-PRSI,CNT >STACK
	EQUAL? STACK,IT \?L5
	PUT P-PRSI,CNT,P-IT-OBJECT
	SET 'TMP,1
?L6:	ZERO? TMP \?L16
	SET 'CNT,0
?L15:	IGRTR? 'CNT,OCNT /?L16
	GET P-PRSO,CNT >STACK
	EQUAL? STACK,IT \?L15
	PUT P-PRSO,CNT,P-IT-OBJECT
?L16:	SET 'CNT,0
?L3:	ZERO? OCNT \?L25
	SET 'NUM,OCNT
	JUMP ?L32
?L25:	GRTR? OCNT,1 \?L27
	SET 'TBL,P-PRSO
	ZERO? ICNT \?L28
	SET 'OBJ,0
	JUMP ?L30
?L28:	GET P-PRSI,1 >OBJ
?L30:	SET 'NUM,OCNT
	JUMP ?L32
?L27:	GRTR? ICNT,1 \?L31
	SET 'PTBL,0
	SET 'TBL,P-PRSI
	GET P-PRSO,1 >OBJ
	SET 'NUM,ICNT
	JUMP ?L32
?L31:	SET 'NUM,1
?L32:	ZERO? OBJ \?L33
	EQUAL? ICNT,1 \?L33
	GET P-PRSI,1 >OBJ
?L33:	EQUAL? PRSA,V?WALK \?L36
	CALL PERFORM,PRSA,PRSO >V
	JUMP ?L53
?L36:	ZERO? NUM \?L38
	GETB P-SYNTAX,P-SBITS >STACK
	BAND STACK,P-SONUMS >STACK
	ZERO? STACK \?L39
	CALL PERFORM,PRSA >V
	SET 'PRSO,0
	JUMP ?L53
?L39:	ZERO? LIT \?L41
	PRINT TOO-DARK
	CALL END-QUOTE
	JUMP ?L53
?L41:	PRINTI "There isn't anything to "
	GET P-ITBL,P-VERBN >TMP
	EQUAL? PRSA,V?TELL \?L43
	PRINTI "talk to"
	JUMP ?L47
?L43:	ZERO? P-OFLAG \?L46
	ZERO? P-MERGED /?L45
?L46:	GET TMP,0 >STACK
	PRINTB STACK
	JUMP ?L47
?L45:	GETB TMP,3 >STACK
	GETB TMP,2 >STACK
	CALL WORD-PRINT,STACK,STACK
?L47:	PRINTI "!"
	CRLF
	SET 'V,0
	CALL END-QUOTE
	JUMP ?L53
?L38:	SET 'P-NOT-HERE,0
	SET 'P-MULT,0
	GRTR? NUM,1 \?L49
	SET 'P-MULT,1
?L49:	SET 'TMP,0
?L52:	IGRTR? 'CNT,NUM \?L54
	GRTR? P-NOT-HERE,0 \?L56
	PRINTI "The "
	EQUAL? P-NOT-HERE,NUM /?L58
	PRINTI "other "
?L58:	PRINTI "object"
	EQUAL? P-NOT-HERE,1 /?L61
	PRINTI "s"
?L61:	PRINTI " that you mentioned "
	EQUAL? P-NOT-HERE,1 /?L64
	PRINTI "are"
	JUMP ?L66
?L64:	PRINTI "is"
?L66:	PRINTI "n't here."
	CRLF
	JUMP ?L53
?L56:	ZERO? TMP \?L53
	PRINT REFERRING
	CRLF
	JUMP ?L53
?L54:	ZERO? PTBL /?L70
	GET P-PRSO,CNT >OBJ1
	JUMP ?L72
?L70:	GET P-PRSI,CNT >OBJ1
?L72:	ZERO? PTBL /?L73
	SET 'PRSO,OBJ1
	JUMP ?L75
?L73:	SET 'PRSO,OBJ
?L75:	ZERO? PTBL /?L76
	SET 'PRSI,OBJ
	JUMP ?L78
?L76:	SET 'PRSI,OBJ1
?L78:	GRTR? NUM,1 /?L81
	GET P-ITBL,P-NC1 >STACK
	GET STACK,0 >STACK
	EQUAL? STACK,W?ALL \?L84
?L81:	CALL MULTIPLE-EXCEPTION?,OBJ1 >STACK
	ZERO? STACK \?L52
	EQUAL? OBJ1,IT \?L85
	CALL DPRINT,P-IT-OBJECT
	JUMP ?L87
?L85:	CALL DPRINT,OBJ1
?L87:	PRINTI ": "
?L84:	SET 'TMP,1
	EQUAL? PRSO,PSEUDO-OBJECT \?L89
	SET 'PSEUDO-PRSO,1
	JUMP ?L90
?L89:	SET 'PSEUDO-PRSO,0
?L90:	CALL PERFORM,PRSA,PRSO,PRSI >V
	EQUAL? V,M-FATAL /?L103
	ZERO? P-MULT /?L52
	INC 'P-MULT
	JUMP ?L52
?L53:	EQUAL? V,M-FATAL /?L103
	EQUAL? PRSA,V?TELL,V?BRIEF,V?SUPER-BRIEF /?L103
	EQUAL? PRSA,V?VERBOSE,V?SAVE,V?VERSION /?L103
	EQUAL? PRSA,V?RESTORE,V?SCRIPT,V?UNSCRIPT /?L103
	LOC WINNER >STACK
	GETP STACK,P?ACTION >STACK
	CALL STACK,M-END >V
?L103:	EQUAL? PRSA,V?SAVE,V?RESTORE,V?SCRIPT /?L108
	EQUAL? PRSA,V?UNSCRIPT,V?VERBOSE,V?BRIEF /?L108
	EQUAL? PRSA,V?SUPER-BRIEF /?L108
	ZERO? P-OFLAG /?L108
?L108:	EQUAL? V,M-FATAL \?L113
	SET 'P-CONT,0
	JUMP ?L113
?L1:	SET 'P-CONT,0
?L113:	ZERO? P-WON /FALSE
	CALL NO-CLOCK-VERB? >STACK
	ZERO? STACK \?L118
	CALL CLOCKER >V
?L118:	SET 'PRSA,0
	SET 'PRSO,0
	SET 'PRSI,0
	RETURN PRSI

	.FUNCT NO-CLOCK-VERB?
	EQUAL? PRSA,V?TELL \?L1
	ZERO? P-CONT \TRUE
?L1:	EQUAL? PRSA,V?BRIEF,V?SUPER-BRIEF,V?VERBOSE /TRUE
	EQUAL? PRSA,V?VERSION,V?QUIT,V?SCORE /TRUE
	EQUAL? PRSA,V?SAVE,V?RESTORE,V?SCRIPT /TRUE
	EQUAL? PRSA,V?UNSCRIPT,V?HELP,V?RESTART /TRUE
	EQUAL? PRSA,V?$0024VERIFY,V?TIME,V?$0024RANDOM /TRUE
	EQUAL? PRSA,V?$0024COMMAND,V?$0024RECORD,V?$0024UNRECORD /TRUE
	RFALSE

	.FUNCT MULTIPLE-EXCEPTION?,OBJ1,L
	LOC OBJ1 >L
	EQUAL? OBJ1,NOT-HERE-OBJECT \?L1
	INC 'P-NOT-HERE
	RTRUE
?L1:	EQUAL? PRSA,V?TAKE \?L3
	ZERO? PRSI /?L3
	IN? PRSO,PRSI \TRUE
?L3:	CALL ACCESSIBLE?,OBJ1 >STACK
	ZERO? STACK /TRUE
	EQUAL? P-GETFLAGS,P-ALL \FALSE
	EQUAL? PRSA,V?TAKE \?L10
	EQUAL? L,WINNER,HERE,PRSI /?L9
	LOC WINNER >STACK
	EQUAL? L,STACK /?L9
	FSET? L,SURFACEBIT /?L9
	FSET? L,SEARCHBIT \TRUE
?L9:	FSET? OBJ1,TAKEBIT /?L6
	FSET? OBJ1,TRYTAKEBIT \TRUE
?L6:	EQUAL? PRSA,V?TAKE \?L10
	ZERO? PRSI \?L10
	CALL HELD?,PRSO >STACK
	ZERO? STACK \TRUE
?L10:	EQUAL? PRSA,V?DROP \?L11
	IN? OBJ1,WINNER \TRUE
?L11:	ZERO? PRSI /?L12
	EQUAL? PRSO,PRSI /TRUE
?L12:	EQUAL? PRSA,V?PUT \?L13
	IN? PRSO,WINNER /?L13
	CALL HELD?,PRSO,PRSI >STACK
	ZERO? STACK \TRUE
?L13:	FSET? PRSO,SPELLBIT \FALSE
	EQUAL? PRSA,V?LEARN,V?GNUSTO,V?CAST /FALSE
	EQUAL? PRSA,V?READ \TRUE
	RFALSE

	.FUNCT FAKE-ORPHAN,TMP
	CALL ORPHAN,P-SYNTAX,0
	PRINTI "What do you want to "
	GET P-OTBL,P-VERBN >TMP
	ZERO? TMP \?L1
	PRINTI "tell"
	JUMP ?L4
?L1:	GETB P-VTBL,2 >STACK
	ZERO? STACK \?L3
	GET TMP,0 >STACK
	PRINTB STACK
	JUMP ?L4
?L3:	GETB TMP,3 >STACK
	GETB TMP,2 >STACK
	CALL WORD-PRINT,STACK,STACK
	PUTB P-VTBL,2,0
?L4:	SET 'P-OFLAG,1
	SET 'P-WON,0
	GETB P-SYNTAX,P-SPREP1 >STACK
	CALL PREP-PRINT,STACK
	PRINTR "?"

	.FUNCT PERFORM,A,O=0,I=0,V,OA,OO,OI,CNT
	SET 'OA,PRSA
	SET 'OO,PRSO
	SET 'OI,PRSI
	SET 'PRSA,A
	EQUAL? IT,I,O \?L1
	ZERO? I \?L3
	CALL FAKE-ORPHAN
	RETURN 2
?L3:	PRINT REFERRING
	CRLF
	RETURN 2
?L1:	ZERO? O /?L8
	EQUAL? PRSA,V?WALK /?L8
	EQUAL? O,NOT-HERE-OBJECT /?L8
	CALL THIS-IS-IT,O
?L8:	SET 'PRSO,O
	SET 'PRSI,I
	EQUAL? A,V?WALK /?L10
	EQUAL? NOT-HERE-OBJECT,PRSO,PRSI \?L10
	CALL NOT-HERE-OBJECT-F >V
	ZERO? V /?L10
	SET 'P-WON,0
	JUMP ?L21
?L10:	SET 'O,PRSO
	SET 'I,PRSI
	GETP WINNER,P?ACTION >STACK
	CALL STACK >V
	ZERO? V \?L21
	LOC WINNER >STACK
	EQUAL? STACK,HERE /?L15
	LOC WINNER >STACK
	GETP STACK,P?ACTION >STACK
	CALL STACK,M-BEG >V
	ZERO? V \?L21
?L15:	GETP HERE,P?ACTION >STACK
	CALL STACK,M-BEG >V
	ZERO? V \?L21
	GET PREACTIONS,A >STACK
	CALL STACK >V
	ZERO? V \?L21
	ZERO? I /?L18
	GETP I,P?ACTION >STACK
	CALL STACK >V
	ZERO? V \?L21
?L18:	ZERO? O /?L20
	EQUAL? A,V?WALK /?L19
	LOC O >STACK
	ZERO? STACK /?L19
	LOC O >STACK
	GETP STACK,P?CONTFCN >STACK
	ZERO? STACK /?L19
	LOC O >STACK
	GETP STACK,P?CONTFCN >STACK
	CALL STACK,M-CONTAINER >V
	ZERO? V \?L21
?L19:	ZERO? O /?L20
	EQUAL? A,V?WALK /?L20
	GETP O,P?ACTION >STACK
	CALL STACK >V
	ZERO? V \?L21
?L20:	GET ACTIONS,A >STACK
	CALL STACK >V
	ZERO? V /?L21
?L21:	ZERO? SPELL-CAST /?L23
	GETP SPELL-CAST,P?COUNT >CNT
	GRTR? CNT,0 \?L25
	SUB CNT,1 >STACK
	PUTP SPELL-CAST,P?COUNT,STACK
?L25:	LESS? SPELL-ROOM,SPELL-MAX \?L28
	INC 'SPELL-ROOM
?L28:	SET 'SPELL-CAST,0
?L23:	SET 'PRSA,OA
	SET 'PRSO,OO
	SET 'PRSI,OI
	RETURN V

	.FUNCT DEQUEUE,RTN
	CALL QUEUED?,RTN >RTN
	ZERO? RTN /FALSE
	PUT RTN,C-RTN,0
	RTRUE

	.FUNCT QUEUED?,RTN,C,E
	ADD C-TABLE,C-TABLELEN >E
	ADD C-TABLE,C-INTS >C
?L1:	EQUAL? C,E /FALSE
	GET C,C-RTN >STACK
	EQUAL? STACK,RTN \?L8
	GET C,C-TICK >STACK
	ZERO? STACK /FALSE
	RETURN C
?L8:	ADD C,C-INTLEN >C
	JUMP ?L1

	.FUNCT QUEUE,RTN,TICK,C,E,INT=0
	ADD C-TABLE,C-TABLELEN >E
	ADD C-TABLE,C-INTS >C
?L1:	EQUAL? C,E \?L3
	ZERO? INT /?L5
	SET 'C,INT
	JUMP ?L7
?L5:	SUB C-INTS,C-INTLEN >C-INTS
	ADD C-TABLE,C-INTS >INT
?L7:	PUT INT,C-RTN,RTN
	JUMP ?L2
?L3:	GET C,C-RTN >STACK
	EQUAL? STACK,RTN \?L8
	SET 'INT,C
	JUMP ?L2
?L8:	GET C,C-RTN >STACK
	ZERO? STACK \?L9
	SET 'INT,C
?L9:	ADD C,C-INTLEN >C
	JUMP ?L1
?L2:	GRTR? INT,CLOCK-HAND \?L11
	ADD TICK,3 >STACK
	SUB 0,STACK >TICK
?L11:	PUT INT,C-TICK,TICK
	RETURN INT

	.FUNCT CLOCKER,E,TICK,RTN,FLG=0,Q?=0,OWINNER
	ZERO? CLOCK-WAIT /?L1
	SET 'CLOCK-WAIT,0
	RFALSE
?L1:	ADD C-TABLE,C-INTS >CLOCK-HAND
	ADD C-TABLE,C-TABLELEN >E
	SET 'OWINNER,WINNER
	SET 'WINNER,PLAYER
?L4:	EQUAL? CLOCK-HAND,E \?L6
	SET 'CLOCK-HAND,E
	INC 'MOVES
	SET 'WINNER,OWINNER
	RETURN FLG
?L6:	GET CLOCK-HAND,C-RTN >STACK
	ZERO? STACK /?L26
	GET CLOCK-HAND,C-TICK >TICK
	LESS? TICK,-1 \?L9
	SUB 0,TICK >STACK
	SUB STACK,3 >STACK
	PUT CLOCK-HAND,C-TICK,STACK
	SET 'Q?,CLOCK-HAND
	JUMP ?L26
?L9:	ZERO? TICK /?L26
	GRTR? TICK,0 \?L12
	DEC 'TICK
	PUT CLOCK-HAND,C-TICK,TICK
?L12:	ZERO? TICK /?L15
	SET 'Q?,CLOCK-HAND
?L15:	GRTR? TICK,0 /?L26
	GET CLOCK-HAND,C-RTN >RTN
	ZERO? TICK \?L20
	PUT CLOCK-HAND,C-RTN,0
?L20:	CALL RTN >STACK
	ZERO? STACK /?L23
	SET 'FLG,1
?L23:	ZERO? Q? \?L26
	GET CLOCK-HAND,C-RTN >STACK
	ZERO? STACK /?L26
	SET 'Q?,1
?L26:	ADD CLOCK-HAND,C-INTLEN >CLOCK-HAND
	ZERO? Q? \?L4
	ADD C-INTS,C-INTLEN >C-INTS
	JUMP ?L4

	.FUNCT PARSER,PTR=P-LEXSTART,WRD,VAL=0,VERB=0,OF-FLAG=0,OWINNER,OMERGED,LEN,DIR=0,NW=0,LW=0,CNT=-1
?L1:	IGRTR? 'CNT,P-ITBLLEN /?L2
	ZERO? P-OFLAG \?L6
	GET P-ITBL,CNT >STACK
	PUT P-OTBL,CNT,STACK
?L6:	PUT P-ITBL,CNT,0
	JUMP ?L1
?L2:	SET 'OWINNER,WINNER
	SET 'OMERGED,P-MERGED
	SET 'P-ADVERB,0
	SET 'P-MERGED,0
	SET 'P-END-ON-PREP,0
	PUT P-PRSO,P-MATCHLEN,0
	PUT P-PRSI,P-MATCHLEN,0
	PUT P-BUTS,P-MATCHLEN,0
	ZERO? QUOTE-FLAG \?L9
	EQUAL? WINNER,PLAYER /?L9
	SET 'WINNER,PLAYER
	LOC WINNER >STACK
	FSET? STACK,VEHBIT /?L11
	LOC WINNER >HERE
?L11:	CALL LIT?,HERE >LIT
?L9:	ZERO? RESERVE-PTR /?L15
	SET 'PTR,RESERVE-PTR
	CALL STUFF,RESERVE-LEXV,P-LEXV
	ZERO? VERBOSITY /?L17
	EQUAL? PLAYER,WINNER \?L17
	CRLF
?L17:	SET 'RESERVE-PTR,0
	SET 'P-CONT,0
	JUMP ?L24
?L15:	ZERO? P-CONT /?L20
	SET 'PTR,P-CONT
	ZERO? VERBOSITY /?L21
	EQUAL? PLAYER,WINNER \?L21
	CRLF
?L21:	SET 'P-CONT,0
	JUMP ?L24
?L20:	SET 'WINNER,PLAYER
	SET 'QUOTE-FLAG,0
	LOC WINNER >STACK
	FSET? STACK,VEHBIT /?L25
	LOC WINNER >HERE
?L25:	CALL LIT?,HERE >LIT
	ZERO? VERBOSITY /?L28
	CRLF
?L28:	PRINTI ">"
	READ P-INBUF,P-LEXV
?L24:	GETB P-LEXV,P-LEXWORDS >P-LEN
	ZERO? P-LEN \?L31
	CALL BEG-PARDON
	RFALSE
?L31:	GET P-LEXV,PTR >WRD
	EQUAL? WRD,W?OOPS \?L34
	ADD PTR,P-LEXELEN >STACK
	GET P-LEXV,STACK >STACK
	EQUAL? STACK,W?$PERIOD,W?$COMMA \?L36
	ADD PTR,P-LEXELEN >PTR
	DEC 'P-LEN
?L36:	GRTR? P-LEN,1 /?L39
	PRINTI "I can't help your clumsiness."
	CRLF
	RFALSE
?L39:	GET OOPS-TABLE,O-PTR >STACK
	ZERO? STACK /?L41
	GRTR? P-LEN,2 \?L44
	ADD PTR,P-LEXELEN >STACK
	GET P-LEXV,STACK >STACK
	EQUAL? STACK,W?$QUOTE \?L42
	PRINTI "Sorry, you can't correct mistakes in quoted text."
	CRLF
	RFALSE
?L42:	GRTR? P-LEN,2 \?L44
	PRINTI "Warning: only the first word after OOPS is used."
	CRLF
?L44:	ADD PTR,P-LEXELEN >STACK
	GET P-LEXV,STACK >STACK
	GET OOPS-TABLE,O-PTR >STACK
	PUT AGAIN-LEXV,STACK,STACK
	SET 'WINNER,OWINNER
	GET OOPS-TABLE,O-PTR >STACK
	MUL STACK,P-LEXELEN >STACK
	ADD STACK,3 >STACK
	MUL PTR,P-LEXELEN >STACK
	ADD STACK,7 >STACK
	GETB P-LEXV,STACK >STACK
	MUL PTR,P-LEXELEN >STACK
	ADD STACK,6 >STACK
	GETB P-LEXV,STACK >STACK
	CALL INBUF-ADD,STACK,STACK,STACK
	CALL STUFF,AGAIN-LEXV,P-LEXV
	GETB P-LEXV,P-LEXWORDS >P-LEN
	GET OOPS-TABLE,O-START >PTR
	CALL INBUF-STUFF,OOPS-INBUF,P-INBUF
	JUMP ?L47
?L41:	PUT OOPS-TABLE,O-END,0
	PRINTI "There was no word to replace!"
	CRLF
	RFALSE
?L34:	EQUAL? WRD,W?AGAIN,W?G /?L48
	SET 'P-QWORD,0
	SET 'P-NUMBER,0
?L48:	PUT OOPS-TABLE,O-END,0
?L47:	GET P-LEXV,PTR >STACK
	EQUAL? STACK,W?AGAIN,W?G \?L51
	GETB OOPS-INBUF,1 >STACK
	ZERO? STACK \?L53
	CALL BEG-PARDON
	RFALSE
?L53:	ZERO? P-OFLAG /?L55
	PRINTI "It's difficult to repeat fragments."
	CRLF
	RFALSE
?L55:	ZERO? P-WON \?L56
	PRINTI "That would just repeat a mistake."
	CRLF
	RFALSE
?L56:	GRTR? P-LEN,1 \?L57
	ADD PTR,P-LEXELEN >STACK
	GET P-LEXV,STACK >STACK
	EQUAL? STACK,W?$PERIOD,W?$COMMA,W?THEN /?L60
	ADD PTR,P-LEXELEN >STACK
	GET P-LEXV,STACK >STACK
	EQUAL? STACK,W?AND \?L58
?L60:	ADD PTR,4 >PTR
	GETB P-LEXV,P-LEXWORDS >STACK
	SUB STACK,2 >STACK
	PUTB P-LEXV,P-LEXWORDS,STACK
	JUMP ?L62
?L58:	PRINTI "I couldn't understand that sentence."
	CRLF
	RFALSE
?L57:	ADD PTR,P-LEXELEN >PTR
	GETB P-LEXV,P-LEXWORDS >STACK
	DEC 'STACK
	PUTB P-LEXV,P-LEXWORDS,STACK
?L62:	GETB P-LEXV,P-LEXWORDS >STACK
	GRTR? STACK,0 \?L63
	CALL STUFF,P-LEXV,RESERVE-LEXV
	SET 'RESERVE-PTR,PTR
	JUMP ?L65
?L63:	SET 'RESERVE-PTR,0
?L65:	SET 'WINNER,OWINNER
	SET 'P-MERGED,OMERGED
	CALL INBUF-STUFF,OOPS-INBUF,P-INBUF
	CALL STUFF,AGAIN-LEXV,P-LEXV
	SET 'CNT,-1
	SET 'DIR,AGAIN-DIR
?L66:	IGRTR? 'CNT,P-ITBLLEN /?L73
	GET P-OTBL,CNT >STACK
	PUT P-ITBL,CNT,STACK
	JUMP ?L66
?L51:	CALL STUFF,P-LEXV,AGAIN-LEXV
	CALL INBUF-STUFF,P-INBUF,OOPS-INBUF
	PUT OOPS-TABLE,O-START,PTR
	MUL 4,P-LEN >STACK
	PUT OOPS-TABLE,O-LENGTH,STACK
	GETB P-LEXV,P-LEXWORDS >STACK
	MUL P-LEXELEN,STACK >STACK
	ADD PTR,STACK >STACK
	MUL 2,STACK >LEN
	SUB LEN,2 >STACK
	GETB P-LEXV,STACK >STACK
	SUB LEN,1 >STACK
	GETB P-LEXV,STACK >STACK
	ADD STACK,STACK >STACK
	PUT OOPS-TABLE,O-END,STACK
	SET 'RESERVE-PTR,0
	SET 'LEN,P-LEN
	SET 'P-NCN,0
	SET 'P-GETFLAGS,0
?L72:	DLESS? 'P-LEN,0 \?L74
	SET 'QUOTE-FLAG,0
	JUMP ?L73
?L74:	CALL KNOWN-WORD?,PTR,VERB >WRD
	ZERO? WRD /?L76
	ZERO? P-LEN \?L77
	SET 'NW,0
	JUMP ?L79
?L77:	ADD PTR,P-LEXELEN >STACK
	GET P-LEXV,STACK >NW
?L79:	EQUAL? WRD,W?TO \?L80
	EQUAL? VERB,ACT?TELL,ACT?ASK \?L80
	CALL WT?,NW,PS?VERB,P1?VERB >STACK
	ZERO? STACK /?L80
	PUT P-ITBL,P-VERB,ACT?TELL
	SET 'WRD,W?$QUOTE
	JUMP ?L85
?L80:	EQUAL? WRD,W?THEN \?L85
	GRTR? P-LEN,0 \?L85
	ZERO? VERB \?L85
	ZERO? QUOTE-FLAG \?L85
	EQUAL? LW,0,W?$PERIOD \?L83
	SET 'WRD,W?THE
	JUMP ?L85
?L83:	PUT P-ITBL,P-VERB,ACT?TELL
	PUT P-ITBL,P-VERBN,0
	SET 'WRD,W?$QUOTE
?L85:	EQUAL? WRD,W?THEN,W?$PERIOD,W?$QUOTE \?L87
	EQUAL? WRD,W?$QUOTE \?L98
	GET P-LEXV,PTR >STACK
	EQUAL? STACK,W?$QUOTE \?L91
	EQUAL? VERB,ACT?TELL,ACT?SAY \?L93
	EQUAL? WINNER,PLAYER /?L91
?L93:	CALL QUOTED-PHRASE,PTR,VERB >STACK
	ZERO? STACK /FALSE
	ADD PTR,P-LEXELEN >PTR
	JUMP ?L72
?L91:	ZERO? QUOTE-FLAG /?L97
	SET 'QUOTE-FLAG,0
	JUMP ?L98
?L97:	SET 'QUOTE-FLAG,1
?L98:	ZERO? P-LEN /?L100
	ADD PTR,P-LEXELEN >P-CONT
?L100:	PUTB P-LEXV,P-LEXWORDS,P-LEN
	JUMP ?L73
?L87:	CALL WT?,WRD,PS?DIRECTION,P1?DIRECTION >VAL
	ZERO? VAL /?L102
	EQUAL? VERB,0,ACT?WALK \?L102
	EQUAL? LEN,1 /?L103
	EQUAL? LEN,2 \?L104
	EQUAL? VERB,ACT?WALK /?L103
?L104:	EQUAL? NW,W?THEN,W?$PERIOD,W?$QUOTE \?L105
	LESS? LEN,2 \?L103
?L105:	ZERO? QUOTE-FLAG /?L106
	EQUAL? LEN,2 \?L106
	EQUAL? NW,W?$QUOTE /?L103
?L106:	GRTR? LEN,2 \?L102
	EQUAL? NW,W?$COMMA,W?AND \?L102
?L103:	SET 'DIR,VAL
	EQUAL? NW,W?$COMMA,W?AND \?L107
	ADD PTR,P-LEXELEN >STACK
	CALL CHANGE-LEXV,STACK,W?THEN
?L107:	GRTR? LEN,2 /?L139
	SET 'QUOTE-FLAG,0
	JUMP ?L73
?L102:	CALL WT?,WRD,PS?VERB,P1?VERB >VAL
	ZERO? VAL /?L113
	ZERO? VERB \?L113
	SET 'VERB,VAL
	PUT P-ITBL,P-VERB,VAL
	PUT P-ITBL,P-VERBN,P-VTBL
	PUT P-VTBL,0,WRD
	MUL PTR,2 >STACK
	ADD STACK,2 >CNT
	GETB P-LEXV,CNT >STACK
	PUTB P-VTBL,2,STACK
	ADD CNT,1 >STACK
	GETB P-LEXV,STACK >STACK
	PUTB P-VTBL,3,STACK
	JUMP ?L139
?L113:	CALL WT?,WRD,PS?PREPOSITION,0 >VAL
	ZERO? VAL \?L115
	EQUAL? WRD,W?ALL,W?ONE,W?BOTH /?L116
	CALL WT?,WRD,PS?ADJECTIVE >STACK
	ZERO? STACK \?L116
	CALL WT?,WRD,PS?OBJECT >STACK
	ZERO? STACK /?L114
?L116:	SET 'VAL,0
?L115:	GRTR? P-LEN,1 \?L117
	EQUAL? NW,W?OF \?L117
	ZERO? VAL \?L149
	EQUAL? WRD,W?ALL,W?ONE,W?A /?L117
	EQUAL? WRD,W?BOTH /?L117
	SET 'OF-FLAG,1
	JUMP ?L139
?L117:	ZERO? VAL /?L119
?L149:	ZERO? P-LEN /?L120
	EQUAL? NW,W?THEN,W?$PERIOD \?L119
?L120:	SET 'P-END-ON-PREP,1
	LESS? P-NCN,2 \?L139
	PUT P-ITBL,P-PREP1,VAL
	PUT P-ITBL,P-PREP1N,WRD
	JUMP ?L139
?L119:	EQUAL? P-NCN,2 \?L124
	PRINTI "There were too many nouns in that sentence."
	CRLF
	RFALSE
?L124:	INC 'P-NCN
	SET 'P-ACT,VERB
	CALL CLAUSE,PTR,VAL,WRD >PTR
	ZERO? PTR /FALSE
	LESS? PTR,0 \?L139
	SET 'QUOTE-FLAG,0
	JUMP ?L73
?L114:	EQUAL? WRD,W?OF \?L131
	ZERO? OF-FLAG /?L134
	EQUAL? NW,W?$PERIOD,W?THEN \?L132
?L134:	CALL CANT-USE,PTR
	RFALSE
?L132:	SET 'OF-FLAG,0
	JUMP ?L139
?L131:	CALL WT?,WRD,PS?BUZZ-WORD >STACK
	ZERO? STACK \?L139
	EQUAL? VERB,ACT?TELL \?L137
	CALL WT?,WRD,PS?VERB,P1?VERB >STACK
	ZERO? STACK /?L137
	EQUAL? WINNER,PLAYER \?L137
	PRINTI "Please consult your manual for the correct way to talk to characters."
	CRLF
	RFALSE
?L137:	CALL CANT-USE,PTR
	RFALSE
?L76:	CALL UNKNOWN-WORD,PTR
	RFALSE
?L139:	SET 'LW,WRD
	ADD PTR,P-LEXELEN >PTR
	JUMP ?L72
?L73:	PUT OOPS-TABLE,O-PTR,0
	ZERO? DIR /?L140
	SET 'PRSA,V?WALK
	SET 'PRSO,DIR
	SET 'P-OFLAG,0
	SET 'P-WALK-DIR,DIR
	SET 'AGAIN-DIR,DIR
	RETURN AGAIN-DIR
?L140:	ZERO? P-OFLAG /?L143
	CALL ORPHAN-MERGE
?L143:	SET 'P-WALK-DIR,0
	SET 'AGAIN-DIR,0
	CALL SYNTAX-CHECK >STACK
	ZERO? STACK /FALSE
	CALL SNARF-OBJECTS >STACK
	ZERO? STACK /FALSE
	CALL MANY-CHECK >STACK
	ZERO? STACK /FALSE
	CALL TAKE-CHECK >STACK
	ZERO? STACK \TRUE
	RFALSE

	.FUNCT BEG-PARDON
	PRINTR "I beg your pardon?"

	.FUNCT KNOWN-WORD?,PTR,VERB=0,WRD=0
	GET P-LEXV,PTR >WRD
	ZERO? WRD \?L1
	CALL QUOTED-WORD?,PTR,VERB >WRD
	ZERO? WRD \?L1
	CALL NUMBER?,PTR >WRD
?L1:	RETURN WRD

	.FUNCT CHANGE-LEXV,PTR,WRD
	PUT P-LEXV,PTR,WRD
	PUT AGAIN-LEXV,PTR,WRD
	RTRUE

	.FUNCT STUFF,SRC,DEST,MAX=29,PTR=P-LEXSTART,CTR=1,BPTR
	GETB SRC,0 >STACK
	PUTB DEST,0,STACK
	GETB SRC,1 >STACK
	PUTB DEST,1,STACK
?L1:	GET SRC,PTR >STACK
	PUT DEST,PTR,STACK
	MUL PTR,2 >STACK
	ADD STACK,2 >BPTR
	GETB SRC,BPTR >STACK
	PUTB DEST,BPTR,STACK
	MUL PTR,2 >STACK
	ADD STACK,3 >BPTR
	GETB SRC,BPTR >STACK
	PUTB DEST,BPTR,STACK
	ADD PTR,P-LEXELEN >PTR
	IGRTR? 'CTR,MAX \?L1
	RTRUE

	.FUNCT INBUF-STUFF,SRC,DEST,CNT
	GETB SRC,0 >STACK
	SUB STACK,1 >CNT
?L1:	GETB SRC,CNT >STACK
	PUTB DEST,CNT,STACK
	DLESS? 'CNT,0 \?L1
	RTRUE

	.FUNCT INBUF-ADD,LEN,BEG,SLOT,DBEG,CTR=0,TMP,?TMP
	GET OOPS-TABLE,O-END >TMP
	ZERO? TMP /?L1
	SET 'DBEG,TMP
	JUMP ?L3
?L1:	GET OOPS-TABLE,O-LENGTH >TMP
	GETB AGAIN-LEXV,TMP >?TMP
	ADD TMP,1 >STACK
	GETB AGAIN-LEXV,STACK >STACK
	ADD ?TMP,STACK >DBEG
?L3:	ADD DBEG,LEN >STACK
	PUT OOPS-TABLE,O-END,STACK
?L4:	ADD BEG,CTR >STACK
	GETB P-INBUF,STACK >STACK
	ADD DBEG,CTR >STACK
	PUTB OOPS-INBUF,STACK,STACK
	INC 'CTR
	EQUAL? CTR,LEN \?L4
	PUTB AGAIN-LEXV,SLOT,DBEG
	SUB SLOT,1 >STACK
	PUTB AGAIN-LEXV,STACK,LEN
	RTRUE

	.FUNCT WT?,PTR,BIT,B1=5,OFFS=P-P1OFF,TYP
	GETB PTR,P-PSOFF >TYP
	BTST TYP,BIT \FALSE
	GRTR? B1,4 /TRUE
	BAND TYP,P-P1BITS >TYP
	EQUAL? TYP,B1 /?L6
	INC 'OFFS
?L6:	GETB PTR,OFFS >STACK
	RSTACK

	.FUNCT CLAUSE,PTR,VAL,WRD,OFF,NUM,ANDFLG=0,1ST?=1,NW,LW=0
	SUB P-NCN,1 >STACK
	MUL STACK,2 >OFF
	ZERO? VAL /?L1
	ADD P-PREP1,OFF >NUM
	PUT P-ITBL,NUM,VAL
	ADD NUM,1 >STACK
	PUT P-ITBL,STACK,WRD
	ADD PTR,P-LEXELEN >PTR
	JUMP ?L3
?L1:	INC 'P-LEN
?L3:	ZERO? P-LEN \?L4
	DEC 'P-NCN
	RETURN -1
?L4:	ADD P-NC1,OFF >NUM
	MUL PTR,2 >STACK
	ADD P-LEXV,STACK >STACK
	PUT P-ITBL,NUM,STACK
	GET P-LEXV,PTR >STACK
	EQUAL? STACK,W?THE,W?A,W?AN /?L9
	GET P-LEXV,PTR >STACK
	EQUAL? STACK,W?$0024BUZZ \?L7
?L9:	GET P-ITBL,NUM >STACK
	ADD STACK,4 >STACK
	PUT P-ITBL,NUM,STACK
?L7:	DLESS? 'P-LEN,0 \?L13
	MUL PTR,2 >STACK
	ADD P-LEXV,STACK >STACK
	ADD NUM,1 >STACK
	PUT P-ITBL,STACK,STACK
	RETURN -1
?L13:	CALL KNOWN-WORD?,PTR >WRD
	ZERO? WRD /?L16
	ZERO? P-LEN \?L18
	SET 'NW,0
	JUMP ?L20
?L18:	ADD PTR,P-LEXELEN >STACK
	GET P-LEXV,STACK >NW
?L20:	EQUAL? WRD,W?$QUOTE \?L21
	EQUAL? P-ACT,ACT?TELL,ACT?SAY /?L21
	CALL QUOTED-PHRASE,PTR,P-ACT >STACK
	ZERO? STACK /FALSE
	ADD PTR,P-LEXELEN >PTR
	JUMP ?L7
?L21:	EQUAL? WRD,W?AND,W?$COMMA \?L26
	SET 'ANDFLG,1
	JUMP ?L46
?L26:	EQUAL? WRD,W?ALL,W?ONE,W?BOTH \?L27
	EQUAL? NW,W?OF \?L46
	DEC 'P-LEN
	ADD PTR,P-LEXELEN >PTR
	JUMP ?L46
?L27:	EQUAL? WRD,W?THEN,W?$PERIOD /?L32
	CALL WT?,WRD,PS?PREPOSITION >STACK
	ZERO? STACK /?L31
	GET P-ITBL,P-VERB >STACK
	ZERO? STACK /?L31
	ZERO? 1ST? \?L31
?L32:	INC 'P-LEN
	MUL PTR,2 >STACK
	ADD P-LEXV,STACK >STACK
	ADD NUM,1 >STACK
	PUT P-ITBL,STACK,STACK
	SUB PTR,P-LEXELEN >STACK
	RSTACK
?L31:	ZERO? ANDFLG /?L33
	GET P-ITBL,P-VERB >STACK
	ZERO? STACK \?L33
	SUB PTR,4 >PTR
	ADD PTR,2 >STACK
	CALL CHANGE-LEXV,STACK,W?THEN
	ADD P-LEN,2 >P-LEN
	JUMP ?L46
?L33:	CALL WT?,WRD,PS?OBJECT >STACK
	ZERO? STACK /?L34
	GRTR? P-LEN,0 \?L35
	EQUAL? NW,W?OF \?L35
	EQUAL? WRD,W?ALL,W?ONE \?L46
?L35:	CALL WT?,WRD,PS?ADJECTIVE,P1?ADJECTIVE >STACK
	ZERO? STACK /?L37
	ZERO? NW /?L37
	CALL WT?,NW,PS?OBJECT >STACK
	ZERO? STACK \?L46
	CALL WT?,NW,PS?ADJECTIVE >STACK
	ZERO? STACK \?L46
?L37:	EQUAL? WRD,W?FORBURN \?L39
	EQUAL? NW,W?THE,W?WILY /?L46
?L39:	ZERO? ANDFLG \?L40
	EQUAL? NW,W?BUT,W?EXCEPT,W?AND /?L40
	EQUAL? NW,W?$COMMA /?L40
	ADD PTR,2 >STACK
	MUL STACK,2 >STACK
	ADD P-LEXV,STACK >STACK
	ADD NUM,1 >STACK
	PUT P-ITBL,STACK,STACK
	RETURN PTR
?L40:	SET 'ANDFLG,0
	JUMP ?L46
?L34:	CALL WT?,WRD,PS?ADJECTIVE >STACK
	ZERO? STACK \?L46
	CALL WT?,WRD,PS?BUZZ-WORD >STACK
	ZERO? STACK \?L46
	CALL WT?,WRD,PS?PREPOSITION >STACK
	ZERO? STACK \?L46
	CALL CANT-USE,PTR
	RFALSE
?L16:	CALL UNKNOWN-WORD,PTR
	RFALSE
?L46:	SET 'LW,WRD
	SET '1ST?,0
	ADD PTR,P-LEXELEN >PTR
	JUMP ?L7

	.FUNCT NUMBER?,PTR,CNT,BPTR,CHR,SUM=0
	MUL PTR,2 >STACK
	ADD P-LEXV,STACK >STACK
	GETB STACK,2 >CNT
	MUL PTR,2 >STACK
	ADD P-LEXV,STACK >STACK
	GETB STACK,3 >BPTR
?L1:	DLESS? 'CNT,0 /?L2
	GETB P-INBUF,BPTR >CHR
	GRTR? SUM,10000 /FALSE
	LESS? CHR,58 \FALSE
	GRTR? CHR,47 \FALSE
	SUB CHR,48 >STACK
	MUL SUM,10 >STACK
	ADD STACK,STACK >SUM
	INC 'BPTR
	JUMP ?L1
?L2:	CALL CHANGE-LEXV,PTR,W?INTNUM
	GRTR? SUM,10000 /FALSE
	SET 'P-NUMBER,SUM
	RETURN W?INTNUM

	.FUNCT QUOTED-PHRASE,PTR,VERB,LEN,1ST?=1,WRD,BPTR
	CALL CHANGE-LEXV,PTR,W?$0024BUZZ
	SUB P-LEN,1 >LEN
	ADD PTR,P-LEXELEN >PTR
	MUL PTR,2 >STACK
	ADD P-LEXV,STACK >BPTR
?L1:	LESS? LEN,0 \?L3
	PRINTI "You forgot a second quote."
	CRLF
	RFALSE
?L3:	GET P-LEXV,PTR >WRD
	EQUAL? WRD,W?$QUOTE \?L5
	CALL CHANGE-LEXV,PTR,W?$0024BUZZ
	RTRUE
?L5:	ZERO? 1ST? /?L6
	ZERO? WRD /?L7
	EQUAL? VERB,ACT?SAY,ACT?ANSWER /?L11
?L7:	CALL QUOTED-WORD?,PTR,VERB >STACK
	ZERO? STACK /?L9
	SET '1ST?,0
	JUMP ?L11
?L9:	PRINTI "There isn't anything here with """
	GETB BPTR,3 >STACK
	GETB BPTR,2 >STACK
	CALL WORD-PRINT,STACK,STACK
	PRINTI """ written on it."
	CRLF
	RFALSE
?L6:	CALL CHANGE-LEXV,PTR,W?$0024BUZZ
?L11:	ADD PTR,P-LEXELEN >PTR
	DEC 'LEN
	JUMP ?L1

	.FUNCT QUOTED-WORD?,PTR,VERB=0,QPTR,WRD
	EQUAL? VERB,ACT?WRITE \?L1
	ZERO? P-QWORD \?L1
	SET 'P-QWORD,PTR
	SET 'WRD,W?QWORD
	JUMP ?L3
?L1:	CALL KNOWN-NAME?,PTR >WRD
	ZERO? WRD /FALSE
?L3:	CALL CHANGE-LEXV,PTR,WRD
	RETURN WRD

	.FUNCT KNOWN-NAME?,PTR,WRD,QPTR
	SET 'QPTR,P-QBUF
?L1:	GET QPTR,0 >WRD
	ZERO? WRD /FALSE
	CALL MATCH?,PTR,QPTR >STACK
	ZERO? STACK \?L2
	ADD QPTR,10 >QPTR
	JUMP ?L1
?L2:	RETURN WRD

	.FUNCT MATCH?,PTR,QPTR,CNT,BPTR,QCNT
	MUL PTR,2 >STACK
	ADD P-LEXV,STACK >PTR
	GETB PTR,2 >CNT
	GRTR? CNT,6 \?L1
	SET 'CNT,6
?L1:	GETB PTR,3 >BPTR
	GET QPTR,1 >QCNT
	ADD QPTR,4 >QPTR
?L4:	ZERO? CNT \?L6
	GRTR? QCNT,0 \TRUE
	RFALSE
?L6:	GETB QPTR,0 >STACK
	GETB P-INBUF,BPTR >STACK
	EQUAL? STACK,STACK \FALSE
	DLESS? 'QCNT,0 /FALSE
	DEC 'CNT
	INC 'QPTR
	INC 'BPTR
	JUMP ?L4

	.FUNCT QCOPY,WRD,PTR,QPTR,CNT,BPTR,QCNT=6
	MUL PTR,2 >STACK
	ADD P-LEXV,STACK >STACK
	GETB STACK,2 >CNT
	GRTR? CNT,6 \?L1
	SET 'CNT,6
?L1:	MUL PTR,2 >STACK
	ADD P-LEXV,STACK >STACK
	GETB STACK,3 >BPTR
	PUT QPTR,0,WRD
	PUT QPTR,1,CNT
	ADD QPTR,4 >QPTR
?L4:	DLESS? 'CNT,0 \?L6
	PUTB QPTR,0,0
	JUMP ?L8
?L6:	GETB P-INBUF,BPTR >STACK
	PUTB QPTR,0,STACK
	INC 'BPTR
	INC 'QPTR
?L8:	DEC 'QCNT
	ZERO? QCNT \?L4
	RTRUE

	.FUNCT ORPHAN-MERGE,CNT=-1,TEMP,VERB,BEG,END,ADJ=0,WRD,?TMP
	SET 'P-OFLAG,0
	GET P-ITBL,P-VERBN >STACK
	GET STACK,0 >WRD
	CALL WT?,WRD,PS?VERB,P1?VERB >?TMP
	GET P-OTBL,P-VERB >STACK
	EQUAL? ?TMP,STACK /?L3
	CALL WT?,WRD,PS?ADJECTIVE >STACK
	ZERO? STACK /?L1
?L3:	SET 'ADJ,1
	JUMP ?L4
?L1:	CALL WT?,WRD,PS?OBJECT,P1?OBJECT >STACK
	ZERO? STACK /?L4
	ZERO? P-NCN \?L4
	PUT P-ITBL,P-VERB,0
	PUT P-ITBL,P-VERBN,0
	ADD P-LEXV,2 >STACK
	PUT P-ITBL,P-NC1,STACK
	ADD P-LEXV,6 >STACK
	PUT P-ITBL,P-NC1L,STACK
	SET 'P-NCN,1
?L4:	GET P-ITBL,P-VERB >VERB
	ZERO? VERB /?L6
	ZERO? ADJ \?L6
	GET P-OTBL,P-VERB >STACK
	EQUAL? VERB,STACK \FALSE
?L6:	EQUAL? P-NCN,2 /FALSE
	GET P-OTBL,P-NC1 >STACK
	EQUAL? STACK,1 \?L9
	GET P-ITBL,P-PREP1 >TEMP
	GET P-OTBL,P-PREP1 >STACK
	EQUAL? TEMP,STACK /?L12
	ZERO? TEMP \FALSE
?L12:	ZERO? ADJ /?L13
	ADD P-LEXV,2 >STACK
	PUT P-OTBL,P-NC1,STACK
	GET P-ITBL,P-NC1L >STACK
	ZERO? STACK \?L15
	ADD P-LEXV,6 >STACK
	PUT P-ITBL,P-NC1L,STACK
?L15:	ZERO? P-NCN \?L21
	SET 'P-NCN,1
	JUMP ?L21
?L13:	GET P-ITBL,P-NC1 >STACK
	PUT P-OTBL,P-NC1,STACK
?L21:	GET P-ITBL,P-NC1L >STACK
	PUT P-OTBL,P-NC1L,STACK
	JUMP ?L42
?L9:	GET P-OTBL,P-NC2 >STACK
	EQUAL? STACK,1 \?L23
	GET P-ITBL,P-PREP1 >TEMP
	GET P-OTBL,P-PREP2 >STACK
	EQUAL? TEMP,STACK /?L26
	ZERO? TEMP \FALSE
?L26:	ZERO? ADJ /?L29
	ADD P-LEXV,2 >STACK
	PUT P-ITBL,P-NC1,STACK
	GET P-ITBL,P-NC1L >STACK
	ZERO? STACK \?L29
	ADD P-LEXV,6 >STACK
	PUT P-ITBL,P-NC1L,STACK
?L29:	GET P-ITBL,P-NC1 >STACK
	PUT P-OTBL,P-NC2,STACK
	GET P-ITBL,P-NC1L >STACK
	PUT P-OTBL,P-NC2L,STACK
	SET 'P-NCN,2
	JUMP ?L42
?L23:	ZERO? P-ACLAUSE /?L42
	EQUAL? P-NCN,1 /?L35
	ZERO? ADJ \?L35
	SET 'P-ACLAUSE,0
	RFALSE
?L35:	GET P-ITBL,P-NC1 >BEG
	ZERO? ADJ /?L38
	ADD P-LEXV,2 >BEG
	SET 'ADJ,0
?L38:	GET P-ITBL,P-NC1L >END
?L41:	GET BEG,0 >WRD
	EQUAL? BEG,END \?L43
	ZERO? ADJ /?L45
	CALL ACLAUSE-WIN,ADJ
	JUMP ?L42
?L45:	SET 'P-ACLAUSE,0
	RFALSE
?L43:	ZERO? ADJ \?L48
	GETB WRD,P-PSOFF >STACK
	BTST STACK,PS?ADJECTIVE /?L49
	EQUAL? WRD,W?ALL,W?ONE \?L48
?L49:	SET 'ADJ,WRD
	JUMP ?L51
?L48:	EQUAL? WRD,W?ONE \?L50
	CALL ACLAUSE-WIN,ADJ
	JUMP ?L42
?L50:	GETB WRD,P-PSOFF >STACK
	BTST STACK,PS?OBJECT \?L51
	EQUAL? WRD,P-ANAM \?L52
	CALL ACLAUSE-WIN,ADJ
	JUMP ?L42
?L52:	CALL NCLAUSE-WIN
	JUMP ?L42
?L51:	ADD BEG,P-WORDLEN >BEG
	ZERO? END \?L41
	SET 'END,BEG
	SET 'P-NCN,1
	SUB BEG,4 >STACK
	PUT P-ITBL,P-NC1,STACK
	PUT P-ITBL,P-NC1L,BEG
	JUMP ?L41
?L42:	GET P-OVTBL,0 >STACK
	PUT P-VTBL,0,STACK
	GETB P-OVTBL,2 >STACK
	PUTB P-VTBL,2,STACK
	GETB P-OVTBL,3 >STACK
	PUTB P-VTBL,3,STACK
	PUT P-OTBL,P-VERBN,P-VTBL
	PUTB P-VTBL,2,0
?L60:	IGRTR? 'CNT,P-ITBLLEN \?L62
	SET 'P-MERGED,1
	RTRUE
?L62:	GET P-OTBL,CNT >STACK
	PUT P-ITBL,CNT,STACK
	JUMP ?L60

	.FUNCT ACLAUSE-WIN,ADJ
	GET P-OTBL,P-VERB >STACK
	PUT P-ITBL,P-VERB,STACK
	PUT P-CCTBL,CC-SBPTR,P-ACLAUSE
	ADD P-ACLAUSE,1 >STACK
	PUT P-CCTBL,CC-SEPTR,STACK
	PUT P-CCTBL,CC-DBPTR,P-ACLAUSE
	ADD P-ACLAUSE,1 >STACK
	PUT P-CCTBL,CC-DEPTR,STACK
	CALL CLAUSE-COPY,P-OTBL,P-OTBL,ADJ
	GET P-OTBL,P-NC2 >STACK
	ZERO? STACK /?L1
	SET 'P-NCN,2
?L1:	SET 'P-ACLAUSE,0
	RTRUE

	.FUNCT NCLAUSE-WIN
	PUT P-CCTBL,CC-SBPTR,P-NC1
	PUT P-CCTBL,CC-SEPTR,P-NC1L
	PUT P-CCTBL,CC-DBPTR,P-ACLAUSE
	ADD P-ACLAUSE,1 >STACK
	PUT P-CCTBL,CC-DEPTR,STACK
	CALL CLAUSE-COPY,P-ITBL,P-OTBL
	GET P-OTBL,P-NC2 >STACK
	ZERO? STACK /?L1
	SET 'P-NCN,2
?L1:	SET 'P-ACLAUSE,0
	RTRUE

	.FUNCT WORD-PRINT,CNT,BUF
?L1:	DLESS? 'CNT,0 /TRUE
	GETB P-INBUF,BUF >STACK
	PRINTC STACK
	INC 'BUF
	JUMP ?L1

	.FUNCT UNKNOWN-WORD,PTR,BUF,?TMP
	PUT OOPS-TABLE,O-PTR,PTR
	PRINTI "I don't know the word """
	MUL PTR,2 >BUF
	ADD P-LEXV,BUF >STACK
	GETB STACK,2 >?TMP
	ADD P-LEXV,BUF >STACK
	GETB STACK,3 >STACK
	CALL WORD-PRINT,?TMP,STACK
	PRINTI "."""
	CRLF
	SET 'QUOTE-FLAG,0
	SET 'P-OFLAG,0
	RETURN P-OFLAG

	.FUNCT CANT-USE,PTR,BUF,?TMP
	PRINTI "You used the word """
	MUL PTR,2 >BUF
	ADD P-LEXV,BUF >STACK
	GETB STACK,2 >?TMP
	ADD P-LEXV,BUF >STACK
	GETB STACK,3 >STACK
	CALL WORD-PRINT,?TMP,STACK
	PRINTI """ in a way that I don't understand."
	CRLF
	SET 'QUOTE-FLAG,0
	SET 'P-OFLAG,0
	RETURN P-OFLAG

	.FUNCT SYNTAX-CHECK,SYN,LEN,NUM,OBJ,DRIVE1=0,DRIVE2=0,PREP,VERB,TMP
	GET P-ITBL,P-VERB >VERB
	ZERO? VERB \?L1
	PRINTI "There was no verb in that sentence!"
	CRLF
	RFALSE
?L1:	SUB 255,VERB >STACK
	GET VERBS,STACK >SYN
	GETB SYN,0 >LEN
	INC 'SYN
?L4:	GETB SYN,P-SBITS >STACK
	BAND STACK,P-SONUMS >NUM
	GRTR? P-NCN,NUM /?L13
	LESS? NUM,1 /?L8
	ZERO? P-NCN \?L8
	GET P-ITBL,P-PREP1 >PREP
	ZERO? PREP /?L9
	GETB SYN,P-SPREP1 >STACK
	EQUAL? PREP,STACK \?L8
?L9:	SET 'DRIVE1,SYN
	JUMP ?L13
?L8:	GET P-ITBL,P-PREP1 >STACK
	GETB SYN,P-SPREP1 >STACK
	EQUAL? STACK,STACK \?L13
	EQUAL? NUM,2 \?L11
	EQUAL? P-NCN,1 \?L11
	SET 'DRIVE2,SYN
	JUMP ?L13
?L11:	GET P-ITBL,P-PREP2 >STACK
	GETB SYN,P-SPREP2 >STACK
	EQUAL? STACK,STACK \?L13
	CALL SYNTAX-FOUND,SYN
	RTRUE
?L13:	DLESS? 'LEN,1 \?L16
	ZERO? DRIVE1 \?L39
	ZERO? DRIVE2 \?L5
	PRINT NOT-RECOGNIZED
	CRLF
	RFALSE
?L16:	ADD SYN,P-SYNLEN >SYN
	JUMP ?L4
?L5:	ZERO? DRIVE1 /?L23
?L39:	GETB DRIVE1,P-SPREP1 >STACK
	GETB DRIVE1,P-SLOC1 >STACK
	GETB DRIVE1,P-SFWIM1 >STACK
	CALL GWIM,STACK,STACK,STACK >OBJ
	ZERO? OBJ /?L23
	PUT P-PRSO,P-MATCHLEN,1
	PUT P-PRSO,1,OBJ
	CALL SYNTAX-FOUND,DRIVE1 >STACK
	RSTACK
?L23:	ZERO? DRIVE2 /?L25
	GETB DRIVE2,P-SPREP2 >STACK
	GETB DRIVE2,P-SLOC2 >STACK
	GETB DRIVE2,P-SFWIM2 >STACK
	CALL GWIM,STACK,STACK,STACK >OBJ
	ZERO? OBJ /?L25
	PUT P-PRSI,P-MATCHLEN,1
	PUT P-PRSI,1,OBJ
	CALL SYNTAX-FOUND,DRIVE2 >STACK
	RSTACK
?L25:	EQUAL? VERB,ACT?FIND \?L26
	PRINTI "I can't answer that question."
	CRLF
	RFALSE
?L26:	EQUAL? WINNER,PLAYER /?L27
	PRINT CANT-ORPHAN
	CRLF
	RFALSE
?L27:	CALL ORPHAN,DRIVE1,DRIVE2
	PRINTI "What do you want to "
	GET P-OTBL,P-VERBN >TMP
	ZERO? TMP \?L29
	PRINTI "tell"
	JUMP ?L32
?L29:	GETB P-VTBL,2 >STACK
	ZERO? STACK \?L31
	GET TMP,0 >STACK
	PRINTB STACK
	JUMP ?L32
?L31:	GETB TMP,3 >STACK
	GETB TMP,2 >STACK
	CALL WORD-PRINT,STACK,STACK
	PUTB P-VTBL,2,0
?L32:	ZERO? DRIVE2 /?L33
	PRINTI " "
	CALL THING-PRINT,1,1
?L33:	SET 'P-OFLAG,1
	ZERO? DRIVE1 /?L36
	GETB DRIVE1,P-SPREP1 >STACK
	JUMP ?L38
?L36:	GETB DRIVE2,P-SPREP2 >STACK
?L38:	CALL PREP-PRINT,STACK
	PRINTI "?"
	CRLF
	RFALSE

	.FUNCT ORPHAN,D1,D2,CNT=-1
	ZERO? P-MERGED \?L1
	PUT P-OCLAUSE,P-MATCHLEN,0
?L1:	GET P-VTBL,0 >STACK
	PUT P-OVTBL,0,STACK
	GETB P-VTBL,2 >STACK
	PUTB P-OVTBL,2,STACK
	GETB P-VTBL,3 >STACK
	PUTB P-OVTBL,3,STACK
?L4:	IGRTR? 'CNT,P-ITBLLEN /?L5
	GET P-ITBL,CNT >STACK
	PUT P-OTBL,CNT,STACK
	JUMP ?L4
?L5:	EQUAL? P-NCN,2 \?L9
	PUT P-CCTBL,CC-SBPTR,P-NC2
	PUT P-CCTBL,CC-SEPTR,P-NC2L
	PUT P-CCTBL,CC-DBPTR,P-NC2
	PUT P-CCTBL,CC-DEPTR,P-NC2L
	CALL CLAUSE-COPY,P-ITBL,P-OTBL
?L9:	LESS? P-NCN,1 /?L12
	PUT P-CCTBL,CC-SBPTR,P-NC1
	PUT P-CCTBL,CC-SEPTR,P-NC1L
	PUT P-CCTBL,CC-DBPTR,P-NC1
	PUT P-CCTBL,CC-DEPTR,P-NC1L
	CALL CLAUSE-COPY,P-ITBL,P-OTBL
?L12:	ZERO? D1 /?L15
	GETB D1,P-SPREP1 >STACK
	PUT P-OTBL,P-PREP1,STACK
	PUT P-OTBL,P-NC1,1
	RTRUE
?L15:	ZERO? D2 /FALSE
	GETB D2,P-SPREP2 >STACK
	PUT P-OTBL,P-PREP2,STACK
	PUT P-OTBL,P-NC2,1
	RTRUE

	.FUNCT ORPHAN-VERB,WRD,ACT
	PUT P-VTBL,0,WRD
	PUT P-OTBL,P-VERB,ACT
	PUT P-OTBL,P-VERBN,P-VTBL
	PUT P-OTBL,P-PREP1,0
	PUT P-OTBL,P-PREP1N,0
	PUT P-OTBL,P-PREP2,0
	PUT P-OTBL,5,0
	PUT P-OTBL,P-NC1,1
	PUT P-OTBL,P-NC1L,0
	PUT P-OTBL,P-NC2,0
	PUT P-OTBL,P-NC2L,0
	SET 'P-OFLAG,1
	RETURN P-OFLAG

	.FUNCT THING-PRINT,PRSO?,THE?=0,BEG,END
	ZERO? PRSO? /?L1
	GET P-ITBL,P-NC1 >BEG
	GET P-ITBL,P-NC1L >END
	JUMP ?L3
?L1:	GET P-ITBL,P-NC2 >BEG
	GET P-ITBL,P-NC2L >END
?L3:	CALL BUFFER-PRINT,BEG,END,THE? >STACK
	RSTACK

	.FUNCT BUFFER-PRINT,BEG,END,CP,NOSP=1,WRD,1ST?=1,PN=0,Q?=0
?L1:	EQUAL? BEG,END /TRUE
	GET BEG,0 >WRD
	EQUAL? WRD,W?$0024BUZZ /?L10
	EQUAL? WRD,W?$COMMA \?L8
	PRINTI ", "
	JUMP ?L10
?L8:	ZERO? NOSP /?L9
	SET 'NOSP,0
	JUMP ?L10
?L9:	PRINTI " "
?L10:	EQUAL? WRD,W?$PERIOD,W?$0024BUZZ,W?$COMMA \?L11
	SET 'NOSP,1
	JUMP ?L16
?L11:	EQUAL? WRD,W?ME \?L13
	PRINTD ME
	SET 'PN,1
	JUMP ?L16
?L13:	EQUAL? WRD,W?INTNUM \?L14
	PRINTN P-NUMBER
	SET 'PN,1
	JUMP ?L16
?L14:	CALL NAME?,WRD >STACK
	ZERO? STACK /?L15
	CALL CAPITALIZE,BEG
	SET 'PN,1
	JUMP ?L16
?L15:	ZERO? 1ST? /?L17
	ZERO? PN \?L17
	ZERO? CP /?L17
	PRINTI "the "
?L17:	ZERO? P-OFLAG \?L22
	ZERO? P-MERGED /?L20
?L22:	CALL ZMEMQ,WRD,CUBE-LIST,47 >Q?
	ZERO? Q? /?L23
	SUB Q?,2 >STACK
	GET STACK,0 >STACK
	CALL CUBE-NAME,STACK
	JUMP ?L31
?L23:	PRINTB WRD
	JUMP ?L31
?L20:	EQUAL? WRD,W?IT \?L26
	CALL ACCESSIBLE?,P-IT-OBJECT >STACK
	ZERO? STACK /?L26
	PRINTD P-IT-OBJECT
	JUMP ?L31
?L26:	CALL CUBE-NAME?,WRD >Q?
	ZERO? Q? /?L28
	PRINTI """"
?L28:	GETB BEG,3 >STACK
	GETB BEG,2 >STACK
	CALL WORD-PRINT,STACK,STACK
	ZERO? Q? /?L31
	PRINTI """"
?L31:	SET '1ST?,0
?L16:	ADD BEG,P-WORDLEN >BEG
	JUMP ?L1

	.FUNCT CUBE-NAME?,WRD,QWRD,QPTR
	EQUAL? WRD,W?QWORD /TRUE
	SET 'QPTR,P-QBUF
?L4:	GET QPTR,0 >QWRD
	ZERO? QWRD /FALSE
	EQUAL? QWRD,WRD /TRUE
	ADD QPTR,10 >QPTR
	JUMP ?L4

	.FUNCT NAME?,WRD
	EQUAL? WRD,W?BELBOZ,W?ARDIS,W?ORKAN /TRUE
	EQUAL? WRD,W?GZORNENPLATZ,W?SNEFFLE,W?HOOBLY \FALSE
	RTRUE

	.FUNCT CAPITALIZE,PTR
	ZERO? P-OFLAG \?L3
	ZERO? P-MERGED /?L1
?L3:	GET PTR,0 >STACK
	PRINTB STACK
	RTRUE
?L1:	GETB PTR,3 >STACK
	GETB P-INBUF,STACK >STACK
	SUB STACK,32 >STACK
	PRINTC STACK
	GETB PTR,3 >STACK
	INC 'STACK
	GETB PTR,2 >STACK
	DEC 'STACK
	CALL WORD-PRINT,STACK,STACK >STACK
	RSTACK

	.FUNCT PREP-PRINT,PREP,WRD
	ZERO? PREP /FALSE
	PRINTI " "
	EQUAL? PREP,PR?THROUGH \?L3
	PRINTI "through"
	RTRUE
?L3:	CALL PREP-FIND,PREP >WRD
	PRINTB WRD
	RTRUE

	.FUNCT CLAUSE-COPY,SRC,DEST,INSRT=0,BEG,END
	GET P-CCTBL,CC-SBPTR >STACK
	GET SRC,STACK >BEG
	GET P-CCTBL,CC-SEPTR >STACK
	GET SRC,STACK >END
	GET P-OCLAUSE,P-MATCHLEN >STACK
	MUL STACK,P-LEXELEN >STACK
	ADD STACK,2 >STACK
	ADD P-OCLAUSE,STACK >STACK
	GET P-CCTBL,CC-DBPTR >STACK
	PUT DEST,STACK,STACK
?L1:	EQUAL? BEG,END \?L3
	GET P-OCLAUSE,P-MATCHLEN >STACK
	MUL STACK,P-LEXELEN >STACK
	ADD STACK,2 >STACK
	ADD P-OCLAUSE,STACK >STACK
	GET P-CCTBL,CC-DEPTR >STACK
	PUT DEST,STACK,STACK
	RTRUE
?L3:	ZERO? INSRT /?L6
	GET BEG,0 >STACK
	EQUAL? P-ANAM,STACK \?L6
	CALL CLAUSE-ADD,INSRT
?L6:	GET BEG,0 >STACK
	CALL CLAUSE-ADD,STACK
	ADD BEG,P-WORDLEN >BEG
	JUMP ?L1

	.FUNCT CLAUSE-ADD,WRD,PTR
	GET P-OCLAUSE,P-MATCHLEN >STACK
	ADD STACK,2 >PTR
	SUB PTR,1 >STACK
	PUT P-OCLAUSE,STACK,WRD
	PUT P-OCLAUSE,PTR,0
	PUT P-OCLAUSE,P-MATCHLEN,PTR
	RTRUE

	.FUNCT PREP-FIND,PREP,CNT=0,SIZE
	GET PREPOSITIONS,0 >STACK
	MUL STACK,2 >SIZE
?L1:	IGRTR? 'CNT,SIZE /FALSE
	GET PREPOSITIONS,CNT >STACK
	EQUAL? STACK,PREP \?L1
	SUB CNT,1 >STACK
	GET PREPOSITIONS,STACK >STACK
	RSTACK

	.FUNCT SYNTAX-FOUND,SYN
	SET 'P-SYNTAX,SYN
	GETB SYN,P-SACTION >PRSA
	RETURN PRSA

	.FUNCT GWIM,GBIT,LBIT,PREP,OBJ
	EQUAL? GBIT,RLANDBIT \?L1
	RETURN ROOMS
?L1:	SET 'P-GWIMBIT,GBIT
	SET 'P-SLOCBITS,LBIT
	PUT P-MERGE,P-MATCHLEN,0
	CALL GET-OBJECT,P-MERGE,0 >STACK
	ZERO? STACK /?L4
	SET 'P-GWIMBIT,0
	GET P-MERGE,P-MATCHLEN >STACK
	EQUAL? STACK,1 \FALSE
	GET P-MERGE,1 >OBJ
	PRINTI "("
	ZERO? PREP /?L8
	ZERO? P-END-ON-PREP \?L8
	CALL PREP-FIND,PREP >PREP
	PRINTB PREP
	EQUAL? PREP,W?OUT \?L10
	PRINTI " of"
?L10:	PRINTI " "
	EQUAL? OBJ,HANDS \?L13
	CALL DPRINT,OBJ
	JUMP ?L15
?L13:	CALL THE-PRINT,OBJ
?L15:	PRINTI ")"
	CRLF
	RETURN OBJ
?L8:	CALL DPRINT,OBJ
	PRINTI ")"
	CRLF
	RETURN OBJ
?L4:	SET 'P-GWIMBIT,0
	RFALSE

	.FUNCT SNARF-OBJECTS,OPTR,IPTR,L
	PUT P-BUTS,P-MATCHLEN,0
	GET P-ITBL,P-NC2 >IPTR
	ZERO? IPTR /?L3
	GETB P-SYNTAX,P-SLOC2 >P-SLOCBITS
	GET P-ITBL,P-NC2L >STACK
	CALL SNARFEM,IPTR,STACK,P-PRSI >STACK
	ZERO? STACK /FALSE
?L3:	GET P-ITBL,P-NC1 >OPTR
	ZERO? OPTR /?L8
	GETB P-SYNTAX,P-SLOC1 >P-SLOCBITS
	GET P-ITBL,P-NC1L >STACK
	CALL SNARFEM,OPTR,STACK,P-PRSO >STACK
	ZERO? STACK /FALSE
?L8:	GET P-BUTS,P-MATCHLEN >STACK
	ZERO? STACK /TRUE
	GET P-PRSO,P-MATCHLEN >L
	ZERO? OPTR /?L13
	CALL BUT-MERGE,P-PRSO >P-PRSO
?L13:	ZERO? IPTR /TRUE
	ZERO? OPTR /?L18
	GET P-PRSO,P-MATCHLEN >STACK
	EQUAL? L,STACK \TRUE
?L18:	CALL BUT-MERGE,P-PRSI >P-PRSI
	RTRUE

	.FUNCT BUT-MERGE,TBL,LEN,BUTLEN,CNT=1,MATCHES=0,OBJ,NTBL
	GET TBL,P-MATCHLEN >LEN
	PUT P-MERGE,P-MATCHLEN,0
?L1:	DLESS? 'LEN,0 /?L2
	GET TBL,CNT >OBJ
	CALL ZMEMQ,OBJ,P-BUTS >STACK
	ZERO? STACK \?L6
	ADD MATCHES,1 >STACK
	PUT P-MERGE,STACK,OBJ
	INC 'MATCHES
?L6:	INC 'CNT
	JUMP ?L1
?L2:	PUT P-MERGE,P-MATCHLEN,MATCHES
	SET 'NTBL,P-MERGE
	SET 'P-MERGE,TBL
	RETURN NTBL

	.FUNCT SNARFEM,PTR,EPTR,TBL,BUT=0,LEN,WV,WRD,NW,WAS-ALL=0
	SET 'P-AND,0
	EQUAL? P-GETFLAGS,P-ALL \?L1
	SET 'WAS-ALL,1
?L1:	SET 'P-GETFLAGS,0
	PUT TBL,P-MATCHLEN,0
	GET PTR,0 >WRD
?L4:	EQUAL? PTR,EPTR \?L6
?L57:	ZERO? BUT /?L9
	PUSH BUT
	JUMP ?L8
?L9:	PUSH TBL
?L8:	CALL GET-OBJECT,STACK >WV
	ZERO? WAS-ALL /?L10
	SET 'P-GETFLAGS,P-ALL
?L10:	RETURN WV
?L6:	ADD PTR,P-WORDLEN >STACK
	EQUAL? EPTR,STACK \?L14
	SET 'NW,0
	JUMP ?L16
?L14:	GET PTR,P-LEXELEN >NW
?L16:	EQUAL? WRD,W?ALL,W?BOTH \?L17
	SET 'P-GETFLAGS,P-ALL
	EQUAL? NW,W?OF \?L52
	ADD PTR,P-WORDLEN >PTR
	JUMP ?L52
?L17:	EQUAL? WRD,W?BUT,W?EXCEPT \?L22
	ZERO? BUT /?L26
	PUSH BUT
	JUMP ?L25
?L26:	PUSH TBL
?L25:	CALL GET-OBJECT,STACK >STACK
	ZERO? STACK /FALSE
	SET 'BUT,P-BUTS
	PUT BUT,P-MATCHLEN,0
	JUMP ?L52
?L22:	EQUAL? WRD,W?A,W?ONE \?L27
	ZERO? P-ADJ \?L28
	SET 'P-GETFLAGS,P-ONE
	EQUAL? NW,W?OF \?L52
	ADD PTR,P-WORDLEN >PTR
	JUMP ?L52
?L28:	SET 'P-NAM,P-ONEOBJ
	ZERO? BUT /?L37
	PUSH BUT
	JUMP ?L36
?L37:	PUSH TBL
?L36:	CALL GET-OBJECT,STACK >STACK
	ZERO? STACK /FALSE
	ZERO? NW /TRUE
	JUMP ?L52
?L27:	EQUAL? WRD,W?AND,W?$COMMA \?L40
	EQUAL? NW,W?AND,W?$COMMA /?L40
	SET 'P-AND,1
	ZERO? BUT /?L44
	PUSH BUT
	JUMP ?L43
?L44:	PUSH TBL
?L43:	CALL GET-OBJECT,STACK >STACK
	ZERO? STACK /FALSE
	JUMP ?L52
?L40:	CALL WT?,WRD,PS?BUZZ-WORD >STACK
	ZERO? STACK \?L52
	EQUAL? WRD,W?AND,W?$COMMA /?L52
	EQUAL? WRD,W?OF \?L47
	ZERO? P-GETFLAGS \?L52
	SET 'P-GETFLAGS,P-INHIBIT
	JUMP ?L52
?L47:	CALL WT?,WRD,PS?ADJECTIVE,P1?ADJECTIVE >WV
	ZERO? WV /?L51
	ZERO? P-ADJ \?L51
	SET 'P-ADJ,WV
	SET 'P-ADJN,WRD
	JUMP ?L52
?L51:	CALL WT?,WRD,PS?OBJECT,P1?OBJECT >STACK
	ZERO? STACK /?L52
	SET 'P-NAM,WRD
	SET 'P-ONEOBJ,WRD
?L52:	EQUAL? PTR,EPTR /?L57
	ADD PTR,P-WORDLEN >PTR
	SET 'WRD,NW
	JUMP ?L4

	.FUNCT GET-OBJECT,TBL,VRB=1,GEN,BITS,LEN,XBITS,TLEN,GCHECK=0,OLEN=0,OBJ
	SET 'XBITS,P-SLOCBITS
	GET TBL,P-MATCHLEN >TLEN
	BTST P-GETFLAGS,P-INHIBIT /TRUE
	ZERO? P-NAM \?L7
	ZERO? P-ADJ /?L4
	CALL WT?,P-ADJN,PS?OBJECT,P1?OBJECT >STACK
	ZERO? STACK /?L4
	SET 'P-NAM,P-ADJN
	SET 'P-ADJ,0
?L4:	ZERO? P-NAM \?L7
	ZERO? P-ADJ \?L7
	EQUAL? P-GETFLAGS,P-ALL /?L68
	ZERO? P-GWIMBIT \?L7
	ZERO? VRB /FALSE
	PRINT NOUN-MISSING
	CRLF
	RFALSE
?L7:	EQUAL? P-GETFLAGS,P-ALL \?L15
?L68:	ZERO? P-SLOCBITS \?L13
?L15:	SET 'P-SLOCBITS,-1
?L13:	SET 'P-TABLE,TBL
?L17:	ZERO? GCHECK /?L19
	CALL GLOBAL-CHECK,TBL
	JUMP ?L21
?L19:	ZERO? LIT /?L22
	FCLEAR PLAYER,TRANSBIT
	CALL DO-SL,HERE,SOG,SIR
	LOC PLAYER >STACK
	FSET? STACK,VEHBIT \?L24
	LOC PLAYER >STACK
	FSET? STACK,OPENBIT /?L24
	LOC PLAYER >STACK
	CALL DO-SL,STACK,SOG,SIR
?L24:	FSET PLAYER,TRANSBIT
?L22:	CALL DO-SL,PLAYER,SH,SC
?L21:	GET TBL,P-MATCHLEN >STACK
	SUB STACK,TLEN >LEN
	BTST P-GETFLAGS,P-ALL /?L38
	BTST P-GETFLAGS,P-ONE \?L30
	ZERO? LEN /?L30
	EQUAL? LEN,1 /?L31
	RANDOM LEN >STACK
	GET TBL,STACK >STACK
	PUT TBL,1,STACK
	PRINTI "(How about "
	GET TBL,1 >STACK
	CALL THE-PRINT,STACK
	PRINTI "?)"
	CRLF
?L31:	PUT TBL,P-MATCHLEN,1
	JUMP ?L38
?L30:	GRTR? LEN,1 /?L35
	ZERO? LEN \?L66
	EQUAL? P-SLOCBITS,-1 /?L38
?L35:	EQUAL? P-SLOCBITS,-1 \?L36
	SET 'P-SLOCBITS,XBITS
	SET 'OLEN,LEN
	GET TBL,P-MATCHLEN >STACK
	SUB STACK,LEN >STACK
	PUT TBL,P-MATCHLEN,STACK
	JUMP ?L17
?L36:	ZERO? LEN \?L39
	SET 'LEN,OLEN
?L39:	GRTR? LEN,1 \?L42
	CALL GENERIC-OBJECT? >STACK
	ZERO? STACK /?L42
	GET TBL,LEN >STACK
	GETP STACK,P?GENERIC >STACK
	ZERO? STACK /?L42
	GET TBL,LEN >STACK
	GETP STACK,P?GENERIC >STACK
	CALL STACK,TBL,LEN >GEN
	ZERO? GEN /?L44
	ADD TLEN,1 >LEN
	PUT TBL,P-MATCHLEN,LEN
	PUT TBL,LEN,GEN
	SET 'P-XNAM,P-NAM
	SET 'P-XADJ,P-ADJ
	SET 'P-XADJN,P-ADJN
	SET 'P-NAM,0
	SET 'P-ADJ,0
	RTRUE
?L44:	PRINT MORE-SPECIFIC
	PRINTI " about which one you mean."
	CRLF
	SET 'P-NAM,0
	SET 'P-ADJ,0
	RFALSE
?L42:	ZERO? VRB /?L53
	EQUAL? WINNER,PLAYER /?L47
	PRINT CANT-ORPHAN
	CRLF
	SET 'P-NAM,0
	SET 'P-ADJ,0
	RFALSE
?L47:	ZERO? VRB /?L53
	ZERO? P-NAM \?L49
	ZERO? P-ADJ /?L48
?L49:	CALL WHICH-PRINT,TLEN,LEN,TBL
	EQUAL? TBL,P-PRSO \?L50
	SET 'P-ACLAUSE,P-NC1
	JUMP ?L52
?L50:	SET 'P-ACLAUSE,P-NC2
?L52:	SET 'P-AADJ,P-ADJ
	SET 'P-ANAM,P-NAM
	CALL ORPHAN,0,0
	SET 'P-OFLAG,1
	JUMP ?L53
?L48:	ZERO? VRB /?L53
	PRINT NOUN-MISSING
	CRLF
?L53:	SET 'P-NAM,0
	SET 'P-ADJ,0
	RFALSE
?L38:	ZERO? LEN \?L66
	ZERO? GCHECK /?L56
	ZERO? VRB /?L64
	SET 'P-SLOCBITS,XBITS
	ZERO? LIT \?L63
	EQUAL? PRSA,V?TELL,V?WHERE,V?WHAT /?L63
	EQUAL? PRSA,V?WHO \?L60
?L63:	CALL OBJ-FOUND,NOT-HERE-OBJECT,TBL
	SET 'P-XNAM,P-NAM
	SET 'P-XADJ,P-ADJ
	SET 'P-XADJN,P-ADJN
	SET 'P-NAM,0
	SET 'P-ADJ,0
	RTRUE
?L60:	PRINT TOO-DARK
?L64:	SET 'P-NAM,0
	SET 'P-ADJ,0
	RFALSE
?L56:	ZERO? LEN \?L66
	SET 'GCHECK,1
	JUMP ?L17
?L66:	SET 'P-SLOCBITS,XBITS
	SET 'P-NAM,0
	SET 'P-ADJ,0
	RTRUE

	.FUNCT MOBY-FIND,TBL,FOO,LEN,GEN
	SET 'P-MOBY-FLAG,1
	SET 'P-SLOCBITS,-1
	SET 'P-TABLE,TBL
	SET 'P-NAM,P-XNAM
	SET 'P-ADJ,P-XADJ
	PUT TBL,P-MATCHLEN,0
	FIRST? ROOMS >FOO \?L3
?L4:	CALL SEARCH-LIST,FOO,TBL,P-SRCALL
	NEXT? FOO >FOO /?L4
?L3:	CALL DO-SL,LOCAL-GLOBALS,1,1
	CALL SEARCH-LIST,ROOMS,TBL,P-SRCTOP
	GET TBL,P-MATCHLEN >LEN
	EQUAL? LEN,1 \?L8
	GET TBL,1 >P-MOBY-FOUND
	JUMP ?L11
?L8:	CALL GENERIC-OBJECT? >STACK
	ZERO? STACK /?L11
	GET TBL,LEN >STACK
	GETP STACK,P?GENERIC >STACK
	ZERO? STACK /?L11
	GET TBL,LEN >STACK
	GETP STACK,P?GENERIC >STACK
	CALL STACK,TBL,LEN >GEN
	ZERO? GEN /?L11
	SET 'LEN,1
	SET 'P-MOBY-FOUND,GEN
?L11:	SET 'P-MOBY-FLAG,0
	SET 'P-NAM,0
	SET 'P-ADJ,0
	RETURN LEN

	.FUNCT WHICH-PRINT,TLEN,LEN,TBL,OBJ,RLEN
	SET 'RLEN,LEN
	PRINTI "Which "
	ZERO? P-OFLAG \?L3
	ZERO? P-MERGED \?L3
	ZERO? P-AND /?L1
?L3:	ZERO? P-NAM /?L4
	PUSH P-NAM
	JUMP ?L7
?L4:	ZERO? P-ADJ /?L6
	PUSH P-ADJN
	JUMP ?L7
?L6:	PUSH W?ONE
?L7:	PRINTB STACK
	JUMP ?L8
?L1:	EQUAL? TBL,P-PRSO /?L9
	PUSH 0
	JUMP ?L10
?L9:	PUSH 1
?L10:	CALL THING-PRINT,STACK
?L8:	PRINTI " do you mean, "
?L11:	INC 'TLEN
	GET TBL,TLEN >OBJ
	CALL THE-PRINT,OBJ
	EQUAL? LEN,2 \?L13
	EQUAL? RLEN,2 /?L15
	PRINTI ","
?L15:	PRINTI " or "
	JUMP ?L18
?L13:	GRTR? LEN,2 \?L18
	PRINTI ", "
?L18:	DLESS? 'LEN,1 \?L11
	PRINTR "?"

	.FUNCT GLOBAL-CHECK,TBL,LEN,RMG,RMGL,CNT=0,OBJ,OBITS,FOO
	GET TBL,P-MATCHLEN >LEN
	SET 'OBITS,P-SLOCBITS
	GETPT HERE,P?GLOBAL >RMG
	ZERO? RMG /?L4
	PTSIZE RMG >STACK
	SUB STACK,1 >RMGL
?L3:	GETB RMG,CNT >OBJ
	CALL THIS-IT?,OBJ,TBL >STACK
	ZERO? STACK /?L5
	CALL OBJ-FOUND,OBJ,TBL
?L5:	IGRTR? 'CNT,RMGL \?L3
?L4:	GETP HERE,P?THINGS >RMG
	ZERO? RMG /?L15
	GET RMG,0 >RMGL
	SET 'CNT,0
?L14:	ADD CNT,1 >STACK
	GET RMG,STACK >STACK
	EQUAL? P-NAM,STACK \?L16
	ZERO? P-ADJ /?L18
	ADD CNT,2 >STACK
	GET RMG,STACK >STACK
	EQUAL? P-ADJN,STACK \?L16
?L18:	SET 'P-PNAM,P-NAM
	ZERO? P-ADJ /?L19
	SET 'P-PADJN,P-ADJN
	JUMP ?L21
?L19:	SET 'P-PADJN,0
?L21:	SET 'LAST-PSEUDO-LOC,HERE
	ADD CNT,3 >STACK
	GET RMG,STACK >STACK
	PUTP PSEUDO-OBJECT,P?ACTION,STACK
	GETPT PSEUDO-OBJECT,P?ACTION >STACK
	SUB STACK,5 >FOO
	GET P-NAM,0 >STACK
	PUT FOO,0,STACK
	GET P-NAM,1 >STACK
	PUT FOO,1,STACK
	CALL OBJ-FOUND,PSEUDO-OBJECT,TBL
	JUMP ?L15
?L16:	ADD CNT,3 >CNT
	LESS? CNT,RMGL /?L14
?L15:	GET TBL,P-MATCHLEN >STACK
	EQUAL? STACK,LEN \FALSE
	SET 'P-SLOCBITS,-1
	SET 'P-TABLE,TBL
	CALL DO-SL,GLOBAL-OBJECTS,1,1
	SET 'P-SLOCBITS,OBITS
	RETURN P-SLOCBITS

	.FUNCT DO-SL,OBJ,BIT1,BIT2,BTS
	ADD BIT1,BIT2 >STACK
	BTST P-SLOCBITS,STACK \?L1
	CALL SEARCH-LIST,OBJ,P-TABLE,P-SRCALL >STACK
	RSTACK
?L1:	BTST P-SLOCBITS,BIT1 \?L4
	CALL SEARCH-LIST,OBJ,P-TABLE,P-SRCTOP >STACK
	RSTACK
?L4:	BTST P-SLOCBITS,BIT2 \TRUE
	CALL SEARCH-LIST,OBJ,P-TABLE,P-SRCBOT >STACK
	RSTACK

	.FUNCT SEARCH-LIST,OBJ,TBL,LVL,FLS,NOBJ
	FIRST? OBJ >OBJ \FALSE
?L3:	EQUAL? LVL,P-SRCBOT /?L5
	GETPT OBJ,P?SYNONYM >STACK
	ZERO? STACK /?L5
	CALL THIS-IT?,OBJ,TBL >STACK
	ZERO? STACK /?L5
	CALL OBJ-FOUND,OBJ,TBL
?L5:	EQUAL? LVL,P-SRCTOP \?L10
	FSET? OBJ,SEARCHBIT /?L10
	FSET? OBJ,SURFACEBIT \?L11
?L10:	FIRST? OBJ >NOBJ \?L11
	ZERO? P-MOBY-FLAG \?L16
	FSET? OBJ,OPENBIT /?L13
	FSET? OBJ,TRANSBIT \?L11
?L13:	ZERO? P-MOBY-FLAG \?L16
	FSET? OBJ,SURFACEBIT /?L16
	FSET? OBJ,SEARCHBIT \?L14
?L16:	PUSH P-SRCALL
	JUMP ?L17
?L14:	PUSH P-SRCTOP
?L17:	CALL SEARCH-LIST,OBJ,TBL,STACK >FLS
?L11:	NEXT? OBJ >OBJ /?L3
	RTRUE

	.FUNCT OBJ-FOUND,OBJ,TBL,PTR
	GET TBL,P-MATCHLEN >PTR
	ADD PTR,1 >STACK
	PUT TBL,STACK,OBJ
	ADD PTR,1 >STACK
	PUT TBL,P-MATCHLEN,STACK
	RTRUE

	.FUNCT TAKE-CHECK
	GETB P-SYNTAX,P-SLOC1 >STACK
	CALL ITAKE-CHECK,P-PRSO,STACK >STACK
	ZERO? STACK /FALSE
	GETB P-SYNTAX,P-SLOC2 >STACK
	CALL ITAKE-CHECK,P-PRSI,STACK >STACK
	RSTACK

	.FUNCT ITAKE-CHECK,TBL,IBITS,PTR,OBJ,TAKEN?1
	GET TBL,P-MATCHLEN >PTR
	ZERO? PTR /TRUE
	BTST IBITS,SHAVE /?L3
	BTST IBITS,STAKE \TRUE
?L3:	DLESS? 'PTR,0 /TRUE
	ADD PTR,1 >STACK
	GET TBL,STACK >OBJ
	EQUAL? OBJ,IT \?L13
	CALL ACCESSIBLE?,P-IT-OBJECT >STACK
	ZERO? STACK \?L11
	PRINT REFERRING
	CRLF
	RFALSE
?L11:	SET 'OBJ,P-IT-OBJECT
?L13:	CALL HELD?,OBJ >STACK
	ZERO? STACK \?L3
	EQUAL? OBJ,ME /?L3
	SET 'PRSO,OBJ
	FSET? OBJ,TRYTAKEBIT \?L19
	SET 'TAKEN?1,1
	JUMP ?L24
?L19:	EQUAL? WINNER,PLAYER \?L22
	EQUAL? PRSO,INTNUM \?L21
	CALL HELD?,ZORKMID >STACK
	ZERO? STACK /?L21
?L22:	SET 'TAKEN?1,0
	JUMP ?L24
?L21:	BTST IBITS,STAKE \?L23
	CALL ITAKE,0 >STACK
	EQUAL? STACK,1 \?L23
	SET 'TAKEN?1,0
	JUMP ?L24
?L23:	SET 'TAKEN?1,1
?L24:	ZERO? TAKEN?1 /?L38
	BTST IBITS,SHAVE \?L25
	GET TBL,P-MATCHLEN >STACK
	LESS? 1,STACK \?L27
	PRINT YOU-ARENT
	PRINTI "holding all those things!"
	CRLF
	RFALSE
?L27:	EQUAL? OBJ,NOT-HERE-OBJECT \?L29
	PRINT YOU-CANT-SEE
	PRINTI "that here!"
	CRLF
	RFALSE
?L29:	EQUAL? WINNER,PLAYER \?L30
	PRINT YOU-ARENT
	JUMP ?L31
?L30:	PRINTI "It doesn't look like "
	CALL THE-PRINT,WINNER
	PRINTI " is "
?L31:	PRINTI "holding "
	EQUAL? OBJ,PSEUDO-OBJECT \?L32
	PRINTI "that"
	JUMP ?L34
?L32:	CALL THE-PRINT,OBJ
?L34:	CALL THIS-IS-IT,OBJ
	PRINT PERIOD
	RFALSE
?L25:	ZERO? TAKEN?1 \?L3
?L38:	EQUAL? WINNER,PLAYER \?L3
	EQUAL? PRSO,INTNUM /?L3
	PRINTI "(Taking "
	CALL THE-PRINT,OBJ
	PRINTI " first)"
	CRLF
	JUMP ?L3

	.FUNCT MANY-CHECK,LOSS=0,TMP
	GET P-PRSO,P-MATCHLEN >STACK
	GRTR? STACK,1 \?L1
	GETB P-SYNTAX,P-SLOC1 >STACK
	BTST STACK,SMANY /?L1
	SET 'LOSS,1
	JUMP ?L3
?L1:	GET P-PRSI,P-MATCHLEN >STACK
	GRTR? STACK,1 \?L3
	GETB P-SYNTAX,P-SLOC2 >STACK
	BTST STACK,SMANY /?L3
	SET 'LOSS,2
?L3:	ZERO? LOSS /TRUE
	PRINT YOU-CANT
	PRINTI "use multiple "
	EQUAL? LOSS,2 \?L7
	PRINTI "in"
?L7:	PRINTI "direct objects with """
	GET P-ITBL,P-VERBN >TMP
	ZERO? TMP \?L10
	PRINTI "tell"
	JUMP ?L14
?L10:	ZERO? P-OFLAG \?L13
	ZERO? P-MERGED /?L12
?L13:	GET TMP,0 >STACK
	PRINTB STACK
	JUMP ?L14
?L12:	GETB TMP,3 >STACK
	GETB TMP,2 >STACK
	CALL WORD-PRINT,STACK,STACK
?L14:	PRINTI """."
	CRLF
	RFALSE

	.FUNCT ZMEMQ,ITM,TBL,SIZE=-1,CNT=1
	ZERO? TBL /FALSE
	LESS? SIZE,0 /?L4
	SET 'CNT,0
	JUMP ?L6
?L4:	GET TBL,0 >SIZE
?L6:	GET TBL,CNT >STACK
	EQUAL? ITM,STACK \?L9
	MUL CNT,2 >STACK
	ADD TBL,STACK >STACK
	RSTACK
?L9:	IGRTR? 'CNT,SIZE \?L6
	RFALSE

	.FUNCT ZMEMQB,ITM,TBL,SIZE,CNT=0
?L1:	GETB TBL,CNT >STACK
	EQUAL? ITM,STACK /TRUE
	IGRTR? 'CNT,SIZE \?L1
	RFALSE

	.FUNCT LIT?,RM,RMBIT=1,OHERE?1,LIT?1=0
	SET 'P-GWIMBIT,ONBIT
	SET 'OHERE?1,HERE
	SET 'HERE,RM
	ZERO? RMBIT /?L1
	FSET? RM,ONBIT \?L1
	SET 'LIT?1,HERE
	JUMP ?L14
?L1:	FSET? WINNER,ONBIT \?L3
	CALL HELD?,WINNER,RM >STACK
	ZERO? STACK /?L3
	SET 'LIT?1,WINNER
	JUMP ?L14
?L3:	PUT P-MERGE,P-MATCHLEN,0
	SET 'P-TABLE,P-MERGE
	SET 'P-SLOCBITS,-1
	EQUAL? OHERE?1,RM \?L7
	CALL DO-SL,WINNER,1,1
	EQUAL? WINNER,PLAYER /?L7
	IN? PLAYER,RM \?L7
	CALL DO-SL,PLAYER,1,1
?L7:	LOC WINNER >STACK
	FSET? STACK,VEHBIT \?L11
	LOC WINNER >STACK
	FSET? STACK,OPENBIT /?L11
	LOC WINNER >STACK
	CALL DO-SL,STACK,1,1
?L11:	CALL DO-SL,RM,1,1
	GET P-TABLE,P-MATCHLEN >STACK
	GRTR? STACK,0 \?L14
	GET P-TABLE,1 >LIT?1
?L14:	ZERO? LIT?1 \?L17
	EQUAL? CHANGED?,GRUE \?L17
	SET 'LIT?1,GRUE
?L17:	SET 'HERE,OHERE?1
	SET 'P-GWIMBIT,0
	RETURN LIT?1

	.FUNCT THIS-IT?,OBJ,TBL,SYNS
	FSET? OBJ,INVISIBLE /FALSE
	ZERO? P-NAM /?L3
	GETPT OBJ,P?SYNONYM >SYNS
	PTSIZE SYNS >STACK
	DIV STACK,2 >STACK
	DEC 'STACK
	CALL ZMEMQ,P-NAM,SYNS,STACK >STACK
	ZERO? STACK /FALSE
?L3:	ZERO? P-ADJ /?L4
	GETPT OBJ,P?ADJECTIVE >SYNS
	ZERO? SYNS /FALSE
	PTSIZE SYNS >STACK
	DEC 'STACK
	CALL ZMEMQB,P-ADJ,SYNS,STACK >STACK
	ZERO? STACK /FALSE
?L4:	ZERO? P-GWIMBIT /TRUE
	FSET? OBJ,P-GWIMBIT /TRUE
	RFALSE

	.FUNCT END-QUOTE
	SET 'QUOTE-FLAG,0
	SET 'P-CONT,0
	RETURN 2

	.FUNCT GENERIC-OBJECT?
	EQUAL? P-NAM,W?CUBE,W?CUBES \?L1
	ZERO? P-ADJ /TRUE
	EQUAL? P-ADJN,W?SMALL,W?WHITE,W?FEATURELESS /TRUE
	RFALSE
?L1:	EQUAL? P-NAM,W?ROCK,W?ROCKS,W?BOULDER \?L7
	ZERO? P-ADJ /TRUE
	EQUAL? P-ADJN,W?FLAT /TRUE
	RFALSE
?L7:	EQUAL? P-NAM,W?RUNE \?L12
	ZERO? P-ADJ /TRUE
	EQUAL? P-ADJN,W?SILVER,W?LEAD /TRUE
	RFALSE
?L12:	ZERO? P-ADJ \FALSE
	EQUAL? P-NAM,W?FISH,W?WALL,W?CARPET /TRUE
	EQUAL? P-NAM,W?RUG,W?HOLE,W?PILE /TRUE
	EQUAL? P-NAM,W?PILES /TRUE
	RFALSE

	.FUNCT DIR-BASE,DIR,I,O,L,CNT
	GET DIR-TABLE,0 >L
	SET 'CNT,0
?L1:	ADD CNT,I >STACK
	GET DIR-TABLE,STACK >STACK
	EQUAL? STACK,DIR \?L4
	ADD CNT,O >STACK
	GET DIR-TABLE,STACK >STACK
	RSTACK
?L4:	ADD CNT,3 >CNT
	GRTR? CNT,L \?L1
	RTRUE

	.FUNCT NOT-HERE-OBJECT-F,TBL,PRSO?=1,OBJ,X=0
	EQUAL? PRSO,NOT-HERE-OBJECT \?L3
	EQUAL? PRSI,NOT-HERE-OBJECT \?L1
	PRINTR "Those things aren't here!"
?L1:	EQUAL? PRSO,NOT-HERE-OBJECT \?L3
	SET 'TBL,P-PRSO
	EQUAL? PRSA,V?FOLLOW,V?LEARN,V?WHAT /?L6
	EQUAL? PRSA,V?WHERE,V?WHO,V?WAIT-FOR /?L6
	EQUAL? PRSA,V?CAST,V?WALK-TO,V?FIND \?L8
?L6:	SET 'X,1
	JUMP ?L8
?L3:	SET 'TBL,P-PRSI
	EQUAL? PRSA,V?ASK-ABOUT,V?ASK-FOR,V?TELL-ABOUT \?L9
	SET 'X,1
?L9:	SET 'PRSO?,0
?L8:	ZERO? X /?L20
	CALL FIND-NOT-HERE,TBL,PRSO? >OBJ
	ZERO? OBJ /FALSE
	EQUAL? OBJ,NOT-HERE-OBJECT \TRUE
	EQUAL? PRSA,V?FIND,V?FOLLOW,V?WHERE /?L20
	EQUAL? PRSA,V?LEARN,V?CAST /?L20
	PRINT MORE-SPECIFIC
	PRINTR ", I'm afraid."
?L20:	EQUAL? WINNER,PLAYER \?L24
	PRINTI "You"
	JUMP ?L26
?L24:	CALL CTHE-PRINT,WINNER
?L26:	PRINTI " can't see"
	CALL NAME?,P-XNAM >STACK
	ZERO? STACK \?L27
	PRINTI " any"
?L27:	CALL NOT-HERE-PRINT,PRSO?
	PRINTI " here."
	CRLF
	CALL END-QUOTE >STACK
	RSTACK

	.FUNCT FIND-NOT-HERE,TBL,PRSO?,M-F,OBJ
	CALL MOBY-FIND,TBL >M-F
	EQUAL? 1,M-F \?L1
	ZERO? PRSO? /?L3
	SET 'PRSO,P-MOBY-FOUND
	RFALSE
?L3:	SET 'PRSI,P-MOBY-FOUND
	RFALSE
?L1:	RETURN NOT-HERE-OBJECT

	.FUNCT NOT-HERE-PRINT,PRSO?
	PRINTI " "
	ZERO? P-OFLAG /?L1
	ZERO? P-XADJ /?L3
	PRINTB P-XADJN
?L3:	ZERO? P-XNAM /FALSE
	PRINTB P-XNAM
	RTRUE
?L1:	CALL THING-PRINT,PRSO? >STACK
	RSTACK

	.FUNCT LIGHT-F
	EQUAL? PRSA,V?LAMP-ON \?L1
	FSET? HERE,ONBIT \?L3
	PRINT IT-IS-ALREADY
	PRINTI "light"
	PRINT PERIOD
	RTRUE
?L3:	PRINTR "Perhaps you should ""frotz"" something?"
?L1:	EQUAL? PRSA,V?LAMP-OFF \?L6
	PRINT WASTE-OF-TIME
	RTRUE
?L6:	EQUAL? PRSA,V?THROUGH \?L7
	EQUAL? HERE,GRUE-CAVE,PILLAR-ROOM \FALSE
	CALL GOTO,LIGHT-POOL >STACK
	RSTACK
?L7:	EQUAL? PRSA,V?EXAMINE \FALSE
	EQUAL? CHANGED?,GRUE \?L12
	EQUAL? HERE,LIGHT-POOL \?L14
	PRINTI "The light is so bright and painful you can barely stand it."
	CRLF
	CALL PRINT-ID,STR?53 >STACK
	RSTACK
?L14:	PRINTI "It hurts to look at light so dim you could hardly discern it normally."
	CRLF
	CALL PRINT-ID,STR?54 >STACK
	RSTACK
?L12:	EQUAL? HERE,DARK-CAVE,GRUE-CAVE \FALSE
	PRINTR "The light is in a small, dimly glowing pile."

	.FUNCT GLOBAL-HOLE-F
	EQUAL? PRSA,V?THROUGH,V?LEAP,V?CLIMB-DOWN \?L1
	CALL DO-WALK,P?DOWN >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?PUT \?L3
	CALL HELD?,PRSO >STACK
	ZERO? STACK /?L3
	EQUAL? PRSI,GLOBAL-HOLE \?L3
	MOVE PRSO,LOST-ON-LAND
	PRINTI "You drop "
	CALL THE-PRINT-PRSO
	PRINTR " through the hole, and it disappears."
?L3:	EQUAL? PRSA,V?LOOK-INSIDE,V?LOOK-DOWN \?L4
	PRINTR "You see clouds!"
?L4:	EQUAL? PRSA,V?REACH-IN \FALSE
	PRINTR "You find nothing of interest."

	.FUNCT CEILING-F
	EQUAL? PRSA,V?LOOK-UNDER \FALSE
	CALL PERFORM,V?LOOK
	RTRUE

	.FUNCT ICE-F
	IN? ICEBERG,HERE \?L1
	CALL REDIRECT,ICE,ICEBERG >STACK
	RSTACK
?L1:	ZERO? ICED-OBJECT /?L3
	CALL ACCESSIBLE?,ICED-OBJECT >STACK
	ZERO? STACK /?L3
	EQUAL? PRSA,V?EXAMINE \?L4
	PRINT IT-LOOKS-LIKE
	PRINTI "an icy "
	CALL DPRINT,ICED-OBJECT
	PRINT PERIOD
	RTRUE
?L4:	EQUAL? PRSA,V?RUB \FALSE
	PRINTR "It's cold."
?L3:	EQUAL? HERE,GLACIER-ROOM /FALSE
	PRINTR "There is no ice here."

	.FUNCT EYES-F
	EQUAL? PRSA,V?OPEN \?L1
	PRINTR "They are."
?L1:	EQUAL? PRSA,V?CLOSE \?L3
	PRINTR "That won't help."
?L3:	ZERO? LIT \?L4
	PRINT TOO-DARK
	RTRUE
?L4:	EQUAL? HERE,NORTH-SNAKE-ROOM,SOUTH-SNAKE-ROOM \FALSE
	EQUAL? PRSA,V?EXAMINE \?L6
	PRINTR "The eye stares balefully at you."
?L6:	CALL REDIRECT,EYES,SNAKE >STACK
	RSTACK

	.FUNCT PLAYER-F
	ZERO? CHANGED? /FALSE
	EQUAL? CHANGED?,GROUPER \?L3
	EQUAL? PRSA,V?WRITE,V?OPEN,V?CLOSE /?L6
	EQUAL? PRSA,V?TAKE,V?DROP,V?PUT \FALSE
?L6:	PRINTR "Your finny fins aren't capable of that."
?L3:	EQUAL? CHANGED?,GRUE \?L8
	EQUAL? PRSA,V?SLAVER \?L9
	PRINTR "You do that very well for such an inexperienced grue."
?L9:	EQUAL? PRSA,V?EAT \FALSE
	CALL HELD?,PRSO >STACK
	ZERO? STACK /FALSE
	REMOVE PRSO
	PRINTR "That tasted surprisingly good."
?L8:	EQUAL? CHANGED?,OGRE \FALSE
	EQUAL? PRSA,V?SMELL \FALSE
	PRINTR "You are completely congested and can't smell a thing. This may explain why, in spite of their appalling sanitary habits, ogres are not extinct."

	.FUNCT ME-F,OLIT
	EQUAL? PRSA,V?EXAMINE \?L1
	EQUAL? PRSO,ME \?L1
	CALL V-DIAGNOSE >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?TELL \?L3
	PRINTI "Talking to yourself is a sign of impending mental collapse."
	CRLF
	CALL END-QUOTE >STACK
	RSTACK
?L3:	EQUAL? PRSA,V?LISTEN \?L4
	PRINTR "Yes?"
?L4:	EQUAL? PRSA,V?ALARM \?L5
	PRINT YOU-ARE
	PRINT PERIOD
	RTRUE
?L5:	EQUAL? PRSA,V?GIVE \?L6
	EQUAL? PRSO,ME \?L7
	CALL V-SQUEEZE >STACK
	RSTACK
?L7:	EQUAL? PRSI,ME \FALSE
	IN? PRSO,PLAYER \?L10
	CALL PRE-TAKE >STACK
	RSTACK
?L10:	CALL PERFORM,V?TAKE,PRSO
	RTRUE
?L6:	EQUAL? PRSA,V?MOVE \?L14
	CALL V-WALK-AROUND >STACK
	RSTACK
?L14:	EQUAL? PRSA,V?SEARCH \?L15
	CALL V-INVENTORY
	RTRUE
?L15:	EQUAL? PRSA,V?KILL,V?MUNG,V?PLANT \?L16
	CALL PRINT-ID,STR?55
	CALL JIGS-UP,STR?56
	RTRUE
?L16:	EQUAL? PRSA,V?WHO \?L17
	CALL V-WHAT >STACK
	RSTACK
?L17:	EQUAL? PRSA,V?FOLLOW \?L18
	PRINTR "You're getting ahead of yourself."
?L18:	EQUAL? PRSA,V?WRITE,V?WRITE-ON \?L19
	PRINT YOU-ARENT
	PRINTR "a tattoo artist!"
?L19:	EQUAL? PRSA,V?TINSOT \?L20
	PRINTR "You are covered with a thin film of ice, which shatters as soon as you move."
?L20:	EQUAL? PRSA,V?CASKLY \?L21
	CALL V-SQUEEZE >STACK
	RSTACK
?L21:	EQUAL? PRSA,V?YOMIN \FALSE
	PRINTR "You would know better than I."

	.FUNCT GLOBAL-ROOM-F
	EQUAL? PRSA,V?LOOK,V?EXAMINE,V?LOOK-INSIDE \?L1
	CALL V-LOOK
	RTRUE
?L1:	EQUAL? PRSA,V?THROUGH,V?WALK-TO \?L3
	CALL V-WALK-AROUND >STACK
	RSTACK
?L3:	EQUAL? PRSA,V?DROP,V?LEAVE,V?EXIT \?L4
	CALL DO-WALK,P?OUT >STACK
	RSTACK
?L4:	EQUAL? PRSA,V?WALK-AROUND \?L5
	PRINTR "Walking around the room reveals nothing new. To move elsewhere, just type the desired direction."
?L5:	EQUAL? PRSA,V?LAMP-ON \FALSE
	CALL PERFORM,V?LAMP-ON,LIGHT
	RTRUE

	.FUNCT WALL-F
	EQUAL? PRSA,V?EXAMINE \FALSE
	EQUAL? HERE,MAZE-ANTEROOM \?L3
	EQUAL? PRSO,NORTH-WALL \?L3
	ZERO? MAZE-EXIT-FLAG /?L3
	PRINTR "There is a hole there."
?L3:	GETPT HERE,P?EXITS >STACK
	ZERO? STACK /?L5
	PRINTI "The wall is marble."
	CALL DESCRIBE-MAZE-WALLS
	CRLF
	RTRUE
?L5:	PRINT IT-LOOKS-LIKE
	PRINTR "a wall."

	.FUNCT GROUND-F
	EQUAL? PRSA,V?EXAMINE \?L1
	ZERO? FALLING? /?L3
	PRINTR "You can see the ground rushing towards you from below, or vice versa."
?L3:	FSET? HERE,RAIRBIT \?L5
	PRINTR "It's a long way down."
?L5:	PRINTR "It's still there."
?L1:	EQUAL? PRSA,V?PUT \?L7
	EQUAL? GROUND,PRSI \?L7
	EQUAL? PRSO,WEED \?L8
	CALL PERFORM,V?PLANT,WEED
	RTRUE
?L8:	CALL PERFORM,V?DROP,PRSO
	RTRUE
?L7:	EQUAL? PRSA,V?CLIMB-UP,V?CLIMB-ON,V?CLIMB-FOO /?L12
	EQUAL? PRSA,V?BOARD \?L11
?L12:	PRINT WASTE-OF-TIME
	RTRUE
?L11:	EQUAL? PRSA,V?LOOK-UNDER \FALSE
	PRINTR "You've never mastered an X-ray vision spell."

	.FUNCT CORRIDOR-F
	EQUAL? PRSA,V?THROUGH,V?WALK-TO \FALSE
	CALL V-WALK-AROUND >STACK
	RSTACK

	.FUNCT WALLS-F
	FSET? HERE,RAIRBIT \FALSE
	PRINTR "What wall?"

	.FUNCT GLOBAL-GRUE-F
	EQUAL? WINNER,GLOBAL-GRUE \?L1
	PRINTI "There is no answer."
	CALL END-QUOTE >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?WHAT \?L3
	PRINTR "Grues are darkness-loving, enchanterivorous monsters."
?L3:	CALL HOSTILE-VERB? >STACK
	ZERO? STACK \?L6
	EQUAL? PRSA,V?EXAMINE,V?RAISE,V?LOWER /?L6
	EQUAL? PRSA,V?SMELL,V?TAKE,V?LOOK-UNDER \?L4
?L6:	CALL CANT-SEE-GRUE >STACK
	RSTACK
?L4:	EQUAL? PRSA,V?WHERE \?L7
	PRINTI "There is no grue here, but I'm sure there is at least one"
	PRINT LURKING
	PRINTR " I'd stay near a light source if I were you!"
?L7:	EQUAL? PRSA,V?LISTEN \?L8
	PRINTI "It makes no sound but is always"
	PRINT LURKING
	CRLF
	RTRUE
?L8:	EQUAL? PRSA,V?FROTZ \?L9
	ZERO? LIT /?L10
	PRINTR "There aren't any grues here -- it's light!"
?L10:	PRINTI "There's a flash of light nearby, and you glimpse a horrible, multifanged creature, a look of sheer terror on its face. It charges away, gurgling in agony, tearing at its glowing fur."
	CRLF
	CALL PRINT-ID,STR?57 >STACK
	RSTACK
?L9:	EQUAL? PRSA,V?SNAVIG \?L13
	CALL CANT-SEE-GRUE >STACK
	RSTACK
?L13:	CALL SPELL-VERB? >STACK
	ZERO? STACK /FALSE
	PRINTR "Nothing happens. Either there are no grues nearby, or they were able to dodge in time."

	.FUNCT CANT-SEE-GRUE
	PRINT YOU-CANT-SEE
	PRINTR "any grue here (thankfully)."

	.FUNCT GRUE-F,OLIT
	EQUAL? CHANGED?,GRUE /?L1
	EQUAL? HERE,GRUE-CAVE,PILLAR-ROOM,LIGHT-POOL /?L1
	CALL REDIRECT,GRUE,GLOBAL-GRUE >STACK
	RSTACK
?L1:	EQUAL? WINNER,GRUE \?L3
	EQUAL? CHANGED?,GRUE \?L4
	CALL JIGS-UP,STR?58
	JUMP ?L6
?L4:	CALL CALLED-ATTENTION
?L6:	CALL END-QUOTE >STACK
	RSTACK
?L3:	EQUAL? PRSA,V?EXAMINE,V?LOOK-UNDER \?L7
	ZERO? LIT /?L8
	PRINTR "The grues look exactly as you would expect, only worse."
?L8:	CALL GLOBAL-GRUE-F >STACK
	RSTACK
?L7:	EQUAL? PRSA,V?GIVE \?L11
	EQUAL? PRSI,GRUE \?L11
	FSET? PRSO,ONBIT \?L12
	CALL GRUES-NOTICE-LIGHT >STACK
	RSTACK
?L12:	REMOVE PRSO
	EQUAL? PRSO,BREAD,FISH \?L15
	PRINTI "The grue snarls at you, but takes it anyway"
	JUMP ?L17
?L15:	PRINTI "It looks quizzically at the "
	PRINTD PRSO
	PRINTI ", then snatches it"
?L17:	PRINTR " and noisily wolfs it down, teeth tearing it into tiny gobbets."
?L11:	CALL HOSTILE-VERB? >STACK
	ZERO? STACK \?L19
	EQUAL? PRSA,V?RAISE,V?LOWER,V?TAKE \?L18
?L19:	EQUAL? CHANGED?,GRUE \?L20
	CALL JIGS-UP,STR?59 >STACK
	RSTACK
?L20:	CALL CALLED-ATTENTION >STACK
	RSTACK
?L18:	EQUAL? PRSA,V?WHERE \?L23
	PRINTR "There are grues all around."
?L23:	EQUAL? PRSA,V?LISTEN \?L24
	PRINTR "The grues gurgle unsettlingly, intent upon their business."
?L24:	EQUAL? PRSA,V?SNAVIG \?L25
	EQUAL? HERE,GRUE-CAVE,LIGHT-POOL,PILLAR-ROOM \?L26
	PRINTI "You feel yourself changing in a very unpleasant way. Your claws feel odd, and you have an uncontrollable tendency to slaver. You gurgle vilely to yourself, worrying about the presence of light."
	FSET? WINNER,ONBIT \?L28
	CALL PRINT-ID,STR?60
	CALL JIGS-UP,STR?61 >STACK
	RSTACK
?L28:	EQUAL? HERE,GRUE-CAVE \?L31
	PRINTI " Directly in front of you, a horrific creature recoils with a look of shocked surprise. It scuttles off, perplexed."
?L31:	CALL LIT?,HERE >OLIT
	ZERO? OLIT /?L34
	PRINTI " The light from "
	CALL THE-PRINT,OLIT
	PRINTI " hurts your eyes."
	CALL PRINT-ID,STR?62
?L34:	SET 'CHANGED?,GRUE
	CALL QUEUE,I-SNAVIG,12
	CALL LIT?,HERE >LIT
	CRLF
	CRLF
	CALL PERFORM,V?LOOK
	RTRUE
?L26:	PRINTR "You see no grues here."
?L25:	EQUAL? PRSA,V?YOMIN \?L38
	PRINTR "You sense ravening hunger and a nasty, mean, and brutish disposition."
?L38:	CALL SPELL-VERB? >STACK
	ZERO? STACK /FALSE
	EQUAL? CHANGED?,GRUE /?L40
	ZERO? LIT /?L40
	CALL GLOBAL-GRUE-F >STACK
	RSTACK
?L40:	PRINT NOTHING-HAPPENS
	RTRUE

	.FUNCT CALLED-ATTENTION
	CALL JIGS-UP,STR?63 >STACK
	RSTACK

	.FUNCT WATER-F
	EQUAL? PRSA,V?POUR,V?THROW \?L1
	EQUAL? PRSO,LOCAL-WATER \?L1
	LOC PRSO >STACK
	ZERO? STACK /?L3
	LOC PRSO >STACK
	IN? STACK,WINNER \?L3
	LOC PRSO >STACK
	CALL PERFORM,V?POUR,STACK
	RTRUE
?L3:	CALL DONT-HAVE-THAT >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?EAT,V?DRINK,V?DRINK-FROM \?L6
	EQUAL? PRSO,LOCAL-WATER \?L20
	LOC PRSO >STACK
	IN? STACK,WINNER \?L9
	LOC PRSO >STACK
	FSET? STACK,OPENBIT \?L11
	REMOVE PRSO
	JUMP ?L14
?L11:	CALL TELL-OPEN-CLOSED,BOTTLE
	RTRUE
?L9:	CALL GLOBAL-IN?,WATER,HERE >STACK
	ZERO? STACK \?L14
	PRINT YOU-DONT-HAVE
	LOC PRSO >STACK
	CALL THE-PRINT,STACK
	PRINT PERIOD
	RTRUE
?L14:	EQUAL? PRSO,LOCAL-WATER \?L20
	FSET? PRSO,RMUNGBIT /?L19
?L20:	EQUAL? PRSO,WATER \?L17
	EQUAL? HERE,OCEAN-ROOM,LOST-IN-OCEAN,OCEAN-FLOOR \?L17
?L19:	PRINTI "It's bitter and you spit it out immediately."
	CALL PRINT-ID,STR?64
	CRLF
	RTRUE
?L17:	PRINTI "That was refreshing, but you shouldn't drink untested water."
	CALL PRINT-ID,STR?65
	CRLF
	RTRUE
?L6:	EQUAL? PRSA,V?REACH-IN,V?RUB \?L22
	PRINTR "It's wet."
?L22:	EQUAL? PRSA,V?LOOK-INSIDE,V?LOOK-UNDER \?L23
	CALL MAKE-OUT >STACK
	RSTACK
?L23:	EQUAL? PRSA,V?THROUGH,V?LEAP \FALSE
	FSET? HERE,RWATERBIT \FALSE
	PRINT YOU-ARE
	PRINT PERIOD
	RTRUE

	.FUNCT RETREAT-F,RARG
	EQUAL? RARG,M-LOOK \?L1
	PRINTR "The Enchanters' Retreat is an old stone structure perched high in the mountains. For generations, retired (or even burnt-out) enchanters have come here to breathe the clean mountain air, watch the stars, and rest from their exertions. The appointments are simple, the fare is unsophisticated, but those here have a look of quiet contentment that is easy for you to envy."
?L1:	EQUAL? RARG,M-BEG \FALSE
	EQUAL? PRSA,V?WALK \?L4
	PRINTR "Belboz stops you. ""You should not even be here. You will disturb our rest."""
?L4:	EQUAL? PRSA,V?ANSWER,V?YES,V?NO \?L6
	CALL PERFORM,V?REPLY,BELBOZ
	RTRUE
?L6:	EQUAL? PRSA,V?SAY \FALSE
	ZERO? BELBOZ-ASKS /FALSE
	ZERO? BELBOZ-CONVINCED? \FALSE
	SUB P-CONT,P-LEXELEN >STACK
	CALL QUOTED-PHRASE,STACK,ACT?ANSWER
	CALL ORPHAN-VERB,W?ANSWER,ACT?ANSWER >STACK
	RSTACK

	.FUNCT BELBOZ-F,RARG=0
	EQUAL? WINNER,BELBOZ \?L1
	EQUAL? PRSA,V?TELL-ABOUT \?L3
	EQUAL? PRSO,ME /FALSE
?L3:	EQUAL? PRSA,V?HELLO \?L5
	PRINTR """Hello."" Belboz doesn't seem pleased to see you."
?L5:	ZERO? BELBOZ-CONVINCED? \?L6
	PRINTI "Belboz looks at you suspiciously. "
	ZERO? BELBOZ-ASKS /?L7
	PRINTR """Please answer my question, or I shall be forced to conclude you are an imposter."""
?L7:	PRINTI """You were here a few days ago, or rather someone who resembled you strongly enough to be your twin was here. This being betrayed its true nature, however, as it did not know facts which would be trifles to even the rawest apprentice. It fled before I could capture it. Prove to me that you are truly yourself, and answer me a question. "
	GET QUESTIONS,0 >STACK
	RANDOM STACK >BELBOZ-ASKS
	CALL ORPHAN-VERB,W?ANSWER,ACT?ANSWER
	GET QUESTIONS,BELBOZ-ASKS >STACK
	PRINT STACK
	PRINTR "?"""
?L6:	EQUAL? PRSA,V?GIVE \?L10
	PRINTR """All in good time."""
?L10:	EQUAL? PRSA,V?HELP \?L11
	EQUAL? PRSO,0,ME \?L11
	PRINTR "The great mage looks tired. ""That is beyond my power,"" he says. ""I have given up worldly affairs. My time is past, I am old, and the world is now in the care of my successors. I am convinced you will not fail."""
?L11:	EQUAL? PRSA,V?TELL-ME-ABOUT \?L12
	EQUAL? PRSO,MAGIC \?L13
	PRINTR """I can tell you nothing which you do not already know. We live in perilous times."""
?L13:	EQUAL? PRSO,SHADOW \?L15
	PRINTR """I have encountered such creatures, but this one is unfamiliar to me. They are sometimes spirits of the dead, or demons, or even illusory sendings."""
?L15:	EQUAL? PRSO,SNAKE \?L16
	PRINTR """This serpent brings to mind the great Ouroboros, said to encircle the world."""
?L16:	EQUAL? PRSO,KEY \?L17
	PRINTR """It was left nearby."""
?L17:	GETP PRSO,P?CUBE >STACK
	ZERO? STACK /?L18
	CALL HELD?,PRSO >STACK
	ZERO? STACK /?L19
	PRINTI "Belboz looks at the cube for a while, turning it over and over in his hands."
	JUMP ?L21
?L19:	PRINTI "Belboz thinks for a while."
?L21:	PRINTI " ""There is a legend about cubes. When the foundations of the world were laid down, it is said that the elemental powers and forces were symbolized during the making by small cubes. The cubes and the forces were merged in a way that our knowledge no longer comprehends. When the making was done, the cubes were hidden away where their powers could not be tampered with. If someone has gained access to them, or rediscovered the knowledge of their making, we are in terrible danger. One who had power over these cubes could change the very structure of our universe. Such a one would have powers I do not care to contemplate."""
	CALL HELD?,PRSO >STACK
	ZERO? STACK /?L22
	PRINTI " Belboz gives back the cube."
?L22:	CRLF
	RTRUE
?L18:	EQUAL? PRSO,PSEUDO-OBJECT \?L25
	PRINTR """I know little you do not know yourself."""
?L25:	PRINTR """I know nothing of interest about that."""
?L12:	PRINTR "Belboz looks at you, but says nothing."
?L1:	EQUAL? RARG,M-CONTAINER \?L28
	EQUAL? PRSA,V?TAKE \FALSE
	CALL FORLORN-ENCYSTMENT >STACK
	RSTACK
?L28:	ZERO? RARG \FALSE
	EQUAL? PRSA,V?TELL \?L33
	ZERO? BELBOZ-ASKS /?L33
	ZERO? BELBOZ-CONVINCED? \?L33
	CALL ORPHAN-VERB,W?ANSWER,ACT?ANSWER
	RFALSE
?L33:	EQUAL? PRSA,V?EXAMINE \?L35
	PRINTR "Belboz looks the same as always, ageless at an age when most have already departed the world. Outwardly, he seems relaxed and carefree."
?L35:	EQUAL? PRSA,V?SHOW \?L36
	SET 'WINNER,BELBOZ
	CALL PERFORM,V?TELL-ME-ABOUT,PRSO
	SET 'WINNER,PLAYER
	RTRUE
?L36:	EQUAL? PRSA,V?ASK-FOR \?L37
	SET 'WINNER,BELBOZ
	CALL PERFORM,V?GIVE,ME,PRSO
	SET 'WINNER,PLAYER
	RTRUE
?L37:	EQUAL? PRSA,V?WHO \?L38
	PRINTR "Belboz the Necromancer was head of the Accardi-by-the-sea chapter of the Guild of Enchanters until his recent retirement. You owe your position (and your life) to him, and it is partly because he was your mentor that you have achieved your present position. When he retired, he expressed an interest in rest, meditation and learning to arrange flowers."
?L38:	ZERO? BELBOZ-CONVINCED? \?L39
	EQUAL? PRSA,V?REPLY \?L40
	EQUAL? PRSO,BELBOZ \?L39
	ZERO? PRSI \?L39
	CALL ORPHAN-VERB,W?ANSWER,ACT?ANSWER
	PRINTR """Yes? What is the answer?"""
?L39:	EQUAL? PRSA,V?REPLY \?L40
	CALL ANSWER-BELBOZ >STACK
	RSTACK
?L40:	EQUAL? PRSA,V?YOMIN \?L41
	PRINTI "You sense peacefulness"
	ZERO? BELBOZ-CONVINCED? \?L42
	PRINTI " overlaid upon a foundation of worry"
?L42:	PRINT PERIOD
	RTRUE
?L41:	CALL HOSTILE-VERB? >STACK
	ZERO? STACK \?L46
	EQUAL? PRSA,V?ESPNIS,V?LISKON,V?SNAVIG /?L46
	EQUAL? PRSA,V?TINSOT \?L45
?L46:	PRINTI "Belboz stops you with a word of power."
	CRLF
	CALL PRINT-ID,STR?66
	CALL FORLORN-ENCYSTMENT >STACK
	RSTACK
?L45:	EQUAL? PRSA,V?WHERE,V?FIND \FALSE
	IN? BELBOZ,HERE /?L48
	FSET? RETREAT,TOUCHBIT /?L48
	PRINTR "You last saw Belboz months ago, when he left for the Enchanters' Retreat in the mountains."
?L48:	PRINTR "I would assume he is still at the Retreat."

	.FUNCT ANSWER-BELBOZ
	ZERO? BELBOZ-ASKS /?L1
	ZERO? BELBOZ-CONVINCED? \?L1
	EQUAL? PRSO,PSEUDO-OBJECT,BELBOZ \?L3
	EQUAL? PRSI,0,PSEUDO-OBJECT \?L3
	GET ANSWERS,BELBOZ-ASKS >STACK
	CALL CORRECT?,STACK >STACK
	ZERO? STACK \?L5
	SET 'FAKE-KEY,1
?L5:	ADD SCORE,25 >SCORE
	SET 'BELBOZ-CONVINCED?,1
	PRINTI """Good! I knew it was you all along. What may I do for you?"""
	IN? KEY,BELBOZ \?L8
	FCLEAR KEY,NDESCBIT
	MOVE KEY,WINNER
	PRINTI " He fumbles in his pouch for a moment. ""First, let me give you this."" He hands you a "
	PRINTD KEY
	PRINTI ". ""It may prove useful."""
?L8:	CRLF
	RTRUE
?L3:	CALL FORLORN-ENCYSTMENT >STACK
	RSTACK
?L1:	PRINTR """I asked no question,"" says Belboz."

	.FUNCT FORLORN-ENCYSTMENT
	SET 'DEATHS,3
	CALL PRINT-ID,STR?67
	CALL JIGS-UP,STR?68 >STACK
	RSTACK

	.FUNCT CORRECT?,WRD
	EQUAL? WRD,P-PNAM /TRUE
	EQUAL? WRD,W?BARBEL \?L3
	EQUAL? P-PADJN,W?BARBEL,0 \?L3
	EQUAL? P-PNAM,W?GURTH /TRUE
?L3:	EQUAL? WRD,W?GUSTAR \?L4
	EQUAL? P-PADJN,W?GUSTAR,0 \?L4
	EQUAL? P-PNAM,W?WOOMAX /TRUE
?L4:	EQUAL? WRD,W?DIMITHIO \?L5
	EQUAL? P-PADJN,W?DIMITHIO,0 \?L5
	EQUAL? P-PNAM,W?BORPHEE /TRUE
?L5:	EQUAL? WRD,W?FORBURN \FALSE
	EQUAL? P-PADJN,W?FORBURN,0 \FALSE
	EQUAL? P-PNAM,W?WILY \FALSE
	RTRUE

	.FUNCT ANSWER-PSEUDO
	EQUAL? PRSA,V?WHO \?L1
	PRINTR "You studied his career while still an apprentice."
?L1:	EQUAL? PRSA,V?REPLY \FALSE
	EQUAL? PRSO,PSEUDO-OBJECT \FALSE
	EQUAL? HERE,RETREAT \FALSE
	CALL PERFORM,V?REPLY,BELBOZ,PRSO
	RTRUE

	.FUNCT PLURAL-PSEUDO
	CALL RANDOM-PSEUDO,1 >STACK
	RSTACK

	.FUNCT RANDOM-PSEUDO,PLURAL?=0
	EQUAL? PRSA,V?EXAMINE \?L1
	ZERO? PLURAL? /?L3
	PRINTI "They look"
	JUMP ?L5
?L3:	PRINTI "It looks"
?L5:	PRINTR " exactly as you would expect."
?L1:	EQUAL? PRSA,V?TAKE \FALSE
	PRINTR "You're an enchanter, not a garbage collector."

	.FUNCT REDIRECT,FROM,TO
	EQUAL? PRSI,FROM \?L1
	PUSH TO
	JUMP ?L3
?L1:	PUSH PRSI
?L3:	EQUAL? PRSO,FROM \?L4
	PUSH TO
	JUMP ?L6
?L4:	PUSH PRSO
?L6:	CALL PERFORM,PRSA,STACK,STACK
	RTRUE

	.FUNCT GLOBAL-SLEEP-F
	EQUAL? PRSA,V?WALK-TO,V?TAKE \?L1
	CALL PERFORM,V?SLEEP
	RTRUE
?L1:	EQUAL? PRSA,V?FIND \FALSE
	PRINTR "Sleep anywhere."

	.FUNCT MAGIC-F
	EQUAL? PRSA,V?WHAT \FALSE
	PRINTR "The Guild will be surprised to hear you don't know."

	.FUNCT DONT-HAVE-THAT
	PRINT YOU-DONT-HAVE
	PRINTI "that"
	PRINT PERIOD
	RTRUE

	.FUNCT CANT-GO
	PRINT YOU-CANT
	PRINTR "go that way."

	.FUNCT NOT-HOLDING,OBJ
	PRINT YOU-ARENT
	PRINTI "holding "
	CALL THE-PRINT,OBJ
	PRINT PERIOD
	RTRUE

	.FUNCT ITS-EMPTY
	CALL CTHE-PRINT-PRSO
	PRINTI " is empty"
	PRINT PERIOD
	RTRUE

	.FUNCT ALREADY-OPEN
	PRINT IT-IS-ALREADY
	PRINTI "open"
	PRINT PERIOD
	RTRUE

	.FUNCT ALREADY-CLOSED
	PRINT IT-IS-ALREADY
	PRINTI "closed"
	PRINT PERIOD
	RTRUE

	.FUNCT MAKE-OUT
	PRINT YOU-CANT
	PRINTR "make out anything."

	.FUNCT WITH-PRSI?
	PRINTI "With "
	CALL A-PRSI? >STACK
	RSTACK

	.FUNCT TELL-OPEN-CLOSED,OBJ=0
	ZERO? OBJ /?L1
	CALL CTHE-PRINT,OBJ
	JUMP ?L3
?L1:	SET 'OBJ,PRSO
	CALL THE-PRINT-PRSO
?L3:	PRINTI " is "
	FSET? OBJ,OPENBIT \?L4
	PRINTI "open"
	JUMP ?L6
?L4:	PRINTI "closed"
?L6:	PRINT PERIOD
	RTRUE

	.FUNCT THE-PRSO
	CALL THE-PRINT-PRSO
	PRINT PERIOD
	RTRUE

	.FUNCT A-PRSO
	CALL PRINTA-PRSO
	PRINT PERIOD
	RTRUE

	.FUNCT A-PRSO?
	CALL PRINTA-PRSO
	PRINTR "?"

	.FUNCT THE-PRSI
	CALL THE-PRINT-PRSI
	PRINT PERIOD
	RTRUE

	.FUNCT A-PRSI
	CALL PRINTA-PRSI
	PRINT PERIOD
	RTRUE

	.FUNCT A-PRSI?
	CALL PRINTA-PRSI
	PRINTR "?"

	.FUNCT YOU-CANT-X-THAT,STR
	PRINT YOU-CANT
	PRINT STR
	PRINTR " that!"

	.FUNCT YOU-CANT-X-PRSO,STR
	PRINT YOU-CANT
	PRINT STR
	PRINTI " "
	ZERO? PRSO /?L1
	CALL THE-PRINT-PRSO
	JUMP ?L3
?L1:	PRINTI "that"
?L3:	PRINT PERIOD
	RTRUE

	.FUNCT YOU-CANT-X-PRSI,STR
	PRINT YOU-CANT
	PRINT STR
	PRINTI " "
	ZERO? PRSI /?L1
	CALL THE-PRINT-PRSI
	JUMP ?L3
?L1:	PRINTI "that"
?L3:	PRINT PERIOD
	RTRUE

	.FUNCT UNINTERESTED,OBJ
	EQUAL? OBJ,ME \?L1
	CALL TELL-YUKS >STACK
	RSTACK
?L1:	CALL CTHE-PRINT,OBJ
	PRINTR " is uninterested."

	.FUNCT CANT-REACH-THAT
	PRINT YOU-CANT-REACH
	PRINTR "that."

	.FUNCT CANT-REACH-IT
	PRINT YOU-CANT-REACH
	PRINTR "it."

	.FUNCT V-VERBOSE
	SET 'VERBOSITY,2
	PRINTI "Verbose"
	PRINT DESCRIPTIONS
	PRINT PERIOD
	CRLF
	CALL V-LOOK >STACK
	RSTACK

	.FUNCT V-BRIEF
	SET 'VERBOSITY,1
	PRINTI "Brief"
	PRINT DESCRIPTIONS
	PRINT PERIOD
	RTRUE

	.FUNCT V-SUPER-BRIEF
	SET 'VERBOSITY,0
	PRINTI "Super-brief"
	PRINT DESCRIPTIONS
	PRINT PERIOD
	RTRUE

	.FUNCT V-DIAGNOSE
	PRINTI "You are "
	ZERO? SMALL-FLAG /?L1
	PRINTI "shrunken, "
?L1:	ZERO? CHANGED? /?L4
	PRINTI "transformed into a "
	PRINTD CHANGED?
	PRINTI ", "
?L4:	LESS? AWAKE,0 \?L7
	PRINTI "wide awake"
	JUMP ?L9
?L7:	GET TIRED-TELL,AWAKE >STACK
	PRINT STACK
?L9:	PRINTI ", and in "
	GRTR? FREEZE-COUNT,4 \?L10
	PRINTI "danger of freezing to death"
	JUMP ?L12
?L10:	PRINTI "good health"
?L12:	PRINT PERIOD
	RTRUE

	.FUNCT V-INVENTORY
	FIRST? WINNER >STACK \?L1
	CALL PRINT-CONT,WINNER >STACK
	RSTACK
?L1:	PRINTR "You are empty-handed."

	.FUNCT V-QUIT,ASK?=1,SCOR
	CALL V-SCORE
	ZERO? ASK? /?L3
	PRINTI "Do you wish to leave the game"
	CALL YES? >STACK
	ZERO? STACK \?L3
	ZERO? ASK? \?L1
?L3:	QUIT
?L1:	PRINT OKAY
	RTRUE

	.FUNCT V-RESTART
	CALL V-SCORE,1
	PRINTI "Do you wish to restart"
	CALL YES? >STACK
	ZERO? STACK /FALSE
	PRINTI "Restarting."
	CRLF
	RESTART

	.FUNCT FINISH,WRD
	CALL V-SCORE
	CRLF
?L1:	CRLF
	PRINTI "[EVENT: GAME OVER]Would you like to restart the game from the beginning, restore a saved game position, or end this session of the game?
(Type RESTART, RESTORE, or QUIT):
>"
	READ P-INBUF,P-LEXV
	GET P-LEXV,1 >WRD
	EQUAL? WRD,W?RESTAR \?L3
	RESTART
?L3:	EQUAL? WRD,W?RESTOR \?L5
	RESTORE \?L6
	PRINT OKAY
	JUMP ?L1
?L6:	PRINT FAILED
	JUMP ?L1
?L5:	EQUAL? WRD,W?QUIT,W?Q \?L1
	QUIT

	.FUNCT YES?
	PRINTI "?
(Y is affirmative): >"
	READ P-INBUF,P-LEXV
	GET P-LEXV,1 >STACK
	EQUAL? STACK,W?YES,W?Y \FALSE
	RTRUE

	.FUNCT V-RESTORE
	RESTORE /TRUE
	PRINT FAILED
	RTRUE

	.FUNCT V-SAVE,X
	PUTB OOPS-INBUF,1,0
	SAVE /?L1
	SET 'X,0
	JUMP ?L2
?L1:	SET 'X,1
?L2:	ZERO? X \?L3
	PRINT FAILED
	RTRUE
?L3:	PRINT OKAY
	RTRUE

	.FUNCT V-SCORE,ASK?=1
	PRINTI "Your score is "
	PRINTN SCORE
	PRINTI " of a possible 600, in "
	PRINTN MOVES
	PRINTI " move"
	EQUAL? MOVES,1 /?L1
	PRINTI "s"
?L1:	PRINTI ". This puts you in the class of "
	LESS? SCORE,0 \?L4
	PRINTI "Menace to Society"
	JUMP ?L6
?L4:	DIV SCORE,50 >STACK
	GET RANKINGS,STACK >STACK
	PRINT STACK
?L6:	PRINT PERIOD
	RETURN SCORE

	.FUNCT V-SCRIPT
	GET 0,8 >STACK
	BOR STACK,1 >STACK
	PUT 0,8,STACK
	PRINTI "Here begins"
	PRINT COPR-NOTICE
	CRLF
	CALL V-VERSION >STACK
	RSTACK

	.FUNCT V-UNSCRIPT
	PRINTI "Here ends"
	PRINT COPR-NOTICE
	CRLF
	CALL V-VERSION
	GET 0,8 >STACK
	BAND STACK,-2 >STACK
	PUT 0,8,STACK
	RTRUE

	.FUNCT V-VERSION,CNT
	PRINTI "SPELLBREAKER
An Interactive Fantasy
Copyright (c) 1985 by Infocom, Inc. All rights reserved.
SPELLBREAKER is a trademark of Infocom, Inc.
Release "
	GET 0,1 >STACK
	BAND STACK,2047 >STACK
	PRINTN STACK
	PRINTI " / Serial number "
	SET 'CNT,18
?L1:	GETB 0,CNT >STACK
	PRINTC STACK
	IGRTR? 'CNT,23 \?L1
	CRLF
	RTRUE

	.FUNCT V-$0024VERIFY
	EQUAL? PRSO,INTNUM \?L1
	EQUAL? P-NUMBER,1066 \?L1
	PRINTN SERIAL
	CRLF
	RTRUE
?L1:	ZERO? PRSO /?L3
	PRINT NOT-RECOGNIZED
	CRLF
	RTRUE
?L3:	PRINTI "Verifying..."
	CRLF
	VERIFY \?L5
	PRINTR "The disk is correct."
?L5:	CRLF
	PRINTR "** Disk Failure **"

	.FUNCT V-ALARM
	EQUAL? PRSO,ROOMS \?L1
	CALL PERFORM,V?ALARM,ME
	RTRUE
?L1:	EQUAL? PRSO,ESPNIS? \?L3
	PRINTI "It would take more than that to awaken "
	CALL THE-PRSO >STACK
	RSTACK
?L3:	PRINT I-DONT-THINK-THAT
	CALL THE-PRINT-PRSO
	PRINTR " is sleeping."

	.FUNCT V-ANSWER
	PRINTI "Nobody is awaiting your answer."
	CRLF
	CALL END-QUOTE >STACK
	RSTACK

	.FUNCT PRE-ASK-ABOUT,P
	ZERO? PRSI \FALSE
	CALL FIND-IN,HERE,PERSON >P
	ZERO? P /FALSE
	CALL PERFORM,PRSA,P,PRSO
	RTRUE

	.FUNCT V-ASK-ABOUT,OWINNER
	EQUAL? PRSO,ME \?L1
	CALL PERFORM,V?TELL,ME
	RTRUE
?L1:	FSET? PRSO,PERSON \?L3
	SET 'OWINNER,WINNER
	SET 'WINNER,PRSO
	CALL PERFORM,V?TELL-ME-ABOUT,PRSI
	SET 'WINNER,OWINNER
	RTRUE
?L3:	CALL PERFORM,V?TELL,PRSO
	RTRUE

	.FUNCT FIND-IN,WHERE,WHAT,W
	FIRST? WHERE >W \FALSE
?L1:	FSET? W,WHAT \?L4
	CALL VISIBLE?,W >STACK
	ZERO? STACK /?L4
	RETURN W
?L4:	NEXT? W >W /?L1
	RFALSE

	.FUNCT PRE-ASK-FOR
	CALL PRE-ASK-ABOUT >STACK
	RSTACK

	.FUNCT V-ASK-FOR,OWINNER
	EQUAL? PRSO,ME \?L1
	CALL PERFORM,V?TAKE,PRSI
	RTRUE
?L1:	FSET? PRSO,PERSON \?L3
	SET 'OWINNER,WINNER
	SET 'WINNER,PRSO
	CALL PERFORM,V?GIVE,PRSI,ME
	SET 'WINNER,OWINNER
	RTRUE
?L3:	PRINTI "It's unlikely that "
	CALL THE-PRINT-PRSO
	PRINTR " will oblige."

	.FUNCT V-ATTACK
	CALL IKILL,STR?69 >STACK
	RSTACK

	.FUNCT V-BITE
	CALL HACK-HACK,STR?70 >STACK
	RSTACK

	.FUNCT PRE-BOARD,AV
	LOC WINNER >AV
	FSET? PRSO,VEHBIT /?L3
	EQUAL? PRSO,PSEUDO-OBJECT \?L1
	GETP PSEUDO-OBJECT,P?ACTION >STACK
	EQUAL? STACK,POOL-PSEUDO \?L1
?L3:	EQUAL? AV,PRSO \?L4
	PRINT YOU-ARE
	PRINT PERIOD
	RETURN 2
?L4:	FSET? AV,VEHBIT \FALSE
	CALL HELD?,PRSO,AV >STACK
	ZERO? STACK /FALSE
	PRINT YOU-HAVE-TO
	PRINTI " leave "
	CALL THE-PRINT,AV
	PRINTI " first"
	PRINT PERIOD
	RETURN 2
?L1:	PRINT YOU-CANT
	PRINTI "get into "
	CALL THE-PRINT-PRSO
	PRINTI "!"
	CRLF
	RETURN 2

	.FUNCT YOU-ARE-IN,AV
	PRINT YOU-ARE
	FSET? AV,SURFACEBIT \?L1
	PUSH STR?71
	JUMP ?L3
?L1:	PUSH STR?72
?L3:	PRINT STACK
	CALL THE-PRINT,AV
	PRINTR "!"

	.FUNCT V-BOARD,AV
	PRINT YOU-ARE-NOW
	PRINTI "in "
	CALL THE-PRSO
	MOVE WINNER,PRSO
	GETP PRSO,P?ACTION >STACK
	CALL STACK,M-ENTER >STACK
	RTRUE

	.FUNCT V-BURN
	CALL IS-PERSON? >STACK
	CALL PRINT-ID,STR?73,STACK
	CALL IS-OBJ-PROP-ANIMAL? >STACK
	CALL PRINT-ID,STR?74,STACK
	CALL IS-SELF? >STACK
	CALL PRINT-ID,STR?75,STACK
	ZERO? PRSI \?L1
	PRINTR "Your blazing gaze is insufficient."
?L1:	CALL WITH-PRSI? >STACK
	RSTACK

	.FUNCT V-CHASTISE
	PRINTR "Use prepositions instead: LOOK AT the object, LOOK INSIDE it, LOOK UNDER it, etc."

	.FUNCT V-CLIMB-DOWN
	EQUAL? PRSO,ROOMS \?L1
	CALL DO-WALK,P?DOWN >STACK
	RSTACK
?L1:	CALL V-SQUEEZE >STACK
	RSTACK

	.FUNCT V-CLIMB-FOO
	EQUAL? PRSO,ROOMS \?L1
	CALL DO-WALK,P?UP >STACK
	RSTACK
?L1:	CALL V-SQUEEZE >STACK
	RSTACK

	.FUNCT V-CLIMB-ON
	FSET? PRSO,VEHBIT \?L1
	FSET? PRSO,SURFACEBIT \?L1
	CALL PERFORM,V?BOARD,PRSO
	RTRUE
?L1:	PRINT YOU-CANT
	PRINTI "climb onto "
	CALL A-PRSO >STACK
	RSTACK

	.FUNCT V-CLIMB-OVER
	CALL YOU-CANT-X-THAT,STR?76 >STACK
	RSTACK

	.FUNCT V-CLIMB-UP
	EQUAL? PRSO,ROOMS \?L1
	CALL DO-WALK,P?UP >STACK
	RSTACK
?L1:	CALL V-SQUEEZE >STACK
	RSTACK

	.FUNCT PRE-CLOSE
	CALL IMMOBILIZED? >STACK
	ZERO? STACK \TRUE
	RFALSE

	.FUNCT V-CLOSE
	FSET? PRSO,SURFACEBIT \?L1
	PRINTI "There's no way to close "
	CALL THE-PRSO >STACK
	RSTACK
?L1:	FSET? PRSO,CONTBIT /?L3
	FSET? PRSO,DOORBIT /?L3
	CALL PERFORM,V?OPEN,PRSO
	RTRUE
?L3:	FSET? PRSO,PERSON \?L4
	PRINTR "Huh?"
?L4:	FSET? PRSO,SURFACEBIT /?L5
	GETP PRSO,P?CAPACITY >STACK
	ZERO? STACK /?L5
	FSET? PRSO,OPENBIT \?L6
	FCLEAR PRSO,OPENBIT
	PRINTI "Closed."
	CALL LIT?,HERE >LIT
	ZERO? LIT \?L8
	PRINTI " "
	PRINT NOW-BLACK
?L8:	CRLF
	RTRUE
?L6:	CALL ALREADY-CLOSED >STACK
	RSTACK
?L5:	FSET? PRSO,DOORBIT \?L12
	FSET? PRSO,OPENBIT \?L13
	CALL OKAY-THE-PRSO-IS-NOW,STR?77
	FCLEAR PRSO,OPENBIT
	RTRUE
?L13:	CALL ALREADY-CLOSED >STACK
	RSTACK
?L12:	PRINTR "You cannot close that."

	.FUNCT OKAY-THE-PRSO-IS-NOW,STR
	PRINTI "Okay, "
	CALL THE-PRINT-PRSO
	PRINTI " is now "
	PRINT STR
	PRINT PERIOD
	RTRUE

	.FUNCT V-COMPARE
	PRINT WASTE-OF-TIME
	RTRUE

	.FUNCT V-COUNT
	PRINT WASTE-OF-TIME
	RTRUE

	.FUNCT V-CROSS
	CALL YOU-CANT-X-THAT,STR?78 >STACK
	RSTACK

	.FUNCT V-CURSE
	PRINTI "Moral turpitude is grounds for expulsion from the Circle!"
	CRLF
	CALL PRINT-ID,STR?79 >STACK
	RSTACK

	.FUNCT V-CUT
	FSET? PRSO,PERSON \?L1
	CALL PERFORM,V?KILL,PRSO,PRSI
	RTRUE
?L1:	FSET? PRSI,WEAPONBIT \?L7
	FSET? PRSO,SCROLLBIT /?L4
	EQUAL? PRSO,CARPET-LABEL \?L3
?L4:	REMOVE PRSO
	PRINTI "Skillfully wielding the "
	PRINTD PRSI
	PRINTI ", you slice "
	CALL THE-PRINT-PRSO
	PRINTI " into slivers, which vanish."
	CRLF
	CALL PRINT-ID,STR?80 >STACK
	RSTACK
?L3:	FSET? PRSI,WEAPONBIT /?L5
?L7:	PRINTI "I doubt that the ""cutting edge"" of "
	CALL THE-PRINT-PRSI
	PRINTR " is adequate."
?L5:	PRINTI "Strange concept, cutting "
	CALL A-PRSO >STACK
	RSTACK

	.FUNCT V-DIG
	IN? WINNER,MAGIC-CARPET \?L1
	GRTR? UD-COUNT,0 \?L1
	PRINT WHILE-FLYING
	RTRUE
?L1:	PRINT WASTE-OF-TIME
	RTRUE

	.FUNCT V-DISEMBARK,AV
	LOC WINNER >AV
	ZERO? PRSO /?L3
	EQUAL? PRSO,ROOMS \?L1
?L3:	ZERO? AV /?L4
	FSET? AV,VEHBIT \?L4
	CALL PERFORM,V?DISEMBARK,AV
	RTRUE
?L4:	FSET? HERE,RWATERBIT \?L6
	CALL DO-WALK,P?UP >STACK
	RSTACK
?L6:	PRINT YOU-ARENT
	PRINTR "in anything."
?L1:	ZERO? AV /?L8
	FSET? AV,VEHBIT \?L8
	EQUAL? AV,PRSO /?L9
	CALL HELD?,AV,PRSO >STACK
	ZERO? STACK \?L9
	CALL YOU-ARE-IN,AV
	RETURN 2
?L9:	LOC PRSO >STACK
	MOVE WINNER,STACK
	PRINT YOU-ARE-NOW
	PRINTR "on your feet."
?L8:	LOC PRSO >STACK
	ZERO? STACK /?L14
	CALL PERFORM,V?TAKE,PRSO
	RTRUE
?L14:	PRINTR "It's not in anything."

	.FUNCT V-DRINK,S
	CALL DANGEROUS-DRINK? >STACK
	CALL PRINT-ID,STR?81,STACK
	CALL YOU-CANT-X-THAT,STR?82 >STACK
	RSTACK

	.FUNCT V-DRINK-FROM,X
	EQUAL? PRSO,WATER \?L1
	CALL PERFORM,V?DRINK,PRSO
	RTRUE
?L1:	CALL HOW-DO-YOU
	CALL A-PRSO? >STACK
	RSTACK

	.FUNCT PRE-DROP
	LOC WINNER >STACK
	EQUAL? PRSO,STACK \FALSE
	CALL PERFORM,V?DISEMBARK,PRSO
	RTRUE

	.FUNCT V-DROP
	CALL IDROP >STACK
	ZERO? STACK /TRUE
	PRINTR "Dropped."

	.FUNCT V-EAT,OLIT
	EQUAL? PRSO,FISH,BREAD \?L1
	SET 'OLIT,LIT
	REMOVE PRSO
	PRINTI "Yum! That was pretty good, considering that it's a leftover from the luncheon."
	CALL PRINT-ID,STR?83
	CALL GOT-DARK?,OLIT
	CRLF
	RTRUE
?L1:	PRINTI "Did they teach you to eat that in survival school?"
	CRLF
	CALL DANGEROUS-FOOD? >STACK
	CALL PRINT-ID,STR?84,STACK >STACK
	RSTACK

	.FUNCT GOT-DARK?,OLIT
	CALL LIT?,HERE >LIT
	ZERO? OLIT /FALSE
	ZERO? LIT \FALSE
	PRINTI " "
	EQUAL? HERE,DARK-CAVE,GRUE-CAVE,LIGHT-POOL /?L5
	EQUAL? HERE,PILLAR-ROOM \?L3
?L5:	PRINTI "It's now darker."
	RTRUE
?L3:	PRINT NOW-BLACK
	RTRUE

	.FUNCT PRE-EXAMINE
	ZERO? LIT \FALSE
	PRINT TOO-DARK
	RTRUE

	.FUNCT V-EXAMINE
	FSET? PRSO,READBIT /?L3
	FSET? PRSO,SPELLBIT \?L1
?L3:	GETP PRSO,P?TEXT >STACK
	ZERO? STACK /?L1
	CALL PERFORM,V?READ,PRSO
	RTRUE
?L1:	FSET? PRSO,DOORBIT \?L4
	CALL V-LOOK-INSIDE >STACK
	RSTACK
?L4:	FSET? PRSO,CONTBIT \?L5
	FSET? PRSO,OPENBIT \?L6
	CALL V-LOOK-INSIDE >STACK
	RSTACK
?L6:	PRINTR "It's closed."
?L5:	FSET? PRSO,ONBIT \?L9
	PRINTI "Someone must have cast "
	CALL THE-PRINT,FROTZ-SPELL
	PRINTI " on "
	CALL THE-PRINT-PRSO
	PRINTR ", because it is glowing brightly."
?L9:	CALL PRSO-NOTHING-SPECIAL >STACK
	RSTACK

	.FUNCT PRSO-NOTHING-SPECIAL
	PRINTI "You see nothing special about "
	CALL THE-PRSO >STACK
	RSTACK

	.FUNCT V-EXIT
	EQUAL? PRSO,ROOMS /?L1
	FSET? PRSO,VEHBIT \?L1
	CALL PERFORM,V?DISEMBARK,PRSO
	RTRUE
?L1:	GETPT HERE,P?OUT >STACK
	ZERO? STACK /?L3
	CALL DO-WALK,P?OUT >STACK
	RSTACK
?L3:	CALL V-WALK-AROUND >STACK
	RSTACK

	.FUNCT V-FILL
	ZERO? PRSI \?L1
	CALL GLOBAL-IN?,WATER,HERE >STACK
	ZERO? STACK /?L3
	CALL PERFORM,V?FILL,PRSO,WATER
	RTRUE
?L3:	PRINT THERES-NOTHING-TO
	PRINTI "fill it with"
	PRINT PERIOD
	RTRUE
?L1:	PRINTR "Huh?"

	.FUNCT V-FIND,WHERE=0,L
	LOC PRSO >L
	EQUAL? PRSO,ME,HANDS,EYES \?L1
	PRINTI "Somewhere nearby, I'm sure"
	JUMP ?L16
?L1:	IN? PRSO,PLAYER \?L3
	PRINTI "You have it"
	JUMP ?L16
?L3:	IN? PRSO,HERE /?L5
	EQUAL? PRSO,PSEUDO-OBJECT \?L4
?L5:	FSET? PRSO,PERSON \?L6
	EQUAL? PRSO,ROC \?L8
	PRINTI "She"
	JUMP ?L11
?L8:	PRINTI "He"
	JUMP ?L11
?L6:	PRINTI "It"
?L11:	PRINTI "'s right in front of you"
	JUMP ?L16
?L4:	IN? PRSO,LOCAL-GLOBALS \?L12
	PRINTI "You're the magician"
	JUMP ?L16
?L12:	FSET? L,PERSON \?L13
	CALL VISIBLE?,L >STACK
	ZERO? STACK /?L13
	PRINTI "I think "
	CALL THE-PRINT,L
	PRINTI " has it"
	JUMP ?L16
?L13:	FSET? L,CONTBIT \?L14
	CALL VISIBLE?,L >STACK
	ZERO? STACK /?L14
	PRINTI "It's in "
	CALL THE-PRINT,L
	JUMP ?L16
?L14:	ZERO? WHERE /?L15
	PRINTI "Beats me"
	JUMP ?L16
?L15:	PRINT YOU-HAVE-TO
	PRINTI " do that yourself"
?L16:	PRINT PERIOD
	RTRUE

	.FUNCT V-FLY
	EQUAL? PRSO,0,ME \?L1
	IN? WINNER,MAGIC-CARPET \?L3
	GRTR? UD-COUNT,0 \?L3
	PRINTR "You are!"
?L3:	PRINTR "Perhaps some magical assistance?"
?L1:	EQUAL? PRSO,P-WALK-DIR \?L6
	CALL DO-WALK,PRSO
	RTRUE
?L6:	PRINT YOU-CANT
	PRINTI "make "
	CALL PRINTA-PRSO
	PRINTR " fly!"

	.FUNCT V-FOLLOW
	ZERO? PRSO /?L1
	IN? PRSO,HERE \?L1
	PRINTI "But "
	CALL THE-PRINT-PRSO
	PRINTR " is right here!"
?L1:	PRINT WASTE-OF-TIME
	RTRUE

	.FUNCT V-FORGET
	PRINTR "You can never forget, uh, whatever it was."

	.FUNCT PRE-GIVE
	EQUAL? PRSO,INTNUM \?L1
	CALL HELD?,ZORKMID >STACK
	ZERO? STACK \FALSE
?L1:	CALL HELD?,PRSO >STACK
	ZERO? STACK \?L3
	PRINT YOU-HAVE-TO
	PRINTR " get it first."
?L3:	FSET? PRSO,SPELLBIT \FALSE
	PRINTR "Spells are intangible."

	.FUNCT V-GIVE
	FSET? PRSI,PERSON /?L1
	PRINT YOU-CANT
	PRINTI "give "
	CALL PRINTA-PRSO
	PRINTI " to "
	CALL PRINTA-PRSI
	PRINTR "!"
?L1:	CALL UNINTERESTED,PRSI >STACK
	RSTACK

	.FUNCT V-HELLO,OWINNER
	ZERO? PRSO /?L1
	FSET? PRSO,PERSON \?L3
	SET 'OWINNER,WINNER
	SET 'WINNER,PRSO
	CALL PERFORM,V?HELLO
	SET 'WINNER,OWINNER
	RETURN WINNER
?L3:	PRINTI "Mages never say ""Hello"" to "
	CALL A-PRSO >STACK
	RSTACK
?L1:	PRINTR "Cheery, aren't you?"

	.FUNCT V-HELP
	PRINTR "If you're really stuck, you can order maps and InvisiClues Hint Booklets using the order form that came in your package."

	.FUNCT V-HIDE
	ZERO? PRSO \?L1
	PRINTI "There's no place to hide here."
	CRLF
	RETURN 2
?L1:	ZERO? PRSI /?L8
	FSET? PRSI,PERSON \?L5
	CALL UNINTERESTED,PRSI >STACK
	RSTACK
?L5:	ZERO? PRSI \FALSE
?L8:	CALL V-SQUEEZE >STACK
	RSTACK

	.FUNCT V-HIDE-FROM
	PRINT YOU-HAVE-TO
	PRINTR " decide where."

	.FUNCT V-INFLATE
	CALL HOW-DO-YOU
	CALL A-PRSO? >STACK
	RSTACK

	.FUNCT V-KICK,?TMP
	CALL IS-PERSON? >?TMP
	ZERO? ?TMP /?L2
	PUSH ?TMP
	JUMP ?L1
?L2:	CALL IS-OBJ-PROP-ANIMAL? >STACK
?L1:	CALL PRINT-ID,STR?85,STACK
	CALL HACK-HACK,STR?86 >STACK
	RSTACK

	.FUNCT V-KILL
	CALL IKILL,STR?87 >STACK
	RSTACK

	.FUNCT IKILL,STR
	CALL IS-PERSON? >STACK
	CALL PRINT-ID,STR?88,STACK
	CALL IS-OBJ-PROP-ANIMAL? >STACK
	CALL PRINT-ID,STR?89,STACK
	CALL IS-SELF? >STACK
	CALL PRINT-ID,STR?90,STACK
	ZERO? PRSO \?L1
	PRINT THERES-NOTHING-TO
	PRINT STR
	PRINTI " here."
	CRLF
	JUMP ?L3
?L1:	ZERO? PRSI \?L3
	IN? KNIFE,WINNER \?L3
	SET 'PRSI,KNIFE
	PRINTI "(with "
	CALL THE-PRINT-PRSI
	PRINTI ")"
	CRLF
	CALL PERFORM,V?KILL,PRSO,PRSI
	RTRUE
?L3:	FSET? PRSO,DOORBIT \?L5
	PRINTR "Pounding on a door is of little use."
?L5:	FSET? PRSO,PERSON /?L7
	PRINTI "How strange. Fighting "
	CALL A-PRSO? >STACK
	RSTACK
?L7:	EQUAL? PRSI,0,HANDS /?L9
	FSET? PRSI,WEAPONBIT /?L8
?L9:	PRINTI "Trying to "
	PRINT STR
	PRINTI " "
	CALL THE-PRINT-PRSO
	PRINTI " with "
	EQUAL? PRSI,0,HANDS /?L10
	CALL PRINTA-PRSI
	JUMP ?L12
?L10:	PRINTI "your bare hands"
?L12:	PRINTR " is suicidal."
?L8:	IN? PRSI,WINNER /?L13
	CALL NOT-HOLDING,PRSI >STACK
	RSTACK
?L13:	CALL NOT-TRAINED >STACK
	RSTACK

	.FUNCT NOT-TRAINED
	PRINTR "You miss. (Mages aren't given a lot of training in this sort of thing.)"

	.FUNCT V-KNOCK
	FSET? PRSO,DOORBIT \?L1
	PRINTR "Nobody's home."
?L1:	PRINTI "Why knock on "
	CALL A-PRSO? >STACK
	RSTACK

	.FUNCT V-KISS
	FSET? PRSO,PERSON \?L1
	CALL PRINT-ID,STR?91
	CALL UNINTERESTED,PRSO >STACK
	RSTACK
?L1:	CALL V-SQUEEZE >STACK
	RSTACK

	.FUNCT V-LAMP-OFF
	FSET? PRSO,ONBIT \?L1
	FCLEAR PRSO,ONBIT
	EQUAL? PRSO,ME \?L3
	FCLEAR PLAYER,ONBIT
?L3:	PRINTI "The magical glow fades"
	CALL LIT?,HERE >LIT
	ZERO? LIT \?L6
	PRINTI ", leaving you in the dark"
?L6:	PRINT PERIOD
	RTRUE
?L1:	CALL HOW-DO-YOU
	CALL A-PRSO? >STACK
	RSTACK

	.FUNCT V-LAMP-ON
	CALL HOW-DO-YOU
	CALL A-PRSO? >STACK
	RSTACK

	.FUNCT V-LAND
	IN? WINNER,MAGIC-CARPET \?L1
	CALL DO-WALK,P?DOWN >STACK
	RSTACK
?L1:	PRINT LOOK-AROUND-YOU
	RTRUE

	.FUNCT V-LEAN-ON
	PRINTR "Tired?"

	.FUNCT V-LEAP
	IN? WINNER,MAGIC-CARPET \?L1
	GRTR? UD-COUNT,0 \?L1
	PRINT WHILE-FLYING
	RTRUE
?L1:	EQUAL? PRSO,0,ROOMS \?L3
	EQUAL? HERE,CLIFF-MIDDLE,BOULDER-1,BOULDER-2 \?L3
	CALL PRINT-ID,STR?92
	CALL JIGS-UP,STR?93 >STACK
	RSTACK
?L3:	ZERO? PRSO /?L4
	IN? PRSO,HERE \?L4
	CALL V-SKIP >STACK
	RSTACK
?L4:	PRINTR "That would be a good trick."

	.FUNCT V-LEAVE
	CALL DO-WALK,P?OUT >STACK
	RSTACK

	.FUNCT V-LISTEN
	EQUAL? PRSO,0,GLOBAL-ROCKS \?L1
	CALL QUEUED?,I-AVALANCHE >STACK
	ZERO? STACK /?L1
	CALL TIME-FROZEN? >STACK
	ZERO? STACK \?L1
	EQUAL? HERE,MOUNTAIN-TOP,CAVE-ENTRANCE,CLIFF-TOP /?L3
	EQUAL? HERE,CLIFF-MIDDLE,CLIFF-BOTTOM \?L1
?L3:	CALL HEAR-AVALANCHE
	JUMP ?L7
?L1:	PRINTI "At the moment, "
	ZERO? PRSO \?L5
	PRINTI "you hear nothing unsettling"
	JUMP ?L7
?L5:	CALL THE-PRINT-PRSO
	PRINTI " makes no sound"
?L7:	PRINT PERIOD
	RTRUE

	.FUNCT V-LOCK
	FSET? PRSO,DOORBIT \?L1
	EQUAL? PRSI,KEY \?L1
	PRINT DOESNT-FIT
	RTRUE
?L1:	CALL TELL-YUKS >STACK
	RSTACK

	.FUNCT V-FIRST-LOOK
	CALL DESCRIBE-ROOM >STACK
	ZERO? STACK /FALSE
	ZERO? VERBOSITY /FALSE
	CALL DESCRIBE-OBJECTS >STACK
	RSTACK

	.FUNCT V-LOOK
	CALL DESCRIBE-ROOM,1 >STACK
	ZERO? STACK /FALSE
	CALL DESCRIBE-OBJECTS,1 >STACK
	RSTACK

	.FUNCT V-LOOK-BEHIND
	PRINT THERE-IS-NOTHING
	PRINTI "behind "
	CALL THE-PRSO >STACK
	RSTACK

	.FUNCT V-LOOK-DOWN
	ZERO? LIT \?L1
	PRINT TOO-DARK
	RTRUE
?L1:	EQUAL? PRSO,0,ROOMS,GLOBAL-HOLE \FALSE
	CALL GLOBAL-IN?,GLOBAL-HOLE,HERE >STACK
	ZERO? STACK /?L4
	CALL PERFORM,V?LOOK-INSIDE,GLOBAL-HOLE
	RTRUE
?L4:	CALL PERFORM,V?EXAMINE,GROUND
	RTRUE

	.FUNCT WHAT-CONTENTS
	CALL PRINT-CONTENTS,PRSO >STACK
	ZERO? STACK \?L3
	PRINTI "nothing"
	IN? PLAYER,PRSO \?L3
	PRINTI " (other than you)"
?L3:	PRINT PERIOD
	RTRUE

	.FUNCT V-LOOK-INSIDE
	FSET? PRSO,PERSON \?L1
	CALL PRSO-NOTHING-SPECIAL >STACK
	RSTACK
?L1:	FSET? PRSO,SURFACEBIT \?L3
	PRINTI "On "
	CALL THE-PRINT-PRSO
	PRINTI " is "
	CALL WHAT-CONTENTS >STACK
	RSTACK
?L3:	FSET? PRSO,DOORBIT \?L4
	CALL THIS-IS-IT,PRSO
	PRINTI "All you can tell is that "
	CALL TELL-OPEN-CLOSED >STACK
	RSTACK
?L4:	FSET? PRSO,SCROLLBIT \?L5
	CALL PERFORM,V?READ,PRSO
	RTRUE
?L5:	FSET? PRSO,CONTBIT \?L6
	LOC WINNER >STACK
	EQUAL? PRSO,STACK \?L7
	MOVE PLAYER,ROOMS
	PRINTI "Aside from you, there's "
	CALL WHAT-CONTENTS
	MOVE PLAYER,PRSO
	RTRUE
?L7:	CALL SEE-INSIDE?,PRSO >STACK
	ZERO? STACK /?L9
	CALL CTHE-PRINT-PRSO
	PRINTI " contains "
	CALL WHAT-CONTENTS >STACK
	RSTACK
?L9:	FSET? PRSO,OPENBIT /?L10
	FIRST? PRSO >STACK \?L10
	CALL PERFORM,V?OPEN,PRSO
	RTRUE
?L10:	CALL THIS-IS-IT,PRSO
	PRINTI "It seems "
	CALL TELL-OPEN-CLOSED >STACK
	RSTACK
?L6:	CALL YOU-CANT-X-PRSO,STR?94 >STACK
	RSTACK

	.FUNCT V-LOOK-UNDER
	CALL HELD?,PRSO >STACK
	ZERO? STACK /?L1
	PRINTR "You're already holding it!"
?L1:	PRINT THERE-IS-NOTHING
	PRINTR "there."

	.FUNCT V-LOWER
	CALL V-RAISE >STACK
	RSTACK

	.FUNCT V-LOWER-INTO
	CALL V-RAISE >STACK
	RSTACK

	.FUNCT V-MELT
	PRINTI "I'm not sure that "
	CALL THE-PRINT-PRSO
	PRINTI " can be melted."
	CRLF
	CALL IS-PERSON? >STACK
	CALL PRINT-ID,STR?95,STACK
	CALL IS-OBJ-PROP-ANIMAL? >STACK
	CALL PRINT-ID,STR?96,STACK
	CALL IS-SELF? >STACK
	CALL PRINT-ID,STR?97,STACK >STACK
	RSTACK

	.FUNCT V-MOVE
	CALL HELD?,PRSO >STACK
	ZERO? STACK /?L1
	PRINTR "Why juggle objects?"
?L1:	FSET? PRSO,TAKEBIT \?L3
	FSET? PRSO,PERSON /?L3
	CALL V-TURN-OVER >STACK
	RSTACK
?L3:	CALL YOU-CANT-X-PRSO,STR?98 >STACK
	RSTACK

	.FUNCT HOSTILE-VERB?
	EQUAL? PRSA,V?ATTACK,V?BITE,V?KICK /TRUE
	EQUAL? PRSA,V?KILL,V?MUNG,V?RUB /TRUE
	EQUAL? PRSA,V?PUSH,V?MOVE,V?THROW /TRUE
	RFALSE

	.FUNCT V-MUNG
	CALL IS-PERSON? >STACK
	CALL PRINT-ID,STR?99,STACK
	CALL IS-OBJ-PROP-ANIMAL? >STACK
	CALL PRINT-ID,STR?100,STACK
	CALL IS-SELF? >STACK
	CALL PRINT-ID,STR?101,STACK
	CALL HACK-HACK,STR?102 >STACK
	RSTACK

	.FUNCT PRE-OPEN
	CALL IMMOBILIZED? >STACK
	ZERO? STACK \TRUE
	FSET? PRSO,PERSON \FALSE
	PRINTR "What a grisly idea."

	.FUNCT V-OPEN,F,STR
	FSET? PRSO,CONTBIT /?L4
	FSET? PRSO,DOORBIT \?L3
?L4:	FSET? PRSO,SCROLLBIT /?L3
	FSET? PRSO,SURFACEBIT \?L1
?L3:	PRINTI "You must tell me how to do that to "
	CALL A-PRSO >STACK
	RSTACK
?L1:	GETP PRSO,P?CAPACITY >STACK
	ZERO? STACK /?L5
	FSET? PRSO,OPENBIT \?L6
	CALL ALREADY-OPEN >STACK
	RSTACK
?L6:	FSET PRSO,OPENBIT
	FSET PRSO,TOUCHBIT
	FIRST? PRSO >STACK \?L11
	FSET? PRSO,TRANSBIT \?L9
?L11:	PRINTR "Opened."
?L9:	PRINTI "Opening "
	CALL THE-PRINT-PRSO
	PRINTI " reveals "
	CALL WHAT-CONTENTS >STACK
	RSTACK
?L5:	FSET? PRSO,OPENBIT \?L14
	CALL ALREADY-OPEN >STACK
	RSTACK
?L14:	FSET? PRSO,LOCKED \?L16
	PRINTR "It's locked."
?L16:	FSET PRSO,OPENBIT
	CALL OKAY-THE-PRSO-IS-NOW,STR?103 >STACK
	RSTACK

	.FUNCT V-PAY
	ZERO? PRSI \?L1
	PRINTR "Pay with what?"
?L1:	CALL WITH-PRSI? >STACK
	RSTACK

	.FUNCT V-PICK
	CALL YOU-CANT-X-THAT,STR?104 >STACK
	RSTACK

	.FUNCT V-PLAY
	PRINTR "How peculiar!"

	.FUNCT V-PLUG
	CALL V-TURN >STACK
	RSTACK

	.FUNCT V-POINT
	PRINTR "It's impolite to point."

	.FUNCT V-POUR
	FSET? PRSO,CONTBIT \?L1
	CALL HELD?,PRSO >STACK
	ZERO? STACK /?L1
	CALL EMPTY-ALL,PRSO,PRSI >STACK
	RSTACK
?L1:	CALL YOU-CANT-X-THAT,STR?105 >STACK
	RSTACK

	.FUNCT EMPTY-ALL,FROM,TO,F,N,R,F?1,N?1
	FIRST? FROM >STACK /?L1
	CALL CTHE-PRINT,FROM
	PRINTR " is empty."
?L1:	FIRST? FROM >F?1 \TRUE
?L4:	NEXT? F?1 >N?1 /?L7
?L7:	CALL DPRINT,F?1
	PRINTI ": "
	ZERO? TO /?L8
	CALL PERFORM,V?PUT,F?1,TO >R
	JUMP ?L10
?L8:	CALL PERFORM,V?DROP,F?1 >R
?L10:	EQUAL? R,M-FATAL /TRUE
	SET 'F?1,N?1
	ZERO? F?1 \?L4
	RTRUE

	.FUNCT V-PUMP
	PRINTR "It's not clear how."

	.FUNCT V-PUSH
	CALL HACK-HACK,STR?106 >STACK
	RSTACK

	.FUNCT V-PUSH-TO
	CALL YOU-CANT-X-THAT,STR?107 >STACK
	RSTACK

	.FUNCT PRE-PUT,L
	LOC PRSO >L
	IN? PRSO,GLOBAL-OBJECTS /?L3
	FSET? PRSO,TAKEBIT /?L1
?L3:	PRINTR "Nice try."
?L1:	EQUAL? PRSA,V?PUT \?L4
	FSET? PRSO,WEAPONBIT \?L4
	FSET? PRSI,PERSON \?L4
	CALL PERFORM,V?ATTACK,PRSI,PRSO
	RTRUE
?L4:	IN? PRSO,PRSI \?L5
	CALL TAKE-OUT-FIRST,PRSO,PRSI >STACK
	RSTACK
?L5:	IN? PRSI,PRSO \?L6
	CALL TAKE-OUT-FIRST,PRSI,PRSO >STACK
	RSTACK
?L6:	FSET? L,CONTBIT \FALSE
	FSET? L,OPENBIT /FALSE
	CALL TAKE-OUT-FIRST,PRSO,L >STACK
	RSTACK

	.FUNCT TAKE-OUT-FIRST,OBJ,CONT
	PRINTI "You should take "
	CALL THE-PRINT,OBJ
	PRINTI " out of "
	CALL THE-PRINT,CONT
	PRINTR " first."

	.FUNCT V-PUT,W,?TMP
	FSET? PRSI,OPENBIT /?L1
	FSET? PRSI,DOORBIT /?L11
	FSET? PRSI,CONTBIT /?L1
	FSET? PRSI,SURFACEBIT /?L1
	FSET? PRSI,VEHBIT /?L1
	CALL YOU-CANT-X-THAT,STR?76
	RTRUE
?L1:	FSET? PRSI,DOORBIT \?L3
?L11:	EQUAL? PRSO,KEY \?L3
	CALL PERFORM,V?UNLOCK,PRSI,PRSO
	RTRUE
?L3:	FSET? PRSI,OPENBIT /?L4
	FSET? PRSI,SURFACEBIT /?L4
	PRINTI "Inspection reveals that "
	CALL THE-PRINT-PRSI
	PRINTI " isn't open."
	CRLF
	CALL THIS-IS-IT,PRSI >STACK
	RSTACK
?L4:	EQUAL? PRSI,PRSO \?L5
	CALL HOW-DO-YOU
	CALL A-PRSO? >STACK
	RSTACK
?L5:	IN? PRSO,PRSI \?L6
	PRINTI "I think "
	CALL THE-PRINT-PRSO
	PRINTI " is already in "
	CALL THE-PRSI >STACK
	RSTACK
?L6:	LOC PRSI >W
	FSET? W,PERSON \?L7
	EQUAL? W,WINNER /?L7
	PRINTI "Don't you think you should ask "
	CALL THE-PRINT,W
	PRINTR " first?"
?L7:	CALL WEIGHT,PRSI >?TMP
	CALL WEIGHT,PRSO >STACK
	ADD ?TMP,STACK >?TMP
	GETP PRSI,P?SIZE >STACK
	SUB ?TMP,STACK >?TMP
	GETP PRSI,P?CAPACITY >STACK
	GRTR? ?TMP,STACK \?L8
	PRINT NO-ROOM
	CRLF
	RTRUE
?L8:	CALL HELD?,PRSO >STACK
	ZERO? STACK \?L9
	CALL ITAKE >STACK
	EQUAL? STACK,M-FATAL,0 /TRUE
?L9:	MOVE PRSO,PRSI
	FSET PRSO,TOUCHBIT
	PRINTR "Done."

	.FUNCT V-PUT-BEHIND
	PRINTR "That hiding place is too obvious."

	.FUNCT V-PUT-ON
	EQUAL? PRSI,ME \?L1
	CALL PERFORM,V?WEAR,PRSO
	RTRUE
?L1:	EQUAL? PRSI,GROUND \?L3
	CALL PERFORM,V?DROP,PRSO
	RTRUE
?L3:	FSET? PRSI,SURFACEBIT \?L4
	CALL V-PUT >STACK
	RSTACK
?L4:	PRINTI "There's no good surface on "
	CALL THE-PRSI >STACK
	RSTACK

	.FUNCT V-PUT-UNDER
	CALL YOU-CANT-X-THAT,STR?108 >STACK
	RSTACK

	.FUNCT V-RAISE
	CALL HACK-HACK,STR?109 >STACK
	RSTACK

	.FUNCT V-REACH-IN,OBJ
	FSET? PRSO,CONTBIT \?L3
	FSET? PRSO,PERSON \?L1
?L3:	CALL HOW-DO-YOU
	CALL A-PRSO? >STACK
	RSTACK
?L1:	FSET? PRSO,OPENBIT /?L4
	PRINTR "It's not open."
?L4:	FIRST? PRSO >OBJ \?L6
	FSET? OBJ,INVISIBLE /?L6
	FSET? OBJ,TAKEBIT /?L5
?L6:	CALL ITS-EMPTY >STACK
	RSTACK
?L5:	PRINTI "You reach into "
	CALL THE-PRINT-PRSO
	PRINTR " and feel something."

	.FUNCT PRE-READ
	EQUAL? PRSO,SPELL-BOOK /FALSE
	FSET? PRSO,SPELLBIT \?L3
	IN? PRSO,SPELL-BOOK /FALSE
?L3:	ZERO? LIT \?L4
	PRINTR "You can't read in the dark."
?L4:	ZERO? PRSI /FALSE
	FSET? PRSI,TRANSBIT /FALSE
	CALL HOW-DO-YOU
	CALL A-PRSI? >STACK
	RSTACK

	.FUNCT HOW-DO-YOU
	PRINTI "How do you do that with "
	RTRUE

	.FUNCT V-READ
	FSET? PRSO,READBIT /?L3
	FSET? PRSO,SPELLBIT \?L1
?L3:	GETP PRSO,P?TEXT >STACK
	PRINT STACK
	CRLF
	RTRUE
?L1:	CALL HOW-DO-YOU
	CALL A-PRSO? >STACK
	RSTACK

	.FUNCT V-REPLY
	EQUAL? HERE,RETREAT \?L1
	EQUAL? PRSO,BELBOZ /?L1
	ZERO? PRSI \?L1
	CALL PERFORM,V?REPLY,BELBOZ,PRSO
	RTRUE
?L1:	PRINTI "Your reply is ignored."
	CRLF
	CALL END-QUOTE >STACK
	RSTACK

	.FUNCT PRE-SRUB
	CALL PERFORM,V?RUB,PRSI,PRSO
	RTRUE

	.FUNCT V-SRUB
	RTRUE

	.FUNCT V-RUB
	CALL IS-PERSON? >STACK
	CALL PRINT-ID,STR?110,STACK
	CALL HACK-HACK,STR?111 >STACK
	RSTACK

	.FUNCT V-SAY,V
	CALL FIND-IN,HERE,PERSON >V
	ZERO? V /?L1
	PRINTI "You must address "
	CALL THE-PRINT,V
	PRINTI " directly."
	CRLF
	CALL END-QUOTE >STACK
	RSTACK
?L1:	GET P-LEXV,P-CONT >STACK
	EQUAL? STACK,W?HELLO \?L3
	SET 'QUOTE-FLAG,0
	RTRUE
?L3:	CALL PERFORM,V?TELL,ME
	CALL END-QUOTE >STACK
	RSTACK

	.FUNCT V-SEARCH
	FSET? PRSO,PERSON \?L1
	EQUAL? ESPNIS?,PRSO /?L1
	CALL TIME-FROZEN? >STACK
	ZERO? STACK \?L1
	CALL CTHE-PRINT-PRSO
	PRINTR " refuses to let you search him."
?L1:	PRINT THERE-IS-NOTHING
	PRINTI "there"
	PRINT PERIOD
	RTRUE

	.FUNCT V-SEND
	FSET? PRSO,PERSON \?L1
	PRINTI "Why would you send for "
	CALL A-PRSO? >STACK
	RSTACK
?L1:	CALL TELL-YUKS >STACK
	RSTACK

	.FUNCT PRE-SGIVE
	CALL PERFORM,V?GIVE,PRSI,PRSO
	RTRUE

	.FUNCT V-SGIVE
	RTRUE

	.FUNCT V-SHAKE,X
	FSET? PRSO,PERSON \?L1
	PRINTR "Be real."
?L1:	FSET? PRSO,TAKEBIT /?L3
	PRINT YOU-CANT
	PRINTR "take it; thus, you can't shake it!"
?L3:	PRINTR "There's no point in shaking that."

	.FUNCT V-SHARPEN
	PRINTR "You'll never sharpen anything with that!"

	.FUNCT V-SHOOT
	PRINTI "Don't ever bother applying for a job as an armaments expert."
	CRLF
	CALL IS-PERSON? >STACK
	CALL PRINT-ID,STR?112,STACK
	CALL IS-OBJ-PROP-ANIMAL? >STACK
	CALL PRINT-ID,STR?113,STACK
	CALL IS-SELF? >STACK
	CALL PRINT-ID,STR?114,STACK >STACK
	RSTACK

	.FUNCT V-SHOW
	CALL UNINTERESTED,PRSI >STACK
	RSTACK

	.FUNCT V-SIT
	PRINT WASTE-OF-TIME
	RTRUE

	.FUNCT V-SKIP
	PRINTR "Wasn't that fun?"

	.FUNCT IMPOSSIBLE-TO-SLEEP
	PRINTR "It's impossible to sleep at a time like this!"

	.FUNCT V-SLEEP,FORCE?=0
	LOC WINNER >STACK
	EQUAL? STACK,ROC /?L3
	EQUAL? HERE,ROC-NEST \?L1
?L3:	ZERO? FORCE? /?L4
	PRINTI "You fall asleep and then awaken as you"
	LOC WINNER >STACK
	FSET? STACK,VEHBIT \?L6
	PRINTI " and "
	LOC WINNER >STACK
	CALL CTHE-PRINT,STACK
?L6:	PRINTI " are eaten by a roc chick."
	CALL PRINT-ID,STR?115
	CALL JIGS-UP >STACK
	RSTACK
?L4:	CALL IMPOSSIBLE-TO-SLEEP >STACK
	RSTACK
?L1:	EQUAL? HERE,CASTLE \?L10
	EQUAL? PRSA,V?ESPNIS \?L11
	SET 'SCORE,-99
	PRINTI "You fall asleep and miss the end of the world."
	CALL PRINT-ID,STR?116
	CALL FINISH >STACK
	RSTACK
?L11:	CALL QUEUE,I-TIRED,150
	SET 'AWAKE,-1
	CALL IMPOSSIBLE-TO-SLEEP >STACK
	RSTACK
?L10:	ZERO? FORCE? \?L14
	EQUAL? AWAKE,-1 \?L14
	PRINTR "You settle down to sleep, but you really aren't tired, so you thrash around for a while and then give up."
?L14:	EQUAL? HERE,OCEAN-ROOM,OCEAN-FLOOR,LOST-IN-OCEAN /?L16
	EQUAL? HERE,IN-CHANNEL,IN-PIPE,IN-PIPE-2 /?L16
	EQUAL? HERE,RUINS-CHANNEL /?L16
	EQUAL? HERE,OUBLIETTE \?L15
	GRTR? WATER-FLAG,0 \?L15
?L16:	ZERO? FORCE? /?L17
	CALL PRINT-ID,STR?117
	CALL JIGS-UP,STR?118 >STACK
	RSTACK
?L17:	CALL IMPOSSIBLE-TO-SLEEP >STACK
	RSTACK
?L15:	EQUAL? HERE,OGRE-CAVE,OGRE-BEDROOM \?L20
	ZERO? FORCE? /?L21
	CALL PRINT-ID,STR?119
	CALL JIGS-UP,STR?120 >STACK
	RSTACK
?L21:	PRINTR "I'd think twice before going to sleep in an ogre's cave."
?L20:	ZERO? FALLING? /?L24
	ZERO? FORCE? /?L25
	CALL PRINT-ID,STR?121
	CALL JIGS-UP,STR?122 >STACK
	RSTACK
?L25:	CALL IMPOSSIBLE-TO-SLEEP >STACK
	RSTACK
?L24:	ZERO? FORCE? \?L28
	IN? PLAYER,CABINET /?L29
	IN? PLAYER,PAST-CABINET \?L28
?L29:	PRINTR "It's too cramped in here to sleep comfortably."
?L28:	EQUAL? HERE,GLACIER-ROOM \?L31
	SET 'FREEZE-COUNT,9
?L31:	LESS? REAL-SPELL-MAX,8 \?L34
	INC 'REAL-SPELL-MAX
?L34:	SET 'SPELL-MAX,REAL-SPELL-MAX
	SET 'SPELL-ROOM,SPELL-MAX
	ADD MOVES,50 >MOVES
	SET 'LAST-SLEPT,MOVES
	SET 'LOAD-ALLOWED,LOAD-MAX
	SET 'FUMBLE-NUMBER,8
	CALL QUEUE,I-TIRED,150
	SET 'AWAKE,-1
	CALL FORGET-ALL
	PRINTI "Ah, sleep! It's been a long day, and rest will do you good. "
	LOC PLAYER >STACK
	EQUAL? STACK,MAGIC-CARPET \?L37
	GRTR? UD-COUNT,0 \?L37
	PRINTI "It's not the best of beds, but at least it's air cushioned. You"
	JUMP ?L39
?L37:	PRINTI "You stretch out "
	IN? PLAYER,IDOL \?L40
	PRINTI "in the arms of "
	CALL THE-PRINT,IDOL
	JUMP ?L45
?L40:	LOC PLAYER >STACK
	EQUAL? STACK,ROCK,OTHER-ROCK \?L42
	PRINTI "on the back of "
	LOC PLAYER >STACK
	CALL THE-PRINT,STACK
	JUMP ?L45
?L42:	IN? PLAYER,ZIPPER \?L43
	PRINTI "in the nothingness"
	JUMP ?L45
?L43:	PRINTI "on the floor"
	IN? PLAYER,HERE /?L45
	PRINTI " next to "
	LOC PLAYER >STACK
	CALL THE-PRINT,STACK
	MOVE PLAYER,HERE
?L45:	PRINTI " and"
?L39:	PRINTI " drift off, renewing your powers and refreshing your mind. Time passes as you snore blissfully."
	CRLF
	CRLF
	RANDOM 100 >STACK
	LESS? 50,STACK /?L48
	PRINTI "You sleep uneventfully and awake refreshed."
	CALL PRINT-ID,STR?123
	JUMP ?L50
?L48:	PRINTI "You dream of "
	CALL PICK-ONE,DREAMS >STACK
	PRINT STACK
	PRINTI " You awaken."
?L50:	IN? PLAYER,ROCK \?L51
	PRINTI " The rock says, ""You've been quiet a long time. Are you estivating?"""
	JUMP ?L54
?L51:	EQUAL? HERE,BAZAAR \?L54
	RANDOM 100 >STACK
	LESS? 75,STACK /?L54
	CALL ROB,PLAYER,0 >STACK
	ZERO? STACK /?L54
	PRINTI " During your nap, some unscrupulous person absconded with your possessions!"
	CALL PRINT-ID,STR?124
?L54:	CRLF
	CALL WEAR-OFF-SPELLS
	RTRUE

	.FUNCT V-SMELL
	ZERO? PRSO /?L1
	PRINTI "It smells just like "
	CALL A-PRSO >STACK
	RSTACK
?L1:	LOC WINNER >STACK
	FSET? STACK,VEHBIT \?L3
	LOC WINNER >STACK
	CALL PERFORM,PRSA,STACK
	RTRUE
?L3:	PRINTR "There's no noticeable smell here."

	.FUNCT V-SPAY
	CALL PERFORM,V?PAY,PRSI,PRSO
	RTRUE

	.FUNCT V-SPIN
	CALL YOU-CANT-X-THAT,STR?125 >STACK
	RSTACK

	.FUNCT V-SQUEEZE
	PRINTR "How singularly useless."

	.FUNCT PRE-SSHOW
	CALL PERFORM,V?SHOW,PRSI,PRSO
	RTRUE

	.FUNCT V-SSHOW
	RTRUE

	.FUNCT V-STAND
	LOC WINNER >STACK
	FSET? STACK,VEHBIT \?L1
	LOC WINNER >STACK
	CALL PERFORM,V?DISEMBARK,STACK
	RTRUE
?L1:	EQUAL? PRSO,0,ROOMS /?L3
	CALL HACK-HACK,STR?126 >STACK
	RSTACK
?L3:	IN? WINNER,MAGIC-CARPET \?L4
	GRTR? UD-COUNT,0 \?L4
	PRINT WHILE-FLYING
	RTRUE
?L4:	PRINT YOU-ARE
	PRINTR " standing."

	.FUNCT V-STAND-ON
	PRINT WASTE-OF-TIME
	RTRUE

	.FUNCT V-SWING
	ZERO? PRSI \?L1
	PRINTR "Whoosh!"
?L1:	CALL PERFORM,V?ATTACK,PRSI,PRSO
	RTRUE

	.FUNCT V-SWIM
	ZERO? PRSO /?L1
	CALL PERFORM,V?THROUGH,PRSO
	RTRUE
?L1:	CALL GLOBAL-IN?,WATER,HERE >STACK
	ZERO? STACK /?L3
	CALL PERFORM,V?THROUGH,WATER
	RTRUE
?L3:	PRINT THERES-NOTHING-TO
	PRINTI "swim in"
	PRINT PERIOD
	RTRUE

	.FUNCT IMMOBILIZED?
	CALL TIME-FROZEN? >STACK
	ZERO? STACK /FALSE
	CALL HELD?,PRSO >STACK
	ZERO? STACK \FALSE
	CALL IMMOBILE >STACK
	RSTACK

	.FUNCT IMMOBILE
	PRINTR "It's immobilized."

	.FUNCT TIME-FROZEN?
	ZERO? TIME-STOPPED? /FALSE
	EQUAL? TIME-STOPPED?,HERE /?L3
	EQUAL? TIME-STOPPED?,OGRE-CAVE,OGRE-BEDROOM \?L4
	EQUAL? HERE,OGRE-BEDROOM,OGRE-CAVE /?L3
?L4:	EQUAL? TIME-STOPPED?,CLIFF-TOP,CLIFF-MIDDLE \FALSE
	EQUAL? HERE,CLIFF-TOP,CLIFF-MIDDLE,CLIFF-BOTTOM \FALSE
?L3:	RETURN HERE

	.FUNCT PRE-TAKE
	IN? PRSO,WINNER \?L1
	PRINTR "You already have it."
?L1:	FSET? PRSO,SPELLBIT \?L3
	LOC PRSO >STACK
	FSET? STACK,SCROLLBIT \?L3
	LOC PRSO >STACK
	CALL ACCESSIBLE?,STACK >STACK
	ZERO? STACK /?L3
	LOC PRSO >STACK
	CALL PERFORM,V?TAKE,STACK
	RTRUE
?L3:	LOC WINNER >STACK
	FSET? STACK,VEHBIT /?L4
	LOC PRSO >STACK
	FSET? STACK,CONTBIT \?L4
	LOC PRSO >STACK
	FSET? STACK,OPENBIT /?L4
	CALL CANT-REACH-THAT
	RTRUE
?L4:	CALL IMMOBILIZED? >STACK
	ZERO? STACK \TRUE
	ZERO? PRSI /?L6
	EQUAL? PRSO,ME \?L7
	CALL PERFORM,V?DROP,PRSI
	RTRUE
?L7:	LOC PRSO >STACK
	EQUAL? PRSI,STACK /?L9
	PRINTI "But "
	CALL THE-PRINT-PRSO
	PRINTI " isn't in "
	CALL THE-PRSI >STACK
	RSTACK
?L9:	SET 'PRSI,0
	RFALSE
?L6:	LOC WINNER >STACK
	EQUAL? PRSO,STACK \FALSE
	PRINTI "You are "
	FSET? PRSO,PERSON \?L12
	PRINTI "being carried by"
	JUMP ?L15
?L12:	FSET? PRSO,SURFACEBIT \?L14
	PRINTI "on"
	JUMP ?L15
?L14:	PRINTI "in"
?L15:	PRINTR " it!"

	.FUNCT NOT-IN-VEHICLE?,V
	LOC WINNER >V
	EQUAL? PRSO,0,V,ROOMS /FALSE
	CALL HELD?,PRSO >STACK
	ZERO? STACK \FALSE
	CALL HELD?,PRSO,V >STACK
	ZERO? STACK /TRUE
	RFALSE

	.FUNCT V-TAKE
	CALL ITAKE >STACK
	EQUAL? STACK,1 \FALSE
	PRINT TAKEN
	CALL IS-THEFT? >STACK
	CALL PRINT-ID,STR?127,STACK >STACK
	RSTACK

	.FUNCT V-TAKE-OFF
	FSET? PRSO,VEHBIT \?L1
	CALL PERFORM,V?DISEMBARK,PRSO
	RTRUE
?L1:	CALL PERFORM,V?TAKE,PRSO
	RTRUE

	.FUNCT V-TELL
	FSET? PRSO,PERSON \?L1
	ZERO? P-CONT /?L3
	SET 'WINNER,PRSO
	RTRUE
?L3:	PRINTI "Hmmm ... "
	CALL THE-PRINT-PRSO
	PRINTR " waits for you to say something."
?L1:	CALL YOU-CANT-X-PRSO,STR?128
	CALL END-QUOTE >STACK
	RSTACK

	.FUNCT V-THANK
	ZERO? PRSO \?L1
	PRINTR "You're welcome, I guess."
?L1:	FSET? PRSO,PERSON \?L3
	CALL UNINTERESTED,PRSO >STACK
	RSTACK
?L3:	CALL HOW-DO-YOU
	CALL A-PRSO? >STACK
	RSTACK

	.FUNCT V-THROUGH,M
	EQUAL? PRSO,ROOMS \?L1
	CALL FIND-IN,HERE,VEHBIT >M
	ZERO? M /?L3
	CALL PERFORM,V?BOARD,M
	RTRUE
?L3:	GETPT HERE,P?IN >STACK
	ZERO? STACK /?L5
	CALL DO-WALK,P?IN >STACK
	RSTACK
?L5:	CALL V-WALK-AROUND >STACK
	RSTACK
?L1:	FSET? PRSO,VEHBIT \?L7
	CALL PERFORM,V?BOARD,PRSO
	RTRUE
?L7:	FSET? PRSO,TAKEBIT /?L8
	PRINT YOU-HIT
	CALL THE-PRINT-PRSO
	PRINTR " as you attempt this feat."
?L8:	IN? PRSO,WINNER \?L9
	PRINTR "That would involve quite a contortion!"
?L9:	CALL TELL-YUKS >STACK
	RSTACK

	.FUNCT V-THROW
	ZERO? PRSI /?L9
	FSET? PRSI,PERSON \?L1
	IN? PRSO,WINNER \?L3
	CALL IDROP >STACK
	ZERO? STACK /FALSE
	CALL NOT-TRAINED >STACK
	RSTACK
?L3:	CALL PERFORM,V?ATTACK,PRSI,PRSO
	RTRUE
?L1:	ZERO? PRSI /?L9
	FSET? PRSI,DOORBIT /?L9
	FSET? PRSI,CONTBIT \?L9
	CALL PERFORM,V?PUT,PRSO,PRSI
	RTRUE
?L9:	CALL IDROP >STACK
	ZERO? STACK /FALSE
	PRINTR "Thrown."

	.FUNCT V-THROW-OFF
	CALL YOU-CANT-X-THAT,STR?129 >STACK
	RSTACK

	.FUNCT V-TIE
	CALL HOW-DO-YOU
	CALL A-PRSI? >STACK
	RSTACK

	.FUNCT V-TIE-UP
	CALL HOW-DO-YOU
	CALL A-PRSO? >STACK
	RSTACK

	.FUNCT V-TIME,X
	SUB MOVES,LAST-SLEPT >X
	PRINTI "It's "
	LESS? X,15 \?L1
	PRINTI "early morning"
	JUMP ?L7
?L1:	LESS? X,30 \?L3
	PRINTI "mid-morning"
	JUMP ?L7
?L3:	LESS? X,50 \?L4
	PRINTI "mid-day"
	JUMP ?L7
?L4:	LESS? X,65 \?L5
	PRINTI "late afternoon"
	JUMP ?L7
?L5:	LESS? X,80 \?L6
	PRINTI "early evening"
	JUMP ?L7
?L6:	PRINTI "late evening"
?L7:	PRINT PERIOD
	RTRUE

	.FUNCT V-TORTURE
	PRINTI "An appalling idea!"
	CRLF
	CALL IS-PERSON? >STACK
	CALL PRINT-ID,STR?130,STACK
	CALL IS-ANIMAL? >STACK
	CALL PRINT-ID,STR?131,STACK
	CALL IS-SELF? >STACK
	CALL PRINT-ID,STR?132,STACK >STACK
	RSTACK

	.FUNCT V-TURN
	PRINTR "This has no effect."

	.FUNCT V-TURN-OVER
	PRINTI "Moving "
	CALL THE-PRINT-PRSO
	PRINTR " reveals nothing."

	.FUNCT V-UNLOCK
	CALL V-LOCK >STACK
	RSTACK

	.FUNCT V-UNTIE
	CALL HOW-DO-YOU
	CALL A-PRSO? >STACK
	RSTACK

	.FUNCT V-WALK,PT,PTS,STR,OBJ,RM
	ZERO? P-WALK-DIR \?L1
	CALL PERFORM,V?WALK-TO,PRSO
	RTRUE
?L1:	GETPT HERE,PRSO >PT
	ZERO? PT /?L3
	PTSIZE PT >PTS
	EQUAL? PTS,UEXIT \?L4
	GETB PT,REXIT >STACK
	CALL GOTO,STACK >STACK
	RSTACK
?L4:	EQUAL? PTS,NEXIT \?L6
	GET PT,NEXITSTR >STACK
	PRINT STACK
	CRLF
	RETURN 2
?L6:	EQUAL? PTS,FEXIT \?L9
	GET PT,FEXITFCN >STACK
	CALL STACK >RM
	ZERO? RM /?L10
	CALL GOTO,RM >STACK
	RSTACK
?L10:	RETURN 2
?L9:	EQUAL? PTS,CEXIT \?L15
	GETB PT,CEXITFLAG >STACK
	VALUE STACK >STACK
	ZERO? STACK /?L16
	GETB PT,REXIT >STACK
	CALL GOTO,STACK >STACK
	RSTACK
?L16:	GET PT,CEXITSTR >STR
	ZERO? STR /?L18
	PRINT STR
	CRLF
	RETURN 2
?L18:	CALL CANT-GO
	RETURN 2
?L15:	EQUAL? PTS,DEXIT \FALSE
	GETB PT,DEXITOBJ >OBJ
	FSET? OBJ,OPENBIT \?L25
	GETB PT,REXIT >STACK
	CALL GOTO,STACK >STACK
	RSTACK
?L25:	GET PT,DEXITSTR >STR
	ZERO? STR /?L27
	PRINT STR
	CRLF
	CALL THIS-IS-IT,OBJ
	RETURN 2
?L27:	CALL CTHE-PRINT,OBJ
	PRINTI " is closed."
	CRLF
	CALL THIS-IS-IT,OBJ
	RETURN 2
?L3:	CALL CANT-GO
	RETURN 2

	.FUNCT V-WALK-AROUND
	PRINTR "Please use compass directions instead."

	.FUNCT V-WALK-TO
	ZERO? PRSO /?L1
	IN? PRSO,HERE /?L3
	CALL GLOBAL-IN?,PRSO,HERE >STACK
	ZERO? STACK /?L1
?L3:	PRINTR "It's here!"
?L1:	CALL V-WALK-AROUND >STACK
	RSTACK

	.FUNCT V-WAIT,NUM=3
	PRINTI "Time passes..."
	CRLF
?L1:	DLESS? 'NUM,0 /?L2
	CALL CLOCKER >STACK
	ZERO? STACK /?L1
?L2:	SET 'CLOCK-WAIT,1
	RETURN CLOCK-WAIT

	.FUNCT V-WAIT-FOR
	LOC PRSO >STACK
	EQUAL? STACK,HERE,WINNER \?L1
	PRINTR "It's already here!"
?L1:	PRINTR "You may well wait quite a while."

	.FUNCT V-WAVE
	CALL HACK-HACK,STR?133 >STACK
	RSTACK

	.FUNCT V-WAVE-AT
	PRINTI "Despite your friendly nature, "
	CALL THE-PRINT-PRSO
	PRINTR " isn't likely to respond."

	.FUNCT V-WEAR
	CALL YOU-CANT-X-PRSO,STR?134 >STACK
	RSTACK

	.FUNCT V-WHAT
	PRINTR "An excellent question."

	.FUNCT V-WHERE
	ZERO? PRSO \?L1
	ZERO? P-IT-OBJECT /?L3
	CALL PERFORM,V?WHERE,P-IT-OBJECT
	RTRUE
?L3:	PRINTR "Why?"
?L1:	CALL V-FIND,1 >STACK
	RSTACK

	.FUNCT V-WHO
	ZERO? PRSO \?L1
	CALL V-WHAT >STACK
	RSTACK
?L1:	FSET? PRSO,PERSON \?L3
	CALL PERFORM,V?WHAT,PRSO
	RTRUE
?L3:	PRINTR "That's not a person!"

	.FUNCT V-YAWN
	CALL V-LEAN-ON >STACK
	RSTACK

	.FUNCT V-YELL
	PRINTR "Aarrrgggghhhhh!"

	.FUNCT ITAKE,VB=1,CNT,OBJ,?TMP
	CALL IMMOBILIZED? >STACK
	ZERO? STACK \FALSE
	FSET? PRSO,TAKEBIT /?L3
	ZERO? VB /FALSE
	CALL TELL-YUKS
	RFALSE
?L3:	IN? PRSO,WINNER \?L7
	PRINT YOU-HAVE
	PRINTI "it"
	PRINT PERIOD
	RFALSE
?L7:	LOC PRSO >STACK
	IN? STACK,WINNER /?L8
	CALL WEIGHT,PRSO >?TMP
	CALL WEIGHT,WINNER >STACK
	ADD ?TMP,STACK >STACK
	GRTR? STACK,LOAD-ALLOWED \?L8
	ZERO? VB /?L9
	FIRST? PLAYER >STACK \?L11
	PRINTI "Your load is too heavy"
	JUMP ?L13
?L11:	PRINTI "It's a little too heavy"
?L13:	LESS? LOAD-ALLOWED,LOAD-MAX \?L14
	PRINTI ", especially in light of your exhaustion."
	JUMP ?L16
?L14:	PRINTI "."
?L16:	CRLF
?L9:	RETURN 2
?L8:	CALL CCOUNT,WINNER >CNT
	GRTR? CNT,FUMBLE-NUMBER \?L20
	ZERO? VB /?L21
	PRINTI "You're holding too many things and can't quite get them all arranged to take it as well."
	CRLF
?L21:	RETURN 2
?L20:	MOVE PRSO,WINNER
	EQUAL? PRSO,TIME-CUBE /?L27
	CALL SCORE-OBJECT
?L27:	FCLEAR PRSO,NDESCBIT
	RTRUE

	.FUNCT SCORE-OBJECT,OBJ=0
	ZERO? OBJ \?L1
	SET 'OBJ,PRSO
?L1:	FSET? OBJ,TOUCHBIT /TRUE
	FSET OBJ,TOUCHBIT
	GETP OBJ,P?CUBE >STACK
	ZERO? STACK /?L7
	ADD SCORE,25 >SCORE
	RETURN SCORE
?L7:	FSET? OBJ,SCROLLBIT \?L9
	ADD SCORE,10 >SCORE
	RETURN SCORE
?L9:	FSET? OBJ,MAGICBIT \FALSE
	ADD SCORE,10 >SCORE
	RETURN SCORE

	.FUNCT IDROP
	CALL HELD?,PRSO >STACK
	ZERO? STACK \?L1
	PRINT YOU-ARENT
	PRINTI "carrying "
	CALL THE-PRSO
	RFALSE
?L1:	IN? PRSO,WINNER /?L3
	LOC PRSO >STACK
	FSET? STACK,OPENBIT /?L3
	CALL THIS-IS-IT,PRSO
	LOC PRSO >STACK
	CALL TELL-OPEN-CLOSED,STACK
	RFALSE
?L3:	LOC WINNER >STACK
	MOVE PRSO,STACK
	RTRUE

	.FUNCT CCOUNT,OBJ,CNT=0,X,X?1
	FIRST? OBJ >X?1 \?L3
?L1:	INC 'CNT
	NEXT? X?1 >X?1 /?L1
?L3:	RETURN CNT

	.FUNCT WEIGHT,OBJ,CONT,WT=0,CONT?1
	EQUAL? OBJ,ZIPPER,SPELL-BOOK /?L6
	FIRST? OBJ >CONT?1 \?L6
?L4:	CALL WEIGHT,CONT?1 >STACK
	ADD WT,STACK >WT
	NEXT? CONT?1 >CONT?1 /?L4
?L6:	GETP OBJ,P?SIZE >STACK
	ADD WT,STACK >STACK
	RSTACK

	.FUNCT DESCRIBE-ROOM,LOOK?=0,V?,STR,AV
	ZERO? LIT \?L1
	EQUAL? HERE,GRUE-CAVE,LIGHT-POOL,PILLAR-ROOM /?L1
	PRINT NOW-BLACK
	CRLF
	RFALSE
?L1:	IN? HERE,ROOMS \?L4
	PRINTD HERE
?L4:	LOC WINNER >AV
	FSET? AV,VEHBIT \?L12
	FSET? AV,SURFACEBIT \?L9
	PRINTI ", on "
	JUMP ?L11
?L9:	PRINTI ", in "
?L11:	CALL THE-PRINT,AV
	EQUAL? AV,ROC \?L12
	PRINTI "'s talons"
?L12:	CRLF
	SET 'V?,LOOK?
	ZERO? V? \?L19
	EQUAL? VERBOSITY,2 /?L18
	SET 'V?,0
	JUMP ?L19
?L18:	SET 'V?,1
?L19:	FSET? HERE,TOUCHBIT /?L22
	FSET HERE,TOUCHBIT
	ZERO? VERBOSITY /?L22
	SET 'V?,1
?L22:	SET 'DESCRIBED-ROOM?,V?
	ZERO? V? /TRUE
	EQUAL? HERE,AV /?L28
	FSET? AV,VEHBIT \?L28
	GETP AV,P?ACTION >STACK
	CALL STACK,M-LOOK >STACK
	ZERO? STACK \TRUE
?L28:	GETP HERE,P?ACTION >STACK
	CALL STACK,M-LOOK >STACK
	ZERO? STACK \TRUE
	GETP HERE,P?LDESC >STR
	ZERO? STR /TRUE
	PRINT STR
	CRLF
	RTRUE

	.FUNCT DESCRIBE-OBJECTS,V?=0,L
	EQUAL? HERE,BELWIT-SQUARE \?L1
	FSET? CLOUD,INVISIBLE \TRUE
?L1:	ZERO? LIT /?L3
	IN? PLAYER,ZIPPER \?L4
	SET 'L,ZIPPER
	JUMP ?L6
?L4:	SET 'L,HERE
?L6:	FIRST? L >STACK \FALSE
	ZERO? V? \?L9
	SET 'V?,VERBOSITY
?L9:	CALL PRINT-CONT,L,V?,-1 >STACK
	RSTACK
?L3:	EQUAL? HERE,LIGHT-POOL,PILLAR-ROOM,GRUE-CAVE /TRUE
	PRINT TOO-DARK
	RTRUE

	.FUNCT DESCRIBE-OBJECT,OBJ,V?,LEVEL,STR=0,AV,VEH?=0
	SET 'DESC-OBJECT,OBJ
	LOC WINNER >AV
	ZERO? AV /?L3
	FSET? AV,VEHBIT \?L3
	SET 'VEH?,1
	FSET? AV,OPENBIT /?L3
	CALL HELD?,OBJ,AV >STACK
	ZERO? STACK /FALSE
?L3:	ZERO? LEVEL \?L7
	GETP OBJ,P?DESCFCN >STACK
	CALL STACK,M-OBJDESC,OBJ >STACK
	ZERO? STACK \TRUE
	GETP OBJ,P?LDESC >STR
	ZERO? STR /?L11
	PRINT STR
	JUMP ?L12
?L11:	PRINTI "There is "
	CALL PRINTA,OBJ
	PRINTI " here"
	FSET? OBJ,ONBIT \?L13
	PRINT PROVIDING-LIGHT
?L13:	PRINTI "."
?L12:	ZERO? VEH? /?L20
	PRINTI " (outside "
	CALL THE-PRINT,AV
	PRINTI ")"
	JUMP ?L20
?L7:	GET INDENTS,LEVEL >STACK
	PRINT STACK
	CALL PRINTA,OBJ
	FSET? OBJ,ONBIT \?L20
	PRINT PROVIDING-LIGHT
?L20:	CRLF
	CALL SEE-INSIDE?,OBJ >STACK
	ZERO? STACK /FALSE
	FIRST? OBJ >STACK \FALSE
	CALL PRINT-CONT,OBJ,V?,LEVEL >STACK
	RSTACK

	.FUNCT PRINT-CONT,OBJ,V?=0,LEVEL=0,Y,1ST?,AV,STR,PV?=0,INV?=0
	FIRST? OBJ >Y \TRUE
	LOC WINNER >AV
	ZERO? AV /?L4
	FSET? AV,VEHBIT /?L6
?L4:	SET 'AV,0
?L6:	SET '1ST?,1
	LOC OBJ >STACK
	EQUAL? WINNER,OBJ,STACK \?L7
	SET 'INV?,1
?L7:	FIRST? OBJ >Y /?L13
?L39:	ZERO? PV? /?L15
	ZERO? AV /?L15
	FIRST? AV >STACK \?L15
	CALL PRINT-CONT,AV,V?,LEVEL
?L15:	ZERO? 1ST? \FALSE
	RTRUE
?L13:	EQUAL? Y,AV \?L20
	SET 'PV?,1
	JUMP ?L35
?L20:	EQUAL? Y,PLAYER /?L35
	FSET? Y,INVISIBLE /?L35
	FSET? Y,NDESCBIT \?L25
	FSET? Y,BRIEFBIT \?L23
	EQUAL? VERBOSITY,1 \?L23
	ZERO? DESCRIBED-ROOM? \?L23
?L25:	ZERO? 1ST? /?L26
	CALL FIRSTER,OBJ,LEVEL >STACK
	ZERO? STACK /?L30
	LESS? LEVEL,0 \?L30
	SET 'LEVEL,0
?L30:	INC 'LEVEL
	SET '1ST?,0
?L26:	CALL DESCRIBE-OBJECT,Y,V?,LEVEL
	JUMP ?L35
?L23:	FIRST? Y >STACK \?L35
	CALL SEE-INSIDE?,Y >STACK
	ZERO? STACK /?L35
	CALL PRINT-CONT,Y,V?,LEVEL
?L35:	NEXT? Y >Y /?L13
	JUMP ?L39

	.FUNCT PRINT-CONTENTS,OBJ,F,N,1ST?=1,IT?=0,TWO?=0
	FIRST? OBJ >F \FALSE
?L3:	NEXT? F >N /?L5
?L5:	EQUAL? F,PLAYER /?L16
	FSET? F,INVISIBLE /?L16
	ZERO? 1ST? /?L8
	SET '1ST?,0
	JUMP ?L11
?L8:	PRINTI ", "
	ZERO? N \?L11
	PRINTI "and "
?L11:	CALL PRINTA,F
	ZERO? IT? \?L14
	ZERO? TWO? \?L14
	SET 'IT?,F
	JUMP ?L16
?L14:	SET 'TWO?,1
	SET 'IT?,0
?L16:	SET 'F,N
	ZERO? F \?L3
	ZERO? IT? /?L4
	ZERO? TWO? \?L4
	CALL THIS-IS-IT,IT?
?L4:	ZERO? 1ST? \FALSE
	RTRUE

	.FUNCT CLEVER-CONTENTS,OBJ,STR,IGNORE=0,F,N=0,1ST?=1
	FIRST? OBJ >F /?L4
?L23:	ZERO? N /?L6
	ZERO? 1ST? /?L8
	SET '1ST?,0
	PRINT STR
	PRINTI " is "
	JUMP ?L10
?L8:	PRINTI " and "
?L10:	CALL PRINTA,N
	PRINTI "."
?L6:	ZERO? 1ST? \FALSE
	RTRUE
?L4:	EQUAL? F,PLAYER /?L14
	FSET? F,INVISIBLE /?L14
	EQUAL? F,IGNORE /?L14
	ZERO? N /?L15
	ZERO? 1ST? /?L17
	SET '1ST?,0
	PRINT STR
	PRINTI " are "
	JUMP ?L19
?L17:	PRINTI ", "
?L19:	CALL PRINTA,N
?L15:	SET 'N,F
?L14:	NEXT? F >F /?L4
	JUMP ?L23

	.FUNCT FIRSTER,OBJ,LEVEL
	EQUAL? OBJ,WINNER \?L1
	PRINTR "You are carrying:"
?L1:	IN? OBJ,ROOMS /FALSE
	GRTR? LEVEL,0 \?L4
	GET INDENTS,LEVEL >STACK
	PRINT STACK
?L4:	FSET? OBJ,SURFACEBIT \?L7
	PRINTI "Sitting on "
	CALL THE-PRINT,OBJ
	PRINTR " you see:"
?L7:	FSET? OBJ,PERSON \?L9
	CALL CTHE-PRINT,OBJ
	PRINTR " is holding:"
?L9:	CALL CTHE-PRINT,OBJ
	PRINTR " contains:"

	.FUNCT GOTO,RM,V?=1,OLIT
	GETP HERE,P?ACTION >STACK
	CALL STACK,M-LEAVE >STACK
	SET 'OHERE,HERE
	SET 'OLIT,LIT
	LOC WINNER >STACK
	EQUAL? STACK,HERE /?L1
	LOC WINNER >STACK
	MOVE STACK,RM
	JUMP ?L3
?L1:	MOVE WINNER,RM
?L3:	SET 'HERE,RM
	CALL LIT?,HERE >LIT
	ZERO? OLIT \?L4
	ZERO? LIT \?L4
	EQUAL? HERE,PILLAR-ROOM,LIGHT-POOL /?L4
	EQUAL? PRSA,V?BLORPLE /?L4
	RANDOM 100 >STACK
	LESS? 80,STACK /?L4
	CALL JIGS-UP,STR?135
	RTRUE
?L4:	GETP HERE,P?ACTION >STACK
	CALL STACK,M-ENTER >STACK
	EQUAL? HERE,RM \TRUE
	ZERO? V? /TRUE
	CALL V-FIRST-LOOK
	RTRUE

	.FUNCT JIGS-UP,DESC=0
	SET 'WINNER,PLAYER
	ZERO? DESC /?L1
	PRINT DESC
?L1:	EQUAL? HERE,INNER-VAULT,SCALES-ROOM \?L4
	CALL MAKE-JUNK
?L4:	CALL FORGET-ALL
	SET 'FALLING?,0
	PRINTI "

   ****  You have died  ****
"
	CRLF
	CALL WEAR-OFF-SPELLS,0
	PRINTI "You are floating in a dark, silent realm of nothingness. You don't know how much time passes, but eventually you hear the sound of soft footsteps. A figure in a dark cloak comes near. In a voice like ashes, it speaks: """
	GET DEATH-SPEECHES,DEATHS >STACK
	PRINT STACK
	PRINTI """

You find yourself falling down a deep well of darkness, as the figure recedes into infinite distances"
	IGRTR? 'DEATHS,3 \?L7
	PRINTI ", and mocking laughter haunts you for eternity."
	CRLF
	CALL FINISH
?L7:	PRINT PERIOD
	CRLF
	MOVE PLAYER,HERE
	IN? PLAYER,MAGIC-CARPET \?L10
	MOVE MAGIC-CARPET,PLAYER
?L10:	SET 'DEAD?,1
	CALL GOTO,DEATH-ROOM
	SET 'DEAD?,0
	SET 'P-CONT,0
	RETURN 2

	.FUNCT ROB,FROM,TO,IGNORE=0,F,N,1ST?=0
	FIRST? FROM >F /?L17
	RETURN 1ST?
?L1:	ZERO? F /?L3
?L17:	NEXT? F >N /?L6
?L6:	FSET? F,TAKEBIT \?L14
	EQUAL? F,IGNORE /?L14
	SET '1ST?,1
	IN? PLAYER,F \?L9
	MOVE PLAYER,HERE
?L9:	ZERO? TO /?L12
	MOVE F,TO
	JUMP ?L14
?L12:	REMOVE F
?L14:	SET 'F,N
	JUMP ?L1
?L3:	RETURN 1ST?

	.FUNCT THIS-IS-IT,OBJ
	EQUAL? OBJ,IT /FALSE
	SET 'P-IT-OBJECT,OBJ
	RETURN P-IT-OBJECT

	.FUNCT ACCESSIBLE?,OBJ,L,?TMP
	LOC OBJ >L
	FSET? OBJ,INVISIBLE /FALSE
	EQUAL? OBJ,PSEUDO-OBJECT \?L3
	EQUAL? LAST-PSEUDO-LOC,HERE \FALSE
	RTRUE
?L3:	ZERO? L /FALSE
	EQUAL? L,GLOBAL-OBJECTS /TRUE
	EQUAL? L,LOCAL-GLOBALS \?L9
	CALL GLOBAL-IN?,OBJ,HERE >STACK
	ZERO? STACK \TRUE
?L9:	CALL META-LOC,OBJ >?TMP
	LOC WINNER >STACK
	EQUAL? ?TMP,HERE,STACK \FALSE
	LOC WINNER >STACK
	EQUAL? L,WINNER,HERE,STACK /TRUE
	FSET? L,OPENBIT \FALSE
	CALL ACCESSIBLE?,L >STACK
	ZERO? STACK /FALSE
	RTRUE

	.FUNCT VISIBLE?,OBJ,L
	LOC OBJ >L
	CALL ACCESSIBLE?,OBJ >STACK
	ZERO? STACK \TRUE
	CALL SEE-INSIDE?,L >STACK
	ZERO? STACK /?L3
	CALL VISIBLE?,L >STACK
	ZERO? STACK \TRUE
?L3:	EQUAL? HERE,VOLCANO-ROOM \FALSE
	EQUAL? L,OUTCROPPING-ROOM \FALSE
	RTRUE

	.FUNCT META-LOC,OBJ
?L1:	ZERO? OBJ /FALSE
	IN? OBJ,GLOBAL-OBJECTS \?L5
	RETURN GLOBAL-OBJECTS
?L5:	IN? OBJ,ROOMS \?L7
	RETURN OBJ
?L7:	LOC OBJ >OBJ
	JUMP ?L1

	.FUNCT HELD?,OBJ,WHO=0
	ZERO? WHO \?L1
	SET 'WHO,PLAYER
?L1:	ZERO? OBJ /FALSE
	IN? OBJ,WHO /TRUE
	IN? OBJ,ROOMS /FALSE
	IN? OBJ,GLOBAL-OBJECTS /FALSE
	LOC OBJ >STACK
	CALL HELD?,STACK,WHO >STACK
	RSTACK

	.FUNCT SEE-INSIDE?,OBJ
	ZERO? OBJ /FALSE
	FSET? OBJ,INVISIBLE /FALSE
	FSET? OBJ,TRANSBIT /TRUE
	FSET? OBJ,OPENBIT /TRUE
	RFALSE

	.FUNCT GLOBAL-IN?,OBJ1,OBJ2,TEE
	ZERO? OBJ2 /FALSE
	GETPT OBJ2,P?GLOBAL >TEE
	ZERO? TEE /FALSE
	PTSIZE TEE >STACK
	DEC 'STACK
	CALL ZMEMQB,OBJ1,TEE,STACK >STACK
	RSTACK

	.FUNCT DO-WALK,DIR
	SET 'P-WALK-DIR,DIR
	CALL PERFORM,V?WALK,DIR >STACK
	RSTACK

	.FUNCT SOAK-STUFF,OBJ,RECURSE?=1,F,1ST?=1
	FIRST? OBJ >F /?L4
?L16:	ZERO? 1ST? \FALSE
	RTRUE
?L4:	CALL SOAK-OBJ?,F >STACK
	ZERO? STACK /?L8
	SET '1ST?,0
	JUMP ?L11
?L8:	ZERO? RECURSE? \?L9
	EQUAL? F,PLAYER /?L11
?L9:	FSET? F,CONTBIT \?L11
	FSET? F,OPENBIT \?L11
	FIRST? F >STACK \?L11
	CALL SOAK-STUFF,F >STACK
	ZERO? STACK /?L11
	SET '1ST?,0
?L11:	NEXT? F >F /?L4
	JUMP ?L16

	.FUNCT SOAK-OBJ?,F
	FSET? F,RMUNGBIT /FALSE
	EQUAL? F,SPELL-BOOK /?L4
	FSET? F,SCROLLBIT \FALSE
?L4:	FSET F,RMUNGBIT
	RTRUE

	.FUNCT HACK-HACK,STR
	PRINT STR
	PRINTI " "
	CALL THE-PRINT-PRSO
	PRINTR " has no effect."

	.FUNCT TELL-YUKS
	CALL PICK-ONE,YUKS >STACK
	PRINT STACK
	CRLF
	RTRUE

	.FUNCT OPEN-CLOSE
	EQUAL? PRSA,V?OPEN \?L1
	FSET? PRSO,OPENBIT \?L1
	CALL ALREADY-OPEN
	RTRUE
?L1:	EQUAL? PRSA,V?CLOSE \FALSE
	FSET? PRSO,OPENBIT /FALSE
	CALL ALREADY-CLOSED
	RTRUE

	.FUNCT PRE-SWRITE
	ZERO? PRSO /FALSE
	ZERO? PRSI /FALSE
	CALL PERFORM,V?WRITE,PRSI,PRSO
	RTRUE

	.FUNCT V-SWRITE
	PRINTI "Write what on "
	CALL THE-PRINT-PRSO
	PRINTR "?"

	.FUNCT PRE-WRITE-ON
	ZERO? PRSI \?L1
	PRINT YOU-HAVE-TO
	PRINTI " write on "
	CALL THE-PRINT-PRSO
	PRINTR " with something."
?L1:	EQUAL? PRSI,BURIN \?L3
	CALL V-SWRITE >STACK
	RSTACK
?L3:	CALL NO-BURIN >STACK
	RSTACK

	.FUNCT V-WRITE-ON
	CALL CTHE-PRINT-PRSO
	PRINT HAS-NO-SURFACE
	PRINT PERIOD
	RTRUE

	.FUNCT PRE-WRITE
	ZERO? PRSI \?L1
	EQUAL? PRSO,QWORD \?L3
	PRINT YOU-HAVE-TO
	PRINTR " write that on something."
?L3:	FSET? PRSO,SPELLBIT /?L6
	FSET? PRSO,SCROLLBIT \?L5
?L6:	PRINTR "You have to copy the spell onto something."
?L5:	PRINT YOU-CANT
	PRINTI "write "
	CALL PRINTA-PRSO
	PRINTR ". Try writing a word, such as ""purple"", instead."
?L1:	IN? BURIN,WINNER /?L8
	CALL NO-BURIN >STACK
	RSTACK
?L8:	FSET? PRSO,SPELLBIT /?L10
	FSET? PRSO,SCROLLBIT \FALSE
?L10:	CALL PERFORM,V?COPY,PRSO,PRSI
	RTRUE

	.FUNCT V-WRITE
	CALL CTHE-PRINT-PRSI
	PRINT HAS-NO-SURFACE
	PRINT PERIOD
	RTRUE

	.FUNCT V-PRY
	CALL V-TURN >STACK
	RSTACK

	.FUNCT V-PLANT
	PRINT I-DONT-THINK-THAT
	CALL THE-PRINT-PRSO
	PRINTR " is going to sprout."

	.FUNCT V-YES
	PRINTR "That was a rhetorical question."

	.FUNCT V-NO
	CALL V-YES >STACK
	RSTACK

	.FUNCT V-BUY
	CALL UNINTERESTED,PRSI >STACK
	RSTACK

	.FUNCT PRE-SSELL
	CALL PERFORM,V?SELL,PRSI,PRSO
	RTRUE

	.FUNCT V-SSELL
	RTRUE

	.FUNCT V-SELL
	CALL UNINTERESTED,PRSI >STACK
	RSTACK

	.FUNCT PRE-TELL-ABOUT
	EQUAL? PRSO,ME \FALSE
	CALL PERFORM,V?TELL-ME-ABOUT,PRSI
	RTRUE

	.FUNCT V-TELL-ABOUT
	CALL UNINTERESTED,PRSO >STACK
	RSTACK

	.FUNCT V-TELL-ME-ABOUT
	EQUAL? WINNER,PLAYER \?L1
	PRINTR "Talking to yourself?"
?L1:	CALL UNINTERESTED,WINNER >STACK
	RSTACK

	.FUNCT V-OFFER
	CALL V-TRADE >STACK
	RSTACK

	.FUNCT V-TRADE
	IN? MERCHANT,HERE \?L1
	EQUAL? PRSO,MAGIC-CARPET,RANDOM-CARPET \?L1
	CALL HELD?,PRSO >STACK
	ZERO? STACK /?L1
	EQUAL? PRSO,RANDOM-CARPET \?L3
	PUSH MAGIC-CARPET
	JUMP ?L5
?L3:	PUSH RANDOM-CARPET
?L5:	CALL ASK-ABOUT-CARPET,STACK >STACK
	RSTACK
?L1:	ZERO? PRSI /?L6
	FSET? PRSI,PERSON \?L6
	CALL UNINTERESTED,PRSI >STACK
	RSTACK
?L6:	PRINTR "Perhaps it isn't for sale."

	.FUNCT V-SLAVER
	PRINTR "You're not very convincing."

	.FUNCT V-ERASE
	GETP PRSO,P?NAME >STACK
	ZERO? STACK /?L1
	CALL YOU-CANT-X-PRSO,STR?136 >STACK
	RSTACK
?L1:	GETPT PRSO,P?NAME >STACK
	ZERO? STACK /?L3
	PRINT THERES-NOTHING-TO
	PRINTI "erase"
	PRINT PERIOD
	RTRUE
?L3:	CALL TELL-YUKS >STACK
	RSTACK

	.FUNCT V-ADMIRE
	PRINTR "Your taste is unusual."

	.FUNCT V-COPY
	ZERO? PRSI \?L1
	PRINT YOU-HAVE-TO
	PRINTR " copy it onto something."
?L1:	EQUAL? PRSI,BURIN \?L3
	PRINTR "You should copy something onto something else."
?L3:	FSET? PRSI,TOOLBIT \?L4
	CALL NOT-WRITING-TOOL >STACK
	RSTACK
?L4:	EQUAL? PRSI,SPELL-BOOK \?L5
	PRINTI "You have to ""gnusto"" spells into "
	CALL A-PRSI >STACK
	RSTACK
?L5:	FSET? PRSO,SPELLBIT \?L7
	FSET? PRSO,SCROLLBIT \?L7
	FSET? PRSI,SCROLLBIT /?L6
?L7:	PRINT YOU-CANT
	PRINTI "copy "
	CALL PRINTA-PRSO
	PRINTI " onto "
	CALL A-PRSI >STACK
	RSTACK
?L6:	IN? BURIN,WINNER /?L8
	CALL NO-BURIN >STACK
	RSTACK
?L8:	CALL ALREADY-USED >STACK
	RSTACK

	.FUNCT ALREADY-USED,F
	FIRST? PRSI >F /?L1
?L1:	PRINTI "That scroll already has "
	CALL THE-PRINT,F
	PRINTR " written on it."

	.FUNCT NOT-WRITING-TOOL
	PRINT I-DONT-THINK-THAT
	CALL PRINTA-PRSI
	PRINTR " makes a very good writing instrument."

	.FUNCT NO-BURIN
	PRINT YOU-DONT-HAVE
	PRINTR "anything to write with."

	.FUNCT V-BARGAIN
	PRINTR "Perhaps you should go to a bazaar."

	.FUNCT V-REPAIR
	FSET? PRSO,RMUNGBIT \?L1
	PRINTR "I don't know how."
?L1:	CALL CTHE-PRINT-PRSO
	PRINTR " isn't broken."

	.FUNCT V-LOOK-UP
	EQUAL? PRSO,ROOMS \?L1
	PRINTR "Don't get a sore neck."
?L1:	CALL PERFORM,V?WHAT,PRSO
	RTRUE

	.FUNCT V-EMPATHIZE,?TMP
	PRINTI "A nice sentiment."
	CRLF
	CALL IS-ANIMAL? >?TMP
	ZERO? ?TMP /?L2
	PUSH ?TMP
	JUMP ?L1
?L2:	CALL IS-PERSON? >STACK
?L1:	CALL PRINT-ID,STR?137,STACK >STACK
	RSTACK

	.FUNCT PRINT-DESC1,OBJ
	ZERO? OBJ /FALSE
	CALL DPRINT,OBJ
	RTRUE

	.FUNCT PRINT-ID,ID,CONDITION=1
	ZERO? CONDITION /FALSE
	PRINTI "[ID: "
	PRINT ID
	PRINTI ", PRSO: "
	CALL PRINT-DESC1,PRSO
	PRINTI ", PRSI: "
	CALL PRINT-DESC1,PRSI
	PRINTI "]"
	RTRUE

	.FUNCT PRINT-DEBUG,TEXT,CONDITION=1
	ZERO? CONDITION /FALSE
	PRINTI "DEBUG FLAG: "
	PRINT TEXT
	RTRUE

	.FUNCT IS-THEFT?
	EQUAL? PRSA,V?TAKE \FALSE
	EQUAL? PRSO,ESPNIS-SCROLL,MAGIC-BOX,WATER-CUBE /TRUE
	EQUAL? PRSO,KEY,TREASURE,SHEARS /TRUE
	EQUAL? PRSO,CONNECTIVITY-CUBE \FALSE
	RTRUE

	.FUNCT IS-OBJECT-OR-PROPERTY?
	EQUAL? PRSO,AIR-CUBE,BLANK-SCROLL,BOTTLE /TRUE
	EQUAL? PRSO,BREAD,CABINET,CARPET-LABEL /TRUE
	EQUAL? PRSO,CASKLY-SCROLL,CEILING,CELL-DOOR /TRUE
	EQUAL? PRSO,CHANGE-CUBE,CHUNK,COMPASS-CARVING /TRUE
	EQUAL? PRSO,COMPASS-ROSE,CONNECTIVITY-CUBE,CORRIDOR /TRUE
	EQUAL? PRSO,CUBE-1,CUBE-10,CUBE-11 /TRUE
	EQUAL? PRSO,CUBE-2,CUBE-3,CUBE-4 /TRUE
	EQUAL? PRSO,CUBE-5,CUBE-6,CUBE-7 /TRUE
	EQUAL? PRSO,CUBE-8,CUBE-9,DARK-CUBE /TRUE
	EQUAL? PRSO,DEAD-BOOK,DEATH-CUBE,EARTH-CUBE /TRUE
	EQUAL? PRSO,EAST-RUNE,EAST-WALL,EGG /TRUE
	EQUAL? PRSO,EMPORIUM-DOOR,ESPNIS-SCROLL,FIRE-CUBE /TRUE
	EQUAL? PRSO,FISH,GIRGOL-SCROLL,GROUPER-NEST /TRUE
	EQUAL? PRSO,HOOBLY,HUT,HYPERCUBE /TRUE
	EQUAL? PRSO,ICEBERG,IDOL,INFLOW /TRUE
	EQUAL? PRSO,IRON-DOOR,KEY,LAVA-ROCK /TRUE
	EQUAL? PRSO,LIFE-CUBE,LIGHT-CUBE,LINES /TRUE
	EQUAL? PRSO,LISKON-SCROLL,MAGIC-BOX,MAGIC-CARPET /TRUE
	EQUAL? PRSO,MAGIC-CUBE,MAZE-2-DOOR,MIND-CUBE /TRUE
	EQUAL? PRSO,MOUTH,NE-RUNE,NE-WALL /TRUE
	EQUAL? PRSO,NORTH-RUNE,NORTH-WALL,NW-RUNE /TRUE
	EQUAL? PRSO,NW-WALL,OCTAGONAL-HOLE,OPAL /TRUE
	EQUAL? PRSO,OPAL-SHARD,ORKAN,OTHER-ROCK /TRUE
	EQUAL? PRSO,OUBLIETTE-CHANNEL,OUTCROPPING,OUTFLOW /TRUE
	EQUAL? PRSO,PAST-CABINET,PILE-1,PILE-2 /TRUE
	EQUAL? PRSO,PILLAR,RANDOM-CARPET,ROCK /TRUE
	EQUAL? PRSO,RUINS-CHANNEL,RUINS-INFLOW,RUINS-OUTFLOW /TRUE
	EQUAL? PRSO,SACK,SE-RUNE,SE-WALL /TRUE
	EQUAL? PRSO,SHEARS,SOUTH-RUNE,SOUTH-WALL /TRUE
	EQUAL? PRSO,SW-RUNE,SW-WALL,TEETH /TRUE
	EQUAL? PRSO,THROCK-SCROLL,TIME-CUBE,TINSOT-SCROLL /TRUE
	EQUAL? PRSO,TRAP-DOOR,TREASURE,VAULT-DOOR /TRUE
	EQUAL? PRSO,WALLS,WATER-CUBE,WATER-PIPE /TRUE
	EQUAL? PRSO,WEED,WEST-RUNE,WEST-WALL /TRUE
	EQUAL? PRSO,ZIPPER,ZORKMID \FALSE
	RTRUE

	.FUNCT IS-PERSON?
	EQUAL? PRSO,ALARM-FAIRY,ARDIS,BELBOZ /TRUE
	EQUAL? PRSO,GZORNENPLATZ,HERMIT,MERCHANT /TRUE
	EQUAL? PRSO,SHADOW,SNEFFLE,SORCERER /TRUE
	EQUAL? PRSO,SPEAKER \FALSE
	RTRUE

	.FUNCT IS-ANIMAL?
	EQUAL? PRSO,BABY-ROC,GLOBAL-GRUE,GROUPER /TRUE
	EQUAL? PRSO,GRUE,OGRE,ROC /TRUE
	EQUAL? PRSO,SNAKE \FALSE
	RTRUE

	.FUNCT IS-SELF?
	EQUAL? PRSO,ME,HEAD \FALSE
	RTRUE

	.FUNCT IS-PART-OF-SELF?
	EQUAL? PRSO,EYES,HANDS \FALSE
	RTRUE

	.FUNCT IS-SELF-OR-PART-OF-SELF?,?TMP
	CALL IS-SELF? >?TMP
	ZERO? ?TMP /?L2
	RETURN ?TMP
?L2:	CALL IS-PART-OF-SELF? >STACK
	RSTACK

	.FUNCT IS-YOUR-PROPERTY?
	EQUAL? PRSO,KNIFE,SPELL-BOOK,BURIN \FALSE
	RTRUE

	.FUNCT DANGEROUS-DRINK?
	EQUAL? PRSO,DIRT,WATER-PIPE \FALSE
	RTRUE

	.FUNCT DANGEROUS-FOOD?
	CALL IS-PART-OF-SELF? >STACK
	ZERO? STACK \?L2
	CALL IS-OBJECT-OR-PROPERTY? >STACK
	ZERO? STACK /FALSE
?L2:	EQUAL? PRSO,BREAD,FISH \TRUE
	RFALSE

	.FUNCT IS-OBJ-PROP-ANIMAL?,?TMP
	CALL IS-OBJECT-OR-PROPERTY? >?TMP
	ZERO? ?TMP /?L2
	RETURN ?TMP
?L2:	CALL IS-ANIMAL? >STACK
	RSTACK

	.FUNCT GENERIC-CUBE-F,TBL,LEN,F,CNT=1,CONT=0,CUBE?
	EQUAL? PRSA,V?ASK-ABOUT,V?TELL-ME-ABOUT,V?COUNT \?L1
	GET TBL,CNT >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?TAKE \?L4
	GET P-ITBL,P-PREP2 >STACK
	EQUAL? STACK,PR?FROM \?L4
	GET P-PRSI,P-MATCHLEN >STACK
	EQUAL? STACK,1 \?L4
	GET P-PRSI,1 >CONT
?L4:	GRTR? CNT,LEN /FALSE
	GET TBL,CNT >F
	GETPT F,P?NAME >CUBE?
	ZERO? CUBE? /?L17
	CALL VISIBLE?,F >STACK
	ZERO? STACK \?L14
	EQUAL? PRSA,V?ASK-ABOUT,V?TELL-ABOUT \?L17
?L14:	GETP F,P?NAME >STACK
	ZERO? STACK \?L17
	ZERO? CONT /?L19
	IN? F,CONT \?L17
?L19:	RETURN F
?L17:	INC 'CNT
	JUMP ?L4

	.FUNCT GENERIC-FISH-F,TBL,LEN
	EQUAL? PRSA,V?DROP,V?EAT,V?SHOW /?L3
	EQUAL? PRSA,V?GIVE \FALSE
?L3:	RETURN FISH

	.FUNCT GENERIC-ROCK-F,TBL,LEN
	IN? PLAYER,ROCK \?L1
	RETURN ROCK
?L1:	IN? PLAYER,OTHER-ROCK \?L3
	RETURN OTHER-ROCK
?L3:	EQUAL? YOU-LOC,ROCK-LOC \?L5
	EQUAL? YOU-LOC,OTHER-ROCK-LOC /FALSE
	EQUAL? YOU-LOC,ROCK-LOC \?L5
	RETURN ROCK
?L5:	EQUAL? YOU-LOC,OTHER-ROCK-LOC \FALSE
	RETURN OTHER-ROCK

	.FUNCT GENERIC-CARPET-F,TBL,LEN
	EQUAL? PRSA,V?EXAMINE /FALSE
	RETURN RANDOM-CARPET

	.FUNCT GENERIC-HOLE-F,TBL,LEN
	IN? OCTAGONAL-HOLE,HERE /?L3
	EQUAL? HERE,MAZE-2 \?L1
?L3:	RETURN OCTAGONAL-HOLE
?L1:	RETURN GLOBAL-HOLE

	.FUNCT GENERIC-RANDOM-F,TBL,LEN
	RFALSE

	.FUNCT I-ORATION
	INC 'OCOUNT
	CRLF
	EQUAL? OCOUNT,1 \?L1
	SET 'ORATOR,SNEFFLE
	PRINTD SNEFFLE
	PRINTR " of the Guild of Bakers is addressing the gathering. ""Do you know what this is doing to our business? Do you know how difficult it is to make those yummy butter pastries by hand? When a simple 'gloth' spell would fold the dough 83 times it was possible to make a profit, but now 'gloth' hardly works, and when it does, it usually folds the dough too often and the butter melts, or it doesn't come out the right size, or..."" He stops, apparently overwhelmed by the prospect of a world where the pastries have to be hand-made. ""Can't you do anything about this? You're supposed to know all about magic!"""
?L1:	EQUAL? OCOUNT,2 \?L3
	SET 'ORATOR,HOOBLY
	PRINTD HOOBLY
	PRINTR " of the Guild of Brewers stands, gesturing at the floury baker. ""You don't know what trouble is! Lately, what comes out of the vats, like as not, is cherry flavored or worse. The last vat, I swear it, tasted as if grues had been bathing in it. It takes magic to turn weird vegetables and water into good Borphee beer. Well, without magic, there isn't going to be any beer!"" This statement has a profound effect on portions of the crowd. You can hear rumblings from the back concerning Enchanters. The word ""traitors"" rises out of nowhere. Your fellow Enchanters are looking at one another nervously."
?L3:	EQUAL? OCOUNT,3 \?L4
	SET 'ORATOR,GZORNENPLATZ
	PRINTI "A tall, gruff fellow begins to speak. This is "
	PRINTD GZORNENPLATZ
	PRINTR " of the Guild of Huntsmen. ""I'm a simple man, and I don't know much about magic. But I do know that the wild beasts are kept out of the towns and villages not just by the huntsmen, but by spells as well. Just yesterday, one of my men was attacked and badly wounded by a troop of rat-ants. They'd slipped the bounds set down by a 'fripple' spell somehow. Are we going to let the sorcerers loose rat-ants on us, and worse?"" He sits, glaring significantly at the now-angry clump of mages around you."
?L4:	EQUAL? OCOUNT,4 \?L5
	SET 'ORATOR,ARDIS
	SET 'CLEESHED?,1
	MOVE BLORPLE-SPELL,SPELL-BOOK
	PRINTI "As the huntsman's accusations are being absorbed and discussed, "
	PRINTD ARDIS
	PRINTI " of the Guild of Poets takes the floor. He begins to talk about magic rhyming and spelling aids, and their lack.

In the midst of his splendid peroration, just as he was sketching out an insulting mythological allusion in iambic hexameter, the poet turns even greener than usual. His chin elongates and his skin begins to look sort of slimy. In the blink of an eye there stands at the podium, not the orator, but rather a large orange newt. ""Breek! Co-ax! Co-ax!"" it protests.

As you look around the room in shock, you discover that Ardis is not alone. Each and every guildmaster in the room has been turned into a frog, salamander, or other amphibian! All but one, that is: yourself!

No! There is one other survivor. At the rear of the room, a "
	PRINTD SHADOW
	PRINTI " in a dark cloak slips quietly out the door."
	CALL THIS-IS-IT,SHADOW
	FCLEAR SHADOW,NDESCBIT
	MOVE SHADOW,GUILD-HALL
	CALL QUEUE,I-SHADOW-GOES,1
	CALL DEQUEUE,I-ORATION
?L5:	CRLF
	RTRUE

	.FUNCT I-SAMARRA
	EQUAL? HERE,BELWIT-SQUARE,GUILD-HALL \?L1
	CRLF
	PRINTR "Out of the corner of your eye, you see the dark-cloaked figure. At first oblivious to you, it straightens up, startled and surprised, then vanishes."
?L1:	SET 'SAMARRA?,0
	RETURN SAMARRA?

	.FUNCT I-SHADOW-GOES
	IN? SHADOW,GUILD-HALL \?L1
	CALL QUEUE,I-SHADOW-GOES,1
	MOVE SHADOW,BELWIT-SQUARE
	EQUAL? HERE,GUILD-HALL \FALSE
	CRLF
	CALL CTHE-PRINT,SHADOW
	PRINTR ", its cloak billowing, charges south into Belwit Square."
?L1:	MOVE EARTH-CUBE,BELWIT-SQUARE
	MOVE SHADOW,GLOBAL-OBJECTS
	FCLEAR SHADOW,TAKEBIT
	FCLEAR SHADOW,TRYTAKEBIT
	FCLEAR CLOUD,INVISIBLE
	CALL QUEUE,I-CLOUD-GONE,20
	EQUAL? HERE,GUILD-HALL \?L7
	CRLF
	PRINTR "Out in the square, there is a crashing noise like an explosion, and then a wisp of orange smoke drifts in through the door."
?L7:	EQUAL? HERE,BELWIT-SQUARE \FALSE
	CRLF
	PRINTR "The sinister figure, its face hidden in the shadows of a dark cowl, turns to face you. It nonchalantly jumps into the air, where it is engulfed in a huge explosion. A thick and acrid cloud of orange smoke fills the square. There is no sign of the figure."

	.FUNCT I-CLOUD-GONE
	FSET CLOUD,INVISIBLE
	IN? EARTH-CUBE,BELWIT-SQUARE \?L1
	FCLEAR EARTH-CUBE,INVISIBLE
	CALL THIS-IS-IT,EARTH-CUBE
?L1:	EQUAL? HERE,BELWIT-SQUARE \FALSE
	CRLF
	PRINTI "The orange smoke dissipates almost as suddenly as it arrived"
	IN? EARTH-CUBE,BELWIT-SQUARE \?L6
	PRINTI ". Left behind on the cobblestones is a small "
	PRINT WHITE-CUBE
?L6:	CALL CLEVER-CONTENTS,HERE,STR?138,EARTH-CUBE
	PRINT PERIOD
	RTRUE

	.FUNCT I-SHADOW-ARRIVES
	EQUAL? HERE,CASTLE \FALSE
	EQUAL? TIME-STOPPED?,HERE \?L3
	CALL QUEUE,I-SHADOW-ARRIVES,1
	RFALSE
?L3:	CALL QUEUE,I-SHADOW,-1
	MOVE SHADOW,CASTLE
	FCLEAR SHADOW,TAKEBIT
	FCLEAR SHADOW,TRYTAKEBIT
	CRLF
	PRINTR "Around the throne a dark mist begins to coalesce. It thickens into the outline of a human figure sitting nonchalantly on the throne. You can see the ghost of a cloak and hood as well."

	.FUNCT I-SHADOW,WON?=0,X
	EQUAL? HERE,CASTLE /?L1
	CALL DEQUEUE,I-SHADOW
	RFALSE
?L1:	ZERO? SAMARRA? /?L4
	SET 'SAMARRA?,0
	CRLF
	PRINTR """So glad to see you. I was surprised to find you in Borphee when I knew we had an appointment here."""
?L4:	EQUAL? TIME-STOPPED?,HERE /FALSE
	INC 'SHADOW-COUNT
	CRLF
	EQUAL? SHADOW-COUNT,1 \?L10
	PRINTI "The figure speaks. ""It's been such a pleasure to follow your progress. "
	GRTR? DEATHS,0 \?L12
	PRINTI "I'm so glad I could be of assistance when you had trouble. It made me feel useful. "
?L12:	PRINTR "Thank you for collecting the cubes."""
?L10:	EQUAL? SHADOW-COUNT,2 \?L15
	MOVE HYPERCUBE,HERE
	PRINTI "The figure waves its arms in the air. Before you, rolling and tumbling in a bath of light, are four cubes. ""When I gathered these and "
	CALL THE-PRINT,EARTH-CUBE
	PRINTR ", after searching old tomes and questioning the wise about their whereabouts, I conceived my plan. I could not gather the remainder of the cubes, but to achieve my desire, they had to be brought together. Who better than you to act in my stead?"""
?L15:	EQUAL? SHADOW-COUNT,3 \?L16
	PRINTI """It was a simple matter to perturb the cubes I had to make your simple magics flicker or fail. I knew this would set you on a quest. For I know you well!"" The four cubes disappear. The figure sits straight on its throne and removes its hood. You are looking at a shadowy, dark and transparent version of yourself!"
	CRLF
	CRLF
	PRINTR """Magic is a powerful force, the most powerful in the universe, but its exercise has its price. Each time a great mage performs a spell, some part of the power in that spell is lost in shadow. A great mage ultimately creates a shadow-self that is dimly aware."" The figure grins. ""You have become the most powerful wizard of all, for I, your shadow, have become very nearly as powerful as you!"""
?L16:	EQUAL? SHADOW-COUNT,4 \?L17
	PRINTI """But why, you ask, am I collecting the elemental cubes? It's easy to answer. I am not powerful enough. My existence is still but a shadow of your own. My desires are unfulfilled. I wish power over all creation! I wish to remold the universe in my own image, and rule it. In such a universe, my merest whim would smash a star or slay a butterfly. You have brought me the tools of the remaking!"""
	CRLF
	CRLF
	ZERO? FROZEN? \?L18
	CALL FREEZES-YOU,1
	CRLF
?L18:	CALL SHADOW-ACQUIRES,EARTH-CUBE
	PRINTR " sets it in the air between you, where it hangs motionless."
?L17:	EQUAL? SHADOW-COUNT,5 \?L21
	CALL SHADOW-ACQUIRES,AIR-CUBE
	PRINTI " places it next to "
	CALL THE-PRINT,EARTH-CUBE
	PRINTI ". They disappear into a glowing line which appears between them. "
	CALL SHADOW-ACQUIRES,0
	PRINTI " places "
	CALL THE-PRINT,FIRE-CUBE
	PRINTI " and "
	CALL THE-PRINT,WATER-CUBE
	PRINTR " in the air, creating a square of glowing light."
?L21:	EQUAL? SHADOW-COUNT,6 \?L22
	PRINTI "Four more cubes are placed above the square: "
	CALL THE-PRINT,LIFE-CUBE
	PRINTI ", "
	CALL THE-PRINT,DEATH-CUBE
	PRINTI ", "
	CALL THE-PRINT,LIGHT-CUBE
	PRINTI " and "
	CALL THE-PRINT,DARK-CUBE
	PRINTR ". A cube of light shimmers before you. The shadow is growing more excited, hopping around the structure to place the cubes."
?L22:	EQUAL? SHADOW-COUNT,7 \?L23
	PRINTI "All the remaining cubes save one, "
	CALL THE-PRINT,MAGIC-CUBE
	PRINTR ", build another square, then the shadow adds its own four cubes to make a second cube of light, which hangs next to the first."
?L23:	EQUAL? SHADOW-COUNT,8 \?L24
	PRINTR "The shadow grabs the first cube of light, and twisting, chanting, squeezing, the cube is compressed and thrust inside the second cube. The points of the inner and outer cube connect, and it begins to tumble, seeming to twist and distort as one face, then another, presents itself to you. The figure capers madly in front of its construction, laughing and giggling. It ignores you."
?L24:	EQUAL? SHADOW-COUNT,9 \?L25
	CALL ROB,HYPERCUBE,HERE,MAGIC-CUBE >STACK
	ZERO? STACK /?L26
	CALL CTHE-PRINT,SHADOW
	PRINTI " removes some detritus from "
	CALL THE-PRINT,HYPERCUBE
	PRINTI ". "
?L26:	IN? MAGIC-CUBE,HYPERCUBE \?L29
	CALL CTHE-PRINT,SHADOW
	PRINTI " grins evilly at "
	CALL THE-PRINT,MAGIC-CUBE
	PRINTI " floating in"
	JUMP ?L31
?L29:	CALL SHADOW-ACQUIRES,MAGIC-CUBE
	MOVE MAGIC-CUBE,HYPERCUBE
	PRINTI " raising it high, thrusts it into"
?L31:	PRINTI " the center of the tesseract! Cascades of light pour forth, blindingly bright, but you can still see "
	CALL THE-PRINT,MAGIC-CUBE
	PRINTR " at the center. The shadow is growing more solid, no longer transparent and dark! Chortling gleefully, it prepares to jump into the hypercube!"
?L25:	EQUAL? SHADOW-COUNT,10 \FALSE
	PRINTI "The shadow, now as solid as a real person, performs a back flip into the tesseract"
	IN? MAGIC-CUBE,HYPERCUBE \?L33
	SET 'WON?,0
	PRINTI ", laughing triumphantly."
	JUMP ?L39
?L33:	FIRST? HYPERCUBE >X \?L35
	CALL MAGIC?,X >STACK
	ZERO? STACK \?L36
	SET 'WON?,3
	JUMP ?L39
?L36:	SET 'WON?,2
	JUMP ?L39
?L35:	SET 'WON?,1
?L39:	EQUAL? WON?,2 \?L40
	PRINTI ". ""Fool! Everything will be as it was!"""
	JUMP ?L42
?L40:	ZERO? WON? /?L42
	PRINTI ". ""No!"" It screams. ""Stop! Fool, you've destroyed me! You've destroyed "
	EQUAL? WON?,1 \?L43
	PRINTI "everything"
	JUMP ?L45
?L43:	EQUAL? WON?,3 \?L45
	PRINTI "magic itself"
?L45:	PRINTI "! All my lovely plans!"""
?L42:	PRINTI " Now glowing as brightly as the construction it made, the figure approaches the center. "
	EQUAL? WON?,3 \?L48
	PRINTI "It grows smaller and smaller, and just before it disappears, the hypercube vanishes with a pop, and "
	CALL THE-PRINT,MAGIC-CUBE
	PRINTI " melts in your hand like an ice cube."
	CRLF
	CRLF
	PRINTI "You find yourself back in Belwit Square, all the guildmasters and even Belboz crowding around you. ""A new age begins today,"" says Belboz after hearing your story. ""The age of magic is ended, as it must, for as magic can confer absolute power, so it can also produce absolute evil. We may defeat this evil when it appears, but if wizardry builds it anew, we can never ultimately win. The new world will be strange, but in time it will serve us better."""
	CRLF
	CALL PRINT-ID,STR?139
	SET 'SCORE,600
	CALL FINISH >STACK
	RSTACK
?L48:	CALL END-OF-WORLD,WON?
	CRLF
	SET 'SCORE,-99
	CALL FINISH >STACK
	RSTACK

	.FUNCT END-OF-WORLD,WON?
	EQUAL? WON?,2 \?L1
	PRINTI "It returns in fury, retrieves the "
	PRINTD MAGIC-CUBE
	PRINTI ", and resumes its quest. "
	CALL END-OF-WORLD,0
	RTRUE
?L1:	PRINTI "It dwindles in size and grows in brightness at the same time, until"
	EQUAL? WON?,1 \?L4
	PRINTI " it reaches the empty center. Then you, it and all the world blink out like a spent match."
	RTRUE
?L4:	PRINTI " you are almost blinded by a light so bright it fills the world. A voice like honey and ashes speaks in your mind. ""I am the All, I am the Will, I am the Power. The universe is Mine! Begone, insect!"" You and all you hold dear are abolished in an instant, and the reign of the shadow begins."
	CALL PRINT-ID,STR?140 >STACK
	RSTACK

	.FUNCT FREEZES-YOU,PREC?=0
	ZERO? PREC? /?L3
	ZERO? FROZEN? \FALSE
?L3:	SET 'FROZEN?,5
	CALL HELD?,MAGIC-CUBE >STACK
	ZERO? STACK /?L4
	CALL QUEUE,I-UNFREEZE,2
?L4:	ZERO? PREC? /?L7
	PRINTI """Now for a small precaution."""
	JUMP ?L9
?L7:	PRINTI "The shadow notices you. ""You force me to take precautions."""
?L9:	PRINTR " The shadow gestures, and you are frozen in place, unable to move even your littlest finger."

	.FUNCT STEAL-CUBES,CNT=0,N=0,CUBE
?L1:	MUL CNT,2 >STACK
	GET CUBE-LIST,STACK >CUBE
	MOVE CUBE,HERE
	FSET CUBE,NDESCBIT
	IGRTR? 'CNT,11 \?L1
	RETURN N

	.FUNCT SHADOW-ACQUIRES,OBJ
	CALL CTHE-PRINT,SHADOW
	ZERO? OBJ \?L1
	CALL STEAL-CUBES >STACK
	RSTACK
?L1:	CALL HELD?,OBJ,WINNER >STACK
	ZERO? STACK /?L4
	PRINTI " deftly takes "
	CALL THE-PRINT,OBJ
	PRINTI " from "
	IN? OBJ,WINNER \?L6
	PRINTI "you"
	JUMP ?L9
?L6:	LOC OBJ >STACK
	CALL THE-PRINT,STACK
	JUMP ?L9
?L4:	PRINTI " takes "
	CALL THE-PRINT,OBJ
?L9:	PRINTI " and"
	FSET OBJ,NDESCBIT
	MOVE OBJ,HERE
	RTRUE

	.FUNCT I-UNFREEZE
	DEC 'FROZEN?
	CALL QUEUE,I-UNFREEZE,1
	CRLF
	EQUAL? FROZEN?,4 \?L1
	PRINTI "Your little finger is full of pins and needles. You could move it if you wanted."
	CRLF
	CALL PRINT-ID,STR?141 >STACK
	RSTACK
?L1:	EQUAL? FROZEN?,3 \?L3
	PRINTI "Your feet and hands feel as if they've been asleep, but you can move them."
	CRLF
	CALL PRINT-ID,STR?142 >STACK
	RSTACK
?L3:	EQUAL? FROZEN?,2 \?L4
	PRINTI "Your arms and legs are free, but you still cannot speak or move your head."
	CRLF
	CALL PRINT-ID,STR?143 >STACK
	RSTACK
?L4:	EQUAL? FROZEN?,1 \?L5
	PRINTI "You feel almost thawed, but your mouth feels full of cotton."
	CRLF
	CALL PRINT-ID,STR?144 >STACK
	RSTACK
?L5:	ZERO? FROZEN? \FALSE
	CALL DEQUEUE,I-UNFREEZE
	SET 'FROZEN?,0
	PRINTI "The freeze has worn entirely off! Your contact with "
	CALL THE-PRINT,MAGIC-CUBE
	PRINTR " must have weakened it."

	.FUNCT I-TIRED,FORG=0
	CALL QUEUE,I-TIRED,8
	CALL HELD?,MAGIC-CUBE >STACK
	ZERO? STACK \TRUE
	GRTR? LOAD-ALLOWED,10 \?L4
	SUB LOAD-ALLOWED,10 >LOAD-ALLOWED
?L4:	GRTR? FUMBLE-NUMBER,1 \?L7
	DEC 'FUMBLE-NUMBER
?L7:	GRTR? SPELL-MAX,1 \?L15
	DEC 'SPELL-MAX
	GRTR? SPELL-ROOM,0 \?L12
	DEC 'SPELL-ROOM
?L12:	ZERO? SPELL-ROOM \?L15
	SET 'FORG,1
?L15:	IGRTR? 'AWAKE,8 \?L19
	PRINTI "You are so exhausted you can't stay awake any longer."
	CRLF
	CRLF
	CALL V-SLEEP,1
	RETURN 2
?L19:	PRINTI "You are "
	GET TIRED-TELL,AWAKE >STACK
	PRINT STACK
	ZERO? FORG /?L24
	PRINTI ", and the spells you've memorized are becoming confused"
?L24:	PRINT PERIOD
	RTRUE

	.FUNCT I-SNAVIG,OCHANGE
	ZERO? CHANGED? /FALSE
	SET 'OCHANGE,CHANGED?
	SET 'CHANGED?,0
	CRLF
	PRINTI "You have become yourself again."
	EQUAL? OCHANGE,GRUE \?L4
	CALL LIT?,HERE >LIT
	EQUAL? HERE,GRUE-CAVE \?L19
	PRINTI " You are immediately noticed by the startled grues. The one drawback of this essentially light-free environment is that it is also adventurer-free. The grues are overjoyed to find this deficiency remedied. You are probably less so."
	CALL PRINT-ID,STR?145
	CALL JIGS-UP
	RETURN 2
?L4:	EQUAL? OCHANGE,ROC \?L11
	FSET? HERE,RAIRBIT \?L19
	CALL START-FALLING
	PRINTR " You begin to fall."
?L11:	EQUAL? OCHANGE,GROUPER \?L19
	EQUAL? HERE,OCEAN-FLOOR \?L16
	CALL QUEUE,I-DROWN,3
	PRINTI " Fortunately your gills have stored some oxygen, but you are in danger of drowning."
?L16:	ZERO? ATE-AS-GROUPER? /?L19
	PRINTI " You have a horrible stomachache. It must have been something you ate."
	CALL PRINT-ID,STR?146
?L19:	CRLF
	RTRUE

	.FUNCT I-DROWN
	EQUAL? HERE,OCEAN-FLOOR \FALSE
	EQUAL? CHANGED?,GROUPER /FALSE
	CRLF
	CALL PRINT-ID,STR?147
	CALL JIGS-UP,STR?148 >STACK
	RSTACK

	.FUNCT I-GIRGOL,TF?
	ZERO? TIME-STOPPED? /FALSE
	CALL TIME-FROZEN? >TF?
	ZERO? TF? /?L3
	CRLF
	PRINTI "Time resumes its forward flight."
	CRLF
?L3:	SET 'TIME-STOPPED?,0
	ZERO? ROCK-FLAG /?L10
	SET 'ROCK-FLAG,0
	EQUAL? HERE,HUT-ROOM,MOUNTAIN-TOP,CAVE-ENTRANCE \?L7
	CRLF
	PRINTI "You hear a gigantic rush of sound as an avalanche tumbles down the mountain."
	CRLF
	JUMP ?L10
?L7:	EQUAL? HERE,BOULDER-1,BOULDER-2,BOULDER-3 \?L9
	CRLF
	CALL PRINT-ID,STR?149
	CALL JIGS-UP,STR?150
	JUMP ?L10
?L9:	EQUAL? TF?,CLIFF-TOP,CLIFF-MIDDLE,CLIFF-BOTTOM \?L10
	CALL QUEUE,I-AVALANCHE,-1
	CRLF
	PRINTI "Tons of rock and dirt continue their downward plunge."
	CRLF
?L10:	EQUAL? TF?,OGRE-BEDROOM,OGRE-CAVE \?L13
	EQUAL? HERE,OGRE-BEDROOM,OGRE-CAVE \?L13
	CALL I-OGRE-KILLS-YOU,1
?L13:	EQUAL? TF?,PAST-RUINS-ROOM \?L16
	EQUAL? HERE,PAST-RUINS-ROOM \?L16
	CALL QUEUE,I-WATER-RISING,3
	CRLF
	PRINTI "The water begins to rise again."
	CRLF
?L16:	EQUAL? TF?,CASTLE \FALSE
	EQUAL? HERE,CASTLE \FALSE
	EQUAL? SHADOW-COUNT,8 \TRUE
	CRLF
	PRINTR """Fool!"" chortles the shadow."

	.FUNCT I-OGRE-KILLS-YOU,GIRGOL?=0
	CALL TIME-FROZEN? >STACK
	ZERO? STACK \?L3
	ZERO? SNEEZY? \?L3
	EQUAL? ESPNIS?,OGRE \?L1
?L3:	CALL QUEUE,I-OGRE-KILLS-YOU,2
	RFALSE
?L1:	EQUAL? HERE,OGRE-CAVE,OGRE-BEDROOM \FALSE
	IN? PLAYER,ZIPPER \?L7
	SET 'OGRE-MURDEROUS?,1
	RTRUE
?L7:	ZERO? GIRGOL? \?L10
	CRLF
?L10:	PRINTI "The ogre, impatient with your presence and your impudent intrusion, "
	EQUAL? HERE,OGRE-BEDROOM \?L13
	PRINTI "charges in and "
?L13:	PRINTI "tramples you to a pulp."
	CALL PRINT-ID,STR?151
	CALL JIGS-UP >STACK
	RSTACK

	.FUNCT I-ESPNIS
	CALL TIME-FROZEN? >STACK
	ZERO? STACK /?L1
	CALL QUEUE,I-ESPNIS,2
	JUMP ?L3
?L1:	ZERO? ESPNIS? /FALSE
?L3:	IN? ESPNIS?,HERE \?L9
	CRLF
	CALL CTHE-PRINT,ESPNIS?
	PRINTI " awakes, looking sheepish."
	EQUAL? ESPNIS?,OGRE \?L7
	ZERO? SNEEZY? \?L7
	CALL OGRE-MAD
	JUMP ?L9
?L7:	CRLF
?L9:	SET 'ESPNIS?,0
	RETURN ESPNIS?

	.FUNCT I-LISKON,NOCR?=0,SF
	ZERO? SHRINK-FLAG /FALSE
	SET 'SF,SHRINK-FLAG
	SET 'SHRINK-FLAG,0
	EQUAL? SF,PLAYER /?L4
	FSET? WEED,RMUNGBIT \?L6
	EQUAL? SF,WEED \?L6
	PUTP WEED,P?SIZE,200
?L6:	CALL VISIBLE?,SF >STACK
	ZERO? STACK /FALSE
	ZERO? NOCR? \?L11
	CRLF
?L11:	EQUAL? SF,SNAKE \?L14
	PRINTR "The serpent slowly and jerkily returns to its former size, swallowing its tail again in the process."
?L14:	PRINTI "With a rather unsettling lack of uniformity, "
	CALL THE-PRINT,SF
	PRINTI " returns to its former size."
	EQUAL? SF,WEED \?L22
	FSET? WEED,RMUNGBIT \?L22
	IN? SF,WINNER \?L19
	MOVE SF,HERE
	PRINTR " It's too heavy to carry."
?L19:	LOC SF >STACK
	EQUAL? STACK,BOTTLE \?L21
	CALL META-LOC,BOTTLE >STACK
	MOVE SF,STACK
	REMOVE BOTTLE
	PRINTR " It bursts the bottle!"
?L21:	LOC SF >STACK
	EQUAL? STACK,MAGIC-CARPET,RANDOM-CARPET \?L22
	CALL META-LOC,SF >STACK
	MOVE SF,STACK
?L22:	CRLF
	RTRUE
?L4:	SET 'SMALL-FLAG,0
	ZERO? NOCR? \?L27
	CRLF
?L27:	PRINTI "You feel stretched, wrung out, and pulled in all directions. You are growing."
	CRLF
	CALL PRINT-ID,STR?152
	LOC PLAYER >STACK
	EQUAL? STACK,CABINET,PAST-CABINET \?L30
	CALL TOO-LARGE,CABINET >STACK
	RSTACK
?L30:	IN? PLAYER,ZIPPER /FALSE
	EQUAL? HERE,IN-PIPE,IN-PIPE-2,IN-SEWER \?L33
	CALL TOO-LARGE,WATER-PIPE
	RETURN 2
?L33:	EQUAL? HERE,IN-CHANNEL \?L36
	CRLF
	CALL GOTO,OUBLIETTE >STACK
	RSTACK
?L36:	EQUAL? HERE,RUINED-PIPE \FALSE
	CRLF
	CALL GOTO,RUINS-ROOM >STACK
	RSTACK

	.FUNCT TOO-LARGE,OBJ
	PRINTI "Unfortunately, you are rather too large for "
	CALL THE-PRINT,OBJ
	PRINTI " you are in, and are crushed by its sides as you try to resume your full size."
	CRLF
	CALL PRINT-ID,STR?153
	CALL JIGS-UP >STACK
	RSTACK

	.FUNCT I-SNAKE
	EQUAL? HERE,NORTH-SNAKE-ROOM,SOUTH-SNAKE-ROOM \FALSE
	CRLF
	PRINTR "The scaly wall begins to move, undulating back and forth in the confined space. A musty odor permeates the air, and you hear scales scraping on stone. Finally, an enormous head slides into view from the east and stops with one monstrous eye staring coldly at you. You notice something unusual about the huge serpent: the tail, which trails out of the western hole, disappears into the gaping maw of the creature. You realize that the monster must be huge enough to make a complete loop!"

	.FUNCT I-UNMALYON-IDOL
	CALL DEQUEUE,I-IDOL
	CALL DEQUEUE,I-FULL-YAWN
	CALL DEQUEUE,I-IDOL-ASLEEP
	FCLEAR IDOL,PERSON
	EQUAL? HERE,TEMPLE-ROOM \FALSE
	CRLF
	PRINTI "The idol turns back into basalt."
	ZERO? IDOL-ASLEEP? /?L3
	PRINTR " It is curled up comfortably asleep."
?L3:	ZERO? IDOL-YAWNING? /?L5
	PRINTI " It has been caught in a cheek-stretching yawn."
?L5:	CRLF
	RTRUE

	.FUNCT I-IDOL
	CALL QUEUE,I-IDOL,-1
	EQUAL? HERE,TEMPLE-ROOM \FALSE
	CRLF
	PRINTI "The idol is "
	ZERO? IDOL-SLEEPED? /?L3
	PRINTR "looking sleepy and tired."
?L3:	CALL TELL-IDOL-ACTION
	PRINTR " around the room, searching for something. No doubt it's you! It looks a little stiff, but for former basalt, it's pretty supple."

	.FUNCT TELL-IDOL-ACTION
	IN? OPAL,IDOL \?L1
	PRINTI "looking"
	RTRUE
?L1:	PRINTI "groping"
	RTRUE

	.FUNCT I-FULL-YAWN
	CALL DEQUEUE,I-IDOL
	SET 'IDOL-ASLEEP?,0
	FSET MOUTH,OPENBIT
	SET 'IDOL-YAWNING?,1
	EQUAL? HERE,TEMPLE-ROOM \FALSE
	CRLF
	PRINTR "The idol is yawning sleepily, its mouth gaping open."

	.FUNCT I-IDOL-ASLEEP
	SET 'IDOL-YAWNING?,0
	FCLEAR MOUTH,OPENBIT
	SET 'IDOL-ASLEEP?,1
	EQUAL? HERE,TEMPLE-ROOM \FALSE
	CRLF
	PRINTR "The idol curls up comfortably and falls asleep on the floor."

	.FUNCT I-OPAL-SMASHES
	IN? OPAL,IDOL \FALSE
	ZERO? OPAL-LOOSE? /FALSE
	REMOVE OPAL
	SET 'OPAL-LOOSE?,0
	MOVE OPAL-SHARD,HERE
	EQUAL? HERE,TEMPLE-ROOM \FALSE
	PRINTI "The opal totters one last time and falls. You "
	IN? PLAYER,IDOL \?L5
	PRINTI "grab for it frantically"
	JUMP ?L7
?L5:	PRINTI "try to catch it"
?L7:	PRINTI ", but it escapes your grip and smashes into a million pieces on the idol's foot."
	CRLF
	CALL PRINT-ID,STR?154 >STACK
	RSTACK

	.FUNCT I-AVALANCHE?
	EQUAL? HERE,CLIFF-TOP \FALSE
	EQUAL? TIME-STOPPED?,HERE /FALSE
	RANDOM 100 >STACK
	LESS? SLIDE-PROB,STACK /?L4
	SET 'ROCK-SLIDE-COUNT,0
	CALL DEQUEUE,I-AVALANCHE?
	CALL QUEUE,I-AVALANCHE,-1
	CRLF
	PRINTI "Something you've done has disturbed the rocks above! Dirt and small stones are trickling down. "
	PRINT IT-LOOKS-LIKE
	PRINTI "the whole dike is about to give way!"
	CRLF
	CALL PRINT-ID,STR?155 >STACK
	RSTACK
?L4:	ADD SLIDE-PROB,10 >SLIDE-PROB
	RETURN SLIDE-PROB

	.FUNCT HEAR-AVALANCHE
	PRINTI "You hear the tremendous sliding, deep-voiced roar of thousands of tons of rock tumbling down the mountain"
	RTRUE

	.FUNCT I-AVALANCHE
	ZERO? TIME-STOPPED? \FALSE
	GRTR? ROCK-SLIDE-COUNT,3 \?L3
	SET 'ROCK-SLIDE-COUNT,0
	CALL DEQUEUE,I-AVALANCHE
	RFALSE
?L3:	INC 'ROCK-SLIDE-COUNT
	EQUAL? HERE,CAVE-ENTRANCE,MOUNTAIN-TOP \?L5
	CRLF
	CALL HEAR-AVALANCHE
	EQUAL? HERE,CAVE-ENTRANCE \?L7
	PRINTI " to your east"
?L7:	PRINT PERIOD
	RTRUE
?L5:	EQUAL? HERE,CLIFF-TOP,CLIFF-MIDDLE,CLIFF-BOTTOM \FALSE
	CRLF
	EQUAL? ROCK-SLIDE-COUNT,1 \?L11
	PRINTR "Huge rocks and boulders are tumbling down, making an almost continuous curtain above you. If you don't do something soon, you will die!"
?L11:	EQUAL? HERE,CLIFF-TOP \?L15
	GRTR? ROCK-SLIDE-COUNT,1 /?L14
?L15:	EQUAL? HERE,CLIFF-MIDDLE \?L16
	GRTR? ROCK-SLIDE-COUNT,2 /?L14
?L16:	EQUAL? HERE,CLIFF-BOTTOM \?L13
	GRTR? ROCK-SLIDE-COUNT,3 \?L13
?L14:	CALL DEQUEUE,I-AVALANCHE
	SET 'ROCK-SLIDE-COUNT,0
	IN? PLAYER,ZIPPER \?L17
	PRINTI "Although you can't see or feel it, y"
	JUMP ?L19
?L17:	PRINTI "Y"
?L19:	CALL PRINT-ID,STR?156
	CALL JIGS-UP,STR?157 >STACK
	RSTACK
?L13:	EQUAL? HERE,CLIFF-TOP,CLIFF-MIDDLE,CLIFF-BOTTOM \FALSE
	CALL ROCKS-TUMBLING >STACK
	RSTACK

	.FUNCT ROCKS-TUMBLING
	PRINTR "Thousands of tons of rock are tumbling down the mountainside!"

	.FUNCT I-OGRE
	EQUAL? TIME-STOPPED?,OGRE-CAVE /FALSE
	EQUAL? HERE,CAVE-ENTRANCE,OGRE-BEDROOM \?L3
	EQUAL? ESPNIS?,OGRE \?L4
	CRLF
	CALL OGRE-NOISES >STACK
	RSTACK
?L4:	ZERO? SNEEZY? /?L6
	CRLF
	PRINTR "You hear explosive sneezing from the cave."
?L6:	RANDOM 100 >STACK
	LESS? 50,STACK /FALSE
	CRLF
	CALL OGRE-NOISES >STACK
	RSTACK
?L3:	EQUAL? HERE,OGRE-CAVE \?L9
	EQUAL? ESPNIS?,OGRE \?L10
	CRLF
	PRINTR "The ogre snores loudly."
?L10:	ZERO? SNEEZY? /?L12
	CRLF
	PRINTR "The ogre doubles over in a spectacular paroxysm of sneezing."
?L12:	RANDOM 100 >STACK
	LESS? 50,STACK /FALSE
	CRLF
	PRINTR "The ogre sneezes."
?L9:	CALL DEQUEUE,I-OGRE
	RFALSE

	.FUNCT OGRE-NOISES
	CALL TIME-FROZEN? >STACK
	ZERO? STACK \FALSE
	PRINTI "You hear a noise from within the cave that sounds like "
	EQUAL? ESPNIS?,OGRE \?L3
	PRINTI "snoring"
	JUMP ?L5
?L3:	PRINTI "a sneeze"
?L5:	PRINT PERIOD
	RTRUE

	.FUNCT I-FLOTSAM
	CALL SINK-STUFF,OCEAN-ROOM
	CALL SINK-STUFF,LOST-IN-OCEAN >STACK
	RSTACK

	.FUNCT SINK-STUFF,RM,F,N
	FIRST? RM >F /?L4
	RTRUE
?L1:	ZERO? F /TRUE
?L4:	NEXT? F >N /?L7
?L7:	EQUAL? F,PLAYER,GROUPER /?L16
	EQUAL? F,WATER-CUBE \?L10
	CALL QUEUED?,I-CUBE-SINKS >STACK
	ZERO? STACK \?L16
?L10:	EQUAL? F,ZIPPER /?L12
	FSET? F,CONTBIT \?L12
	FSET? F,OPENBIT \?L11
	RANDOM 100 >STACK
	LESS? 75,STACK /?L11
?L12:	MOVE F,OCEAN-FLOOR
	FCLEAR F,NDESCBIT
	EQUAL? HERE,RM \?L16
	CALL CTHE-PRINT,F
	PRINTI " sinks beneath the waves."
	CRLF
	JUMP ?L16
?L11:	CALL QUEUE,I-FLOTSAM,2
?L16:	SET 'F,N
	JUMP ?L1

	.FUNCT I-GROUPER,SNACK=0
	IN? FISH,OCEAN-ROOM \?L1
	SET 'SNACK,FISH
	JUMP ?L5
?L1:	IN? BREAD,OCEAN-ROOM \?L3
	SET 'SNACK,BREAD
	JUMP ?L5
?L3:	IN? WATER-CUBE,OCEAN-ROOM \?L4
	SET 'SNACK,WATER-CUBE
	JUMP ?L5
?L4:	IN? BOTTLE,OCEAN-ROOM \?L5
	SET 'SNACK,BOTTLE
?L5:	ZERO? SNACK /FALSE
	MOVE SNACK,GROUPER
	CALL QUEUE,I-GROUPER-IN-NEST,2
	EQUAL? HERE,OCEAN-ROOM \FALSE
	CRLF
	PRINTI "The grouper, nosing around for something tasty, swallows "
	CALL THE-PRINT,SNACK
	PRINTR " and starts to swim downward, temporarily sated."

	.FUNCT I-CUBE-SINKS
	IN? WATER-CUBE,OCEAN-ROOM \FALSE
	MOVE WATER-CUBE,OCEAN-FLOOR
	FCLEAR WATER-CUBE,NDESCBIT
	EQUAL? HERE,OCEAN-ROOM \FALSE
	CRLF
	CALL CTHE-PRINT,WATER-CUBE
	PRINTR " sinks out of sight."

	.FUNCT I-GROUPER-IN-NEST
	MOVE GROUPER,OCEAN-FLOOR
	EQUAL? HERE,OCEAN-ROOM \?L1
	PRINTR "The grouper swims down out of sight."
?L1:	EQUAL? HERE,OCEAN-FLOOR \FALSE
	PRINTR "The grouper approaches, its goggle eyes staring curiously."

	.FUNCT I-TINSOT
	SET 'ICED-OBJECT,0
	CALL QUEUED?,I-OUBLIETTE-EMPTIES >STACK
	ZERO? STACK \FALSE
	SET 'FREEZE-FLAG,0
	RFALSE

	.FUNCT I-OUBLIETTE-FILLS,H=0
	EQUAL? HERE,OUBLIETTE \?L1
	SET 'H,1
?L1:	LESS? WATER-FLAG,3 \?L4
	CALL ROB,OUBLIETTE,0,ICEBERG
	INC 'WATER-FLAG
	ZERO? H /FALSE
	CRLF
	PRINTI "The water level rises. The oubliette is "
	GET WATER-HEIGHTS,WATER-FLAG >STACK
	PRINT STACK
	PRINTI " full."
	IN? PLAYER,ICEBERG /?L8
	CALL SOAK-PLAYER
?L8:	CALL NOT-SITTING
	CRLF
	RTRUE
?L4:	SET 'WATER-FLAG,4
	CALL DEQUEUE,I-OUBLIETTE-FILLS
	CALL QUEUE,I-OUBLIETTE-EMPTIES,5
	ZERO? H /FALSE
	CRLF
	PRINTI "The oubliette is full. There is about four feet of space between the water and the roof. The water must have reached its level, because it has ceased to rise. You are "
	IN? PLAYER,ICEBERG \?L15
	PRINTR "floating serenely on a small ice floe."
?L15:	PRINTR "splashing a tantalizing distance from the roof and trap door."

	.FUNCT I-OUBLIETTE-EMPTIES,H=0
	EQUAL? HERE,OUBLIETTE \?L1
	SET 'H,1
?L1:	EQUAL? WATER-FLAG,4 \?L4
	GRTR? FREEZE-FLAG,0 \?L4
	SET 'FREEZE-FLAG,0
	CALL QUEUE,I-OUBLIETTE-EMPTIES,-1
	ZERO? H /FALSE
	CRLF
	PRINTR "The water level has begun to fall."
?L4:	DEC 'WATER-FLAG
	GRTR? WATER-FLAG,0 \?L10
	ZERO? H /FALSE
	CRLF
	PRINTI "The water level falls. The oubliette is "
	GET WATER-HEIGHTS,WATER-FLAG >STACK
	PRINT STACK
	PRINTR " full."
?L10:	CALL DEQUEUE,I-OUBLIETTE-EMPTIES
	IN? PLAYER,ICEBERG \?L16
	MOVE WINNER,HERE
?L16:	CALL ROB,ICEBERG,HERE
	REMOVE ICEBERG
	SET 'ICED-OBJECT,0
	ZERO? H /FALSE
	CRLF
	PRINTR "The oubliette is empty again. All the ice has melted, and the pipes are open again."

	.FUNCT I-DOWNSTREAM,RM=0
	EQUAL? HERE,IN-CHANNEL \?L1
	SET 'RM,IN-PIPE
	JUMP ?L5
?L1:	EQUAL? HERE,IN-PIPE \?L3
	SET 'RM,IN-PIPE-2
	JUMP ?L5
?L3:	EQUAL? HERE,IN-PIPE-2 \?L4
	SET 'RM,RUINED-PIPE
	JUMP ?L5
?L4:	EQUAL? HERE,RUINED-PIPE \?L5
	SET 'RM,IN-SEWER
?L5:	ZERO? RM /FALSE
	CRLF
	PRINTI "The rushing water is forcing you downstream."
	CRLF
	CRLF
	CALL GOTO,RM >STACK
	RSTACK

	.FUNCT I-ROC
	EQUAL? HERE,GUARD-TOWER \FALSE
	INC 'ROC-COUNT
	IN? PLAYER,ZIPPER /FALSE
	GRTR? ROC-COUNT,4 \?L5
	CALL DEQUEUE,I-ROC
	CALL ROC-GRABS-PLAYER
	CRLF
	CALL GOTO,MIDAIR >STACK
	RSTACK
?L5:	GRTR? ROC-COUNT,0 \FALSE
	CALL THIS-IS-IT,ROC
	CRLF
	PRINTI "There is a "
	CALL DESCRIBE-ROC >STACK
	RSTACK

	.FUNCT I-ROC-FLY
	INC 'ROC-FLY-COUNT
	DEC 'EW-COUNT
	CRLF
	EQUAL? ROC-FLY-COUNT,1 \?L1
	SET 'UD-COUNT,4
	PRINTR "The roc gains height and heads west towards the distant Flathead Mountains."
?L1:	EQUAL? ROC-FLY-COUNT,2 \?L3
	PRINTR "The roc continues to fly west towards the mountains."
?L3:	EQUAL? ROC-FLY-COUNT,3 \?L4
	PRINTR "You are rapidly approaching a rocky eyrie containing an enormous nest."
?L4:	EQUAL? ROC-FLY-COUNT,4 \FALSE
	SET 'UD-COUNT,0
	CALL DEQUEUE,I-ROC-FLY
	MOVE PLAYER,HERE
	MOVE ROC,ROC-NEST
	PRINTI "The roc circles over its nest, settles to the ground, and releases you."
	CRLF
	CRLF
	CALL GOTO,ROC-NEST >STACK
	RSTACK

	.FUNCT I-ROC-HATCHES,ARG=0
	EQUAL? TIME-STOPPED?,HERE \?L1
	CALL QUEUE,I-ROC-HATCHES,5
	RFALSE
?L1:	IN? BABY-ROC,HERE /FALSE
	MOVE BABY-ROC,ROC-NEST
	FSET EGG,RMUNGBIT
	EQUAL? HERE,ROC-NEST \FALSE
	CALL QUEUE,I-YUM-YUM,-1
	IN? PLAYER,ZIPPER /FALSE
	ZERO? ARG \?L9
	CRLF
	JUMP ?L10
?L9:	PRINTI "You batter the egg, intending to destroy it. "
?L10:	PRINTI "Suddenly the egg begins to crack. You can see feathers, then a large, almost reptilian eye. The egg shatters, and a small (wagon-sized) roc chick rolls out. It eyes you hungrily"
	IN? CONNECTIVITY-CUBE,ROC-NEST \?L11
	REMOVE CONNECTIVITY-CUBE
	PRINTI ", notices the cube at its feet, and gobbles it greedily. It still looks hungry"
?L11:	PRINT PERIOD
	RTRUE

	.FUNCT I-YUM-YUM
	EQUAL? HERE,ROC-NEST \?L1
	IN? PLAYER,ZIPPER /FALSE
	EQUAL? ESPNIS?,BABY-ROC /FALSE
	IN? CONNECTIVITY-CUBE,PLAYER \?L5
	MOVE CONNECTIVITY-CUBE,HERE
?L5:	CALL DEQUEUE,I-YUM-YUM
	CALL PRINT-ID,STR?158
	CALL JIGS-UP,STR?159 >STACK
	RSTACK
?L1:	CALL DEQUEUE,I-YUM-YUM
	RFALSE

	.FUNCT I-MERCHANT
	FSET? MERCHANT,TOUCHBIT /?L1
	FSET MERCHANT,TOUCHBIT
	MOVE MAGIC-CARPET,MERCHANT
	MOVE RANDOM-CARPET,MERCHANT
	CRLF
	PRINTI "The merchant approaches you. ""May I help you? We have a fine selection of carpets of all sizes and uses."" He indicates the pile of rugs and picks up two of them. ""These are particularly nice,"" he says. One is "
	CALL PRINTA,MAGIC-CARPET
	PRINTI " with a strange design of cubes, and the other is "
	CALL PRINTA,RANDOM-CARPET
	PRINTR " that's rather shabby and badly made."
?L1:	ZERO? MERCHANT-FLAG /?L3
	SET 'MERCHANT-FLAG,0
	RFALSE
?L3:	IN? MAGIC-CARPET,PLAYER /?L5
	IN? RANDOM-CARPET,PLAYER \?L4
?L5:	PRINTR "The merchant is patiently waiting for you to leave."
?L4:	CRLF
	PRINTR "The merchant tries to look bored. He doesn't pull it off."

	.FUNCT I-FALLING
	EQUAL? TIME-STOPPED?,HERE /FALSE
	EQUAL? HERE,MIDAIR,LOST-IN-CLOUDS /?L3
	SET 'FALLING?,0
	SET 'SMASH-PROB,0
	CALL DEQUEUE,I-FALLING
	RFALSE
?L3:	GRTR? UD-COUNT,1 \?L5
	DEC 'UD-COUNT
	ADD ROC-PROB,25 >ROC-PROB
	LOC PLAYER >STACK
	FSET? STACK,VEHBIT /?L11
	EQUAL? OHERE,EARTH-ROOM,AIR-ROOM \?L11
	RANDOM 100 >STACK
	LESS? ROC-PROB,STACK /?L11
	SET 'FALLING?,0
	CALL ROC-GRABS-PLAYER,1
	RTRUE
?L5:	ADD SMASH-PROB,20 >SMASH-PROB
	RANDOM 100 >STACK
	LESS? SMASH-PROB,STACK /?L11
	SET 'FALLING?,0
	CRLF
	PRINTI "You tumble helplessly into the earth, and the results are, of course, fatal."
	CALL PRINT-ID,STR?160
	CALL PRINT-ID,STR?161
	CALL JIGS-UP
	RETURN 2
?L11:	CRLF
	PRINTR "You are falling towards the ground, wind whipping around you."

	.FUNCT I-ROCK-ARRIVES
	MOVE LAVA-ROCK,VOLCANO-BASE
	EQUAL? HERE,VOLCANO-BASE \FALSE
	CRLF
	PRINTR "One fragment of molten lava explodes out of the flow and drops right at your feet! It sizzles and hisses."

	.FUNCT I-GRUES-NOTICE,CR?=0
	EQUAL? HERE,GRUE-CAVE \?L1
	ZERO? LIT \?L3
	ZERO? CR? \?L5
	CRLF
?L5:	CALL PRINT-ID,STR?162
	CALL JIGS-UP,STR?163 >STACK
	RSTACK
?L3:	EQUAL? CHANGED?,GRUE \?L9
	EQUAL? LIT,GRUE /FALSE
?L9:	CALL GRUES-NOTICE-LIGHT >STACK
	RSTACK
?L1:	EQUAL? HERE,PILLAR-ROOM,LIGHT-POOL \FALSE
	ZERO? LIT \?L12
	ZERO? CR? \?L14
	CRLF
?L14:	PRINTI "Scrabbling and scratching claws are nearby."
	RTRUE
?L12:	EQUAL? CHANGED?,GRUE \?L18
	EQUAL? LIT,GRUE /FALSE
?L18:	PRINTR "The grues have noticed you, and are terrifically agitated."

	.FUNCT GRUES-NOTICE-LIGHT
	PRINTI "The shapes are coming closer. They have noticed "
	CALL TELL-LIGHT-SOURCE
	PRINT PERIOD
	PRINTI "They approach you warily, avoiding the tiny drips of light. They grab you, overwhelm you, and "
	EQUAL? CHANGED?,GRUE \?L1
	PRINTI "as in addition to their other nasty habits, grues are cannibalistic, they "
?L1:	PRINTI "devour you, grunting, gurgling, and snapping at each other as they fight over the best parts."
	CALL PRINT-ID,STR?164
	CALL JIGS-UP >STACK
	RSTACK

	.FUNCT I-FRIED-GRUE
	EQUAL? HERE,LIGHT-POOL \?L1
	EQUAL? CHANGED?,GRUE \?L1
	CALL PRINT-ID,STR?165
	CALL JIGS-UP,STR?166 >STACK
	RSTACK
?L1:	CALL QUEUE,I-FRIED-GRUE,-1
	RFALSE

	.FUNCT I-ALARM
	IN? ALARM-FAIRY,SCALES-ROOM /?L3
	MOVE ALARM-FAIRY,SCALES-ROOM
	EQUAL? HERE,SCALES-ROOM \FALSE
	CRLF
	PRINTI "Suddenly an alarm fairy appears in the Treasury. It carries a big gong which it begins to pound incessantly, and it yells at the top of its lungs."
	CRLF
?L3:	EQUAL? HERE,SCALES-ROOM \FALSE
	CRLF
	PRINTR """There's a thief here! Hey, guards! Thief! Nasty thieving thief's here! Come capture the thief!"" The din is tremendous."

	.FUNCT I-GUARDS
	INC 'GUARDS-FLAG
	EQUAL? GUARDS-FLAG,1 \?L1
	CALL QUEUE,I-GUARDS,1
	EQUAL? HERE,SCALES-ROOM \FALSE
	FSET? IRON-DOOR,OPENBIT \?L5
	CRLF
	PRINTR "Five burly guards, unshaven and thuggish, stand outside the door. It is clear their intention is to come in."
?L5:	CRLF
	PRINTR "You can hear a key being inserted in the lock from outside. The alarm fairy thumbs its nose at you derisively."
?L1:	SET 'TREASURY-GUARDED?,1
	EQUAL? HERE,SCALES-ROOM,INNER-VAULT \FALSE
	CRLF
	PRINTI "All at once "
	FSET? IRON-DOOR,OPENBIT /?L12
	PRINTI "the door bursts in and "
?L12:	FCLEAR IRON-DOOR,OPENBIT
	PRINTI "five burly guards crowd into the Treasury. They look at you with extreme disapproval, tinged with a certain sadistic anticipation of what is to come. The alarm fairy twitters about near the ceiling, jeering at you. ""Told you so, nyaah, nyaah!"" it chants. In the interest of taste, we will gloss over what happens next, but at the end of it you are dead."
	CALL JIGS-UP >STACK
	RSTACK

	.FUNCT I-OTHER-ROCK,DIR,RROW,RCOL,OROW,OCOL,DROW=0,DCOL=0
	EQUAL? ROCK-LOC,OTHER-ROCK-LOC \?L1
	SET 'ROCK-MOVED?,0
	CALL DEQUEUE,I-OTHER-ROCK
	CALL CTHE-PRINT,OTHER-ROCK
	PRINTI ", mesmerized by the looming presence of "
	CALL THE-PRINT,ROCK
	PRINTR ", does not move."
?L1:	ZERO? ROCK-MOVED? /FALSE
	SET 'ROCK-MOVED?,0
	DIV ROCK-LOC,4 >RROW
	BAND ROCK-LOC,3 >RCOL
	DIV OTHER-ROCK-LOC,4 >OROW
	BAND OTHER-ROCK-LOC,3 >OCOL
	GRTR? RROW,OROW \?L4
	SUB RROW,OROW >DROW
	JUMP ?L6
?L4:	SUB OROW,RROW >DROW
?L6:	GRTR? RCOL,OCOL \?L7
	SUB RCOL,OCOL >DCOL
	JUMP ?L9
?L7:	SUB OCOL,RCOL >DCOL
?L9:	CRLF
	EQUAL? OTHER-ROCK-LOC,1 \?L10
	EQUAL? ROCK-LOC,4,5,8 /?L12
	ADD DROW,DCOL >STACK
	BTST STACK,1 /?L12
	SET 'DIR,P?SW
	JUMP ?L58
?L12:	EQUAL? ROCK-LOC,5 /?L14
	SET 'DIR,P?SOUTH
	JUMP ?L58
?L14:	EQUAL? ROCK-LOC,2 /?L58
	SET 'DIR,P?EAST
	JUMP ?L58
?L10:	EQUAL? OTHER-ROCK-LOC,4 \?L17
	EQUAL? ROCK-LOC,1,2,5 /?L18
	ADD DROW,DCOL >STACK
	BTST STACK,1 /?L18
	SET 'DIR,P?NE
	JUMP ?L58
?L18:	EQUAL? ROCK-LOC,5 /?L20
	SET 'DIR,P?EAST
	JUMP ?L58
?L20:	EQUAL? ROCK-LOC,8 /?L58
	SET 'DIR,P?SOUTH
	JUMP ?L58
?L17:	EQUAL? OTHER-ROCK-LOC,5 \?L23
	EQUAL? ROCK-LOC,1,4 \?L23
	EQUAL? ROCK-LOC,4 \?L24
	SET 'DIR,P?EAST
	JUMP ?L58
?L24:	SET 'DIR,P?SOUTH
	JUMP ?L58
?L23:	EQUAL? RROW,OROW \?L27
	ZERO? OROW /?L30
	EQUAL? OROW,1 \?L28
	ZERO? OCOL \?L28
?L30:	SET 'DIR,P?SOUTH
	JUMP ?L58
?L28:	EQUAL? OROW,3 /?L32
	RANDOM 100 >STACK
	LESS? 50,STACK /?L31
?L32:	SET 'DIR,P?NORTH
	JUMP ?L58
?L31:	SET 'DIR,P?SOUTH
	JUMP ?L58
?L27:	EQUAL? RCOL,OCOL \?L34
	ZERO? OCOL /?L37
	EQUAL? OCOL,1 \?L35
	ZERO? OROW \?L35
?L37:	SET 'DIR,P?EAST
	JUMP ?L58
?L35:	EQUAL? OCOL,3 /?L39
	RANDOM 100 >STACK
	LESS? 50,STACK /?L38
?L39:	SET 'DIR,P?WEST
	JUMP ?L58
?L38:	SET 'DIR,P?EAST
	JUMP ?L58
?L34:	ZERO? OCOL \?L41
	EQUAL? OROW,3 \?L41
	RANDOM 100 >STACK
	LESS? 50,STACK /?L42
	SET 'DIR,P?EAST
	JUMP ?L58
?L42:	SET 'DIR,P?NORTH
	JUMP ?L58
?L41:	EQUAL? OCOL,3 \?L49
	EQUAL? OROW,3 \?L45
	RANDOM 100 >STACK
	LESS? 50,STACK /?L46
	SET 'DIR,P?WEST
	JUMP ?L58
?L46:	SET 'DIR,P?NORTH
	JUMP ?L58
?L45:	EQUAL? OCOL,3 \?L49
	ZERO? OROW \?L49
	RANDOM 100 >STACK
	LESS? 50,STACK /?L50
	SET 'DIR,P?WEST
	JUMP ?L58
?L50:	SET 'DIR,P?SOUTH
	JUMP ?L58
?L49:	GRTR? RROW,OROW \?L53
	GRTR? OROW,0 \?L53
	GRTR? OROW,1 /?L54
	GRTR? OCOL,0 \?L53
?L54:	SET 'DIR,P?NORTH
	JUMP ?L58
?L53:	GRTR? RCOL,OCOL \?L55
	GRTR? OCOL,0 \?L55
	GRTR? OCOL,1 /?L56
	GRTR? OROW,0 \?L55
?L56:	SET 'DIR,P?WEST
	JUMP ?L58
?L55:	LESS? RROW,OROW \?L57
	LESS? OROW,3 \?L57
	SET 'DIR,P?SOUTH
	JUMP ?L58
?L57:	LESS? RCOL,OCOL \?L58
	LESS? OCOL,3 \?L58
	SET 'DIR,P?EAST
?L58:	EQUAL? DIR,P?EAST \?L60
	INC 'OCOL
	JUMP ?L66
?L60:	EQUAL? DIR,P?WEST \?L62
	DEC 'OCOL
	JUMP ?L66
?L62:	EQUAL? DIR,P?SOUTH \?L63
	INC 'OROW
	JUMP ?L66
?L63:	EQUAL? DIR,P?NORTH \?L64
	DEC 'OROW
	JUMP ?L66
?L64:	EQUAL? DIR,P?NE \?L65
	DEC 'OROW
	INC 'OCOL
	JUMP ?L66
?L65:	INC 'OROW
	DEC 'OCOL
?L66:	MUL 4,OROW >STACK
	ADD STACK,OCOL >OTHER-ROCK-LOC
	IN? PLAYER,OTHER-ROCK \?L67
	SET 'YOU-LOC,OTHER-ROCK-LOC
?L67:	CALL CTHE-PRINT,OTHER-ROCK
	PRINTI " slides gracefully "
	CALL DIR-BASE,DIR,DIR-DIR,DIR-NAME >DIR
	ZERO? DIR /?L70
	PRINT DIR
?L70:	PRINT PERIOD
	RTRUE

	.FUNCT I-STOP-SNEEZING
	SET 'SNEEZY?,0
	EQUAL? HERE,OGRE-CAVE \?L1
	EQUAL? TIME-STOPPED?,HERE /?L1
	EQUAL? ESPNIS?,OGRE /?L1
	CRLF
	PRINTI "The pollen has settled out, and the ogre's sneezes abate."
	CALL OGRE-MAD >STACK
	RSTACK
?L1:	EQUAL? HERE,CAVE-ENTRANCE,OGRE-BEDROOM \FALSE
	CRLF
	PRINTR "The sneezing noises have slowed in volume and frequency."

	.FUNCT OGRE-MAD
	PRINTI " He recovers his self-possession."
	CRLF
	CALL I-OGRE-KILLS-YOU >STACK
	RSTACK

	.FUNCT I-WATER-RISING
	EQUAL? HERE,PAST-RUINS-ROOM \FALSE
	EQUAL? PAST-WATER-FLAG,4 \?L3
	CALL HYPOTHERMIA
	RETURN 2
?L3:	CALL QUEUE,I-WATER-RISING,4
	LESS? PAST-WATER-FLAG,4 \?L8
	INC 'PAST-WATER-FLAG
?L8:	IN? PLAYER,ZIPPER /FALSE
	CRLF
	GET WATER-TABLE,PAST-WATER-FLAG >STACK
	PRINT STACK
	EQUAL? PAST-WATER-FLAG,2 \?L14
	CALL SOAK-STUFF,HERE,0 >STACK
	ZERO? STACK /?L16
	PRINTI " Items on the floor are wet and ruined, of course."
?L16:	CALL NOT-SITTING
	CRLF
	RTRUE
?L14:	EQUAL? PAST-WATER-FLAG,4 \?L19
	CALL SOAK-PLAYER
?L19:	CRLF
	RTRUE

	.FUNCT I-PRISON-GUARDS
	CALL TIME-FROZEN? >STACK
	ZERO? STACK /?L1
	CALL QUEUE,I-PRISON-GUARDS,2
	RFALSE
?L1:	EQUAL? HERE,PAST-CELL-EAST \FALSE
	PRINTI "Many nasty guards arrive"
	IN? PLAYER,CABINET \?L4
	PRINTI ", find you hiding in the cabinet,"
?L4:	PRINTI " and immediately (for their own protection, of course) run you through with their swords."
	CRLF
	CRLF
	CALL TIME-SICK-CELL-EAST >STACK
	RSTACK

	.FUNCT SPELL-BOOK-F,F,F?1
	EQUAL? PRSA,V?EXAMINE \?L1
	PRINTI "This is your well-used old "
	PRINTD SPELL-BOOK
	PRINTI ", first given to you by Belboz years ago after your original book was lost. "
	FSET? PRSO,RMUNGBIT \?L3
	PRINTR "He would be appalled by its current ruined condition. It's water-soaked, and the ink has run. It's useless."
?L3:	PRINTI "There are some spells written in the book, those few still working of the many you once knew. The rest have faded away."
	ZERO? CLEESHED? /?L6
	ZERO? SEEN-BLORPLE? \?L6
	CALL SEE-BLORPLE
	PRINTI " As you look at it closely, though, you realize that the book has changed subtly from its previous appearance. There is a new entry: "
	PRINTD BLORPLE-SPELL
	PRINTI " ("
	GETP BLORPLE-SPELL,P?TEXT >STACK
	PRINT STACK
	PRINTI ")."
?L6:	CRLF
	RTRUE
?L1:	EQUAL? PRSA,V?OPEN,V?CLOSE \?L9
	PRINTI "The "
	PRINTD SPELL-BOOK
	PRINTR " is always open to the right place, but it is also always closed. This eliminates tedious leafing and hunting for spells. Many lives have been saved by this magical innovation."
?L9:	EQUAL? PRSA,V?READ,V?LOOK-INSIDE \?L10
	FSET? PRSO,RMUNGBIT \?L11
	CALL CTHE-PRINT,SPELL-BOOK
	PRINTR " is totally unreadable. The ink has run, and the pages are soaked. What a mess!"
?L11:	ZERO? LIT \?L13
	PRINTI "The magic writing of the spells casts enough light that you can read them."
	CRLF
?L13:	PRINTI "My Spell Book

"
	FIRST? SPELL-BOOK >F?1 \?L17
?L15:	CALL CTHE-PRINT,F?1
	PRINTI " ("
	GETP F?1,P?TEXT >STACK
	PRINT STACK
	PRINTI ")."
	CRLF
	NEXT? F?1 >F?1 /?L15
?L17:	ZERO? CLEESHED? /TRUE
	ZERO? SEEN-BLORPLE? \TRUE
	CALL SEE-BLORPLE
	PRINTR "
Oddly enough, you have never before seen or heard of the blorple spell which now graces (or defaces?) your book."
?L10:	EQUAL? PRSA,V?WRITE \FALSE
	PRINTI "When you are done, the "
	PRINTD SPELL-BOOK
	PRINTR " remains unmarred."

	.FUNCT SCROLL-F,SPELL
	EQUAL? PRSA,V?TAKE \?L1
	FIRST? PRSO >SPELL /?L3
?L3:	FSET SPELL,TOUCHBIT
	FCLEAR PRSO,TRYTAKEBIT
	RFALSE
?L1:	EQUAL? PRSA,V?GNUSTO,V?COPY,V?WRITE \?L4
	FSET? PRSO,SCROLLBIT \?L5
	IN? PRSO,WINNER /?L5
	CALL MUST-HOLD-SCROLL >STACK
	RSTACK
?L5:	FIRST? PRSO >SPELL \FALSE
	CALL PERFORM,PRSA,SPELL,PRSI
	RTRUE
?L4:	EQUAL? PRSA,V?EXAMINE,V?READ \FALSE
	CALL READ-SCROLL >STACK
	RSTACK

	.FUNCT SCROLL-WET
	PRINTR "The scroll is wet, and the spell cannot be read."

	.FUNCT READ-SCROLL,SPELL=0
	FSET? PRSO,RMUNGBIT \?L1
	CALL SCROLL-WET
	RTRUE
?L1:	ZERO? SPELL \?L6
	FIRST? PRSO >SPELL /?L6
?L6:	PRINTI "The scroll"
	CALL SPELL-READS,SPELL >STACK
	RSTACK

	.FUNCT MUST-HOLD-SCROLL
	PRINTR "You must be holding the spell scroll you wish to copy!"

	.FUNCT SPELL-F,MEM?,FORGET=0,?TMP
	EQUAL? PRSA,V?READ,V?LEARN \?L5
	IN? PRSO,SPELL-BOOK /?L1
	LOC PRSO >STACK
	FSET? STACK,TOUCHBIT \?L1
	LOC PRSO >STACK
	IN? STACK,WINNER /?L1
	PRINT YOU-CANT
	PRINTI "do that without having the spell in your book."
	CRLF
	RETURN 2
?L1:	EQUAL? PRSA,V?READ,V?LEARN \?L5
	FSET? SPELL-BOOK,RMUNGBIT \?L5
	CALL PERFORM,V?READ,SPELL-BOOK
	CALL THIS-IS-IT,PRSO
	RETURN 2
?L5:	LOC PRSO >STACK
	ZERO? STACK /?L8
	LOC PRSO >STACK
	FSET? STACK,RMUNGBIT \?L8
	CALL SCROLL-WET >STACK
	RSTACK
?L8:	EQUAL? PRSA,V?READ \?L9
	PRINTI "The spell"
	CALL SPELL-READS,PRSO >STACK
	RSTACK
?L9:	EQUAL? PRSA,V?LEARN \?L10
	IN? PRSO,SPELL-BOOK /?L11
	CALL HELD?,PRSO >STACK
	ZERO? STACK /?L13
	PRINTI "You haven't written that spell into your book yet. Until you do, you can't memorize the spell."
	CRLF
	RETURN 2
?L13:	CALL V-LEARN
	RETURN 2
?L11:	IN? PRSO,DEAD-BOOK \?L18
	PRINTI "You can learn spells only from your own "
	PRINTD SPELL-BOOK
	PRINT PERIOD
	RETURN 2
?L18:	EQUAL? PRSO,GNUSTO-SPELL,FROTZ-SPELL,REZROV-SPELL \?L21
	PRINTR "You already know that spell by heart."
?L21:	IN? SPELL-BOOK,WINNER /?L22
	PRINT YOU-DONT-HAVE
	PRINTI "your "
	PRINTD SPELL-BOOK
	PRINTI ". You can't memorize a spell without a "
	PRINTD SPELL-BOOK
	PRINT PERIOD
	RETURN 2
?L22:	GETP PRSO,P?COUNT >MEM?
	CALL HELD?,MAGIC-CUBE >STACK
	ZERO? STACK \?L32
	EQUAL? SPELL-MAX,1 /?L30
	GRTR? AWAKE,6 /?L30
	GRTR? AWAKE,0 \?L28
	MUL 5,AWAKE >?TMP
	RANDOM 100 >STACK
	LESS? ?TMP,STACK /?L28
?L30:	PRINT YOU-CANT
	PRINTR "concentrate well enough to learn the spell."
?L28:	EQUAL? MEM?,SPELL-MAX \?L31
	PRINTR "You try, but you just can't memorize those complex syllables again. They slip out of your memory as soon as you cram them in."
?L31:	GRTR? SPELL-ROOM,0 /?L32
	CALL FORGET-SPELL
	SET 'SPELL-ROOM,1
	SET 'FORGET,1
?L32:	DEC 'SPELL-ROOM
	INC 'MEM?
	PUTP PRSO,P?COUNT,MEM?
	CALL HELD?,MAGIC-CUBE >STACK
	ZERO? STACK /?L35
	PRINTI "You easily"
	JUMP ?L37
?L35:	PRINTI "Using your best study habits, you"
?L37:	PRINTI " learn the "
	PRINTD PRSO
	GRTR? MEM?,1 \?L38
	PRINTI " yet another time"
?L38:	PRINT PERIOD
	ZERO? FORGET /TRUE
	PRINTR "You have so much buzzing around in your head, though, that it's likely that something may have been forgotten in the shuffle."
?L10:	CALL VISIBLE?,PRSO >STACK
	ZERO? STACK \?L44
	EQUAL? PRSA,V?CAST /?L44
	PRINT YOU-CANT-SEE
	PRINTR "that spell here!"
?L44:	EQUAL? PRSA,V?TAKE,V?DROP,V?THROW \FALSE
	CALL TELL-YUKS >STACK
	RSTACK

	.FUNCT SPELL-READS,SPELL
	PRINTI " reads """
	CALL DPRINT,SPELL
	PRINTI ": "
	GETP SPELL,P?TEXT >STACK
	PRINT STACK
	PRINTI "."""
	EQUAL? SPELL,GIRGOL-SPELL /?L3
	EQUAL? SPELL,SPELL-COPY \?L1
	GETP SPELL,P?WALLS >STACK
	EQUAL? STACK,GIRGOL-SPELL \?L1
?L3:	PRINTI " The spell is long and complicated."
?L1:	CRLF
	RTRUE

	.FUNCT FORGET-SPELL,F,TBL,NUM=0,SP=0
	FIRST? SPELL-BOOK >F /?L1
?L1:	SET 'TBL,FORGET-TBL
	ZERO? F /?L3
?L4:	GETP F,P?COUNT >STACK
	GRTR? STACK,0 \?L6
	SET 'SP,F
	PUT TBL,1,F
	INC 'NUM
	ADD TBL,2 >TBL
?L6:	NEXT? F >F /?L4
?L3:	ZERO? NUM /TRUE
	GRTR? NUM,1 \?L12
	PUT FORGET-TBL,0,NUM
	CALL RANDOM-ELEMENT,FORGET-TBL >SP
?L12:	GETP SP,P?COUNT >STACK
	DEC 'STACK
	PUTP SP,P?COUNT,STACK
	RTRUE

	.FUNCT FORGET-ALL,F,F?1
	SET 'SPELL-ROOM,SPELL-MAX
	FIRST? SPELL-BOOK >F?1 \TRUE
?L1:	PUTP F?1,P?COUNT,0
	NEXT? F?1 >F?1 /?L1
	RTRUE

	.FUNCT WEAR-OFF-SPELLS,SLEEP?=1
	ZERO? CHANGED? /?L5
	ZERO? SLEEP? /?L3
	CALL I-SNAVIG
	JUMP ?L5
?L3:	SET 'CHANGED?,0
	CALL DEQUEUE,I-SNAVIG
?L5:	ZERO? SHRINK-FLAG /?L11
	ZERO? SLEEP? /?L9
	CALL I-LISKON
	JUMP ?L11
?L9:	CALL HELD?,SHRINK-FLAG >STACK
	ZERO? STACK /?L12
	EQUAL? SHRINK-FLAG,WEED \?L12
	MOVE WEED,HERE
?L12:	SET 'SHRINK-FLAG,0
	SET 'SMALL-FLAG,0
	CALL DEQUEUE,I-LISKON
?L11:	ZERO? TIME-STOPPED? /?L20
	ZERO? SLEEP? /?L18
	CALL I-GIRGOL
	JUMP ?L20
?L18:	SET 'TIME-STOPPED?,0
	SET 'ROCK-FLAG,0
	CALL DEQUEUE,I-GIRGOL
?L20:	ZERO? ESPNIS? /FALSE
	ZERO? SLEEP? /?L24
	CALL I-ESPNIS >STACK
	RSTACK
?L24:	SET 'ESPNIS?,0
	CALL DEQUEUE,I-ESPNIS >STACK
	RSTACK

	.FUNCT SPELL-VERB?
	EQUAL? PRSA,V?GNUSTO,V?FROTZ,V?REZROV /TRUE
	EQUAL? PRSA,V?TINSOT,V?YOMIN,V?MALYON /TRUE
	EQUAL? PRSA,V?LESOCH,V?BLORPLE,V?SNAVIG /TRUE
	EQUAL? PRSA,V?GIRGOL,V?JINDAK,V?ESPNIS /TRUE
	EQUAL? PRSA,V?CASKLY,V?LISKON,V?THROCK /TRUE
	RFALSE

	.FUNCT PRE-CAST,SPELL,SCROLL
	ZERO? SPELL-CAST \FALSE
	EQUAL? PRSA,V?GNUSTO \?L4
	SET 'SPELL,GNUSTO-SPELL
	JUMP ?L5
?L4:	EQUAL? PRSA,V?FROTZ \?L6
	SET 'SPELL,FROTZ-SPELL
	JUMP ?L5
?L6:	EQUAL? PRSA,V?REZROV \?L7
	SET 'SPELL,REZROV-SPELL
	JUMP ?L5
?L7:	EQUAL? PRSA,V?YOMIN \?L8
	SET 'SPELL,YOMIN-SPELL
	JUMP ?L5
?L8:	EQUAL? PRSA,V?LESOCH \?L9
	SET 'SPELL,LESOCH-SPELL
	JUMP ?L5
?L9:	EQUAL? PRSA,V?BLORPLE \?L10
	SET 'SPELL,BLORPLE-SPELL
	JUMP ?L5
?L10:	EQUAL? PRSA,V?SNAVIG \?L11
	SET 'SPELL,SNAVIG-SPELL
	JUMP ?L5
?L11:	EQUAL? PRSA,V?GIRGOL \?L12
	SET 'SPELL,GIRGOL-SPELL
	JUMP ?L5
?L12:	EQUAL? PRSA,V?JINDAK \?L13
	SET 'SPELL,JINDAK-SPELL
	JUMP ?L5
?L13:	EQUAL? PRSA,V?ESPNIS \?L14
	SET 'SPELL,ESPNIS-SPELL
	JUMP ?L5
?L14:	EQUAL? PRSA,V?MALYON \?L15
	SET 'SPELL,MALYON-SPELL
	JUMP ?L5
?L15:	EQUAL? PRSA,V?CASKLY \?L16
	SET 'SPELL,CASKLY-SPELL
	JUMP ?L5
?L16:	EQUAL? PRSA,V?LISKON \?L17
	SET 'SPELL,LISKON-SPELL
	JUMP ?L5
?L17:	EQUAL? PRSA,V?THROCK \?L18
	SET 'SPELL,THROCK-SPELL
	JUMP ?L5
?L18:	EQUAL? PRSA,V?TINSOT \?L19
	SET 'SPELL,TINSOT-SPELL
	JUMP ?L5
?L19:	EQUAL? PRSA,V?$0024XEROX \?L20
	SET 'SPELL,SPELL-COPY
	JUMP ?L5
?L20:	SET 'SPELL,0
?L5:	IN? SPELL,BLANK-SCROLL \?L22
	LOC SPELL-COPY >STACK
	IN? STACK,WINNER \?L22
	IN? BLANK-SCROLL,WINNER /?L22
	SET 'SPELL,SPELL-COPY
?L22:	EQUAL? CHANGED?,GROUPER,SNAKE,GRUE \?L25
	PRINTI "Your mouth cannot form the words of spells while you are changed into a "
	PRINTD CHANGED?
	PRINT PERIOD
	RTRUE
?L25:	EQUAL? HERE,OCEAN-FLOOR \?L27
	PRINTR "You can't cast a spell while underwater!"
?L27:	LOC SPELL >SCROLL
	EQUAL? SPELL,PRSO /?L31
	EQUAL? SCROLL,PRSO \?L29
	EQUAL? SCROLL,SPELL-BOOK /?L29
?L31:	PRINTR "As you must remember from Thaumaturgy 101, you cannot cast a spell upon itself, or upon the scroll it is written on."
?L29:	EQUAL? SCROLL,0,SPELL-BOOK /?L37
	FSET? SCROLL,SCROLLBIT /?L33
	EQUAL? SCROLL,DEAD-BOOK \?L37
?L33:	FSET? SCROLL,RMUNGBIT \?L34
	CALL CTHE-PRINT,SCROLL
	PRINTR " is unreadable."
?L34:	IN? SCROLL,WINNER \?L36
	REMOVE SCROLL
	PRINTI "As you cast the spell, "
	CALL THE-PRINT,SCROLL
	PRINTI " vanishes!"
	CRLF
	PUTP SPELL,P?COUNT,1
	JUMP ?L37
?L36:	CALL CTHE-PRINT,SPELL
	PRINTR " is not memorized, and you aren't holding a scroll on which it is written."
?L37:	EQUAL? SPELL,SPELL-COPY \?L39
	GETP SPELL-COPY,P?EXITS >PRSA
?L39:	EQUAL? PRSA,V?BLORPLE \?L42
	IN? PRSO,WINNER /?L42
	CALL NOT-HOLDING,PRSO
	RTRUE
?L42:	GETP SPELL,P?COUNT >STACK
	ZERO? STACK \?L47
	EQUAL? SPELL,GNUSTO-SPELL,REZROV-SPELL,FROTZ-SPELL \?L45
?L47:	SET 'SPELL-CAST,SPELL
	EQUAL? HERE,SCALES-ROOM \?L48
	EQUAL? PRSA,V?REZROV,V?MALYON \?L50
	EQUAL? PRSO,IRON-DOOR,VAULT-DOOR \?L50
	SET 'SPELLS-USED,2
?L50:	CALL USE-SPELL
?L48:	EQUAL? HERE,PLAIN-ROOM \?L54
	CALL PLAIN-SPELL-FAIL >STACK
	RSTACK
?L54:	CALL SPELL-PROB?,SPELL >STACK
	ZERO? STACK \FALSE
	PRINTI "The casting feels wrong, and sure enough, "
	CALL PICK-ONE,FIZZLES >STACK
	PRINT STACK
	CRLF
	RTRUE
?L45:	PRINT YOU-DONT-HAVE
	CALL THE-PRINT,SPELL
	PRINTI " memorized!"
	CRLF
	CALL THIS-IS-IT,SPELL
	RTRUE

	.FUNCT USE-SPELL
	EQUAL? PRSA,V?JINDAK \?L1
	SET 'USED-JINDAK?,1
?L1:	IGRTR? 'SPELLS-USED,2 \FALSE
	ZERO? GUARDS-FLAG \FALSE
	CALL QUEUED?,I-ALARM >STACK
	ZERO? STACK \FALSE
	CALL QUEUE,I-ALARM,-1
	CALL QUEUE,I-GUARDS,2
	RFALSE

	.FUNCT SPELL-PROB?,SPELL?,P=50,N1,N2
	CALL GOT?,MAGIC-CUBE >STACK
	ZERO? STACK /?L1
	EQUAL? SPELL?,GIRGOL-SPELL \TRUE
?L1:	EQUAL? SPELL?,FROTZ-SPELL \?L3
	EQUAL? HERE,DARK-CAVE,GRUE-CAVE,LIGHT-POOL /FALSE
	EQUAL? HERE,PILLAR-ROOM /FALSE
?L3:	EQUAL? SPELL?,BLORPLE-SPELL \?L5
	EQUAL? HERE,CASTLE \?L5
	GRTR? SHADOW-COUNT,8 /FALSE
?L5:	EQUAL? SPELL?,GNUSTO-SPELL \?L7
	SET 'P,75
	SET 'N1,CHANGE-CUBE
	SET 'N2,EARTH-CUBE
	JUMP ?L30
?L7:	EQUAL? SPELL?,FROTZ-SPELL \?L9
	SET 'P,75
	SET 'N1,CHANGE-CUBE
	SET 'N2,LIGHT-CUBE
	JUMP ?L30
?L9:	EQUAL? SPELL?,REZROV-SPELL \?L10
	SET 'N1,CHANGE-CUBE
	SET 'N2,EARTH-CUBE
	JUMP ?L30
?L10:	EQUAL? SPELL?,YOMIN-SPELL \?L11
	SET 'N1,MIND-CUBE
	SET 'N2,LIGHT-CUBE
	JUMP ?L30
?L11:	EQUAL? SPELL?,LESOCH-SPELL \?L12
	SET 'N1,AIR-CUBE
	SET 'N2,FIRE-CUBE
	JUMP ?L30
?L12:	EQUAL? SPELL?,BLORPLE-SPELL /TRUE
	EQUAL? SPELL?,SNAVIG-SPELL \?L14
	SET 'N1,CHANGE-CUBE
	SET 'N2,DARK-CUBE
	JUMP ?L30
?L14:	EQUAL? SPELL?,GIRGOL-SPELL \?L15
	IN? GIRGOL-SPELL,GIRGOL-SCROLL \?L16
	EQUAL? SPELL?,GIRGOL-SPELL \TRUE
	EQUAL? HERE,COUNCIL-CHAMBER \TRUE
	RFALSE
?L16:	EQUAL? HERE,CASTLE,PAST-RUINS-ROOM,PAST-CELL-EAST /TRUE
	EQUAL? HERE,MAGIC-ROOM,TIME-ROOM \FALSE
	RTRUE
?L15:	EQUAL? SPELL?,JINDAK-SPELL \?L24
	SET 'N1,LIGHT-CUBE
	SET 'N2,CONNECTIVITY-CUBE
	JUMP ?L30
?L24:	EQUAL? SPELL?,ESPNIS-SPELL \?L25
	SET 'N1,MIND-CUBE
	SET 'N2,DEATH-CUBE
	JUMP ?L30
?L25:	EQUAL? SPELL?,MALYON-SPELL \?L26
	SET 'N1,FIRE-CUBE
	SET 'N2,LIFE-CUBE
	JUMP ?L30
?L26:	EQUAL? SPELL?,CASKLY-SPELL \?L27
	SET 'N1,CHANGE-CUBE
	SET 'N2,CONNECTIVITY-CUBE
	JUMP ?L30
?L27:	EQUAL? SPELL?,LISKON-SPELL \?L28
	SET 'N1,CHANGE-CUBE
	SET 'N2,EARTH-CUBE
	JUMP ?L30
?L28:	EQUAL? SPELL?,THROCK-SPELL \?L29
	SET 'N1,LIFE-CUBE
	SET 'N2,WATER-CUBE
	JUMP ?L30
?L29:	EQUAL? SPELL?,TINSOT-SPELL \?L30
	SET 'N1,WATER-CUBE
	SET 'N2,FIRE-CUBE
?L30:	CALL COUNT-CUBES >STACK
	MUL STACK,5 >STACK
	ADD P,STACK >P
	CALL GOT?,N1 >STACK
	ZERO? STACK /?L32
	ADD P,20 >P
?L32:	CALL GOT?,N2 >STACK
	ZERO? STACK /?L35
	ADD P,20 >P
?L35:	LESS? P,100 \TRUE
	RANDOM 100 >STACK
	LESS? P,STACK /FALSE
	RTRUE

	.FUNCT V-CAST,VRB
	FSET? PRSO,SPELLBIT /?L1
	PRINTI "You can't cast "
	CALL A-PRSO >STACK
	RSTACK
?L1:	CALL SPELL-TO-VERB >VRB
	ZERO? PRSI \?L4
	EQUAL? VRB,V?JINDAK,V?GIRGOL,V?LESOCH /?L4
	EQUAL? VRB,V?$0024XEROX /?L4
	PRINTR "You must cast that on something."
?L4:	CALL PERFORM,VRB,PRSI
	RTRUE

	.FUNCT V-$0024XEROX,VRB
	GETP SPELL-COPY,P?EXITS >VRB
	ZERO? VRB /TRUE
	CALL PERFORM,VRB,PRSO
	RTRUE

	.FUNCT SPELL-TO-VERB
	EQUAL? PRSO,GNUSTO-SPELL \?L1
	RETURN V?GNUSTO
?L1:	EQUAL? PRSO,FROTZ-SPELL \?L3
	RETURN V?FROTZ
?L3:	EQUAL? PRSO,REZROV-SPELL \?L4
	RETURN V?REZROV
?L4:	EQUAL? PRSO,YOMIN-SPELL \?L5
	RETURN V?YOMIN
?L5:	EQUAL? PRSO,LESOCH-SPELL \?L6
	RETURN V?LESOCH
?L6:	EQUAL? PRSO,BLORPLE-SPELL \?L7
	RETURN V?BLORPLE
?L7:	EQUAL? PRSO,SNAVIG-SPELL \?L8
	RETURN V?SNAVIG
?L8:	EQUAL? PRSO,GIRGOL-SPELL \?L9
	RETURN V?GIRGOL
?L9:	EQUAL? PRSO,JINDAK-SPELL \?L10
	RETURN V?JINDAK
?L10:	EQUAL? PRSO,ESPNIS-SPELL \?L11
	RETURN V?ESPNIS
?L11:	EQUAL? PRSO,MALYON-SPELL \?L12
	RETURN V?MALYON
?L12:	EQUAL? PRSO,CASKLY-SPELL \?L13
	RETURN V?CASKLY
?L13:	EQUAL? PRSO,LISKON-SPELL \?L14
	RETURN V?LISKON
?L14:	EQUAL? PRSO,THROCK-SPELL \?L15
	RETURN V?THROCK
?L15:	EQUAL? PRSO,TINSOT-SPELL \?L16
	RETURN V?TINSOT
?L16:	EQUAL? PRSO,SPELL-COPY \FALSE
	RETURN V?$0024XEROX

	.FUNCT V-SPELLS,S,ANY=0,OS=0,TMP,CNT
	PRINTI "The gnusto, rezrov, and frotz spells are yours forever. Other than that, you have "
	GET ALL-SPELLS,0 >CNT
?L1:	GET ALL-SPELLS,CNT >STACK
	CALL SPELL-TIMES,STACK >TMP
	ZERO? TMP /?L4
	ZERO? OS /?L6
	CALL SPELL-PRINT,OS,ANY
	SET 'ANY,1
?L6:	SET 'OS,TMP
?L4:	DLESS? 'CNT,1 \?L1
	ZERO? OS /?L10
	CALL SPELL-PRINT,OS,ANY,1
	SET 'ANY,1
?L10:	ZERO? ANY \?L13
	PRINTR "no spells memorized."
?L13:	PRINTR " committed to memory."

	.FUNCT SPELL-PRINT,S,ANY,PAND?=0,X
	ZERO? ANY /?L5
	ZERO? PAND? /?L3
	PRINTI " and "
	JUMP ?L5
?L3:	PRINTI ", "
?L5:	CALL THE-PRINT,S
	PRINTI " "
	GETP S,P?COUNT >STACK
	SUB STACK,1 >X
	GRTR? X,4 \?L7
	SET 'X,4
?L7:	GET COUNTERS,X >STACK
	PRINT STACK
	RETURN S

	.FUNCT SPELL-TIMES,S
	GETP S,P?COUNT >STACK
	GRTR? STACK,0 \FALSE
	IN? S,SPELL-BOOK \FALSE
	RETURN S

	.FUNCT V-LEARN
	PRINT YOU-DONT-HAVE
	PRINTR "that spell, if indeed that is a spell."

	.FUNCT SEE-BLORPLE
	ZERO? SEEN-BLORPLE? \FALSE
	SET 'SEEN-BLORPLE?,1
	ADD SCORE,15 >SCORE
	RETURN SCORE

	.FUNCT V-BLORPLE,RM
	CALL SEE-BLORPLE
	GETP HERE,P?CUBE >STACK
	ZERO? STACK \?L3
	EQUAL? HERE,DULL-ROOM \?L1
?L3:	PRINT NOTHING-HAPPENS
	RTRUE
?L1:	EQUAL? PRSO,TIME-CUBE \?L5
	ZERO? USED-JINDAK? \?L5
	SET 'BLORPLE-OBJECT,0
	SET 'RM,0
	JUMP ?L7
?L5:	SET 'BLORPLE-OBJECT,PRSO
	GETP PRSO,P?CUBE >RM
?L7:	ZERO? RM \?L8
	SET 'DULL-ROOM-RETURN,HERE
	SET 'RM,DULL-ROOM
?L8:	PRINTI "Abruptly, your surroundings shift."
	LOC PLAYER >STACK
	FSET? STACK,VEHBIT \?L11
	SET 'SITTING?,0
	EQUAL? HERE,MIDAIR \?L13
	LOC PLAYER >STACK
	MOVE STACK,LOST-ON-LAND
?L13:	PRINTI " The spell leaves "
	LOC PLAYER >STACK
	CALL THE-PRINT,STACK
	PRINTI " behind."
?L11:	MOVE PLAYER,HERE
	REMOVE PRSO
	CRLF
	CRLF
	CALL GOTO,RM >STACK
	RSTACK

	.FUNCT RECOVER-CUBE
	ZERO? BLORPLE-OBJECT /FALSE
	EQUAL? HERE,OHERE /FALSE
	PRINTI "As you leave, "
	CALL THE-PRINT,BLORPLE-OBJECT
	PRINTI " reappears in your hand."
	CRLF
	CRLF
	MOVE BLORPLE-OBJECT,WINNER
	FCLEAR BLORPLE-OBJECT,NDESCBIT
	SET 'BLORPLE-OBJECT,0
	RTRUE

	.FUNCT V-LESOCH
	EQUAL? HERE,BELWIT-SQUARE \?L1
	EQUAL? PRSO,CLOUD /?L3
	ZERO? PRSO \?L1
	FSET? CLOUD,INVISIBLE /?L1
?L3:	FSET CLOUD,INVISIBLE
	CALL DEQUEUE,I-CLOUD-GONE
	PRINTI "A small gust of wind begins to roil the cloud. The cloud is unimpressed. The wind builds, slowly but inexorably, to hurricane force. The cloud starts to unravel at the edges, and then gives up and dissipates"
	IN? EARTH-CUBE,HERE \?L4
	CALL THIS-IS-IT,EARTH-CUBE
	FCLEAR EARTH-CUBE,INVISIBLE
	PRINTI ". Left behind on the ground is a small "
	PRINT WHITE-CUBE
	PRINTI "."
?L4:	CALL CLEVER-CONTENTS,HERE,STR?167,EARTH-CUBE
	CRLF
	RTRUE
?L1:	PRINTR "Slowly, teasingly, a small puff of wind begins to blow. It quickly builds to gale force, then hurricane force, and just as you feel you are about to be swept away, it subsides."

	.FUNCT V-SNAVIG
	ZERO? PRSO \?L1
	PRINTR "You have to transform into something, and it has to be something nearby."
?L1:	EQUAL? CHANGED?,PRSO \?L3
	PRINT NOTHING-HAPPENS
	RTRUE
?L3:	EQUAL? PRSO,PSEUDO-OBJECT \?L4
	EQUAL? P-PNAM,W?MOSS,W?CORAL \?L4
	PRINTR "You're too large."
?L4:	CALL YOU-CANT-X-PRSO,STR?168 >STACK
	RSTACK

	.FUNCT TOO-PRECISE,STR
	EQUAL? PRSO,0,GLOBAL-ROOM /FALSE
	PRINTI "This spell "
	PRINT STR
	PRINTI " in a large area, so directing it at "
	CALL HELD?,PRSO >STACK
	ZERO? STACK /?L3
	PRINTI "an object you are holding won't work very well"
	JUMP ?L5
?L3:	PRINTI "a specific object is unnecessarily precise"
?L5:	PRINT PERIOD
	CRLF
	RTRUE

	.FUNCT V-GIRGOL
	ZERO? TIME-STOPPED? /?L1
	PRINT NOTHING-HAPPENS
	RTRUE
?L1:	EQUAL? HERE,EMPORIUM \?L3
	CALL PERFORM,V?ESPNIS,MERCHANT
	RTRUE
?L3:	CALL TOO-PRECISE,STR?169
	SET 'TIME-STOPPED?,HERE
	CALL QUEUE,I-GIRGOL,12
	EQUAL? HERE,CLIFF-TOP \?L5
	CALL QUEUED?,I-AVALANCHE >STACK
	ZERO? STACK /?L5
	GRTR? ROCK-SLIDE-COUNT,0 \?L5
	CALL STOP-AVALANCHE >STACK
	RSTACK
?L5:	EQUAL? HERE,OGRE-CAVE \?L7
	PRINTR "The ogre, who was gesticulating wildly, freezes in place. He looks like a particularly bad statue of himself. Even his lice aren't moving."
?L7:	EQUAL? HERE,SOUTH-SNAKE-ROOM,NORTH-SNAKE-ROOM \?L8
	PRINTR "The snake freezes in place, as though a particularly good statue of itself had been put in its place. However, it still completely blocks the passage."
?L8:	EQUAL? HERE,PAST-RUINS-ROOM \?L9
	CALL DEQUEUE,I-WATER-RISING
	PRINTR "The water stops rising."
?L9:	EQUAL? HERE,CASTLE \?L10
	IN? SHADOW,CASTLE \?L10
	LESS? SHADOW-COUNT,8 \?L11
	SET 'TIME-STOPPED?,0
	CALL DEQUEUE,I-GIRGOL
	PRINTR "The shadow turns and silences you with a word of power, cancelling the spell."
?L11:	EQUAL? SHADOW-COUNT,8 \?L13
	CALL QUEUE,I-GIRGOL,3
	PRINTR "All around you freezes in place! The shadow is caught in a particularly evil posture. You can tell the spell won't hold for long!"
?L13:	EQUAL? SHADOW-COUNT,9 \FALSE
	CALL QUEUE,I-GIRGOL,3
	PRINTR "The shadow freezes in mid-leap! You can tell the spell won't hold for long in this magically charged atmosphere!"
?L10:	PRINT AT-FIRST
	PRINTR "subtle changes in your surroundings. Nothing is moving. You can see dust motes hanging in midair, and a tiny gnat, its wings motionless, unknowingly defying gravity."

	.FUNCT V-JINDAK,F,1ST?=1,P1,P2
	CALL TOO-PRECISE,STR?170
	EQUAL? HERE,SCALES-ROOM \?L1
	CALL MEASURE,PILE-1 >P1
	CALL MEASURE,PILE-2 >P2
	GRTR? P1,0 \?L11
	GRTR? P2,0 \?L3
	PRINTI "Both piles of cubes glow with a faint blue glow. "
	EQUAL? P1,P2 \?L5
	PRINTI "Both piles seem to glow with identical brightness."
	JUMP ?L13
?L5:	PRINTI "However, the "
	GRTR? P1,P2 \?L8
	PRINTD PILE-1
	JUMP ?L10
?L8:	PRINTD PILE-2
?L10:	PRINTI " is glowing more brightly."
	JUMP ?L13
?L3:	GRTR? P1,0 \?L11
	CALL CTHE-PRINT,PILE-1
	PRINT IS-GLOWING
	JUMP ?L13
?L11:	GRTR? P2,0 \?L12
	CALL CTHE-PRINT,PILE-2
	PRINT IS-GLOWING
	JUMP ?L13
?L12:	FIRST? PILE-1 >STACK \?L13
	FIRST? PILE-2 >STACK \?L13
	PRINTI "Neither pile is glowing at all."
?L13:	CRLF
	CALL DETECT-MAGIC,HERE >STACK
	ZERO? STACK \FALSE
	PRINTR "Nothing else is glowing."
?L1:	CALL DETECT-MAGIC,HERE >STACK
	ZERO? STACK \FALSE
	PRINTR "Nothing in the vicinity glows. Apparently there is no magic nearby."

	.FUNCT DETECT-MAGIC,OBJ,1ST?=1,F,F?1
	FIRST? OBJ >F?1 \?L3
?L1:	EQUAL? F?1,PLAYER,PILE-1,PILE-2 /?L9
	CALL VISIBLE?,F?1 >STACK
	ZERO? STACK /?L6
	CALL MAGIC?,F?1 >STACK
	ZERO? STACK /?L6
	SET '1ST?,0
	CALL CTHE-PRINT,F?1
	PRINT IS-GLOWING
	CRLF
	JUMP ?L9
?L6:	CALL SEE-INSIDE?,F?1 >STACK
	ZERO? STACK /?L9
	FIRST? F?1 >STACK \?L9
	CALL DETECT-MAGIC,F?1,1ST? >STACK
	ZERO? STACK /?L9
	SET '1ST?,0
?L9:	NEXT? F?1 >F?1 /?L1
?L3:	ZERO? 1ST? /TRUE
	RFALSE

	.FUNCT MAGIC?,OBJ
	FSET? OBJ,MAGICBIT /TRUE
	FSET? OBJ,SCROLLBIT /TRUE
	GETPT OBJ,P?NAME >STACK
	ZERO? STACK \TRUE
	RFALSE

	.FUNCT V-ESPNIS
	EQUAL? PRSO,ME,WINNER \?L1
	CALL V-SLEEP,1 >STACK
	RSTACK
?L1:	CALL TIME-FROZEN? >STACK
	ZERO? STACK /?L3
	PRINT NOTHING-HAPPENS
	RTRUE
?L3:	FSET? PRSO,PERSON \?L4
	CALL QUEUE,I-ESPNIS,20
	EQUAL? ESPNIS?,PRSO \?L5
	CALL CTHE-PRINT-PRSO
	PRINTR " continues to sleep."
?L5:	ZERO? ESPNIS? /?L8
	CALL I-ESPNIS
?L8:	SET 'ESPNIS?,PRSO
	CALL CTHE-PRINT-PRSO
	PRINTR " falls asleep, yawning lazily."
?L4:	PRINTI "I suppose you expect to hear "
	CALL THE-PRINT-PRSO
	PRINTR " snoring?"

	.FUNCT V-CASKLY
	CALL CTHE-PRINT-PRSO
	FSET? PRSO,RMUNGBIT \?L1
	FSET? PRSO,TAKEBIT \?L1
	FCLEAR PRSO,RMUNGBIT
	PRINTR " is returned to its original perfection."
?L1:	PRINTR " looks pretty perfect as is."

	.FUNCT V-THROCK
	PRINTI "I guess you have a black thumb. "
	PRINT NOTHING-HAPPENS
	RTRUE

	.FUNCT V-TINSOT
	SET 'ICED-OBJECT,PRSO
	EQUAL? HERE,OUBLIETTE \?L1
	EQUAL? PRSO,INFLOW,OUTFLOW,OUBLIETTE-CHANNEL /?L3
	EQUAL? PRSO,WATER \?L1
?L3:	GRTR? WATER-FLAG,0 \?L4
	EQUAL? PRSO,WATER /?L4
	PRINT YOU-CANT-SEE
	PRINTI "that anymore"
	PRINT PERIOD
	RTRUE
?L4:	EQUAL? PRSO,INFLOW \?L6
	CALL PARTIAL-BLOCKAGE,INFLOW >STACK
	RSTACK
?L6:	ZERO? WATER-FLAG \?L7
	CALL QUEUE,I-TINSOT,30
	SET 'ICED-OBJECT,OUTFLOW
	INC 'FREEZE-FLAG
	EQUAL? FREEZE-FLAG,1 \?L8
	CALL PARTIAL-BLOCKAGE,OUTFLOW >STACK
	RSTACK
?L8:	EQUAL? FREEZE-FLAG,2 \FALSE
	CALL QUEUE,I-OUBLIETTE-FILLS,-1
	PRINTR "In a dazzling purple flash, more water freezes, forming a large icy cap over the outflow pipe in the channel. Water continues to pour in the inflow, and it spills over the edge of the channel and begins to fill the room."
?L7:	IN? ICEBERG,HERE /?L12
	MOVE ICEBERG,HERE
	SET 'ICED-OBJECT,ICEBERG
	PRINTR "The purple flash freezes a small ice floe in the frigid water. It has a nice flat top."
?L12:	PRINT NOTHING-HAPPENS
	RTRUE
?L1:	EQUAL? PRSO,AIR \?L14
	CALL V-SQUEEZE >STACK
	RSTACK
?L14:	EQUAL? PRSO,BOTTLE,WATER,LOCAL-WATER \?L15
	IN? LOCAL-WATER,BOTTLE \?L15
	REMOVE LOCAL-WATER
	REMOVE BOTTLE
	PRINTR "The water and bottle freeze and shatter into a million pieces!"
?L15:	CALL CTHE-PRINT-PRSO
	PRINTI " is covered with a thin film of ice."
	FSET? PRSO,PERSON \?L17
	PRINTI " "
	CALL CTHE-PRINT-PRSO
	PRINTI " shakes and shivers, and the ice cracks and peels away."
?L17:	CRLF
	RTRUE

	.FUNCT PARTIAL-BLOCKAGE,OBJ
	PRINTI "There is a purple flash, and in a burst of snow and freezing spray, the water in the channel freezes. But the water flow is so hard that "
	CALL THE-PRINT,OBJ
	PRINTR " is only partially blocked."

	.FUNCT PRE-LISKON
	EQUAL? SHRINK-FLAG,PRSO /?L3
	EQUAL? SHRINK-FLAG,PLAYER \?L1
	EQUAL? PRSO,ME \?L1
?L3:	PRINT NOTHING-HAPPENS
	RTRUE
?L1:	ZERO? SHRINK-FLAG /FALSE
	CALL I-LISKON,1 >STACK
	ZERO? STACK /FALSE
	CRLF
	RFALSE

	.FUNCT V-LISKON
	FSET? PRSO,PERSON \?L1
	CALL PRE-LISKON >STACK
	ZERO? STACK \TRUE
	CALL QUEUE,I-LISKON,15
	EQUAL? PRSO,0,ME /?L6
	SET 'SHRINK-FLAG,PRSO
	CALL CTHE-PRINT-PRSO
	PRINTI " shrinks to about a tenth of its former size."
	EQUAL? PRSO,OGRE \?L8
	PRINTI " He still looks mean."
?L8:	CRLF
	RTRUE
?L6:	SET 'SHRINK-FLAG,PLAYER
	SET 'SMALL-FLAG,1
	PRINTR "You feel very funny, sort of squashed and pushed and squeezed. Your surroundings are wavering, then growing, then wavering again. The feeling vanishes, but your surroundings are ten times their former size... or is it that you are one-tenth your former size?"
?L1:	PRINTR "Nothing happens, which is unsurprising, as this spell works only on living things."

	.FUNCT V-GNUSTO,SCROLL
	IN? SPELL-BOOK,WINNER /?L1
	PRINTI "The spell quests around in your hands, looking for your "
	PRINTD SPELL-BOOK
	PRINTR ", and not finding it, fades reluctantly."
?L1:	FSET? PRSO,SPELLBIT /?L3
	PRINT YOU-CANT
	PRINTI "inscribe "
	CALL PRINTA-PRSO
	PRINTI " in your "
	PRINTD SPELL-BOOK
	PRINTR "!"
?L3:	IN? PRSO,SPELL-BOOK \?L4
	PRINT YOU-HAVE
	PRINTI "that spell inscribed in your "
	PRINTD SPELL-BOOK
	PRINTR "!"
?L4:	LOC PRSO >STACK
	ZERO? STACK /?L5
	LOC PRSO >STACK
	IN? STACK,WINNER /?L5
	CALL MUST-HOLD-SCROLL >STACK
	RSTACK
?L5:	FSET? PRSO,RMUNGBIT \?L6
	PRINTR "The spell is unreadable."
?L6:	LOC PRSO >SCROLL
	FSET? SCROLL,RMUNGBIT \?L8
	CALL SCROLL-WET >STACK
	RSTACK
?L8:	FSET? SCROLL,SCROLLBIT \?L10
	CALL HELD?,SCROLL >STACK
	ZERO? STACK /?L10
	PRINTI "Your "
	PRINTD SPELL-BOOK
	PRINTI " begins to glow softly. "
	EQUAL? PRSO,GIRGOL-SPELL \?L11
	PRINTI "In a spectacular effort of magic, the powers of the gnusto spell attempt to copy the "
	PRINTD PRSO
	PRINTI " into your book, but the spell is too long, too complicated, and too powerful. The glow fades, but fortunately "
	CALL THE-PRINT,SCROLL
	PRINTR " remains intact."
?L11:	REMOVE SCROLL
	MOVE PRSO,SPELL-BOOK
	PUTP PRSO,P?COUNT,0
	PRINTI "Slowly, ornately, the words of the "
	PRINTD PRSO
	PRINTI " are inscribed, glowing even more brightly than the book itself. The book's brightness fades, but the spell remains!"
	EQUAL? SCROLL,DEAD-BOOK \?L14
	PRINTI " The old book in which it was written crumbles to dust"
	JUMP ?L16
?L14:	PRINTI " However, the scroll on which it was written vanishes"
?L16:	PRINTR " as the last word is copied."
?L10:	PRINTR "You must have the object from which you are copying in your hands before the gnusto spell will work on it."

	.FUNCT V-FROTZ,OLIT
	SET 'OLIT,LIT
	FSET? PRSO,ONBIT \?L1
	PRINTI "Have you forgotten that you already frotzed "
	CALL THE-PRINT-PRSO
	PRINTR "?"
?L1:	FSET? PRSO,TAKEBIT /?L4
	FSET? PRSO,PERSON \?L3
?L4:	FSET PRSO,ONBIT
	FSET PRSO,TOUCHBIT
	PRINTI "There is an almost blinding flash of light as "
	CALL PRINT-ID,STR?171
	EQUAL? PRSO,ME \?L5
	FSET WINNER,ONBIT
	PRINTI "you begin"
	JUMP ?L7
?L5:	CALL THE-PRINT-PRSO
	PRINTI " begins"
?L7:	PRINTI " to glow! It slowly fades to a less painful level, but "
	EQUAL? PRSO,ME \?L8
	PRINTI "you are"
	JUMP ?L10
?L8:	CALL THE-PRINT-PRSO
	PRINTI " is"
?L10:	PRINTI " now a serviceable light source."
	CRLF
	CALL LIT?,HERE >LIT
	ZERO? OLIT \TRUE
	ZERO? LIT /TRUE
	CRLF
	CALL V-LOOK
	RTRUE
?L3:	CALL V-NO-OP >STACK
	RSTACK

	.FUNCT V-MALYON
	CALL TIME-FROZEN? >STACK
	ZERO? STACK /?L1
	PRINT NOTHING-HAPPENS
	RTRUE
?L1:	FSET? PRSO,PERSON \?L3
	PRINTI "Wow! "
	PRINT IT-LOOKS-LIKE
	CALL THE-PRINT-PRSO
	PRINTR " is now alive! What a magician you are!"
?L3:	FSET? PRSO,TAKEBIT \?L4
	PRINTI "As you complete the spell, "
	CALL THE-PRINT-PRSO
	PRINTR " comes alive! It blinks, dances a little jig, and a moment later returns to normal."
?L4:	CALL V-NO-OP >STACK
	RSTACK

	.FUNCT V-REZROV
	FSET? PRSO,PERSON \?L1
	PRINTR "It might be a boon to surgeons if it worked, but it doesn't."
?L1:	FSET? PRSO,VEHBIT \?L3
	EQUAL? PRSO,ZIPPER /?L3
	PRINTR "It doesn't need opening."
?L3:	FSET? PRSO,CONTBIT /?L5
	FSET? PRSO,DOORBIT \?L4
?L5:	FSET? PRSO,OPENBIT \?L6
	CALL ALREADY-OPEN >STACK
	RSTACK
?L6:	CALL TIME-FROZEN? >STACK
	ZERO? STACK /?L8
	PRINT NOTHING-HAPPENS
	RTRUE
?L8:	FSET? PRSO,SCROLLBIT /?L9
	PRINTI "Silently, "
	CALL THE-PRINT-PRSO
	PRINTI " swings open"
	FIRST? PRSO >STACK \?L10
	PRINTI ", revealing "
	CALL PRINT-CONTENTS,PRSO
?L10:	EQUAL? PRSO,IRON-DOOR /?L13
	PRINTI ". Like swatting a fly with a sledge hammer, if you ask me"
?L13:	PRINT PERIOD
	FSET PRSO,OPENBIT
	RTRUE
?L9:	CALL V-NO-OP >STACK
	RSTACK
?L4:	CALL V-NO-OP >STACK
	RSTACK

	.FUNCT V-NO-OP
	PRINTR "Although you complete the spell, nothing has happened."

	.FUNCT V-YOMIN
	PRINTI "I'm afraid "
	CALL THE-PRINT-PRSO
	PRINTR " doesn't have much of a mind for you to read."

	.FUNCT BLANK-SCROLL-F,OT,DT
	EQUAL? PRSA,V?COPY \?L1
	IN? BURIN,WINNER /?L3
	CALL NO-BURIN >STACK
	RSTACK
?L3:	EQUAL? PRSI,BLANK-SCROLL \FALSE
	FSET? PRSI,RMUNGBIT \?L6
	CALL CTHE-PRINT-PRSI
	PRINTR " is too wet."
?L6:	FIRST? PRSI >STACK \?L7
	CALL ALREADY-USED >STACK
	RSTACK
?L7:	FSET? PRSO,SPELLBIT \FALSE
	LOC PRSO >STACK
	EQUAL? STACK,SPELL-BOOK,DEAD-BOOK \?L9
	PRINTR "Spell books are copy-protected to prevent spell thieves from making spell scrolls from another mage's spell book."
?L9:	EQUAL? PRSO,GIRGOL-SPELL \?L10
	CALL HELD?,MAGIC-CUBE >STACK
	ZERO? STACK \?L10
	PRINTR "You try hard to copy the obscure runes and ideographs of the spell, but your mind just can't comprehend them, and your fingers just can't follow the curves and strokes."
?L10:	GETPT PRSO,P?ADJECTIVE >DT
	GETPT SPELL-COPY,P?ADJECTIVE >OT
	GETB OT,0 >STACK
	PUTB DT,0,STACK
	GETB DT,1 >STACK
	PUTB OT,0,STACK
	GETP PRSO,P?TEXT >STACK
	PUTP SPELL-COPY,P?TEXT,STACK
	LOC PRSO >STACK
	MOVE SPELL-COPY,STACK
	FSET PRSO,RWATERBIT
	MOVE PRSO,PRSI
	PUTP SPELL-COPY,P?WALLS,PRSO
	CALL SPELL-TO-VERB >STACK
	PUTP SPELL-COPY,P?EXITS,STACK
	PRINTR "Copied."
?L1:	FIRST? PRSO >STACK /?L12
	EQUAL? PRSA,V?EXAMINE \?L13
	PRINT IT-LOOKS-LIKE
	PRINTR "a blank piece of vellum scroll paper."
?L13:	EQUAL? PRSA,V?READ \?L15
	PRINTR "This scroll is blank."
?L15:	EQUAL? PRSA,V?WRITE \FALSE
	EQUAL? PRSO,QWORD \?L16
	PRINTI "You should write spells, not random words, on spell paper."
	CRLF
	CALL PRINT-ID,STR?172 >STACK
	RSTACK
?L16:	EQUAL? PRSA,V?WRITE \FALSE
	FSET? PRSO,SPELLBIT /FALSE
	PRINTI "That's not a spell! You'll waste good spell paper!"
	CRLF
	CALL PRINT-ID,STR?173 >STACK
	RSTACK
?L12:	CALL SCROLL-F >STACK
	RSTACK

	.FUNCT KNIFE-F
	EQUAL? PRSA,V?CUT \FALSE
	EQUAL? PRSO,BREAD,FISH \FALSE
	PRINTI "You slice off a little piece and eat it. It tastes pretty good, but you really weren't feeling very hungry."
	CRLF
	CALL PRINT-ID,STR?174 >STACK
	RSTACK

	.FUNCT GUILD-HALL-F,RARG
	EQUAL? RARG,M-LOOK \FALSE
	PRINTI "This is the entrance to the Guild Hall in Borphee. To the north is the Council Chamber, and to the south is an exit leading outside."
	FSET? BREAD,TOUCHBIT \?L5
	FSET? FISH,TOUCHBIT /?L3
?L5:	PRINTI " Little is left of the sumptuous buffet lunch. Only "
	FSET? BREAD,TOUCHBIT /?L8
	PRINTI "a loaf of bread"
	FSET? FISH,TOUCHBIT /?L12
	PRINTI " and "
?L8:	FSET? FISH,TOUCHBIT /?L12
	PRINTI "some smoked fish"
?L12:	PRINTI " remains."
?L3:	CRLF
	RTRUE

	.FUNCT FROG-PSEUDO
	ZERO? CLEESHED? /?L1
	CALL REDIRECT,PSEUDO-OBJECT,GZORNENPLATZ >STACK
	RSTACK
?L1:	CALL AMPHIBIAN-PSEUDO >STACK
	RSTACK

	.FUNCT TOAD-PSEUDO
	ZERO? CLEESHED? /?L1
	CALL REDIRECT,PSEUDO-OBJECT,SNEFFLE >STACK
	RSTACK
?L1:	CALL AMPHIBIAN-PSEUDO >STACK
	RSTACK

	.FUNCT SALAMANDER-PSEUDO
	ZERO? CLEESHED? /?L1
	CALL REDIRECT,PSEUDO-OBJECT,HOOBLY >STACK
	RSTACK
?L1:	CALL AMPHIBIAN-PSEUDO >STACK
	RSTACK

	.FUNCT NEWT-PSEUDO
	ZERO? CLEESHED? /?L1
	CALL REDIRECT,PSEUDO-OBJECT,ARDIS >STACK
	RSTACK
?L1:	CALL AMPHIBIAN-PSEUDO >STACK
	RSTACK

	.FUNCT HELLBENDER-PSEUDO
	ZERO? CLEESHED? /?L1
	CALL REDIRECT,PSEUDO-OBJECT,ORKAN >STACK
	RSTACK
?L1:	CALL AMPHIBIAN-PSEUDO >STACK
	RSTACK

	.FUNCT AMPHIBIAN-PSEUDO
	ZERO? CLEESHED? /?L1
	PRINTR "They are hopping around so wildly it's hard to do anything with them."
?L1:	PRINTR "I think you had too much punch at lunch. There's no such thing here."

	.FUNCT SORCERER-F
	EQUAL? PRSA,V?TELL \?L1
	PRINT MORE-SPECIFIC
	PRINTR ". There are about ten of them around, including yourself."
?L1:	EQUAL? PRSA,V?EXAMINE \?L3
	ZERO? CLEESHED? /?L4
	PRINTR "The former mages are scuttling hither and yon across the floor."
?L4:	PRINTR "The mages, grouped loosely near you, are listening to the speakers."
?L3:	EQUAL? PRSA,V?COUNT \FALSE
	ZERO? CLEESHED? /?L8
	PRINTR "It's hard to tell. I assume there are still about ten."
?L8:	PRINTI "There are about ten, including you and "
	PRINTD ORKAN
	PRINTR ", the most eminent of the group, now that Belboz has retired."

	.FUNCT SPEAKER-F
	CALL REDIRECT,SPEAKER,ORATOR >STACK
	RSTACK

	.FUNCT COUNCIL-CHAMBER-F,RARG=0
	EQUAL? RARG,M-LOOK \?L1
	PRINTI "You are in the Council Chamber of the ancient Guild Hall at Borphee. To the south is the entry of the Guild Hall. "
	ZERO? CLEESHED? /?L3
	PRINTR "Scurrying wetly hither and yon around you are many brightly colored newts, efts, and salamanders. Toads and frogs hop excitedly about."
?L3:	PRINTI "There is a meeting of the guildmasters going on. You are standing among a group of about ten sorcerers, each the master of an Enchanters Guild chapter somewhere in the land."
	GRTR? OCOUNT,0 \?L6
	PRINTI " "
	PRINTD ORATOR
	PRINTI " is addressing the meeting."
?L6:	CRLF
	RTRUE
?L1:	EQUAL? RARG,M-BEG \FALSE
	ZERO? CLEESHED? \FALSE
	EQUAL? PRSA,V?WALK \?L12
	PRINTI "Annoyed guildmasters make way grudgingly. You hear muttering about ""arrogant enchanters"" as you try to leave the chamber. Finally, "
	PRINTD ORKAN
	PRINTR ", one of your colleagues, says, ""Stay. Be quiet. Don't embarrass us."""
?L12:	EQUAL? PRSA,V?SAY \?L14
	ZERO? PRSO \?L14
	CALL END-QUOTE
	PRINTD ORKAN
	PRINTR " quiets you. ""Interruptions will only annoy them."""
?L14:	EQUAL? PRSA,V?LISTEN \?L15
	ZERO? PRSO \?L15
	PRINTD ORATOR
	PRINTR " is speaking."
?L15:	CALL SPELL-VERB? >STACK
	ZERO? STACK /?L16
	PRINTD ORKAN
	PRINTR " stares at you in wonderment. ""Are you trying to get them even more mad at us?"" He makes a gesture of cancellation before you can finish the spell."
?L16:	CALL HOSTILE-VERB? >STACK
	ZERO? STACK /?L17
	FSET? PRSO,PERSON \?L17
	EQUAL? PRSO,ORKAN \?L18
	PRINTD ORKAN
	PRINTR " easily subdues you without causing undue disruption."
?L18:	PRINTD ORKAN
	PRINTR " grabs you and prevents your antisocial deed."
?L17:	EQUAL? PRSA,V?YAWN,V?SLEEP \FALSE
	PRINTR "Realizing how insulting you are being to the speaker, you try to stifle the yawn."

	.FUNCT ORKAN-F
	EQUAL? WINNER,ORKAN \?L1
	EQUAL? PRSA,V?TELL-ABOUT \?L3
	EQUAL? PRSO,ME /FALSE
?L3:	ZERO? CLEESHED? /?L5
	PRINTI "Orkan doesn't reply."
	CRLF
	JUMP ?L6
?L5:	PRINTI """Please! You should at least pretend to pay attention to these fools,"" whispers Orkan."
	CRLF
	CALL PRINT-ID,STR?175
?L6:	CALL END-QUOTE >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?EXAMINE \?L7
	ZERO? CLEESHED? /?L8
	PRINTR "Orkan is now a hellbender."
?L8:	PRINTD ORKAN
	PRINTR " is a large bear-like gentleman dressed in the traditional garb of a mage."
?L7:	EQUAL? PRSA,V?LISTEN \?L11
	ZERO? CLEESHED? \FALSE
	PRINTR "Orkan is listening to the speaker and suggests you do the same."
?L11:	EQUAL? PRSA,V?YOMIN \FALSE
	ZERO? CLEESHED? /FALSE
	PRINTR "You get a vague impression of hunger and annoyance at being dry."

	.FUNCT SNEFFLE-F
	EQUAL? WINNER,SNEFFLE \?L1
	EQUAL? PRSA,V?TELL-ABOUT \?L3
	EQUAL? PRSO,ME /FALSE
?L3:	ZERO? CLEESHED? /?L5
	PRINTI """Breep!"""
	CRLF
	JUMP ?L6
?L5:	PRINTI """Interrupting, eh? This is precisely what I was talking about!"" snorts "
	PRINTD SNEFFLE
	CALL PRINT-ID,STR?176
	PRINT PERIOD
?L6:	CALL END-QUOTE >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?EXAMINE \?L7
	ZERO? CLEESHED? /?L8
	PRINTR "Sneffle is now a tree toad."
?L8:	PRINTR "Sneffle is a small doughy gentleman whose person is splotched here and there with flour."
?L7:	EQUAL? PRSA,V?LISTEN \?L11
	ZERO? CLEESHED? \FALSE
	CALL LISTEN-TO-GUILDMASTER >STACK
	RSTACK
?L11:	EQUAL? PRSA,V?YOMIN \FALSE
	ZERO? CLEESHED? /FALSE
	PRINTR "Sneffle is searching intently for flies."

	.FUNCT LISTEN-TO-GUILDMASTER
	PRINTD PRSO
	PRINTI " is "
	EQUAL? PRSO,ORATOR \?L1
	PRINTR "making a speech."
?L1:	PRINTR "listening to the speaker."

	.FUNCT HOOBLY-F
	EQUAL? WINNER,HOOBLY \?L1
	EQUAL? PRSA,V?TELL-ABOUT \?L3
	EQUAL? PRSO,ME /FALSE
?L3:	ZERO? CLEESHED? /?L5
	PRINTI """Ssss!"""
	CRLF
	JUMP ?L7
?L5:	EQUAL? ORATOR,HOOBLY \?L6
	PRINTD HOOBLY
	PRINTI " pointedly ignores you."
	CRLF
	JUMP ?L7
?L6:	PRINTI """Your manners leave something to be desired! "
	PRINTD ORATOR
	PRINTI " is speaking!"" remarks "
	PRINTD HOOBLY
	CALL PRINT-ID,STR?177
	PRINT PERIOD
?L7:	CALL END-QUOTE >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?EXAMINE \?L8
	ZERO? CLEESHED? /?L9
	PRINTR "Hoobly has become a salamander."
?L9:	PRINTR "Hoobly is a large, florid, and solid-looking fellow who gives the appearance of being one of his own better customers."
?L8:	EQUAL? PRSA,V?YOMIN \FALSE
	ZERO? CLEESHED? /FALSE
	PRINTR "You get a strong feeling of torpidity."

	.FUNCT GZORNENPLATZ-F
	EQUAL? WINNER,GZORNENPLATZ \?L1
	EQUAL? PRSA,V?TELL-ABOUT \?L3
	EQUAL? PRSO,ME /FALSE
?L3:	ZERO? CLEESHED? /?L5
	PRINTI """Braaaak! Gleep?"""
	CRLF
	JUMP ?L6
?L5:	PRINTD GZORNENPLATZ
	PRINTI " glares at you."
	EQUAL? ORATOR,GZORNENPLATZ /?L7
	PRINTI " ""No doubt you don't wish the speakers to be heard. This is what I expect from such as you!"""
?L7:	CRLF
?L6:	CALL END-QUOTE >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?EXAMINE \?L10
	ZERO? CLEESHED? /?L11
	PRINTD GZORNENPLATZ
	PRINTR " has become a leopard frog."
?L11:	PRINTD GZORNENPLATZ
	PRINTR " is a tall, whipcord thin man with sandy blond hair. He is dressed in the traditional lincoln green of huntsmen."
?L10:	EQUAL? PRSA,V?YOMIN \FALSE
	ZERO? CLEESHED? /FALSE
	PRINTR "You feel a strong impression of intent, careful stalking of a beetle."

	.FUNCT ARDIS-F
	EQUAL? WINNER,ARDIS \?L1
	EQUAL? PRSA,V?TELL-ABOUT \?L3
	EQUAL? PRSO,ME /FALSE
?L3:	ZERO? CLEESHED? /?L5
	CALL UNINTERESTED,ARDIS
	JUMP ?L6
?L5:	PRINTI """You must wait your turn!"" screams "
	PRINTD ARDIS
	CALL PRINT-ID,STR?178
	PRINT PERIOD
?L6:	CALL END-QUOTE >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?EXAMINE \?L7
	ZERO? CLEESHED? /?L8
	PRINTR "Ardis has become a newt."
?L8:	PRINTR "Ardis is the muscular sort of poet (as opposed to the neurasthenic). He sports a full black beard, wild hair, and talks in a loud voice."
?L7:	EQUAL? PRSA,V?YOMIN \FALSE
	ZERO? CLEESHED? /FALSE
	PRINTR "You get a feeling of surprise and terror."

	.FUNCT GUILD-HALL-PSEUDO
	EQUAL? PRSA,V?THROUGH \?L1
	CALL DO-WALK,P?NORTH >STACK
	RSTACK
?L1:	CALL RANDOM-PSEUDO >STACK
	RSTACK

	.FUNCT MANSE-PSEUDO
	EQUAL? PRSA,V?EXAMINE \?L1
	PRINTR "It is a large, imposing building of great age."
?L1:	EQUAL? PRSA,V?THROUGH \FALSE
	PRINTR "The manse is closed to the public."

	.FUNCT GUARD-PSEUDO
	EQUAL? PRSA,V?EXAMINE \?L1
	PRINTR "He looks very zealous."
?L1:	EQUAL? PRSA,V?TELL,V?ASK-ABOUT \?L3
	PRINTI "The guard ignores you, intent on his duty."
	CRLF
	EQUAL? PRSA,V?TELL \TRUE
	CALL END-QUOTE >STACK
	RSTACK
?L3:	EQUAL? PRSA,V?SHOW,V?GIVE,V?OFFER \?L7
	PRINTR "Trying to bribe the guard, eh?"
?L7:	CALL HOSTILE-VERB? >STACK
	ZERO? STACK /?L8
	PRINTI "That would be incredibly dangerous."
	CRLF
	EQUAL? PRSA,V?KILL /?L9
	PUSH 1
	JUMP ?L10
?L9:	PUSH 0
?L10:	CALL PRINT-ID,STR?179,STACK
	EQUAL? PRSA,V?KILL /?L11
	PUSH 0
	JUMP ?L12
?L11:	PUSH 1
?L12:	CALL PRINT-ID,STR?180,STACK >STACK
	RSTACK
?L8:	CALL SPELL-VERB? >STACK
	ZERO? STACK /FALSE
	PRINTR "Nothing happens, as the mayoral guards are quite well-protected from spells."

	.FUNCT BELWIT-SQUARE-F,RARG
	EQUAL? RARG,M-LOOK \?L1
	PRINTI "This is "
	PRINTD HERE
	PRINTI ". "
	FSET? CLOUD,INVISIBLE /?L3
	PRINTR "Its many historic and picturesque buildings are obscured by a cloud of orange smoke."
?L3:	PRINTR "To the north is the ancient Guild Hall. A wide cobblestone street runs east and west. To the south is the storied Manse, home of the Mayors of Borphee for generations."
?L1:	EQUAL? RARG,M-BEG \?L6
	FSET? CLOUD,INVISIBLE /?L6
	EQUAL? PRSA,V?WALK \?L7
	PRINT YOU-CANT-SEE
	PRINTI "well enough to find your way out"
	PRINT PERIOD
	RTRUE
?L7:	EQUAL? PRSO,CLOUD /FALSE
	EQUAL? PRSA,V?FIND,V?LOOK,V?TAKE /?L11
	EQUAL? PRSA,V?EXAMINE,V?TELL,V?ASK-ABOUT \?L10
?L11:	CALL HELD?,PRSO >STACK
	ZERO? STACK \?L10
	PRINT YOU-CANT-SEE
	PRINTR "anything, what with the smokey orange cloud that blankets the square."
?L10:	EQUAL? PRSA,V?DROP \?L12
	CALL IDROP >STACK
	ZERO? STACK /TRUE
	PRINTI "Dropped, but you lose it in the smoke."
	CRLF
	CALL PRINT-ID,STR?181 >STACK
	RSTACK
?L12:	EQUAL? PRSA,V?SMELL \FALSE
	ZERO? PRSO \FALSE
	CALL SMELL-CLOUD >STACK
	RSTACK
?L6:	EQUAL? RARG,M-ENTER \FALSE
	FSET? DEATH-CUBE,TOUCHBIT \FALSE
	ZERO? SAMARRA? \FALSE
	SET 'SAMARRA?,1
	CALL QUEUE,I-SAMARRA,1 >STACK
	RSTACK

	.FUNCT SHADOW-DESC,RARG,OBJ
	ZERO? CLEESHED? /FALSE
	PRINTI "A "
	PRINTD SHADOW
	PRINTI " in a dark cloak "
	EQUAL? HERE,GUILD-HALL,COUNCIL-CHAMBER \?L3
	PRINTI "is running out the door"
	JUMP ?L6
?L3:	EQUAL? HERE,BELWIT-SQUARE \?L5
	PRINTI "flees across the square"
	JUMP ?L6
?L5:	PRINTI "is here"
?L6:	PRINT PERIOD
	RTRUE

	.FUNCT SHADOW-F
	EQUAL? HERE,CASTLE \?L3
	IN? SHADOW,CASTLE /?L1
?L3:	EQUAL? WINNER,SHADOW \?L4
	CALL END-QUOTE
	PRINTR "What shadow?"
?L4:	ZERO? CLEESHED? \?L6
	EQUAL? PRSA,V?FIND \?L6
	RANDOM 100 >STACK
	LESS? 33,STACK /?L6
	PRINTR "There is a figure wearing a dark cloak on the other side of the room, but almost the moment you catch sight of it, it disappears."
?L6:	EQUAL? PRSA,V?EXAMINE \?L7
	PRINTI "I don't see any "
	PRINTD SHADOW
	PRINTR " anywhere."
?L7:	EQUAL? PRSA,V?ASK-ABOUT,V?TELL-ABOUT,V?TELL-ME-ABOUT /FALSE
	EQUAL? PRSA,V?FOLLOW \?L9
	IN? SHADOW,HERE /?L9
	EQUAL? HERE,COUNCIL-CHAMBER,GUILD-HALL \?L10
	CALL DO-WALK,P?SOUTH >STACK
	RSTACK
?L10:	PRINTR "Where it went, I doubt you can follow."
?L9:	PRINTR "There is no sign of such a person."
?L1:	EQUAL? HERE,CASTLE \FALSE
	EQUAL? WINNER,SHADOW \?L15
	CALL TIME-FROZEN? >STACK
	ZERO? STACK /?L17
	CALL IMMOBILE
	CALL END-QUOTE >STACK
	RSTACK
?L17:	PRINTR """All will be revealed in due time."""
?L15:	EQUAL? PRSA,V?GIVE \?L20
	GETP PRSO,P?CUBE >STACK
	ZERO? STACK /?L20
	MOVE PRSO,HERE
	FSET PRSO,NDESCBIT
	CALL CTHE-PRINT,SHADOW
	PRINTR " snatches it greedily."
?L20:	CALL HOSTILE-VERB? >STACK
	ZERO? STACK /?L21
	EQUAL? TIME-STOPPED?,HERE \?L22
	PRINTI "The frozen shadow is impervious to harm."
	CRLF
	CALL PRINT-ID,STR?182 >STACK
	RSTACK
?L22:	CALL FREEZES-YOU >STACK
	RSTACK
?L21:	EQUAL? PRSA,V?ESPNIS \?L25
	EQUAL? HERE,TIME-STOPPED? \?L26
	PRINT NOTHING-HAPPENS
	RTRUE
?L26:	PRINTI "The shadow begins to nod off but with great effort resists and awakens. "
	CALL FREEZES-YOU >STACK
	RSTACK
?L25:	EQUAL? PRSA,V?YOMIN \?L29
	PRINTI "You feel your own innermost desires, petty jealousies, and unworthy thoughts magnified a thousand times."
	CRLF
	CALL PRINT-ID,STR?183 >STACK
	RSTACK
?L29:	EQUAL? PRSA,V?EXAMINE \?L30
	CALL CTHE-PRINT,SHADOW
	PRINTR " is hard to see, almost as though some spell is acting to obscure it. It's clad in a dark cloak with a hood, and it blends into the background in a disturbing way."
?L30:	EQUAL? PRSA,V?TELL \?L31
	ZERO? FROZEN? /?L31
	PRINTI "You cannot speak."
	CRLF
	CALL END-QUOTE >STACK
	RSTACK
?L31:	EQUAL? PRSA,V?EMPATHIZE \?L32
	PRINTR "You sense in return a blast of cold."
?L32:	ZERO? FROZEN? \FALSE
	GRTR? SHADOW-COUNT,4 \FALSE
	LESS? SHADOW-COUNT,8 \FALSE
	EQUAL? PRSA,V?TELL \?L34
	CALL FREEZES-YOU >STACK
	RSTACK
?L34:	CALL NO-CLOCK-VERB? >STACK
	ZERO? STACK \FALSE
	EQUAL? PRSA,V?EXAMINE,V?LOOK,V?WAIT /FALSE
	EQUAL? PRSA,V?LOOK-INSIDE /FALSE
	CALL FREEZES-YOU >STACK
	RSTACK

	.FUNCT CLOUD-F
	EQUAL? PRSA,V?EXAMINE \?L1
	PRINTI "This is a fairly standard "
	PRINTD PRSO
	PRINTI ", a side effect of a certain class of teleportation spells. These spells are favored by those of a less than honest nature, as the "
	PRINTD PRSO
	PRINTR " serves to conceal their usually hasty departures."
?L1:	EQUAL? PRSA,V?THROUGH \?L3
	PRINT YOU-ARE
	PRINTR " in the middle of it."
?L3:	EQUAL? PRSA,V?SMELL \FALSE
	CALL SMELL-CLOUD >STACK
	RSTACK

	.FUNCT SMELL-CLOUD
	PRINTR "It smells vaguely of orange peels, but the predominant motif is less pleasant and more acrid."

	.FUNCT CASTLE-F,RARG,F
	EQUAL? RARG,M-LOOK \?L1
	PRINTR "This is the audience chamber. It is high and spacious, and every proportion and decoration is intended to highlight the throne that looms before you. The throne itself is bathed in light, but only featureless gray may be seen through the windows and skylights."
?L1:	EQUAL? RARG,M-BEG \?L3
	EQUAL? PRSA,V?EXAMINE,V?WAIT,V?LOOK /FALSE
	CALL NO-CLOCK-VERB? >STACK
	ZERO? STACK \FALSE
	ZERO? FROZEN? /?L7
	EQUAL? FROZEN?,1 \?L8
	EQUAL? TIME-STOPPED?,HERE /FALSE
	PRINTI "You clumsily attempt to "
	CALL SPELL-VERB? >STACK
	ZERO? STACK /?L12
	PRINTI "cast the spell."
	JUMP ?L14
?L12:	PRINTI "do it."
?L14:	LESS? SHADOW-COUNT,8 /?L17
	CALL SPELL-VERB? >STACK
	ZERO? STACK \?L17
	CALL HOSTILE-VERB? >STACK
	ZERO? STACK \?L17
	EQUAL? PRSO,SHADOW \TRUE
?L17:	PRINTI " "
	CALL FREEZES-YOU
	RTRUE
?L8:	PRINTI "You are frozen."
	CRLF
	CALL PRINT-ID,STR?184 >STACK
	RSTACK
?L7:	EQUAL? PRSA,V?LEARN \?L21
	PRINTI "Something about this place prevents you. It's unsettling."
	CRLF
	CALL PRINT-ID,STR?185 >STACK
	RSTACK
?L21:	EQUAL? PRSA,V?TAKE \?L22
	EQUAL? TIME-STOPPED?,HERE \?L23
	ZERO? P-MULT /?L25
	PRINTI "As you try to decide what to take first, the spell wears off! "
	CALL FREEZES-YOU
	RETURN 2
?L25:	EQUAL? PRSO,MAGIC-CUBE \?L29
	EQUAL? SHADOW-COUNT,9 \?L29
	MOVE MAGIC-CUBE,WINNER
	FCLEAR MAGIC-CUBE,NDESCBIT
	PRINTR "You tug and pull at the cube, trying desperately to remove it from its place in the center of the tesseract. With your last reserve of strength you free it!"
?L29:	GETP PRSO,P?CUBE >STACK
	ZERO? STACK /?L30
	FSET? PRSO,NDESCBIT \?L30
	PRINTI "You can no longer see "
	CALL THE-PRINT-PRSO
	PRINTR " in the blaze of light."
?L30:	CALL ITAKE >STACK
	EQUAL? STACK,1 \TRUE
	PRINT TAKEN
	RTRUE
?L23:	IN? SHADOW,HERE \FALSE
	CALL FREEZES-YOU >STACK
	RSTACK
?L22:	EQUAL? PRSA,V?PUT \?L35
	EQUAL? PRSI,HYPERCUBE \?L35
	EQUAL? PRSO,ME \?L36
	CALL PERFORM,V?BOARD,PRSI
	RTRUE
?L36:	EQUAL? TIME-STOPPED?,HERE \?L38
	FIRST? HYPERCUBE >F \?L39
	CALL CTHE-PRINT,F
	PRINTR " is already there."
?L39:	MOVE PRSO,HYPERCUBE
	FSET PRSO,NDESCBIT
	PRINTI "You push "
	CALL THE-PRINT-PRSO
	PRINTR " into the hypercube, where it hangs unsupported."
?L38:	IN? SHADOW,HERE \FALSE
	CALL FREEZES-YOU >STACK
	RSTACK
?L35:	EQUAL? PRSA,V?BOARD \?L44
	IN? SHADOW,HERE \?L44
	EQUAL? TIME-STOPPED?,HERE /?L44
	CALL FREEZES-YOU >STACK
	RSTACK
?L44:	EQUAL? PRSA,V?JINDAK \FALSE
	PRINTR "Everything glows."
?L3:	EQUAL? RARG,M-ENTER \FALSE
	IN? SHADOW,HERE /?L48
	CALL QUEUE,I-SHADOW-ARRIVES,2
	JUMP ?L50
?L48:	CALL QUEUE,I-SHADOW,-1
?L50:	PRINTI "Mocking laughter echoes around you."
	CRLF
	CRLF
	RTRUE

	.FUNCT HYPERCUBE-F
	EQUAL? PRSA,V?EXAMINE \?L1
	PRINTR "It floats in front of you, glowing and tumbling."
?L1:	EQUAL? PRSA,V?LEAP \FALSE
	PRINTR "Though tempted, you cannot bring yourself to do it."

	.FUNCT BURIN-F
	EQUAL? PRSA,V?EXAMINE \?L1
	PRINTR "This is a magical burin, used for inscribing objects with words or runes of magical import. Such a burin also gives you the ability to write spell scrolls."
?L1:	EQUAL? PRSA,V?WHAT \FALSE
	PRINTR "A burin is an engraving and writing tool."

	.FUNCT DULL-ROOM-F,RARG
	EQUAL? RARG,M-LOOK \?L1
	PRINTR "This is a drab, nondescript room. The only exit leads south."
?L1:	EQUAL? RARG,M-LEAVE \FALSE
	CALL RECOVER-CUBE >STACK
	RSTACK

	.FUNCT DULL-ROOM-EXIT
	EQUAL? DULL-ROOM-RETURN,CASTLE \?L1
	CALL MAGIC-DOOR-EXIT >STACK
	RSTACK
?L1:	RETURN DULL-ROOM-RETURN

	.FUNCT EARTH-ROOM-F,RARG
	EQUAL? RARG,M-LOOK \?L1
	PRINTR "This is a small room crudely constructed of packed earth, mud, and sod. Crudely framed openings of wood tied with leather thongs lead off in each of the four cardinal directions, and a muddy hole leads down."
?L1:	EQUAL? RARG,M-LEAVE \FALSE
	CALL RECOVER-CUBE >STACK
	RSTACK

	.FUNCT HALL-OF-STONE-F,RARG
	EQUAL? RARG,M-LOOK \?L1
	PRINTR "This is a long hall built of crudely dressed stone. The blocks are as tall as you and the ceiling invisible in the gloom above. Dirt trickles from gaps in the walls and ceiling. The atmosphere is oppressive, and there is a dry, stale smell all around. The corridor extends north and south from here."
?L1:	EQUAL? RARG,M-BEG \FALSE
	EQUAL? PRSA,V?SMELL \FALSE
	ZERO? PRSO \FALSE
	PRINTR "It smells dry and stale."

	.FUNCT SNAKE-EYE-PSEUDO
	CALL REDIRECT,PSEUDO-OBJECT,EYES >STACK
	RSTACK

	.FUNCT SNAKE-SCALES-PSEUDO
	EQUAL? PRSA,V?EXAMINE /?L3
	CALL HOSTILE-VERB? >STACK
	ZERO? STACK /FALSE
?L3:	CALL HACK-SNAKE >STACK
	RSTACK

	.FUNCT HACK-SNAKE
	PRINTI "The steel-like scales are "
	EQUAL? PRSA,V?RUB \?L1
	PRINTI "cool to the touch"
	JUMP ?L3
?L1:	PRINTI "impervious to your puny strength"
	CALL PRINT-ID,STR?186
?L3:	PRINT PERIOD
	RTRUE

	.FUNCT SNAKE-ROOM-EXIT
	EQUAL? SHRINK-FLAG,SNAKE \?L1
	EQUAL? P-WALK-DIR,P?NORTH,P?SOUTH \?L3
	PRINTI "The snake is pleasurably stretching its mouth and rippling its scaly body in the unaccustomed space. It barely hisses as you go by."
	CRLF
	CRLF
	EQUAL? HERE,SOUTH-SNAKE-ROOM \?L5
	RETURN NORTH-SNAKE-ROOM
?L5:	RETURN SOUTH-SNAKE-ROOM
?L3:	PRINTI "Avoiding the snake, you carefully head "
	EQUAL? P-WALK-DIR,P?EAST \?L9
	PUSH STR?187
	JUMP ?L11
?L9:	PUSH STR?188
?L11:	PRINT STACK
	PRINTI ". The corridor is smooth and circular. It eventually leads back to where you started."
	CRLF
	CRLF
	RETURN HERE
?L1:	EQUAL? P-WALK-DIR,P?NORTH,P?SOUTH \?L12
	PRINTI "The serpent completely fills the passage."
	CRLF
	RFALSE
?L12:	PRINTI "The serpent fills the entire corridor. There is no space to squeeze by."
	CRLF
	RFALSE

	.FUNCT SNAKE-ROOM-F,RARG,N?
	EQUAL? RARG,M-LOOK \?L1
	PRINTI "Here a long north-south corridor meets an east-west cross corridor whose walls are polished to almost mirror smoothness. Just to your "
	EQUAL? HERE,NORTH-SNAKE-ROOM /?L5
	SET 'N?,0
	JUMP ?L3
?L5:	SET 'N?,1
	PRINTI "south"
	JUMP ?L7
?L3:	PRINTI "north"
?L7:	EQUAL? SHRINK-FLAG,SNAKE \?L8
	PRINTR " is a large snake whose head pokes out of one side of the cross corridor and the tip of whose tail pokes out the other side. You can see that ahead is more of the crudely built main hall, and beyond that is a dark area."
?L8:	PRINTR " is a huge scaly mass which fills the entire cross corridor. Its thickness is more than three times your height and its length is unguessable."
?L1:	EQUAL? RARG,M-ENTER \FALSE
	FSET? SOUTH-SNAKE-ROOM,TOUCHBIT /FALSE
	CALL QUEUE,I-SNAKE,1 >STACK
	RSTACK

	.FUNCT SNAKE-F
	EQUAL? WINNER,SNAKE \?L1
	CALL TIME-FROZEN? >STACK
	ZERO? STACK /?L3
	CALL IMMOBILE
	RTRUE
?L3:	PRINTI """Sssss..."" You can't understand the "
	PRINTD SNAKE
	PRINT PERIOD
	CALL END-QUOTE >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?EXAMINE \?L6
	EQUAL? SNAKE,SHRINK-FLAG \?L7
	PRINTI "The snake is no longer gargantuan. Its tail sticks out one side of the corridor and its head the other, no longer filling the corridor."
	JUMP ?L10
?L7:	PRINTI "It is huge, filling the entire corridor it occupies."
	CALL TIME-FROZEN? >STACK
	ZERO? STACK \?L10
	PRINTI " It stares at you balefully, hissing like a small steam engine. It appears completely unconcerned that it has swallowed its own tail."
?L10:	CALL TIME-FROZEN? >STACK
	ZERO? STACK /?L13
	PRINTI " "
	CALL IMMOBILE
	RTRUE
?L13:	CRLF
	RTRUE
?L6:	EQUAL? PRSA,V?BOARD,V?CLIMB-FOO,V?CLIMB-UP /?L17
	EQUAL? PRSA,V?CLIMB-OVER,V?CLIMB-ON \?L16
?L17:	PRINTI "The scales are too slippery"
	CALL PRINT-ID,STR?189
	CALL TIME-FROZEN? >STACK
	ZERO? STACK \?L18
	PRINTI ", and the serpent's eye fixes you with a stare that removes much of your interest in getting that close"
	JUMP ?L20
?L18:	PRINTI ". "
	CALL IMMOBILE
	RTRUE
?L20:	PRINT PERIOD
	RTRUE
?L16:	EQUAL? PRSA,V?LISTEN \?L21
	PRINTR "It sounds like a leaky steam engine."
?L21:	CALL HOSTILE-VERB? >STACK
	ZERO? STACK /?L22
	CALL HACK-SNAKE >STACK
	RSTACK
?L22:	EQUAL? PRSA,V?THROW-OFF \?L23
	EQUAL? SHRINK-FLAG,SNAKE /?L24
	MOVE PRSO,HERE
	CALL CTHE-PRINT-PRSO
	PRINTI " hits the snake and drops to the floor."
	CRLF
	CALL PRINT-ID,STR?190 >STACK
	RSTACK
?L24:	CALL PERFORM,V?THROW,PRSO
	RTRUE
?L23:	EQUAL? PRSA,V?GIVE \?L27
	CALL UNINTERESTED,SNAKE >STACK
	RSTACK
?L27:	EQUAL? PRSA,V?RUB \?L28
	CALL HACK-SNAKE >STACK
	RSTACK
?L28:	EQUAL? PRSA,V?TAKE \?L29
	PRINTI "The creature is taller than a house, and longer than the tallest tree is tall."
	CRLF
	CALL PRINT-ID,STR?191 >STACK
	RSTACK
?L29:	EQUAL? PRSA,V?FROTZ \?L30
	PRINTR "The snake glows dimly as the spell stretches to cover it, but then the glow winks out."
?L30:	EQUAL? PRSA,V?LISKON \?L31
	EQUAL? SHRINK-FLAG,SNAKE \?L32
	PRINT NOTHING-HAPPENS
	RTRUE
?L32:	CALL PRE-LISKON >STACK
	ZERO? STACK \FALSE
	SET 'SHRINK-FLAG,SNAKE
	CALL QUEUE,I-LISKON,15
	PRINTR "The serpent shrinks. You can see it thinning out, filling less and less of the corridor. At first it doesn't seem to be growing any shorter, but then you realize that this isn't true. It has swallowed so much of its own tail that it makes up the deficiency by disgorging more tail. Finally, just before the spell stops, the tail tip slips out of the snake's mouth and almost disappears down the western corridor."
?L31:	EQUAL? PRSA,V?SNAVIG \?L36
	SET 'AWAKE,5
	CALL QUEUE,I-TIRED,5
	PRINTI "The spell strains to change you into a serpent, but you're just too small. Finally, you snap back to your normal appearance, and you feel very, very tired."
	CRLF
	CALL PRINT-ID,STR?192 >STACK
	RSTACK
?L36:	EQUAL? PRSA,V?GIRGOL \?L37
	EQUAL? SHRINK-FLAG,SNAKE \FALSE
	PRINT NOTHING-HAPPENS
	RTRUE
?L37:	EQUAL? PRSA,V?YOMIN \?L41
	CALL CTHE-PRINT,SNAKE
	PRINTI " is "
	EQUAL? SHRINK-FLAG,SNAKE \?L42
	PRINTR "almost overcome by the sheer joy of being able to writhe and stretch."
?L42:	PRINTR "bored, constricted, and caged. It's in a surly mood, thinking of its past. It was once a simple temple snake, well fed on sacrifices. It was too well fed, for it grew great, and its pride grew as well. For declaring itself the greatest of snakes, it was prisoned here, forced to swallow its own tail in mimicry of the true master of serpents. That was an age ago."
?L41:	EQUAL? PRSA,V?ESPNIS \FALSE
	PRINTR "The snake yawns briefly, but the spell is too attenuated by the creature's huge mass to do more."

	.FUNCT TEMPLE-ROOM-F,RARG
	EQUAL? RARG,M-LOOK \?L1
	PRINTI "This is a ruined temple to a forgotten god. Black basalt pillars reach to the ceiling, but some are broken and lie in huge fragments on the ground. The air is stale and filled with the odor of decay. Bats roost in the rafters, the only remaining worshippers. Before the temple "
	ZERO? IDOL-ASLEEP? /?L3
	PUSH STR?193
	JUMP ?L5
?L3:	PUSH STR?194
?L5:	PRINT STACK
	PRINTI " a tall basalt idol in the form of a huge rodent. Its fang-bedecked mouth is "
	ZERO? IDOL-YAWNING? /?L6
	PRINTR "open in an embarrassing yawn."
?L6:	ZERO? IDOL-ASLEEP? /?L8
	PRINTR "closed tightly."
?L8:	PRINTR "open slightly, exposing teeth and tongue."
?L1:	EQUAL? RARG,M-BEG \FALSE
	EQUAL? PRSA,V?SMELL \FALSE
	EQUAL? PRSO,0,GLOBAL-ROOM \FALSE
	PRINTI "It smells of decay, rot, and centuries-long accumulation of bat guano."
	CRLF
	CALL PRINT-ID,STR?195 >STACK
	RSTACK

	.FUNCT IDOL-F,RARG=0
	EQUAL? RARG,M-BEG \?L1
	FSET MOUTH,SEARCHBIT
	EQUAL? PRSA,V?CLIMB-DOWN,V?DISEMBARK /?L5
	EQUAL? PRSA,V?WALK \?L6
	EQUAL? P-WALK-DIR,P?DOWN \?L3
?L5:	MOVE PLAYER,HERE
	PRINTR "You climb off the idol."
?L3:	EQUAL? PRSA,V?WALK \?L6
	PRINT YOU-HAVE-TO
	PRINTR " climb down first."
?L6:	EQUAL? PRSA,V?BOARD,V?CLIMB-FOO,V?CLIMB-ON /?L8
	EQUAL? PRSA,V?CLIMB-UP,V?THROUGH \?L7
?L8:	EQUAL? PRSO,IDOL \?L7
	PRINTR "You are clinging to the idol already."
?L7:	EQUAL? PRSA,V?LEAP \?L9
	MOVE PLAYER,HERE
	PRINTR "You carelessly leap off the idol."
?L9:	EQUAL? PRSA,V?TAKE \?L10
	FSET? PRSO,TAKEBIT \?L10
	CALL NOT-IN-VEHICLE? >STACK
	ZERO? STACK /?L10
	CALL CANT-REACH-THAT >STACK
	RSTACK
?L10:	EQUAL? PRSA,V?DROP \FALSE
	EQUAL? PRSO,OPAL,IDOL /FALSE
	CALL IDROP >STACK
	ZERO? STACK /TRUE
	MOVE PRSO,HERE
	PRINTR "Dropped."
?L1:	ZERO? RARG \FALSE
	FSET IDOL,SEARCHBIT
	EQUAL? PRSA,V?EXAMINE \?L18
	PRINTI "The idol is carved of black basalt. It is about twenty feet tall and represents a gigantic and ferocious rodent-like creature with sharp teeth and one staring"
	IN? OPAL,IDOL \?L20
	ZERO? OPAL-LOOSE? \?L20
	PRINTI " opalescent eye"
	JUMP ?L22
?L20:	PRINTI ", empty eye socket"
?L22:	PRINTI "."
	IN? PLAYER,IDOL /?L23
	PRINTI " The sculpture is rough enough to offer climbing holds."
?L23:	ZERO? IDOL-YAWNING? /?L26
	PRINTR " Oddly, the idol is yawning, its mouth gaping open."
?L26:	ZERO? IDOL-ASLEEP? /?L28
	PRINTI " The idol is sculpted as though sound asleep."
?L28:	CRLF
	RTRUE
?L18:	EQUAL? PRSA,V?GIVE,V?SEARCH,V?TELL /?L31
	EQUAL? PRSA,V?HELLO,V?TAKE,V?WAVE-AT \?L30
?L31:	FSET? IDOL,PERSON \?L30
	EQUAL? PRSA,V?TELL \?L32
	CALL END-QUOTE
?L32:	CALL JIGS-UP,IDOL-CRUSHES-YOU >STACK
	RSTACK
?L30:	EQUAL? PRSA,V?TAKE \?L35
	PRINTR "The idol reaches all the way to the ceiling and is made of basalt. This is beyond your strength."
?L35:	CALL HOSTILE-VERB? >STACK
	ZERO? STACK /?L36
	FSET? IDOL,PERSON \?L37
	CALL JIGS-UP,IDOL-CRUSHES-YOU >STACK
	RSTACK
?L37:	PRINT WASTE-OF-TIME
	RTRUE
?L36:	EQUAL? PRSA,V?LOOK-INSIDE \?L40
	CALL PERFORM,PRSA,MOUTH
	RTRUE
?L40:	EQUAL? PRSA,V?KISS,V?RUB \?L41
	FSET? IDOL,PERSON \?L42
	CALL JIGS-UP,IDOL-CRUSHES-YOU >STACK
	RSTACK
?L42:	PRINTR "The idol is stonelike to the touch."
?L41:	EQUAL? PRSA,V?BOARD,V?CLIMB-FOO,V?CLIMB-ON /?L46
	EQUAL? PRSA,V?CLIMB-UP \?L45
?L46:	FSET? IDOL,PERSON \?L47
	CALL JIGS-UP,IDOL-CRUSHES-YOU >STACK
	RSTACK
?L47:	MOVE PLAYER,IDOL
	ZERO? IDOL-ASLEEP? /?L50
	PRINTR "Okay, you are now on the sleeping idol."
?L50:	PRINTR "You can find enough holds to climb all the way up to the head, where you gaze warily at the idol's mouth."
?L45:	EQUAL? PRSA,V?MALYON \?L53
	FSET? IDOL,PERSON \?L54
	PRINTR "It looks pretty animated to me."
?L54:	FSET MOUTH,SEARCHBIT
	PRINTI "The idol quivers, comes to life,"
	CALL ROB,MOUTH,0,AIR-CUBE >STACK
	ZERO? STACK /?L57
	REMOVE AIR-CUBE
	CALL LIT?,HERE >LIT
	PRINTI " swallows,"
?L57:	ZERO? IDOL-ASLEEP? /?L60
	PRINTI " gets to its feet"
?L60:	PRINTI " and "
	IN? PLAYER,IDOL \?L63
	PRINTI "notices you climbing on it (no doubt from the itching). It grabs for you, and you try to escape. Its razor-sharp claws snatch you up to its greedy mouth"
	IN? AIR-CUBE,MOUTH \?L65
	PRINTI ", where you can see the white cube on its tongue as you are swallowed"
?L65:	PRINTI "."
	CALL PRINT-ID,STR?196
	CALL JIGS-UP >STACK
	RSTACK
?L63:	SET 'IDOL-SLEEPED?,0
	SET 'IDOL-YAWNING?,0
	SET 'IDOL-ASLEEP?,0
	CALL QUEUE,I-UNMALYON-IDOL,4
	CALL QUEUE,I-IDOL,2
	CALL QUEUE,I-FULL-YAWN,0
	CALL QUEUE,I-IDOL-ASLEEP,0
	FSET IDOL,PERSON
	PRINTI "begins "
	CALL TELL-IDOL-ACTION
	PRINTR " suspiciously (and hungrily) around. Fortunately it doesn't notice you."
?L53:	EQUAL? PRSA,V?LISKON \?L69
	FSET? IDOL,PERSON \FALSE
	PRINTR "While the idol appears to be made of ""malyoned"" basalt, it must actually be made of something denser, as this spell has no effect on it."
?L69:	EQUAL? PRSA,V?ESPNIS \?L73
	CALL CTHE-PRINT,IDOL
	FSET? IDOL,PERSON \?L74
	SET 'IDOL-SLEEPED?,1
	CALL QUEUE,I-FULL-YAWN,2
	CALL QUEUE,I-IDOL-ASLEEP,3
	PRINTR " suddenly looks very tired and begins to yawn. You can see the idol fighting it but losing."
?L74:	PRINTR " doesn't seem to be very wakeful to me."
?L73:	EQUAL? PRSA,V?YOMIN \?L77
	FSET? IDOL,PERSON \FALSE
	ZERO? IDOL-SLEEPED? \?L82
	ZERO? IDOL-YAWNING? \?L82
	ZERO? IDOL-ASLEEP? /?L80
?L82:	PRINTR "You sense a great tiredness, as though these few exertions dissipated a thousand years of strength."
?L80:	PRINTR "You sense a raging anger at the abandonment of its temple, a desire for the destruction of its former worshippers, and an incandescent hatred for bats."
?L77:	EQUAL? PRSA,V?SNAVIG \FALSE
	FSET? IDOL,PERSON \FALSE
	CALL PRINT-ID,STR?197
	CALL JIGS-UP,STR?198 >STACK
	RSTACK

	.FUNCT TEETH-F
	EQUAL? PRSA,V?EXAMINE \?L1
	PRINTR "They are razor sharp."
?L1:	EQUAL? PRSA,V?MUNG,V?ATTACK \FALSE
	PRINTR "The teeth are stone hard."

	.FUNCT MOUTH-F,RARG=0
	EQUAL? RARG,M-CONTAINER \?L1
	EQUAL? PRSA,V?TAKE \?L3
	IN? PLAYER,IDOL /?L5
	PRINT YOU-HAVE-TO
	PRINTR " climb up to the mouth first."
?L5:	FSET? IDOL,PERSON \?L7
	PRINTR "The outcome would be fatal."
?L7:	ZERO? IDOL-ASLEEP? /?L8
	PRINTR "The idol's mouth is shut tightly."
?L8:	EQUAL? PRSO,AIR-CUBE \FALSE
	IN? AIR-CUBE,MOUTH \FALSE
	ZERO? IDOL-YAWNING? /?L10
	CALL ITAKE >STACK
	EQUAL? STACK,1 \TRUE
	PRINT TAKEN
	RTRUE
?L10:	PRINTI "You can see the cube, tantalizingly close, but your "
	EQUAL? SHRINK-FLAG,WINNER \?L16
	PRINTI "arm is too short to reach"
	JUMP ?L18
?L16:	PRINTI "hand is too big to fit between the razor-sharp teeth"
?L18:	PRINTR ". If only its mouth were open! Glancing at the size of the fangs, maybe it's just as well."
?L3:	EQUAL? PRSA,V?MOVE,V?PUSH \FALSE
	CALL CANT-REACH-THAT >STACK
	RSTACK
?L1:	ZERO? RARG \FALSE
	FSET MOUTH,SEARCHBIT
	EQUAL? PRSA,V?EXAMINE,V?LOOK-INSIDE \?L23
	IN? PLAYER,IDOL /?L27
	ZERO? IDOL-ASLEEP? /?L25
?L27:	CALL CTHE-PRINT,MOUTH
	PRINTI " is "
	FSET? MOUTH,OPENBIT /?L28
	PRINTR "shut tight."
?L28:	ZERO? IDOL-YAWNING? /?L30
	PRINTI "wide open in an almost parodic yawn. The tongue stretches out of the mouth, and the fangs are far apart."
	CALL MOUTH-CONTENTS
	CRLF
	RTRUE
?L30:	PRINTI "slightly open. In the narrow space between the fangs you can see a fat, pointed tongue."
	CALL MOUTH-CONTENTS
	CRLF
	RTRUE
?L25:	PRINT YOU-CANT-SEE
	PRINTR "much from here."
?L23:	EQUAL? PRSA,V?CLIMB-UP \?L33
	CALL PERFORM,V?CLIMB-UP,IDOL
	RTRUE
?L33:	EQUAL? PRSA,V?OPEN,V?CLOSE \?L34
	PRINTR "Not a chance."
?L34:	EQUAL? PRSA,V?REACH-IN \?L35
	CALL WONT-FIT >STACK
	RSTACK
?L35:	EQUAL? PRSA,V?PUT \?L36
	EQUAL? MOUTH,PRSI \?L36
	ZERO? IDOL-YAWNING? \?L37
	GETP PRSO,P?SIZE >STACK
	GRTR? STACK,5 /?L39
	GETP PRSO,P?NAME >STACK
	ZERO? STACK /?L37
?L39:	CALL WONT-FIT >STACK
	RSTACK
?L37:	FCLEAR AIR-CUBE,NDESCBIT
	RFALSE
?L36:	EQUAL? PRSA,V?REZROV \FALSE
	PRINTR "There's no hinge there; it's not a door!"

	.FUNCT WONT-FIT
	PRINTR "Your hand won't fit in."

	.FUNCT MOUTH-CONTENTS,STR
	SET 'STR,STR?199
	IN? AIR-CUBE,MOUTH \?L1
	PRINT STR
	PRINTI " is "
	CALL PRINTA,AIR-CUBE
	PRINTI "."
	SET 'STR,STR?200
?L1:	CALL CLEVER-CONTENTS,MOUTH,STR,AIR-CUBE >STACK
	RSTACK

	.FUNCT OPAL-F
	EQUAL? PRSA,V?EXAMINE \?L1
	IN? OPAL,IDOL \?L3
	PRINTI "The eye glows opalescently in the light."
	IN? PLAYER,IDOL /?L5
	PRINTR " It is near the top of the idol, nearly twenty feet up, but it still looks large even at this distance."
?L5:	PRINTR " The color may be attributed to the fact that the eye is actually an opal of enormous size."
?L3:	PRINTR "This is the largest opal you have ever seen."
?L1:	EQUAL? PRSA,V?TAKE \?L9
	ZERO? OPAL-LOOSE? \FALSE
	IN? PLAYER,IDOL /?L12
	CALL CANT-REACH-THAT >STACK
	RSTACK
?L12:	IN? OPAL,IDOL \FALSE
	PRINTR "You scratch at the setting for a while without success."
?L9:	EQUAL? PRSA,V?PRY \?L15
	EQUAL? PRSO,OPAL \?L15
	IN? OPAL,IDOL \?L15
	IN? PLAYER,IDOL /?L16
	ZERO? IDOL-ASLEEP? \?L16
	CALL CANT-REACH-IT >STACK
	RSTACK
?L16:	EQUAL? PRSI,KNIFE,BURIN,SHEARS \?L18
	IN? PRSI,WINNER /?L19
	CALL NOT-HOLDING,PRSI >STACK
	RSTACK
?L19:	ZERO? OPAL-LOOSE? /?L21
	PRINT IT-IS-ALREADY
	PRINTI "tottering, ready to fall, and trying to pry it again just hastens the inevitable"
	PRINT PERIOD
	RTRUE
?L21:	SET 'OPAL-LOOSE?,1
	CALL QUEUE,I-OPAL-SMASHES,2
	PRINTR "The opal pops out of the eye socket. It is teetering on the edge of the cruel and pointy nose of the idol, ready to fall."
?L18:	CALL CTHE-PRINT-PRSI
	PRINTR " doesn't appear equal to the task."
?L15:	CALL HELD?,OPAL >STACK
	ZERO? STACK /FALSE
	EQUAL? PRSA,V?THROW,V?MUNG /?L25
	EQUAL? PRSA,V?DROP \FALSE
	IN? WINNER,IDOL \FALSE
?L25:	REMOVE OPAL
	MOVE OPAL-SHARD,HERE
	PRINTR "Broken."

	.FUNCT RUINS-PSEUDO
	EQUAL? PRSA,V?EXAMINE \FALSE
	EQUAL? HERE,PAST-RUINS-ROOM \?L3
	PRINTR "This place is abandoned and falling into ruin."
?L3:	PRINTR "This place has been abandoned for centuries. It is a mouldering ruin."

	.FUNCT ZIPPER-F,RARG=0,OLIT,ZLIT
	EQUAL? RARG,M-LOOK \?L1
	PRINTI "You are in a zipper. Clammy dark mist surrounds you. "
	FSET? ZIPPER,OPENBIT \?L3
	PRINTI "The zipper is open. "
	CALL CANT-SEE-OUTSIDE >STACK
	RSTACK
?L3:	CALL TELL-OPEN-CLOSED,ZIPPER >STACK
	RSTACK
?L1:	EQUAL? RARG,M-CONTAINER \?L6
	EQUAL? PRSA,V?TAKE,V?PUT \?L7
	IN? WINNER,ZIPPER /?L7
	CALL HELD?,ZIPPER >STACK
	ZERO? STACK \?L7
	CALL DONT-HAVE-THAT >STACK
	RSTACK
?L7:	EQUAL? PRSA,V?READ,V?EXAMINE \FALSE
	IN? WINNER,ZIPPER /FALSE
	CALL MAKE-OUT >STACK
	RSTACK
?L6:	EQUAL? RARG,M-BEG \?L11
	CALL NOT-IN-VEHICLE? >STACK
	ZERO? STACK /?L12
	EQUAL? PRSA,V?FIND,V?WHAT,V?WHERE /?L12
	EQUAL? PRSA,V?WHO /?L12
	PRINTR "That's not in here."
?L12:	EQUAL? PRSA,V?LOOK-INSIDE \?L14
	EQUAL? PRSO,ZIPPER \?L14
	CALL PERFORM,V?LOOK
	RTRUE
?L14:	EQUAL? PRSA,V?BOARD,V?REACH-IN \?L15
	PRINT YOU-ARE
	PRINT PERIOD
	RTRUE
?L15:	EQUAL? PRSA,V?SIT \?L16
	PRINTR "There isn't a good place to sit here."
?L16:	EQUAL? PRSA,V?EXIT /?L18
	EQUAL? PRSA,V?WALK \?L19
	EQUAL? P-WALK-DIR,P?OUT /?L18
?L19:	EQUAL? PRSA,V?THROUGH \?L17
	EQUAL? PRSO,ZIPPER \?L17
?L18:	CALL PERFORM,V?DISEMBARK
	RTRUE
?L17:	EQUAL? PRSA,V?OPEN,V?REZROV \?L20
	EQUAL? PRSO,ZIPPER \?L20
	FSET? ZIPPER,OPENBIT /?L20
	GETPT ZIPPER,P?SYNONYM >STACK
	PUT STACK,1,W?HOLE
	FSET ZIPPER,OPENBIT
	PRINTI "Opened. "
	CALL CANT-SEE-OUTSIDE >STACK
	RSTACK
?L20:	EQUAL? PRSA,V?CLOSE \?L21
	EQUAL? PRSO,ZIPPER \?L21
	FSET? ZIPPER,OPENBIT \?L21
	GETPT ZIPPER,P?SYNONYM >STACK
	PUT STACK,1,W?ZIPPER
	FCLEAR ZIPPER,OPENBIT
	PRINT YOU-ARE-NOW
	PRINTR "in a private little world of your own."
?L21:	EQUAL? PRSA,V?WALK \?L22
	PRINTR "There's nowhere to go in here."
?L22:	EQUAL? PRSA,V?DISEMBARK /?L24
	EQUAL? PRSA,V?DROP \FALSE
	EQUAL? PRSO,ZIPPER \FALSE
?L24:	FSET? ZIPPER,OPENBIT \?L25
	LOC ZIPPER >STACK
	ZERO? STACK \?L27
	CALL EMERGE-AND-DROWN >STACK
	RSTACK
?L27:	CALL LIT?,HERE >LIT
	LOC ZIPPER >STACK
	MOVE PLAYER,STACK
	MOVE ZIPPER,PLAYER
	PRINTI "You get out of the hole."
	CRLF
	ZERO? OGRE-MURDEROUS? /TRUE
	CALL I-OGRE-KILLS-YOU
	RTRUE
?L25:	PRINT YOU-HAVE-TO
	PRINTI " open the "
	PRINTD ZIPPER
	PRINTR " first."
?L11:	ZERO? RARG \FALSE
	SET 'OLIT,LIT
	EQUAL? PRSA,V?EXAMINE \?L36
	PRINTI "This is a silver zipper about two feet long, with very fine teeth. "
	CALL TELL-OPEN-CLOSED,ZIPPER >STACK
	RSTACK
?L36:	EQUAL? PRSA,V?OPEN,V?REZROV \?L38
	FSET? ZIPPER,OPENBIT /?L38
	GETPT ZIPPER,P?SYNONYM >STACK
	PUT STACK,1,W?HOLE
	FSET ZIPPER,OPENBIT
	ZERO? LIT \?L39
	CALL LIT?,HERE >LIT
?L39:	PRINTI "Opening the zipper reveals a "
	CALL LIT?,ZIPPER,0 >STACK
	ZERO? STACK /?L42
	PRINTI "bright"
	JUMP ?L44
?L42:	PRINTI "dim"
?L44:	PRINTI "ly lit hole."
	ZERO? OLIT \?L45
	ZERO? LIT /?L45
	PRINTI " Enough rays escape to dimly light the area."
?L45:	CRLF
	RTRUE
?L38:	EQUAL? PRSA,V?CLOSE \?L48
	FSET? ZIPPER,OPENBIT \?L48
	GETPT ZIPPER,P?SYNONYM >STACK
	PUT STACK,1,W?ZIPPER
	FCLEAR ZIPPER,OPENBIT
	CALL LIT?,HERE >LIT
	PRINTI "The zipper now looks like an ordinary zipper."
	ZERO? OLIT /?L49
	ZERO? LIT \?L49
	PRINTI " "
	PRINT NOW-BLACK
?L49:	CRLF
	RTRUE
?L48:	EQUAL? PRSA,V?LOOK-INSIDE \?L52
	FSET? ZIPPER,OPENBIT \?L53
	PRINTI "It's "
	CALL LIT?,ZIPPER,0 >ZLIT
	ZERO? ZLIT /?L55
	PRINTI "bright"
	JUMP ?L57
?L55:	PRINTI "dark"
?L57:	PRINTI " inside, "
	FIRST? ZIPPER >STACK \?L58
	ZERO? ZLIT /?L60
	PRINTI "and"
	JUMP ?L62
?L60:	PRINTI "but"
?L62:	PRINTI " you can see "
	CALL PRINT-CONTENTS,ZIPPER
	JUMP ?L64
?L58:	ZERO? ZLIT /?L63
	PRINTI "and empty"
	JUMP ?L64
?L63:	PRINTI "and you can't see anything"
?L64:	PRINT PERIOD
	RTRUE
?L53:	CALL TELL-OPEN-CLOSED,ZIPPER >STACK
	RSTACK
?L52:	EQUAL? PRSA,V?REACH-IN \?L66
	FSET? ZIPPER,OPENBIT /?L67
	CALL TELL-OPEN-CLOSED,ZIPPER >STACK
	RSTACK
?L67:	ZERO? ZIPPER-SCROLL? \FALSE
	SET 'ZIPPER-SCROLL?,1
	MOVE GIRGOL-SCROLL,ZIPPER
	CALL THIS-IS-IT,GIRGOL-SCROLL
	PRINTR "Odd, you can't really feel anything for a moment, but then, almost as though something was thrust into your hand, there's something there. Oops, it slipped away again."
?L66:	EQUAL? PRSA,V?BOARD \?L71
	IN? ZIPPER,PLAYER /?L72
	CALL DONT-HAVE-THAT >STACK
	RSTACK
?L72:	FSET? ZIPPER,OPENBIT \?L74
	EQUAL? HERE,OCEAN-ROOM,LOST-IN-OCEAN,OCEAN-FLOOR /?L77
	EQUAL? HERE,IN-CHANNEL,IN-PIPE,IN-PIPE-2 /?L77
	EQUAL? HERE,IN-SEWER,RUINED-PIPE,PAST-CABINET /?L77
	EQUAL? HERE,CABINET /?L77
	EQUAL? HERE,OUBLIETTE \?L75
	GRTR? WATER-FLAG,0 \?L75
?L77:	CALL IMPOSSIBLE-MANEUVER
	RTRUE
?L75:	ZERO? ZIPPER-SCROLL? \?L79
	SET 'ZIPPER-SCROLL?,1
	MOVE GIRGOL-SCROLL,ZIPPER
?L79:	MOVE ZIPPER,HERE
	MOVE PLAYER,ZIPPER
	CALL LIT?,ZIPPER,0 >ZLIT
	SET 'LIT,1
	PRINTI "It's just big enough to fit in with the zipper fully open. You crawl into a "
	ZERO? ZLIT /?L82
	PRINTI "bright"
	JUMP ?L84
?L82:	PRINTI "dark"
?L84:	PRINTI ", strange place almost like a big sack. You can sort of stand up, but there isn't much room to move around. "
	CALL CANT-SEE-OUTSIDE >STACK
	RSTACK
?L74:	CALL TELL-OPEN-CLOSED,ZIPPER >STACK
	RSTACK
?L71:	EQUAL? PRSA,V?PUT \FALSE
	EQUAL? PRSI,ZIPPER \FALSE
	IN? ZIPPER,BOTTLE \?L87
	CALL CANT-REACH-THAT >STACK
	RSTACK
?L87:	ZERO? ZIPPER-SCROLL? \FALSE
	FSET? PRSO,ONBIT \FALSE
	SET 'ZIPPER-SCROLL?,1
	MOVE GIRGOL-SCROLL,ZIPPER
	RFALSE

	.FUNCT CANT-SEE-OUTSIDE
	PRINT YOU-CANT-SEE
	PRINTR "your outside surroundings, though. It's as though a mist was in the way."

	.FUNCT RUINS-ROOM-F,RARG
	EQUAL? RARG,M-LOOK \?L1
	PRINTI "Here the main corridor opens into a vast underground space. Your light can barely illuminate a fraction of it. All around are cyclopean blocks of stone, crudely carved statues, and constructs of unimaginable purpose. Nearby the portico of a building has collapsed, and a pillar has smashed the pavement and exposed a small channel filled with swiftly rushing water. Water stains indicate that at one time the water flooded the entire area."
	FSET? ZIPPER,NDESCBIT \?L3
	PRINTI " Wedged against a pillar, as though by rushing water, is a zipper."
?L3:	CRLF
	RTRUE
?L1:	EQUAL? RARG,M-BEG \FALSE
	EQUAL? PRSA,V?PUT \?L7
	EQUAL? PRSI,WATER \?L7
	CALL PERFORM,PRSA,PRSO,RUINS-CHANNEL
	RTRUE
?L7:	EQUAL? PRSA,V?THROUGH,V?BOARD \FALSE
	EQUAL? PRSO,WATER \FALSE
	CALL PERFORM,PRSA,RUINS-CHANNEL
	RTRUE

	.FUNCT CLIFF-TOP-EXIT,H=0,DIR
	EQUAL? HERE,MOUNTAIN-TOP \?L1
	SET 'H,1
	SET 'DIR,STR?201
	JUMP ?L3
?L1:	SET 'DIR,STR?202
?L3:	ZERO? ROCK-FLAG /?L4
	ZERO? H /?L6
	RETURN BOULDER-3
?L6:	RETURN BOULDER-1
?L4:	CALL TIME-FROZEN? >STACK
	ZERO? STACK /?L9
	PRINTI "Even frozen in place, the rocks are so jumbled that you can't climb "
	PRINT DIR
	PRINTI " them. You would need full mountaineering equipment even to try."
	CRLF
	RFALSE
?L9:	ZERO? ROCK-SLIDE-COUNT /?L10
	PRINT I-DONT-THINK-THAT
	PRINTI "you can climb "
	PRINT DIR
	PRINTI " an avalanche."
	CRLF
	RFALSE
?L10:	PRINTI "The pile of rocks looks so unsteady that attempting to climb over it could set off an avalanche."
	CRLF
	RFALSE

	.FUNCT CLIFF-TOP-F,RARG
	EQUAL? RARG,M-LOOK \?L1
	PRINTI "This is the upper end of a narrow, winding path up a sheer cliff. From here you can see that any further extension of the path was destroyed by a rock slide at some relatively recent time. There are many rocks "
	ZERO? ROCK-FLAG /?L3
	PRINTI "suspended in midair above you. Some are quite close."
	JUMP ?L6
?L3:	ZERO? ROCK-SLIDE-COUNT /?L5
	PRINTI "tumbling towards you from above."
	JUMP ?L6
?L5:	PRINTI "precariously balanced above you. "
	PRINT IT-LOOKS-LIKE
	PRINTI "the slightest disturbance could bring them down on you."
?L6:	FSET? MOUNTAIN-TOP,TOUCHBIT /?L7
	PRINTR " Frustratingly, you can see the remains of a small building just beyond the dangerous area, but there is no way to get there from here."
?L7:	PRINTR " The hermit's hut is above."
?L1:	EQUAL? RARG,M-BEG \?L10
	EQUAL? PRSA,V?WALK \?L11
	EQUAL? P-WALK-DIR,P?UP,P?DOWN /?L11
	PRINTR "The only path leads up or down. There is only a sheer cliff elsewhere."
?L11:	EQUAL? PRSA,V?LESOCH \FALSE
	ZERO? PRSO \FALSE
	CALL PERFORM,V?LESOCH,GLOBAL-ROCKS
	RTRUE
?L10:	EQUAL? RARG,M-ENTER \FALSE
	ZERO? ROCK-SLIDE-COUNT \FALSE
	ZERO? ROCK-FLAG \FALSE
	SET 'SLIDE-PROB,10
	CALL QUEUE,I-AVALANCHE?,-1 >STACK
	RSTACK

	.FUNCT STOP-AVALANCHE
	SET 'TIME-STOPPED?,HERE
	SET 'ROCK-FLAG,1
	CALL QUEUE,I-GIRGOL,12
	PRINT AT-FIRST
	CALL ROCKS-STOPPED >STACK
	RSTACK

	.FUNCT ROCKS-STOPPED
	PRINTR "that the rocks are no longer falling. Dust hangs suspended in the air. Rocks appear wired in place. The mountainside that threatened to bury you floats serenely in midair."

	.FUNCT BOULDER-ROOM-F,RARG
	EQUAL? RARG,M-LOOK \?L1
	PRINTI "You are clinging to a boulder that is floating in midair. There are many other boulders around, also floating, and lots of dust and dirt, also not moving. "
	EQUAL? HERE,BOULDER-1 \?L3
	PRINTR "One particularly large boulder with good handholds is above you. Below you is the cliff face."
?L3:	EQUAL? HERE,BOULDER-2 \?L5
	PRINTR "A nice oblong boulder is above, and another large one is below you."
?L5:	EQUAL? HERE,BOULDER-3 \?L6
	PRINTI "Below you is a long oblong boulder. Above you there are no more boulders, but there is a continuation of the trail that you were on."
?L6:	CRLF
	RTRUE
?L1:	EQUAL? RARG,M-BEG \FALSE
	EQUAL? PRSA,V?CLIMB-UP,V?CLIMB-FOO \?L9
	CALL DO-WALK,P?UP >STACK
	RSTACK
?L9:	EQUAL? PRSA,V?CLIMB-DOWN \FALSE
	CALL DO-WALK,P?DOWN >STACK
	RSTACK

	.FUNCT MOUNTAIN-TOP-F,RARG
	EQUAL? RARG,M-LOOK \?L1
	PRINTI "This is the top of the mountain. There is "
	ZERO? HERMIT-APPEASED? /?L3
	PRINTI "an imposing"
	JUMP ?L5
?L3:	PRINTI "a crudely built"
?L5:	PRINTR " stone hut nearby to the west."
?L1:	EQUAL? RARG,M-BEG \FALSE
	EQUAL? PRSA,V?CLIMB-UP,V?CLIMB-FOO \?L7
	CALL DO-WALK,P?UP >STACK
	RSTACK
?L7:	EQUAL? PRSA,V?CLIMB-DOWN \FALSE
	CALL DO-WALK,P?DOWN >STACK
	RSTACK

	.FUNCT HUT-ROOM-EXIT
	EQUAL? HERE,HUT-ROOM \?L1
	RETURN MOUNTAIN-TOP
?L1:	RETURN HUT-ROOM

	.FUNCT KEYSTONE-PSEUDO
	CALL REDIRECT,PSEUDO-OBJECT,LIFE-CUBE >STACK
	RSTACK

	.FUNCT HUT-ROOM-F,RARG
	EQUAL? RARG,M-LOOK \?L1
	CALL PERFORM,V?EXAMINE,HUT
	PRINTI "Squatting on the floor is a wild-haired, bearded hermit who is "
	ZERO? HERMIT-APPEASED? /?L3
	PRINTI "admiring his perfect hut"
	JUMP ?L5
?L3:	PRINTI "looking at you with ill-concealed dislike"
?L5:	PRINT PERIOD
	RTRUE
?L1:	EQUAL? RARG,M-BEG \FALSE
	EQUAL? PRSA,V?POINT \?L7
	EQUAL? PRSO,HUT,HERMIT,LIFE-CUBE \?L7
	CALL ASK-HERMIT-ABOUT,PRSO >STACK
	RSTACK
?L7:	EQUAL? PRSA,V?TAKE,V?RUB,V?WRITE /?L10
	EQUAL? PRSA,V?MOVE \?L9
?L10:	EQUAL? PRSO,LIFE-CUBE \?L9
	ZERO? HERMIT-APPEASED? \?L9
	PRINTR "The hermit springs between you and the cube. ""Not so fast! That thing holds up the whole hut. It's the keystone. Don't touch it."""
?L9:	EQUAL? PRSA,V?MALYON \FALSE
	EQUAL? PRSO,LIFE-CUBE \FALSE
	ZERO? HERMIT-APPEASED? \FALSE
	FSET HUT,RMUNGBIT
	FSET HUT-ROOM,RMUNGBIT
	CALL PRINT-ID,STR?203
	CALL JIGS-UP,STR?204 >STACK
	RSTACK

	.FUNCT HUT-F
	EQUAL? PRSA,V?EXAMINE \?L1
	PRINTI "The hut is "
	EQUAL? HERE,CLIFF-TOP \?L3
	PRINTR "barely visible."
?L3:	ZERO? HERMIT-APPEASED? /?L5
	PRINTI "beautifully constructed out of carefully dressed granite blocks and strong mortar."
	JUMP ?L6
?L5:	PRINTI "made of irregular stones"
?L6:	EQUAL? HERE,HUT-ROOM \?L7
	ZERO? HERMIT-APPEASED? /?L9
	PRINTI " The construction of the hut is somewhat at odds with the squalor of its contents."
	JUMP ?L11
?L9:	PRINTI ". The walls are chinked with moss, mud, small stones,"
	IN? LIFE-CUBE,HUT-ROOM \?L12
	FSET? LIFE-CUBE,NDESCBIT \?L12
	PRINTI " a "
	PRINT WHITE-CUBE
	PRINTI ","
?L12:	PRINTI " and an occasional old fur."
?L11:	PRINTR " There is an exit to the east."
?L7:	ZERO? HERMIT-APPEASED? \?L16
	PRINTI " much like those lying all around you."
?L16:	PRINTR " There is an entrance to the west."
?L1:	EQUAL? HERE,CLIFF-TOP \?L19
	PRINT TOO-FAR
	RTRUE
?L19:	EQUAL? PRSA,V?LOOK-INSIDE \?L20
	EQUAL? HERE,MOUNTAIN-TOP \?L20
	PRINT YOU-CANT-SEE
	PRINTR "very much from out here. Why not go in?"
?L20:	EQUAL? PRSA,V?REACH-IN \?L21
	EQUAL? MOUNTAIN-TOP,HERE \?L21
	PRINTI "You reach in and hear a yell of surprise from inside."
	CRLF
	CALL PRINT-ID,STR?205 >STACK
	RSTACK
?L21:	EQUAL? PRSA,V?THROUGH,V?BOARD \?L22
	EQUAL? HERE,HUT-ROOM \?L23
	PRINT YOU-ARE
	PRINT PERIOD
	RTRUE
?L23:	CALL GOTO,HUT-ROOM >STACK
	RSTACK
?L22:	EQUAL? PRSA,V?DISEMBARK,V?DROP \?L26
	EQUAL? HERE,HUT-ROOM /?L27
	PRINT YOU-ARE
	PRINT PERIOD
	RTRUE
?L27:	CALL GOTO,MOUNTAIN-TOP >STACK
	RSTACK
?L26:	EQUAL? PRSA,V?CASKLY \FALSE
	ZERO? HERMIT-APPEASED? \FALSE
	SET 'HERMIT-APPEASED?,1
	FCLEAR LIFE-CUBE,NDESCBIT
	PRINTI "The hut begins to melt, the stones dripping down like wax and the dirt spraying in all directions. "
	CALL PRINT-ID,STR?206
	EQUAL? HERE,HUT-ROOM \?L33
	PRINTI """Now you've done it, you meddlesome mage!"" screams the hermit."
	JUMP ?L35
?L33:	PRINTI "You hear a scream from inside the hut."
?L35:	PRINTI " But then the stones start flowing back into place, and the dirt speeds into place between them, and all is changed. The hut looks considerably different"
	EQUAL? HERE,HUT-ROOM \?L36
	PRINTI ", and the cube, no longer necessary, sits in lonely splendor on the ground between you and the hermit"
?L36:	PRINT PERIOD
	RTRUE

	.FUNCT HERMIT-F
	EQUAL? WINNER,HERMIT \?L1
	EQUAL? PRSA,V?TELL-ABOUT \?L3
	EQUAL? PRSO,ME /FALSE
?L3:	EQUAL? PRSA,V?TELL-ME-ABOUT \?L5
	CALL ASK-HERMIT-ABOUT,PRSO >STACK
	RSTACK
?L5:	PRINTI "He's a taciturn old buzzard and doesn't respond."
	CRLF
	CALL END-QUOTE >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?EXAMINE \?L7
	PRINTR "The old man is clothed in goatskin rags. He has a long, tangled beard and dirty matted hair."
?L7:	EQUAL? PRSA,V?SMELL \?L8
	PRINTI "His last bath may well have been before you were born."
	CRLF
	CALL PRINT-ID,STR?207 >STACK
	RSTACK
?L8:	EQUAL? PRSA,V?SHOW \?L9
	GETPT PRSO,P?NAME >STACK
	ZERO? STACK /?L10
	PRINTR "The hermit remarks ""You've got one, too. What do you want with mine, then?"""
?L10:	EQUAL? PRSO,ZORKMID \?L12
	CALL MATERIALISM >STACK
	RSTACK
?L12:	EQUAL? PRSO,BREAD,FISH \?L13
	PRINTR """That looks pretty good. I eat mostly berries, moss, and goat meat."""
?L13:	CALL UNINTERESTED,HERMIT >STACK
	RSTACK
?L9:	EQUAL? PRSA,V?GIVE \?L15
	EQUAL? PRSO,BREAD,FISH \FALSE
	REMOVE PRSO
	PRINTI "The hermit devours the "
	PRINTD PRSO
	PRINTI " with gusto. He belches. ""That was a nice change,"" he remarks."
	CRLF
	CALL PRINT-ID,STR?208 >STACK
	RSTACK
?L15:	EQUAL? PRSA,V?ASK-FOR \?L19
	EQUAL? PRSO,HERMIT \?L19
	EQUAL? PRSI,LIFE-CUBE \?L19
	ZERO? HERMIT-APPEASED? /?L20
	PRINTI """Sure, take it."" He's distracted by his admiration for his newly perfected dwelling."
	CRLF
	CALL PRINT-ID,STR?209 >STACK
	RSTACK
?L20:	PRINTR """Not on your life. It's holding up the whole hut. It's perfect for that chink. You don't know how long it took me to find it."""
?L19:	EQUAL? PRSA,V?TRADE,V?BUY \?L23
	CALL MATERIALISM >STACK
	RSTACK
?L23:	EQUAL? PRSA,V?YOMIN \FALSE
	PRINTI "The hermit is worried that you will rob him. He is very suspicious. He's been up here on the mountain for so long that his brains are slightly curdled."
	CRLF
	CALL PRINT-ID,STR?210 >STACK
	RSTACK

	.FUNCT MATERIALISM
	PRINTR """Materialism! That's another thing I was trying to get away from!"" The hermit looks glum."

	.FUNCT ASK-HERMIT-ABOUT,OBJ
	CALL PRINT-ID,STR?211
	EQUAL? OBJ,GLOBAL-ROCKS \?L1
	PRINTR """I like avalanches. They keep people away. Usually."""
?L1:	EQUAL? OBJ,ZORKMID \?L3
	CALL MATERIALISM >STACK
	RSTACK
?L3:	EQUAL? OBJ,FISH,BREAD \?L4
	PRINTR "He perks up at the mention of food."
?L4:	EQUAL? OBJ,LIFE-CUBE,HUT,HERMIT \FALSE
	PRINTR """I've been living up here for many years. Wanted to get away from people. Too much noise, too much talk, too much jabber-jabber all the time. I've been building this hut for years, too. Couldn't find the right keystone. It would always collapse after a while, so I never moved into it. I kept hoping to get it right some day; no training in stonemasonry. One day there was a presence on the mountain, like a cloud had come over. Then there was smoke, orange smoke, I think. The next day I found that stone sitting on top of a rock not five minutes' walk from here. It was perfect."""

	.FUNCT GLOBAL-CLIFF-F
	EQUAL? PRSA,V?EXAMINE \?L1
	PRINT ROCKS-PRECARIOUS
	PRINT PERIOD
	RTRUE
?L1:	EQUAL? PRSA,V?CLIMB-UP,V?CLIMB-FOO,V?FOLLOW \?L3
	CALL DO-WALK,P?UP >STACK
	RSTACK
?L3:	EQUAL? PRSA,V?CLIMB-DOWN \FALSE
	CALL DO-WALK,P?DOWN >STACK
	RSTACK

	.FUNCT GLOBAL-ROCKS-F
	EQUAL? PRSA,V?EXAMINE \?L1
	EQUAL? HERE,BOULDER-1,BOULDER-2,BOULDER-3 \?L3
	CALL PERFORM,V?LOOK
	RTRUE
?L3:	EQUAL? HERE,VOLCANO-BASE,VOLCANO-ROOM,OUTCROPPING-ROOM \?L5
	PRINTR "The rocks look hot and are melted to all their neighbors."
?L5:	EQUAL? HERE,CLIFF-TOP,CLIFF-MIDDLE,CLIFF-BOTTOM /?L7
	EQUAL? HERE,MOUNTAIN-TOP,CAVE-ENTRANCE \FALSE
?L7:	ZERO? ROCK-FLAG \?L10
	CALL TIME-FROZEN? >STACK
	ZERO? STACK /?L8
?L10:	PRINTI "You can see "
	CALL ROCKS-STOPPED >STACK
	RSTACK
?L8:	CALL QUEUED?,I-AVALANCHE >STACK
	ZERO? STACK /?L11
	CALL ROCKS-TUMBLING >STACK
	RSTACK
?L11:	PRINT ROCKS-PRECARIOUS
	PRINT PERIOD
	RTRUE
?L1:	EQUAL? PRSA,V?CLIMB-FOO,V?CLIMB-UP,V?CLIMB-ON /?L15
	EQUAL? PRSA,V?CLIMB-OVER \?L14
?L15:	CALL DO-WALK,P?UP >STACK
	RSTACK
?L14:	EQUAL? PRSA,V?RUB,V?MOVE,V?PUSH /?L17
	EQUAL? PRSA,V?LESOCH,V?KICK,V?MALYON \?L16
?L17:	EQUAL? HERE,VOLCANO-BASE,VOLCANO-ROOM,OUTCROPPING-ROOM \?L18
	CALL TELL-TOO-HOT
	PRINT PERIOD
	RTRUE
?L18:	CALL TIME-FROZEN? >STACK
	ZERO? STACK \FALSE
	EQUAL? HERE,CLIFF-TOP,MOUNTAIN-TOP \FALSE
	EQUAL? PRSA,V?MALYON \?L22
	PRINTI "You animate"
	JUMP ?L24
?L22:	EQUAL? PRSA,V?LESOCH \?L23
	PRINTI "The wind whips up to a frenzy and touches"
	JUMP ?L24
?L23:	PRINTI "You gingerly touch"
	CALL PRINT-ID,STR?212
?L24:	PRINTI " a rock, which tilts a little. Another rock slides into the gap, triggering a larger one to fall. Suddenly, the entire mountainside begins to tumble down."
	CRLF
	CALL DEQUEUE,I-AVALANCHE?
	CALL QUEUE,I-AVALANCHE,-1
	RTRUE
?L16:	EQUAL? PRSA,V?TAKE \FALSE
	EQUAL? HERE,CLIFF-TOP,MOUNTAIN-TOP \?L26
	CALL TIME-FROZEN? >STACK
	ZERO? STACK \?L26
	CALL QUEUED?,I-AVALANCHE >STACK
	ZERO? STACK \FALSE
	PRINTI "Taken, but you drop it immediately when you see that your intemperate action has triggered a rock slide."
	CRLF
	SET 'ROCK-SLIDE-COUNT,0
	CALL DEQUEUE,I-AVALANCHE?
	CALL QUEUE,I-AVALANCHE,-1
	RTRUE
?L26:	EQUAL? HERE,VOLCANO-BASE,VOLCANO-ROOM,OUTCROPPING-ROOM \?L31
	CALL TELL-TOO-HOT
	PRINTR " or solidly fixed to the ground here."
?L31:	PRINTR "None of the rocks look interesting enough to take."

	.FUNCT TELL-TOO-HOT
	CALL CTHE-PRINT-PRSO
	PRINTI " is too hot to touch"
	RTRUE

	.FUNCT CLIFF-MIDDLE-F,RARG
	EQUAL? RARG,M-LOOK \?L1
	PRINTR "A narrow ledge, barely wide enough to stand on, interrupts the cliff here."
?L1:	EQUAL? RARG,M-BEG \FALSE
	EQUAL? PRSA,V?WALK \FALSE
	EQUAL? P-WALK-DIR,P?UP,P?DOWN /FALSE
	PRINTR "The path leads up or down. There is a sheer cliff elsewhere."

	.FUNCT CLIFF-BOTTOM-F,RARG
	EQUAL? RARG,M-LOOK \FALSE
	PRINTR "This is the bottom of a sheer cliff which towers above you. Jumbled rockfalls are all around you. A goat track (at best) leads up, and a well-worn trail heads west."

	.FUNCT GLOBAL-CAVE-F
	EQUAL? PRSA,V?EXAMINE \?L1
	EQUAL? HERE,CAVE-ENTRANCE /?L1
	CALL PERFORM,V?LOOK
	RTRUE
?L1:	EQUAL? PRSA,V?THROUGH \?L3
	EQUAL? HERE,CAVE-ENTRANCE \?L4
	CALL GOTO,OGRE-CAVE >STACK
	RSTACK
?L4:	PRINT YOU-ARE
	PRINT PERIOD
	RTRUE
?L3:	CALL REDIRECT,GLOBAL-CAVE,GLOBAL-ROOM >STACK
	RSTACK

	.FUNCT CAVE-ENTRANCE-F,RARG
	EQUAL? RARG,M-LOOK \?L1
	PRINTR "A well-worn trail terminates here where a cave enters the cliff-side to the north. Outside the cave is a litter of bones, old hides and brush. The smell that issues from the cave is mephitic. To the east is the bottom of a sheer cliff."
?L1:	EQUAL? RARG,M-ENTER \?L3
	CALL QUEUE,I-OGRE,-1
	RFALSE
?L3:	EQUAL? RARG,M-BEG \FALSE
	EQUAL? PRSA,V?LISTEN \?L5
	ZERO? PRSO \?L5
	CALL OGRE-NOISES >STACK
	RSTACK
?L5:	EQUAL? PRSA,V?SMELL \FALSE
	ZERO? PRSO \FALSE
	PRINTI "It smells horrific. The sanitary habits of ogres are appalling."
	CRLF
	CALL PRINT-ID,STR?213 >STACK
	RSTACK

	.FUNCT OGRE-CAVE-F,RARG
	EQUAL? RARG,M-LOOK \?L1
	PRINTI "This is a natural fissure in the rock which was enlarged with crude skill into a spacious and comfortable room, at least if you're fond of caves. The floor is dirt, hard packed in some parts, loose in others. A low passage leads down. "
	CALL OGRE-DESC >STACK
	RSTACK
?L1:	EQUAL? RARG,M-ENTER \?L3
	CALL QUEUED?,I-OGRE-KILLS-YOU >STACK
	ZERO? STACK \?L4
	CALL QUEUE,I-OGRE-KILLS-YOU,12
?L4:	ZERO? LIT \?L7
	CALL PRINT-ID,STR?214
	CALL JIGS-UP,STR?215 >STACK
	RSTACK
?L7:	EQUAL? OHERE,OGRE-BEDROOM \FALSE
	ZERO? SNEEZY? \FALSE
	EQUAL? ESPNIS?,OGRE /FALSE
	CALL TIME-FROZEN? >STACK
	ZERO? STACK \FALSE
	CALL I-OGRE-KILLS-YOU,1 >STACK
	RSTACK
?L3:	EQUAL? RARG,M-BEG \FALSE
	EQUAL? PRSA,V?LISTEN \?L12
	ZERO? PRSO \?L12
	CALL PERFORM,V?LISTEN,OGRE
	RTRUE
?L12:	EQUAL? PRSA,V?SMELL \?L14
	ZERO? PRSO \?L14
	CALL SMELL-OGRE-CAVE >STACK
	RSTACK
?L14:	EQUAL? PRSA,V?WAVE \?L15
	CALL GIVE-TO-OGRE >STACK
	RSTACK
?L15:	EQUAL? PRSA,V?THROUGH \FALSE
	EQUAL? PRSO,CORRIDOR \FALSE
	CALL DO-WALK,P?DOWN >STACK
	RSTACK

	.FUNCT SMELL-OGRE-CAVE
	PRINTI "It smells even worse inside than it did outside, as hard as that is to credit."
	CRLF
	CALL PRINT-ID,STR?216 >STACK
	RSTACK

	.FUNCT OGRE-BEDROOM-EXIT
	ZERO? SNEEZY? \?L3
	CALL TIME-FROZEN? >STACK
	ZERO? STACK \?L3
	EQUAL? ESPNIS?,OGRE \?L1
?L3:	PRINTI "You saunter nonchalantly past the "
	ZERO? SNEEZY? /?L4
	PUSH STR?217
	JUMP ?L7
?L4:	CALL TIME-FROZEN? >STACK
	ZERO? STACK /?L6
	PUSH STR?218
	JUMP ?L7
?L6:	PUSH STR?219
?L7:	PRINT STACK
	PRINTI " ogre."
	CRLF
	CRLF
	RETURN OGRE-BEDROOM
?L1:	PRINTI "The ogre moves quickly to bar your way"
	EQUAL? SHRINK-FLAG,OGRE \?L9
	PRINTI ". He may be small, but he's still dangerous"
?L9:	PRINT PERIOD
	RFALSE

	.FUNCT OGRE-BEDROOM-F,RARG
	EQUAL? RARG,M-LOOK \?L1
	PRINTR "This small but cozy hole is the ogre's lair. Moldy, filthy furs piled in one corner make a crude bed. There is a rocky crawl up to the main part of the cave."
?L1:	EQUAL? RARG,M-ENTER \?L3
	EQUAL? OHERE,DULL-ROOM \FALSE
	CALL I-OGRE-KILLS-YOU,1 >STACK
	RSTACK
?L3:	EQUAL? RARG,M-BEG \FALSE
	EQUAL? PRSA,V?LISTEN \?L8
	ZERO? PRSO \?L8
	CALL OGRE-NOISES >STACK
	RSTACK
?L8:	EQUAL? PRSA,V?SMELL \?L10
	ZERO? PRSO \?L10
	CALL SMELL-OGRE-CAVE >STACK
	RSTACK
?L10:	EQUAL? PRSA,V?THROUGH \FALSE
	EQUAL? PRSO,CORRIDOR \FALSE
	CALL DO-WALK,P?UP >STACK
	RSTACK

	.FUNCT MAGIC-BOX-EXIT,L
	LOC MAGIC-BOX >L
	ZERO? L /?L1
	IN? L,ROOMS \?L1
	EQUAL? L,EMPORIUM /?L1
	GETP L,P?CUBE >STACK
	ZERO? STACK \?L1
	GETP HERE,P?CUBE >STACK
	EQUAL? STACK,MAGIC-BOX-CUBE \?L1
	EQUAL? L,CASTLE \?L3
	CALL MAGIC-DOOR-EXIT >STACK
	RSTACK
?L3:	RETURN L
?L1:	PRINTI "Oddly, although there appears to be an exit there, you can't seem to force your way through it."
	CRLF
	RFALSE

	.FUNCT MAGIC-BOX-F
	EQUAL? PRSA,V?EXAMINE \?L1
	PRINTI "The gold box is small, richly ornamented with allegorical figures of "
	CALL MAGIC-BOX-CREATURE
	PRINTI " and cryptic symbols. It has a small latch which "
	FSET? MAGIC-BOX,OPENBIT \?L3
	PRINTI "could hold"
	JUMP ?L5
?L3:	PRINTI "holds"
?L5:	PRINTR " closed the lid."
?L1:	EQUAL? PRSA,V?LOCK,V?UNLOCK \?L6
	PRINTR "There's no lock, only a latch."
?L6:	EQUAL? PRSA,V?PUT \FALSE
	EQUAL? PRSI,MAGIC-BOX \FALSE
	IN? MAGIC-BOX,WINNER /?L8
	CALL NOT-HOLDING,PRSI >STACK
	RSTACK
?L8:	FSET? MAGIC-BOX,OPENBIT /?L10
	PRINT YOU-HAVE-TO
	PRINTI " open the "
	PRINTD PRSI
	PRINTR " first."
?L10:	FIRST? MAGIC-BOX >STACK \?L11
	PRINTR "There is already something in it."
?L11:	GETPT PRSO,P?NAME >STACK
	ZERO? STACK \?L12
	GETP MAGIC-BOX,P?CAPACITY >STACK
	GETP PRSO,P?SIZE >STACK
	LESS? STACK,STACK \?L13
	PRINTR "Strangely, you can't fit it in."
?L13:	PRINT DOESNT-FIT
	RTRUE
?L12:	MOVE PRSO,MAGIC-BOX
	EQUAL? PRSO,MAGIC-BOX-CUBE /?L19
	EQUAL? MAGIC-BOX-CUBE,TIME-CUBE \?L17
	GETP PRSO,P?CUBE >STACK
	ZERO? STACK \?L17
?L19:	PRINTR "Done."
?L17:	EQUAL? HERE,SCALES-ROOM \?L21
	CALL USE-SPELL
?L21:	SET 'MAGIC-BOX-CUBE,PRSO
	PRINTI "When you insert "
	CALL THE-PRINT-PRSO
	PRINTI " into the box, there is a brief burst of light, and the decorations on the box change subtly. They now depict "
	CALL MAGIC-BOX-CREATURE
	PRINT PERIOD
	RTRUE

	.FUNCT MAGIC-BOX-CREATURE,STR
	GETP MAGIC-BOX-CUBE,P?TEXT >STR
	ZERO? STR /?L1
	PRINT STR
	RTRUE
?L1:	PRINTI "turtles"
	RTRUE

	.FUNCT OGRE-DESC,RARG,OBJ
	PRINTI "A "
	EQUAL? SHRINK-FLAG,OGRE \?L1
	PUSH STR?220
	JUMP ?L3
?L1:	PUSH STR?221
?L3:	PRINT STACK
	PRINTI " ogre "
	CALL TIME-FROZEN? >STACK
	ZERO? STACK /?L4
	PRINTR "stands immobile in the passage, caught in mid-sneeze."
?L4:	EQUAL? ESPNIS?,OGRE \?L6
	PRINTR "snores noisily here."
?L6:	ZERO? SNEEZY? /?L7
	PRINTR "rolls uncomfortably on the floor, sneezing loudly."
?L7:	PRINTR "bars the passage."

	.FUNCT OGRE-F,RARG=0
	EQUAL? WINNER,OGRE \?L1
	CALL TIME-FROZEN? >STACK
	ZERO? STACK \?L5
	EQUAL? ESPNIS?,OGRE \?L3
?L5:	PRINTI "There is no reply."
	CRLF
	JUMP ?L6
?L3:	CALL CTHE-PRINT,OGRE
	PRINTI " grunts nastily at you."
	CRLF
?L6:	CALL END-QUOTE >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?EXAMINE \?L8
	PRINTI "This is a fairly typical mountain ogre. His carbuncles are a brilliant purple, and his hair is matted down with something slick and unpleasant-smelling. His eyes are watering and his nose is running, which doesn't make him any more attractive. His whole body is covered by dirty brown fur. He looks like a particularly ill-favored bear."
	CALL TIME-FROZEN? >STACK
	ZERO? STACK /?L10
	PRINTI " He and all his surroundings are frozen in place."
?L10:	EQUAL? SHRINK-FLAG,OGRE \?L13
	PRINTI " He is currently six inches of concentrated ugliness."
?L13:	CRLF
	RTRUE
?L8:	EQUAL? PRSA,V?GIVE,V?SHOW,V?WAVE-AT \?L16
	EQUAL? PRSI,OGRE \?L16
	CALL GIVE-TO-OGRE >STACK
	RSTACK
?L16:	EQUAL? PRSA,V?LISTEN \?L17
	CALL CTHE-PRINT,OGRE
	PRINTI " sounds "
	CALL TIME-FROZEN? >STACK
	ZERO? STACK /?L18
	PRINTR "very quiet."
?L18:	EQUAL? ESPNIS?,OGRE \?L20
	PRINTR "like he is snoring."
?L20:	CALL VISIBLE?,WEED >STACK
	ZERO? STACK /?L26
	FSET? WEED,RMUNGBIT \?L24
	PRINTI "extremely "
	JUMP ?L26
?L24:	PRINTI "somewhat "
?L26:	PRINTR "congested and sneezy."
?L17:	CALL HOSTILE-VERB? >STACK
	ZERO? STACK /?L28
	CALL PRINT-ID,STR?222
	EQUAL? ESPNIS?,OGRE \?L29
	SET 'ESPNIS?,0
	CALL DEQUEUE,I-ESPNIS
	PRINTI "The ogre wakes at the first touch!"
	CRLF
?L29:	CALL TIME-FROZEN? >STACK
	ZERO? STACK /?L32
	PRINTR "There is no effect. It's like attacking a statue."
?L32:	ZERO? SNEEZY? /?L34
	CALL CTHE-PRINT,OGRE
	PRINTR "'s hide is thick, and your attack only tickles him."
?L34:	CALL CTHE-PRINT,OGRE
	PRINTR " contemptuously fends you off."
?L28:	EQUAL? PRSA,V?SMELL \?L36
	PRINTI "You would put your nasal cavity at great risk."
	CRLF
	CALL PRINT-ID,STR?223 >STACK
	RSTACK
?L36:	EQUAL? PRSA,V?YOMIN \?L37
	EQUAL? ESPNIS?,PRSO \?L38
	CALL CTHE-PRINT-PRSO
	PRINTR " is asleep."
?L38:	PRINTR "You get the impression of discomfort and annoyance. This is apparently not just for the usual ogreish reasons (general nastiness, bad temper, and lice) but because the ogre is suffering from hay fever."
?L37:	EQUAL? PRSA,V?SNAVIG \FALSE
	SET 'CHANGED?,OGRE
	CALL QUEUE,I-SNAVIG,12
	PRINTI "You become just as ugly, bellicose, and sneezy as the ogre."
	EQUAL? ESPNIS?,OGRE /?L42
	CALL TIME-FROZEN? >STACK
	ZERO? STACK \?L42
	PRINTI " The ogre is even less inclined to let you by."
?L42:	CRLF
	RTRUE

	.FUNCT GIVE-TO-OGRE
	CALL TIME-FROZEN? >STACK
	ZERO? STACK \?L3
	EQUAL? ESPNIS?,OGRE \?L1
?L3:	PRINTR "He is in no position to respond."
?L1:	EQUAL? PRSO,WEED \?L4
	PRINTI "The ogre shrinks back and lets go an explosive sneeze"
	PRINT PERIOD
	RTRUE
?L4:	CALL UNINTERESTED,OGRE >STACK
	RSTACK

	.FUNCT WATER-ROOM-F,RARG
	EQUAL? RARG,M-LOOK \?L1
	PRINTR "This is a damp, mossy room. Its floor is mud, and its walls and ceiling are coral. In the gaps in the coral you can see a shimmering film which you realize is actually the outer edge of a huge bubble of air enclosing you. On the north, east and south sides of the room are curtains of bubbles."
?L1:	EQUAL? RARG,M-LEAVE \FALSE
	CALL RECOVER-CUBE >STACK
	RSTACK

	.FUNCT OCEAN-ROOM-F,RARG
	EQUAL? RARG,M-LOOK \?L1
	PRINTI "You are swimming in mid-ocean."
	CALL CLEVER-CONTENTS,HERE,STR?224,GROUPER
	CRLF
	RTRUE
?L1:	EQUAL? RARG,M-ENTER \?L3
	EQUAL? OHERE,WATER-ROOM \FALSE
	MOVE GROUPER,HERE
	CALL QUEUE,I-GROUPER,2
	CALL QUEUE,I-CUBE-SINKS,3
	MOVE WATER-CUBE,HERE
	FSET WATER-CUBE,NDESCBIT
	PRINTI "You step out of the room and drop precipitously into the Flathead Ocean, making a terrific splash. "
	CALL CTHE-PRINT,WATER-CUBE
	PRINTI ", lost in the shock of the fall, makes a smaller splash. It is a little less buoyant than you and begins to sink slowly beneath the waves."
	CALL SOAK-PLAYER
	CRLF
	CRLF
	RTRUE
?L3:	EQUAL? RARG,M-BEG \?L7
	CALL FUN-IN-OCEAN >STACK
	RSTACK
?L7:	EQUAL? RARG,M-END \FALSE
	CALL SOAK-IF-OPENED >STACK
	RSTACK

	.FUNCT FUN-IN-OCEAN
	EQUAL? PRSA,V?WALK,V?SWIM \?L1
	EQUAL? HERE,LOST-IN-OCEAN \?L3
	CALL GOTO,LOST-IN-OCEAN >STACK
	RSTACK
?L3:	EQUAL? P-WALK-DIR,P?DOWN \?L5
	EQUAL? CHANGED?,GROUPER \?L6
	CALL YOU-SWIM
	CALL GOTO,OCEAN-FLOOR >STACK
	RSTACK
?L6:	CALL HOLD-BREATH >STACK
	RSTACK
?L5:	EQUAL? P-WALK-DIR,P?UP \?L9
	PRINTR "Only if you sprout wings first."
?L9:	CALL GOTO,LOST-IN-OCEAN >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?TAKE \?L11
	EQUAL? CHANGED?,GROUPER \?L12
	PRINTR "Your fins are not well designed to hold things."
?L12:	GRTR? P-MULT,1 \FALSE
	PRINTI "They were floating in opposite directions, and you get a chance at only one of them."
	CRLF
	RETURN 2
?L11:	EQUAL? PRSA,V?DROP \?L18
	CALL HELD?,PRSO >STACK
	ZERO? STACK /?L18
	CALL QUEUE,I-FLOTSAM,2
	MOVE PRSO,HERE
	FSET PRSO,NDESCBIT
	CALL SOAK-OBJ?,PRSO
	CALL CTHE-PRINT-PRSO
	EQUAL? PRSO,BOTTLE \?L19
	PRINTI " is now floating nearby"
	JUMP ?L21
?L19:	PRINTI " begins to sink beneath the waves"
?L21:	PRINT PERIOD
	RTRUE
?L18:	EQUAL? PRSA,V?EAT \FALSE
	EQUAL? CHANGED?,GROUPER \FALSE
	FSET? PRSO,TAKEBIT \FALSE
	SET 'ATE-AS-GROUPER?,1
	REMOVE PRSO
	PRINTI "Opening your maw, you swallow "
	CALL THE-PRSO >STACK
	RSTACK

	.FUNCT HOLD-BREATH
	PRINTR "You take a deep breath and swim downward, but you can't hold it long enough to reach the bottom."

	.FUNCT YOU-SWIM
	PRINTI "You swim "
	EQUAL? HERE,OCEAN-ROOM \?L1
	PRINTI "downward"
	JUMP ?L3
?L1:	PRINTI "upward"
?L3:	IN? GROUPER,HERE \?L4
	EQUAL? HERE,OCEAN-ROOM \?L6
	MOVE GROUPER,OCEAN-FLOOR
	PRINTI ", followed"
	JUMP ?L8
?L6:	PRINTI ", watched"
?L8:	PRINTI " by the nervous grouper"
?L4:	PRINT PERIOD
	CRLF
	RTRUE

	.FUNCT LOST-IN-OCEAN-F,RARG
	EQUAL? RARG,M-LOOK \?L1
	PRINTI "You are lost in the middle of the open ocean. There is no land in sight."
	CALL CLEVER-CONTENTS,HERE,STR?224
	CRLF
	RTRUE
?L1:	EQUAL? RARG,M-BEG \?L3
	CALL FUN-IN-OCEAN >STACK
	RSTACK
?L3:	EQUAL? RARG,M-END \FALSE
	CALL SOAK-IF-OPENED >STACK
	RSTACK

	.FUNCT EMERGE-AND-DROWN
	EQUAL? CHANGED?,GROUPER /FALSE
	CALL PRINT-ID,STR?225
	CALL JIGS-UP,STR?226 >STACK
	RSTACK

	.FUNCT OCEAN-FLOOR-F,RARG
	EQUAL? RARG,M-LOOK \?L1
	PRINTR "You are deep beneath the waves, near a small pile of rocks and broken coral that make up the nest of a grouper."
?L1:	EQUAL? RARG,M-ENTER \?L3
	CALL EMERGE-AND-DROWN >STACK
	RSTACK
?L3:	EQUAL? RARG,M-BEG \FALSE
	EQUAL? PRSA,V?WALK,V?SWIM \?L5
	EQUAL? CHANGED?,GROUPER \?L7
	EQUAL? P-WALK-DIR,P?UP \?L9
	CALL YOU-SWIM
	CALL GOTO,OCEAN-ROOM >STACK
	RSTACK
?L9:	EQUAL? P-WALK-DIR,P?DOWN \?L11
	PRINTR "You hit your nose against the sand."
?L11:	PRINTR "You swim in circles for a while."
?L7:	EQUAL? PRSO,0,P?UP /?L14
	EQUAL? P-WALK-DIR,P?UP \?L13
?L14:	PRINTI "You swim upward, desperately trying to hold your breath until you reach the surface. It's a losing battle. "
	PRINT YOU-CANT
	PRINTI "hold it any longer, take a breath, and it's pure, sweet air! You have reached the surface."
	CRLF
	CRLF
	CALL GOTO,OCEAN-ROOM >STACK
	RSTACK
?L13:	PRINTR "You swim about for a short distance."
?L5:	EQUAL? PRSA,V?DROP /FALSE
	EQUAL? CHANGED?,GROUPER \FALSE
	CALL FUN-IN-OCEAN >STACK
	RSTACK

	.FUNCT BOTTLE-F,F
	EQUAL? PRSA,V?FILL \?L1
	IN? BOTTLE,WINNER /?L3
	CALL NOT-HOLDING,BOTTLE >STACK
	RSTACK
?L3:	IN? LOCAL-WATER,BOTTLE \?L5
	PRINT IT-IS-ALREADY
	PRINTI "full"
	PRINT PERIOD
	RTRUE
?L5:	EQUAL? PRSI,0,WATER \?L6
	CALL GLOBAL-IN?,WATER,HERE >STACK
	ZERO? STACK \?L7
	PRINTR "There's no water here."
?L7:	MOVE LOCAL-WATER,BOTTLE
	CALL CTHE-PRINT,BOTTLE
	PRINTI " is now full of "
	EQUAL? HERE,OCEAN-ROOM,OCEAN-FLOOR,LOST-IN-OCEAN \?L10
	FSET LOCAL-WATER,RMUNGBIT
	PRINTI "salt "
	JUMP ?L12
?L10:	FCLEAR LOCAL-WATER,RMUNGBIT
?L12:	PRINTI "water"
	FSET? BOTTLE,OPENBIT /?L13
	PRINTI ", and it's closed again"
?L13:	CALL SOAK-STUFF,BOTTLE >F
	ZERO? F /?L16
	PRINTI ". The water has ruined something in the bottle"
?L16:	PRINT PERIOD
	RTRUE
?L6:	CALL YOU-CANT-X-PRSI,STR?227 >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?POUR \?L20
	EQUAL? PRSO,BOTTLE \?L20
	IN? LOCAL-WATER,BOTTLE \?L20
	REMOVE LOCAL-WATER
	CALL CTHE-PRINT,BOTTLE
	PRINTR " is now empty of water."
?L20:	EQUAL? PRSA,V?LOOK-INSIDE,V?OPEN \FALSE
	FCLEAR LISKON-SCROLL,NDESCBIT
	RFALSE

	.FUNCT GROUPER-F
	EQUAL? WINNER,GROUPER \?L1
	CALL END-QUOTE
	PRINTR "The grouper stares at you, goggle-eyed and interested, but wary."
?L1:	EQUAL? PRSA,V?EXAMINE \?L3
	PRINTR "The grouper is a large fish with an enormous mouth. This specimen is large but not exceptional. It probably weighs about as much as you."
?L3:	EQUAL? PRSA,V?FOLLOW \?L4
	IN? GROUPER,OCEAN-FLOOR \FALSE
	IN? PLAYER,OCEAN-ROOM \FALSE
	CALL DO-WALK,P?DOWN >STACK
	RSTACK
?L4:	EQUAL? PRSA,V?WAVE-AT,V?GIVE,V?SHOW \?L8
	PRINTR "The grouper looks interested but is afraid to come close."
?L8:	EQUAL? PRSA,V?LISKON \?L9
	CALL PRE-LISKON >STACK
	ZERO? STACK \?L9
	REMOVE GROUPER
	CALL DEQUEUE,I-GROUPER
	CALL DEQUEUE,I-GROUPER-IN-NEST
	PRINTR "The grouper dwindles to the size of a sea bass. Startled and upset, it swims rapidly away."
?L9:	EQUAL? PRSA,V?SNAVIG \?L10
	SET 'CHANGED?,GROUPER
	SET 'ATE-AS-GROUPER?,0
	CALL QUEUE,I-SNAVIG,12
	PRINTI "You change."
	CALL ROB,PLAYER,OCEAN-FLOOR >STACK
	ZERO? STACK /?L11
	PRINTI " You can no longer carry anything."
?L11:	PRINTR " The grouper stares at you with fishy eyes like yours, twiddles fins like yours, opens a huge mouth like yours, and flicking a tail like yours, swims suspiciously around you."
?L10:	EQUAL? PRSA,V?ESPNIS \?L14
	PRINTR "As groupers rarely if ever sleep, this has no effect."
?L14:	EQUAL? PRSA,V?YOMIN \?L15
	PRINTI "The mind of a grouper is hard to focus on, but you get a vision of "
	IN? BREAD,GROUPER /?L18
	IN? FISH,GROUPER \?L16
?L18:	PRINTR "curiosity and expectation: is there any more food to be had?"
?L16:	PRINTR "hunger and curiosity. The last time the grouper saw something like you, it was interesting."
?L15:	CALL HOSTILE-VERB? >STACK
	ZERO? STACK /FALSE
	PRINTI "The grouper is startled but returns after a few moments, its curiosity unsated."
	CRLF
	CALL PRINT-ID,STR?228 >STACK
	RSTACK

	.FUNCT OUBLIETTE-DOWN-EXIT
	ZERO? SMALL-FLAG /?L1
	ZERO? WATER-FLAG /?L3
	PRINTI "The channel is frozen over."
	CRLF
	RFALSE
?L3:	RETURN IN-CHANNEL
?L1:	ZERO? WATER-FLAG /?L6
	IN? WINNER,ICEBERG \?L7
	PRINT YOU-HAVE-TO
	PRINTI " get in the water first"
	PRINT PERIOD
	RFALSE
?L7:	CALL HOLD-BREATH
	RFALSE
?L6:	PRINTI "You'd never fit."
	CRLF
	RFALSE

	.FUNCT OUBLIETTE-UP-EXIT
	GRTR? WATER-FLAG,3 \?L1
	FSET? TRAP-DOOR,OPENBIT \?L3
	IN? PLAYER,ICEBERG \?L5
	MOVE PLAYER,HERE
	RETURN PRISON
?L5:	PRINTI "You still can't quite reach the trap door opening. "
	PRINT YOU-CANT
	PRINTI "get enough momentum thrusting upward out of the water."
	CRLF
	RFALSE
?L3:	CALL THIS-IS-IT,TRAP-DOOR
	CALL TELL-OPEN-CLOSED,TRAP-DOOR
	RFALSE
?L1:	GRTR? WATER-FLAG,0 \?L10
	PRINTI "The oubliette is only "
	GET WATER-HEIGHTS,WATER-FLAG >STACK
	PRINT STACK
	PRINTI " full. "
?L10:	CALL CTHE-PRINT,TRAP-DOOR
	PRINTI " is far over your head. "
	CALL CANT-REACH-IT
	RFALSE

	.FUNCT OUBLIETTE-F,RARG
	EQUAL? RARG,M-LOOK \?L1
	PRINTI "This is an oubliette. "
	GRTR? WATER-FLAG,0 \?L3
	PRINTI "It is "
	GET WATER-HEIGHTS,WATER-FLAG >STACK
	PRINT STACK
	PRINTI " full of icy water. Sheer walls enclose it on all sides. In the ceiling is"
	JUMP ?L5
?L3:	PRINTI "Sheer walls rise for twenty feet above you and lean inward to"
?L5:	PRINTI " a narrow opening"
	FSET? TRAP-DOOR,OPENBIT /?L6
	PRINTI " covered with wooden planks"
?L6:	ZERO? WATER-FLAG \?L9
	ZERO? FREEZE-FLAG \?L11
	PRINTI ". A small but fast-flowing "
	JUMP ?L14
?L11:	EQUAL? FREEZE-FLAG,1 \?L13
	PRINTI ". A partially frozen "
	JUMP ?L14
?L13:	PRINTI ". A completely frozen "
?L14:	PRINTI "channel of water runs along the bottom of the chamber between two pipes"
	JUMP ?L18
?L9:	LESS? WATER-FLAG,4 \?L18
	PRINTI ". The water level is "
	CALL QUEUED?,I-OUBLIETTE-FILLS >STACK
	ZERO? STACK /?L16
	PRINTI "rising"
	JUMP ?L18
?L16:	PRINTI "falling"
?L18:	PRINT PERIOD
	RTRUE
?L1:	EQUAL? RARG,M-BEG \?L20
	EQUAL? PRSA,V?PUT \?L21
	ZERO? WATER-FLAG \?L21
	EQUAL? PRSI,WATER \?L21
	CALL PERFORM,PRSA,PRSO,OUBLIETTE-CHANNEL
	RTRUE
?L21:	GRTR? WATER-FLAG,0 \?L28
	EQUAL? PRSA,V?DROP,V?THROW /?L24
	EQUAL? PRSA,V?PUT \?L23
	EQUAL? PRSI,WATER \?L23
?L24:	CALL IDROP >STACK
	ZERO? STACK /TRUE
	REMOVE PRSO
	PRINTR "Splash! Dropped."
?L23:	GRTR? WATER-FLAG,0 \?L28
	EQUAL? PRSO,INFLOW,OUTFLOW,OUBLIETTE-CHANNEL /?L29
	EQUAL? PRSI,INFLOW,OUTFLOW,OUBLIETTE-CHANNEL \?L28
?L29:	PRINTR "It's under water!"
?L28:	EQUAL? PRSA,V?THROUGH,V?BOARD \?L30
	EQUAL? PRSO,WATER \?L30
	IN? PLAYER,ICEBERG \?L31
	CALL PERFORM,V?DISEMBARK,ICEBERG
	RTRUE
?L31:	GRTR? WATER-FLAG,0 \?L33
	PRINT YOU-ARE
	PRINT PERIOD
	RTRUE
?L33:	CALL PERFORM,PRSA,OUBLIETTE-CHANNEL
	RTRUE
?L30:	EQUAL? PRSA,V?CLIMB-ON \?L35
	EQUAL? PRSO,TRAP-DOOR \?L35
	CALL DO-WALK,P?UP
	RTRUE
?L35:	EQUAL? PRSA,V?LEAP \FALSE
	EQUAL? PRSO,WATER \FALSE
	IN? PLAYER,ICEBERG \FALSE
	CALL PERFORM,V?DISEMBARK
	RTRUE
?L20:	EQUAL? RARG,M-ENTER \?L38
	GRTR? WATER-FLAG,0 \?L39
	PRINTI "You "
	EQUAL? OHERE,WATER-ROOM \?L41
	PRINTI "emerge in"
	JUMP ?L43
?L41:	PRINTI "plunge into the"
?L43:	PRINTI " freezing water and frantically swim to the surface."
	CALL SOAK-PLAYER
	CRLF
	CRLF
?L39:	SET 'FREEZE-COUNT,0
	RFALSE
?L38:	EQUAL? RARG,M-LEAVE \?L45
	SET 'FREEZE-COUNT,0
	RETURN FREEZE-COUNT
?L45:	EQUAL? RARG,M-END \FALSE
	GRTR? WATER-FLAG,0 \FALSE
	IN? PLAYER,ICEBERG /FALSE
	CALL SOAK-PLAYER,1
	INC 'FREEZE-COUNT
	EQUAL? FREEZE-COUNT,5 \?L49
	CRLF
	PRINTI "Your body is becoming numb from the cold of the water."
	CRLF
	CALL PRINT-ID,STR?229 >STACK
	RSTACK
?L49:	EQUAL? FREEZE-COUNT,10 \FALSE
	CALL HYPOTHERMIA >STACK
	RSTACK

	.FUNCT HYPOTHERMIA
	CRLF
	CALL PRINT-ID,STR?230
	CALL JIGS-UP,STR?231 >STACK
	RSTACK

	.FUNCT ICEBERG-F,RARG=0
	EQUAL? RARG,M-BEG \?L1
	EQUAL? PRSA,V?CLIMB-DOWN,V?DISEMBARK /?L5
	EQUAL? PRSA,V?LEAP \FALSE
	EQUAL? PRSO,WATER \FALSE
?L5:	MOVE WINNER,HERE
	PRINTI "You reenter the freezing water."
	CRLF
	CALL PRINT-ID,STR?232 >STACK
	RSTACK
?L1:	ZERO? RARG \FALSE
	EQUAL? PRSA,V?BOARD,V?SIT,V?CLIMB-FOO /?L10
	EQUAL? PRSA,V?CLIMB-ON,V?STAND-ON \?L8
?L10:	IN? WINNER,ICEBERG /?L8
	SET 'FREEZE-COUNT,0
	MOVE WINNER,ICEBERG
	PRINTR "You scramble onto the ice floe."
?L8:	EQUAL? PRSA,V?RUB \FALSE
	PRINTR "It's cold."

	.FUNCT TELL-ABOUT-PIPE
	CALL CTHE-PRINT-PRSO
	PRINTI " is ceramic, about a foot in diameter, and "
	RTRUE

	.FUNCT INFLOW-F
	EQUAL? PRSA,V?EXAMINE \?L1
	CALL TELL-ABOUT-PIPE
	EQUAL? HERE,OUBLIETTE,IN-CHANNEL \?L3
	PRINTI "is here to let water into the channel, presumably for drinking and sanitary purposes"
	JUMP ?L5
?L3:	PRINTI "water is rushing through it"
?L5:	PRINT PERIOD
	RTRUE
?L1:	EQUAL? PRSA,V?THROUGH,V?BOARD \?L6
	ZERO? SMALL-FLAG /?L6
	PRINTR "The current is too swift."
?L6:	CALL FLOW-HACKS >STACK
	RSTACK

	.FUNCT FLOW-HACKS
	EQUAL? PRSA,V?THROUGH,V?BOARD \?L1
	PRINTR "It's much too small for you to fit."
?L1:	EQUAL? PRSA,V?LOOK-INSIDE \?L3
	PRINTR "It's dark and filled with rushing water, so you can't see much."
?L3:	EQUAL? PRSA,V?REACH-IN \?L4
	PRINTR "The pipe extends as far as you can reach."
?L4:	EQUAL? PRSA,V?PUT \?L5
	CALL HELD?,PRSO >STACK
	ZERO? STACK /?L5
	CALL SWEPT-AWAY,PRSO >STACK
	RSTACK
?L5:	EQUAL? PRSA,V?PLUG \FALSE
	CALL HELD?,PRSI >STACK
	ZERO? STACK /FALSE
	CALL SWEPT-AWAY,PRSI >STACK
	RSTACK

	.FUNCT OUTFLOW-F,OUB?
	EQUAL? HERE,IN-CHANNEL,OUBLIETTE /?L1
	SET 'OUB?,0
	JUMP ?L2
?L1:	SET 'OUB?,1
?L2:	EQUAL? PRSA,V?EXAMINE \?L3
	CALL TELL-ABOUT-PIPE
	ZERO? OUB? /?L5
	PRINTI "permits water in the channel to exit the oubliette"
	JUMP ?L7
?L5:	PRINTI "has water flowing out of it"
?L7:	PRINT PERIOD
	RTRUE
?L3:	EQUAL? PRSA,V?THROUGH,V?BOARD \?L8
	ZERO? SMALL-FLAG /?L8
	EQUAL? HERE,OUBLIETTE,RUINS-ROOM /?L9
	PRINTI "It's almost inevitable, given the speed of the current."
	CRLF
	CRLF
?L9:	ZERO? OUB? /?L12
	PUSH IN-PIPE
	JUMP ?L14
?L12:	PUSH IN-SEWER
?L14:	CALL GOTO,STACK >STACK
	RSTACK
?L8:	CALL FLOW-HACKS >STACK
	RSTACK

	.FUNCT IN-CHANNEL-F,RARG
	EQUAL? RARG,M-LOOK \?L1
	PRINTI "You are in a fast flowing stream of very cold water. "
	PRINT LONG-PIPE-DESC-2
	CRLF
	CALL PRINT-ID,STR?233 >STACK
	RSTACK
?L1:	EQUAL? RARG,M-ENTER \?L3
	CALL FUN-IN-PIPE >STACK
	RSTACK
?L3:	EQUAL? RARG,M-END \FALSE
	CALL SOAK-IF-OPENED >STACK
	RSTACK

	.FUNCT SOAK-PLAYER,END?=0
	CALL SOAK-STUFF,PLAYER >STACK
	ZERO? STACK /FALSE
	ZERO? END? \?L3
	PRINTI " "
?L3:	PRINTI "Some of your possessions have been damaged by the water."
	CALL PRINT-ID,STR?234
	ZERO? END? /TRUE
	CRLF
	RTRUE

	.FUNCT SOAK-IF-OPENED
	EQUAL? PRSA,V?OPEN \FALSE
	CALL SOAK-STUFF,PRSO >STACK
	ZERO? STACK /FALSE
	PRINTI "Oh, no! Something has been damaged as water rushed into "
	CALL PRINT-ID,STR?235
	CALL THE-PRSO >STACK
	RSTACK

	.FUNCT WATER-PIPE-F
	EQUAL? PRSA,V?EXAMINE \?L1
	CALL TELL-ABOUT-PIPE
	PRINTI "water flows from one end of it to the other."
	EQUAL? HERE,IN-PIPE-2 \?L3
	PRINTI " A chunk has broken out of the pipe here."
?L3:	CRLF
	RTRUE
?L1:	EQUAL? PRSA,V?PUT \?L6
	CALL HELD?,PRSO >STACK
	ZERO? STACK /?L6
	EQUAL? PRSI,WATER-PIPE \?L6
	CALL SWEPT-AWAY,PRSO >STACK
	RSTACK
?L6:	EQUAL? PRSA,V?PLUG \?L7
	CALL HELD?,PRSI >STACK
	ZERO? STACK /?L7
	CALL SWEPT-AWAY,PRSI >STACK
	RSTACK
?L7:	EQUAL? PRSA,V?THROUGH,V?BOARD \?L8
	PRINT YOU-ARE
	PRINT PERIOD
	RTRUE
?L8:	EQUAL? PRSA,V?DISEMBARK,V?LEAVE \FALSE
	EQUAL? HERE,IN-CHANNEL,RUINED-PIPE \?L10
	CALL DO-WALK,P?UP
	RTRUE
?L10:	PRINTR "There is no way out here."

	.FUNCT SWEPT-AWAY,OBJ
	REMOVE OBJ
	PRINTI "It drops into the water and is swept away by the current."
	CRLF
	CALL PRINT-ID,STR?236 >STACK
	RSTACK

	.FUNCT CHANNEL-F
	EQUAL? PRSA,V?EXAMINE \?L1
	CALL TELL-ABOUT-PIPE
	EQUAL? PRSO,OUBLIETTE-CHANNEL \?L3
	PRINTI "water rushes through it from an inflow pipe at one end to an outflow pipe at the other"
	JUMP ?L5
?L3:	PRINTI "smashed at the top where a huge pillar destroyed the paving above it"
?L5:	PRINT PERIOD
	RTRUE
?L1:	EQUAL? PRSA,V?THROUGH,V?BOARD \?L6
	ZERO? SMALL-FLAG /?L7
	EQUAL? PRSO,OUBLIETTE-CHANNEL \?L9
	PUSH IN-CHANNEL
	JUMP ?L11
?L9:	PUSH RUINED-PIPE
?L11:	CALL GOTO,STACK >STACK
	RSTACK
?L7:	PRINTR "Trying to wet your tootsies, eh? Well, you dabble your feet in the water for a while, but they get pretty cold, and water splashes on the floor."
?L6:	EQUAL? PRSA,V?PUT \?L13
	CALL HELD?,PRSO >STACK
	ZERO? STACK /?L13
	CALL SWEPT-AWAY,PRSO >STACK
	RSTACK
?L13:	EQUAL? PRSA,V?PLUG \?L14
	CALL HELD?,PRSI >STACK
	ZERO? STACK /?L14
	CALL SWEPT-AWAY,PRSI >STACK
	RSTACK
?L14:	EQUAL? PRSA,V?CASKLY \FALSE
	EQUAL? PRSO,RUINS-CHANNEL \FALSE
	PRINTR "This channel was made as perfectly as the technology of the times allowed, and even as a ruin, its essence is still perfect."

	.FUNCT MOSS-PSEUDO
	EQUAL? PRSA,V?EXAMINE,V?RUB \FALSE
	PRINTR "It's green and slimy."

	.FUNCT IN-PIPE-F,RARG
	EQUAL? RARG,M-LOOK \?L1
	PRINT LONG-PIPE-DESC
	PRINT LONG-PIPE-DESC-2
	CRLF
	RTRUE
?L1:	EQUAL? RARG,M-ENTER \?L3
	CALL FUN-IN-PIPE >STACK
	RSTACK
?L3:	EQUAL? RARG,M-END \FALSE
	CALL SOAK-IF-OPENED >STACK
	RSTACK

	.FUNCT IN-PIPE-2-F,RARG
	EQUAL? RARG,M-LOOK \?L1
	PRINT LONG-PIPE-DESC
	PRINTI "On the north side of the pipe is such an irregularity: a large chunk has been knocked out of the pipe, and the slime and moss grows abundantly. "
	IN? CHANGE-CUBE,CHUNK \?L3
	PRINTI "Inside, covered with moss and slime, is something large, white, and apparently cubical. "
?L3:	PRINT LONG-PIPE-DESC-2
	CRLF
	RTRUE
?L1:	EQUAL? RARG,M-ENTER \?L6
	CALL FUN-IN-PIPE >STACK
	RSTACK
?L6:	EQUAL? RARG,M-END \FALSE
	CALL SOAK-IF-OPENED >STACK
	RSTACK

	.FUNCT CHUNK-F
	EQUAL? PRSA,V?EXAMINE \?L1
	PRINTI "A weak spot in the pipe has broken away here, making a smallish crack that has filled with slime and moss."
	IN? CHANGE-CUBE,CHUNK \?L3
	PRINTI " There is a large white object partially obscured by the growth. It is held in the crack by the force of the current."
?L3:	CRLF
	RTRUE
?L1:	EQUAL? PRSA,V?REACH-IN,V?RUB \?L6
	PRINTI "You reach into the crack and touch "
	IN? CHANGE-CUBE,CHUNK \?L7
	PRINTR "the cube. Don't you want to take it, too?"
?L7:	PRINTR "moss."
?L6:	EQUAL? PRSA,V?THROUGH,V?BOARD \?L10
	PRINTR "It's too small to enter. It's large enough to reach into, though."
?L10:	EQUAL? PRSA,V?PUT \FALSE
	EQUAL? PRSI,CHUNK \FALSE
	FIRST? PRSI >STACK \?L12
	PRINT NO-ROOM
	CRLF
	RTRUE
?L12:	GETPT PRSO,P?NAME >STACK
	ZERO? STACK /FALSE
	REMOVE PRSO
	PRINTI "You put "
	CALL THE-PRINT-PRSO
	PRINTR " in the crack, but the moss won't hold it in any longer, and the current carries it away before you can retrieve it."

	.FUNCT RUINED-PIPE-F,RARG
	EQUAL? RARG,M-LOOK \?L1
	PRINTR "The pipe here is smashed from the top where a huge pillar has toppled over onto it. Cyclopean ruins are all around you. The cracks and fissures in the pipe might make it possible to climb out here. The water is fast and loud around you."
?L1:	EQUAL? RARG,M-ENTER \?L3
	CALL FUN-IN-PIPE >STACK
	RSTACK
?L3:	EQUAL? RARG,M-END \FALSE
	CALL SOAK-IF-OPENED >STACK
	RSTACK

	.FUNCT FUN-IN-PIPE
	CALL QUEUE,I-DOWNSTREAM,3
	EQUAL? OHERE,OUBLIETTE,RUINS-ROOM \FALSE
	PRINTI "You enter the cold, fast-flowing water."
	CALL SOAK-PLAYER
	CRLF
	CRLF
	RTRUE

	.FUNCT IN-SEWER-F,RARG
	EQUAL? RARG,M-ENTER \FALSE
	CALL PRINT-ID,STR?237
	CALL JIGS-UP,STR?238 >STACK
	RSTACK

	.FUNCT PRISON-DOWN-EXIT
	FSET? TRAP-DOOR,OPENBIT \?L1
	ZERO? WATER-FLAG /?L3
	RETURN OUBLIETTE
?L3:	CALL PRINT-ID,STR?239
	CALL JIGS-UP,STR?240
	RFALSE
?L1:	CALL TELL-OPEN-CLOSED,TRAP-DOOR
	RFALSE

	.FUNCT PRISON-F,RARG
	EQUAL? RARG,M-LOOK \FALSE
	PRINTI "This is a dark, dank, forgotten dungeon. It is overgrown with moss, fungus, and slime. The floor is slippery. At your feet "
	FSET? TRAP-DOOR,OPENBIT \?L3
	PRINTI "an open trap door leads down into blackness."
	JUMP ?L5
?L3:	PRINTI "is a closed trap door."
?L5:	PRINTR " A corridor leads east and stairs lead up."

	.FUNCT TRAP-DOOR-F
	EQUAL? PRSA,V?EXAMINE \?L1
	PRINTI "This is a sturdy oak trap door, but it is obviously rarely used, as it is covered with mold, cobwebs, and dirt. "
	CALL TELL-OPEN-CLOSED,TRAP-DOOR >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?OPEN,V?CLOSE \?L3
	EQUAL? HERE,OUBLIETTE \FALSE
	LESS? WATER-FLAG,4 /?L7
	IN? PLAYER,ICEBERG /?L6
?L7:	CALL CANT-REACH-IT >STACK
	RSTACK
?L6:	CALL OPEN-CLOSE >STACK
	RSTACK
?L3:	EQUAL? PRSA,V?REZROV \?L9
	FSET? TRAP-DOOR,OPENBIT /?L9
	FSET TRAP-DOOR,OPENBIT
	PRINTR "The trap door creaks open upon rusty hinges."
?L9:	EQUAL? PRSA,V?THROUGH,V?BOARD \FALSE
	EQUAL? HERE,PRISON \?L11
	PUSH P?DOWN
	JUMP ?L13
?L11:	PUSH P?UP
?L13:	CALL DO-WALK,STACK >STACK
	RSTACK

	.FUNCT CABINET-F,RARG=0,L
	EQUAL? RARG,M-BEG \?L1
	LOC WINNER >L
	EQUAL? PRSA,V?LOOK \?L3
	FSET? L,OPENBIT /?L3
	CALL TELL-OPEN-CLOSED,L >STACK
	RSTACK
?L3:	EQUAL? PRSA,V?WALK \?L5
	PRINT YOU-HAVE-TO
	PRINTI " get out of the "
	PRINTD CABINET
	PRINTI " first"
	PRINT PERIOD
	RTRUE
?L5:	EQUAL? PRSA,V?DISEMBARK \?L6
	FSET? L,OPENBIT /?L6
	CALL TELL-OPEN-CLOSED,L >STACK
	RSTACK
?L6:	EQUAL? PRSA,V?OPEN \FALSE
	EQUAL? PRSO,CABINET,PAST-CABINET \FALSE
	FSET? PRSO,OPENBIT /FALSE
	FSET PRSO,OPENBIT
	PRINTR "Opened."
?L1:	ZERO? RARG \FALSE
	EQUAL? PRSA,V?EXAMINE \?L10
	PRINTI "This massive cabinet fills most of one wall. It's made of oak and looks "
	EQUAL? HERE,CELL-EAST \?L12
	PRINTI "better preserved than anything else in the room. Its lock is corroded and unusable. "
	JUMP ?L14
?L12:	PRINTI "quite sturdy. It has a strong lock. "
?L14:	CALL TELL-OPEN-CLOSED,PRSO >STACK
	RSTACK
?L10:	EQUAL? PRSA,V?BOARD \?L15
	FSET? PRSO,OPENBIT /?L16
	CALL TELL-OPEN-CLOSED,PRSO >STACK
	RSTACK
?L16:	ZERO? SHRINK-FLAG \FALSE
	PRINTR "You're too big. It isn't very deep."
?L15:	EQUAL? PRSA,V?HIDE \?L20
	PRINT NO-ROOM
	CRLF
	RTRUE
?L20:	EQUAL? PRSA,V?OPEN \?L21
	FSET? PRSO,LOCKED \?L21
	PRINTR "The cabinet is locked."
?L21:	EQUAL? PRSA,V?LOCK,V?UNLOCK \?L22
	EQUAL? HERE,CELL-EAST \?L22
	PRINTR "The lock has corroded into a mass of rust."
?L22:	EQUAL? PRSA,V?UNLOCK \?L23
	EQUAL? PRSI,KEY \?L23
	ZERO? FAKE-KEY /?L24
	PRINTI "As you insert the key into the lock, it disappears, and a vision of Belboz materializes before you!"
	CRLF
	CALL FORLORN-ENCYSTMENT >STACK
	RSTACK
?L24:	FCLEAR PRSO,LOCKED
	PRINTR "Unlocked."
?L23:	EQUAL? PRSA,V?LOCK \?L27
	EQUAL? PRSI,KEY \?L27
	FSET? PRSO,RMUNGBIT \?L28
	PRINTR "The lock has been burst."
?L28:	FSET? PRSO,LOCKED /?L30
	FCLEAR CABINET,OPENBIT
	FSET PRSO,LOCKED
	PRINTR "Locked."
?L30:	PRINTR "It already is."
?L27:	EQUAL? PRSA,V?REZROV \FALSE
	FSET? PRSO,OPENBIT /FALSE
	FSET PRSO,RMUNGBIT
	FCLEAR PRSO,LOCKED
	FSET PRSO,OPENBIT
	PRINTI "The cabinet bursts open"
	CALL PRINT-ID,STR?241
	IN? PLAYER,CABINET /?L33
	IN? PLAYER,PAST-CABINET /?L33
	FIRST? PRSO >STACK \?L33
	PRINTI ", revealing "
	CALL PRINT-CONTENTS,PRSO
?L33:	PRINTR "!"

	.FUNCT DEAD-BOOK-F,SPELL
	EQUAL? PRSA,V?EXAMINE,V?READ,V?OPEN \?L1
	PRINTI "This book has been almost completely destroyed by mold and rot. You can tell only that it was once a "
	PRINTD SPELL-BOOK
	PRINTI "."
	CALL PRINT-ID,STR?242
	FSET? PRSO,RMUNGBIT \?L3
	PRINTR " None of the spells are legible any longer."
?L3:	IN? SNAVIG-SPELL,DEAD-BOOK \?L5
	PRINTI " Only one spell is still readable. It says """
	PRINTD SNAVIG-SPELL
	PRINTI ": "
	GETP SNAVIG-SPELL,P?TEXT >STACK
	PRINT STACK
	PRINTI "."""
?L5:	CRLF
	RTRUE
?L1:	EQUAL? PRSA,V?CASKLY \?L7
	FSET? DEAD-BOOK,RMUNGBIT \FALSE
	PRINTI "The book glows brightly for a moment. "
	CALL PRINT-ID,STR?243
	FSET? HERE,RWATERBIT \?L10
	PRINTI "The water quenches it immediately"
	JUMP ?L12
?L10:	FCLEAR DEAD-BOOK,RMUNGBIT
	MOVE SNAVIG-SPELL,DEAD-BOOK
	ADD SCORE,DEAD-BOOK-SCORE >SCORE
	SET 'DEAD-BOOK-SCORE,0
	PRINTI "The mold and rot retreat as you watch. While not good as new, the book looks much better"
?L12:	PRINT PERIOD
	RTRUE
?L7:	EQUAL? PRSA,V?GNUSTO \FALSE
	IN? PRSO,WINNER /?L15
	PRINTR "You must be holding the book to copy from it!"
?L15:	FIRST? PRSO >SPELL \?L17
	CALL PERFORM,V?GNUSTO,SPELL
	RTRUE
?L17:	PRINTI "There's no spell in "
	CALL THE-PRSO >STACK
	RSTACK

	.FUNCT CELL-PSEUDO
	EQUAL? PRSA,V?EXAMINE,V?LOOK-INSIDE \?L1
	PRINT IT-LOOKS-LIKE
	PRINTR "a prison cell."
?L1:	EQUAL? PRSA,V?THROUGH \?L3
	CALL DO-WALK,P?NORTH >STACK
	RSTACK
?L3:	EQUAL? PRSA,V?EXIT \FALSE
	CALL DO-WALK,P?SOUTH >STACK
	RSTACK

	.FUNCT GUARD-TOWER-F,RARG
	EQUAL? RARG,M-LOOK \?L1
	PRINTR "This is the guard tower of a crumbling castle. It overlooks a mountainous landscape of tarns, tumbled rock, and twisted low trees. The vegetation is in browns, blacks, and ochres. The only real color is provided by a distant volcano which lights the lowering clouds with bright red and yellow coruscations. The only exit is down."
?L1:	EQUAL? RARG,M-ENTER \FALSE
	SET 'SEEN-TOWER?,1
	MOVE ROC,HERE
	SET 'ROC-COUNT,0
	CALL QUEUE,I-ROC,-1 >STACK
	RSTACK

	.FUNCT ROC-GRABS-PLAYER,FALL?=0
	MOVE ROC,HERE
	MOVE PLAYER,ROC
	SET 'ROC-FLY-COUNT,0
	SET 'FALLING?,0
	CALL DEQUEUE,I-FALLING
	CALL QUEUE,I-ROC-FLY,-1
	CRLF
	ZERO? FALL? /?L1
	PRINTI "Suddenly, from above, you are hit by a crashing blow! You twist and see that a huge bird has taken you in its talons. The"
	JUMP ?L3
?L1:	PRINTI "The bird dives for you, its talons outstretched. As it nears, you realize that rather than vulture or even condor size, the"
?L3:	PRINTI " bird is nearly the size of an elephant. It closes its huge claws gently around you, squawks (nearly suffocating you with its fetid breath), and takes off towards the west."
	CRLF
	CALL PRINT-ID,STR?244 >STACK
	RSTACK

	.FUNCT DESCRIBE-ROC
	SUB ROC-COUNT,1 >STACK
	GET ROC-DESCS,STACK >STACK
	PRINT STACK
	CRLF
	RTRUE

	.FUNCT ROC-DESC,RARG,OBJ
	EQUAL? HERE,GUARD-TOWER /TRUE
	EQUAL? HERE,ROC-NEST \FALSE
	PRINTR "The roc perches on the side of the nest, watching you intently."

	.FUNCT ROC-GRIPS-YOU-FIRMLY,SPELL?=0
	PRINTI "The roc grips you firmly in its talons. Your "
	ZERO? SPELL? /?L1
	PRINTI "attempts to cast a spell"
	JUMP ?L3
?L1:	PRINTI "struggles"
?L3:	PRINTR " just make it hold you tighter."

	.FUNCT ROC-F,RARG=0
	EQUAL? WINNER,ROC \?L1
	PRINTI "The roc is intent upon its "
	EQUAL? HERE,ROC-NEST \?L3
	IN? BABY-ROC,HERE \?L5
	PRINTI "chick"
	JUMP ?L8
?L5:	PRINTI "egg"
	JUMP ?L8
?L3:	PRINTI "mission"
?L8:	PRINT PERIOD
	CALL END-QUOTE >STACK
	RSTACK
?L1:	EQUAL? RARG,M-BEG \?L9
	EQUAL? PRSA,V?DROP \?L10
	CALL DROP-IN-AIR >STACK
	RSTACK
?L10:	EQUAL? PRSA,V?BOARD \?L12
	EQUAL? PRSO,ROC \?L13
	PRINTR "It would rather carry you."
?L13:	CALL ROC-GRIPS-YOU-FIRMLY >STACK
	RSTACK
?L12:	CALL SPELL-VERB? >STACK
	ZERO? STACK /?L16
	CALL ROC-GRIPS-YOU-FIRMLY,1 >STACK
	RSTACK
?L16:	EQUAL? PRSA,V?WALK,V?LEAP,V?DISEMBARK /?L18
	EQUAL? PRSA,V?CLIMB-DOWN,V?SIT \FALSE
?L18:	CALL ROC-GRIPS-YOU-FIRMLY >STACK
	RSTACK
?L9:	ZERO? RARG \FALSE
	CALL HOSTILE-VERB? >STACK
	ZERO? STACK /?L21
	IN? PLAYER,ROC \?L21
	PRINTI "The roc twists its ugly head around, squawks at you warningly, and continues flying."
	CRLF
	CALL PRINT-ID,STR?245 >STACK
	RSTACK
?L21:	EQUAL? PRSA,V?EXAMINE \?L23
	IN? PLAYER,ROC \?L24
	PRINTR "The roc is a female of enormous size. It resembles a huge raptor, such as an eagle or perhaps a falcon, but the size of a house. It doesn't smell very good and is infested with fleas."
?L24:	EQUAL? HERE,GUARD-TOWER \?L26
	GRTR? ROC-COUNT,0 \?L26
	PRINT IT-LOOKS-LIKE
	PRINTI "a "
	CALL DESCRIBE-ROC >STACK
	RSTACK
?L26:	PRINTR "The roc is a huge raptor and resembles an eagle."
?L23:	EQUAL? HERE,GUARD-TOWER \?L28
	LESS? ROC-COUNT,4 \?L28
	PRINT TOO-FAR
	RTRUE
?L28:	EQUAL? PRSA,V?GIVE \?L29
	CALL PRINT-ID,STR?246
	EQUAL? PRSO,FISH \?L30
	CALL GOBBLES-IT >STACK
	RSTACK
?L30:	CALL UNINTERESTED,ROC >STACK
	RSTACK
?L29:	EQUAL? PRSA,V?SMELL \?L33
	PRINTI "The roc smells like old, rotting meat. As it's a scavenger, this is to be expected."
	CRLF
	CALL PRINT-ID,STR?247 >STACK
	RSTACK
?L33:	EQUAL? PRSA,V?BOARD,V?SIT,V?CLIMB-UP /?L35
	EQUAL? PRSA,V?CLIMB-FOO \?L34
?L35:	IN? PLAYER,ROC /FALSE
	PRINTR "The roc isn't interested in carrying you any more."
?L34:	EQUAL? PRSA,V?YOMIN \?L39
	PRINTR "You sense a strong maternal urge."
?L39:	EQUAL? PRSA,V?ESPNIS,V?SNAVIG,V?LISKON /?L41
	EQUAL? PRSA,V?GIRGOL \FALSE
?L41:	CALL ROC-SQUAWKS >STACK
	RSTACK

	.FUNCT GOBBLES-IT
	REMOVE PRSO
	CALL CTHE-PRINT-PRSI
	PRINTR " gobbles it down."

	.FUNCT NEST-PSEUDO
	EQUAL? PRSA,V?EXAMINE,V?LOOK-INSIDE \?L1
	EQUAL? HERE,MIDAIR,ROC-NEST \?L5
	ZERO? NS-COUNT \?L5
	ZERO? EW-COUNT /?L3
?L5:	PRINT YOU-CANT-SEE
	PRINTR "a nest here."
?L3:	PRINT IT-LOOKS-LIKE
	PRINTI "a "
	EQUAL? HERE,ROC-NEST \?L7
	PRINTR "huge mass of trees woven together."
?L7:	PRINTI "giant bird's nest."
	FIRST? ROC-NEST >STACK \?L10
	PRINTI " There are some things in the nest."
?L10:	CRLF
	RTRUE
?L1:	EQUAL? PRSA,V?DROP,V?DISEMBARK,V?LEAVE \FALSE
	IN? PLAYER,MAGIC-CARPET \?L14
	PUSH P?UP
	JUMP ?L16
?L14:	PUSH P?OUT
?L16:	CALL DO-WALK,STACK >STACK
	RSTACK

	.FUNCT ROC-NEST-F,RARG
	EQUAL? RARG,M-LOOK \?L1
	PRINTI "This nest is made from skillfully woven tree trunks, small bushes, and large amounts of mud and roc guano for glue. Giant black feathers are everywhere. In the center of the nest "
	FSET? EGG,RMUNGBIT \?L3
	PRINTI "is a hungry baby roc and the fragments of a hatched egg"
	JUMP ?L5
?L3:	PRINTI "is an egg the size of a small wagon"
?L5:	FSET? CONNECTIVITY-CUBE,TOUCHBIT /?L6
	FSET? EGG,RMUNGBIT /?L6
	PRINTI ". Nestled beneath the egg is a "
	PRINT WHITE-CUBE
?L6:	PRINT PERIOD
	RTRUE
?L1:	EQUAL? RARG,M-BEG \?L9
	EQUAL? PRSA,V?LEAP \?L10
	EQUAL? PRSO,0,ROOMS \?L10
	CALL DO-WALK,P?OUT >STACK
	RSTACK
?L10:	EQUAL? PRSA,V?LOOK-DOWN \?L12
	PRINTR "It's a long, unclimbable way down."
?L12:	EQUAL? PRSA,V?TAKE \FALSE
	EQUAL? PRSO,CONNECTIVITY-CUBE \FALSE
	FSET? EGG,RMUNGBIT /FALSE
	IN? ROC,HERE \FALSE
	EQUAL? TIME-STOPPED?,HERE /FALSE
	PRINTR "The roc, convinced you are threatening its precious egg, drives you away before you can snatch the cube."
?L9:	EQUAL? RARG,M-ENTER \FALSE
	IN? ROC,HERE /?L16
	FSET? EGG,RMUNGBIT /?L16
	CALL QUEUED?,I-ROC-HATCHES >STACK
	ZERO? STACK \?L16
	CALL QUEUE,I-ROC-HATCHES,5 >STACK
	RSTACK
?L16:	IN? BABY-ROC,HERE \FALSE
	CALL JIGS-UP,STR?248 >STACK
	RSTACK

	.FUNCT EGG-F,MOM?=0
	FSET? EGG,RMUNGBIT \?L1
	PRINTR "There isn't much of the egg left to deal with."
?L1:	EQUAL? PRSA,V?EXAMINE \?L3
	PRINT IT-LOOKS-LIKE
	PRINTR "it's going to hatch soon."
?L3:	EQUAL? PRSA,V?LOOK-UNDER \?L4
	PRINTI "There's dirt, guano, detritus, and "
	FSET? CONNECTIVITY-CUBE,TOUCHBIT \?L5
	PRINTI "feathers"
	JUMP ?L7
?L5:	PRINTI "a "
	PRINTD CONNECTIVITY-CUBE
?L7:	PRINTR " there."
?L4:	CALL HOSTILE-VERB? >STACK
	ZERO? STACK \?L9
	EQUAL? PRSA,V?OPEN,V?RAISE \?L8
?L9:	CALL IMMOBILIZED? >STACK
	ZERO? STACK \TRUE
	IN? ROC,HERE \?L12
	PRINTI "The mother roc prevents you."
	CRLF
	CALL PRINT-ID,STR?249 >STACK
	RSTACK
?L12:	CALL DEQUEUE,I-ROC-HATCHES
	CALL I-ROC-HATCHES,1 >STACK
	RSTACK
?L8:	EQUAL? PRSA,V?ESPNIS,V?SNAVIG,V?LISKON /?L15
	EQUAL? PRSA,V?GIRGOL \FALSE
?L15:	CALL ROC-SQUAWKS >STACK
	RSTACK

	.FUNCT ROC-SQUAWKS,MOM?=0
	IN? ROC,HERE \?L1
	SET 'MOM?,1
?L1:	ZERO? MOM? \?L6
	IN? BABY-ROC,HERE \FALSE
?L6:	PRINTI "The "
	ZERO? MOM? /?L7
	PRINTI "mother"
	JUMP ?L9
?L7:	PRINTI "baby"
?L9:	PRINTR " roc hears you preparing the spell and squawks at you so raucously that your concentration is destroyed, and the spell misfires."

	.FUNCT BABY-ROC-F,MOM?=0
	EQUAL? PRSA,V?EXAMINE \?L1
	PRINTR "The roc chick is much larger than you, nearly featherless, and very hungry."
?L1:	EQUAL? PRSA,V?TAKE \?L3
	PRINTI "It's only about three times your size."
	CRLF
	CALL PRINT-ID,STR?250 >STACK
	RSTACK
?L3:	EQUAL? PRSA,V?GIVE \?L4
	CALL HELD?,PRSO >STACK
	ZERO? STACK /?L4
	CALL PRINT-ID,STR?251
	CALL GOBBLES-IT >STACK
	RSTACK
?L4:	CALL HOSTILE-VERB? >STACK
	ZERO? STACK /?L5
	PRINTI "The baby roc defends itself quite successfully."
	CRLF
	CALL PRINT-ID,STR?252 >STACK
	RSTACK
?L5:	EQUAL? PRSA,V?YOMIN \?L6
	PRINTR "You sense ravenous hunger."
?L6:	EQUAL? PRSA,V?ESPNIS,V?SNAVIG,V?LISKON /?L8
	EQUAL? PRSA,V?GIRGOL \FALSE
?L8:	CALL ROC-SQUAWKS >STACK
	RSTACK

	.FUNCT MIDAIR-EXIT
	ZERO? FALL-WARNING? \?L3
	IN? PLAYER,MAGIC-CARPET \?L1
?L3:	RETURN MIDAIR
?L1:	SET 'FALL-WARNING?,1
	PRINTI "You pull back at the edge, noticing just in time that the hole in the floor opens into thin air which goes a long way down before anything solid is reached."
	CRLF
	RFALSE

	.FUNCT AIR-ROOM-F,RARG
	EQUAL? RARG,M-LOOK \?L1
	PRINTR "You are on a large fluffy white cloud. In fact, you are surrounded by clouds. They blow past, wind seeming to boil them around you from all sides. There is a bit of clear air to the north, momentary gaps in the clouds to the south and west, and an alarming one below you."
?L1:	EQUAL? RARG,M-LEAVE \FALSE
	CALL RECOVER-CUBE >STACK
	RSTACK

	.FUNCT GLACIER-ROOM-F,RARG
	EQUAL? RARG,M-LOOK \?L1
	PRINTR "You are in the midst of a trackless glacier in the Flathead Mountains. Snow blows around you, the wind complaining of its own discomfort. This is a desolate and dangerous place, for there are crevasses everywhere under the deceptive blanket of snow."
?L1:	EQUAL? RARG,M-BEG \?L3
	EQUAL? PRSA,V?WALK \FALSE
	RANDOM 100 >STACK
	LESS? 75,STACK /?L6
	CALL PRINT-ID,STR?253
	CALL JIGS-UP,STR?254 >STACK
	RSTACK
?L6:	CALL GOTO,GLACIER-ROOM >STACK
	RSTACK
?L3:	EQUAL? RARG,M-LEAVE \?L10
	SET 'FREEZE-COUNT,0
	RETURN FREEZE-COUNT
?L10:	EQUAL? RARG,M-END \FALSE
	INC 'FREEZE-COUNT
	EQUAL? FREEZE-COUNT,5 \?L12
	CRLF
	PRINTI "Your body is becoming numb from the cold."
	CRLF
	CALL PRINT-ID,STR?255 >STACK
	RSTACK
?L12:	EQUAL? FREEZE-COUNT,10 \FALSE
	CRLF
	CALL PRINT-ID,STR?256
	CALL JIGS-UP,STR?257 >STACK
	RSTACK

	.FUNCT GLACIER-PSEUDO
	EQUAL? PRSA,V?EXAMINE \?L1
	PRINTR "The ice glints so brightly that you are almost blinded."
?L1:	EQUAL? PRSA,V?TINSOT \FALSE
	PRINTR "Coals to Newcastle, if you ask me."

	.FUNCT CARPET-PSEUDO
	EQUAL? PRSA,V?EXAMINE \?L1
	PRINTR "They are beautiful examples of the weaver's art."
?L1:	EQUAL? PRSA,V?TAKE \?L3
	PRINTI "You might be accused of thievery."
	CRLF
	CALL PRINT-ID,STR?258 >STACK
	RSTACK
?L3:	EQUAL? PRSA,V?BUY \FALSE
	PRINT MORE-SPECIFIC
	PRINT PERIOD
	RTRUE

	.FUNCT SIGN-PSEUDO
	EQUAL? PRSA,V?READ,V?EXAMINE \FALSE
	PRINTR "The sign might as well be Greek."

	.FUNCT EMPORIUM-F,RARG
	EQUAL? RARG,M-LOOK \?L1
	PRINTR "This is the middle of a huge emporium. Signs in a language unknown to you grace the displays. Most of the objects displayed are ornately woven rugs. There is an exit into the street to the west."
?L1:	EQUAL? RARG,M-ENTER \?L3
	CALL QUEUE,I-KICKED-OUT,50
	CALL QUEUE,I-MERCHANT,-1 >STACK
	RSTACK
?L3:	EQUAL? RARG,M-LEAVE \?L4
	CALL HELD?,MAGIC-CARPET >STACK
	ZERO? STACK \?L7
	CALL HELD?,RANDOM-CARPET >STACK
	ZERO? STACK /?L5
?L7:	FSET EMPORIUM-DOOR,LOCKED
	FCLEAR EMPORIUM-DOOR,OPENBIT
?L5:	CALL DEQUEUE,I-MERCHANT >STACK
	RSTACK
?L4:	EQUAL? RARG,M-BEG \FALSE
	EQUAL? PRSA,V?NO,V?YES \?L10
	PRINTR """Words are trifles! Let me see your zorkmids!"" chides the merchant."
?L10:	CALL SPELL-VERB? >STACK
	ZERO? STACK /FALSE
	PRINTI "The spell trickles away to nothing. The merchant smiles. ""Do you think you are the first magician to try to use lawless, thieving magic on a humble merchant?"""
	CALL KICKED-OUT
	RTRUE

	.FUNCT EMPORIUM-DOOR-F
	EQUAL? PRSA,V?OPEN,V?KNOCK,V?REZROV /?L3
	EQUAL? PRSA,V?THROUGH \FALSE
?L3:	FSET? EMPORIUM-DOOR,LOCKED \?L1
	CALL MERCHANT-AT-DOOR >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?THROUGH \FALSE
	EQUAL? HERE,BAZAAR \?L5
	PUSH P?EAST
	JUMP ?L7
?L5:	PUSH P?WEST
?L7:	CALL DO-WALK,STACK >STACK
	RSTACK

	.FUNCT MERCHANT-AT-DOOR
	PRINT DOOR-LOCKED
	PRINTR ", apparently by powerful magic. When you attempt entry, the merchant opens a small panel in the door and recognizes you. ""We're closed for lunch!"" He slams the panel shut."

	.FUNCT EMPORIUM-EXIT
	FSET? EMPORIUM-DOOR,LOCKED \?L1
	CALL THIS-IS-IT,EMPORIUM-DOOR
	CALL MERCHANT-AT-DOOR
	RFALSE
?L1:	FSET? EMPORIUM-DOOR,OPENBIT \?L3
	RETURN EMPORIUM
?L3:	CALL TELL-OPEN-CLOSED,EMPORIUM-DOOR
	RFALSE

	.FUNCT ZORKMID-F
	EQUAL? PRSA,V?EXAMINE,V?READ \FALSE
	PRINTR "This is a gold 500 zorkmid piece."

	.FUNCT MERCHANT-DESC,RARG,OBJ
	PRINTI "A young and earnest-looking merchant stands near a pile of carpets"
	FIRST? MERCHANT >STACK \?L9
	PRINTI ". He is carrying in his arms a "
	IN? MAGIC-CARPET,MERCHANT \?L5
	PRINTD MAGIC-CARPET
	PRINTI " with a design of cubes on it"
	IN? RANDOM-CARPET,MERCHANT \?L9
	PRINTI " and a "
?L5:	IN? RANDOM-CARPET,MERCHANT \?L9
	PRINTD RANDOM-CARPET
	PRINTI " that's shabby and badly made"
?L9:	PRINT PERIOD
	RTRUE

	.FUNCT MERCHANT-F,RARG=0,PREV
	SET 'MERCHANT-FLAG,1
	EQUAL? WINNER,MERCHANT \?L1
	EQUAL? PRSA,V?TELL-ABOUT \?L3
	EQUAL? PRSO,ME /FALSE
?L3:	EQUAL? PRSA,V?HELLO \?L5
	PRINTR """Greetings to you! May I be of assistance?"""
?L5:	EQUAL? PRSA,V?TELL-ME-ABOUT /?L7
	EQUAL? PRSA,V?GIVE,V?SELL \?L6
	EQUAL? PRSI,ME \?L6
?L7:	CALL ASK-ABOUT-CARPET,PRSO >STACK
	RSTACK
?L6:	ZERO? YOUR-OFFER \?L8
	PRINTR """Would you care to purchase a fine carpet?"""
?L8:	PRINTR """Come, come. I haven't all day."""
?L1:	EQUAL? RARG,M-CONTAINER \?L10
	EQUAL? PRSA,V?EXAMINE /FALSE
	EQUAL? PRSA,V?BUY \?L13
	EQUAL? PRSI,OPAL,ZORKMID \?L14
	SET 'ASKED-FOR,PRSO
	CALL PERFORM,V?GIVE,PRSI,MERCHANT
	RTRUE
?L14:	ZERO? YOUR-OFFER \?L16
	ZERO? MERCHANT-COUNT \?L16
	SET 'ASKED-FOR,PRSO
	CALL MAKE-NEW-OFFER >STACK
	RSTACK
?L16:	CALL ASK-ABOUT-CARPET,PRSO >STACK
	RSTACK
?L13:	EQUAL? PRSA,V?TAKE,V?POINT,V?RUB /?L19
	EQUAL? PRSA,V?ADMIRE,V?POINT \?L18
?L19:	CALL ASK-ABOUT-CARPET,PRSO >STACK
	RSTACK
?L18:	EQUAL? PRSA,V?FIND /FALSE
	PRINTR """Your obvious eagerness to do business is matched only by your boorish manners."""
?L10:	ZERO? RARG \FALSE
	EQUAL? PRSA,V?EXAMINE \?L23
	EQUAL? PRSO,MERCHANT \?L23
	PRINTR "The merchant is extremely anxious to please. He looks as if it might be his first day on the job. He's a young fellow wearing purple trousers which bulge alarmingly at the knees, an orange-striped shirt and a small hat. He has a detestable moustache."
?L23:	EQUAL? PRSA,V?BARGAIN \?L25
	PRINTR """This is precisely my intention!"""
?L25:	EQUAL? PRSA,V?GIVE,V?SHOW \FALSE
	EQUAL? PRSI,MERCHANT \FALSE
	EQUAL? PRSO,MAGIC-CARPET \?L27
	CALL PERFORM,V?TAKE,RANDOM-CARPET
	RTRUE
?L27:	EQUAL? PRSO,RANDOM-CARPET \?L29
	CALL PERFORM,V?TAKE,MAGIC-CARPET
	RTRUE
?L29:	GRTR? MERCHANT-WANTS,YOUR-OFFER /?L30
	PRINTR """But we've already made a deal! I can't accept anything additional!"""
?L30:	EQUAL? PRSO,OPAL /?L32
	EQUAL? PRSO,ZORKMID,INTNUM \?L31
?L32:	CALL NEW-OFFER >STACK
	RSTACK
?L31:	GETP PRSO,P?CUBE >STACK
	ZERO? STACK /?L33
	PRINTR """A mere gewgaw, hardly worth a single zorkmid!"""
?L33:	FSET? PRSO,MAGICBIT /?L35
	FSET? PRSO,SCROLLBIT \?L34
?L35:	PRINTR """That sort of thing is worthless to me. I am a simple man with no interest in magic!"""
?L34:	PRINTR """You insult me. You insult my wife, you insult my children, you insult even my lowliest, mangiest dog."""

	.FUNCT ASK-ABOUT-CARPET,OBJ
	ZERO? YOUR-OFFER \?L1
	EQUAL? PRSA,V?ASK-ABOUT,V?ASK-FOR,V?TELL-ME-ABOUT /?L5
	EQUAL? PRSA,V?ADMIRE,V?POINT /?L5
	EQUAL? OBJ,MAGIC-CARPET,RANDOM-CARPET /?L3
?L5:	PRINTI """I see you have excellent taste. Let me tell you about these fine carpets"
	EQUAL? OBJ,MAGIC-CARPET,RANDOM-CARPET /?L6
	PRINTI " instead"
	JUMP ?L8
?L6:	SET 'ASKED-FOR,OBJ
?L8:	PRINTR ". They are my pride and joy, next of course to my nieces and nephews, but I digress... These carpets are the best you will find anywhere."""
?L3:	SET 'ASKED-FOR,OBJ
	PRINTR """This is a valuable carpet. What will you offer for it? I'm not in business for my health."""
?L1:	LESS? YOUR-OFFER,MERCHANT-WANTS \?L10
	PRINTR """A serious offer, now! Enough of this game-playing!"""
?L10:	EQUAL? OBJ,MAGIC-CARPET \?L11
	IN? OBJ,MERCHANT \?L11
	EQUAL? ASKED-FOR,MAGIC-CARPET \?L12
	IN? RANDOM-CARPET,PLAYER \?L14
	PRINTI """How silly of me! You wanted this one with the cubes, didn't you?"" He gives it to you"
	JUMP ?L16
?L14:	PRINTI "He grudgingly gives you the "
	PRINTD MAGIC-CARPET
?L16:	IN? PLAYER,RANDOM-CARPET \?L17
	MOVE PLAYER,HERE
?L17:	MOVE RANDOM-CARPET,MERCHANT
	MOVE MAGIC-CARPET,PLAYER
	CALL SCORE-OBJECT,MAGIC-CARPET
	IN? RANDOM-CARPET,MERCHANT /?L20
	PRINTI ", retrieving the "
	PRINTD RANDOM-CARPET
?L20:	PRINT PERIOD
	RTRUE
?L12:	EQUAL? ASKED-FOR,RANDOM-CARPET \FALSE
	PRINTR """No going back on our deal! I'll report you to the merchants' association!"""
?L11:	EQUAL? OBJ,RANDOM-CARPET \?L25
	IN? OBJ,MERCHANT \?L25
	SET 'ASKED-FOR,RANDOM-CARPET
	PRINTI "He hurriedly gives you the "
	PRINTD RANDOM-CARPET
	IN? MAGIC-CARPET,MERCHANT /?L26
	PRINTI ", retrieving the "
	PRINTD MAGIC-CARPET
?L26:	IN? PLAYER,MAGIC-CARPET \?L29
	MOVE PLAYER,HERE
?L29:	MOVE MAGIC-CARPET,MERCHANT
	MOVE RANDOM-CARPET,PLAYER
	PRINT PERIOD
	RTRUE
?L25:	PRINTI """Yes? What about "
	CALL THE-PRINT,OBJ
	PRINTR "?"""

	.FUNCT NEW-OFFER,NEW,OBJ
	EQUAL? PRSO,ZORKMID,INTNUM \?L1
	SET 'OBJ,ZORKMID
	ZERO? P-NUMBER \?L3
	ZERO? YOUR-OFFER \?L5
	PRINTI """Five hundred zorkmids? Possibly a true coin..."" He tries to hide his interest. "
?L5:	SET 'NEW,500
	JUMP ?L9
?L3:	SET 'NEW,P-NUMBER
	JUMP ?L9
?L1:	SET 'OBJ,PRSO
	SET 'NEW,MERCHANT-WANTS
?L9:	ZERO? ASKED-FOR \?L10
	SET 'ASKED-FOR,RANDOM-CARPET
	PRINTI "The merchant's eyes light up. ""No doubt you wish to purchase this lovely "
	PRINTD RANDOM-CARPET
	PRINTR ". A wise choice!"""
?L10:	GRTR? MERCHANT-WANTS,NEW /?L12
	SET 'YOUR-OFFER,NEW
	PRINTI """Done, then!"" The merchant takes "
	CALL THE-PRINT,OBJ
	PRINTI ". "
	CALL PRINT-ID,STR?259
	EQUAL? OBJ,ZORKMID /?L13
	PRINTI "He examines it skeptically. ""I don't really think this is worth the price, no, it won't do at all..."" He hefts it in his hand. ""Well, I believe in accommodating our out-of-town visitors. Otherwise, we don't get any repeat customers, right? I can always put this trinket on the mantelpiece and regale my family with the story."" He smiles unctuously. "
	JUMP ?L15
?L13:	GRTR? YOUR-OFFER,500 \?L15
	PRINTI """What do you take me for? This is only a 500 zorkmid piece! Trying to cheat me is trying to cheat my children! This I cannot accept! Out with you!"""
	CALL PRINT-ID,STR?260
	CALL KICKED-OUT
	RTRUE
?L15:	MOVE OBJ,MERCHANT
	MOVE RANDOM-CARPET,PLAYER
	PRINTR """I don't know what my family will eat tonight, but they say I'm softhearted. I only want to get back to my lunch, so you've got a deal. You should have told me you were an expert."" He gives you a carpet. ""Now go before my family sees what a fool I've been..."""
?L12:	LESS? NEW,100 /?L17
	ADD 50,YOUR-OFFER >STACK
	LESS? NEW,STACK /?L17
	CALL MAKE-NEW-OFFER,NEW >STACK
	RSTACK
?L17:	ZERO? YOUR-OFFER \?L19
	SET 'YOUR-OFFER,NEW
?L19:	PRINTR """Now, really, you must bargain in good faith. My patience is not infinite, as my lunch even now is congealing."""

	.FUNCT MAKE-NEW-OFFER,NEW=0
	SET 'YOUR-OFFER,NEW
	INC 'MERCHANT-COUNT
	GET MERCHANT-SAYS,0 >STACK
	GRTR? MERCHANT-COUNT,STACK /?L1
	SUB MERCHANT-WANTS,100 >MERCHANT-WANTS
	GRTR? MERCHANT-WANTS,YOUR-OFFER /?L3
	SET 'MERCHANT-WANTS,YOUR-OFFER
	CALL NEW-OFFER >STACK
	RSTACK
?L3:	GET MERCHANT-SAYS,MERCHANT-COUNT >STACK
	PRINT STACK
	CRLF
	RTRUE
?L1:	PRINTI """That does it! Out you go! Down the road to the rag-pickers, you thief!"""
	CALL KICKED-OUT
	RTRUE

	.FUNCT KICKED-OUT,L
	LOC PLAYER >L
	FSET? L,VEHBIT \?L1
	MOVE PLAYER,HERE
	MOVE L,PLAYER
?L1:	PRINTI " He throws you into the street and bars the door."
	CRLF
	CRLF
	FCLEAR EMPORIUM-DOOR,OPENBIT
	FSET EMPORIUM-DOOR,LOCKED
	CALL GOTO,BAZAAR >STACK
	RSTACK

	.FUNCT I-KICKED-OUT
	EQUAL? HERE,EMPORIUM \FALSE
	CRLF
	PRINTI "The merchant says, ""Time is money, and you've wasted too much of mine!"""
	CALL KICKED-OUT >STACK
	RSTACK

	.FUNCT SHOP-PSEUDO
	EQUAL? PRSA,V?THROUGH \FALSE
	CALL DO-WALK,P?EAST >STACK
	RSTACK

	.FUNCT BAZAAR-F,RARG
	EQUAL? RARG,M-LOOK \FALSE
	PRINTI "This is a crowded, noisy bazaar. Directly in front of you to the east is a shop. Above its door is a sign in an unknown tongue. "
	PRINT YOU-CANT
	PRINTI "read it, but it is illustrated with a picture of a very ornate rug. "
	FSET? EMPORIUM-DOOR,LOCKED \?L3
	CALL THIS-IS-IT,EMPORIUM-DOOR
	PRINT DOOR-LOCKED
	PRINT PERIOD
	RTRUE
?L3:	FSET? EMPORIUM-DOOR,OPENBIT /?L5
	CALL TELL-OPEN-CLOSED,EMPORIUM-DOOR >STACK
	RSTACK
?L5:	PRINTR "The door beckons invitingly."

	.FUNCT TAKE-ON-CARPET,CARP
	EQUAL? PRSO,MAGIC-CARPET \?L1
	CALL GET-OFF-FIRST >STACK
	RSTACK
?L1:	CALL NOT-IN-VEHICLE? >STACK
	ZERO? STACK /FALSE
	CALL CANT-REACH-THAT >STACK
	RSTACK

	.FUNCT NOT-SITTING
	ZERO? SITTING? /FALSE
	MOVE PLAYER,HERE
	SET 'SITTING?,0
	PRINTI " You are no longer sitting on the carpet."
	RTRUE

	.FUNCT NOW-SITTING
	ZERO? SITTING? /?L1
	IN? PLAYER,PRSO \?L1
	PRINT YOU-ARE
	PRINT PERIOD
	RFALSE
?L1:	SET 'SITTING?,1
	PRINTI "You "
	IN? PLAYER,PRSO \?L4
	PRINTI "sit down"
	JUMP ?L6
?L4:	MOVE PLAYER,PRSO
	PRINTI "are now sitting"
?L6:	PRINTI " on "
	CALL THE-PRINT-PRSO
	PRINTI ". "
	RTRUE

	.FUNCT RANDOM-CARPET-F,RARG=0
	EQUAL? RARG,M-BEG \?L1
	EQUAL? PRSA,V?FLY /?L6
	EQUAL? PRSA,V?WALK \?L7
	EQUAL? P-WALK-DIR,P?UP /?L6
	GRTR? UD-COUNT,0 \?L3
?L6:	PRINT NOTHING-HAPPENS
	RTRUE
?L3:	EQUAL? PRSA,V?WALK \?L7
	CALL GET-OFF-FIRST >STACK
	RSTACK
?L7:	EQUAL? PRSA,V?TAKE,V?MOVE \?L8
	CALL TAKE-ON-CARPET,RANDOM-CARPET >STACK
	RSTACK
?L8:	EQUAL? PRSA,V?DISEMBARK \FALSE
	EQUAL? PRSO,RANDOM-CARPET \FALSE
	CALL STEP-OFF-CARPET
	CRLF
	RTRUE
?L1:	ZERO? RARG \FALSE
	EQUAL? PRSA,V?EXAMINE \?L12
	PRINTI "This is a cheaply made and ugly carpet. It is a garish red and looks ready to fall apart."
	CALL CLEVER-CONTENTS,RANDOM-CARPET,STR?261
	CRLF
	RTRUE
?L12:	EQUAL? PRSA,V?CASKLY \?L14
	PRINTR "It's perfectly awful already."
?L14:	EQUAL? PRSA,V?OFFER \?L15
	EQUAL? PRSI,RANDOM-CARPET \?L15
	IN? MERCHANT,HERE \?L15
	SET 'ASKED-FOR,PRSI
	CALL PERFORM,V?GIVE,PRSO,MERCHANT
	RTRUE
?L15:	EQUAL? PRSA,V?TAKE \?L16
	CALL TAKE-CARPET >STACK
	RSTACK
?L16:	EQUAL? PRSA,V?BOARD,V?CLIMB-ON,V?STAND-ON \?L17
	CALL BOARD-CARPET >STACK
	RSTACK
?L17:	EQUAL? PRSA,V?SIT \?L18
	IN? WINNER,RANDOM-CARPET /?L18
	CALL CANT-GET-ON? >STACK
	ZERO? STACK \TRUE
	CALL NOW-SITTING >STACK
	ZERO? STACK /TRUE
	PRINTR "Some of the nap comes off on you."
?L18:	EQUAL? PRSA,V?CUT \FALSE
	EQUAL? PRSI,SHEARS,KNIFE \FALSE
	CALL CARPET-CRUMBLES >STACK
	RSTACK

	.FUNCT IMPOSSIBLE-MANEUVER
	PRINTR "An impossible maneuver under the circumstances."

	.FUNCT CANT-GET-ON?
	FSET? HERE,RAIRBIT \?L1
	PRINTR "A good thought, but a little too late to save you, I'm afraid."
?L1:	FSET? HERE,RWATERBIT \?L3
	CALL IMPOSSIBLE-MANEUVER >STACK
	RSTACK
?L3:	CALL HELD?,PRSO >STACK
	ZERO? STACK /FALSE
	PRINT YOU-HAVE-TO
	PRINTR " put it down first."

	.FUNCT BOARD-CARPET
	IN? PLAYER,PRSO \?L1
	PRINT YOU-ARE
	PRINT PERIOD
	RTRUE
?L1:	CALL CANT-GET-ON? >STACK
	ZERO? STACK \TRUE
	MOVE PLAYER,PRSO
	SET 'SITTING?,0
	PRINT YOU-ARE-NOW
	PRINTR "standing on the carpet. Nothing expected is happening."

	.FUNCT STEP-OFF-CARPET
	SET 'SITTING?,0
	LOC PRSO >STACK
	MOVE PLAYER,STACK
	PRINTI "You step off the carpet."
	RTRUE

	.FUNCT MAGIC-CARPET-F,RARG=0
	EQUAL? RARG,M-BEG \?L1
	EQUAL? PRSA,V?TAKE,V?MOVE \?L3
	CALL TAKE-ON-CARPET,MAGIC-CARPET >STACK
	RSTACK
?L3:	EQUAL? PRSA,V?DROP \?L5
	GRTR? UD-COUNT,0 \?L5
	CALL DROP-IN-AIR >STACK
	RSTACK
?L5:	EQUAL? PRSA,V?FLY /?L89
	EQUAL? PRSA,V?WALK \?L53
	EQUAL? P-WALK-DIR,P?UP /?L8
	GRTR? UD-COUNT,0 \?L6
?L8:	EQUAL? PRSA,V?FLY \?L9
?L89:	ZERO? PRSO \?L9
	SET 'P-WALK-DIR,P?UP
?L9:	IN? CARPET-LABEL,MAGIC-CARPET \?L14
	FSET? CARPET-LABEL,RMUNGBIT \?L12
?L14:	PRINT NOTHING-HAPPENS
	RTRUE
?L12:	ZERO? SITTING? \?L15
	PRINT RIPPLES
	PRINT PERIOD
	RTRUE
?L15:	EQUAL? HERE,MIDAIR \?L16
	EQUAL? P-WALK-DIR,P?NORTH \?L17
	INC 'NS-COUNT
	JUMP ?L28
?L17:	EQUAL? P-WALK-DIR,P?SOUTH \?L19
	DEC 'NS-COUNT
	JUMP ?L28
?L19:	EQUAL? P-WALK-DIR,P?EAST \?L20
	INC 'EW-COUNT
	JUMP ?L28
?L20:	EQUAL? P-WALK-DIR,P?WEST \?L21
	DEC 'EW-COUNT
	JUMP ?L28
?L21:	EQUAL? P-WALK-DIR,P?UP \?L22
	INC 'UD-COUNT
	JUMP ?L28
?L22:	EQUAL? P-WALK-DIR,P?DOWN \?L23
	DEC 'UD-COUNT
	JUMP ?L28
?L23:	EQUAL? P-WALK-DIR,P?NE \?L24
	INC 'NS-COUNT
	INC 'EW-COUNT
	JUMP ?L28
?L24:	EQUAL? P-WALK-DIR,P?NW \?L25
	INC 'NS-COUNT
	DEC 'EW-COUNT
	JUMP ?L28
?L25:	EQUAL? P-WALK-DIR,P?SE \?L26
	DEC 'NS-COUNT
	INC 'EW-COUNT
	JUMP ?L28
?L26:	EQUAL? P-WALK-DIR,P?SW \?L27
	DEC 'NS-COUNT
	DEC 'EW-COUNT
	JUMP ?L28
?L27:	PRINTR "The carpet doesn't move."
?L28:	ZERO? UD-COUNT \?L29
	ZERO? NS-COUNT \?L33
	ZERO? EW-COUNT \?L31
	CALL GOTO,ROC-NEST
	RTRUE
?L31:	ZERO? NS-COUNT \?L33
	EQUAL? EW-COUNT,4 \?L33
	ZERO? SEEN-TOWER? /?L33
	CALL GOTO,GUARD-TOWER
	RTRUE
?L33:	CALL GOTO,LOST-ON-LAND
	RTRUE
?L29:	CALL DESCRIBE-CARPET-LOC >STACK
	RSTACK
?L16:	EQUAL? HERE,LOST-IN-CLOUDS \?L36
	ADD SMASH-PROB,5 >SMASH-PROB
	RANDOM 100 >STACK
	LESS? SMASH-PROB,STACK /?L37
	FCLEAR MIDAIR,TOUCHBIT
	CALL GOTO,MIDAIR >STACK
	RSTACK
?L37:	PRINTR "You are still lost in thick, fluffy clouds. It is impossible to tell directions in here."
?L36:	EQUAL? P-WALK-DIR,P?UP \?L40
	EQUAL? HERE,GUARD-TOWER,ROC-NEST \?L41
	PRINTI "The carpet takes to the air, rising swiftly."
	IN? ROC,HERE \?L43
	EQUAL? HERE,GUARD-TOWER \?L43
	REMOVE ROC
	PRINTI " The huge bird stops, almost stalls, and flees goggle-eyed with surprise."
?L43:	CRLF
	CRLF
	FCLEAR MIDAIR,TOUCHBIT
	CALL GOTO,MIDAIR >STACK
	RSTACK
?L41:	EQUAL? HERE,VOLCANO-ROOM,VOLCANO-BASE,OUTCROPPING-ROOM \?L46
	PRINTI "You begin to rise, but you notice that the "
	EQUAL? MAGIC-CARPET,ICED-OBJECT \?L47
	SET 'ICED-OBJECT,0
	PRINTR "carpet is steaming as the ice melts. You prudently return to earth."
?L47:	REMOVE CARPET-LABEL
	CALL PRINT-ID,STR?262
	CALL JIGS-UP,STR?263 >STACK
	RSTACK
?L46:	FSET? HERE,OUTSIDE \?L50
	FCLEAR LOST-IN-CLOUDS,TOUCHBIT
	CALL GOTO,LOST-IN-CLOUDS >STACK
	RSTACK
?L50:	PRINTR "It ripples a little."
?L40:	PRINT RIPPLES
	PRINT PERIOD
	RTRUE
?L6:	EQUAL? PRSA,V?WALK \?L53
	CALL GET-OFF-FIRST >STACK
	RSTACK
?L53:	EQUAL? PRSA,V?DISEMBARK \?L54
	EQUAL? PRSO,MAGIC-CARPET \?L54
	CALL STEP-OFF-CARPET
	FSET? HERE,RAIRBIT \?L55
	CALL START-FALLING
	PRINTI " As you are in midair, you begin to fall. The carpet loses its impetus the moment you cease to touch it and accordians like a rug that's been slipped on. It too begins to fall."
?L55:	CRLF
	RTRUE
?L54:	EQUAL? PRSA,V?LEAP \FALSE
	GRTR? UD-COUNT,0 \FALSE
	PRINTI "This is not the most prudent method of disembarking."
	CRLF
	CALL PRINT-ID,STR?264 >STACK
	RSTACK
?L1:	ZERO? RARG \?L60
	EQUAL? PRSA,V?EXAMINE \?L61
	PRINTI "This is a carpet of unusual design. It is blue, beautifully woven and has a pattern that looks different each time you look at it. Sometimes, for example, it's an array of cubes pointing upward, and other times it's the same array pointing downward. There is a jaunty fringe around the outer edge."
	CALL CLEVER-CONTENTS,MAGIC-CARPET,STR?261,CARPET-LABEL
	CRLF
	RTRUE
?L61:	EQUAL? PRSA,V?OFFER \?L63
	EQUAL? PRSI,MAGIC-CARPET \?L63
	IN? MERCHANT,HERE \?L63
	SET 'ASKED-FOR,PRSI
	CALL PERFORM,V?GIVE,PRSO,MERCHANT
	RTRUE
?L63:	EQUAL? PRSA,V?TAKE \?L64
	CALL TAKE-CARPET >STACK
	RSTACK
?L64:	EQUAL? PRSA,V?CUT \?L65
	EQUAL? PRSI,SHEARS,KNIFE \?L65
	CALL START-FALLING
	CALL CARPET-CRUMBLES >STACK
	RSTACK
?L65:	EQUAL? PRSA,V?LOOK-INSIDE \?L66
	CALL CLEVER-CONTENTS,PRSO,STR?265,CARPET-LABEL >STACK
	ZERO? STACK /?L67
	CRLF
	RTRUE
?L67:	CALL ITS-EMPTY >STACK
	RSTACK
?L66:	EQUAL? PRSA,V?LOOK-UNDER,V?TURN-OVER,V?MOVE \?L70
	PRINTI "You turn the carpet over and discover "
	IN? PLAYER,MAGIC-CARPET \?L71
	EQUAL? HERE,MIDAIR,LOST-IN-CLOUDS \?L71
	CALL PRINT-ID,STR?266
	CALL JIGS-UP,STR?267
	RETURN 2
?L71:	IN? CARPET-LABEL,MAGIC-CARPET \?L75
	FSET? CARPET-LABEL,RMUNGBIT /?L75
	FCLEAR CARPET-LABEL,INVISIBLE
	PRINTI "a label"
	JUMP ?L76
?L75:	PRINTI "nothing"
?L76:	PRINT PERIOD
	RTRUE
?L70:	EQUAL? PRSA,V?BOARD,V?CLIMB-ON,V?STAND-ON \?L77
	CALL BOARD-CARPET >STACK
	RSTACK
?L77:	EQUAL? PRSA,V?SIT \FALSE
	CALL CANT-GET-ON? >STACK
	ZERO? STACK \TRUE
	CALL NOW-SITTING >STACK
	ZERO? STACK /TRUE
	IN? CARPET-LABEL,MAGIC-CARPET \?L82
	FSET? CARPET-LABEL,RMUNGBIT /?L82
	PRINTR "At first nothing happens. Then the fringe of the carpet starts to ruffle expectantly."
?L82:	PRINTR "Nothing interesting happens, although the carpet is comfortable."
?L60:	EQUAL? RARG,M-ENTER \FALSE
	SET 'SMASH-PROB,0
	RETURN SMASH-PROB

	.FUNCT TAKE-CARPET,IGNORE?=0
	CALL ITAKE >STACK
	EQUAL? STACK,1 \TRUE
	PRINTI "Taken"
	FSET? CARPET-LABEL,RMUNGBIT /?L3
	SET 'IGNORE?,CARPET-LABEL
	JUMP ?L4
?L3:	SET 'IGNORE?,0
?L4:	CALL ROB,PRSO,HERE,IGNORE? >STACK
	ZERO? STACK /?L6
	PRINTI ", but something fell off"
?L6:	PRINT PERIOD
	RTRUE

	.FUNCT GET-OFF-FIRST
	PRINT YOU-HAVE-TO
	PRINTR " get off the carpet first."

	.FUNCT CARPET-CRUMBLES
	IN? PLAYER,PRSO \?L1
	MOVE PLAYER,HERE
?L1:	REMOVE PRSO
	PRINTI "As the first thread is cut, the "
	PRINTD PRSO
	PRINTI " crumbles to dust."
	CRLF
	CALL PRINT-ID,STR?268 >STACK
	RSTACK

	.FUNCT DESCRIBE-CARPET-LOC
	PRINTI "You are "
	IN? PLAYER,MAGIC-CARPET \?L1
	PRINTI "flying "
?L1:	GRTR? UD-COUNT,3 \?L4
	PRINTI "dizzyingly high "
	JUMP ?L7
?L4:	GRTR? UD-COUNT,2 \?L6
	PRINTI "very high "
	JUMP ?L7
?L6:	GRTR? UD-COUNT,1 \?L7
	PRINTI "high "
?L7:	PRINTI "above "
	ZERO? NS-COUNT \?L11
	ZERO? EW-COUNT \?L9
	PRINTI "a giant bird's nest"
	JUMP ?L13
?L9:	ZERO? NS-COUNT \?L11
	EQUAL? EW-COUNT,4 \?L11
	ZERO? SEEN-TOWER? /?L11
	PRINTI "an abandoned guard tower"
	JUMP ?L13
?L11:	ZERO? EW-COUNT \?L12
	PRINTI "jagged mountains"
	JUMP ?L13
?L12:	PRINTI "a trackless wilderness to the "
	GRTR? EW-COUNT,0 \?L14
	PRINTI "east"
	JUMP ?L16
?L14:	PRINTI "west"
?L16:	PRINTI " of a range of jagged mountains"
?L13:	PRINT PERIOD
	RTRUE

	.FUNCT CARPET-LABEL-F
	EQUAL? PRSA,V?READ,V?EXAMINE \?L1
	PRINTR "The label reads:

""Frobozz Magic Magic Carpet Co.

This carpet is made of all-unnatural fibers. Occupancy by more than one person is prohibited. Keep to posted speeds. Do not remove this label under penalty of law.

Abdul el-Flathead

(Printed by the Frobozz Magic Label Co.)"""
?L1:	EQUAL? PRSA,V?CASKLY \?L3
	IN? CARPET-LABEL,MAGIC-CARPET /?L3
	PRINT NOTHING-HAPPENS
	RTRUE
?L3:	EQUAL? PRSA,V?TAKE,V?MUNG /?L5
	EQUAL? PRSA,V?CUT \FALSE
	ZERO? PRSI /FALSE
	FSET? PRSI,WEAPONBIT \FALSE
?L5:	FSET PRSO,RMUNGBIT
	IN? PLAYER,MAGIC-CARPET \FALSE
	FSET? HERE,RAIRBIT \FALSE
	CALL START-FALLING
	MOVE PLAYER,HERE
	PRINTR "As soon as the label is removed, the carpet hits an air pocket and rolls up. There is no room for you on a rolled-up carpet. You begin to fall."

	.FUNCT START-FALLING
	SET 'FALLING?,1
	SET 'SMASH-PROB,0
	CALL QUEUE,I-FALLING,-1 >STACK
	RSTACK

	.FUNCT MIDAIR-F,RARG
	EQUAL? RARG,M-LOOK \?L1
	PRINTI "You are in midair."
	IN? PLAYER,ROC \?L3
	PRINTI " Fortunately a very large bird is carrying you, otherwise you would fall."
	JUMP ?L6
?L3:	IN? PLAYER,MAGIC-CARPET \?L5
	PRINTI " Fortunately you are sitting on a magic carpet and thus are fairly safe."
	JUMP ?L6
?L5:	ZERO? FALLING? /?L6
	PRINTI " You are falling."
?L6:	EQUAL? HERE,MIDAIR \?L8
	PRINTI " "
	CALL DESCRIBE-CARPET-LOC
	RTRUE
?L8:	CRLF
	RTRUE
?L1:	EQUAL? RARG,M-ENTER \?L11
	IN? PLAYER,MAGIC-CARPET /?L12
	FSET? HERE,TOUCHBIT \?L14
	SET 'ROC-PROB,0
	JUMP ?L16
?L14:	SET 'ROC-PROB,25
?L16:	CALL QUEUE,I-ROC,-1
?L12:	EQUAL? OHERE,LOST-IN-CLOUDS \?L18
	RANDOM 5 >STACK
	SUB STACK,1 >EW-COUNT
	JUMP ?L21
?L18:	EQUAL? OHERE,GUARD-TOWER,AIR-ROOM,EARTH-ROOM \?L20
	SET 'EW-COUNT,4
	JUMP ?L21
?L20:	SET 'EW-COUNT,0
?L21:	EQUAL? OHERE,LOST-IN-CLOUDS \?L22
	RANDOM 5 >STACK
	SUB STACK,3 >NS-COUNT
	JUMP ?L24
?L22:	SET 'NS-COUNT,0
?L24:	EQUAL? OHERE,LOST-IN-CLOUDS \?L25
	RANDOM 4 >UD-COUNT
	RFALSE
?L25:	EQUAL? OHERE,AIR-ROOM,EARTH-ROOM \?L27
	SET 'UD-COUNT,4
	RFALSE
?L27:	SET 'UD-COUNT,1
	RFALSE
?L11:	EQUAL? RARG,M-LEAVE \?L29
	IN? MAGIC-CARPET,HERE \FALSE
	MOVE MAGIC-CARPET,LOST-ON-LAND
	RTRUE
?L29:	EQUAL? RARG,M-BEG \?L33
	EQUAL? PRSA,V?WALK \?L34
	ZERO? FALLING? /?L34
	EQUAL? P-WALK-DIR,P?DOWN \?L36
	PRINTR "You have little choice."
?L36:	PRINTR "Down seems more likely."
?L34:	EQUAL? PRSA,V?LESOCH \?L39
	ZERO? PRSO \?L39
	CALL LESOCH-CLOUDS >STACK
	RSTACK
?L39:	EQUAL? PRSA,V?DROP \FALSE
	CALL DROP-IN-AIR >STACK
	RSTACK
?L33:	EQUAL? RARG,M-END \FALSE
	LOC PLAYER >STACK
	EQUAL? STACK,ROC,MAGIC-CARPET /FALSE
	ZERO? FALLING? \FALSE
	SET 'ROC-PROB,0
	CALL START-FALLING
	PRINTR "You have begun to fall."

	.FUNCT DROP-IN-AIR
	LOC WINNER >STACK
	EQUAL? PRSO,STACK /FALSE
	CALL IDROP >STACK
	ZERO? STACK /TRUE
	EQUAL? PRSO,MAGIC-BOX \?L4
	MOVE PRSO,LOST-ON-LAND
	JUMP ?L6
?L4:	REMOVE PRSO
?L6:	CALL CTHE-PRINT-PRSO
	PRINTR " falls, dwindling below you, never to be seen again."

	.FUNCT WILDERNESS-F,RARG
	EQUAL? RARG,M-ENTER \FALSE
	PRINTI "Wilderness
You are lost in a trackless wilderness. Wild creatures and wild men rule here. As soon as "
	IN? PLAYER,MAGIC-CARPET \?L3
	PRINTI "your carpet touches ground"
	JUMP ?L5
?L3:	PRINTI "you arrive"
?L5:	PRINTI ", you are set upon by one or the other (they are difficult to tell apart) and devoured."
	CALL PRINT-ID,STR?269
	CALL JIGS-UP >STACK
	RSTACK

	.FUNCT FIRE-ROOM-F,RARG
	EQUAL? RARG,M-LOOK \?L1
	PRINTR "In this room, the walls are brick and glow a deep red. The floor itself radiates heat, and in fact the entire room is hot, oppressive and smokey. Searing heat radiates from openings in the north, east and south walls."
?L1:	EQUAL? RARG,M-LEAVE \FALSE
	CALL RECOVER-CUBE >STACK
	RSTACK

	.FUNCT VOLCANO-ROOM-F,RARG
	EQUAL? RARG,M-LOOK \?L1
	PRINTR "You are at the edge of a lava vent in an active volcano. The lava glows red and yellow, and there is a stench of sulphur in the air. A lake of lava bubbles and steams before you, molten rock roiling from unseen disturbances. To the west, in the middle of the tumult, is a small outcropping of something with a higher melting point than rock. It is undisturbed by the heat."
?L1:	EQUAL? RARG,M-BEG \FALSE
	EQUAL? PRSA,V?SMELL \FALSE
	ZERO? PRSO \FALSE
	PRINT SMELL-LAVA
	RTRUE

	.FUNCT VOLCANO-PSEUDO
	EQUAL? PRSA,V?EXAMINE \?L1
	CALL PERFORM,V?LOOK
	RTRUE
?L1:	EQUAL? PRSA,V?SMELL \?L3
	PRINT SMELL-LAVA
	RTRUE
?L3:	EQUAL? PRSA,V?TINSOT \FALSE
	CALL LAVA-COOLS >STACK
	RSTACK

	.FUNCT LAVA-COOLS
	PRINTR "A small patch of lava cools, but it is swept away."

	.FUNCT LAVA-PSEUDO
	EQUAL? PRSA,V?EXAMINE,V?TAKE,V?SWIM /?L3
	EQUAL? PRSA,V?THROUGH \?L1
?L3:	CALL TAKE-LAVA >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?SMELL \?L4
	PRINT SMELL-LAVA
	RTRUE
?L4:	EQUAL? PRSA,V?THROW,V?PUT \?L5
	CALL HELD?,PRSO >STACK
	ZERO? STACK /?L5
	EQUAL? PRSI,PSEUDO-OBJECT \?L5
	CALL INTO-LAVA >STACK
	RSTACK
?L5:	EQUAL? PRSA,V?TAKE,V?RUB \?L6
	CALL TAKE-LAVA >STACK
	RSTACK
?L6:	EQUAL? PRSA,V?TINSOT \FALSE
	CALL LAVA-COOLS >STACK
	RSTACK

	.FUNCT INTO-LAVA
	REMOVE PRSO
	PRINTR "It disappears into the lava."

	.FUNCT VOLCANO-BASE-F,RARG
	EQUAL? RARG,M-LOOK \?L1
	PRINTR "You are partway up the base of an active volcano. All around you is a stream of glowing, molten lava, bubbling and spitting. Clumps of red-hot lava fly through the air, narrowly missing you. Your vantage point is a small point of rock that hasn't been remelted by the flow."
?L1:	EQUAL? RARG,M-BEG \?L3
	EQUAL? PRSA,V?WALK \?L4
	PRINTI "The heat of the lava would cook you for sure!"
	CRLF
	CALL PRINT-ID,STR?270 >STACK
	RSTACK
?L4:	EQUAL? PRSA,V?SMELL \FALSE
	ZERO? PRSO \FALSE
	PRINT SMELL-LAVA
	RTRUE
?L3:	EQUAL? RARG,M-ENTER \FALSE
	ZERO? ROCK-ARRIVED? \FALSE
	SET 'ROCK-ARRIVED?,1
	CALL QUEUE,I-ROCK-ARRIVES,2 >STACK
	RSTACK

	.FUNCT LAVA-ROCK-F
	EQUAL? PRSA,V?TINSOT /?L3
	EQUAL? PRSA,V?POUR \?L1
	EQUAL? PRSO,LOCAL-WATER \?L1
?L3:	EQUAL? PRSA,V?POUR \?L4
	REMOVE LOCAL-WATER
?L4:	FSET LAVA-ROCK,TOUCHBIT
	FCLEAR LAVA-ROCK,RMUNGBIT
	CALL THIS-IS-IT,LAVA-ROCK
	PRINTR "The fragment is cool enough to touch."
?L1:	EQUAL? PRSA,V?EXAMINE \?L7
	FSET? PRSO,RMUNGBIT \?L7
	PRINTR "It's cooling slowly but is still too hot to touch safely."
?L7:	EQUAL? PRSA,V?SMELL \?L8
	PRINT SMELL-LAVA
	RTRUE
?L8:	EQUAL? PRSA,V?TAKE,V?RUB \FALSE
	FSET? PRSO,RMUNGBIT \FALSE
	CALL TAKE-LAVA >STACK
	RSTACK

	.FUNCT TAKE-LAVA
	ZERO? PRSI /?L1
	EQUAL? PRSI,WEED,SPELL-BOOK,DEAD-BOOK /?L5
	EQUAL? PRSI,BREAD,FISH,MAGIC-CARPET /?L5
	EQUAL? PRSI,RANDOM-CARPET /?L5
	FSET? PRSI,SCROLLBIT \?L3
?L5:	REMOVE PRSI
	CALL CTHE-PRINT-PRSI
	PRINTI " catches fire and burns to a crisp."
	CRLF
	CALL PRINT-ID,STR?271 >STACK
	RSTACK
?L3:	CALL CTHE-PRINT-PRSI
	PRINTI " hisses and sizzles when you touch the lava with it."
	CRLF
	CALL PRINT-ID,STR?272 >STACK
	RSTACK
?L1:	PRINTI "It's too hot to touch. You burn yourself slightly just getting near it."
	CRLF
	CALL PRINT-ID,STR?273 >STACK
	RSTACK

	.FUNCT OUTCROPPING-ROOM-F,RARG
	EQUAL? RARG,M-LOOK \?L1
	PRINTR "You are on a very small outcropping of some material that is impervious to heat. All around you lava bubbles and steams, flowing down the side of the mountain in a relentless stream. There is solid ground out of reach to the east."
?L1:	EQUAL? RARG,M-BEG \FALSE
	EQUAL? PRSA,V?TAKE \?L4
	EQUAL? PRSO,MAGIC-CUBE \?L4
	ZERO? GOT-MAGIC-CUBE? \?L4
	SET 'GOT-MAGIC-CUBE?,1
	CALL SCORE-OBJECT
	MOVE MAGIC-CUBE,WINNER
	PRINTR "As you take the cube, you are nearly blinded by a blast of power. It rolls out from the cube, up your arm and all over your body. Every hair stands on end, every muscle is tense. You feel more powerful, as though a weight had been lifted from your body and a veil drawn from before you. The very stuff of magic crackles from your fingertips."
?L4:	EQUAL? PRSA,V?SMELL \FALSE
	ZERO? PRSO \FALSE
	PRINT SMELL-LAVA
	RTRUE

	.FUNCT SOLID-GROUND-PSEUDO
	EQUAL? PRSA,V?EXAMINE \?L1
	PRINTI "There is solid ground about twenty feet to the east, past a stream of molten lava."
	CALL CLEVER-CONTENTS,VOLCANO-ROOM,STR?274
	CRLF
	RTRUE
?L1:	EQUAL? PRSA,V?THROW \?L3
	CALL HELD?,PRSO >STACK
	ZERO? STACK /?L3
	EQUAL? PRSI,PSEUDO-OBJECT \?L3
	MOVE PRSO,VOLCANO-ROOM
	CALL CTHE-PRINT-PRSO
	PRINTR " sails smoothly through the broiling air and lands on the ground to your east."
?L3:	EQUAL? PRSA,V?CLIMB-ON,V?BOARD \FALSE
	PRINT TOO-FAR
	RTRUE

	.FUNCT OUTCROPPING-F
	EQUAL? HERE,VOLCANO-ROOM \?L1
	EQUAL? PRSA,V?EXAMINE,V?LOOK-INSIDE \?L3
	PRINTI "The outcropping is made of some hard, heat-resistant substance. It sticks up about three feet out of the lava about twenty feet from you. It has a flat top about four feet across which is roughly square."
	IN? MAGIC-CUBE,OUTCROPPING-ROOM \?L5
	PRINTI " Sitting in the very center of the outcropping is something small, white, and cubical."
?L5:	CALL CLEVER-CONTENTS,OUTCROPPING-ROOM,STR?275,MAGIC-CUBE
	CRLF
	RTRUE
?L3:	EQUAL? PRSA,V?PUT,V?PUT-ON \?L8
	EQUAL? PRSI,OUTCROPPING \?L8
	PRINT TOO-FAR
	RTRUE
?L8:	CALL THROW-ONTO,OUTCROPPING,OUTCROPPING-ROOM >STACK
	ZERO? STACK \TRUE
	EQUAL? PRSA,V?THROW-OFF \?L10
	CALL HELD?,PRSO >STACK
	ZERO? STACK /?L10
	EQUAL? PRSI,OUTCROPPING \?L10
	CALL INTO-LAVA >STACK
	RSTACK
?L10:	EQUAL? PRSA,V?THROUGH,V?WALK-TO,V?CLIMB-ON /?L12
	EQUAL? PRSA,V?BOARD \FALSE
?L12:	PRINT TOO-FAR
	RTRUE
?L1:	EQUAL? PRSA,V?EXAMINE,V?LOOK-INSIDE \FALSE
	PRINTR "Now that you are on it, you can see that the outcropping is made of some kind of volcanic glass that somehow was expelled from the volcano and lodged here in the middle of the lava stream. It is an iceberg only partly above the flow, stuck solidly in the channel through which the lava flows."

	.FUNCT THROW-ONTO,OBJ,RM
	EQUAL? PRSA,V?THROW \FALSE
	CALL HELD?,PRSO >STACK
	ZERO? STACK /FALSE
	EQUAL? PRSI,OBJ \FALSE
	EQUAL? PRSO,WATER,LOCAL-WATER \?L3
	CALL INTO-LAVA >STACK
	RSTACK
?L3:	MOVE PRSO,RM
	CALL CTHE-PRINT-PRSO
	PRINTI " sails smoothly through the air, bounces on "
	CALL THE-PRINT-PRSI
	PRINTR " and ends up perched on the very edge of the far side."

	.FUNCT DARK-ROOM-F,RARG
	EQUAL? RARG,M-LOOK \?L1
	PRINTR "This room is totally black, so black that you see nothing when you look around it. All light is absorbed by the substance of the place. You can tell it is physical, because you can feel your feet touching the floor, but your eyes tell you nothing."
?L1:	EQUAL? RARG,M-LEAVE \FALSE
	CALL RECOVER-CUBE >STACK
	RSTACK

	.FUNCT DARK-CAVE-F,RARG
	EQUAL? RARG,M-LOOK \?L1
	EQUAL? CHANGED?,GRUE \?L3
	PRINTR "This is a jumbled, rough cave with many small passages leading in and out, and one large one leading down."
?L3:	PRINTI "This is a large cave with a rough floor. You can tell little about the surroundings, because your "
	PRINTD FROTZ-SPELL
	PRINTI " doesn't seem to be working normally here and produces only a wan and sickly glow. The light coming from "
	CALL TELL-LIGHT-SOURCE
	PRINTR " has been reduced to a thin, barely glowing stream of tiny blobs that drips, spurts and sputters uselessly to the ground. There it collects into a small pile which is slowly disappearing, perhaps by evaporation."
?L1:	EQUAL? RARG,M-ENTER \?L6
	GETPT LIGHT,P?SYNONYM >STACK
	PUT STACK,2,W?PILE
	RTRUE
?L6:	EQUAL? RARG,M-LEAVE \FALSE
	GETPT LIGHT,P?SYNONYM >STACK
	PUT STACK,2,W?LIGHTS
	RTRUE

	.FUNCT TELL-LIGHT-SOURCE
	EQUAL? LIT,WINNER \?L1
	PRINTI "you"
	RTRUE
?L1:	EQUAL? LIT,HERE \?L3
	PRINTI "here"
	RTRUE
?L3:	CALL THE-PRINT,LIT
	RTRUE

	.FUNCT POOL-PSEUDO
	EQUAL? PRSA,V?THROUGH,V?BOARD \?L1
	CALL DO-WALK,P?DOWN >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?EXAMINE \?L3
	CALL PERFORM,V?LOOK
	RTRUE
?L3:	EQUAL? PRSA,V?THROW,V?DROP \FALSE
	EQUAL? PRSI,PSEUDO-OBJECT \FALSE
	CALL IDROP >STACK
	ZERO? STACK /TRUE
	MOVE PRSO,LIGHT-POOL
	EQUAL? PRSA,V?THROW \?L7
	PRINTI "Thrown"
	JUMP ?L9
?L7:	PRINTI "Dropped"
?L9:	PRINT PERIOD
	RTRUE

	.FUNCT GRUE-CAVE-F,RARG
	EQUAL? RARG,M-LOOK \?L1
	EQUAL? CHANGED?,GRUE \?L3
	PRINTI "A natural amphitheater carved out of the underground rock opens from several small passages. The cave is crowded with grues of all shapes and sizes. At the lowest point of the cave a small pool of light has gathered, glowing very dimly (from a human point of view). The grues avoid it, and in fact it hurts your eyes to look at it for very long. In the middle of the pool is a short, squat pillar"
	FIRST? PILLAR-ROOM >STACK \?L5
	CALL THIS-IS-IT,FIRE-CUBE
	PRINTI " with something on top of it. This is the object of all the attention. The grues seem to regard the pillar or its contents with awe"
?L5:	PRINT PERIOD
	RTRUE
?L3:	PRINTR "This is a large underground chamber filled with nightmarish, barely visible shapes. There is very dim light issuing from somewhere near the center of the room."
?L1:	EQUAL? RARG,M-BEG \?L9
	EQUAL? CHANGED?,GRUE /FALSE
	EQUAL? PRSA,V?WALK,V?TELL,V?HELLO /?L12
	EQUAL? PRSA,V?BOARD \FALSE
?L12:	CALL DEQUEUE,I-GRUES-NOTICE
	CALL I-GRUES-NOTICE,1
	RTRUE
?L9:	EQUAL? RARG,M-ENTER \?L14
	GETPT LIGHT,P?SYNONYM >STACK
	PUT STACK,2,W?PILE
	EQUAL? CHANGED?,GRUE /FALSE
	EQUAL? OHERE,DARK-CAVE /?L17
	CALL QUEUE,I-GRUES-NOTICE,1
	RFALSE
?L17:	CALL QUEUE,I-GRUES-NOTICE,2
	ZERO? LIT \?L20
	PRINTI "You stumble blindly down a short passage which opens into what feels like a larger area."
	CRLF
	CRLF
	RTRUE
?L20:	EQUAL? LIT,GRUE /FALSE
	PRINTI "You make your way carefully in the almost non-existent light down to an area filled with dim shapes. They move about purposefully, making horrible gurgling noises. The floor is rough and jumbled near the walls, so you haven't been noticed yet."
	CRLF
	CRLF
	RTRUE
?L14:	EQUAL? RARG,M-LEAVE \FALSE
	GETPT LIGHT,P?SYNONYM >STACK
	PUT STACK,2,W?LIGHTS
	RTRUE

	.FUNCT LIGHT-POOL-F,RARG
	EQUAL? RARG,M-LOOK \?L1
	PRINTR "This is a small pool or pond of light, very dim by human standards, but painful for a grue to even look at. In the center of the pool is a pillar which sticks up out of the light."
?L1:	EQUAL? RARG,M-BEG \?L3
	EQUAL? PRSA,V?DISEMBARK \FALSE
	EQUAL? PRSO,0,ROOMS,PSEUDO-OBJECT \FALSE
	CALL DO-WALK,P?OUT >STACK
	RSTACK
?L3:	EQUAL? RARG,M-ENTER \?L7
	GETPT LIGHT,P?SYNONYM >STACK
	PUT STACK,2,W?PILE
	CALL QUEUE,I-FRIED-GRUE,2
	PRINTI "You enter the pool, which is composed of the accumulated dribbles of light that have made their way to this uttermost bottom of a dark dimension. The light tickles"
	EQUAL? CHANGED?,GRUE \?L8
	PRINTI " at first, but then it begins to burn and your eyes are hurting severely"
?L8:	PRINT PERIOD
	CRLF
	RTRUE
?L7:	EQUAL? RARG,M-LEAVE \FALSE
	GETPT LIGHT,P?SYNONYM >STACK
	PUT STACK,2,W?LIGHTS
	RTRUE

	.FUNCT PILLAR-ROOM-F,RARG
	EQUAL? RARG,M-LOOK \?L1
	PRINTI "You are on top of a short marble pillar surrounded by a pool of "
	EQUAL? CHANGED?,GRUE \?L3
	PRINTR "light. Squinting through the intolerable glare, you can see that the other grues are staring at you with a mixture of amazement and fear."
?L3:	PRINTR "almost imperceptible light. You can barely see dim shapes capering in the dark."
?L1:	EQUAL? RARG,M-ENTER \?L6
	GETPT LIGHT,P?SYNONYM >STACK
	PUT STACK,2,W?PILE
	RTRUE
?L6:	EQUAL? RARG,M-LEAVE \FALSE
	GETPT LIGHT,P?SYNONYM >STACK
	PUT STACK,2,W?LIGHTS
	RTRUE

	.FUNCT PILLAR-F,IGNORE?=0
	EQUAL? PRSA,V?EXAMINE,V?LOOK-INSIDE \?L1
	PRINTI "This is the stump of a marble pillar covered with eroded glyphs. It barely projects out of the pool of light. The grues seem awed by it."
	IN? FIRE-CUBE,PILLAR-ROOM \?L7
	EQUAL? HERE,PILLAR-ROOM /?L7
	SET 'IGNORE?,FIRE-CUBE
	EQUAL? HERE,LIGHT-POOL \?L5
	PRINTR " You can't see the top of the pillar from here."
?L5:	PRINTI " There is something small and white on the pillar."
	CALL CLEVER-CONTENTS,PILLAR-ROOM,STR?276,IGNORE?
?L7:	CRLF
	RTRUE
?L1:	CALL THROW-ONTO,PILLAR,PILLAR-ROOM >STACK
	ZERO? STACK \TRUE
	EQUAL? PRSA,V?CLIMB-ON,V?CLIMB-UP,V?CLIMB-FOO /?L11
	EQUAL? PRSA,V?BOARD \?L10
?L11:	EQUAL? HERE,GRUE-CAVE \?L12
	PRINTR "It's in the pool, out of reach from here."
?L12:	EQUAL? HERE,LIGHT-POOL \?L14
	CALL GOTO,PILLAR-ROOM >STACK
	RSTACK
?L14:	EQUAL? HERE,PILLAR-ROOM \FALSE
	PRINTR "It doesn't go any higher, and you're on it already."
?L10:	EQUAL? PRSA,V?DISEMBARK,V?CLIMB-DOWN \FALSE
	EQUAL? HERE,LIGHT-POOL,GRUE-CAVE \?L18
	PRINT YOU-ARENT
	PRINTR "on it yet."
?L18:	EQUAL? HERE,PILLAR-ROOM \FALSE
	CALL GOTO,LIGHT-POOL >STACK
	RSTACK

	.FUNCT SCALES-ROOM-EXIT
	PRINTI "You slowly drift ""eastward,"" and the nothing attenuates. Something begins to break through the nothing."
	CRLF
	CRLF
	RETURN INNER-VAULT

	.FUNCT PLAIN-ROOM-EXIT
	PRINTI "Your mind starts to wander ""southward,"" and slowly something impinges itself on your mind."
	CRLF
	CRLF
	RETURN PLAIN-ROOM

	.FUNCT MIND-BOX-EXIT
	LOC MAGIC-BOX >STACK
	IN? STACK,ROOMS \?L1
	GETP HERE,P?CUBE >STACK
	EQUAL? STACK,MAGIC-BOX-CUBE \?L1
	PRINTI "Your mind drifts ""westward,"" and slowly something surrounds your mind."
	CRLF
	CRLF
	LOC MAGIC-BOX >STACK
	RSTACK
?L1:	PRINTI "Oddly, although your mind is drawn in that direction, no act of will helps in going that way."
	CRLF
	RFALSE

	.FUNCT MIND-ROOM-F,RARG
	EQUAL? RARG,M-LOOK \?L1
	PRINT THERE-IS-NOTHING
	PRINTR "here. You are here, but there is no here where you are. You see nothing. Your senses are vainly trying to find something, anything to work on. You can know your body is there, but you can't truly sense it to confirm the suspicion. Your mind is alternately drawn in three ""directions"" (or at least what seem like directions): east, west and south. There is something slightly different about the nothing in those directions."
?L1:	EQUAL? RARG,M-LEAVE \FALSE
	CALL RECOVER-CUBE >STACK
	RSTACK

	.FUNCT FAKE-PSEUDO
	CALL REDIRECT,PSEUDO-OBJECT,TREASURE >STACK
	RSTACK

	.FUNCT INNER-VAULT-F,RARG
	EQUAL? RARG,M-LOOK \?L1
	PRINTI "This is a bare concrete chamber that looks like the inside of a vault."
	IN? TREASURE,HERE \?L3
	PRINTI " The room is filled with unimaginable treasure. Gold and jewels are strewn everywhere. Coffers burst with coins, and stacks of rare paintings lean against the walls. Beautifully ornamented vases and glassware are carelessly stacked in corners."
?L3:	PRINTI " There is a door on the north side of the room whose lock mechanism is visible. "
	CALL DESCRIBE-VAULT-DOOR >STACK
	RSTACK
?L1:	EQUAL? RARG,M-LEAVE \FALSE
	EQUAL? PRSA,V?BLORPLE \FALSE
	CALL MAKE-JUNK >STACK
	RSTACK

	.FUNCT VAULT-DOOR-F
	EQUAL? PRSA,V?EXAMINE \?L1
	PRINTI "This is a steel door. It is thick and heavy, like the door to a bank vault. "
	EQUAL? HERE,INNER-VAULT \?L3
	PRINTI "It is covered with complicated mechanisms which look like they are part of a timing or locking device. "
?L3:	CALL DESCRIBE-VAULT-DOOR >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?OPEN,V?UNLOCK \?L6
	FSET? PRSO,OPENBIT /?L6
	PRINTI "You can see no way to open "
	CALL THE-PRSO >STACK
	RSTACK
?L6:	EQUAL? PRSA,V?THROUGH \?L7
	EQUAL? HERE,SCALES-ROOM \?L8
	PUSH P?SOUTH
	JUMP ?L10
?L8:	PUSH P?NORTH
?L10:	CALL DO-WALK,STACK >STACK
	RSTACK
?L7:	EQUAL? PRSA,V?REZROV \FALSE
	FSET? VAULT-DOOR,OPENBIT \?L12
	CALL TELL-OPEN-CLOSED,VAULT-DOOR >STACK
	RSTACK
?L12:	CALL HELD?,MAGIC-CUBE >STACK
	ZERO? STACK /?L14
	FCLEAR VAULT-DOOR,LOCKED
	FSET VAULT-DOOR,OPENBIT
	EQUAL? HERE,INNER-VAULT \?L15
	PRINTI "The mechanisms whirr madly"
	JUMP ?L17
?L15:	PRINTI "You hear strange noises"
?L17:	PRINTR " for a few moments, and then the door swings ponderously open."
?L14:	CALL REZROV-TOUGH-DOOR >STACK
	RSTACK

	.FUNCT REZROV-TOUGH-DOOR
	EQUAL? HERE,INNER-VAULT \?L1
	PRINTI "The mechanisms try vainly to turn,"
	JUMP ?L3
?L1:	PRINTI "The door strains and creaks,"
?L3:	PRINTR " but your spell is just not powerful enough."

	.FUNCT DESCRIBE-VAULT-DOOR
	PRINTI "The door is "
	FSET? VAULT-DOOR,OPENBIT \?L1
	PRINTI "open, and beyond you can see "
	EQUAL? HERE,SCALES-ROOM \?L3
	PRINTI "a treasure chamber"
	JUMP ?L6
?L3:	PRINTI "the outer vault"
	JUMP ?L6
?L1:	PRINTI "closed and locked"
?L6:	PRINT PERIOD
	RTRUE

	.FUNCT CASTLE-GUARDS-PSEUDO
	EQUAL? HERE,SCALES-ROOM,INNER-VAULT \?L4
	ZERO? GUARDS-FLAG /?L3
?L4:	EQUAL? HERE,PAST-CELL-EAST \?L1
	FSET? CELL-DOOR,OPENBIT /?L1
?L3:	PRINTR "What guards?"
?L1:	EQUAL? PRSA,V?EXAMINE \?L5
	PRINTR "The guards are no doubt burly, thuggish and nasty."
?L5:	CALL SPELL-VERB? >STACK
	ZERO? STACK /FALSE
	PRINTI """A wise guy, eh?"" The guards burst in and dispatch you before you can finish the spell."
	CRLF
	CRLF
	CALL TIME-SICK-CELL-EAST >STACK
	RSTACK

	.FUNCT IRON-DOOR-EXIT
	FSET? IRON-DOOR,OPENBIT \?L1
	PRINTI "You poke your head out the door. "
	EQUAL? GUARDS-FLAG,1 \?L3
	PRINTI "You see, directly in front of you, five burly guards who look like they want to discuss something with you."
	CRLF
	RFALSE
?L3:	PRINTI "You see a long, gloomy corridor down which five burly guards are coming."
	CRLF
	RFALSE
?L1:	CALL THIS-IS-IT,IRON-DOOR
	CALL TELL-OPEN-CLOSED,IRON-DOOR
	RFALSE

	.FUNCT IRON-DOOR-F
	EQUAL? PRSA,V?UNLOCK,V?OPEN \?L1
	FSET? IRON-DOOR,OPENBIT /?L1
	PRINTR "The lock is beyond your ability to unlock or pick."
?L1:	EQUAL? PRSA,V?THROUGH \FALSE
	CALL DO-WALK,P?NORTH >STACK
	RSTACK

	.FUNCT SCALES-ROOM-F,RARG,P1,P2
	EQUAL? RARG,M-LOOK \?L1
	PRINTI "You are in a large, bare concrete room."
	FIRST? PILE-1 >STACK \?L5
	FIRST? PILE-2 >STACK \?L3
	PRINTI " There are two piles on the floor. The first contains "
	CALL PILE-LOOP,PILE-1
	PRINTI ". The second contains "
	CALL PILE-LOOP,PILE-2
	PRINTI "."
	JUMP ?L6
?L3:	FIRST? PILE-1 >STACK \?L5
	CALL TELL-PILE,PILE-1,PILE-2
	JUMP ?L6
?L5:	FIRST? PILE-2 >STACK \?L6
	CALL TELL-PILE,PILE-2,PILE-1
?L6:	PRINTI " An exit is to the north. It is "
	FSET? IRON-DOOR,OPENBIT \?L8
	PRINTI "an open"
	JUMP ?L10
?L8:	PRINTI "a closed"
?L10:	PRINTI " iron door. To the south is the inner vault. Its steel door is "
	FSET? VAULT-DOOR,OPENBIT \?L11
	PRINTI "open"
	JUMP ?L13
?L11:	PRINTI "closed"
?L13:	IN? ALARM-FAIRY,HERE \?L14
	PRINTI ". An agitated alarm fairy flits about near the ceiling"
?L14:	PRINT PERIOD
	RTRUE
?L1:	EQUAL? RARG,M-BEG \?L17
	EQUAL? PRSA,V?SAVE \FALSE
	PRINTR "That spell doesn't work here."
?L17:	EQUAL? RARG,M-ENTER \?L21
	EQUAL? OHERE,INNER-VAULT \?L22
	CALL HELD?,TREASURE >STACK
	ZERO? STACK /?L24
	CALL USE-SPELL
?L24:	FCLEAR VAULT-DOOR,OPENBIT
	PRINTI "As you enter the outer vault, the vault door swings inexorably shut."
	CRLF
	CRLF
?L22:	ZERO? TREASURY-GUARDED? /?L28
	CALL PRINT-ID,STR?277
	CALL JIGS-UP,STR?278 >STACK
	RSTACK
?L28:	CALL JUGGLE-CUBES
	SET 'USED-JINDAK?,0
	RANDOM 100 >STACK
	LESS? 50,STACK /?L31
	SET 'REAL-VALUE,3
	SET 'FAKE-VALUE,2
	RETURN FAKE-VALUE
?L31:	SET 'REAL-VALUE,2
	SET 'FAKE-VALUE,3
	RETURN FAKE-VALUE
?L21:	EQUAL? RARG,M-LEAVE \FALSE
	CALL CUBES-TO-PILES
	ZERO? TIME-CUBE-SCORE? /?L35
	SET 'TREASURY-GUARDED?,1
?L35:	EQUAL? PRSA,V?BLORPLE \FALSE
	CALL MAKE-JUNK >STACK
	RSTACK

	.FUNCT INITIALIZE-CUBES,CNT=1,L,BUF
	SET 'L,FAKE-CUBE-LIST
	SET 'BUF,P-QBUF
?L1:	IGRTR? 'CNT,13 /?L2
	GET L,CNT >STACK
	PUTP STACK,P?NAME,BUF
	ADD BUF,10 >BUF
	JUMP ?L1
?L2:	PUT BUF,0,0
	SET 'P-QNEXT,BUF
	RETURN P-QNEXT

	.FUNCT CUBES-TO-PILES,L,CNT
	SET 'L,FAKE-CUBE-LIST
	SET 'CNT,2
?L1:	GET L,CNT >STACK
	MOVE STACK,PILE-1
	IGRTR? 'CNT,13 \?L1
	EQUAL? TIME-CUBE,BLORPLE-OBJECT \?L6
	REMOVE TIME-CUBE
	ZERO? TIME-CUBE-SCORE? \?L6
	SET 'TIME-CUBE-SCORE?,1
	FCLEAR TIME-CUBE,TOUCHBIT
	CALL SCORE-OBJECT,TIME-CUBE
?L6:	ZERO? BLORPLE-OBJECT /FALSE
	LOC BLORPLE-OBJECT >STACK
	ZERO? STACK /FALSE
	SET 'BLORPLE-OBJECT,0
	RETURN BLORPLE-OBJECT

	.FUNCT JUGGLE-CUBES,BUF,P1=0,P2=0,Q,CNT
	CALL ROB,PILE-1,SCALES-ROOM
	CALL ROB,PILE-2,SCALES-ROOM
	SET 'CNT,2
?L1:	CALL PICK-ONE,FAKE-CUBE-LIST >Q
	FSET Q,NDESCBIT
	EQUAL? P2,6 /?L6
	LESS? P1,6 \?L4
	RANDOM 100 >STACK
	LESS? 50,STACK /?L4
?L6:	INC 'P1
	MOVE Q,PILE-1
	JUMP ?L7
?L4:	MOVE Q,PILE-2
	INC 'P2
?L7:	IGRTR? 'CNT,13 \?L1
	SET 'BUF,P-QBUF
	FIRST? PILE-1 >CNT \?L10
?L8:	PUTP CNT,P?NAME,BUF
	CALL CUBE-ADJ,CNT >STACK
	PUT BUF,0,STACK
	ADD BUF,10 >BUF
	NEXT? CNT >CNT /?L8
?L10:	FIRST? PILE-2 >CNT \TRUE
?L11:	PUTP CNT,P?NAME,BUF
	CALL CUBE-ADJ,CNT >STACK
	PUT BUF,0,STACK
	ADD BUF,10 >BUF
	NEXT? CNT >CNT /?L11
	RTRUE

	.FUNCT TELL-PILE,PILE,OTHER
	PRINTI " There is a pile of things on the floor, containing "
	CALL PILE-LOOP,PILE
	PRINTI ". There is an empty spot where "
	CALL THE-PRINT,OTHER
	PRINTI " was."
	RTRUE

	.FUNCT TREASURE-F
	EQUAL? PRSA,V?EXAMINE \?L1
	PRINTR "On closer examination, the treasure is even richer than you thought."
?L1:	EQUAL? PRSA,V?DROP \FALSE
	EQUAL? HERE,INNER-VAULT \FALSE
	FSET TREASURE,NDESCBIT
	RFALSE

	.FUNCT MAKE-JUNK
	FCLEAR VAULT-DOOR,OPENBIT
	CALL HELD?,TREASURE >STACK
	ZERO? STACK /FALSE
	LOC TREASURE >STACK
	MOVE JUNK,STACK
	FSET TREASURE,NDESCBIT
	MOVE TREASURE,INNER-VAULT
	RTRUE

	.FUNCT JUNK-F
	EQUAL? PRSA,V?EXAMINE \?L1
	PRINTR "The treasure consists of paste jewels, badly crafted gilt vessels and lead coins."
?L1:	EQUAL? PRSA,V?DROP \FALSE
	EQUAL? HERE,INNER-VAULT \FALSE
	CALL IDROP >STACK
	ZERO? STACK /TRUE
	REMOVE JUNK
	MOVE TREASURE,HERE
	PRINTR "The junk looks valuable again."

	.FUNCT MEASURE,OBJ,F,CNT=0,F?1
	FIRST? OBJ >F?1 \?L3
?L1:	GETP F?1,P?CUBE >STACK
	ZERO? STACK /?L4
	ADD CNT,REAL-VALUE >CNT
	JUMP ?L7
?L4:	GETPT F?1,P?NAME >STACK
	ZERO? STACK /?L6
	ADD CNT,FAKE-VALUE >CNT
	JUMP ?L7
?L6:	FSET? F?1,MAGICBIT /?L8
	FSET? F?1,SCROLLBIT \?L7
?L8:	INC 'CNT
?L7:	NEXT? F?1 >F?1 /?L1
?L3:	RETURN CNT

	.FUNCT ALARM-FAIRY-F
	EQUAL? WINNER,ALARM-FAIRY \?L1
	PRINTR """Go away, thief! Just wait 'til the guards come! You'll be sorry!"""
?L1:	EQUAL? PRSA,V?EXAMINE,V?KISS \?L3
	PRINTR "The alarm fairy is small, winged and very obnoxious. It flies near the ceiling, out of reach, and jeers at you."
?L3:	EQUAL? PRSA,V?ESPNIS \?L4
	PRINTR "It thumbs its nose at you. ""I never sleep!"" it jeers."
?L4:	EQUAL? PRSA,V?YOMIN \?L5
	PRINTR "You sense a mixture of spitefulness and pleasurable anticipation."
?L5:	EQUAL? PRSA,V?SNAVIG \?L6
	PRINTR "It's too small."
?L6:	CALL HOSTILE-VERB? >STACK
	ZERO? STACK /FALSE
	PRINTR """Missed me! Missed me! Now you have to kiss me!"" It plants a smooch on your cheek."

	.FUNCT PILE-LOOP,OBJ,F,N,1ST?=1,CNT=0,CUBE?,F?1,N?1
	FIRST? OBJ >F?1 \?L3
?L1:	NEXT? F?1 >N?1 /?L4
?L4:	GETPT F?1,P?NAME >CUBE?
	ZERO? CUBE? /?L7
	GETP F?1,P?NAME >STACK
	ZERO? STACK /?L5
?L7:	ZERO? 1ST? \?L8
	ZERO? N?1 \?L10
	ZERO? CNT \?L10
	PRINTI " and "
	JUMP ?L13
?L10:	PRINTI ", "
	JUMP ?L13
?L8:	SET '1ST?,0
?L13:	GETPT F?1,P?NAME >STACK
	ZERO? STACK \?L14
	CALL PRINTA,F?1
	JUMP ?L17
?L14:	CALL THE-PRINT,F?1
	JUMP ?L17
?L5:	INC 'CNT
?L17:	SET 'F?1,N?1
	ZERO? F?1 \?L1
?L3:	GRTR? CNT,0 \TRUE
	ZERO? 1ST? \?L20
	PRINTI " and "
?L20:	PRINTN CNT
	PRINTI " "
	PRINT WHITE-CUBE
	GRTR? CNT,1 \TRUE
	PRINTI "s"
	RTRUE

	.FUNCT PILE-F
	EQUAL? PRSA,V?EXAMINE \?L1
	FIRST? PRSO >STACK \?L3
	PRINTI "The pile contains "
	CALL PILE-LOOP,PRSO
	JUMP ?L5
?L3:	PRINTI "Its spot is empty"
?L5:	PRINT PERIOD
	RTRUE
?L1:	EQUAL? PRSA,V?COUNT \?L6
	GETPT PRSO,P?NAME >STACK
	ZERO? STACK /?L6
	EQUAL? PRSI,PILE-1,PILE-2 \?L6
	CALL CTHE-PRINT-PRSI
	PRINTI " holds "
	CALL TELL-CUBE-COUNT,PRSI >STACK
	RSTACK
?L6:	EQUAL? PRSA,V?CUT \?L7
	PRINT MORE-SPECIFIC
	PRINTR " about individual items to take, drop, etc."
?L7:	EQUAL? PRSA,V?PUT \?L8
	EQUAL? PRSI,PILE-1,PILE-2 \FALSE
	CALL HELD?,PRSO >STACK
	ZERO? STACK \?L11
	CALL ITAKE >STACK
	EQUAL? STACK,M-FATAL,0 /TRUE
?L11:	EQUAL? PRSO,MAGIC-CARPET,RANDOM-CARPET,ZIPPER \?L13
	MOVE PRSO,HERE
	PRINTI "You put it on the floor near "
	CALL THE-PRINT-PRSI
	PRINT PERIOD
	RTRUE
?L13:	MOVE PRSO,PRSI
	FSET PRSO,TOUCHBIT
	FSET PRSO,NDESCBIT
	PRINTR "Done."
?L8:	EQUAL? PRSA,V?PUT-ON \FALSE
	CALL PERFORM,V?PUT,PRSO,PRSI
	RTRUE

	.FUNCT CUBE-DESC,RARG,OBJ
	PRINTI "A white cube"
	GETP OBJ,P?NAME >STACK
	ZERO? STACK /?L1
	PRINTI " labelled "
	CALL CUBE-NAME,OBJ
?L1:	PRINTR " is here."

	.FUNCT CUBE-F
	EQUAL? PRSA,V?EXAMINE \?L1
	GETP PRSO,P?NAME >STACK
	ZERO? STACK /?L3
	PRINTI "This is a white cube with the word "
	CALL CUBE-NAME,PRSO
	PRINTR " written on it."
?L3:	PRINTI "This is a "
	PRINT WHITE-CUBE
	PRINT PERIOD
	RTRUE
?L1:	EQUAL? PRSA,V?COMPARE \?L6
	EQUAL? PRSO,PRSI /?L6
	GETPT PRSO,P?NAME >STACK
	ZERO? STACK /?L6
	GETPT PRSI,P?NAME >STACK
	ZERO? STACK /?L6
	PRINTI "Structurally, they are identical."
	GETP PRSO,P?NAME >STACK
	ZERO? STACK /?L7
	PRINTI " One has "
	CALL CUBE-NAME,PRSO
	PRINTI " written on it."
?L7:	GETP PRSI,P?NAME >STACK
	ZERO? STACK /?L10
	PRINTI " One has "
	CALL CUBE-NAME,PRSI
	PRINTI " written on it."
?L10:	CRLF
	RTRUE
?L6:	EQUAL? PRSA,V?WRITE \?L13
	EQUAL? PRSO,QWORD \?L14
	ZERO? PRSI /?L16
	CALL HELD?,PRSI >STACK
	ZERO? STACK \?L16
	PRINTI "You must have "
	CALL THE-PRINT-PRSI
	PRINTR " to write on it."
?L16:	CALL KNOWN-NAME?,P-QWORD >STACK
	ZERO? STACK /?L18
	PRINTI "Strangely, your efforts leave "
	CALL THE-PRINT-PRSI
	PRINTR " unchanged."
?L18:	GETP PRSI,P?NAME >STACK
	ZERO? STACK /?L19
	PRINTI "You replace the word "
	CALL CUBE-NAME,PRSI
	PRINTI " with the word "
	CALL WRITE-ON-CUBE,PRSI
	CALL CUBE-NAME,PRSI
	PRINT PERIOD
	RTRUE
?L19:	CALL WRITE-ON-CUBE,PRSI >STACK
	ZERO? STACK /?L20
	PRINTI "The word "
	CALL CUBE-NAME,PRSI
	PRINTR " is now written on the cube."
?L20:	CALL YOU-CANT-X-THAT,STR?279 >STACK
	RSTACK
?L14:	ZERO? PRSI /FALSE
	GETPT PRSI,P?NAME >STACK
	ZERO? STACK /FALSE
	FSET? PRSO,READBIT \?L23
	PRINTR "Strangely, you cannot duplicate the pattern."
?L23:	CALL YOU-CANT-X-PRSI,STR?280 >STACK
	RSTACK
?L13:	EQUAL? PRSA,V?TAKE \?L27
	EQUAL? PRSI,PILE-1,PILE-2 \FALSE
	FCLEAR PRSO,NDESCBIT
	RFALSE
?L27:	EQUAL? PRSA,V?COUNT \FALSE
	PRINTI "You have "
	CALL TELL-CUBE-COUNT,WINNER >STACK
	RSTACK

	.FUNCT TELL-CUBE-COUNT,OBJ,CNT
	CALL CUBE-COUNT,OBJ >CNT
	ZERO? CNT \?L1
	PRINTI "no"
	JUMP ?L3
?L1:	PRINTN CNT
?L3:	PRINTI " cube"
	EQUAL? CNT,1 /?L4
	PRINTI "s"
?L4:	PRINTR "."

	.FUNCT CUBE-COUNT,OBJ,CNT=0,CONT
	FIRST? OBJ >CONT \?L3
?L1:	GETPT CONT,P?NAME >STACK
	ZERO? STACK /?L4
	INC 'CNT
	JUMP ?L6
?L4:	FIRST? CONT >STACK \?L6
	CALL CUBE-COUNT,CONT >STACK
	ADD CNT,STACK >CNT
?L6:	NEXT? CONT >CONT /?L1
?L3:	RETURN CNT

	.FUNCT MOUNTAIN-PSEUDO
	EQUAL? PRSA,V?EXAMINE \?L1
	PRINTR "The mountains are tall and volcanic."
?L1:	EQUAL? PRSA,V?CLIMB-FOO,V?CLIMB-UP \?L3
	CALL DO-WALK,P?UP >STACK
	RSTACK
?L3:	EQUAL? PRSA,V?CLIMB-DOWN \FALSE
	CALL DO-WALK,P?DOWN >STACK
	RSTACK

	.FUNCT PLAIN-PSEUDO
	CALL REDIRECT,PSEUDO-OBJECT,GROUND >STACK
	RSTACK

	.FUNCT PLAIN-ROOM-F,RARG
	EQUAL? RARG,M-LOOK \?L1
	PRINTI "This is a flat plain punctuated by boulders. The boulders are all identical and slide to and fro on the eerie surface, propelled by an unknown mechanism. The ground is scratched by many intersecting lines which seem to have a regular pattern. "
	CALL DESCRIBE-PLAIN
	PRINTR " Far in the distance are mountains which quiver itchily as they belch forth purple fire."
?L1:	EQUAL? RARG,M-BEG \?L3
	SET 'ROCK-MOVED?,0
	EQUAL? WINNER,PLAYER \FALSE
	EQUAL? PRSA,V?WALK \FALSE
	IN? PLAYER,HERE \?L6
	PRINTR "You find that the surface is too smooth. Your feet slip out from under you, and you crash to the ground."
?L6:	EQUAL? P-WALK-DIR,P?DOWN \?L8
	CALL PERFORM,V?DISEMBARK
	RTRUE
?L8:	PRINT YOU-HAVE-TO
	PRINTR " get down off the rock if you want to walk."
?L3:	EQUAL? RARG,M-ENTER \?L11
	SET 'ROCK-LOC,5
	SET 'YOU-LOC,5
	RETURN YOU-LOC
?L11:	EQUAL? RARG,M-LEAVE \FALSE
	SET 'ROCK-BRIBED?,0
	CALL DEQUEUE,I-OTHER-ROCK >STACK
	RSTACK

	.FUNCT PLAIN-SPELL-FAIL
	EQUAL? PRSA,V?BLORPLE /FALSE
	PRINTI "A bright purple ball of light issues from your fingers and collapses like a deflated balloon on the ground."
	IN? PLAYER,OTHER-ROCK /?L4
	SET 'ROCK-TALKED?,1
	PRINTI " ""Great effect!"" says the "
	PRINTD ROCK
	PRINTI ". ""That's better than most of you soft ones can do here."""
?L4:	CRLF
	RTRUE

	.FUNCT DESCRIBE-PLAIN,ROCKS?=1
	CALL HELD?,PLAYER,ROCK >STACK
	ZERO? STACK /?L1
	PRINTI "You are on a large, green eyed rock. "
?L1:	PRINTI "From where you are "
	CALL HELD?,PLAYER,ROCK >STACK
	ZERO? STACK \?L6
	CALL HELD?,PLAYER,OTHER-ROCK >STACK
	ZERO? STACK /?L4
?L6:	PUSH STR?281
	JUMP ?L7
?L4:	PUSH STR?282
?L7:	PRINT STACK
	PRINTI " you can see lines radiating "
	GETB PLAIN-WALLS,YOU-LOC >STACK
	CALL TELL-WALLS,STACK
	PRINTI "."
	ZERO? ROCKS? /TRUE
	EQUAL? YOU-LOC,ROCK-LOC \?L13
	IN? PLAYER,ROCK /?L11
?L13:	PRINTI " There is a large green eyed rock"
	IN? PLAYER,ROCK /?L14
	PRINTI " here"
	JUMP ?L16
?L14:	CALL ROCK-DIRECTION,ROCK-LOC
?L16:	PRINTI "."
?L11:	IN? PLAYER,OTHER-ROCK /FALSE
	PRINTI " Also, there is a large brown eyed rock "
	IN? DARK-CUBE,OTHER-ROCK \?L20
	PRINTI "with a "
	PRINT WHITE-CUBE
	PRINTI " on its back "
?L20:	EQUAL? YOU-LOC,OTHER-ROCK-LOC \?L23
	PRINTI "here"
	JUMP ?L25
?L23:	CALL ROCK-DIRECTION,OTHER-ROCK-LOC
?L25:	PRINTI "."
	RTRUE

	.FUNCT ROCK-DIRECTION,R,ROW,COL,RROW,RCOL,DROW=0,DCOL=0
	DIV YOU-LOC,4 >ROW
	BAND YOU-LOC,3 >COL
	DIV R,4 >RROW
	BAND R,3 >RCOL
	GRTR? RROW,ROW \?L1
	SUB RROW,ROW >DROW
	JUMP ?L3
?L1:	SUB ROW,RROW >DROW
?L3:	GRTR? RCOL,COL \?L4
	SUB RCOL,COL >DCOL
	JUMP ?L6
?L4:	SUB COL,RCOL >DCOL
?L6:	LESS? DROW,2 \?L7
	LESS? DCOL,2 \?L7
	PRINTI "nearby and off"
	JUMP ?L10
?L7:	LESS? DROW,3 \?L9
	LESS? DCOL,3 \?L9
	PRINTI "some distance"
	JUMP ?L10
?L9:	PRINTI "quite a ways off"
?L10:	PRINTI " to the "
	GRTR? RROW,ROW \?L11
	GRTR? RCOL,COL \?L13
	PRINTI "southeast"
	RTRUE
?L13:	LESS? RCOL,COL \?L15
	PRINTI "southwest"
	RTRUE
?L15:	EQUAL? RCOL,COL \FALSE
	PRINTI "south"
	RTRUE
?L11:	LESS? RROW,ROW \?L18
	GRTR? RCOL,COL \?L19
	PRINTI "northeast"
	RTRUE
?L19:	LESS? RCOL,COL \?L21
	PRINTI "northwest"
	RTRUE
?L21:	EQUAL? RCOL,COL \FALSE
	PRINTI "north"
	RTRUE
?L18:	GRTR? RCOL,COL \?L25
	PRINTI "east"
	RTRUE
?L25:	PRINTI "west"
	RTRUE

	.FUNCT LINES-F
	EQUAL? PRSA,V?EXAMINE \?L1
	PRINTI "These lines appear to be discolorations in the surface, perhaps a different mineral permeating the rock. They form a usually rectangular grid. The boulders, as far as you can tell, always follow the lines. "
	CALL DESCRIBE-PLAIN,0
	CRLF
	RTRUE
?L1:	EQUAL? PRSA,V?RUB \FALSE
	PRINTR "The lines aren't raised or lowered with respect to the plain. They are most likely just discolorations in the surface."

	.FUNCT ROCK-SPEECHES
	ZERO? ROCK-TALKED? /?L1
	ZERO? ROCK-BRIBED? /?L3
	PRINTR """That was pretty good food. A little light on the phosphorus for my taste, but some have been known to disagree."" It snorts good-naturedly."
?L3:	PRINTR """You know, I could do with a little food. The paths are sort of bare this time of year; everyone's scraped them pretty thin. Yes, a little food would be nice. Something crunchy. Then you could watch me eat. I'm really at my best then."""
?L1:	SET 'ROCK-TALKED?,1
	PRINTI "The rock seems somewhat surprised to see you, and looks you over carefully before answering. "
	EQUAL? PRSA,V?HELLO /?L7
	PRINTI "It doesn't pay much attention to you. "
?L7:	PRINTR """Hello. You're certainly an odd-looking one, though not as odd as the last. It was as unprepossessing as you. Of course, I am the most handsome."""

	.FUNCT ROCK-F,RARG=0
	EQUAL? WINNER,ROCK \?L1
	EQUAL? PRSA,V?TELL-ABOUT \?L3
	EQUAL? PRSO,ME /FALSE
?L3:	EQUAL? PRSA,V?WALK,V?WALK-TO \?L5
	EQUAL? PRSA,V?WALK \?L6
	CALL HELD?,PLAYER,ROCK >STACK
	ZERO? STACK /?L6
	CALL ROCK-WALK,P-WALK-DIR
	JUMP ?L19
?L6:	ZERO? ROCK-BRIBED? /?L8
	PRINTI """Do you want to ride along? "
	ZERO? TRIED-BOARDING? /?L9
	PRINTI "That's what you seemed to want. "
?L9:	PRINTI "Do you have any more food?"""
	CRLF
	JUMP ?L19
?L8:	CALL WHATS-IN-IT-FOR-ME?
	JUMP ?L19
?L5:	EQUAL? PRSA,V?TELL-ME-ABOUT \?L13
	EQUAL? PRSO,BREAD,FISH \?L14
	PRINTI """Yummy food? Food is crunchy and nice. I like it with lots of phosphorus!"""
	CRLF
	JUMP ?L19
?L14:	EQUAL? PRSO,OTHER-ROCK \?L16
	PRINTI """It's not as pretty as me."""
	CRLF
	JUMP ?L19
?L16:	PRINTI """I don't know much about that."""
	CRLF
	JUMP ?L19
?L13:	EQUAL? PRSA,V?EAT \?L18
	PRINTI """You have food?"""
	CRLF
	JUMP ?L19
?L18:	CALL ROCK-SPEECHES
?L19:	SET 'ROCK-TALKED?,1
	RETURN ROCK-TALKED?
?L1:	EQUAL? RARG,M-CONTAINER \?L20
	CALL HELD?,PLAYER,ROCK >STACK
	ZERO? STACK \FALSE
	CALL CANT-REACH-THAT >STACK
	RSTACK
?L20:	EQUAL? RARG,M-BEG \?L24
	EQUAL? PRSA,V?DISEMBARK,V?CLIMB-DOWN,V?LEAP \FALSE
	EQUAL? PRSO,0,ROOMS,ROCK \FALSE
	MOVE PLAYER,HERE
	SET 'ROCK-BRIBED?,0
	PRINTR """That was fun! I'm kind of tired from carrying you, though. Do you have any more food?"""
?L24:	ZERO? RARG \FALSE
	EQUAL? PRSA,V?EXAMINE \?L29
	PRINTI "This is a rather large boulder with a flat bottom. Something prevents it from touching the ground, as it moves about quite nimbly, watching you with lovely green eyes."
	CALL CLEVER-CONTENTS,ROCK,STR?283
	CRLF
	RTRUE
?L29:	EQUAL? PRSA,V?ADMIRE \?L31
	SET 'ROCK-TALKED?,1
	PRINTR """You're very perceptive."" The rock has no false modesty."
?L31:	EQUAL? PRSA,V?MOVE,V?PUSH \?L32
	SET 'ROCK-TALKED?,1
	PRINT IT-TICKLES
	RTRUE
?L32:	EQUAL? PRSA,V?RUB \?L33
	SET 'ROCK-TALKED?,1
	PRINTR """Aren't I smooth?"" says the rock."
?L33:	EQUAL? PRSA,V?GIVE,V?SHOW \?L34
	EQUAL? PRSI,ROCK \?L34
	SET 'ROCK-TALKED?,1
	EQUAL? PRSO,BREAD,FISH \?L35
	PRINTR """What's that? Dead animal or vegetable matter! You won't fool me! Horrible! It would ruin my complexion!"""
?L35:	EQUAL? PRSO,LAVA-ROCK \?L37
	EQUAL? PRSA,V?GIVE \?L38
	REMOVE LAVA-ROCK
	SET 'ROCK-BRIBED?,1
	PRINTI """Mmm. That looks good. Just the right size, too."" It slides happily over the piece of lava and settles comfortably to the ground. You hear a sound like a rasp for a while. The rock blinks contentedly and rises into the air again."
	CRLF
	CALL PRINT-ID,STR?284 >STACK
	RSTACK
?L38:	PRINTR """Oh, yum! Give it to me, please!"""
?L37:	PRINTR """That doesn't look very appetizing."""
?L34:	EQUAL? PRSA,V?BOARD,V?SIT,V?CLIMB-ON /?L43
	EQUAL? PRSA,V?CLIMB-FOO,V?CLIMB-UP \?L42
?L43:	SET 'ROCK-TALKED?,1
	SET 'TRIED-BOARDING?,1
	IN? PLAYER,ROCK \?L44
	PRINT IT-TICKLES
	RTRUE
?L44:	ZERO? ROCK-BRIBED? /?L46
	MOVE PLAYER,ROCK
	PRINTR "You climb the rock and perch precariously on top. From here you can see that the long scratches in the ground form a rectangular grid that fills a rather small valley. ""My back is the most hemispheric of all my friends',"" remarks the rock."
?L46:	PRINTI "The rock spins in place, preventing you from getting on. "
	CALL WHATS-IN-IT-FOR-ME? >STACK
	RSTACK
?L42:	EQUAL? PRSA,V?LOOK-UNDER \FALSE
	SET 'ROCK-TALKED?,1
	PRINTI "The rock's underside is perfectly smooth. When you look under it, the rock says, ""Hey! What is this? What about my privacy?"""
	CALL PRINT-ID,STR?285
	ZERO? ROCK-BRIBED? /?L49
	PRINTI " There is no sign of the lava."
?L49:	CRLF
	RTRUE

	.FUNCT WHATS-IN-IT-FOR-ME?
	PRINTR """What's in it for me? For example, if you had some food, that might be nice. Then you could ride on top and admire me from that angle. It's a rare privilege."""

	.FUNCT ROCK-WALK,DIR,ROW,COL
	CALL QUEUE,I-OTHER-ROCK,-1
	EQUAL? ROCK-LOC,4 \?L1
	EQUAL? DIR,P?NE \?L1
	SET 'ROCK-LOC,1
	JUMP ?L4
?L1:	EQUAL? ROCK-LOC,1 \?L3
	EQUAL? DIR,P?SW \?L3
	SET 'ROCK-LOC,4
	JUMP ?L4
?L3:	DIV ROCK-LOC,4 >ROW
	BAND ROCK-LOC,3 >COL
	EQUAL? DIR,P?NORTH \?L5
	GRTR? ROW,1 /?L7
	GRTR? ROW,0 \?L5
	GRTR? COL,0 \?L5
?L7:	DEC 'ROW
	JUMP ?L12
?L5:	EQUAL? DIR,P?SOUTH \?L8
	LESS? ROW,3 \?L8
	INC 'ROW
	JUMP ?L12
?L8:	EQUAL? DIR,P?EAST \?L9
	LESS? COL,3 \?L9
	INC 'COL
	JUMP ?L12
?L9:	EQUAL? DIR,P?WEST \?L10
	GRTR? COL,1 /?L11
	GRTR? COL,0 \?L10
	GRTR? ROW,0 \?L10
?L11:	DEC 'COL
	JUMP ?L12
?L10:	PRINTR "The rock says, ""There isn't a line there. Do you want me to starve to death? Besides, what would my friends think if I was out of line?"""
?L12:	MUL ROW,4 >STACK
	ADD STACK,COL >ROCK-LOC
?L4:	CALL HELD?,PLAYER,ROCK >STACK
	ZERO? STACK /?L13
	SET 'YOU-LOC,ROCK-LOC
?L13:	SET 'ROCK-MOVED?,1
	PRINTI "The rock glides smoothly, carefully following the line on the plain. ""Yum!"" it remarks, parenthetically. "
	CALL DESCRIBE-PLAIN
	REMOVE OTHER-ROCK
	CALL ROB,HERE,0,ROCK >STACK
	ZERO? STACK /?L16
	PRINTI " Something you left behind on the ground has been crushed by the rock."
?L16:	MOVE OTHER-ROCK,HERE
	CRLF
	RTRUE

	.FUNCT OTHER-ROCK-F,RARG=0
	EQUAL? WINNER,OTHER-ROCK \?L1
	EQUAL? OTHER-ROCK-LOC,YOU-LOC /?L3
	PRINT TOO-FAR
	JUMP ?L5
?L3:	CALL CTHE-PRINT,OTHER-ROCK
	PRINTI " doesn't respond. It acts sulky and peevish."
	CRLF
?L5:	CALL END-QUOTE >STACK
	RSTACK
?L1:	EQUAL? RARG,M-CONTAINER \?L6
	CALL HELD?,PLAYER,OTHER-ROCK >STACK
	ZERO? STACK \FALSE
	CALL CANT-REACH-THAT >STACK
	RSTACK
?L6:	EQUAL? RARG,M-BEG \?L10
	EQUAL? PRSA,V?DISEMBARK,V?CLIMB-DOWN,V?LEAP \FALSE
	EQUAL? PRSO,0,ROOMS,OTHER-ROCK \FALSE
	MOVE PLAYER,HERE
	EQUAL? OTHER-ROCK-LOC,3 /?L13
	SET 'OTHER-ROCK-LOC,3
	JUMP ?L15
?L13:	SET 'OTHER-ROCK-LOC,12
?L15:	PRINTI "You jump down, and the "
	PRINTD OTHER-ROCK
	PRINTR " zooms away in a huff."
?L10:	ZERO? RARG \FALSE
	EQUAL? PRSA,V?EXAMINE,V?LOOK-INSIDE \?L18
	PRINTI "This rock looks just like the other, except that it has brown eyes."
	CALL CLEVER-CONTENTS,OTHER-ROCK,STR?283
	CRLF
	RTRUE
?L18:	EQUAL? PRSA,V?BOARD,V?SIT,V?CLIMB-ON /?L21
	EQUAL? PRSA,V?CLIMB-FOO,V?CLIMB-UP,V?LEAP \?L20
?L21:	EQUAL? OTHER-ROCK-LOC,YOU-LOC /?L22
	PRINT TOO-FAR
	RTRUE
?L22:	IN? PLAYER,ROCK \?L27
	SET 'ROCK-MOVED?,0
	SET 'ROCK-BRIBED?,0
	MOVE PLAYER,OTHER-ROCK
	PRINTI "You leap gracefully to the "
	PRINTD OTHER-ROCK
	PRINTI ", almost slide off, and finally settle yourself carefully on top. "
	IN? DARK-CUBE,OTHER-ROCK \?L27
	FCLEAR DARK-CUBE,NDESCBIT
	PRINTI "Right in front of you is a "
	PRINT WHITE-CUBE
	PRINTI ". "
?L27:	PRINT ROCK-IRRITATION
	RTRUE
?L20:	EQUAL? PRSA,V?TELL,V?ASK-ABOUT,V?TELL-ME-ABOUT /FALSE
	EQUAL? OTHER-ROCK-LOC,YOU-LOC /FALSE
	PRINT TOO-FAR
	RTRUE

	.FUNCT LIGHT-ROOM-F,RARG
	EQUAL? RARG,M-LOOK \?L1
	PRINTR "This place is bright and glaring. The very materials of which it is made blaze with light so bright that their forms are obscured. There are glowing archways to the west and south."
?L1:	EQUAL? RARG,M-LEAVE \FALSE
	CALL RECOVER-CUBE >STACK
	RSTACK

	.FUNCT LIFE-ROOM-F,RARG
	EQUAL? RARG,M-LOOK \?L1
	PRINTR "This place is soft, warm and slightly spongy. It glistens in the light. There are passages leading east and south."
?L1:	EQUAL? RARG,M-LEAVE \FALSE
	CALL RECOVER-CUBE >STACK
	RSTACK

	.FUNCT FLOWERS-PSEUDO
	EQUAL? PRSA,V?SMELL \?L1
	PRINTR "Taking time to stop and smell the flowers?"
?L1:	CALL PLANTS-PSEUDO >STACK
	RSTACK

	.FUNCT GRASS-PSEUDO
	EQUAL? PRSA,V?EXAMINE \?L1
	PRINTR "It's well maintained."
?L1:	CALL PLANTS-PSEUDO >STACK
	RSTACK

	.FUNCT PLANTS-PSEUDO
	EQUAL? PRSA,V?CUT \?L1
	EQUAL? PRSI,KNIFE,SHEARS \?L1
	PRINTR "Doing a little gardening?"
?L1:	EQUAL? PRSA,V?PICK \?L3
	PRINTI "You shouldn't pick that."
	CRLF
	CALL PRINT-ID,STR?286 >STACK
	RSTACK
?L3:	CALL RANDOM-PSEUDO >STACK
	RSTACK

	.FUNCT CLOUD-PSEUDO
	EQUAL? PRSA,V?EXAMINE \?L1
	PRINTR "The clouds are puffy and white, perfect for a lazy summer's day."
?L1:	EQUAL? PRSA,V?LESOCH \FALSE
	CALL LESOCH-CLOUDS >STACK
	RSTACK

	.FUNCT LESOCH-CLOUDS
	PRINTI "The clouds clear away."
	EQUAL? HERE,LOST-IN-CLOUDS \?L1
	CRLF
	CRLF
	CALL GOTO,MIDAIR >STACK
	RSTACK
?L1:	CRLF
	RTRUE

	.FUNCT RABBIT-PSEUDO
	EQUAL? PRSA,V?EXAMINE,V?FOLLOW,V?FIND /?L3
	CALL SPELL-VERB? >STACK
	ZERO? STACK /FALSE
?L3:	PRINTR "What rabbit? I guess he was late for something."

	.FUNCT MEADOW-ROOM-F,RARG
	EQUAL? RARG,M-LOOK \?L1
	PRINTR "This is a warm, sunny meadow nestled among low hills. Wildflowers abound, and insects buzz lazily through the air. The grass is soft and thick. Birds drift serenely through the sky, where puffy white clouds decorate the bright blue background."
?L1:	EQUAL? RARG,M-END \FALSE
	ZERO? RABBIT-FLAG \FALSE
	RANDOM 100 >STACK
	LESS? 20,STACK /FALSE
	SET 'RABBIT-FLAG,1
	CRLF
	PRINTR "A rabbit hops across the meadow, twitches its nose at you, and then scampers away."

	.FUNCT SHEARS-F
	EQUAL? PRSA,V?EXAMINE \FALSE
	PRINTR "This is a very nice pair of pruning shears, such as a gardener would own."

	.FUNCT WEED-DESC,RARG,OBJ
	CALL WEED-DETAILS,RARG >STACK
	RSTACK

	.FUNCT WEED-DETAILS,RARG
	ZERO? RARG /?L1
	PRINTI "There is a weed "
	JUMP ?L3
?L1:	PRINTI "This is a ragweed "
?L3:	FSET? WEED,RWATERBIT \?L4
	PRINTI "cutting"
	JUMP ?L6
?L4:	PRINTI "plant"
?L6:	ZERO? RARG /?L7
	PRINTI " here"
?L7:	PRINTI ". It's tall"
	FSET? WEED,RMUNGBIT \?L10
	EQUAL? SHRINK-FLAG,WEED /?L10
	PRINTI " as a tree"
?L10:	PRINTI ", with yellow blossoms dripping pollen."
	ZERO? RARG \?L13
	EQUAL? HERE,MEADOW-ROOM \?L13
	PRINTI " This is the only weed you can see anywhere in the meadow. It's like a well-kept garden."
?L13:	CRLF
	RTRUE

	.FUNCT WEED-F
	EQUAL? PRSA,V?EXAMINE \?L1
	CALL WEED-DETAILS,0 >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?TAKE,V?PICK,V?MOVE \?L3
	FSET? WEED,RMUNGBIT \?L4
	EQUAL? SHRINK-FLAG,WEED /?L4
	PRINTR "I suppose you have the logging equipment to do this? If so, I don't see it anywhere."
?L4:	CALL HELD?,PRSO >STACK
	ZERO? STACK \FALSE
	EQUAL? WEED-PLANTED?,2 \?L7
	CALL ITAKE >STACK
	EQUAL? STACK,1 \TRUE
	MOVE WEED,HERE
	SET 'WEED-PLANTED?,1
	PRINTR "The weed pulls partly out of the ground."
?L7:	EQUAL? WEED-PLANTED?,1 \FALSE
	CALL ITAKE >STACK
	EQUAL? STACK,1 \TRUE
	SET 'WEED-PLANTED?,0
	PRINTR "The weed pulls out of the ground, taking a good-sized ball of earth with it."
?L3:	EQUAL? PRSA,V?CUT \?L18
	EQUAL? PRSI,KNIFE,SHEARS \?L18
	FSET? WEED,RMUNGBIT \?L19
	EQUAL? SHRINK-FLAG,WEED /?L19
	PRINTR "You would need an axe."
?L19:	MOVE WEED,WINNER
	FSET WEED,RWATERBIT
	PRINTR "You now have a weed cutting."
?L18:	EQUAL? PRSA,V?PLANT \?L22
	EQUAL? PRSI,GROUND,GLOBAL-CAVE /?L25
	EQUAL? PRSI,PSEUDO-OBJECT \?L24
	EQUAL? P-PNAM,W?DIRT /?L25
?L24:	ZERO? PRSI \?L22
	FSET? HERE,OUTSIDE /?L25
	EQUAL? HERE,OGRE-CAVE,OGRE-BEDROOM \?L22
?L25:	FSET? HERE,RLANDBIT \?L26
	GETP HERE,P?CUBE >STACK
	ZERO? STACK \?L26
	IN? WINNER,HERE \?L26
	FSET? WEED,RWATERBIT \?L28
	PRINT YOU-CANT
	PRINTR "expect it to grow from such a cutting."
?L28:	SET 'WEED-PLANTED?,2
	MOVE WEED,HERE
	PRINTI "You plant the weed. "
	PRINT IT-LOOKS-LIKE
	PRINTI "it might even thrive if it gets some attention."
	CRLF
	CALL PRINT-ID,STR?287 >STACK
	RSTACK
?L26:	PRINT I-DONT-THINK-THAT
	PRINTR "even a weed can grow here."
?L22:	EQUAL? PRSA,V?THROCK \?L32
	FSET? WEED,RWATERBIT \?L33
	PRINTR "The weed shivers, tries very hard to grow in its mutilated state and then gives up."
?L33:	ZERO? WEED-PLANTED? \?L35
	PRINTR "The spell envelops the weed, quests around its roots looking for something, fails to find it and fades."
?L35:	FSET? WEED,RMUNGBIT \?L36
	PRINTR "The weed grows a few more inches and then stops."
?L36:	PUTP WEED,P?SIZE,200
	FSET WEED,RMUNGBIT
	PRINTI "With a spurt of explosive growth, the weed expands to spectacular size. It is now as large as a small tree!"
	EQUAL? HERE,CAVE-ENTRANCE \?L38
	CALL OGRE-SNEEZING
	PRINTR " After a few seconds, you hear a muffled exclamation from within the cave, and then a volley of sneezes."
?L38:	EQUAL? HERE,OGRE-CAVE \?L40
	CALL OGRE-SNEEZING
	PRINTI " As the weed grows, the ogre watches in horror. ""Ragweed!"" he screams, and then his further comments are cut off by a volley of sneezes like the reports of a small cannon. The ogre begins to rub his eyes, which are watering horrifically, and his sneezes are monumental. He is totally oblivious to your presence."
	CALL PRINT-ID,STR?288
?L40:	CRLF
	RTRUE
?L32:	EQUAL? PRSA,V?CASKLY \?L42
	PRINT NOTHING-HAPPENS
	RTRUE
?L42:	EQUAL? PRSA,V?LISKON \?L43
	CALL PRE-LISKON >STACK
	ZERO? STACK \TRUE
	FSET? WEED,RMUNGBIT \FALSE
	SET 'SHRINK-FLAG,WEED
	PUTP WEED,P?SIZE,3
	CALL QUEUE,I-LISKON,15
	PRINTR "The weed shrinks back to almost exactly its former size."
?L43:	EQUAL? PRSA,V?SHAKE \FALSE
	EQUAL? HERE,OGRE-CAVE \FALSE
	CALL PERFORM,V?WAVE-AT,PRSO,OGRE
	RTRUE

	.FUNCT OGRE-SNEEZING
	CALL QUEUE,I-STOP-SNEEZING,10
	SET 'SNEEZY?,1
	RETURN SNEEZY?

	.FUNCT DEATH-ROOM-F,RARG
	EQUAL? RARG,M-LOOK \?L1
	PRINTR "This is a room of bones. Shoulder blades make up the floor, skulls the walls and leg bones the door frames. The west exit leads into darkness, but the doorway to the north opens onto a seemingly normal street scene."
?L1:	EQUAL? RARG,M-LEAVE \FALSE
	CALL RECOVER-CUBE >STACK
	RSTACK

	.FUNCT MARBLE-PSEUDO
	EQUAL? PRSA,V?EXAMINE \FALSE
	PRINT IT-LOOKS-LIKE
	PRINTR "bare, smooth marble."

	.FUNCT CHANGE-ROOM-F,RARG
	EQUAL? RARG,M-LOOK \?L1
	PRINTR "The scene here shifts and changes constantly. For example, the exit to the west is always an exit, but one moment it is an oak door, and the next a flimsy curtain of beads. The details are impossible to pin down for longer than a second or two. The eastern and northern exits are equally fluid."
?L1:	EQUAL? RARG,M-LEAVE \FALSE
	CALL RECOVER-CUBE >STACK
	RSTACK

	.FUNCT MAZE-ANTEROOM-F,RARG
	EQUAL? RARG,M-LOOK \?L1
	PRINTI "This room is a perfectly carved, smoothed and shaped cube of black marble. "
	ZERO? MAZE-EXIT-FLAG /?L3
	PRINTI "There is a smallish "
	PRINT OCT-HOLE
	PRINTR " in the north wall."
?L3:	PRINTR "There are no exits, but inset in the north wall is a carving of a compass rose."
?L1:	EQUAL? RARG,M-LEAVE \FALSE
	EQUAL? PRSA,V?BLORPLE /FALSE
	SET 'MAZE-EXIT-FLAG,0
	PUTP MAZE-ANTEROOM,P?EXITS,0
	CALL OCT-HOLE-DISAPPEARS >STACK
	RSTACK

	.FUNCT OCT-HOLE-DISAPPEARS
	REMOVE OCTAGONAL-HOLE
	PRINTI "You slide through the "
	PRINT OCT-HOLE
	PRINTI ", which constricts and disappears as soon as you are through it."
	CRLF
	CRLF
	RTRUE

	.FUNCT COMPASS-CARVING-F
	EQUAL? PRSA,V?EXAMINE \?L1
	IN? COMPASS-ROSE,COMPASS-CARVING \?L3
	PRINTR "The carving is hidden by the real compass rose, which resembles it in every particular."
?L3:	PRINTR "This carving of a compass rose was made by a master craftsman. All the delicate filigree one might expect on a real but ornamental counterpart is here. As though that challenge was not enough, the artist set the carving deep in the stone of the wall."
?L1:	EQUAL? PRSA,V?OPEN,V?REZROV \?L6
	CALL YOU-CANT-X-PRSO,STR?103 >STACK
	RSTACK
?L6:	EQUAL? PRSA,V?CLOSE \?L7
	CALL YOU-CANT-X-PRSO,STR?289 >STACK
	RSTACK
?L7:	EQUAL? PRSA,V?PUT \FALSE
	EQUAL? COMPASS-CARVING,PRSO,PRSI \FALSE
	EQUAL? COMPASS-ROSE,PRSO,PRSI \?L9
	MOVE COMPASS-ROSE,COMPASS-CARVING
	ZERO? MAZE-EXIT-FLAG /?L11
	PRINT NOTHING-HAPPENS
	RTRUE
?L11:	SET 'MAZE-EXIT-FLAG,1
	PUTP MAZE-ANTEROOM,P?EXITS,C-NORTH
	PRINTI "The silver rose fits the carving perfectly. As it slides in, an "
	PRINT OCT-HOLE
	PRINTI " appears below the carving. It is small, but large enough to squeeze through. You notice that the arm pointing north is now dull pot-metal."
	GRTR? COMPASS-ROSE-ARMS,1 \?L14
	PRINTI " Further, all the other arms are silver again!"
?L14:	MOVE OCTAGONAL-HOLE,HERE
	SET 'COMPASS-ROSE-ARMS,1
	SET 'COMPASS-ROSE-STATE,C-NORTH
	CRLF
	RTRUE
?L9:	PRINTR "It won't fit."

	.FUNCT COMPASS-ROSE-DESC,RARG,OBJ
	FSET? OBJ,TOUCHBIT /?L1
	PRINTI "A "
	PRINTD COMPASS-ROSE
	PRINTI " lies discarded in a corner"
	JUMP ?L3
?L1:	PRINTI "There is a "
	PRINTD COMPASS-ROSE
	PRINTI " here"
?L3:	PRINT PERIOD
	RTRUE

	.FUNCT ARM-DIRECTION,N,L,CNT
	GET DIR-TABLE,0 >L
	SET 'CNT,1
?L1:	GET DIR-TABLE,CNT >STACK
	EQUAL? STACK,N \?L4
	ADD CNT,2 >STACK
	GET DIR-TABLE,STACK >STACK
	RSTACK
?L4:	ADD CNT,3 >CNT
	GRTR? CNT,L \?L1
	RTRUE

	.FUNCT COMPASS-ROSE-F,N=1,1ST?=1
	EQUAL? PRSA,V?EXAMINE \?L1
	PRINTI "Ornate arms indicating the directions grace this lovely silver compass rose. The central knob tells which arm goes with which direction. The arms are decorated with mythological scenes"
	LESS? COMPASS-ROSE-ARMS,8 \?L3
	ZERO? COMPASS-ROSE-ARMS \?L5
	PRINTI " in"
	JUMP ?L7
?L5:	PRINTI ". Oddly, some of the arms are"
?L7:	PRINTI " finely wrought silver chased with gold"
?L3:	GRTR? COMPASS-ROSE-ARMS,0 \?L9
	GRTR? COMPASS-ROSE-ARMS,1 \?L11
	LESS? COMPASS-ROSE-ARMS,8 \?L13
	PRINTI ", while some of the arms ("
?L15:	EQUAL? N,256 /?L16
	BAND COMPASS-ROSE-STATE,N >STACK
	ZERO? STACK /?L19
	ZERO? 1ST? /?L20
	SET '1ST?,0
	JUMP ?L22
?L20:	PRINTI ", "
?L22:	CALL ARM-DIRECTION,N >STACK
	PRINT STACK
?L19:	MUL N,2 >N
	JUMP ?L15
?L16:	PRINTI ")"
	JUMP ?L24
?L13:	PRINTI ". Oddly, all of the arms"
?L24:	PRINTI " are"
	JUMP ?L25
?L11:	PRINTI ", while the "
	CALL ARM-DIRECTION,COMPASS-ROSE-STATE >STACK
	PRINT STACK
	PRINTI " arm is"
?L25:	PRINTI " made of ornate lead or pot-metal chased with brass"
?L9:	PRINTI "."
	EQUAL? HERE,MAZE-ANTEROOM \?L27
	IN? COMPASS-ROSE,COMPASS-CARVING /?L27
	PRINTI " The compass rose exactly fits the carving of a compass rose on the north wall of the room."
?L27:	CRLF
	RTRUE
?L1:	EQUAL? PRSA,V?COMPARE \?L30
	EQUAL? COMPASS-ROSE,PRSO,PRSI \?L30
	EQUAL? COMPASS-CARVING,PRSO,PRSI \?L30
	PRINTI "The "
	PRINTD COMPASS-CARVING
	PRINTI " is a carving of the "
	PRINTD COMPASS-ROSE
	PRINT PERIOD
	RTRUE
?L30:	EQUAL? PRSA,V?TURN,V?MOVE,V?RUB /?L32
	EQUAL? PRSA,V?SPIN \FALSE
?L32:	PRINT NOTHING-HAPPENS
	RTRUE

	.FUNCT RUNE-F,DIR
	EQUAL? PRSA,V?EXAMINE,V?READ \FALSE
	GETP PRSO,P?EXITS >DIR
	PRINTI "This is the rune for """
	CALL ARM-DIRECTION,DIR >STACK
	PRINT STACK
	PRINTI ","" made of inlaid "
	GETP HERE,P?WALLS >STACK
	BAND STACK,DIR >STACK
	ZERO? STACK \?L3
	EQUAL? HERE,MAZE-2 \?L5
	EQUAL? DIR,C-WEST \?L5
	PRINTI "gold"
	JUMP ?L8
?L5:	PRINTI "silver"
	JUMP ?L8
?L3:	PRINTI "lead"
?L8:	PRINT PERIOD
	RTRUE

	.FUNCT OCTAGONAL-HOLE-F,E,PT,PTS
	EQUAL? HERE,MAZE-2 \?L1
	IN? MAZE-2-DOOR,HERE \?L1
	CALL MAZE-2-DOOR-F >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?REZROV \?L3
	PRINT IT-IS-ALREADY
	PRINTR "open."
?L3:	EQUAL? PRSA,V?LOOK-INSIDE \?L4
	PRINT NOW-BLACK
	CRLF
	RTRUE
?L4:	EQUAL? PRSA,V?EXAMINE \?L5
	PRINTI "It looks like an "
	PRINT OCT-HOLE
	PRINT PERIOD
	RTRUE
?L5:	EQUAL? PRSA,V?PUT,V?THROW,V?DROP \?L6
	CALL HELD?,PRSO >STACK
	ZERO? STACK /?L6
	EQUAL? PRSI,OCTAGONAL-HOLE \?L6
	GETP HERE,P?EXITS >E
	CALL DIR-BASE,E,DIR-BIT,DIR-DIR >E
	GETPT HERE,E >PT
	PTSIZE PT >PTS
	EQUAL? PTS,UEXIT /?L9
	EQUAL? PTS,CEXIT \?L7
	GETB PT,CEXITFLAG >STACK
	VALUE STACK >STACK
	ZERO? STACK /?L7
?L9:	GETB PT,REXIT >STACK
	MOVE PRSO,STACK
	CALL CTHE-PRINT-PRSO
	PRINTR " disappears into the hole."
?L7:	PRINTR "It won't go."
?L6:	EQUAL? PRSA,V?THROUGH,V?BOARD \FALSE
	GETP HERE,P?EXITS >E
	LESS? E,256 \FALSE
	CALL DIR-BASE,E,DIR-BIT,DIR-DIR >STACK
	CALL DO-WALK,STACK >STACK
	RSTACK

	.FUNCT DESCRIBE-PLUG
	PRINTI "On the west wall just under the rune is an "
	PRINT OCT-HOLE
	IN? MAZE-2-DOOR,HERE \?L1
	PRINTI " plugged with a perfectly fitting piece of alabaster"
?L1:	PRINTI "."
	RTRUE

	.FUNCT MAZE-2-DOOR-F,OPEN?
	IN? MAZE-2-DOOR,HERE /?L1
	SET 'OPEN?,1
	JUMP ?L2
?L1:	SET 'OPEN?,0
?L2:	EQUAL? PRSA,V?EXAMINE \?L3
	CALL DESCRIBE-PLUG
	CRLF
	RTRUE
?L3:	EQUAL? PRSA,V?TAKE,V?MOVE \?L5
	FSET? PRSO,OPENBIT /FALSE
	PRINTR "You can't budge it."
?L5:	EQUAL? PRSA,V?PUSH \?L9
	ZERO? OPEN? /?L10
	PRINT THERE-IS-NOTHING
	PRINTR "there to push on anymore."
?L10:	PRINT NOTHING-HAPPENS
	RTRUE
?L9:	EQUAL? PRSA,V?OPEN \?L13
	PRINTR "There is no apparent lock or handle."
?L13:	EQUAL? PRSA,V?CLOSE \?L14
	ZERO? OPEN? /?L15
	CALL NO-DOOR >STACK
	RSTACK
?L15:	PRINT IT-IS-ALREADY
	PRINTI "closed"
	PRINT PERIOD
	RTRUE
?L14:	EQUAL? PRSA,V?THROUGH \?L18
	ZERO? OPEN? /?L19
	CALL DO-WALK,P?WEST >STACK
	RSTACK
?L19:	CALL NO-DOOR >STACK
	RSTACK
?L18:	EQUAL? PRSA,V?REZROV \FALSE
	PUTP HERE,P?EXITS,4
	FSET OCTAGONAL-HOLE,OPENBIT
	REMOVE MAZE-2-DOOR
	PRINTI "The alabaster melts away, leaving an "
	PRINT OCT-HOLE
	PRINTR " leading west."

	.FUNCT NO-DOOR
	PRINTR "There's no door there."

	.FUNCT DESCRIBE-MAZE-WALLS,EXITS,CNT=1,E=1
	GETP HERE,P?EXITS >EXITS
?L1:	EQUAL? E,256 /TRUE
	BAND EXITS,E >STACK
	ZERO? STACK /?L5
	PRINTI " The "
	CALL ARM-DIRECTION,E >STACK
	PRINT STACK
	GRTR? E,8 \?L6
	PUSH STR?290
	JUMP ?L8
?L6:	PUSH STR?291
?L8:	PRINT STACK
	PRINTI " has a perfect "
	PRINT OCT-HOLE
	PRINTI " in it, just under the "
	EQUAL? HERE,MAZE-ANTEROOM \?L9
	PRINTI "carving"
	JUMP ?L11
?L9:	PRINTI "rune"
?L11:	PRINTI "."
?L5:	INC 'CNT
	MUL E,2 >E
	JUMP ?L1

	.FUNCT MAZE-F,RARG,DIR,OEXITS
	EQUAL? RARG,M-LOOK \?L1
	PRINTI "This room is in the shape of an octagonal solid carved from marble. The floor and ceiling are the octagons and each wall is a rectangle. On each wall is inlaid a rune indicating a direction: the north wall has ""north"" carved on it, and so on. The "
	EQUAL? HERE,MAZE-1 \?L3
	PRINTI "runes are all of lead."
	JUMP ?L5
?L3:	EQUAL? HERE,MAZE-2 \?L6
	PRINTI "west rune is gold, the "
?L6:	CALL TELL-WALLS
	PRINTI " runes are lead, the rest are of silver."
?L5:	GETP HERE,P?EXITS >STACK
	ZERO? STACK /?L9
	CALL DESCRIBE-MAZE-WALLS
?L9:	EQUAL? HERE,MAZE-2 \?L12
	IN? MAZE-2-DOOR,HERE \?L12
	PRINTI " "
	CALL DESCRIBE-PLUG
?L12:	CRLF
	RTRUE
?L1:	EQUAL? RARG,M-ENTER \?L15
	EQUAL? HERE,MAZE-2 \?L16
	MOVE OCTAGONAL-HOLE,HERE
	FCLEAR OCTAGONAL-HOLE,OPENBIT
?L16:	FCLEAR HERE,TOUCHBIT
	RTRUE
?L15:	EQUAL? RARG,M-LEAVE \?L19
	EQUAL? HERE,MAZE-2 \?L20
	MOVE MAZE-2-DOOR,MAZE-2
	FCLEAR OCTAGONAL-HOLE,OPENBIT
?L20:	PUTP HERE,P?EXITS,0
	RTRUE
?L19:	EQUAL? RARG,M-BEG \FALSE
	EQUAL? PRSA,V?WALK \?L24
	CALL DIR-BASE,P-WALK-DIR,DIR-DIR,DIR-BIT >DIR
	GETP HERE,P?EXITS >STACK
	BAND STACK,DIR >STACK
	ZERO? STACK /?L26
	CALL OCT-HOLE-DISAPPEARS
	CALL V-WALK >STACK
	RSTACK
?L26:	PRINTI "There is no exit "
	EQUAL? P-WALK-DIR,P?UP,P?DOWN \?L29
	PRINTI "there"
	JUMP ?L31
?L29:	PRINTI "on that wall"
?L31:	PRINT PERIOD
	RTRUE
?L24:	EQUAL? PRSA,V?PUT,V?PUT-ON \?L32
	EQUAL? PRSO,COMPASS-ROSE \?L32
	CALL GLOBAL-IN?,PRSI,HERE >STACK
	ZERO? STACK /?L33
	CALL PERFORM,V?RUB,PRSI,PRSO
	RTRUE
?L33:	IN? PRSI,GLOBAL-OBJECTS \FALSE
	GETP PRSI,P?EXITS >STACK
	ZERO? STACK /FALSE
	PRINT THERE-IS-NOTHING
	PRINTR "to hang it on."
?L32:	EQUAL? PRSA,V?RUB \FALSE
	EQUAL? PRSI,COMPASS-ROSE \FALSE
	GETP PRSO,P?EXITS >DIR
	EQUAL? HERE,MAZE-2 \?L38
	EQUAL? DIR,4 \?L38
	PRINT NOTHING-HAPPENS
	RTRUE
?L38:	ZERO? DIR /?L40
	GETP HERE,P?WALLS >STACK
	BAND STACK,DIR >STACK
	ZERO? STACK \?L40
	GETP HERE,P?EXITS >STACK
	BAND STACK,DIR >STACK
	ZERO? STACK \?L40
	BAND COMPASS-ROSE-STATE,DIR >STACK
	ZERO? STACK \?L40
	INC 'COMPASS-ROSE-ARMS
	BOR COMPASS-ROSE-STATE,DIR >COMPASS-ROSE-STATE
	GETP HERE,P?EXITS >OEXITS
	PUTP HERE,P?EXITS,DIR
	MOVE OCTAGONAL-HOLE,HERE
	PRINTI "As the compass rose touches the "
	PRINTD PRSO
	PRINTI ", the arm of the rose labelled """
	CALL ARM-DIRECTION,DIR >STACK
	PRINT STACK
	PRINTI """ turns dull and leaden, and an "
	PRINT OCT-HOLE
	PRINTI " large enough for you to squeeze through appears in the wall below the rune."
	ZERO? OEXITS /?L41
	PRINTI " The other hole disappears."
?L41:	CRLF
	RTRUE
?L40:	PRINT NOTHING-HAPPENS
	RTRUE

	.FUNCT TELL-WALLS,N=0,L,1ST?=1,OLD=0,CNT
	GET DIR-TABLE,0 >L
	ZERO? N \?L1
	GETP HERE,P?WALLS >N
?L1:	SET 'CNT,1
?L4:	GET DIR-TABLE,CNT >STACK
	BAND STACK,N >STACK
	ZERO? STACK /?L7
	ZERO? OLD /?L9
	ZERO? 1ST? /?L11
	SET '1ST?,0
	JUMP ?L13
?L11:	PRINTI ", "
?L13:	PRINT OLD
?L9:	ADD CNT,2 >STACK
	GET DIR-TABLE,STACK >OLD
?L7:	ADD CNT,3 >CNT
	GRTR? CNT,L \?L4
	PRINTI " and "
	PRINT OLD
	RTRUE

	.FUNCT MIRROR-PSEUDO
	EQUAL? PRSA,V?EXAMINE,V?LOOK-INSIDE \?L1
	CALL PERFORM,V?EXAMINE,ME
	RTRUE
?L1:	EQUAL? PRSA,V?RUB \FALSE
	PRINTR "Nothing happens here."

	.FUNCT MAGIC-ROOM-F,RARG
	EQUAL? RARG,M-LOOK \?L1
	PRINTR "This place is odd indeed. Nothing that you look at is what it seems. If you look at something carefully enough it turns out to be something entirely different. The room is cluttered with objects and obviously hasn't been cleaned in a long time. The floor is overgrown with grass and weeds, and rabbits have chewed them. There are bird nests around the ceiling and droppings here and there. A very untidy and unsettling place. Much of the walls, ceiling and floor is covered in mirrors. There are empty, mirrorless square areas at north and south and a round black emptiness to the east."
?L1:	EQUAL? RARG,M-LEAVE \FALSE
	CALL RECOVER-CUBE >STACK
	RSTACK

	.FUNCT GOT?,CUBE,?TMP
	EQUAL? CUBE,BLORPLE-OBJECT /TRUE
	CALL HELD?,CUBE >?TMP
	ZERO? ?TMP /?L4
	RETURN ?TMP
?L4:	IN? CUBE,CASTLE /TRUE
	RFALSE

	.FUNCT HAS-ALL-CUBES?
	CALL COUNT-CUBES >STACK
	EQUAL? STACK,13 \FALSE
	RTRUE

	.FUNCT COUNT-CUBES,N=0,CNT
	SET 'CNT,0
?L1:	MUL CNT,2 >STACK
	GET CUBE-LIST,STACK >STACK
	CALL GOT?,STACK >STACK
	ZERO? STACK /?L4
	INC 'N
?L4:	IGRTR? 'CNT,12 \?L1
	RETURN N

	.FUNCT MAGIC-DOOR-EXIT
	CALL HAS-ALL-CUBES? >STACK
	ZERO? STACK /?L1
	RETURN CASTLE
?L1:	PRINT YOU-CANT
	PRINTI "push your way through."
	CRLF
	RFALSE

	.FUNCT SAND-PSEUDO
	CALL REDIRECT,PSEUDO-OBJECT,GROUND >STACK
	RSTACK

	.FUNCT TIME-ROOM-F,RARG
	EQUAL? RARG,M-LOOK \?L1
	PRINTR "A thin trickle of sand flows down from an exit in the ceiling of this circular room to a pile of sand on the floor. The walls of the room are glass, but you can see nothing through them. In the sand is a hole through which, oddly enough, no sand is pouring out."
?L1:	EQUAL? RARG,M-LEAVE \FALSE
	CALL RECOVER-CUBE >STACK
	RSTACK

	.FUNCT CHANNEL-PSEUDO
	EQUAL? PRSA,V?EXAMINE,V?THROUGH \FALSE
	PRINTR "The channel is buried under rubble."

	.FUNCT PAST-RUINS-ROOM-F,RARG
	EQUAL? RARG,M-LOOK \?L1
	PRINTI "This is the south end of a vast chamber filled with partially ruined structures. Here the portico of a building is collapsing. The pillars holding it up are starting to crumble. One has recently fallen and smashed the pavement. The fall exposed and the rubble blocked a small channel filled with swiftly rushing water which is rapidly inundating the area. "
	GET WATER-TABLE,PAST-WATER-FLAG >STACK
	PRINT STACK
	CRLF
	RTRUE
?L1:	EQUAL? RARG,M-BEG \?L3
	EQUAL? PRSA,V?PUT \?L4
	EQUAL? PRSI,WATER \?L4
	REMOVE PRSO
	CALL CTHE-PRINT-PRSO
	PRINTR " is borne away by the flood."
?L4:	EQUAL? PRSA,V?THROUGH \FALSE
	EQUAL? PRSO,WATER /?L7
	EQUAL? P-PNAM,W?CHANNEL \FALSE
?L7:	GRTR? PAST-WATER-FLAG,2 \?L8
	PRINT YOU-ARE
	PRINT PERIOD
	RTRUE
?L8:	PRINTR "It's cold and icy."
?L3:	EQUAL? RARG,M-ENTER \?L12
	GRTR? PAST-WATER-FLAG,0 \?L13
	SET 'DEATHS,3
	CALL PRINT-ID,STR?292
	CALL JIGS-UP,STR?293 >STACK
	RSTACK
?L13:	MOVE GIRGOL-SCROLL,SACK
	FSET GIRGOL-SCROLL,TOUCHBIT
	CALL QUEUE,I-WATER-RISING,3 >STACK
	RSTACK
?L12:	EQUAL? RARG,M-LEAVE \FALSE
	REMOVE PLAYER
	CALL DEQUEUE,I-WATER-RISING
	ZERO? DEAD? \?L17
	CALL ONLY?,ZIPPER,HERE >STACK
	ZERO? STACK /?L17
	CALL ONLY?,GIRGOL-SCROLL,ZIPPER >STACK
	ZERO? STACK /?L17
	FSET? ZIPPER,OPENBIT /?L17
	MOVE PLAYER,HERE
	ADD SCORE,RUINS-SCORE >SCORE
	SET 'RUINS-SCORE,0
	RETURN RUINS-SCORE
?L17:	MOVE PLAYER,HERE
	MOVE GIRGOL-SCROLL,SACK
	MOVE SACK,HERE
	PRINT TIME-SICK
	PRINTI "You feel that you are being pummelled by huge rocks and boulders"
	SET 'DEATHS,3
	CALL PRINT-ID,STR?294
	CALL JIGS-UP,STR?295 >STACK
	RSTACK

	.FUNCT ONLY?,OBJ,CON
	IN? OBJ,CON \FALSE
	FIRST? CON >CON \FALSE
	EQUAL? OBJ,CON \FALSE
	NEXT? CON >STACK \TRUE
	RFALSE

	.FUNCT SACK-F
	EQUAL? PRSA,V?EXAMINE \?L1
	PRINTI "This is a burlap sack of medium size. "
	CALL TELL-OPEN-CLOSED,SACK >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?OPEN \?L3
	FSET? SACK,OPENBIT /?L3
	FSET SACK,OPENBIT
	PRINTI "Opening the "
	PRINTD SACK
	PRINTI " reveals "
	CALL WHAT-CONTENTS >STACK
	RSTACK
?L3:	EQUAL? PRSA,V?LOOK-INSIDE \FALSE
	CALL CTHE-PRINT,SACK
	PRINTI " is "
	FSET? SACK,OPENBIT \?L5
	PRINTI "dim inside, but you can see "
	CALL PRINT-CONTENTS,SACK >STACK
	ZERO? STACK \?L7
	PRINTI "that it's empty"
?L7:	PRINTR "."
?L5:	PRINTR "closed."

	.FUNCT PAST-CELL-EAST-F,RARG
	EQUAL? RARG,M-LOOK \?L1
	PRINTI "This is a luxurious cell, obviously for the imprisonment of a highborn or powerful person. Its rich hangings and heavily ornamented furniture speak of a prisoner whose comfort is important even during imprisonment. A massive oak cabinet dominates one wall. "
	CALL TELL-OPEN-CLOSED,PAST-CABINET
	CALL TELL-OPEN-CLOSED,CELL-DOOR >STACK
	RSTACK
?L1:	EQUAL? RARG,M-LEAVE \?L3
	CALL DEQUEUE,I-PRISON-GUARDS
	REMOVE PLAYER
	ZERO? DEAD? \?L4
	FSET? PAST-CABINET,RMUNGBIT /?L4
	FSET? PAST-CABINET,LOCKED \?L4
	FSET? CELL-DOOR,OPENBIT \?L4
	CALL ONLY?,SPELL-BOOK,PAST-CABINET >STACK
	ZERO? STACK /?L4
	CALL ONLY?,PAST-CABINET,HERE >STACK
	ZERO? STACK /?L4
	ADD SCORE,25 >SCORE
	MOVE PLAYER,HERE
	RTRUE
?L4:	MOVE PLAYER,HERE
	MOVE BLANK-SCROLL,PAST-CABINET
	ZERO? DEAD? \FALSE
	CALL TIME-SICK-CELL-EAST >STACK
	RSTACK
?L3:	EQUAL? RARG,M-ENTER \FALSE
	IN? SPELL-BOOK,PAST-CABINET \FALSE
	CALL JIGS-UP,PAST-CELL-GUARDS-KILL-YOU >STACK
	RSTACK

	.FUNCT TIME-SICK-CELL-EAST
	PRINT TIME-SICK
	PRINTI "You feel that you are being devoured by monsters and pulled screaming beneath the water simultaneously"
	SET 'DEATHS,3
	CALL PRINT-ID,STR?296
	CALL JIGS-UP,STR?295 >STACK
	RSTACK

	.FUNCT CELL-DOOR-F
	EQUAL? PRSA,V?OPEN \?L1
	PRINTR "The door is locked."
?L1:	EQUAL? PRSA,V?THROUGH \?L3
	EQUAL? HERE,PAST-CELL-EAST,CELL-EAST \?L4
	PUSH P?SOUTH
	JUMP ?L6
?L4:	PUSH P?NORTH
?L6:	CALL DO-WALK,STACK >STACK
	RSTACK
?L3:	EQUAL? PRSA,V?REZROV \FALSE
	CALL HELD?,MAGIC-CUBE >STACK
	ZERO? STACK /?L8
	FCLEAR CELL-DOOR,LOCKED
	FSET CELL-DOOR,OPENBIT
	CALL QUEUE,I-PRISON-GUARDS,2
	PRINTR "The door bursts outward in an explosion of power! Immediately, you hear the shouts of guards and the rattle of weapons."
?L8:	CALL REZROV-TOUGH-DOOR >STACK
	RSTACK

	.FUNCT PAST-CELL-EAST-EXIT
	FSET? CELL-DOOR,OPENBIT \?L1
	CALL JIGS-UP,PAST-CELL-GUARDS-KILL-YOU
	RFALSE
?L1:	PRINT DOOR-LOCKED
	PRINT PERIOD
	RFALSE

	.FUNCT CONNECTIVITY-ROOM-F,RARG
	EQUAL? RARG,M-LOOK \?L1
	PRINTR "This is the nexus of a web of multicolored strings and threads of light. They come in from the far distance in graceful curves or tangled, jagged paths. In the center of the room they tie together into a ball that looks like gossamer yarn or glowing cotton candy. One bright set of threads points south to a gap in the weave and another points east to a similar gap."
?L1:	EQUAL? RARG,M-LEAVE \FALSE
	CALL RECOVER-CUBE >STACK
	RSTACK

	.FUNCT CUBE-NAME,CUBE,WRD,CNT,CHR
	GETP CUBE,P?NAME >WRD
	ZERO? WRD /?L1
	GET WRD,1 >CNT
	ADD WRD,4 >WRD
	PRINTI """"
?L3:	GETB WRD,0 >CHR
	ZERO? CHR /?L4
	PRINTC CHR
	INC 'WRD
	DEC 'CNT
	ZERO? CNT \?L3
?L4:	PRINTI """"
	RTRUE
?L1:	PRINTI "no word"
	RTRUE

	.FUNCT CUBE-ADJ,OBJ,TBL
	CALL ZMEMQ,OBJ,CUBE-LIST,47 >TBL
	ZERO? TBL /FALSE
	GET TBL,1 >STACK
	RSTACK

	.FUNCT WRITE-ON-CUBE,OBJ,ADJ,PTR,F
	CALL CUBE-ADJ,OBJ >ADJ
	ZERO? ADJ /FALSE
	GETP OBJ,P?NAME >PTR
	ZERO? PTR \?L3
	GETPT OBJ,P?ADJECTIVE >F
	GETB F,2 >STACK
	PUTB F,1,STACK
	SET 'PTR,P-QNEXT
	ADD P-QNEXT,10 >P-QNEXT
	PUT P-QNEXT,0,0
?L3:	PUTP OBJ,P?NAME,PTR
	FSET OBJ,THE
	CALL QCOPY,ADJ,P-QWORD,PTR
	RETURN ADJ

	.INSERT "./annotated_games/spellbreaker/spellbreaker_str"
	.END
