	.INSERT "./annotated_games/zork1/zork1_freq"
	.INSERT "./annotated_games/zork1/zork1_data"

	.FUNCT MAIN-LOOP,TRASH
?L1:	CALL MAIN-LOOP-1 >TRASH
	JUMP ?L1

	.FUNCT MAIN-LOOP-1,ICNT,OCNT,NUM,CNT,OBJ,TBL,V,PTBL,OBJ1,TMP,O,I
	SET 'CNT,0
	SET 'OBJ,0
	SET 'PTBL,1
	CALL PARSER >P-WON
	ZERO? P-WON /?L1
	GET P-PRSI,P-MATCHLEN >ICNT
	GET P-PRSO,P-MATCHLEN >OCNT
	ZERO? P-IT-OBJECT /?L3
	CALL ACCESSIBLE?,P-IT-OBJECT >STACK
	ZERO? STACK /?L3
	SET 'TMP,0
?L5:	IGRTR? 'CNT,ICNT /?L6
	GET P-PRSI,CNT >STACK
	EQUAL? STACK,IT \?L5
	PUT P-PRSI,CNT,P-IT-OBJECT
	SET 'TMP,1
?L6:	ZERO? TMP \?L16
	SET 'CNT,0
?L15:	IGRTR? 'CNT,OCNT /?L16
	GET P-PRSO,CNT >STACK
	EQUAL? STACK,IT \?L15
	PUT P-PRSO,CNT,P-IT-OBJECT
?L16:	SET 'CNT,0
?L3:	ZERO? OCNT \?L25
	SET 'NUM,OCNT
	JUMP ?L32
?L25:	GRTR? OCNT,1 \?L27
	SET 'TBL,P-PRSO
	ZERO? ICNT \?L28
	SET 'OBJ,0
	JUMP ?L30
?L28:	GET P-PRSI,1 >OBJ
?L30:	SET 'NUM,OCNT
	JUMP ?L32
?L27:	GRTR? ICNT,1 \?L31
	SET 'PTBL,0
	SET 'TBL,P-PRSI
	GET P-PRSO,1 >OBJ
	SET 'NUM,ICNT
	JUMP ?L32
?L31:	SET 'NUM,1
?L32:	ZERO? OBJ \?L33
	EQUAL? ICNT,1 \?L33
	GET P-PRSI,1 >OBJ
?L33:	EQUAL? PRSA,V?WALK \?L36
	ZERO? P-WALK-DIR /?L36
	CALL PERFORM,PRSA,PRSO >V
	JUMP ?L52
?L36:	ZERO? NUM \?L38
	GETB P-SYNTAX,P-SBITS >STACK
	BAND STACK,P-SONUMS >STACK
	ZERO? STACK \?L39
	CALL PERFORM,PRSA >V
	SET 'PRSO,0
	JUMP ?L52
?L39:	ZERO? LIT \?L41
	PRINTI "It's too dark to see."
	CRLF
	JUMP ?L52
?L41:	PRINTI "It's not clear what you're referring to."
	CRLF
	SET 'V,0
	JUMP ?L52
?L38:	SET 'P-NOT-HERE,0
	SET 'P-MULT,0
	GRTR? NUM,1 \?L48
	SET 'P-MULT,1
?L48:	SET 'TMP,0
?L51:	IGRTR? 'CNT,NUM \?L53
	GRTR? P-NOT-HERE,0 \?L55
	PRINTI "The "
	EQUAL? P-NOT-HERE,NUM /?L59
	PRINTI "other "
?L59:	PRINTI "object"
	EQUAL? P-NOT-HERE,1 /?L66
	PRINTI "s"
?L66:	PRINTI " that you mentioned "
	EQUAL? P-NOT-HERE,1 /?L73
	PRINTI "are"
	JUMP ?L77
?L73:	PRINTI "is"
?L77:	PRINTI "n't here."
	CRLF
	JUMP ?L52
?L55:	ZERO? TMP \?L52
	PRINTI "There's nothing here you can take."
	CRLF
	JUMP ?L52
?L53:	ZERO? PTBL /?L87
	GET P-PRSO,CNT >OBJ1
	JUMP ?L89
?L87:	GET P-PRSI,CNT >OBJ1
?L89:	ZERO? PTBL /?L90
	SET 'O,OBJ1
	JUMP ?L92
?L90:	SET 'O,OBJ
?L92:	ZERO? PTBL /?L93
	SET 'I,OBJ
	JUMP ?L95
?L93:	SET 'I,OBJ1
?L95:	GRTR? NUM,1 /?L98
	GET P-ITBL,P-NC1 >STACK
	GET STACK,0 >STACK
	EQUAL? STACK,W?ALL \?L105
?L98:	LOC WINNER >V
	EQUAL? O,NOT-HERE-OBJECT \?L99
	INC 'P-NOT-HERE
	JUMP ?L51
?L99:	EQUAL? PRSA,V?TAKE \?L101
	ZERO? I /?L101
	GET P-ITBL,P-NC1 >STACK
	GET STACK,0 >STACK
	EQUAL? STACK,W?ALL \?L101
	IN? O,I \?L51
?L101:	EQUAL? P-GETFLAGS,P-ALL \?L102
	EQUAL? PRSA,V?TAKE \?L102
	LOC O >STACK
	EQUAL? STACK,WINNER,HERE,V /?L104
	LOC O >STACK
	EQUAL? STACK,I /?L104
	LOC O >STACK
	FSET? STACK,SURFACEBIT \?L51
?L104:	FSET? O,TAKEBIT /?L102
	FSET? O,TRYTAKEBIT \?L51
?L102:	EQUAL? OBJ1,IT \?L106
	PRINTD P-IT-OBJECT
	JUMP ?L108
?L106:	PRINTD OBJ1
?L108:	PRINTI ": "
?L105:	SET 'PRSO,O
	SET 'PRSI,I
	SET 'TMP,1
	CALL PERFORM,PRSA,PRSO,PRSI >V
	EQUAL? V,M-FATAL \?L51
?L52:	EQUAL? V,M-FATAL /?L129
	LOC WINNER >STACK
	GETP STACK,P?ACTION >STACK
	CALL STACK,M-END >V
	EQUAL? V,M-FATAL \?L121
?L129:	SET 'P-CONT,0
	JUMP ?L121
?L1:	SET 'P-CONT,0
?L121:	CALL NULL-F
	ZERO? P-WON /FALSE
	EQUAL? PRSA,V?SUPER-BRIEF,V?BRIEF,V?TELL /TRUE
	EQUAL? PRSA,V?VERSION,V?SAVE,V?VERBOSE /TRUE
	EQUAL? PRSA,V?SCORE,V?RESTART,V?QUIT /TRUE
	EQUAL? PRSA,V?RESTORE,V?UNSCRIPT,V?SCRIPT /TRUE
	CALL CLOCKER >V
	RETURN V

	.FUNCT PERFORM,A,O=0,I=0,V,OA,OO,OI
	SET 'OA,PRSA
	SET 'OO,PRSO
	SET 'OI,PRSI
	EQUAL? IT,I,O \?L1
	CALL ACCESSIBLE?,P-IT-OBJECT >STACK
	ZERO? STACK \?L1
	PRINTI "I don't see what you are referring to."
	CRLF
	RETURN 2
?L1:	EQUAL? O,IT \?L8
	SET 'O,P-IT-OBJECT
?L8:	EQUAL? I,IT \?L11
	SET 'I,P-IT-OBJECT
?L11:	SET 'PRSA,A
	SET 'PRSO,O
	ZERO? PRSO /?L14
	EQUAL? PRSI,IT /?L14
	EQUAL? PRSA,V?WALK /?L14
	SET 'P-IT-OBJECT,PRSO
?L14:	SET 'PRSI,I
	EQUAL? NOT-HERE-OBJECT,PRSO,PRSI \?L17
	CALL NOT-HERE-OBJECT-F >V
	ZERO? V \?L27
?L17:	SET 'O,PRSO
	SET 'I,PRSI
	GETP WINNER,P?ACTION >STACK
	CALL STACK >V
	ZERO? V \?L27
	LOC WINNER >STACK
	GETP STACK,P?ACTION >STACK
	CALL STACK,M-BEG >V
	ZERO? V \?L27
	GET PREACTIONS,A >STACK
	CALL STACK >V
	ZERO? V \?L27
	ZERO? I /?L24
	GETP I,P?ACTION >STACK
	CALL STACK >V
	ZERO? V \?L27
?L24:	ZERO? O /?L26
	EQUAL? A,V?WALK /?L25
	LOC O >STACK
	ZERO? STACK /?L25
	LOC O >STACK
	GETP STACK,P?CONTFCN >STACK
	CALL STACK >V
	ZERO? V \?L27
?L25:	ZERO? O /?L26
	EQUAL? A,V?WALK /?L26
	GETP O,P?ACTION >STACK
	CALL STACK >V
	ZERO? V \?L27
?L26:	GET ACTIONS,A >STACK
	CALL STACK >V
	ZERO? V /?L27
?L27:	SET 'PRSA,OA
	SET 'PRSO,OO
	SET 'PRSI,OI
	RETURN V

	.FUNCT QUEUE,RTN,TICK,CINT
	CALL INT,RTN >CINT
	PUT CINT,C-TICK,TICK
	RETURN CINT

	.FUNCT INT,RTN,DEMON=0,E,C,INT?1
	ADD C-TABLE,C-TABLELEN >E
	ADD C-TABLE,C-INTS >C
?L1:	EQUAL? C,E \?L3
	SUB C-INTS,C-INTLEN >C-INTS
	ZERO? DEMON /?L5
	SUB C-DEMONS,C-INTLEN >C-DEMONS
?L5:	ADD C-TABLE,C-INTS >INT?1
	PUT INT?1,C-RTN,RTN
	RETURN INT?1
?L3:	GET C,C-RTN >STACK
	EQUAL? STACK,RTN \?L7
	RETURN C
?L7:	ADD C,C-INTLEN >C
	JUMP ?L1

	.FUNCT CLOCKER,C,E,TICK,FLG=0
	ZERO? CLOCK-WAIT /?L1
	SET 'CLOCK-WAIT,0
	RFALSE
?L1:	ZERO? P-WON /?L4
	PUSH C-INTS
	JUMP ?L6
?L4:	PUSH C-DEMONS
?L6:	ADD C-TABLE,STACK >C
	ADD C-TABLE,C-TABLELEN >E
?L7:	EQUAL? C,E \?L9
	INC 'MOVES
	RETURN FLG
?L9:	GET C,C-ENABLED? >STACK
	ZERO? STACK /?L15
	GET C,C-TICK >TICK
	ZERO? TICK /?L15
	SUB TICK,1 >STACK
	PUT C,C-TICK,STACK
	GRTR? TICK,1 /?L15
	GET C,C-RTN >STACK
	CALL STACK >STACK
	ZERO? STACK /?L15
	SET 'FLG,1
?L15:	ADD C,C-INTLEN >C
	JUMP ?L7

	.FUNCT PARSER,PTR=P-LEXSTART,WRD,VAL=0,VERB=0,OF-FLAG=0,OWINNER,OMERGED,LEN,DIR=0,NW=0,LW=0,CNT=-1
?L1:	IGRTR? 'CNT,P-ITBLLEN /?L2
	ZERO? P-OFLAG \?L6
	GET P-ITBL,CNT >STACK
	PUT P-OTBL,CNT,STACK
?L6:	PUT P-ITBL,CNT,0
	JUMP ?L1
?L2:	SET 'OWINNER,WINNER
	SET 'OMERGED,P-MERGED
	SET 'P-ADVERB,0
	SET 'P-MERGED,0
	SET 'P-END-ON-PREP,0
	PUT P-PRSO,P-MATCHLEN,0
	PUT P-PRSI,P-MATCHLEN,0
	PUT P-BUTS,P-MATCHLEN,0
	ZERO? QUOTE-FLAG \?L9
	EQUAL? WINNER,PLAYER /?L9
	SET 'WINNER,PLAYER
	CALL META-LOC,PLAYER >HERE
	CALL LIT?,HERE >LIT
?L9:	ZERO? RESERVE-PTR /?L12
	SET 'PTR,RESERVE-PTR
	CALL STUFF,RESERVE-LEXV,P-LEXV
	ZERO? SUPER-BRIEF \?L14
	EQUAL? PLAYER,WINNER \?L14
	CRLF
?L14:	SET 'RESERVE-PTR,0
	SET 'P-CONT,0
	JUMP ?L21
?L12:	ZERO? P-CONT /?L17
	SET 'PTR,P-CONT
	ZERO? SUPER-BRIEF \?L18
	EQUAL? PLAYER,WINNER \?L18
	EQUAL? PRSA,V?SAY /?L18
	CRLF
?L18:	SET 'P-CONT,0
	JUMP ?L21
?L17:	SET 'WINNER,PLAYER
	SET 'QUOTE-FLAG,0
	LOC WINNER >STACK
	FSET? STACK,VEHBIT /?L22
	LOC WINNER >HERE
?L22:	CALL LIT?,HERE >LIT
	ZERO? SUPER-BRIEF \?L25
	CRLF
?L25:	PRINTI ">"
	READ P-INBUF,P-LEXV
?L21:	GETB P-LEXV,P-LEXWORDS >P-LEN
	ZERO? P-LEN \?L30
	PRINTI "I beg your pardon?"
	CRLF
	RFALSE
?L30:	GET P-LEXV,PTR >WRD
	EQUAL? WRD,W?OOPS \?L35
	ADD PTR,P-LEXELEN >STACK
	GET P-LEXV,STACK >STACK
	EQUAL? STACK,W?$PERIOD,W?$COMMA \?L37
	ADD PTR,P-LEXELEN >PTR
	DEC 'P-LEN
?L37:	GRTR? P-LEN,1 /?L40
	PRINTI "I can't help your clumsiness."
	CRLF
	RFALSE
?L40:	GET OOPS-TABLE,O-PTR >STACK
	ZERO? STACK /?L44
	GRTR? P-LEN,2 \?L49
	ADD PTR,P-LEXELEN >STACK
	GET P-LEXV,STACK >STACK
	EQUAL? STACK,W?$QUOTE \?L45
	PRINTI "Sorry, you can't correct mistakes in quoted text."
	CRLF
	RFALSE
?L45:	GRTR? P-LEN,2 \?L49
	PRINTI "Warning: only the first word after OOPS is used."
	CRLF
?L49:	ADD PTR,P-LEXELEN >STACK
	GET P-LEXV,STACK >STACK
	GET OOPS-TABLE,O-PTR >STACK
	PUT AGAIN-LEXV,STACK,STACK
	SET 'WINNER,OWINNER
	GET OOPS-TABLE,O-PTR >STACK
	MUL STACK,P-LEXELEN >STACK
	ADD STACK,3 >STACK
	MUL PTR,P-LEXELEN >STACK
	ADD STACK,7 >STACK
	GETB P-LEXV,STACK >STACK
	MUL PTR,P-LEXELEN >STACK
	ADD STACK,6 >STACK
	GETB P-LEXV,STACK >STACK
	CALL INBUF-ADD,STACK,STACK,STACK
	CALL STUFF,AGAIN-LEXV,P-LEXV
	GETB P-LEXV,P-LEXWORDS >P-LEN
	GET OOPS-TABLE,O-START >PTR
	CALL INBUF-STUFF,OOPS-INBUF,P-INBUF
	JUMP ?L56
?L44:	PUT OOPS-TABLE,O-END,0
	PRINTI "There was no word to replace!"
	CRLF
	RFALSE
?L35:	EQUAL? WRD,W?AGAIN,W?G /?L57
	SET 'P-NUMBER,0
?L57:	PUT OOPS-TABLE,O-END,0
?L56:	GET P-LEXV,PTR >STACK
	EQUAL? STACK,W?AGAIN,W?G \?L60
	GETB OOPS-INBUF,1 >STACK
	ZERO? STACK \?L62
	PRINTI "Beg pardon?"
	CRLF
	RFALSE
?L62:	ZERO? P-OFLAG /?L66
	PRINTI "It's difficult to repeat fragments."
	CRLF
	RFALSE
?L66:	ZERO? P-WON \?L69
	PRINTI "That would just repeat a mistake."
	CRLF
	RFALSE
?L69:	GRTR? P-LEN,1 \?L72
	ADD PTR,P-LEXELEN >STACK
	GET P-LEXV,STACK >STACK
	EQUAL? STACK,W?$PERIOD,W?$COMMA,W?THEN /?L75
	ADD PTR,P-LEXELEN >STACK
	GET P-LEXV,STACK >STACK
	EQUAL? STACK,W?AND \?L73
?L75:	ADD PTR,4 >PTR
	GETB P-LEXV,P-LEXWORDS >STACK
	SUB STACK,2 >STACK
	PUTB P-LEXV,P-LEXWORDS,STACK
	JUMP ?L79
?L73:	PRINTI "I couldn't understand that sentence."
	CRLF
	RFALSE
?L72:	ADD PTR,P-LEXELEN >PTR
	GETB P-LEXV,P-LEXWORDS >STACK
	DEC 'STACK
	PUTB P-LEXV,P-LEXWORDS,STACK
?L79:	GETB P-LEXV,P-LEXWORDS >STACK
	GRTR? STACK,0 \?L80
	CALL STUFF,P-LEXV,RESERVE-LEXV
	SET 'RESERVE-PTR,PTR
	JUMP ?L82
?L80:	SET 'RESERVE-PTR,0
?L82:	SET 'WINNER,OWINNER
	SET 'P-MERGED,OMERGED
	CALL INBUF-STUFF,OOPS-INBUF,P-INBUF
	CALL STUFF,AGAIN-LEXV,P-LEXV
	SET 'CNT,-1
	SET 'DIR,AGAIN-DIR
?L83:	IGRTR? 'CNT,P-ITBLLEN /?L90
	GET P-OTBL,CNT >STACK
	PUT P-ITBL,CNT,STACK
	JUMP ?L83
?L60:	CALL STUFF,P-LEXV,AGAIN-LEXV
	CALL INBUF-STUFF,P-INBUF,OOPS-INBUF
	PUT OOPS-TABLE,O-START,PTR
	MUL 4,P-LEN >STACK
	PUT OOPS-TABLE,O-LENGTH,STACK
	GETB P-LEXV,P-LEXWORDS >STACK
	MUL P-LEXELEN,STACK >STACK
	ADD PTR,STACK >STACK
	MUL 2,STACK >LEN
	SUB LEN,2 >STACK
	GETB P-LEXV,STACK >STACK
	SUB LEN,1 >STACK
	GETB P-LEXV,STACK >STACK
	ADD STACK,STACK >STACK
	PUT OOPS-TABLE,O-END,STACK
	SET 'RESERVE-PTR,0
	SET 'LEN,P-LEN
	SET 'P-DIR,0
	SET 'P-NCN,0
	SET 'P-GETFLAGS,0
?L89:	DLESS? 'P-LEN,0 \?L91
	SET 'QUOTE-FLAG,0
	JUMP ?L90
?L91:	GET P-LEXV,PTR >WRD
	ZERO? WRD \?L94
	CALL NUMBER?,PTR >WRD
	ZERO? WRD /?L93
?L94:	ZERO? P-LEN \?L95
	SET 'NW,0
	JUMP ?L97
?L95:	ADD PTR,P-LEXELEN >STACK
	GET P-LEXV,STACK >NW
?L97:	EQUAL? WRD,W?TO \?L98
	EQUAL? VERB,ACT?TELL \?L98
	SET 'WRD,W?$QUOTE
	JUMP ?L103
?L98:	EQUAL? WRD,W?THEN \?L103
	GRTR? P-LEN,0 \?L103
	ZERO? VERB \?L103
	ZERO? QUOTE-FLAG \?L103
	EQUAL? LW,0,W?$PERIOD \?L101
	SET 'WRD,W?THE
	JUMP ?L103
?L101:	PUT P-ITBL,P-VERB,ACT?TELL
	PUT P-ITBL,P-VERBN,0
	SET 'WRD,W?$QUOTE
?L103:	EQUAL? WRD,W?THEN,W?$PERIOD,W?$QUOTE \?L105
	EQUAL? WRD,W?$QUOTE \?L111
	ZERO? QUOTE-FLAG /?L109
	SET 'QUOTE-FLAG,0
	JUMP ?L111
?L109:	SET 'QUOTE-FLAG,1
?L111:	ZERO? P-LEN /?L113
	ADD PTR,P-LEXELEN >P-CONT
?L113:	PUTB P-LEXV,P-LEXWORDS,P-LEN
	JUMP ?L90
?L105:	CALL WT?,WRD,PS?DIRECTION,P1?DIRECTION >VAL
	ZERO? VAL /?L115
	EQUAL? VERB,0,ACT?WALK \?L115
	EQUAL? LEN,1 /?L116
	EQUAL? LEN,2 \?L117
	EQUAL? VERB,ACT?WALK /?L116
?L117:	EQUAL? NW,W?THEN,W?$PERIOD,W?$QUOTE \?L118
	LESS? LEN,2 \?L116
?L118:	ZERO? QUOTE-FLAG /?L119
	EQUAL? LEN,2 \?L119
	EQUAL? NW,W?$QUOTE /?L116
?L119:	GRTR? LEN,2 \?L115
	EQUAL? NW,W?$COMMA,W?AND \?L115
?L116:	SET 'DIR,VAL
	EQUAL? NW,W?$COMMA,W?AND \?L120
	ADD PTR,P-LEXELEN >STACK
	PUT P-LEXV,STACK,W?THEN
?L120:	GRTR? LEN,2 /?L155
	SET 'QUOTE-FLAG,0
	JUMP ?L90
?L115:	CALL WT?,WRD,PS?VERB,P1?VERB >VAL
	ZERO? VAL /?L126
	ZERO? VERB \?L126
	SET 'VERB,VAL
	PUT P-ITBL,P-VERB,VAL
	PUT P-ITBL,P-VERBN,P-VTBL
	PUT P-VTBL,0,WRD
	MUL PTR,2 >STACK
	ADD STACK,2 >CNT
	GETB P-LEXV,CNT >STACK
	PUTB P-VTBL,2,STACK
	ADD CNT,1 >STACK
	GETB P-LEXV,STACK >STACK
	PUTB P-VTBL,3,STACK
	JUMP ?L155
?L126:	CALL WT?,WRD,PS?PREPOSITION,0 >VAL
	ZERO? VAL \?L128
	EQUAL? WRD,W?ALL,W?ONE /?L128
	CALL WT?,WRD,PS?ADJECTIVE >STACK
	ZERO? STACK \?L128
	CALL WT?,WRD,PS?OBJECT >STACK
	ZERO? STACK /?L127
?L128:	GRTR? P-LEN,1 \?L129
	EQUAL? NW,W?OF \?L129
	ZERO? VAL \?L165
	EQUAL? WRD,W?ALL,W?ONE,W?A /?L129
	SET 'OF-FLAG,1
	JUMP ?L155
?L129:	ZERO? VAL /?L131
?L165:	ZERO? P-LEN /?L132
	EQUAL? NW,W?THEN,W?$PERIOD \?L131
?L132:	SET 'P-END-ON-PREP,1
	LESS? P-NCN,2 \?L155
	PUT P-ITBL,P-PREP1,VAL
	PUT P-ITBL,P-PREP1N,WRD
	JUMP ?L155
?L131:	EQUAL? P-NCN,2 \?L136
	PRINTI "There were too many nouns in that sentence."
	CRLF
	RFALSE
?L136:	INC 'P-NCN
	SET 'P-ACT,VERB
	CALL CLAUSE,PTR,VAL,WRD >PTR
	ZERO? PTR /FALSE
	LESS? PTR,0 \?L155
	SET 'QUOTE-FLAG,0
	JUMP ?L90
?L127:	EQUAL? WRD,W?OF \?L145
	ZERO? OF-FLAG /?L148
	EQUAL? NW,W?$PERIOD,W?THEN \?L146
?L148:	CALL CANT-USE,PTR
	RFALSE
?L146:	SET 'OF-FLAG,0
	JUMP ?L155
?L145:	CALL WT?,WRD,PS?BUZZ-WORD >STACK
	ZERO? STACK \?L155
	EQUAL? VERB,ACT?TELL \?L151
	CALL WT?,WRD,PS?VERB,P1?VERB >STACK
	ZERO? STACK /?L151
	EQUAL? WINNER,PLAYER \?L151
	PRINTI "Please consult your manual for the correct way to talk to other people or creatures."
	CRLF
	RFALSE
?L151:	CALL CANT-USE,PTR
	RFALSE
?L93:	CALL UNKNOWN-WORD,PTR
	RFALSE
?L155:	SET 'LW,WRD
	ADD PTR,P-LEXELEN >PTR
	JUMP ?L89
?L90:	PUT OOPS-TABLE,O-PTR,0
	ZERO? DIR /?L156
	SET 'PRSA,V?WALK
	SET 'PRSO,DIR
	SET 'P-OFLAG,0
	SET 'P-WALK-DIR,DIR
	SET 'AGAIN-DIR,DIR
	RETURN AGAIN-DIR
?L156:	ZERO? P-OFLAG /?L159
	CALL ORPHAN-MERGE
?L159:	SET 'P-WALK-DIR,0
	SET 'AGAIN-DIR,0
	CALL SYNTAX-CHECK >STACK
	ZERO? STACK /FALSE
	CALL SNARF-OBJECTS >STACK
	ZERO? STACK /FALSE
	CALL MANY-CHECK >STACK
	ZERO? STACK /FALSE
	CALL TAKE-CHECK >STACK
	ZERO? STACK \TRUE
	RFALSE

	.FUNCT STUFF,SRC,DEST,MAX=29,PTR=P-LEXSTART,CTR=1,BPTR
	GETB SRC,0 >STACK
	PUTB DEST,0,STACK
	GETB SRC,1 >STACK
	PUTB DEST,1,STACK
?L1:	GET SRC,PTR >STACK
	PUT DEST,PTR,STACK
	MUL PTR,2 >STACK
	ADD STACK,2 >BPTR
	GETB SRC,BPTR >STACK
	PUTB DEST,BPTR,STACK
	MUL PTR,2 >STACK
	ADD STACK,3 >BPTR
	GETB SRC,BPTR >STACK
	PUTB DEST,BPTR,STACK
	ADD PTR,P-LEXELEN >PTR
	IGRTR? 'CTR,MAX \?L1
	RTRUE

	.FUNCT INBUF-STUFF,SRC,DEST,CNT
	GETB SRC,0 >STACK
	SUB STACK,1 >CNT
?L1:	GETB SRC,CNT >STACK
	PUTB DEST,CNT,STACK
	DLESS? 'CNT,0 \?L1
	RTRUE

	.FUNCT INBUF-ADD,LEN,BEG,SLOT,DBEG,CTR=0,TMP,?TMP
	GET OOPS-TABLE,O-END >TMP
	ZERO? TMP /?L1
	SET 'DBEG,TMP
	JUMP ?L3
?L1:	GET OOPS-TABLE,O-LENGTH >TMP
	GETB AGAIN-LEXV,TMP >?TMP
	ADD TMP,1 >STACK
	GETB AGAIN-LEXV,STACK >STACK
	ADD ?TMP,STACK >DBEG
?L3:	ADD DBEG,LEN >STACK
	PUT OOPS-TABLE,O-END,STACK
?L4:	ADD BEG,CTR >STACK
	GETB P-INBUF,STACK >STACK
	ADD DBEG,CTR >STACK
	PUTB OOPS-INBUF,STACK,STACK
	INC 'CTR
	EQUAL? CTR,LEN \?L4
	PUTB AGAIN-LEXV,SLOT,DBEG
	SUB SLOT,1 >STACK
	PUTB AGAIN-LEXV,STACK,LEN
	RTRUE

	.FUNCT WT?,PTR,BIT,B1=5,OFFS=P-P1OFF,TYP
	GETB PTR,P-PSOFF >TYP
	BTST TYP,BIT \FALSE
	GRTR? B1,4 /TRUE
	BAND TYP,P-P1BITS >TYP
	EQUAL? TYP,B1 /?L6
	INC 'OFFS
?L6:	GETB PTR,OFFS >STACK
	RSTACK

	.FUNCT CLAUSE,PTR,VAL,WRD,OFF,NUM,ANDFLG=0,FIRST??=1,NW,LW=0
	SUB P-NCN,1 >STACK
	MUL STACK,2 >OFF
	ZERO? VAL /?L1
	ADD P-PREP1,OFF >NUM
	PUT P-ITBL,NUM,VAL
	ADD NUM,1 >STACK
	PUT P-ITBL,STACK,WRD
	ADD PTR,P-LEXELEN >PTR
	JUMP ?L3
?L1:	INC 'P-LEN
?L3:	ZERO? P-LEN \?L4
	DEC 'P-NCN
	RETURN -1
?L4:	ADD P-NC1,OFF >NUM
	MUL PTR,2 >STACK
	ADD P-LEXV,STACK >STACK
	PUT P-ITBL,NUM,STACK
	GET P-LEXV,PTR >STACK
	EQUAL? STACK,W?THE,W?A,W?AN \?L7
	GET P-ITBL,NUM >STACK
	ADD STACK,4 >STACK
	PUT P-ITBL,NUM,STACK
?L7:	DLESS? 'P-LEN,0 \?L12
	MUL PTR,2 >STACK
	ADD P-LEXV,STACK >STACK
	ADD NUM,1 >STACK
	PUT P-ITBL,STACK,STACK
	RETURN -1
?L12:	GET P-LEXV,PTR >WRD
	ZERO? WRD \?L17
	CALL NUMBER?,PTR >WRD
	ZERO? WRD /?L15
?L17:	ZERO? P-LEN \?L18
	SET 'NW,0
	JUMP ?L20
?L18:	ADD PTR,P-LEXELEN >STACK
	GET P-LEXV,STACK >NW
?L20:	EQUAL? WRD,W?AND,W?$COMMA \?L21
	SET 'ANDFLG,1
	JUMP ?L42
?L21:	EQUAL? WRD,W?ALL,W?ONE \?L23
	EQUAL? NW,W?OF \?L42
	DEC 'P-LEN
	ADD PTR,P-LEXELEN >PTR
	JUMP ?L42
?L23:	EQUAL? WRD,W?THEN,W?$PERIOD /?L28
	CALL WT?,WRD,PS?PREPOSITION >STACK
	ZERO? STACK /?L27
	GET P-ITBL,P-VERB >STACK
	ZERO? STACK /?L27
	ZERO? FIRST?? \?L27
?L28:	INC 'P-LEN
	MUL PTR,2 >STACK
	ADD P-LEXV,STACK >STACK
	ADD NUM,1 >STACK
	PUT P-ITBL,STACK,STACK
	SUB PTR,P-LEXELEN >STACK
	RSTACK
?L27:	CALL WT?,WRD,PS?OBJECT >STACK
	ZERO? STACK /?L29
	GRTR? P-LEN,0 \?L30
	EQUAL? NW,W?OF \?L30
	EQUAL? WRD,W?ALL,W?ONE \?L42
?L30:	CALL WT?,WRD,PS?ADJECTIVE,P1?ADJECTIVE >STACK
	ZERO? STACK /?L32
	ZERO? NW /?L32
	CALL WT?,NW,PS?OBJECT >STACK
	ZERO? STACK \?L42
?L32:	ZERO? ANDFLG \?L33
	EQUAL? NW,W?BUT,W?EXCEPT,W?AND /?L33
	EQUAL? NW,W?$COMMA /?L33
	ADD PTR,2 >STACK
	MUL STACK,2 >STACK
	ADD P-LEXV,STACK >STACK
	ADD NUM,1 >STACK
	PUT P-ITBL,STACK,STACK
	RETURN PTR
?L33:	SET 'ANDFLG,0
	JUMP ?L42
?L29:	ZERO? P-MERGED \?L36
	ZERO? P-OFLAG \?L36
	GET P-ITBL,P-VERB >STACK
	ZERO? STACK /?L35
?L36:	CALL WT?,WRD,PS?ADJECTIVE >STACK
	ZERO? STACK \?L42
	CALL WT?,WRD,PS?BUZZ-WORD >STACK
	ZERO? STACK \?L42
?L35:	ZERO? ANDFLG /?L38
	CALL WT?,WRD,PS?DIRECTION >STACK
	ZERO? STACK \?L39
	CALL WT?,WRD,PS?VERB >STACK
	ZERO? STACK /?L38
?L39:	SUB PTR,4 >PTR
	ADD PTR,2 >STACK
	PUT P-LEXV,STACK,W?THEN
	ADD P-LEN,2 >P-LEN
	JUMP ?L42
?L38:	CALL WT?,WRD,PS?PREPOSITION >STACK
	ZERO? STACK \?L42
	CALL CANT-USE,PTR
	RFALSE
?L15:	CALL UNKNOWN-WORD,PTR
	RFALSE
?L42:	SET 'LW,WRD
	SET 'FIRST??,0
	ADD PTR,P-LEXELEN >PTR
	JUMP ?L7

	.FUNCT NUMBER?,PTR,CNT,BPTR,CHR,SUM=0,TIM=0
	MUL PTR,2 >STACK
	ADD P-LEXV,STACK >STACK
	GETB STACK,2 >CNT
	MUL PTR,2 >STACK
	ADD P-LEXV,STACK >STACK
	GETB STACK,3 >BPTR
?L1:	DLESS? 'CNT,0 /?L2
	GETB P-INBUF,BPTR >CHR
	EQUAL? CHR,58 \?L6
	SET 'TIM,SUM
	SET 'SUM,0
	JUMP ?L10
?L6:	GRTR? SUM,10000 /FALSE
	LESS? CHR,58 \FALSE
	GRTR? CHR,47 \FALSE
	SUB CHR,48 >STACK
	MUL SUM,10 >STACK
	ADD STACK,STACK >SUM
?L10:	INC 'BPTR
	JUMP ?L1
?L2:	PUT P-LEXV,PTR,W?INTNUM
	GRTR? SUM,1000 /FALSE
	ZERO? TIM /?L13
	LESS? TIM,8 \?L14
	ADD TIM,12 >TIM
	JUMP ?L16
?L14:	GRTR? TIM,23 /FALSE
?L16:	MUL TIM,60 >STACK
	ADD SUM,STACK >SUM
?L13:	SET 'P-NUMBER,SUM
	RETURN W?INTNUM

	.FUNCT ORPHAN-MERGE,CNT=-1,TEMP,VERB,BEG,END,ADJ=0,WRD,?TMP
	SET 'P-OFLAG,0
	GET P-ITBL,P-VERBN >STACK
	GET STACK,0 >WRD
	CALL WT?,WRD,PS?VERB,P1?VERB >?TMP
	GET P-OTBL,P-VERB >STACK
	EQUAL? ?TMP,STACK /?L3
	CALL WT?,WRD,PS?ADJECTIVE >STACK
	ZERO? STACK /?L1
?L3:	SET 'ADJ,1
	JUMP ?L4
?L1:	CALL WT?,WRD,PS?OBJECT,P1?OBJECT >STACK
	ZERO? STACK /?L4
	ZERO? P-NCN \?L4
	PUT P-ITBL,P-VERB,0
	PUT P-ITBL,P-VERBN,0
	ADD P-LEXV,2 >STACK
	PUT P-ITBL,P-NC1,STACK
	ADD P-LEXV,6 >STACK
	PUT P-ITBL,P-NC1L,STACK
	SET 'P-NCN,1
?L4:	GET P-ITBL,P-VERB >VERB
	ZERO? VERB /?L6
	ZERO? ADJ \?L6
	GET P-OTBL,P-VERB >STACK
	EQUAL? VERB,STACK \FALSE
?L6:	EQUAL? P-NCN,2 /FALSE
	GET P-OTBL,P-NC1 >STACK
	EQUAL? STACK,1 \?L9
	GET P-ITBL,P-PREP1 >TEMP
	GET P-OTBL,P-PREP1 >STACK
	EQUAL? TEMP,STACK /?L12
	ZERO? TEMP \FALSE
?L12:	ZERO? ADJ /?L13
	ADD P-LEXV,2 >STACK
	PUT P-OTBL,P-NC1,STACK
	GET P-ITBL,P-NC1L >STACK
	ZERO? STACK \?L15
	ADD P-LEXV,6 >STACK
	PUT P-ITBL,P-NC1L,STACK
?L15:	ZERO? P-NCN \?L21
	SET 'P-NCN,1
	JUMP ?L21
?L13:	GET P-ITBL,P-NC1 >STACK
	PUT P-OTBL,P-NC1,STACK
?L21:	GET P-ITBL,P-NC1L >STACK
	PUT P-OTBL,P-NC1L,STACK
	JUMP ?L42
?L9:	GET P-OTBL,P-NC2 >STACK
	EQUAL? STACK,1 \?L23
	GET P-ITBL,P-PREP1 >TEMP
	GET P-OTBL,P-PREP2 >STACK
	EQUAL? TEMP,STACK /?L26
	ZERO? TEMP \FALSE
?L26:	ZERO? ADJ /?L29
	ADD P-LEXV,2 >STACK
	PUT P-ITBL,P-NC1,STACK
	GET P-ITBL,P-NC1L >STACK
	ZERO? STACK \?L29
	ADD P-LEXV,6 >STACK
	PUT P-ITBL,P-NC1L,STACK
?L29:	GET P-ITBL,P-NC1 >STACK
	PUT P-OTBL,P-NC2,STACK
	GET P-ITBL,P-NC1L >STACK
	PUT P-OTBL,P-NC2L,STACK
	SET 'P-NCN,2
	JUMP ?L42
?L23:	ZERO? P-ACLAUSE /?L42
	EQUAL? P-NCN,1 /?L35
	ZERO? ADJ \?L35
	SET 'P-ACLAUSE,0
	RFALSE
?L35:	GET P-ITBL,P-NC1 >BEG
	ZERO? ADJ /?L38
	ADD P-LEXV,2 >BEG
	SET 'ADJ,0
?L38:	GET P-ITBL,P-NC1L >END
?L41:	GET BEG,0 >WRD
	EQUAL? BEG,END \?L43
	ZERO? ADJ /?L45
	CALL ACLAUSE-WIN,ADJ
	JUMP ?L42
?L45:	SET 'P-ACLAUSE,0
	RFALSE
?L43:	ZERO? ADJ \?L48
	GETB WRD,P-PSOFF >STACK
	BTST STACK,PS?ADJECTIVE /?L49
	EQUAL? WRD,W?ALL,W?ONE \?L48
?L49:	SET 'ADJ,WRD
	JUMP ?L51
?L48:	EQUAL? WRD,W?ONE \?L50
	CALL ACLAUSE-WIN,ADJ
	JUMP ?L42
?L50:	GETB WRD,P-PSOFF >STACK
	BTST STACK,PS?OBJECT \?L51
	EQUAL? WRD,P-ANAM \?L52
	CALL ACLAUSE-WIN,ADJ
	JUMP ?L42
?L52:	CALL NCLAUSE-WIN
	JUMP ?L42
?L51:	ADD BEG,P-WORDLEN >BEG
	ZERO? END \?L41
	SET 'END,BEG
	SET 'P-NCN,1
	SUB BEG,4 >STACK
	PUT P-ITBL,P-NC1,STACK
	PUT P-ITBL,P-NC1L,BEG
	JUMP ?L41
?L42:	GET P-OVTBL,0 >STACK
	PUT P-VTBL,0,STACK
	GETB P-OVTBL,2 >STACK
	PUTB P-VTBL,2,STACK
	GETB P-OVTBL,3 >STACK
	PUTB P-VTBL,3,STACK
	PUT P-OTBL,P-VERBN,P-VTBL
	PUTB P-VTBL,2,0
?L60:	IGRTR? 'CNT,P-ITBLLEN \?L62
	SET 'P-MERGED,1
	RTRUE
?L62:	GET P-OTBL,CNT >STACK
	PUT P-ITBL,CNT,STACK
	JUMP ?L60

	.FUNCT ACLAUSE-WIN,ADJ
	GET P-OTBL,P-VERB >STACK
	PUT P-ITBL,P-VERB,STACK
	PUT P-CCTBL,CC-SBPTR,P-ACLAUSE
	ADD P-ACLAUSE,1 >STACK
	PUT P-CCTBL,CC-SEPTR,STACK
	PUT P-CCTBL,CC-DBPTR,P-ACLAUSE
	ADD P-ACLAUSE,1 >STACK
	PUT P-CCTBL,CC-DEPTR,STACK
	CALL CLAUSE-COPY,P-OTBL,P-OTBL,ADJ
	GET P-OTBL,P-NC2 >STACK
	ZERO? STACK /?L1
	SET 'P-NCN,2
?L1:	SET 'P-ACLAUSE,0
	RTRUE

	.FUNCT NCLAUSE-WIN
	PUT P-CCTBL,CC-SBPTR,P-NC1
	PUT P-CCTBL,CC-SEPTR,P-NC1L
	PUT P-CCTBL,CC-DBPTR,P-ACLAUSE
	ADD P-ACLAUSE,1 >STACK
	PUT P-CCTBL,CC-DEPTR,STACK
	CALL CLAUSE-COPY,P-ITBL,P-OTBL
	GET P-OTBL,P-NC2 >STACK
	ZERO? STACK /?L1
	SET 'P-NCN,2
?L1:	SET 'P-ACLAUSE,0
	RTRUE

	.FUNCT WORD-PRINT,CNT,BUF
?L1:	DLESS? 'CNT,0 /TRUE
	GETB P-INBUF,BUF >STACK
	PRINTC STACK
	INC 'BUF
	JUMP ?L1

	.FUNCT UNKNOWN-WORD,PTR,BUF,?TMP
	PUT OOPS-TABLE,O-PTR,PTR
	EQUAL? PRSA,V?SAY \?L1
	PRINTI "Nothing happens."
	CRLF
	RFALSE
?L1:	PRINTI "I don't know the word """
	MUL PTR,2 >BUF
	ADD P-LEXV,BUF >STACK
	GETB STACK,2 >?TMP
	ADD P-LEXV,BUF >STACK
	GETB STACK,3 >STACK
	CALL WORD-PRINT,?TMP,STACK
	PRINTI """."
	CRLF
	SET 'QUOTE-FLAG,0
	SET 'P-OFLAG,0
	RETURN P-OFLAG

	.FUNCT CANT-USE,PTR,BUF,?TMP
	EQUAL? PRSA,V?SAY \?L1
	PRINTI "Nothing happens."
	CRLF
	RFALSE
?L1:	PRINTI "You used the word """
	MUL PTR,2 >BUF
	ADD P-LEXV,BUF >STACK
	GETB STACK,2 >?TMP
	ADD P-LEXV,BUF >STACK
	GETB STACK,3 >STACK
	CALL WORD-PRINT,?TMP,STACK
	PRINTI """ in a way that I don't understand."
	CRLF
	SET 'QUOTE-FLAG,0
	SET 'P-OFLAG,0
	RETURN P-OFLAG

	.FUNCT SYNTAX-CHECK,SYN,LEN,NUM,OBJ,DRIVE1=0,DRIVE2=0,PREP,VERB,TMP
	GET P-ITBL,P-VERB >VERB
	ZERO? VERB \?L1
	PRINTI "There was no verb in that sentence!"
	CRLF
	RFALSE
?L1:	SUB 255,VERB >STACK
	GET VERBS,STACK >SYN
	GETB SYN,0 >LEN
	INC 'SYN
?L6:	GETB SYN,P-SBITS >STACK
	BAND STACK,P-SONUMS >NUM
	GRTR? P-NCN,NUM /?L15
	LESS? NUM,1 /?L10
	ZERO? P-NCN \?L10
	GET P-ITBL,P-PREP1 >PREP
	ZERO? PREP /?L11
	GETB SYN,P-SPREP1 >STACK
	EQUAL? PREP,STACK \?L10
?L11:	SET 'DRIVE1,SYN
	JUMP ?L15
?L10:	GET P-ITBL,P-PREP1 >STACK
	GETB SYN,P-SPREP1 >STACK
	EQUAL? STACK,STACK \?L15
	EQUAL? NUM,2 \?L13
	EQUAL? P-NCN,1 \?L13
	SET 'DRIVE2,SYN
	JUMP ?L15
?L13:	GET P-ITBL,P-PREP2 >STACK
	GETB SYN,P-SPREP2 >STACK
	EQUAL? STACK,STACK \?L15
	CALL SYNTAX-FOUND,SYN
	RTRUE
?L15:	DLESS? 'LEN,1 \?L18
	ZERO? DRIVE1 \?L53
	ZERO? DRIVE2 \?L7
	PRINTI "That sentence isn't one I recognize."
	CRLF
	RFALSE
?L18:	ADD SYN,P-SYNLEN >SYN
	JUMP ?L6
?L7:	ZERO? DRIVE1 /?L27
?L53:	GETB DRIVE1,P-SPREP1 >STACK
	GETB DRIVE1,P-SLOC1 >STACK
	GETB DRIVE1,P-SFWIM1 >STACK
	CALL GWIM,STACK,STACK,STACK >OBJ
	ZERO? OBJ /?L27
	PUT P-PRSO,P-MATCHLEN,1
	PUT P-PRSO,1,OBJ
	CALL SYNTAX-FOUND,DRIVE1 >STACK
	RSTACK
?L27:	ZERO? DRIVE2 /?L29
	GETB DRIVE2,P-SPREP2 >STACK
	GETB DRIVE2,P-SLOC2 >STACK
	GETB DRIVE2,P-SFWIM2 >STACK
	CALL GWIM,STACK,STACK,STACK >OBJ
	ZERO? OBJ /?L29
	PUT P-PRSI,P-MATCHLEN,1
	PUT P-PRSI,1,OBJ
	CALL SYNTAX-FOUND,DRIVE2 >STACK
	RSTACK
?L29:	EQUAL? VERB,ACT?FIND \?L30
	PRINTI "That question can't be answered."
	CRLF
	RFALSE
?L30:	EQUAL? WINNER,PLAYER /?L33
	CALL CANT-ORPHAN >STACK
	RSTACK
?L33:	CALL ORPHAN,DRIVE1,DRIVE2
	PRINTI "What do you want to "
	GET P-OTBL,P-VERBN >TMP
	ZERO? TMP \?L37
	PRINTI "tell"
	JUMP ?L42
?L37:	GETB P-VTBL,2 >STACK
	ZERO? STACK \?L41
	GET TMP,0 >STACK
	PRINTB STACK
	JUMP ?L42
?L41:	GETB TMP,3 >STACK
	GETB TMP,2 >STACK
	CALL WORD-PRINT,STACK,STACK
	PUTB P-VTBL,2,0
?L42:	ZERO? DRIVE2 /?L43
	PRINTI " "
	CALL THING-PRINT,1,1
?L43:	SET 'P-OFLAG,1
	ZERO? DRIVE1 /?L48
	GETB DRIVE1,P-SPREP1 >STACK
	JUMP ?L50
?L48:	GETB DRIVE2,P-SPREP2 >STACK
?L50:	CALL PREP-PRINT,STACK
	PRINTI "?"
	CRLF
	RFALSE

	.FUNCT CANT-ORPHAN
	PRINTI """I don't understand! What are you referring to?"""
	CRLF
	RFALSE

	.FUNCT ORPHAN,D1,D2,CNT=-1
	ZERO? P-MERGED \?L1
	PUT P-OCLAUSE,P-MATCHLEN,0
?L1:	GET P-VTBL,0 >STACK
	PUT P-OVTBL,0,STACK
	GETB P-VTBL,2 >STACK
	PUTB P-OVTBL,2,STACK
	GETB P-VTBL,3 >STACK
	PUTB P-OVTBL,3,STACK
?L4:	IGRTR? 'CNT,P-ITBLLEN /?L5
	GET P-ITBL,CNT >STACK
	PUT P-OTBL,CNT,STACK
	JUMP ?L4
?L5:	EQUAL? P-NCN,2 \?L9
	PUT P-CCTBL,CC-SBPTR,P-NC2
	PUT P-CCTBL,CC-SEPTR,P-NC2L
	PUT P-CCTBL,CC-DBPTR,P-NC2
	PUT P-CCTBL,CC-DEPTR,P-NC2L
	CALL CLAUSE-COPY,P-ITBL,P-OTBL
?L9:	LESS? P-NCN,1 /?L12
	PUT P-CCTBL,CC-SBPTR,P-NC1
	PUT P-CCTBL,CC-SEPTR,P-NC1L
	PUT P-CCTBL,CC-DBPTR,P-NC1
	PUT P-CCTBL,CC-DEPTR,P-NC1L
	CALL CLAUSE-COPY,P-ITBL,P-OTBL
?L12:	ZERO? D1 /?L15
	GETB D1,P-SPREP1 >STACK
	PUT P-OTBL,P-PREP1,STACK
	PUT P-OTBL,P-NC1,1
	RTRUE
?L15:	ZERO? D2 /FALSE
	GETB D2,P-SPREP2 >STACK
	PUT P-OTBL,P-PREP2,STACK
	PUT P-OTBL,P-NC2,1
	RTRUE

	.FUNCT THING-PRINT,PRSO?,THE?=0,BEG,END
	ZERO? PRSO? /?L1
	GET P-ITBL,P-NC1 >BEG
	GET P-ITBL,P-NC1L >END
	JUMP ?L3
?L1:	GET P-ITBL,P-NC2 >BEG
	GET P-ITBL,P-NC2L >END
?L3:	CALL BUFFER-PRINT,BEG,END,THE? >STACK
	RSTACK

	.FUNCT BUFFER-PRINT,BEG,END,CP,NOSP=1,WRD,FIRST??=1,PN=0,Q?=0
?L1:	EQUAL? BEG,END /TRUE
	GET BEG,0 >WRD
	EQUAL? WRD,W?$COMMA \?L6
	PRINTI ", "
	JUMP ?L11
?L6:	ZERO? NOSP /?L10
	SET 'NOSP,0
	JUMP ?L11
?L10:	PRINTI " "
?L11:	EQUAL? WRD,W?$PERIOD,W?$COMMA \?L14
	SET 'NOSP,1
	JUMP ?L18
?L14:	EQUAL? WRD,W?ME \?L16
	PRINTD ME
	SET 'PN,1
	JUMP ?L18
?L16:	EQUAL? WRD,W?INTNUM \?L17
	PRINTN P-NUMBER
	SET 'PN,1
	JUMP ?L18
?L17:	ZERO? FIRST?? /?L19
	ZERO? PN \?L19
	ZERO? CP /?L19
	PRINTI "the "
?L19:	ZERO? P-OFLAG \?L26
	ZERO? P-MERGED /?L24
?L26:	PRINTB WRD
	JUMP ?L28
?L24:	EQUAL? WRD,W?IT \?L27
	CALL ACCESSIBLE?,P-IT-OBJECT >STACK
	ZERO? STACK /?L27
	PRINTD P-IT-OBJECT
	JUMP ?L28
?L27:	GETB BEG,3 >STACK
	GETB BEG,2 >STACK
	CALL WORD-PRINT,STACK,STACK
?L28:	SET 'FIRST??,0
?L18:	ADD BEG,P-WORDLEN >BEG
	JUMP ?L1

	.FUNCT PREP-PRINT,PREP,WRD
	ZERO? PREP /FALSE
	PRINTI " "
	CALL PREP-FIND,PREP >WRD
	PRINTB WRD
	RTRUE

	.FUNCT CLAUSE-COPY,SRC,DEST,INSRT=0,BEG,END
	GET P-CCTBL,CC-SBPTR >STACK
	GET SRC,STACK >BEG
	GET P-CCTBL,CC-SEPTR >STACK
	GET SRC,STACK >END
	GET P-OCLAUSE,P-MATCHLEN >STACK
	MUL STACK,P-LEXELEN >STACK
	ADD STACK,2 >STACK
	ADD P-OCLAUSE,STACK >STACK
	GET P-CCTBL,CC-DBPTR >STACK
	PUT DEST,STACK,STACK
?L1:	EQUAL? BEG,END \?L3
	GET P-OCLAUSE,P-MATCHLEN >STACK
	MUL STACK,P-LEXELEN >STACK
	ADD STACK,2 >STACK
	ADD P-OCLAUSE,STACK >STACK
	GET P-CCTBL,CC-DEPTR >STACK
	PUT DEST,STACK,STACK
	RTRUE
?L3:	ZERO? INSRT /?L6
	GET BEG,0 >STACK
	EQUAL? P-ANAM,STACK \?L6
	CALL CLAUSE-ADD,INSRT
?L6:	GET BEG,0 >STACK
	CALL CLAUSE-ADD,STACK
	ADD BEG,P-WORDLEN >BEG
	JUMP ?L1

	.FUNCT CLAUSE-ADD,WRD,PTR
	GET P-OCLAUSE,P-MATCHLEN >STACK
	ADD STACK,2 >PTR
	SUB PTR,1 >STACK
	PUT P-OCLAUSE,STACK,WRD
	PUT P-OCLAUSE,PTR,0
	PUT P-OCLAUSE,P-MATCHLEN,PTR
	RTRUE

	.FUNCT PREP-FIND,PREP,CNT=0,SIZE
	GET PREPOSITIONS,0 >STACK
	MUL STACK,2 >SIZE
?L1:	IGRTR? 'CNT,SIZE /FALSE
	GET PREPOSITIONS,CNT >STACK
	EQUAL? STACK,PREP \?L1
	SUB CNT,1 >STACK
	GET PREPOSITIONS,STACK >STACK
	RSTACK

	.FUNCT SYNTAX-FOUND,SYN
	SET 'P-SYNTAX,SYN
	GETB SYN,P-SACTION >PRSA
	RETURN PRSA

	.FUNCT GWIM,GBIT,LBIT,PREP,OBJ
	EQUAL? GBIT,RMUNGBIT \?L1
	RETURN ROOMS
?L1:	SET 'P-GWIMBIT,GBIT
	SET 'P-SLOCBITS,LBIT
	PUT P-MERGE,P-MATCHLEN,0
	CALL GET-OBJECT,P-MERGE,0 >STACK
	ZERO? STACK /?L4
	SET 'P-GWIMBIT,0
	GET P-MERGE,P-MATCHLEN >STACK
	EQUAL? STACK,1 \FALSE
	GET P-MERGE,1 >OBJ
	PRINTI "("
	ZERO? PREP /?L10
	ZERO? P-END-ON-PREP \?L10
	CALL PREP-FIND,PREP >PREP
	PRINTB PREP
	EQUAL? PREP,W?OUT \?L12
	PRINTI " of"
?L12:	PRINTI " "
	EQUAL? OBJ,HANDS \?L19
	PRINTI "your hands"
	JUMP ?L23
?L19:	PRINTI "the "
	PRINTD OBJ
?L23:	PRINTI ")"
	CRLF
	RETURN OBJ
?L10:	PRINTD OBJ
	PRINTI ")"
	CRLF
	RETURN OBJ
?L4:	SET 'P-GWIMBIT,0
	RFALSE

	.FUNCT SNARF-OBJECTS,OPTR,IPTR,L
	PUT P-BUTS,P-MATCHLEN,0
	GET P-ITBL,P-NC2 >IPTR
	ZERO? IPTR /?L3
	GETB P-SYNTAX,P-SLOC2 >P-SLOCBITS
	GET P-ITBL,P-NC2L >STACK
	CALL SNARFEM,IPTR,STACK,P-PRSI >STACK
	ZERO? STACK /FALSE
?L3:	GET P-ITBL,P-NC1 >OPTR
	ZERO? OPTR /?L8
	GETB P-SYNTAX,P-SLOC1 >P-SLOCBITS
	GET P-ITBL,P-NC1L >STACK
	CALL SNARFEM,OPTR,STACK,P-PRSO >STACK
	ZERO? STACK /FALSE
?L8:	GET P-BUTS,P-MATCHLEN >STACK
	ZERO? STACK /TRUE
	GET P-PRSO,P-MATCHLEN >L
	ZERO? OPTR /?L13
	CALL BUT-MERGE,P-PRSO >P-PRSO
?L13:	ZERO? IPTR /TRUE
	ZERO? OPTR /?L18
	GET P-PRSO,P-MATCHLEN >STACK
	EQUAL? L,STACK \TRUE
?L18:	CALL BUT-MERGE,P-PRSI >P-PRSI
	RTRUE

	.FUNCT BUT-MERGE,TBL,LEN,BUTLEN,CNT=1,MATCHES=0,OBJ,NTBL
	GET TBL,P-MATCHLEN >LEN
	PUT P-MERGE,P-MATCHLEN,0
?L1:	DLESS? 'LEN,0 /?L2
	GET TBL,CNT >OBJ
	CALL ZMEMQ,OBJ,P-BUTS >STACK
	ZERO? STACK \?L6
	ADD MATCHES,1 >STACK
	PUT P-MERGE,STACK,OBJ
	INC 'MATCHES
?L6:	INC 'CNT
	JUMP ?L1
?L2:	PUT P-MERGE,P-MATCHLEN,MATCHES
	SET 'NTBL,P-MERGE
	SET 'P-MERGE,TBL
	RETURN NTBL

	.FUNCT SNARFEM,PTR,EPTR,TBL,BUT=0,LEN,WV,WRD,NW,WAS-ALL=0
	SET 'P-AND,0
	EQUAL? P-GETFLAGS,P-ALL \?L1
	SET 'WAS-ALL,1
?L1:	SET 'P-GETFLAGS,0
	PUT TBL,P-MATCHLEN,0
	GET PTR,0 >WRD
?L4:	EQUAL? PTR,EPTR \?L6
?L57:	ZERO? BUT /?L9
	PUSH BUT
	JUMP ?L8
?L9:	PUSH TBL
?L8:	CALL GET-OBJECT,STACK >WV
	ZERO? WAS-ALL /?L10
	SET 'P-GETFLAGS,P-ALL
?L10:	RETURN WV
?L6:	ADD PTR,P-WORDLEN >STACK
	EQUAL? EPTR,STACK \?L14
	SET 'NW,0
	JUMP ?L16
?L14:	GET PTR,P-LEXELEN >NW
?L16:	EQUAL? WRD,W?ALL \?L17
	SET 'P-GETFLAGS,P-ALL
	EQUAL? NW,W?OF \?L52
	ADD PTR,P-WORDLEN >PTR
	JUMP ?L52
?L17:	EQUAL? WRD,W?BUT,W?EXCEPT \?L22
	ZERO? BUT /?L26
	PUSH BUT
	JUMP ?L25
?L26:	PUSH TBL
?L25:	CALL GET-OBJECT,STACK >STACK
	ZERO? STACK /FALSE
	SET 'BUT,P-BUTS
	PUT BUT,P-MATCHLEN,0
	JUMP ?L52
?L22:	EQUAL? WRD,W?A,W?ONE \?L27
	ZERO? P-ADJ \?L28
	SET 'P-GETFLAGS,P-ONE
	EQUAL? NW,W?OF \?L52
	ADD PTR,P-WORDLEN >PTR
	JUMP ?L52
?L28:	SET 'P-NAM,P-ONEOBJ
	ZERO? BUT /?L37
	PUSH BUT
	JUMP ?L36
?L37:	PUSH TBL
?L36:	CALL GET-OBJECT,STACK >STACK
	ZERO? STACK /FALSE
	ZERO? NW /TRUE
	JUMP ?L52
?L27:	EQUAL? WRD,W?AND,W?$COMMA \?L40
	EQUAL? NW,W?AND,W?$COMMA /?L40
	SET 'P-AND,1
	ZERO? BUT /?L44
	PUSH BUT
	JUMP ?L43
?L44:	PUSH TBL
?L43:	CALL GET-OBJECT,STACK >STACK
	ZERO? STACK /FALSE
	JUMP ?L52
?L40:	CALL WT?,WRD,PS?BUZZ-WORD >STACK
	ZERO? STACK \?L52
	EQUAL? WRD,W?AND,W?$COMMA /?L52
	EQUAL? WRD,W?OF \?L47
	ZERO? P-GETFLAGS \?L52
	SET 'P-GETFLAGS,P-INHIBIT
	JUMP ?L52
?L47:	CALL WT?,WRD,PS?ADJECTIVE,P1?ADJECTIVE >WV
	ZERO? WV /?L51
	ZERO? P-ADJ \?L51
	SET 'P-ADJ,WV
	SET 'P-ADJN,WRD
	JUMP ?L52
?L51:	CALL WT?,WRD,PS?OBJECT,P1?OBJECT >STACK
	ZERO? STACK /?L52
	SET 'P-NAM,WRD
	SET 'P-ONEOBJ,WRD
?L52:	EQUAL? PTR,EPTR /?L57
	ADD PTR,P-WORDLEN >PTR
	SET 'WRD,NW
	JUMP ?L4

	.FUNCT GET-OBJECT,TBL,VRB=1,BITS,LEN,XBITS,TLEN,GCHECK=0,OLEN=0,OBJ
	SET 'XBITS,P-SLOCBITS
	GET TBL,P-MATCHLEN >TLEN
	BTST P-GETFLAGS,P-INHIBIT /TRUE
	ZERO? P-NAM \?L11
	ZERO? P-ADJ /?L8
	CALL WT?,P-ADJN,PS?OBJECT,P1?OBJECT >STACK
	ZERO? STACK /?L6
	SET 'P-NAM,P-ADJN
	SET 'P-ADJ,0
	JUMP ?L8
?L6:	CALL NULL-F >STACK
	ZERO? STACK /?L8
?L8:	ZERO? P-NAM \?L11
	ZERO? P-ADJ \?L11
	EQUAL? P-GETFLAGS,P-ALL /?L73
	ZERO? P-GWIMBIT \?L11
	ZERO? VRB /FALSE
	PRINTI "There seems to be a noun missing in that sentence!"
	CRLF
	RFALSE
?L11:	EQUAL? P-GETFLAGS,P-ALL \?L21
?L73:	ZERO? P-SLOCBITS \?L19
?L21:	SET 'P-SLOCBITS,-1
?L19:	SET 'P-TABLE,TBL
?L23:	ZERO? GCHECK /?L25
	CALL GLOBAL-CHECK,TBL
	JUMP ?L27
?L25:	ZERO? LIT /?L28
	FCLEAR PLAYER,TRANSBIT
	CALL DO-SL,HERE,SOG,SIR
	FSET PLAYER,TRANSBIT
?L28:	CALL DO-SL,PLAYER,SH,SC
?L27:	GET TBL,P-MATCHLEN >STACK
	SUB STACK,TLEN >LEN
	BTST P-GETFLAGS,P-ALL /?L45
	BTST P-GETFLAGS,P-ONE \?L33
	ZERO? LEN /?L33
	EQUAL? LEN,1 /?L34
	RANDOM LEN >STACK
	GET TBL,STACK >STACK
	PUT TBL,1,STACK
	PRINTI "(How about the "
	GET TBL,1 >STACK
	PRINTD STACK
	PRINTI "?)"
	CRLF
?L34:	PUT TBL,P-MATCHLEN,1
	JUMP ?L45
?L33:	GRTR? LEN,1 /?L42
	ZERO? LEN \?L71
	EQUAL? P-SLOCBITS,-1 /?L45
?L42:	EQUAL? P-SLOCBITS,-1 \?L43
	SET 'P-SLOCBITS,XBITS
	SET 'OLEN,LEN
	GET TBL,P-MATCHLEN >STACK
	SUB STACK,LEN >STACK
	PUT TBL,P-MATCHLEN,STACK
	JUMP ?L23
?L43:	ZERO? LEN \?L46
	SET 'LEN,OLEN
?L46:	EQUAL? WINNER,PLAYER /?L49
	CALL CANT-ORPHAN
	RFALSE
?L49:	ZERO? VRB /?L55
	ZERO? P-NAM /?L51
	CALL WHICH-PRINT,TLEN,LEN,TBL
	EQUAL? TBL,P-PRSO \?L52
	SET 'P-ACLAUSE,P-NC1
	JUMP ?L54
?L52:	SET 'P-ACLAUSE,P-NC2
?L54:	SET 'P-AADJ,P-ADJ
	SET 'P-ANAM,P-NAM
	CALL ORPHAN,0,0
	SET 'P-OFLAG,1
	JUMP ?L55
?L51:	ZERO? VRB /?L55
	PRINTI "There seems to be a noun missing in that sentence!"
	CRLF
?L55:	SET 'P-NAM,0
	SET 'P-ADJ,0
	RFALSE
?L45:	ZERO? LEN \?L71
	ZERO? GCHECK /?L60
	ZERO? VRB /?L67
	SET 'P-SLOCBITS,XBITS
	ZERO? LIT \?L66
	EQUAL? PRSA,V?TELL \?L64
?L66:	CALL OBJ-FOUND,NOT-HERE-OBJECT,TBL
	SET 'P-XNAM,P-NAM
	SET 'P-XADJ,P-ADJ
	SET 'P-XADJN,P-ADJN
	SET 'P-NAM,0
	SET 'P-ADJ,0
	SET 'P-ADJN,0
	RTRUE
?L64:	PRINTI "It's too dark to see!"
	CRLF
?L67:	SET 'P-NAM,0
	SET 'P-ADJ,0
	RFALSE
?L60:	ZERO? LEN \?L71
	SET 'GCHECK,1
	JUMP ?L23
?L71:	SET 'P-SLOCBITS,XBITS
	SET 'P-NAM,0
	SET 'P-ADJ,0
	RTRUE

	.FUNCT WHICH-PRINT,TLEN,LEN,TBL,OBJ,RLEN
	SET 'RLEN,LEN
	PRINTI "Which "
	ZERO? P-OFLAG \?L5
	ZERO? P-MERGED \?L5
	ZERO? P-AND /?L3
?L5:	ZERO? P-NAM /?L6
	PUSH P-NAM
	JUMP ?L9
?L6:	ZERO? P-ADJ /?L8
	PUSH P-ADJN
	JUMP ?L9
?L8:	PUSH W?ONE
?L9:	PRINTB STACK
	JUMP ?L10
?L3:	EQUAL? TBL,P-PRSO /?L11
	PUSH 0
	JUMP ?L12
?L11:	PUSH 1
?L12:	CALL THING-PRINT,STACK
?L10:	PRINTI " do you mean, "
?L15:	INC 'TLEN
	GET TBL,TLEN >OBJ
	PRINTI "the "
	PRINTD OBJ
	EQUAL? LEN,2 \?L19
	EQUAL? RLEN,2 /?L21
	PRINTI ","
?L21:	PRINTI " or "
	JUMP ?L28
?L19:	GRTR? LEN,2 \?L28
	PRINTI ", "
?L28:	DLESS? 'LEN,1 \?L15
	PRINTR "?"

	.FUNCT GLOBAL-CHECK,TBL,LEN,RMG,RMGL,CNT=0,OBJ,OBITS,FOO
	GET TBL,P-MATCHLEN >LEN
	SET 'OBITS,P-SLOCBITS
	GETPT HERE,P?GLOBAL >RMG
	ZERO? RMG /?L4
	PTSIZE RMG >STACK
	SUB STACK,1 >RMGL
?L3:	GETB RMG,CNT >OBJ
	CALL THIS-IT?,OBJ,TBL >STACK
	ZERO? STACK /?L5
	CALL OBJ-FOUND,OBJ,TBL
?L5:	IGRTR? 'CNT,RMGL \?L3
?L4:	GETPT HERE,P?PSEUDO >RMG
	ZERO? RMG /?L15
	PTSIZE RMG >STACK
	DIV STACK,4 >STACK
	SUB STACK,1 >RMGL
	SET 'CNT,0
?L14:	MUL CNT,2 >STACK
	GET RMG,STACK >STACK
	EQUAL? P-NAM,STACK \?L16
	MUL CNT,2 >STACK
	INC 'STACK
	GET RMG,STACK >STACK
	PUTP PSEUDO-OBJECT,P?ACTION,STACK
	GETPT PSEUDO-OBJECT,P?ACTION >STACK
	SUB STACK,5 >FOO
	GET P-NAM,0 >STACK
	PUT FOO,0,STACK
	GET P-NAM,1 >STACK
	PUT FOO,1,STACK
	CALL OBJ-FOUND,PSEUDO-OBJECT,TBL
	JUMP ?L15
?L16:	IGRTR? 'CNT,RMGL \?L14
?L15:	GET TBL,P-MATCHLEN >STACK
	EQUAL? STACK,LEN \FALSE
	SET 'P-SLOCBITS,-1
	SET 'P-TABLE,TBL
	CALL DO-SL,GLOBAL-OBJECTS,1,1
	SET 'P-SLOCBITS,OBITS
	GET TBL,P-MATCHLEN >STACK
	ZERO? STACK \FALSE
	EQUAL? PRSA,V?LOOK-INSIDE,V?SEARCH,V?EXAMINE \FALSE
	CALL DO-SL,ROOMS,1,1 >STACK
	RSTACK

	.FUNCT DO-SL,OBJ,BIT1,BIT2,BTS
	ADD BIT1,BIT2 >STACK
	BTST P-SLOCBITS,STACK \?L1
	CALL SEARCH-LIST,OBJ,P-TABLE,P-SRCALL >STACK
	RSTACK
?L1:	BTST P-SLOCBITS,BIT1 \?L4
	CALL SEARCH-LIST,OBJ,P-TABLE,P-SRCTOP >STACK
	RSTACK
?L4:	BTST P-SLOCBITS,BIT2 \TRUE
	CALL SEARCH-LIST,OBJ,P-TABLE,P-SRCBOT >STACK
	RSTACK

	.FUNCT SEARCH-LIST,OBJ,TBL,LVL,FLS,NOBJ
	FIRST? OBJ >OBJ \FALSE
?L3:	EQUAL? LVL,P-SRCBOT /?L5
	GETPT OBJ,P?SYNONYM >STACK
	ZERO? STACK /?L5
	CALL THIS-IT?,OBJ,TBL >STACK
	ZERO? STACK /?L5
	CALL OBJ-FOUND,OBJ,TBL
?L5:	EQUAL? LVL,P-SRCTOP \?L10
	FSET? OBJ,SEARCHBIT /?L10
	FSET? OBJ,SURFACEBIT \?L8
?L10:	FIRST? OBJ >NOBJ \?L8
	FSET? OBJ,OPENBIT /?L11
	FSET? OBJ,TRANSBIT \?L8
?L11:	FSET? OBJ,SURFACEBIT \?L12
	PUSH P-SRCALL
	JUMP ?L15
?L12:	FSET? OBJ,SEARCHBIT \?L14
	PUSH P-SRCALL
	JUMP ?L15
?L14:	PUSH P-SRCTOP
?L15:	CALL SEARCH-LIST,OBJ,TBL,STACK >FLS
?L8:	NEXT? OBJ >OBJ /?L3
	RTRUE

	.FUNCT OBJ-FOUND,OBJ,TBL,PTR
	GET TBL,P-MATCHLEN >PTR
	ADD PTR,1 >STACK
	PUT TBL,STACK,OBJ
	ADD PTR,1 >STACK
	PUT TBL,P-MATCHLEN,STACK
	RTRUE

	.FUNCT TAKE-CHECK
	GETB P-SYNTAX,P-SLOC1 >STACK
	CALL ITAKE-CHECK,P-PRSO,STACK >STACK
	ZERO? STACK /FALSE
	GETB P-SYNTAX,P-SLOC2 >STACK
	CALL ITAKE-CHECK,P-PRSI,STACK >STACK
	RSTACK

	.FUNCT ITAKE-CHECK,TBL,IBITS,PTR,OBJ,TAKEN
	GET TBL,P-MATCHLEN >PTR
	ZERO? PTR /TRUE
	BTST IBITS,SHAVE /?L3
	BTST IBITS,STAKE \TRUE
?L3:	DLESS? 'PTR,0 /TRUE
	ADD PTR,1 >STACK
	GET TBL,STACK >OBJ
	EQUAL? OBJ,IT \?L15
	CALL ACCESSIBLE?,P-IT-OBJECT >STACK
	ZERO? STACK \?L11
	PRINTI "I don't see what you're referring to."
	CRLF
	RFALSE
?L11:	SET 'OBJ,P-IT-OBJECT
?L15:	CALL HELD?,OBJ >STACK
	ZERO? STACK \?L3
	EQUAL? OBJ,HANDS,ME /?L3
	SET 'PRSO,OBJ
	FSET? OBJ,TRYTAKEBIT \?L19
	SET 'TAKEN,1
	JUMP ?L23
?L19:	EQUAL? WINNER,ADVENTURER /?L21
	SET 'TAKEN,0
	JUMP ?L23
?L21:	BTST IBITS,STAKE \?L22
	CALL ITAKE,0 >STACK
	EQUAL? STACK,1 \?L22
	SET 'TAKEN,0
	JUMP ?L23
?L22:	SET 'TAKEN,1
?L23:	ZERO? TAKEN /?L41
	BTST IBITS,SHAVE \?L24
	EQUAL? WINNER,ADVENTURER \?L24
	EQUAL? OBJ,NOT-HERE-OBJECT \?L26
	PRINTI "You don't have that!"
	CRLF
	RFALSE
?L26:	PRINTI "You don't have the "
	PRINTD OBJ
	PRINTI "."
	CRLF
	RFALSE
?L24:	ZERO? TAKEN \?L3
?L41:	EQUAL? WINNER,ADVENTURER \?L3
	PRINTI "(Taken)"
	CRLF
	JUMP ?L3

	.FUNCT MANY-CHECK,LOSS=0,TMP
	GET P-PRSO,P-MATCHLEN >STACK
	GRTR? STACK,1 \?L1
	GETB P-SYNTAX,P-SLOC1 >STACK
	BTST STACK,SMANY /?L1
	SET 'LOSS,1
	JUMP ?L3
?L1:	GET P-PRSI,P-MATCHLEN >STACK
	GRTR? STACK,1 \?L3
	GETB P-SYNTAX,P-SLOC2 >STACK
	BTST STACK,SMANY /?L3
	SET 'LOSS,2
?L3:	ZERO? LOSS /TRUE
	PRINTI "You can't use multiple "
	EQUAL? LOSS,2 \?L9
	PRINTI "in"
?L9:	PRINTI "direct objects with """
	GET P-ITBL,P-VERBN >TMP
	ZERO? TMP \?L16
	PRINTI "tell"
	JUMP ?L22
?L16:	ZERO? P-OFLAG \?L21
	ZERO? P-MERGED /?L20
?L21:	GET TMP,0 >STACK
	PRINTB STACK
	JUMP ?L22
?L20:	GETB TMP,3 >STACK
	GETB TMP,2 >STACK
	CALL WORD-PRINT,STACK,STACK
?L22:	PRINTI """."
	CRLF
	RFALSE

	.FUNCT ZMEMQ,ITM,TBL,SIZE=-1,CNT=1
	ZERO? TBL /FALSE
	LESS? SIZE,0 /?L4
	SET 'CNT,0
	JUMP ?L6
?L4:	GET TBL,0 >SIZE
?L6:	GET TBL,CNT >STACK
	EQUAL? ITM,STACK \?L9
	MUL CNT,2 >STACK
	ADD TBL,STACK >STACK
	RSTACK
?L9:	IGRTR? 'CNT,SIZE \?L6
	RFALSE

	.FUNCT ZMEMQB,ITM,TBL,SIZE,CNT=0
?L1:	GETB TBL,CNT >STACK
	EQUAL? ITM,STACK /TRUE
	IGRTR? 'CNT,SIZE \?L1
	RFALSE

	.FUNCT LIT?,RM,RMBIT=1,OHERE,LIT?1=0
	ZERO? ALWAYS-LIT /?L1
	EQUAL? WINNER,PLAYER /TRUE
?L1:	SET 'P-GWIMBIT,ONBIT
	SET 'OHERE,HERE
	SET 'HERE,RM
	ZERO? RMBIT /?L4
	FSET? RM,ONBIT \?L4
	SET 'LIT?1,1
	JUMP ?L13
?L4:	PUT P-MERGE,P-MATCHLEN,0
	SET 'P-TABLE,P-MERGE
	SET 'P-SLOCBITS,-1
	EQUAL? OHERE,RM \?L9
	CALL DO-SL,WINNER,1,1
	EQUAL? WINNER,PLAYER /?L9
	IN? PLAYER,RM \?L9
	CALL DO-SL,PLAYER,1,1
?L9:	CALL DO-SL,RM,1,1
	GET P-TABLE,P-MATCHLEN >STACK
	GRTR? STACK,0 \?L13
	SET 'LIT?1,1
?L13:	SET 'HERE,OHERE
	SET 'P-GWIMBIT,0
	RETURN LIT?1

	.FUNCT THIS-IT?,OBJ,TBL,SYNS
	FSET? OBJ,INVISIBLE /FALSE
	ZERO? P-NAM /?L3
	GETPT OBJ,P?SYNONYM >SYNS
	PTSIZE SYNS >STACK
	DIV STACK,2 >STACK
	DEC 'STACK
	CALL ZMEMQ,P-NAM,SYNS,STACK >STACK
	ZERO? STACK /FALSE
?L3:	ZERO? P-ADJ /?L4
	GETPT OBJ,P?ADJECTIVE >SYNS
	ZERO? SYNS /FALSE
	PTSIZE SYNS >STACK
	DEC 'STACK
	CALL ZMEMQB,P-ADJ,SYNS,STACK >STACK
	ZERO? STACK /FALSE
?L4:	ZERO? P-GWIMBIT /TRUE
	FSET? OBJ,P-GWIMBIT /TRUE
	RFALSE

	.FUNCT ACCESSIBLE?,OBJ,L,?TMP
	LOC OBJ >L
	FSET? OBJ,INVISIBLE /FALSE
	ZERO? L /FALSE
	EQUAL? L,GLOBAL-OBJECTS /TRUE
	EQUAL? L,LOCAL-GLOBALS \?L5
	CALL GLOBAL-IN?,OBJ,HERE >STACK
	ZERO? STACK \TRUE
?L5:	CALL META-LOC,OBJ >?TMP
	LOC WINNER >STACK
	EQUAL? ?TMP,HERE,STACK \FALSE
	LOC WINNER >STACK
	EQUAL? L,WINNER,HERE,STACK /TRUE
	FSET? L,OPENBIT \FALSE
	CALL ACCESSIBLE?,L >STACK
	ZERO? STACK /FALSE
	RTRUE

	.FUNCT META-LOC,OBJ
?L1:	ZERO? OBJ /FALSE
	IN? OBJ,GLOBAL-OBJECTS \?L5
	RETURN GLOBAL-OBJECTS
?L5:	IN? OBJ,ROOMS \?L7
	RETURN OBJ
?L7:	LOC OBJ >OBJ
	JUMP ?L1

	.FUNCT ZPROB,BASE
	ZERO? LUCKY /?L1
	RANDOM 100 >STACK
	GRTR? BASE,STACK /TRUE
	RFALSE
?L1:	RANDOM 300 >STACK
	GRTR? BASE,STACK \FALSE
	RTRUE

	.FUNCT RANDOM-ELEMENT,FROB
	GET FROB,0 >STACK
	RANDOM STACK >STACK
	GET FROB,STACK >STACK
	RSTACK

	.FUNCT PICK-ONE,FROB,L,CNT,RND,MSG,RFROB
	GET FROB,0 >L
	GET FROB,1 >CNT
	DEC 'L
	ADD FROB,2 >FROB
	MUL CNT,2 >STACK
	ADD FROB,STACK >RFROB
	SUB L,CNT >STACK
	RANDOM STACK >RND
	GET RFROB,RND >MSG
	GET RFROB,1 >STACK
	PUT RFROB,RND,STACK
	PUT RFROB,1,MSG
	INC 'CNT
	EQUAL? CNT,L \?L1
	SET 'CNT,0
?L1:	PUT FROB,0,CNT
	RETURN MSG

	.FUNCT V-VERBOSE
	SET 'VERBOSE,1
	SET 'SUPER-BRIEF,0
	PRINTR "Maximum verbosity."

	.FUNCT V-BRIEF
	SET 'VERBOSE,0
	SET 'SUPER-BRIEF,0
	PRINTR "Brief descriptions."

	.FUNCT V-SUPER-BRIEF
	SET 'SUPER-BRIEF,1
	PRINTR "Superbrief descriptions."

	.FUNCT V-INVENTORY
	FIRST? WINNER >STACK \?L1
	CALL PRINT-CONT,WINNER >STACK
	RSTACK
?L1:	PRINTR "You are empty-handed."

	.FUNCT FINISH,WRD
	CALL V-SCORE
?L1:	CRLF
	PRINTI "[EVENT: GAME OVER]Would you like to restart the game from the beginning, restore a saved game position, or end this session of the game?
(Type RESTART, RESTORE, or QUIT):
>"
	READ P-INBUF,P-LEXV
	GET P-LEXV,1 >WRD
	EQUAL? WRD,W?RESTART \?L5
	RESTART
?L5:	EQUAL? WRD,W?RESTORE \?L9
	RESTORE \?L10
	PRINTI "Ok."
	CRLF
	JUMP ?L1
?L10:	PRINTI "Failed."
	CRLF
	JUMP ?L1
?L9:	EQUAL? WRD,W?QUIT,W?Q \?L1
	QUIT

	.FUNCT V-QUIT,SCOR
	CALL V-SCORE
	PRINTI "Do you wish to leave the game? (Y is affirmative): "
	CALL YES? >STACK
	ZERO? STACK /?L3
	QUIT
?L3:	PRINTR "Ok."

	.FUNCT V-RESTART
	CALL V-SCORE,1
	PRINTI "Do you wish to restart? (Y is affirmative): "
	CALL YES? >STACK
	ZERO? STACK /FALSE
	PRINTI "Restarting."
	CRLF
	RESTART

	.FUNCT V-RESTORE
	RESTORE \?L1
	PRINTI "Ok."
	CRLF
	CALL V-FIRST-LOOK >STACK
	RSTACK
?L1:	PRINTR "Failed."

	.FUNCT V-SAVE
	SAVE \?L1
	PRINTR "Ok."
?L1:	PRINTR "Failed."

	.FUNCT V-SCRIPT
	GET 0,8 >STACK
	BOR STACK,1 >STACK
	PUT 0,8,STACK
	PRINTI "Here begins a transcript of interaction with"
	CRLF
	CALL V-VERSION
	RTRUE

	.FUNCT V-UNSCRIPT
	PRINTI "Here ends a transcript of interaction with"
	CRLF
	CALL V-VERSION
	GET 0,8 >STACK
	BAND STACK,-2 >STACK
	PUT 0,8,STACK
	RTRUE

	.FUNCT V-VERSION,CNT=17
	PRINTI "ZORK I: The Great Underground Empire
Infocom interactive fiction - a fantasy story
Copyright (c) 1981, 1982, 1983, 1984, 1985, 1986"
	PRINTI " Infocom, Inc. All rights reserved."
	CRLF
	PRINTI "ZORK is a registered trademark of Infocom, Inc.
Release "
	GET 0,1 >STACK
	BAND STACK,2047 >STACK
	PRINTN STACK
	PRINTI " / Serial number "
?L9:	IGRTR? 'CNT,23 /?L10
	GETB 0,CNT >STACK
	PRINTC STACK
	JUMP ?L9
?L10:	CRLF
	RTRUE

	.FUNCT V-VERIFY
	PRINTI "Verifying disk..."
	CRLF
	VERIFY \?L3
	PRINTR "The disk is correct."
?L3:	CRLF
	PRINTR "** Disk Failure **"

	.FUNCT V-COMMAND-FILE
	DIRIN 1
	RTRUE

	.FUNCT V-RANDOM
	EQUAL? PRSO,INTNUM /?L1
	PRINTR "Illegal call to #RND."
?L1:	SUB 0,P-NUMBER >STACK
	RANDOM STACK >STACK
	RTRUE

	.FUNCT V-RECORD
	DIROUT 4
	RTRUE

	.FUNCT V-UNRECORD
	DIROUT -4
	RTRUE

	.FUNCT V-ADVENT
	PRINTR "A hollow voice says ""Fool."""

	.FUNCT V-ALARM
	FSET? PRSO,ACTORBIT \?L1
	GETP PRSO,P?STRENGTH >STACK
	LESS? STACK,0 \?L3
	PRINTI "The "
	PRINTD PRSO
	PRINTI " is rudely awakened."
	CRLF
	CALL AWAKEN,PRSO >STACK
	RSTACK
?L3:	PRINTR "He's wide awake, or haven't you noticed..."
?L1:	PRINTI "The "
	PRINTD PRSO
	PRINTR " isn't sleeping."

	.FUNCT V-ANSWER
	PRINTI "Nobody seems to be awaiting your answer."
	CRLF
	SET 'P-CONT,0
	SET 'QUOTE-FLAG,0
	RTRUE

	.FUNCT V-ATTACK
	FSET? PRSO,ACTORBIT /?L1
	PRINTI "I've known strange people, but fighting a "
	PRINTD PRSO
	PRINTI "?"
	CRLF
	CALL IS-OBJECT-OR-PROPERTY? >STACK
	CALL PRINT-ID,STR?2,STACK
	CALL IS-ANIMAL? >STACK
	CALL PRINT-ID,STR?3,STACK >STACK
	RSTACK
?L1:	ZERO? PRSI /?L6
	EQUAL? PRSI,HANDS \?L5
?L6:	PRINTI "Trying to attack a "
	PRINTD PRSO
	PRINTI " with your bare hands is suicidal."
	CRLF
	CALL PRINT-ID,STR?4 >STACK
	RSTACK
?L5:	IN? PRSI,WINNER /?L9
	PRINTI "You aren't even holding the "
	PRINTD PRSI
	PRINTI "."
	CRLF
	CALL PRINT-ID,STR?5 >STACK
	RSTACK
?L9:	FSET? PRSI,WEAPONBIT /?L12
	PRINTI "Trying to attack the "
	PRINTD PRSO
	PRINTI " with a "
	PRINTD PRSI
	PRINTI " is suicidal."
	CRLF
	CALL PRINT-ID,STR?6 >STACK
	RSTACK
?L12:	CALL HERO-BLOW >STACK
	RSTACK

	.FUNCT V-BACK
	PRINTR "Sorry, my memory is poor. Please give a direction."

	.FUNCT V-BLAST
	PRINTI "You can't blast anything by using words."
	CRLF
	CALL BOMB?,PRSI >STACK
	ZERO? STACK \?L4
	PUSH 0
	JUMP ?L3
?L4:	CALL IS-PERSON? >STACK
?L3:	CALL PRINT-ID,STR?7,STACK
	CALL BOMB?,PRSI >STACK
	ZERO? STACK \?L6
	PUSH 0
	JUMP ?L5
?L6:	CALL IS-OBJ-PROP-ANIMAL? >STACK
?L5:	CALL PRINT-ID,STR?8,STACK
	CALL BOMB?,PRSI >STACK
	ZERO? STACK \?L8
	PUSH 0
	JUMP ?L7
?L8:	CALL IS-SELF? >STACK
?L7:	CALL PRINT-ID,STR?9,STACK >STACK
	RSTACK

	.FUNCT PRE-BOARD,AV
	LOC WINNER >AV
	CALL NULL-F >STACK
	ZERO? STACK \TRUE
	FSET? PRSO,VEHBIT \?L3
	IN? PRSO,HERE /?L4
	PRINTI "The "
	PRINTD PRSO
	PRINTI " must be on the ground to be boarded."
	CRLF
	RETURN 2
?L4:	FSET? AV,VEHBIT \FALSE
	PRINTI "You are already in the "
	PRINTD AV
	PRINTI "!"
	CRLF
	RETURN 2
?L3:	EQUAL? PRSO,WATER,GLOBAL-WATER \?L12
	CALL PERFORM,V?SWIM,PRSO
	RTRUE
?L12:	PRINTI "You have a theory on how to board a "
	PRINTD PRSO
	PRINTI ", perhaps?"
	CRLF
	RETURN 2

	.FUNCT V-BOARD,AV
	PRINTI "You are now in the "
	PRINTD PRSO
	PRINTI "."
	CRLF
	MOVE WINNER,PRSO
	GETP PRSO,P?ACTION >STACK
	CALL STACK,M-ENTER >STACK
	RTRUE

	.FUNCT V-BREATHE
	CALL PERFORM,V?INFLATE,PRSO,LUNGS >STACK
	RSTACK

	.FUNCT V-BRUSH
	PRINTI "If you wish, but heaven only knows why."
	CRLF
	CALL IS-OBJECT-OR-PROPERTY? >STACK
	CALL PRINT-ID,STR?10,STACK >STACK
	RSTACK

	.FUNCT V-BUG
	PRINTR "Bug? Not in a flawless program like this! (Cough, cough)."

	.FUNCT TELL-NO-PRSI
	PRINTR "You didn't say with what!"

	.FUNCT PRE-BURN
	ZERO? PRSI \?L1
	CALL TELL-NO-PRSI
	CALL IS-PERSON? >STACK
	CALL PRINT-ID,STR?11,STACK
	CALL IS-OBJ-PROP-ANIMAL? >STACK
	CALL PRINT-ID,STR?12,STACK
	CALL IS-PART-OF-SELF-OR-SELF? >STACK
	CALL PRINT-ID,STR?13,STACK >STACK
	RSTACK
?L1:	FSET? PRSI,FLAMEBIT \?L3
	FSET? PRSI,ONBIT /FALSE
?L3:	PRINTI "With a "
	PRINTD PRSI
	PRINTI "??!?"
	CRLF
	CALL IS-PERSON? >STACK
	CALL PRINT-ID,STR?14,STACK
	CALL IS-OBJ-PROP-ANIMAL? >STACK
	CALL PRINT-ID,STR?15,STACK
	CALL IS-PART-OF-SELF-OR-SELF? >STACK
	CALL PRINT-ID,STR?16,STACK >STACK
	RSTACK

	.FUNCT V-BURN
	CALL NULL-F >STACK
	ZERO? STACK \FALSE
	FSET? PRSO,BURNBIT \?L3
	IN? PRSO,WINNER /?L6
	IN? WINNER,PRSO \?L4
?L6:	CALL REMOVE-CAREFULLY,PRSO
	PRINTI "The "
	PRINTD PRSO
	PRINTI " catches fire. Unfortunately, you were "
	IN? WINNER,PRSO \?L11
	PRINTI "in"
	JUMP ?L15
?L11:	PRINTI "holding"
	CALL PRINT-ID,STR?17
?L15:	CALL JIGS-UP,STR?18 >STACK
	RSTACK
?L4:	CALL REMOVE-CAREFULLY,PRSO
	PRINTI "The "
	PRINTD PRSO
	PRINTI " catches fire and is consumed."
	CRLF
	CALL PRINT-ID,STR?19 >STACK
	RSTACK
?L3:	PRINTI "You can't burn a "
	PRINTD PRSO
	PRINTI "."
	CRLF
	CALL IS-PERSON? >STACK
	CALL PRINT-ID,STR?20,STACK
	CALL IS-OBJ-PROP-ANIMAL? >STACK
	CALL PRINT-ID,STR?21,STACK
	CALL IS-PART-OF-SELF-OR-SELF? >STACK
	CALL PRINT-ID,STR?22,STACK >STACK
	RSTACK

	.FUNCT V-CHOMP
	PRINTR "Preposterous!"

	.FUNCT V-CLIMB-DOWN
	CALL V-CLIMB-UP,P?DOWN,PRSO >STACK
	RSTACK

	.FUNCT V-CLIMB-FOO
	CALL V-CLIMB-UP,P?UP,PRSO >STACK
	RSTACK

	.FUNCT V-CLIMB-ON
	FSET? PRSO,VEHBIT \?L1
	CALL PERFORM,V?BOARD,PRSO
	RTRUE
?L1:	PRINTI "You can't climb onto the "
	PRINTD PRSO
	PRINTR "."

	.FUNCT V-CLIMB-UP,DIR=P?UP,OBJ=0,X,TX
	ZERO? OBJ /?L1
	EQUAL? PRSO,ROOMS /?L1
	SET 'OBJ,PRSO
?L1:	GETPT HERE,DIR >TX
	ZERO? TX /?L4
	ZERO? OBJ /?L8
	PTSIZE TX >X
	EQUAL? X,NEXIT /?L10
	EQUAL? X,CEXIT,DEXIT,UEXIT \?L8
	GETB TX,0 >STACK
	CALL GLOBAL-IN?,PRSO,STACK >STACK
	ZERO? STACK \?L8
?L10:	PRINTI "The "
	PRINTD OBJ
	PRINTI " do"
	EQUAL? OBJ,STAIRS /?L13
	PRINTI "es"
?L13:	PRINTI "n't lead "
	EQUAL? DIR,P?UP \?L20
	PRINTI "up"
	JUMP ?L24
?L20:	PRINTI "down"
?L24:	PRINTR "ward."
?L8:	CALL DO-WALK,DIR
	RTRUE
?L4:	ZERO? OBJ /?L31
	GETPT PRSO,P?SYNONYM >X
	PTSIZE X >STACK
	CALL ZMEMQ,W?WALL,X,STACK >STACK
	ZERO? STACK /?L31
	PRINTR "Climbing the walls is to no avail."
?L31:	EQUAL? HERE,PATH /?L34
	EQUAL? OBJ,0,TREE \?L34
	CALL GLOBAL-IN?,TREE,HERE >STACK
	ZERO? STACK /?L34
	PRINTR "There are no climbable trees here."
?L34:	EQUAL? OBJ,0,ROOMS \?L37
	PRINTR "You can't go that way."
?L37:	PRINTR "You can't do that!"

	.FUNCT V-CLOSE
	FSET? PRSO,CONTBIT /?L1
	FSET? PRSO,DOORBIT /?L1
	PRINTI "You must tell me how to do that to a "
	PRINTD PRSO
	PRINTR "."
?L1:	FSET? PRSO,SURFACEBIT /?L5
	GETP PRSO,P?CAPACITY >STACK
	ZERO? STACK /?L5
	FSET? PRSO,OPENBIT \?L6
	FCLEAR PRSO,OPENBIT
	PRINTI "Closed."
	CRLF
	ZERO? LIT /TRUE
	CALL LIT?,HERE >LIT
	ZERO? LIT \TRUE
	PRINTR "It is now pitch black."
?L6:	PRINTR "It is already closed."
?L5:	FSET? PRSO,DOORBIT \?L18
	FSET? PRSO,OPENBIT \?L19
	FCLEAR PRSO,OPENBIT
	PRINTI "The "
	PRINTD PRSO
	PRINTR " is now closed."
?L19:	PRINTR "It is already closed."
?L18:	PRINTR "You cannot close that."

	.FUNCT V-COMMAND
	FSET? PRSO,ACTORBIT \?L1
	PRINTI "The "
	PRINTD PRSO
	PRINTR " pays no attention."
?L1:	PRINTR "You cannot talk to that!"

	.FUNCT V-COUNT
	EQUAL? PRSO,BLESSINGS \?L1
	PRINTR "Well, for one, you are playing Zork..."
?L1:	PRINTR "You have lost your mind."

	.FUNCT V-CROSS
	PRINTR "You can't cross that!"

	.FUNCT V-CURSES
	ZERO? PRSO /?L1
	FSET? PRSO,ACTORBIT \?L3
	PRINTI "Insults of this nature won't help you."
	CRLF
	CALL PRINT-ID,STR?23
	CALL PRINT-ID,STR?24 >STACK
	RSTACK
?L3:	PRINTI "What a loony!"
	CRLF
	CALL PRINT-ID,STR?25 >STACK
	RSTACK
?L1:	PRINTI "Such language in a high-class establishment like this!"
	CRLF
	CALL PRINT-ID,STR?26 >STACK
	RSTACK

	.FUNCT V-CUT
	FSET? PRSO,ACTORBIT \?L1
	CALL PERFORM,V?ATTACK,PRSO,PRSI >STACK
	RSTACK
?L1:	FSET? PRSO,BURNBIT \?L3
	FSET? PRSI,WEAPONBIT \?L12
	IN? WINNER,PRSO \?L4
	PRINTI "Not a bright idea, especially since you're in it."
	CRLF
	CALL PRINT-ID,STR?27
	RTRUE
?L4:	CALL REMOVE-CAREFULLY,PRSO
	PRINTI "Your skillful "
	PRINTD PRSI
	PRINTI "smanship slices the "
	PRINTD PRSO
	PRINTI " into innumerable slivers which blow away."
	CRLF
	CALL PRINT-ID,STR?28 >STACK
	RSTACK
?L3:	FSET? PRSI,WEAPONBIT /?L11
?L12:	PRINTI "The ""cutting edge"" of a "
	PRINTD PRSI
	PRINTI " is hardly adequate."
	CRLF
	CALL PRINT-ID,STR?29 >STACK
	RSTACK
?L11:	PRINTI "Strange concept, cutting the "
	PRINTD PRSO
	PRINTI "...."
	CRLF
	CALL PRINT-ID,STR?30 >STACK
	RSTACK

	.FUNCT V-DEFLATE
	PRINTR "Come on, now!"

	.FUNCT V-DIG
	ZERO? PRSI \?L1
	SET 'PRSI,HANDS
?L1:	EQUAL? PRSI,SHOVEL \?L4
	PRINTR "There's no reason to be digging here."
?L4:	FSET? PRSI,TOOLBIT \?L9
	PRINTI "Digging with the "
	PRINTD PRSI
	PRINTR " is slow and tedious."
?L9:	PRINTI "Digging with a "
	PRINTD PRSI
	PRINTR " is silly."

	.FUNCT V-DISEMBARK
	EQUAL? PRSO,ROOMS \?L1
	LOC WINNER >STACK
	FSET? STACK,VEHBIT \?L1
	LOC WINNER >STACK
	CALL PERFORM,V?DISEMBARK,STACK
	RTRUE
?L1:	LOC WINNER >STACK
	EQUAL? STACK,PRSO /?L3
	PRINTI "You're not in that!"
	CRLF
	RETURN 2
?L3:	FSET? HERE,RLANDBIT \?L8
	PRINTI "You are on your own feet again."
	CRLF
	MOVE WINNER,HERE
	RTRUE
?L8:	PRINTI "You realize that getting out here would be fatal."
	CRLF
	RETURN 2

	.FUNCT V-DISENCHANT
	PRINTR "Nothing happens."

	.FUNCT V-DRINK
	CALL V-EAT >STACK
	RSTACK

	.FUNCT V-DRINK-FROM
	PRINTR "How peculiar!"

	.FUNCT PRE-DROP
	LOC WINNER >STACK
	EQUAL? PRSO,STACK \FALSE
	CALL PERFORM,V?DISEMBARK,PRSO
	RTRUE

	.FUNCT V-DROP
	CALL IDROP >STACK
	ZERO? STACK /FALSE
	PRINTR "Dropped."

	.FUNCT V-EAT,EAT?=0,DRINK?=0,NOBJ=0,?TMP
	FSET? PRSO,FOODBIT /?L3
	SET 'EAT?,0
	JUMP ?L1
?L3:	SET 'EAT?,1
	IN? PRSO,WINNER /?L5
	LOC PRSO >STACK
	IN? STACK,WINNER /?L5
	PRINTI "You're not holding that."
	CRLF
	CRLF
	RTRUE
?L5:	EQUAL? PRSA,V?DRINK \?L9
	PRINTR "How can you drink that?"
?L9:	PRINTI "Thank you very much. It really hit the spot."
	CALL REMOVE-CAREFULLY,PRSO
	CRLF
	RTRUE
?L1:	FSET? PRSO,DRINKBIT \?L15
	SET 'DRINK?,1
	LOC PRSO >NOBJ
	IN? PRSO,GLOBAL-OBJECTS /?L18
	CALL GLOBAL-IN?,GLOBAL-WATER,HERE >STACK
	ZERO? STACK \?L18
	EQUAL? PRSO,PSEUDO-OBJECT \?L16
?L18:	CALL HIT-SPOT >STACK
	RSTACK
?L16:	ZERO? NOBJ /?L20
	CALL ACCESSIBLE?,NOBJ >STACK
	ZERO? STACK \?L19
?L20:	PRINTR "There isn't any water here."
?L19:	CALL ACCESSIBLE?,NOBJ >STACK
	ZERO? STACK /?L23
	IN? NOBJ,WINNER /?L23
	PRINTI "You have to be holding the "
	PRINTD NOBJ
	PRINTR " first."
?L23:	FSET? NOBJ,OPENBIT /?L26
	PRINTI "You'll have to open the "
	PRINTD NOBJ
	PRINTR " first."
?L26:	CALL HIT-SPOT >STACK
	RSTACK
?L15:	ZERO? EAT? \FALSE
	ZERO? DRINK? \FALSE
	PRINTI "I don't think that the "
	PRINTD PRSO
	PRINTI " would agree with you."
	CRLF
	CALL DANGEROUS-FOOD? >?TMP
	ZERO? ?TMP /?L34
	PUSH ?TMP
	JUMP ?L33
?L34:	CALL DANGEROUS-DRINK? >STACK
?L33:	CALL PRINT-ID,STR?31,STACK >STACK
	RSTACK

	.FUNCT HIT-SPOT
	EQUAL? PRSO,WATER \?L1
	CALL GLOBAL-IN?,GLOBAL-WATER,HERE >STACK
	ZERO? STACK \?L1
	CALL REMOVE-CAREFULLY,PRSO
?L1:	PRINTR "Thank you very much. I was rather thirsty (from all this talking, probably)."

	.FUNCT V-ECHO,LST,MAX,ECH=0,CNT
	GETB P-LEXV,P-LEXWORDS >STACK
	GRTR? STACK,0 \?L1
	GETB P-LEXV,P-LEXWORDS >STACK
	MUL STACK,P-WORDLEN >STACK
	ADD P-LEXV,STACK >LST
	GETB LST,1 >STACK
	GETB LST,0 >STACK
	ADD STACK,STACK >STACK
	SUB STACK,1 >MAX
?L3:	IGRTR? 'ECH,2 \?L5
	PRINTR "..."
?L5:	GETB LST,1 >STACK
	SUB STACK,1 >CNT
?L10:	IGRTR? 'CNT,MAX /?L11
	GETB P-INBUF,CNT >STACK
	PRINTC STACK
	JUMP ?L10
?L11:	PRINTI " "
	JUMP ?L3
?L1:	PRINTR "echo echo ..."

	.FUNCT V-ENCHANT
	CALL NULL-F
	CALL V-DISENCHANT >STACK
	RSTACK

	.FUNCT REMOVE-CAREFULLY,OBJ,OLIT
	EQUAL? OBJ,P-IT-OBJECT \?L1
	SET 'P-IT-OBJECT,0
?L1:	SET 'OLIT,LIT
	REMOVE OBJ
	CALL LIT?,HERE >LIT
	EQUAL? OLIT,0,LIT /TRUE
	PRINTR "You are left in the dark..."

	.FUNCT V-ENTER
	CALL DO-WALK,P?IN >STACK
	RSTACK

	.FUNCT V-EXAMINE
	GETP PRSO,P?TEXT >STACK
	ZERO? STACK /?L1
	GETP PRSO,P?TEXT >STACK
	PRINT STACK
	CRLF
	RTRUE
?L1:	FSET? PRSO,CONTBIT /?L6
	FSET? PRSO,DOORBIT \?L5
?L6:	CALL V-LOOK-INSIDE >STACK
	RSTACK
?L5:	PRINTI "There's nothing special about the "
	PRINTD PRSO
	PRINTR "."

	.FUNCT V-EXIT
	EQUAL? PRSO,0,ROOMS \?L1
	LOC WINNER >STACK
	FSET? STACK,VEHBIT \?L1
	LOC WINNER >STACK
	CALL PERFORM,V?DISEMBARK,STACK
	RTRUE
?L1:	ZERO? PRSO /?L3
	IN? WINNER,PRSO \?L3
	CALL PERFORM,V?DISEMBARK,PRSO
	RTRUE
?L3:	CALL DO-WALK,P?OUT >STACK
	RSTACK

	.FUNCT V-EXORCISE
	PRINTR "What a bizarre concept!"

	.FUNCT PRE-FILL,TX
	ZERO? PRSI \?L6
	GETPT HERE,P?GLOBAL >TX
	ZERO? TX /?L3
	PTSIZE TX >STACK
	DEC 'STACK
	CALL ZMEMQB,GLOBAL-WATER,TX,STACK >STACK
	ZERO? STACK /?L3
	CALL PERFORM,V?FILL,PRSO,GLOBAL-WATER
	RTRUE
?L3:	LOC WINNER >STACK
	IN? WATER,STACK \?L5
	CALL PERFORM,V?FILL,PRSO,WATER
	RTRUE
?L5:	PRINTR "There is nothing to fill it with."
?L6:	EQUAL? PRSI,WATER,GLOBAL-WATER /FALSE
	CALL PERFORM,V?PUT,PRSI,PRSO
	RTRUE

	.FUNCT V-FILL
	ZERO? PRSI \?L1
	CALL GLOBAL-IN?,GLOBAL-WATER,HERE >STACK
	ZERO? STACK /?L3
	CALL PERFORM,V?FILL,PRSO,GLOBAL-WATER
	RTRUE
?L3:	LOC WINNER >STACK
	IN? WATER,STACK \?L5
	CALL PERFORM,V?FILL,PRSO,WATER
	RTRUE
?L5:	PRINTR "There's nothing to fill it with."
?L1:	PRINTR "You may know how to do that, but I don't."

	.FUNCT V-FIND,L
	LOC PRSO >L
	EQUAL? PRSO,HANDS,LUNGS \?L1
	PRINTR "Within six feet of your head, assuming you haven't left that somewhere."
?L1:	EQUAL? PRSO,ME \?L5
	PRINTR "You're around here somewhere..."
?L5:	EQUAL? L,GLOBAL-OBJECTS \?L8
	PRINTR "You find it."
?L8:	IN? PRSO,WINNER \?L11
	PRINTR "You have it."
?L11:	IN? PRSO,HERE /?L15
	CALL GLOBAL-IN?,PRSO,HERE >STACK
	ZERO? STACK \?L15
	EQUAL? PRSO,PSEUDO-OBJECT \?L14
?L15:	PRINTR "It's right here."
?L14:	FSET? L,ACTORBIT \?L18
	PRINTI "The "
	PRINTD L
	PRINTR " has it."
?L18:	FSET? L,SURFACEBIT \?L21
	PRINTI "It's on the "
	PRINTD L
	PRINTR "."
?L21:	FSET? L,CONTBIT \?L24
	PRINTI "It's in the "
	PRINTD L
	PRINTR "."
?L24:	PRINTR "Beats me."

	.FUNCT V-FOLLOW
	PRINTR "You're nuts!"

	.FUNCT V-FROBOZZ
	PRINTR "The FROBOZZ Corporation created, owns, and operates this dungeon."

	.FUNCT PRE-GIVE
	CALL HELD?,PRSO >STACK
	ZERO? STACK \FALSE
	PRINTI "That's easy for you to say since you don't even have the "
	PRINTD PRSO
	PRINTR "."

	.FUNCT V-GIVE
	FSET? PRSI,ACTORBIT /?L1
	PRINTI "You can't give a "
	PRINTD PRSO
	PRINTI " to a "
	PRINTD PRSI
	PRINTR "!"
?L1:	PRINTI "The "
	PRINTD PRSI
	PRINTR " refuses it politely."

	.FUNCT V-HATCH
	PRINTR "Bizarre!"

	.FUNCT V-HELLO
	ZERO? PRSO /?L1
	FSET? PRSO,ACTORBIT \?L3
	PRINTI "The "
	PRINTD PRSO
	PRINTR " bows his head to you in greeting."
?L3:	PRINTI "It's a well known fact that only schizophrenics say ""Hello"" to a "
	PRINTD PRSO
	PRINTR "."
?L1:	CALL PICK-ONE,HELLOS >STACK
	PRINT STACK
	CRLF
	RTRUE

	.FUNCT V-INCANT
	PRINTI "The incantation echoes back faintly, but nothing else happens."
	CRLF
	SET 'QUOTE-FLAG,0
	SET 'P-CONT,0
	RTRUE

	.FUNCT V-INFLATE
	PRINTR "How can you inflate that?"

	.FUNCT V-KICK,?TMP
	CALL IS-PERSON? >?TMP
	ZERO? ?TMP /?L2
	PUSH ?TMP
	JUMP ?L1
?L2:	CALL IS-OBJ-PROP-ANIMAL? >STACK
?L1:	CALL PRINT-ID,STR?32,STACK
	CALL IS-PART-OF-SELF-OR-SELF? >STACK
	CALL PRINT-ID,STR?33,STACK
	CALL HACK-HACK,STR?34 >STACK
	RSTACK

	.FUNCT V-KISS
	PRINTI "I'd sooner kiss a pig."
	CRLF
	CALL IS-PERSON? >STACK
	CALL PRINT-ID,STR?35,STACK >STACK
	RSTACK

	.FUNCT V-KNOCK
	FSET? PRSO,DOORBIT \?L1
	PRINTR "Nobody's home."
?L1:	PRINTI "Why knock on a "
	PRINTD PRSO
	PRINTR "?"

	.FUNCT V-LAMP-OFF
	FSET? PRSO,LIGHTBIT \?L1
	FSET? PRSO,ONBIT /?L3
	PRINTR "It is already off."
?L3:	FCLEAR PRSO,ONBIT
	ZERO? LIT /?L8
	CALL LIT?,HERE >LIT
?L8:	PRINTI "The "
	PRINTD PRSO
	PRINTI " is now off."
	CRLF
	ZERO? LIT \TRUE
	PRINTR "It is now pitch black."
?L1:	PRINTR "You can't turn that off."

	.FUNCT V-LAMP-ON
	FSET? PRSO,LIGHTBIT \?L1
	FSET? PRSO,ONBIT \?L3
	PRINTR "It is already on."
?L3:	FSET PRSO,ONBIT
	PRINTI "The "
	PRINTD PRSO
	PRINTI " is now on."
	CRLF
	ZERO? LIT \TRUE
	CALL LIT?,HERE >LIT
	CRLF
	CALL V-LOOK
	RTRUE
?L1:	FSET? PRSO,BURNBIT \?L13
	PRINTI "If you wish to burn the "
	PRINTD PRSO
	PRINTI ", you should say so."
	CRLF
	CALL IS-OBJECT-OR-PROPERTY? >STACK
	CALL PRINT-ID,STR?36,STACK
	RTRUE
?L13:	PRINTR "You can't turn that on."

	.FUNCT V-LAUNCH
	FSET? PRSO,VEHBIT \?L1
	PRINTR "You can't launch that by saying ""launch""!"
?L1:	PRINTR "That's pretty weird."

	.FUNCT V-LEAN-ON
	PRINTR "Getting tired?"

	.FUNCT V-LEAP,TX,S
	ZERO? PRSO /?L1
	IN? PRSO,HERE \?L3
	FSET? PRSO,ACTORBIT \?L5
	PRINTI "The "
	PRINTD PRSO
	PRINTR " is too big to jump over."
?L5:	CALL V-SKIP >STACK
	RSTACK
?L3:	PRINTR "That would be a good trick."
?L1:	GETPT HERE,P?DOWN >TX
	ZERO? TX /?L13
	PTSIZE TX >S
	EQUAL? S,2 /?L16
	EQUAL? S,4 \?L14
	GETB TX,1 >STACK
	VALUE STACK >STACK
	ZERO? STACK \?L14
?L16:	PRINTI "This was not a very safe place to try jumping."
	CRLF
	CALL PRINT-ID,STR?37
	CALL PICK-ONE,JUMPLOSS >STACK
	CALL JIGS-UP,STACK >STACK
	RSTACK
?L14:	EQUAL? HERE,UP-A-TREE \?L19
	PRINTI "In a feat of unaccustomed daring, you manage to land on your feet without killing yourself."
	CRLF
	CRLF
	CALL DO-WALK,P?DOWN
	RTRUE
?L19:	CALL V-SKIP >STACK
	RSTACK
?L13:	CALL V-SKIP >STACK
	RSTACK

	.FUNCT V-LEAVE
	CALL DO-WALK,P?OUT >STACK
	RSTACK

	.FUNCT V-LISTEN
	PRINTI "The "
	PRINTD PRSO
	PRINTR " makes no sound."

	.FUNCT V-LOCK
	PRINTR "It doesn't seem to work."

	.FUNCT V-LOOK
	CALL DESCRIBE-ROOM,1 >STACK
	ZERO? STACK /FALSE
	CALL DESCRIBE-OBJECTS,1 >STACK
	RSTACK

	.FUNCT V-LOOK-BEHIND
	PRINTI "There is nothing behind the "
	PRINTD PRSO
	PRINTR "."

	.FUNCT V-LOOK-INSIDE
	FSET? PRSO,DOORBIT \?L1
	FSET? PRSO,OPENBIT \?L3
	PRINTI "The "
	PRINTD PRSO
	PRINTR " is open, but I can't tell what's beyond it."
?L3:	PRINTI "The "
	PRINTD PRSO
	PRINTR " is closed."
?L1:	FSET? PRSO,CONTBIT \?L10
	FSET? PRSO,ACTORBIT \?L11
	PRINTR "There is nothing special to be seen."
?L11:	CALL SEE-INSIDE?,PRSO >STACK
	ZERO? STACK /?L15
	FIRST? PRSO >STACK \?L16
	CALL PRINT-CONT,PRSO >STACK
	ZERO? STACK \TRUE
?L16:	CALL NULL-F >STACK
	ZERO? STACK \TRUE
	PRINTI "The "
	PRINTD PRSO
	PRINTR " is empty."
?L15:	PRINTI "The "
	PRINTD PRSO
	PRINTR " is closed."
?L10:	PRINTI "You can't look inside a "
	PRINTD PRSO
	PRINTR "."

	.FUNCT V-LOOK-ON
	FSET? PRSO,SURFACEBIT \?L1
	CALL PERFORM,V?LOOK-INSIDE,PRSO
	RTRUE
?L1:	PRINTI "Look on a "
	PRINTD PRSO
	PRINTR "???"

	.FUNCT V-LOOK-UNDER
	PRINTR "There is nothing but dust there."

	.FUNCT V-LOWER
	CALL HACK-HACK,STR?38 >STACK
	RSTACK

	.FUNCT V-MAKE
	PRINTR "You can't do that."

	.FUNCT V-MELT
	PRINTI "It's not clear that a "
	PRINTD PRSO
	PRINTI " can be melted."
	CRLF
	CALL IS-PERSON? >STACK
	CALL PRINT-ID,STR?39,STACK
	CALL IS-OBJ-PROP-ANIMAL? >STACK
	CALL PRINT-ID,STR?40,STACK
	CALL IS-PART-OF-SELF-OR-SELF? >STACK
	CALL PRINT-ID,STR?41,STACK >STACK
	RSTACK

	.FUNCT PRE-MOVE
	CALL HELD?,PRSO >STACK
	ZERO? STACK /FALSE
	PRINTR "You aren't an accomplished enough juggler."

	.FUNCT V-MOVE
	FSET? PRSO,TAKEBIT \?L1
	PRINTI "Moving the "
	PRINTD PRSO
	PRINTR " reveals nothing."
?L1:	PRINTI "You can't move the "
	PRINTD PRSO
	PRINTR "."

	.FUNCT V-MUMBLE
	PRINTR "You'll have to speak up if you expect me to hear you!"

	.FUNCT PRE-MUNG
	CALL NULL-F >STACK
	ZERO? STACK \TRUE
	ZERO? PRSI /?L4
	FSET? PRSI,WEAPONBIT /FALSE
?L4:	PRINTI "Trying to destroy the "
	PRINTD PRSO
	PRINTI " with "
	CALL IS-PERSON? >STACK
	CALL PRINT-ID,STR?42,STACK
	CALL IS-OBJ-PROP-ANIMAL? >STACK
	CALL PRINT-ID,STR?43,STACK
	CALL IS-PART-OF-SELF-OR-SELF? >STACK
	CALL PRINT-ID,STR?44,STACK
	ZERO? PRSI \?L7
	PRINTI "your bare hands"
	JUMP ?L11
?L7:	PRINTI "a "
	PRINTD PRSI
?L11:	PRINTR " is futile."

	.FUNCT V-MUNG
	FSET? PRSO,ACTORBIT \?L1
	CALL PERFORM,V?ATTACK,PRSO,PRSI
	RTRUE
?L1:	PRINTI "Nice try."
	CRLF
	CALL IS-OBJECT-OR-PROPERTY? >STACK
	CALL PRINT-ID,STR?45,STACK >STACK
	RSTACK

	.FUNCT V-ODYSSEUS
	EQUAL? HERE,CYCLOPS-ROOM \?L1
	IN? CYCLOPS,HERE \?L1
	ZERO? CYCLOPS-FLAG \?L1
	CALL INT,I-CYCLOPS >STACK
	PUT STACK,0,0
	SET 'CYCLOPS-FLAG,1
	PRINTI "The cyclops, hearing the name of his father's deadly nemesis, flees the room by knocking down the wall on the east of the room."
	CRLF
	SET 'MAGIC-FLAG,1
	FCLEAR CYCLOPS,FIGHTBIT
	CALL REMOVE-CAREFULLY,CYCLOPS >STACK
	RSTACK
?L1:	PRINTR "Wasn't he a sailor?"

	.FUNCT V-OIL
	PRINTR "You probably put spinach in your gas tank, too."

	.FUNCT V-OPEN,F,STR
	FSET? PRSO,CONTBIT \?L1
	GETP PRSO,P?CAPACITY >STACK
	ZERO? STACK /?L1
	FSET? PRSO,OPENBIT \?L3
	PRINTR "It is already open."
?L3:	FSET PRSO,OPENBIT
	FSET PRSO,TOUCHBIT
	FIRST? PRSO >STACK \?L10
	FSET? PRSO,TRANSBIT \?L8
?L10:	PRINTR "Opened."
?L8:	FIRST? PRSO >F \?L13
	NEXT? F >STACK /?L13
	FSET? F,TOUCHBIT /?L13
	GETP F,P?FDESC >STR
	ZERO? STR /?L13
	PRINTI "The "
	PRINTD PRSO
	PRINTI " opens."
	CRLF
	PRINT STR
	CRLF
	RTRUE
?L13:	PRINTI "Opening the "
	PRINTD PRSO
	PRINTI " reveals "
	CALL PRINT-CONTENTS,PRSO
	PRINTR "."
?L1:	FSET? PRSO,DOORBIT \?L23
	FSET? PRSO,OPENBIT \?L24
	PRINTR "It is already open."
?L24:	PRINTI "The "
	PRINTD PRSO
	PRINTI " opens."
	CRLF
	FSET PRSO,OPENBIT
	RTRUE
?L23:	PRINTI "You must tell me how to do that to a "
	PRINTD PRSO
	PRINTR "."

	.FUNCT V-OVERBOARD,LOCN
	EQUAL? PRSI,TEETH \?L1
	LOC WINNER >LOCN
	FSET? LOCN,VEHBIT \?L3
	LOC LOCN >STACK
	MOVE PRSO,STACK
	PRINTI "Ahoy -- "
	PRINTD PRSO
	PRINTR " overboard!"
?L3:	PRINTR "You're not in anything!"
?L1:	LOC WINNER >STACK
	FSET? STACK,VEHBIT \?L10
	CALL PERFORM,V?THROW,PRSO
	RTRUE
?L10:	PRINTR "Huh?"

	.FUNCT V-PICK
	PRINTI "You can't pick that."
	CRLF
	CALL IS-BAD-TO-PICK? >STACK
	CALL PRINT-ID,STR?46,STACK >STACK
	RSTACK

	.FUNCT V-PLAY
	FSET? PRSO,ACTORBIT \?L1
	PRINTI "You become so engrossed in the role of the "
	PRINTD PRSO
	PRINTI " that you kill yourself, just as he might have done!"
	CRLF
	CALL PRINT-ID,STR?47
	CALL JIGS-UP,STR?48 >STACK
	RSTACK
?L1:	PRINTR "That's silly!"

	.FUNCT V-PLUG
	PRINTR "This has no effect."

	.FUNCT V-POUR-ON
	EQUAL? PRSO,WATER \?L1
	CALL REMOVE-CAREFULLY,PRSO
	FSET? PRSI,FLAMEBIT \?L3
	FSET? PRSI,ONBIT \?L3
	PRINTI "The "
	PRINTD PRSI
	PRINTI " is extinguished."
	CRLF
	CALL NULL-F
	FCLEAR PRSI,ONBIT
	FCLEAR PRSI,FLAMEBIT
	RTRUE
?L3:	PRINTI "The water spills over the "
	PRINTD PRSI
	PRINTR ", to the floor, and evaporates."
?L1:	EQUAL? PRSO,PUTTY \?L10
	CALL PERFORM,V?PUT,PUTTY,PRSI >STACK
	RSTACK
?L10:	PRINTR "You can't pour that."

	.FUNCT V-PRAY
	EQUAL? HERE,SOUTH-TEMPLE \?L1
	CALL GOTO,FOREST-1 >STACK
	RSTACK
?L1:	PRINTR "If you pray enough, your prayers may be answered."

	.FUNCT V-PUMP
	EQUAL? PRSI,0,PUMP /?L1
	PRINTI "Pump it up with a "
	PRINTD PRSI
	PRINTR "?"
?L1:	IN? PUMP,WINNER \?L5
	CALL PERFORM,V?INFLATE,PRSO,PUMP >STACK
	RSTACK
?L5:	PRINTR "It's really not clear how."

	.FUNCT V-PUSH
	CALL HACK-HACK,STR?49 >STACK
	RSTACK

	.FUNCT V-PUSH-TO
	PRINTR "You can't push things to that."

	.FUNCT PRE-PUT
	CALL NULL-F >STACK
	ZERO? STACK \FALSE
	CALL PRE-GIVE >STACK
	RSTACK

	.FUNCT V-PUT,?TMP
	FSET? PRSI,OPENBIT /?L7
	FSET? PRSI,DOORBIT /?L4
	FSET? PRSI,CONTBIT /?L4
	FSET? PRSI,VEHBIT /?L4
	PRINTR "You can't do that."
?L4:	FSET? PRSI,OPENBIT /?L7
	PRINTI "The "
	PRINTD PRSI
	PRINTI " isn't open."
	CRLF
	CALL THIS-IS-IT,PRSI >STACK
	RSTACK
?L7:	EQUAL? PRSI,PRSO \?L11
	PRINTR "How can you do that?"
?L11:	IN? PRSO,PRSI \?L14
	PRINTI "The "
	PRINTD PRSO
	PRINTI " is already in the "
	PRINTD PRSI
	PRINTR "."
?L14:	CALL WEIGHT,PRSI >?TMP
	CALL WEIGHT,PRSO >STACK
	ADD ?TMP,STACK >?TMP
	GETP PRSI,P?SIZE >STACK
	SUB ?TMP,STACK >?TMP
	GETP PRSI,P?CAPACITY >STACK
	GRTR? ?TMP,STACK \?L17
	PRINTR "There's no room."
?L17:	CALL HELD?,PRSO >STACK
	ZERO? STACK \?L20
	FSET? PRSO,TRYTAKEBIT \?L20
	PRINTI "You don't have the "
	PRINTD PRSO
	PRINTR "."
?L20:	CALL HELD?,PRSO >STACK
	ZERO? STACK \?L23
	CALL ITAKE >STACK
	ZERO? STACK /TRUE
?L23:	MOVE PRSO,PRSI
	FSET PRSO,TOUCHBIT
	CALL SCORE-OBJ,PRSO
	PRINTR "Done."

	.FUNCT V-PUT-BEHIND
	PRINTR "That hiding place is too obvious."

	.FUNCT V-PUT-ON
	EQUAL? PRSI,GROUND \?L1
	CALL PERFORM,V?DROP,PRSO
	RTRUE
?L1:	FSET? PRSI,SURFACEBIT \?L3
	CALL V-PUT >STACK
	RSTACK
?L3:	PRINTI "There's no good surface on the "
	PRINTD PRSI
	PRINTR "."

	.FUNCT V-PUT-UNDER
	PRINTR "You can't do that."

	.FUNCT V-RAISE
	CALL V-LOWER >STACK
	RSTACK

	.FUNCT V-RAPE
	PRINTI "What a (ahem!) strange idea."
	CRLF
	CALL IS-PERSON? >STACK
	CALL PRINT-ID,STR?50,STACK
	CALL IS-ANIMAL? >STACK
	CALL PRINT-ID,STR?51,STACK >STACK
	RSTACK

	.FUNCT PRE-READ
	ZERO? LIT \?L1
	PRINTR "It is impossible to read in the dark."
?L1:	ZERO? PRSI /FALSE
	FSET? PRSI,TRANSBIT /FALSE
	PRINTI "How does one look through a "
	PRINTD PRSI
	PRINTR "?"

	.FUNCT V-READ
	FSET? PRSO,READBIT /?L1
	PRINTI "How does one read a "
	PRINTD PRSO
	PRINTR "?"
?L1:	GETP PRSO,P?TEXT >STACK
	PRINT STACK
	CRLF
	RTRUE

	.FUNCT V-READ-PAGE
	CALL PERFORM,V?READ,PRSO
	RTRUE

	.FUNCT V-REPENT
	PRINTR "It could very well be too late!"

	.FUNCT V-REPLY
	PRINTI "It is hardly likely that the "
	PRINTD PRSO
	PRINTI " is interested."
	CRLF
	SET 'P-CONT,0
	SET 'QUOTE-FLAG,0
	RTRUE

	.FUNCT V-RING
	PRINTR "How, exactly, can you ring that?"

	.FUNCT V-RUB
	CALL IS-PERSON? >STACK
	CALL PRINT-ID,STR?52,STACK
	CALL HACK-HACK,STR?53 >STACK
	RSTACK

	.FUNCT V-SAY,V
	ZERO? P-CONT \?L1
	PRINTR "Say what?"
?L1:	SET 'QUOTE-FLAG,0
	CALL FIND-IN,HERE,ACTORBIT >V
	ZERO? V /?L6
	PRINTI "You must address the "
	PRINTD V
	PRINTI " directly."
	CRLF
	SET 'P-CONT,0
	RTRUE
?L6:	GET P-LEXV,P-CONT >STACK
	EQUAL? STACK,W?HELLO /TRUE
	SET 'P-CONT,0
	PRINTR "Talking to yourself is a sign of impending mental collapse."

	.FUNCT V-SEARCH
	PRINTR "You find nothing unusual."

	.FUNCT V-SEND
	FSET? PRSO,ACTORBIT \?L1
	PRINTI "Why would you send for the "
	PRINTD PRSO
	PRINTR "?"
?L1:	PRINTR "That doesn't make sends."

	.FUNCT PRE-SGIVE
	CALL PERFORM,V?GIVE,PRSI,PRSO
	RTRUE

	.FUNCT V-SGIVE
	PRINTR "Foo!"

	.FUNCT V-SHAKE
	FSET? PRSO,ACTORBIT \?L1
	PRINTR "This seems to have no effect."
?L1:	FSET? PRSO,TAKEBIT /?L5
	PRINTR "You can't take it; thus, you can't shake it!"
?L5:	FSET? PRSO,CONTBIT \?L8
	FSET? PRSO,OPENBIT \?L9
	FIRST? PRSO >STACK \?L11
	CALL SHAKE-LOOP
	PRINTI "The contents of the "
	PRINTD PRSO
	PRINTI " spill "
	FSET? HERE,RLANDBIT /?L15
	PRINTI "out and disappear"
	JUMP ?L19
?L15:	PRINTI "to the ground"
?L19:	PRINTR "."
?L11:	PRINTR "Shaken."
?L9:	FIRST? PRSO >STACK \?L28
	PRINTI "It sounds like there is something inside the "
	PRINTD PRSO
	PRINTR "."
?L28:	PRINTI "The "
	PRINTD PRSO
	PRINTR " sounds empty."
?L8:	PRINTR "Shaken."

	.FUNCT SHAKE-LOOP,X
?L1:	FIRST? PRSO >X \TRUE
	FSET X,TOUCHBIT
	EQUAL? HERE,UP-A-TREE \?L5
	PUSH PATH
	JUMP ?L8
?L5:	FSET? HERE,RLANDBIT /?L7
	PUSH PSEUDO-OBJECT
	JUMP ?L8
?L7:	PUSH HERE
?L8:	MOVE X,STACK
	JUMP ?L1

	.FUNCT V-SKIP
	CALL PICK-ONE,WHEEEEE >STACK
	PRINT STACK
	CRLF
	RTRUE

	.FUNCT V-SMELL
	PRINTI "It smells like a "
	PRINTD PRSO
	PRINTR "."

	.FUNCT V-SPIN
	PRINTR "You can't spin that!"

	.FUNCT V-SPRAY
	CALL V-SQUEEZE >STACK
	RSTACK

	.FUNCT V-SQUEEZE
	FSET? PRSO,ACTORBIT \?L1
	PRINTI "The "
	PRINTD PRSO
	PRINTR " does not understand this."
?L1:	PRINTR "How singularly useless."

	.FUNCT V-SSPRAY
	CALL PERFORM,V?SPRAY,PRSI,PRSO >STACK
	RSTACK

	.FUNCT V-STAB,W
	CALL FIND-WEAPON,WINNER >W
	ZERO? W /?L1
	CALL PERFORM,V?ATTACK,PRSO,W
	RTRUE
?L1:	PRINTI "No doubt you propose to stab the "
	PRINTD PRSO
	PRINTI " with your pinky?"
	CRLF
	CALL IS-PERSON? >STACK
	CALL PRINT-ID,STR?54,STACK
	CALL IS-OBJ-PROP-ANIMAL? >STACK
	CALL PRINT-ID,STR?55,STACK
	CALL IS-PART-OF-SELF-OR-SELF? >STACK
	CALL PRINT-ID,STR?56,STACK >STACK
	RSTACK

	.FUNCT V-STAND
	LOC WINNER >STACK
	FSET? STACK,VEHBIT \?L1
	LOC WINNER >STACK
	CALL PERFORM,V?DISEMBARK,STACK
	RTRUE
?L1:	PRINTR "You are already standing, I think."

	.FUNCT V-STAY
	PRINTR "You will be lost without me!"

	.FUNCT V-STRIKE
	FSET? PRSO,ACTORBIT \?L1
	PRINTI "Since you aren't versed in hand-to-hand combat, you'd better attack the "
	PRINTD PRSO
	PRINTI " with a weapon."
	CRLF
	CALL PRINT-ID,STR?57 >STACK
	RSTACK
?L1:	CALL PERFORM,V?LAMP-ON,PRSO
	RTRUE

	.FUNCT V-SWIM
	CALL GLOBAL-IN?,GLOBAL-WATER,HERE >STACK
	ZERO? STACK /?L1
	PRINTI "Swimming isn't usually allowed in the "
	EQUAL? PRSO,WATER,GLOBAL-WATER /?L5
	PRINTD PRSO
	PRINTR "."
?L5:	PRINTR "dungeon."
?L1:	CALL NULL-F >STACK
	ZERO? STACK \FALSE
	PRINTR "Go jump in a lake!"

	.FUNCT V-SWING
	ZERO? PRSI \?L1
	PRINTR "Whoosh!"
?L1:	CALL PERFORM,V?ATTACK,PRSI,PRSO >STACK
	RSTACK

	.FUNCT PRE-TAKE
	IN? PRSO,WINNER \?L1
	FSET? PRSO,WEARBIT \?L3
	PRINTR "You are already wearing it."
?L3:	PRINTR "You already have that!"
?L1:	LOC PRSO >STACK
	FSET? STACK,CONTBIT \?L10
	LOC PRSO >STACK
	FSET? STACK,OPENBIT /?L10
	PRINTR "You can't reach something that's inside a closed container."
?L10:	ZERO? PRSI /?L13
	EQUAL? PRSI,GROUND \?L14
	SET 'PRSI,0
	RFALSE
?L14:	CALL NULL-F
	LOC PRSO >STACK
	EQUAL? PRSI,STACK /?L17
	PRINTI "The "
	PRINTD PRSO
	PRINTI " isn't in the "
	PRINTD PRSI
	PRINTR "."
?L17:	SET 'PRSI,0
	RFALSE
?L13:	LOC WINNER >STACK
	EQUAL? PRSO,STACK \FALSE
	PRINTR "You're inside of it!"

	.FUNCT V-TAKE
	CALL ITAKE >STACK
	EQUAL? STACK,1 \FALSE
	FSET? PRSO,WEARBIT \?L3
	PRINTI "You are now wearing the "
	PRINTD PRSO
	PRINTR "."
?L3:	PRINTI "Taken."
	CRLF
	CALL IS-THEFT? >STACK
	CALL PRINT-ID,STR?58,STACK >STACK
	RSTACK

	.FUNCT V-TELL
	FSET? PRSO,ACTORBIT \?L1
	ZERO? P-CONT /?L3
	SET 'WINNER,PRSO
	LOC WINNER >HERE
	RETURN HERE
?L3:	PRINTI "The "
	PRINTD PRSO
	PRINTR " pauses for a moment, perhaps thinking that you should reread the manual."
?L1:	PRINTI "You can't talk to the "
	PRINTD PRSO
	PRINTI "!"
	CRLF
	SET 'QUOTE-FLAG,0
	SET 'P-CONT,0
	RETURN 2

	.FUNCT V-THROUGH,OBJ=0,M
	FSET? PRSO,DOORBIT \?L1
	CALL OTHER-SIDE,PRSO >M
	ZERO? M /?L1
	CALL DO-WALK,M
	RTRUE
?L1:	ZERO? OBJ \?L5
	FSET? PRSO,VEHBIT \?L3
	CALL PERFORM,V?BOARD,PRSO
	RTRUE
?L3:	ZERO? OBJ \?L5
	FSET? PRSO,TAKEBIT /?L4
?L5:	CALL NULL-F
	PRINTI "You hit your head against the "
	PRINTD PRSO
	PRINTI " as you attempt this feat."
	CRLF
	CALL IS-OBJECT-OR-PROPERTY? >STACK
	CALL PRINT-ID,STR?59,STACK >STACK
	RSTACK
?L4:	IN? PRSO,WINNER \?L8
	PRINTR "That would involve quite a contortion!"
?L8:	CALL PICK-ONE,YUKS >STACK
	PRINT STACK
	CRLF
	RTRUE

	.FUNCT V-THROW
	CALL IDROP >STACK
	ZERO? STACK /?L1
	EQUAL? PRSI,ME \?L3
	PRINTI "A terrific throw! The "
	PRINTD PRSO
	SET 'WINNER,PLAYER
	CALL PRINT-ID,STR?60
	CALL JIGS-UP,STR?61 >STACK
	RSTACK
?L3:	ZERO? PRSI /?L7
	FSET? PRSI,ACTORBIT \?L7
	PRINTI "The "
	PRINTD PRSI
	PRINTI " ducks as the "
	PRINTD PRSO
	PRINTI " flies by and crashes to the ground."
	CRLF
	FSET? PRSO,WEAPONBIT /?L10
	PUSH 0
	JUMP ?L11
?L10:	PUSH 1
?L11:	CALL PRINT-ID,STR?62,STACK >STACK
	RSTACK
?L7:	PRINTR "Thrown."
?L1:	PRINTR "Huh?"

	.FUNCT V-THROW-OFF
	PRINTR "You can't throw anything off of that!"

	.FUNCT V-TIE
	EQUAL? PRSI,WINNER \?L1
	PRINTR "You can't tie anything to yourself."
?L1:	PRINTI "You can't tie the "
	PRINTD PRSO
	PRINTI " to that."
	CRLF
	CALL IS-PERSON? >STACK
	CALL PRINT-ID,STR?63,STACK >STACK
	RSTACK

	.FUNCT V-TIE-UP
	PRINTI "You could certainly never tie it with that!"
	CRLF
	CALL IS-PERSON? >STACK
	CALL PRINT-ID,STR?64,STACK >STACK
	RSTACK

	.FUNCT V-TREASURE
	EQUAL? HERE,NORTH-TEMPLE \?L1
	CALL GOTO,TREASURE-ROOM >STACK
	RSTACK
?L1:	EQUAL? HERE,TREASURE-ROOM \?L3
	CALL GOTO,NORTH-TEMPLE >STACK
	RSTACK
?L3:	PRINTR "Nothing happens."

	.FUNCT PRE-TURN
	EQUAL? PRSI,0,ROOMS \?L1
	EQUAL? PRSO,BOOK /?L1
	PRINTR "Your bare hands don't appear to be enough."
?L1:	FSET? PRSO,TURNBIT /FALSE
	PRINTR "You can't turn that!"

	.FUNCT V-TURN
	PRINTR "This has no effect."

	.FUNCT V-UNLOCK
	CALL V-LOCK >STACK
	RSTACK

	.FUNCT V-UNTIE
	PRINTR "This cannot be tied, so it cannot be untied!"

	.FUNCT V-WAIT,NUM=3
	PRINTI "Time passes..."
	CRLF
?L3:	DLESS? 'NUM,0 /?L4
	CALL CLOCKER >STACK
	ZERO? STACK /?L3
?L4:	SET 'CLOCK-WAIT,1
	RETURN CLOCK-WAIT

	.FUNCT V-WALK,PT,PTS,STR,OBJ,RM
	ZERO? P-WALK-DIR \?L1
	CALL PERFORM,V?WALK-TO,PRSO
	RTRUE
?L1:	GETPT HERE,PRSO >PT
	ZERO? PT /?L3
	PTSIZE PT >PTS
	EQUAL? PTS,UEXIT \?L4
	GETB PT,REXIT >STACK
	CALL GOTO,STACK >STACK
	RSTACK
?L4:	EQUAL? PTS,NEXIT \?L6
	GET PT,NEXITSTR >STACK
	PRINT STACK
	CRLF
	RETURN 2
?L6:	EQUAL? PTS,FEXIT \?L11
	GET PT,FEXITFCN >STACK
	CALL STACK >RM
	ZERO? RM /?L12
	CALL GOTO,RM >STACK
	RSTACK
?L12:	CALL NULL-F >STACK
	ZERO? STACK \FALSE
	RETURN 2
?L11:	EQUAL? PTS,CEXIT \?L18
	GETB PT,CEXITFLAG >STACK
	VALUE STACK >STACK
	ZERO? STACK /?L19
	GETB PT,REXIT >STACK
	CALL GOTO,STACK >STACK
	RSTACK
?L19:	GET PT,CEXITSTR >STR
	ZERO? STR /?L21
	PRINT STR
	CRLF
	RETURN 2
?L21:	PRINTI "You can't go that way."
	CRLF
	RETURN 2
?L18:	EQUAL? PTS,DEXIT \FALSE
	GETB PT,DEXITOBJ >OBJ
	FSET? OBJ,OPENBIT \?L32
	GETB PT,REXIT >STACK
	CALL GOTO,STACK >STACK
	RSTACK
?L32:	GET PT,DEXITSTR >STR
	ZERO? STR /?L34
	PRINT STR
	CRLF
	RETURN 2
?L34:	PRINTI "The "
	PRINTD OBJ
	PRINTI " is closed."
	CRLF
	CALL THIS-IS-IT,OBJ
	RETURN 2
?L3:	ZERO? LIT \?L45
	RANDOM 100 >STACK
	GRTR? 80,STACK \?L45
	EQUAL? WINNER,ADVENTURER \?L45
	FSET? HERE,NONLANDBIT /?L45
	ZERO? SPRAYED? /?L46
	PRINTI "There are odd noises in the darkness, and there is no exit in that direction."
	CRLF
	RETURN 2
?L46:	CALL NULL-F >STACK
	ZERO? STACK \FALSE
	CALL JIGS-UP,STR?65 >STACK
	RSTACK
?L45:	PRINTI "You can't go that way."
	CRLF
	RETURN 2

	.FUNCT V-WALK-AROUND
	PRINTR "Use compass directions for movement."

	.FUNCT V-WALK-TO
	ZERO? PRSO /?L1
	IN? PRSO,HERE /?L3
	CALL GLOBAL-IN?,PRSO,HERE >STACK
	ZERO? STACK /?L1
?L3:	PRINTR "It's here!"
?L1:	PRINTR "You should supply a direction!"

	.FUNCT V-WAVE
	CALL HACK-HACK,STR?66 >STACK
	RSTACK

	.FUNCT V-WEAR
	FSET? PRSO,WEARBIT /?L1
	PRINTI "You can't wear the "
	PRINTD PRSO
	PRINTR "."
?L1:	CALL PERFORM,V?TAKE,PRSO
	RTRUE

	.FUNCT V-WIN
	PRINTR "Naturally!"

	.FUNCT V-WIND
	PRINTI "You cannot wind up a "
	PRINTD PRSO
	PRINTR "."

	.FUNCT V-WISH
	PRINTR "With luck, your wish will come true."

	.FUNCT V-YELL
	PRINTI "Aaaarrrrgggghhhh!"
	CRLF
	CALL PRINT-ID,STR?67 >STACK
	RSTACK

	.FUNCT V-ZORK
	PRINTR "At your service!"

	.FUNCT V-FIRST-LOOK
	CALL DESCRIBE-ROOM >STACK
	ZERO? STACK /FALSE
	ZERO? SUPER-BRIEF \FALSE
	CALL DESCRIBE-OBJECTS >STACK
	RSTACK

	.FUNCT DESCRIBE-ROOM,LOOK?=0,V?,STR,AV
	SET 'V?,LOOK?
	ZERO? V? \?L1
	SET 'V?,VERBOSE
?L1:	ZERO? LIT \?L3
	PRINTI "It is pitch black."
	ZERO? SPRAYED? \?L7
	PRINTI " You are likely to be eaten by a grue."
?L7:	CRLF
	CALL NULL-F
	RFALSE
?L3:	FSET? HERE,TOUCHBIT /?L13
	FSET HERE,TOUCHBIT
	SET 'V?,1
?L13:	FSET? HERE,MAZEBIT \?L16
	FCLEAR HERE,TOUCHBIT
?L16:	IN? HERE,ROOMS \?L19
	PRINTD HERE
	LOC WINNER >AV
	FSET? AV,VEHBIT \?L23
	PRINTI ", in the "
	PRINTD AV
?L23:	CRLF
?L19:	ZERO? LOOK? \?L31
	ZERO? SUPER-BRIEF \TRUE
?L31:	LOC WINNER >AV
	ZERO? V? /?L34
	GETP HERE,P?ACTION >STACK
	CALL STACK,M-LOOK >STACK
	ZERO? STACK \TRUE
	ZERO? V? /?L34
	GETP HERE,P?LDESC >STR
	ZERO? STR /?L34
	PRINT STR
	CRLF
	JUMP ?L37
?L34:	GETP HERE,P?ACTION >STACK
	CALL STACK,M-FLASH >STACK
?L37:	EQUAL? HERE,AV /TRUE
	FSET? AV,VEHBIT \TRUE
	GETP AV,P?ACTION >STACK
	CALL STACK,M-LOOK >STACK
	RTRUE

	.FUNCT DESCRIBE-OBJECTS,V?=0
	ZERO? LIT /?L1
	FIRST? HERE >STACK \FALSE
	ZERO? V? \?L5
	SET 'V?,VERBOSE
?L5:	CALL PRINT-CONT,HERE,V?,-1 >STACK
	RSTACK
?L1:	PRINTR "Only bats can see in the dark. And you're not one."

	.FUNCT DESCRIBE-OBJECT,OBJ,V?,LEVEL,STR=0,AV
	SET 'DESC-OBJECT,OBJ
	ZERO? LEVEL \?L8
	GETP OBJ,P?DESCFCN >STACK
	CALL STACK,M-OBJDESC >STACK
	ZERO? STACK \TRUE
	ZERO? LEVEL \?L8
	FSET? OBJ,TOUCHBIT /?L5
	GETP OBJ,P?FDESC >STR
	ZERO? STR \?L4
?L5:	GETP OBJ,P?LDESC >STR
	ZERO? STR /?L3
?L4:	PRINT STR
	JUMP ?L27
?L3:	ZERO? LEVEL \?L8
	PRINTI "There is a "
	PRINTD OBJ
	PRINTI " here"
	FSET? OBJ,ONBIT \?L11
	PRINTI " (providing light)"
?L11:	PRINTI "."
	JUMP ?L27
?L8:	GET INDENTS,LEVEL >STACK
	PRINT STACK
	PRINTI "A "
	PRINTD OBJ
	FSET? OBJ,ONBIT \?L23
	PRINTI " (providing light)"
	JUMP ?L27
?L23:	FSET? OBJ,WEARBIT \?L27
	IN? OBJ,WINNER \?L27
	PRINTI " (being worn)"
?L27:	CALL NULL-F
	ZERO? LEVEL \?L31
	LOC WINNER >AV
	ZERO? AV /?L31
	FSET? AV,VEHBIT \?L31
	PRINTI " (outside the "
	PRINTD AV
	PRINTI ")"
?L31:	CRLF
	CALL SEE-INSIDE?,OBJ >STACK
	ZERO? STACK /FALSE
	FIRST? OBJ >STACK \FALSE
	CALL PRINT-CONT,OBJ,V?,LEVEL >STACK
	RSTACK

	.FUNCT PRINT-CONTENTS,OBJ,F,N,1ST?=1,IT?=0,TWO?=0
	FIRST? OBJ >F \FALSE
?L3:	NEXT? F >N /?L5
?L5:	ZERO? 1ST? /?L6
	SET '1ST?,0
	JUMP ?L11
?L6:	PRINTI ", "
	ZERO? N \?L11
	PRINTI "and "
?L11:	PRINTI "a "
	PRINTD F
	ZERO? IT? \?L18
	ZERO? TWO? \?L18
	SET 'IT?,F
	JUMP ?L20
?L18:	SET 'TWO?,1
	SET 'IT?,0
?L20:	SET 'F,N
	ZERO? F \?L3
	ZERO? IT? /TRUE
	ZERO? TWO? \TRUE
	CALL THIS-IS-IT,IT?
	RTRUE

	.FUNCT PRINT-CONT,OBJ,V?=0,LEVEL=0,Y,1ST?,SHIT,AV,STR,PV?=0,INV?=0
	FIRST? OBJ >Y \TRUE
	LOC WINNER >AV
	ZERO? AV /?L4
	FSET? AV,VEHBIT /?L6
?L4:	SET 'AV,0
?L6:	SET '1ST?,1
	SET 'SHIT,1
	LOC OBJ >STACK
	EQUAL? WINNER,OBJ,STACK \?L7
	SET 'INV?,1
	JUMP ?L11
?L7:	ZERO? Y /?L11
?L12:	EQUAL? Y,AV \?L14
	SET 'PV?,1
	JUMP ?L24
?L14:	EQUAL? Y,WINNER /?L24
	FSET? Y,INVISIBLE /?L24
	FSET? Y,TOUCHBIT /?L24
	GETP Y,P?FDESC >STR
	ZERO? STR /?L24
	FSET? Y,NDESCBIT /?L17
	PRINT STR
	CRLF
	SET 'SHIT,0
?L17:	CALL SEE-INSIDE?,Y >STACK
	ZERO? STACK /?L24
	LOC Y >STACK
	GETP STACK,P?DESCFCN >STACK
	ZERO? STACK \?L24
	FIRST? Y >STACK \?L24
	CALL PRINT-CONT,Y,V?,0 >STACK
	ZERO? STACK /?L24
	SET '1ST?,0
?L24:	NEXT? Y >Y /?L12
?L11:	FIRST? OBJ >Y /?L33
?L62:	ZERO? PV? /?L32
	ZERO? AV /?L32
	FIRST? AV >STACK \?L32
	INC 'LEVEL
	CALL PRINT-CONT,AV,V?,LEVEL
	JUMP ?L32
?L33:	EQUAL? Y,AV,ADVENTURER /?L55
	FSET? Y,INVISIBLE /?L55
	ZERO? INV? \?L40
	FSET? Y,TOUCHBIT /?L40
	GETP Y,P?FDESC >STACK
	ZERO? STACK \?L55
?L40:	FSET? Y,NDESCBIT /?L41
	ZERO? 1ST? /?L43
	CALL FIRSTER,OBJ,LEVEL >STACK
	ZERO? STACK /?L47
	LESS? LEVEL,0 \?L47
	SET 'LEVEL,0
?L47:	INC 'LEVEL
	SET '1ST?,0
?L43:	LESS? LEVEL,0 \?L52
	SET 'LEVEL,0
?L52:	CALL DESCRIBE-OBJECT,Y,V?,LEVEL
	JUMP ?L55
?L41:	FIRST? Y >STACK \?L55
	CALL SEE-INSIDE?,Y >STACK
	ZERO? STACK /?L55
	INC 'LEVEL
	CALL PRINT-CONT,Y,V?,LEVEL
	DEC 'LEVEL
?L55:	NEXT? Y >Y /?L33
	JUMP ?L62
?L32:	ZERO? 1ST? /TRUE
	ZERO? SHIT /TRUE
	RFALSE

	.FUNCT FIRSTER,OBJ,LEVEL
	EQUAL? OBJ,TROPHY-CASE \?L1
	PRINTR "Your collection of treasures consists of:"
?L1:	EQUAL? OBJ,WINNER \?L5
	PRINTR "You are carrying:"
?L5:	IN? OBJ,ROOMS /FALSE
	GRTR? LEVEL,0 \?L9
	GET INDENTS,LEVEL >STACK
	PRINT STACK
?L9:	FSET? OBJ,SURFACEBIT \?L14
	PRINTI "Sitting on the "
	PRINTD OBJ
	PRINTR " is: "
?L14:	FSET? OBJ,ACTORBIT \?L18
	PRINTI "The "
	PRINTD OBJ
	PRINTR " is holding: "
?L18:	PRINTI "The "
	PRINTD OBJ
	PRINTR " contains:"

	.FUNCT SEE-INSIDE?,OBJ
	FSET? OBJ,INVISIBLE /FALSE
	FSET? OBJ,TRANSBIT /TRUE
	FSET? OBJ,OPENBIT /TRUE
	RFALSE

	.FUNCT SCORE-UPD,NUM
	ADD BASE-SCORE,NUM >BASE-SCORE
	ADD SCORE,NUM >SCORE
	EQUAL? SCORE,350 \TRUE
	ZERO? WON-FLAG \TRUE
	SET 'WON-FLAG,1
	FCLEAR MAP,INVISIBLE
	FCLEAR WEST-OF-HOUSE,TOUCHBIT
	PRINTR "An almost inaudible voice whispers in your ear, ""Look to your treasures for the final secret."""

	.FUNCT SCORE-OBJ,OBJ,TEMP
	GETP OBJ,P?VALUE >TEMP
	GRTR? TEMP,0 \FALSE
	CALL SCORE-UPD,TEMP
	PUTP OBJ,P?VALUE,0
	RTRUE

	.FUNCT YES?
	PRINTI ">"
	READ P-INBUF,P-LEXV
	GET P-LEXV,1 >STACK
	EQUAL? STACK,W?YES,W?Y \FALSE
	RTRUE

	.FUNCT ITAKE,VB=1,CNT,OBJ,?TMP
	ZERO? DEAD /?L1
	ZERO? VB /FALSE
	PRINTI "Your hand passes through its object."
	CRLF
	RFALSE
?L1:	FSET? PRSO,TAKEBIT /?L8
	ZERO? VB /FALSE
	CALL PICK-ONE,YUKS >STACK
	PRINT STACK
	CRLF
	RFALSE
?L8:	CALL NULL-F >STACK
	ZERO? STACK \FALSE
	LOC PRSO >STACK
	FSET? STACK,CONTBIT \?L15
	LOC PRSO >STACK
	FSET? STACK,OPENBIT \FALSE
?L15:	LOC PRSO >STACK
	IN? STACK,WINNER /?L16
	CALL WEIGHT,PRSO >?TMP
	CALL WEIGHT,WINNER >STACK
	ADD ?TMP,STACK >STACK
	GRTR? STACK,LOAD-ALLOWED \?L16
	ZERO? VB /?L17
	PRINTI "Your load is too heavy"
	LESS? LOAD-ALLOWED,LOAD-MAX \?L21
	PRINTI ", especially in light of your condition."
	JUMP ?L25
?L21:	PRINTI "."
?L25:	CRLF
?L17:	RETURN 2
?L16:	EQUAL? PRSA,V?TAKE \?L31
	CALL CCOUNT,WINNER >CNT
	GRTR? CNT,FUMBLE-NUMBER \?L31
	MUL CNT,FUMBLE-PROB >?TMP
	RANDOM 100 >STACK
	GRTR? ?TMP,STACK \?L31
	PRINTI "You're holding too many things already!"
	CRLF
	RFALSE
?L31:	MOVE PRSO,WINNER
	FCLEAR PRSO,NDESCBIT
	FSET PRSO,TOUCHBIT
	CALL NULL-F
	CALL SCORE-OBJ,PRSO
	RTRUE

	.FUNCT IDROP
	IN? PRSO,WINNER /?L5
	LOC PRSO >STACK
	IN? STACK,WINNER /?L1
	PRINTI "You're not carrying the "
	PRINTD PRSO
	PRINTI "."
	CRLF
	RFALSE
?L1:	IN? PRSO,WINNER /?L5
	LOC PRSO >STACK
	FSET? STACK,OPENBIT /?L5
	PRINTI "The "
	PRINTD PRSO
	PRINTI " is closed."
	CRLF
	RFALSE
?L5:	LOC WINNER >STACK
	MOVE PRSO,STACK
	RTRUE

	.FUNCT CCOUNT,OBJ,CNT=0,X
	FIRST? OBJ >X \?L4
?L3:	FSET? X,WEARBIT /?L5
	INC 'CNT
?L5:	NEXT? X >X /?L3
?L4:	RETURN CNT

	.FUNCT WEIGHT,OBJ,CONT,WT=0
	FIRST? OBJ >CONT \?L4
?L3:	EQUAL? OBJ,PLAYER \?L5
	FSET? CONT,WEARBIT \?L5
	INC 'WT
	JUMP ?L7
?L5:	CALL WEIGHT,CONT >STACK
	ADD WT,STACK >WT
?L7:	NEXT? CONT >CONT /?L3
?L4:	GETP OBJ,P?SIZE >STACK
	ADD WT,STACK >STACK
	RSTACK

	.FUNCT HACK-HACK,STR
	IN? PRSO,GLOBAL-OBJECTS \?L1
	EQUAL? PRSA,V?LOWER,V?RAISE,V?WAVE \?L1
	PRINTI "The "
	PRINTD PRSO
	PRINTR " isn't here!"
?L1:	PRINT STR
	PRINTD PRSO
	CALL PICK-ONE,HO-HUM >STACK
	PRINT STACK
	CRLF
	RTRUE

	.FUNCT NO-GO-TELL,AV,WLOC
	ZERO? AV /?L1
	PRINTI "You can't go there in a "
	PRINTD WLOC
	PRINTR "."
?L1:	PRINTR "You can't go there without a vehicle."

	.FUNCT GOTO,RM,V?=1,LB,WLOC,AV=0,OLIT,OHERE
	FSET? RM,RLANDBIT /?L1
	SET 'LB,0
	JUMP ?L2
?L1:	SET 'LB,1
?L2:	LOC WINNER >WLOC
	SET 'OLIT,LIT
	SET 'OHERE,HERE
	FSET? WLOC,VEHBIT \?L3
	GETP WLOC,P?VTYPE >AV
?L3:	ZERO? LB \?L8
	ZERO? AV \?L6
	CALL NO-GO-TELL,AV,WLOC
	RFALSE
?L6:	ZERO? LB \?L8
	FSET? RM,AV /?L8
	CALL NO-GO-TELL,AV,WLOC
	RFALSE
?L8:	FSET? HERE,RLANDBIT \?L9
	ZERO? LB /?L9
	EQUAL? AV,0,RLANDBIT /?L9
	FSET? RM,AV /?L9
	CALL NO-GO-TELL,AV,WLOC
	RFALSE
?L9:	FSET? RM,RMUNGBIT \?L10
	GETP RM,P?LDESC >STACK
	PRINT STACK
	CRLF
	RFALSE
?L10:	ZERO? LB /?L14
	FSET? HERE,RLANDBIT /?L14
	ZERO? DEAD \?L14
	FSET? WLOC,VEHBIT \?L14
	PRINTI "The "
	PRINTD WLOC
	PRINTI " comes to a rest on the shore."
	CRLF
	CRLF
?L14:	ZERO? AV /?L19
	MOVE WLOC,RM
	JUMP ?L21
?L19:	MOVE WINNER,RM
?L21:	SET 'HERE,RM
	CALL LIT?,HERE >LIT
	ZERO? OLIT \?L29
	ZERO? LIT \?L40
	RANDOM 100 >STACK
	GRTR? 80,STACK \?L29
	ZERO? SPRAYED? /?L24
	PRINTI "There are sinister gurgling noises in the darkness all around you!"
	CRLF
	JUMP ?L29
?L24:	CALL NULL-F >STACK
	ZERO? STACK \FALSE
	PRINTI "Oh, no! A lurking grue slithered into the "
	LOC WINNER >STACK
	FSET? STACK,VEHBIT \?L32
	LOC WINNER >STACK
	PRINTD STACK
	JUMP ?L36
?L32:	PRINTI "room"
?L36:	CALL JIGS-UP,STR?68
	RTRUE
?L29:	ZERO? LIT \?L40
	EQUAL? WINNER,ADVENTURER \?L40
	PRINTI "You have moved into a dark place."
	CRLF
	SET 'P-CONT,0
?L40:	GETP HERE,P?ACTION >STACK
	CALL STACK,M-ENTER >STACK
	CALL SCORE-OBJ,RM
	EQUAL? HERE,RM \TRUE
	EQUAL? ADVENTURER,WINNER /?L47
	IN? ADVENTURER,OHERE \?L47
	PRINTI "The "
	PRINTD WINNER
	PRINTR " leaves the room."
?L47:	EQUAL? HERE,OHERE \?L50
	EQUAL? HERE,ENTRANCE-TO-HADES /TRUE
?L50:	ZERO? V? /TRUE
	EQUAL? WINNER,ADVENTURER \TRUE
	CALL V-FIRST-LOOK
	RTRUE

	.FUNCT LKP,ITM,TBL,CNT=0,LEN
	GET TBL,0 >LEN
?L1:	IGRTR? 'CNT,LEN /FALSE
	GET TBL,CNT >STACK
	EQUAL? STACK,ITM \?L1
	EQUAL? CNT,LEN /FALSE
	ADD CNT,1 >STACK
	GET TBL,STACK >STACK
	RSTACK

	.FUNCT DO-WALK,DIR
	SET 'P-WALK-DIR,DIR
	CALL PERFORM,V?WALK,DIR >STACK
	RSTACK

	.FUNCT GLOBAL-IN?,OBJ1,OBJ2,TX
	GETPT OBJ2,P?GLOBAL >TX
	ZERO? TX /FALSE
	PTSIZE TX >STACK
	DEC 'STACK
	CALL ZMEMQB,OBJ1,TX,STACK >STACK
	RSTACK

	.FUNCT FIND-IN,WHERE,WHAT,W
	FIRST? WHERE >W \FALSE
?L2:	FSET? W,WHAT \?L7
	EQUAL? W,ADVENTURER /?L7
	RETURN W
?L7:	NEXT? W >W /?L2
	RFALSE

	.FUNCT HELD?,CAN
?L1:	LOC CAN >CAN
	ZERO? CAN /FALSE
	EQUAL? CAN,WINNER \?L1
	RTRUE

	.FUNCT OTHER-SIDE,DOBJ,P=0,TX
?L1:	NEXTP HERE,P >P
	LESS? P,P?LAND /FALSE
	GETPT HERE,P >TX
	PTSIZE TX >STACK
	EQUAL? STACK,DEXIT \?L1
	GETB TX,DEXITOBJ >STACK
	EQUAL? STACK,DOBJ \?L1
	RETURN P

	.FUNCT MUNG-ROOM,RM,STR
	FSET RM,RMUNGBIT
	PUTP RM,P?LDESC,STR
	RTRUE

	.FUNCT THIS-IS-IT,OBJ
	SET 'P-IT-OBJECT,OBJ
	RETURN P-IT-OBJECT

	.FUNCT NOT-HERE-OBJECT-F,TBL,PRSO?=1,OBJ
	EQUAL? PRSO,NOT-HERE-OBJECT \?L5
	EQUAL? PRSI,NOT-HERE-OBJECT \?L1
	PRINTR "Those things aren't here!"
?L1:	EQUAL? PRSO,NOT-HERE-OBJECT \?L5
	SET 'TBL,P-PRSO
	JUMP ?L6
?L5:	SET 'TBL,P-PRSI
	SET 'PRSO?,0
?L6:	SET 'P-CONT,0
	SET 'QUOTE-FLAG,0
	EQUAL? WINNER,PLAYER \?L7
	PRINTI "You can't see any "
	CALL NOT-HERE-PRINT,PRSO?
	PRINTR " here!"
?L7:	PRINTI "The "
	PRINTD WINNER
	PRINTI " seems confused. ""I don't see any "
	CALL NOT-HERE-PRINT,PRSO?
	PRINTR " here!"""

	.FUNCT NOT-HERE-PRINT,PRSO?
	ZERO? P-OFLAG /?L1
	ZERO? P-XADJ /?L3
	PRINTB P-XADJN
?L3:	ZERO? P-XNAM /FALSE
	PRINTB P-XNAM
	RTRUE
?L1:	ZERO? PRSO? /?L9
	GET P-ITBL,P-NC1L >STACK
	GET P-ITBL,P-NC1 >STACK
	CALL BUFFER-PRINT,STACK,STACK,0 >STACK
	RSTACK
?L9:	GET P-ITBL,P-NC2L >STACK
	GET P-ITBL,P-NC2 >STACK
	CALL BUFFER-PRINT,STACK,STACK,0 >STACK
	RSTACK

	.FUNCT NULL-F,A1,A2
	RFALSE

	.FUNCT STAIRS-F
	EQUAL? PRSA,V?THROUGH \FALSE
	PRINTR "You should say whether you want to go up or down."

	.FUNCT SAILOR-FCN
	EQUAL? PRSA,V?TELL \?L1
	SET 'P-CONT,0
	SET 'QUOTE-FLAG,0
	PRINTR "You can't talk to the sailor that way."
?L1:	EQUAL? PRSA,V?EXAMINE \?L5
	PRINTR "There is no sailor to be seen."
?L5:	EQUAL? PRSA,V?HELLO \FALSE
	INC 'HS
	MOD HS,20 >STACK
	ZERO? STACK \?L9
	PRINTR "You seem to be repeating yourself."
?L9:	MOD HS,10 >STACK
	ZERO? STACK \?L13
	PRINTR "I think that phrase is getting a bit worn out."
?L13:	PRINTR "Nothing happens here."

	.FUNCT GROUND-FUNCTION
	EQUAL? PRSA,V?PUT-ON,V?PUT \?L1
	EQUAL? PRSI,GROUND \?L1
	CALL PERFORM,V?DROP,PRSO
	RTRUE
?L1:	EQUAL? HERE,SANDY-CAVE \?L3
	CALL SAND-FUNCTION >STACK
	RSTACK
?L3:	EQUAL? PRSA,V?DIG \FALSE
	PRINTR "The ground is too hard for digging here."

	.FUNCT GRUE-FUNCTION
	EQUAL? PRSA,V?EXAMINE \?L1
	PRINTR "The grue is a sinister, lurking presence in the dark places of the earth. Its favorite diet is adventurers, but its insatiable appetite is tempered by its fear of light. No grue has ever been seen by the light of day, and few have survived its fearsome jaws to tell the tale."
?L1:	EQUAL? PRSA,V?FIND \?L5
	PRINTR "There is no grue here, but I'm sure there is at least one lurking in the darkness nearby. I wouldn't let my light go out if I were you!"
?L5:	EQUAL? PRSA,V?LISTEN \FALSE
	PRINTR "It makes no sound but is always lurking in the darkness nearby."

	.FUNCT CRETIN-FCN
	EQUAL? PRSA,V?TELL \?L1
	SET 'P-CONT,0
	SET 'QUOTE-FLAG,0
	PRINTR "Talking to yourself is said to be a sign of impending mental collapse."
?L1:	EQUAL? PRSA,V?GIVE \?L5
	EQUAL? PRSI,ME \?L5
	CALL PERFORM,V?TAKE,PRSO
	RTRUE
?L5:	EQUAL? PRSA,V?MAKE \?L6
	PRINTR "Only you can do that."
?L6:	EQUAL? PRSA,V?DISEMBARK \?L9
	PRINTR "You'll have to do that on your own."
?L9:	EQUAL? PRSA,V?EAT \?L12
	PRINTI "Auto-cannibalism is not the answer."
	CRLF
	CALL PRINT-ID,STR?69 >STACK
	RSTACK
?L12:	EQUAL? PRSA,V?MUNG,V?ATTACK \?L15
	ZERO? PRSI /?L16
	FSET? PRSI,WEAPONBIT \?L16
	CALL PRINT-ID,STR?70
	CALL JIGS-UP,STR?71 >STACK
	RSTACK
?L16:	PRINTI "Suicide is not the answer."
	CRLF
	CALL PRINT-ID,STR?72 >STACK
	RSTACK
?L15:	EQUAL? PRSA,V?THROW \?L21
	EQUAL? PRSO,ME \FALSE
	PRINTR "Why don't you just walk like normal people?"
?L21:	EQUAL? PRSA,V?TAKE \?L27
	PRINTR "How romantic!"
?L27:	EQUAL? PRSA,V?EXAMINE \FALSE
	LOC MIRROR-2 >STACK
	LOC MIRROR-1 >STACK
	EQUAL? HERE,STACK,STACK \?L31
	PRINTR "Your image in the mirror looks tired."
?L31:	PRINTR "That's difficult unless your eyes are prehensile."

	.FUNCT PATH-OBJECT
	EQUAL? PRSA,V?FOLLOW,V?TAKE \?L1
	PRINTR "You must specify a direction to go."
?L1:	EQUAL? PRSA,V?FIND \?L5
	PRINTR "I can't help you there...."
?L5:	EQUAL? PRSA,V?DIG \FALSE
	PRINTR "Not a chance."

	.FUNCT ZORKMID-FUNCTION
	EQUAL? PRSA,V?EXAMINE \?L1
	PRINTR "The zorkmid is the unit of currency of the Great Underground Empire."
?L1:	EQUAL? PRSA,V?FIND \FALSE
	PRINTR "The best way to find zorkmids is to go out and look for them."

	.FUNCT PRINT-DESC1,OBJ
	ZERO? OBJ /FALSE
	PRINTD OBJ
	RTRUE

	.FUNCT PRINT-ID,ID,CONDITION=1
	ZERO? CONDITION /FALSE
	PRINTI "[ID: "
	PRINT ID
	PRINTI ", PRSO: "
	CALL PRINT-DESC1,PRSO
	PRINTI ", PRSI: "
	CALL PRINT-DESC1,PRSI
	PRINTI "]"
	RTRUE

	.FUNCT PRINT-DEBUG,TEXT,CONDITION=1
	ZERO? CONDITION /FALSE
	PRINTI "DEBUG FLAG: "
	PRINT TEXT
	RTRUE

	.FUNCT IS-THEFT?
	EQUAL? PRSO,ALTAR,ATTIC-TABLE,AXE /TRUE
	EQUAL? PRSO,BAG-OF-COINS,BAR,BAUBLE /TRUE
	EQUAL? PRSO,BELL,BLUE-BUTTON,BOARD /TRUE
	EQUAL? PRSO,BOAT-LABEL,BOLT,BOOK /TRUE
	EQUAL? PRSO,BOTTLE,BRACELET,BUOY /TRUE
	EQUAL? PRSO,CANDLES,CHALICE,COFFIN /TRUE
	EQUAL? PRSO,CONTROL-PANEL,EMERALD,GARLIC /TRUE
	EQUAL? PRSO,GRATE,JADE,KEYS /TRUE
	EQUAL? PRSO,KITCHEN-TABLE,KNIFE,LADDER /TRUE
	EQUAL? PRSO,LAMP,LARGE-BAG,LUNCH /TRUE
	EQUAL? PRSO,MACHINE,MACHINE-SWITCH,MAILBOX /TRUE
	EQUAL? PRSO,MAP,MIRROR-1,MIRROR-2 /TRUE
	EQUAL? PRSO,PAINTING,PEDESTAL,POT-OF-GOLD /TRUE
	EQUAL? PRSO,PUMP,PUTTY,RAISED-BASKET /TRUE
	EQUAL? PRSO,RED-BUTTON,ROPE,RUG /TRUE
	EQUAL? PRSO,RUSTY-KNIFE,SANDWICH-BAG,SCARAB /TRUE
	EQUAL? PRSO,SCEPTRE,SCREWDRIVER,SHOVEL /TRUE
	EQUAL? PRSO,SKULL,STILETTO,SWORD /TRUE
	EQUAL? PRSO,TORCH,TROPHY-CASE,TUBE /TRUE
	EQUAL? PRSO,WRENCH,YELLOW-BUTTON,ZORKMID \FALSE
	RTRUE

	.FUNCT IS-OBJECT-OR-PROPERTY?
	EQUAL? PRSO,ADVERTISEMENT,ALTAR,ATTIC-TABLE /TRUE
	EQUAL? PRSO,AXE,BAG-OF-COINS,BAR /TRUE
	EQUAL? PRSO,BARROW,BARROW-DOOR,BAUBLE /TRUE
	EQUAL? PRSO,BELL,BLUE-BUTTON,BOARD /TRUE
	EQUAL? PRSO,BOARDED-WINDOW,BOAT-LABEL,BOLT /TRUE
	EQUAL? PRSO,BOOK,BOTTLE,BRACELET /TRUE
	EQUAL? PRSO,BUOY,BURNED-OUT-LANTERN,CANARY /TRUE
	EQUAL? PRSO,CANDLES,CHALICE,COFFIN /TRUE
	EQUAL? PRSO,CONTROL-PANEL,DAM,EGG /TRUE
	EQUAL? PRSO,EMERALD,ENGRAVINGS,FRONT-DOOR /TRUE
	EQUAL? PRSO,GRATE,GUIDE,HOT-BELL /TRUE
	EQUAL? PRSO,INFLATABLE-BOAT,INFLATED-BOAT,JADE /TRUE
	EQUAL? PRSO,KEYS,KITCHEN-TABLE,KITCHEN-WINDOW /TRUE
	EQUAL? PRSO,KNIFE,LADDER,LAMP /TRUE
	EQUAL? PRSO,LARGE-BAG,LUNCH,MACHINE /TRUE
	EQUAL? PRSO,MACHINE-SWITCH,MAILBOX,MAP /TRUE
	EQUAL? PRSO,MATCH,MIRROR-1,MIRROR-2 /TRUE
	EQUAL? PRSO,NEST,PAINTING,PEDESTAL /TRUE
	EQUAL? PRSO,POT-OF-GOLD,PUMP,PUNCTURED-BOAT /TRUE
	EQUAL? PRSO,PUTTY,RAILING,RAISED-BASKET /TRUE
	EQUAL? PRSO,RED-BUTTON,ROPE,RUG /TRUE
	EQUAL? PRSO,RUSTY-KNIFE,SANDWICH-BAG,SCARAB /TRUE
	EQUAL? PRSO,SCEPTRE,SCREWDRIVER,SHOVEL /TRUE
	EQUAL? PRSO,SKULL,STAIRS,STILETTO /TRUE
	EQUAL? PRSO,SWORD,TORCH,TRAP-DOOR /TRUE
	EQUAL? PRSO,TREE,TRIDENT,TROPHY-CASE /TRUE
	EQUAL? PRSO,TRUNK,TUBE,WALL /TRUE
	EQUAL? PRSO,WHITE-HOUSE,WOODEN-DOOR,WRENCH /TRUE
	EQUAL? PRSO,YELLOW-BUTTON,ZORKMID \FALSE
	RTRUE

	.FUNCT DANGEROUS-TO-GIVE-TROLL?
	EQUAL? PRSO,PUTTY,TUBE /TRUE
	FSET? PRSO,WEAPONBIT /TRUE
	RFALSE

	.FUNCT BOMB?,TMP
	RFALSE

	.FUNCT IS-BAD-TO-PICK?
	EQUAL? PRSO,FRONT-DOOR \FALSE
	RTRUE

	.FUNCT IS-PERSON?
	EQUAL? PRSO,TROLL,CYCLOPS,THIEF \FALSE
	RTRUE

	.FUNCT DANGEROUS-DRINK?
	EQUAL? PRSO,PUTTY \FALSE
	RTRUE

	.FUNCT DANGEROUS-FOOD?,?TMP
	CALL IS-PART-OF-SELF? >?TMP
	ZERO? ?TMP /?L2
	RETURN ?TMP
?L2:	CALL IS-OBJECT-OR-PROPERTY? >STACK
	RSTACK

	.FUNCT IS-ANIMAL?
	EQUAL? PRSO,GRUE,BAT \FALSE
	RTRUE

	.FUNCT IS-OBJ-PROP-ANIMAL?,?TMP
	CALL IS-OBJECT-OR-PROPERTY? >?TMP
	ZERO? ?TMP /?L2
	RETURN ?TMP
?L2:	CALL IS-ANIMAL? >STACK
	RSTACK

	.FUNCT IS-SELF?
	EQUAL? PRSO,ME \FALSE
	RTRUE

	.FUNCT IS-PART-OF-SELF?
	EQUAL? PRSO,HANDS \FALSE
	RTRUE

	.FUNCT IS-PART-OF-SELF-OR-SELF?,?TMP
	CALL IS-SELF? >?TMP
	ZERO? ?TMP /?L2
	RETURN ?TMP
?L2:	CALL IS-PART-OF-SELF? >STACK
	RSTACK

	.FUNCT TREASURE-INSIDE
	EQUAL? PRSA,V?OPEN \FALSE
	CALL SCORE-OBJ,EMERALD
	RFALSE

	.FUNCT GRATING-EXIT
	ZERO? GRATE-REVEALED /?L1
	FSET? GRATE,OPENBIT \?L3
	RETURN GRATING-ROOM
?L3:	PRINTI "The grating is closed!"
	CRLF
	CALL THIS-IS-IT,GRATE
	RFALSE
?L1:	PRINTI "You can't go that way."
	CRLF
	RFALSE

	.FUNCT CANYON-VIEW-F,RARG
	EQUAL? RARG,M-BEG \FALSE
	EQUAL? PRSA,V?LEAP \FALSE
	ZERO? PRSO \FALSE
	CALL JIGS-UP,STR?73
	RTRUE

	.FUNCT GO
START::
?L0:	CALL QUEUE,I-FIGHT,-1 >STACK
	PUT STACK,0,1
	CALL QUEUE,I-SWORD,-1
	CALL QUEUE,I-THIEF,-1 >STACK
	PUT STACK,0,1
	CALL QUEUE,I-CANDLES,40
	CALL QUEUE,I-LANTERN,200
	PUTP INFLATED-BOAT,P?VTYPE,NONLANDBIT
	ADD DEF1,2 >STACK
	PUT DEF1-RES,1,STACK
	ADD DEF1,4 >STACK
	PUT DEF1-RES,2,STACK
	ADD DEF2B,2 >STACK
	PUT DEF2-RES,2,STACK
	ADD DEF2B,4 >STACK
	PUT DEF2-RES,3,STACK
	ADD DEF3A,2 >STACK
	PUT DEF3-RES,1,STACK
	ADD DEF3B,2 >STACK
	PUT DEF3-RES,3,STACK
	SET 'HERE,WEST-OF-HOUSE
	CALL THIS-IS-IT,MAILBOX
	FSET? HERE,TOUCHBIT /?L1
	CALL V-VERSION
	CRLF
?L1:	SET 'LIT,1
	SET 'WINNER,ADVENTURER
	SET 'PLAYER,WINNER
	MOVE WINNER,HERE
	CALL V-LOOK
	CALL MAIN-LOOP
	JUMP ?L0

	.FUNCT WEST-HOUSE,RARG
	EQUAL? RARG,M-LOOK \FALSE
	PRINTI "You are standing in an open field west of a white house, with a boarded front door."
	ZERO? WON-FLAG /?L5
	PRINTI " A secret path leads southwest into the forest."
?L5:	CRLF
	RTRUE

	.FUNCT EAST-HOUSE,RARG
	EQUAL? RARG,M-LOOK \FALSE
	PRINTI "You are behind the white house. A path leads into the forest to the east. In one corner of the house there is a small window which is "
	FSET? KITCHEN-WINDOW,OPENBIT \?L5
	PRINTR "open."
?L5:	PRINTR "slightly ajar."

	.FUNCT OPEN-CLOSE,OBJ,STROPN,STRCLS
	EQUAL? PRSA,V?OPEN \?L1
	FSET? OBJ,OPENBIT \?L3
	CALL PICK-ONE,DUMMY >STACK
	PRINT STACK
	CRLF
	RTRUE
?L3:	PRINT STROPN
	EQUAL? OBJ,KITCHEN-WINDOW /?L10
	PUSH 0
	JUMP ?L11
?L10:	PUSH 1
?L11:	CALL PRINT-ID,STR?74,STACK
	FSET OBJ,OPENBIT
	CRLF
	RTRUE
?L1:	EQUAL? PRSA,V?CLOSE \FALSE
	FSET? OBJ,OPENBIT \?L13
	PRINT STRCLS
	FCLEAR OBJ,OPENBIT
	CRLF
	RTRUE
?L13:	CALL PICK-ONE,DUMMY >STACK
	PRINT STACK
	CRLF
	RTRUE

	.FUNCT BOARD-F
	EQUAL? PRSA,V?EXAMINE,V?TAKE \FALSE
	PRINTI "The boards are securely fastened."
	CRLF
	CALL PRINT-ID,STR?75 >STACK
	RSTACK

	.FUNCT TEETH-F
	EQUAL? PRSA,V?BRUSH \FALSE
	EQUAL? PRSO,TEETH \FALSE
	EQUAL? PRSI,PUTTY \?L3
	IN? PRSI,WINNER \?L3
	CALL PRINT-ID,STR?76
	CALL JIGS-UP,STR?77 >STACK
	RSTACK
?L3:	ZERO? PRSI \?L5
	PRINTR "Dental hygiene is highly recommended, but I'm not sure what you want to brush them with."
?L5:	PRINTI "A nice idea, but with a "
	PRINTD PRSI
	PRINTI "?"
	CRLF
	CALL IS-OBJECT-OR-PROPERTY? >STACK
	CALL PRINT-ID,STR?78,STACK >STACK
	RSTACK

	.FUNCT GRANITE-WALL-F
	EQUAL? HERE,NORTH-TEMPLE \?L1
	EQUAL? PRSA,V?FIND \?L3
	PRINTR "The west wall is solid granite here."
?L3:	EQUAL? PRSA,V?LOWER,V?RAISE,V?TAKE \FALSE
	PRINTR "It's solid granite."
?L1:	EQUAL? HERE,TREASURE-ROOM \?L11
	EQUAL? PRSA,V?FIND \?L12
	PRINTR "The east wall is solid granite here."
?L12:	EQUAL? PRSA,V?LOWER,V?RAISE,V?TAKE \FALSE
	PRINTR "It's solid granite."
?L11:	EQUAL? HERE,SLIDE-ROOM \?L20
	EQUAL? PRSA,V?READ,V?FIND \?L21
	PRINTR "It only SAYS ""Granite Wall""."
?L21:	PRINTR "The wall isn't granite."
?L20:	PRINTR "There is no granite wall here."

	.FUNCT SONGBIRD-F
	EQUAL? PRSA,V?TAKE,V?FIND \?L1
	PRINTI "The songbird is not here but is probably nearby."
	CRLF
	CALL PRINT-ID,STR?79 >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?LISTEN \?L5
	PRINTR "You can't hear the songbird now."
?L5:	EQUAL? PRSA,V?FOLLOW \?L8
	PRINTR "It can't be followed."
?L8:	PRINTR "You can't see any songbird here."

	.FUNCT WHITE-HOUSE-F
	EQUAL? HERE,KITCHEN,LIVING-ROOM,ATTIC \?L1
	EQUAL? PRSA,V?FIND \?L3
	PRINTR "Why not find your brains?"
?L3:	EQUAL? PRSA,V?WALK-AROUND \FALSE
	CALL GO-NEXT,IN-HOUSE-AROUND
	RTRUE
?L1:	EQUAL? HERE,EAST-OF-HOUSE,WEST-OF-HOUSE,NORTH-OF-HOUSE /?L9
	EQUAL? HERE,SOUTH-OF-HOUSE /?L9
	EQUAL? PRSA,V?FIND \?L10
	EQUAL? HERE,CLEARING \?L12
	PRINTR "It seems to be to the west."
?L12:	PRINTR "It was here just a minute ago...."
?L10:	PRINTR "You're not at the house."
?L9:	EQUAL? PRSA,V?FIND \?L22
	PRINTR "It's right here! Are you blind or something?"
?L22:	EQUAL? PRSA,V?WALK-AROUND \?L25
	CALL GO-NEXT,HOUSE-AROUND
	RTRUE
?L25:	EQUAL? PRSA,V?EXAMINE \?L26
	PRINTR "The house is a beautiful colonial house which is painted white. It is clear that the owners must have been extremely wealthy."
?L26:	EQUAL? PRSA,V?OPEN,V?THROUGH \?L29
	EQUAL? HERE,EAST-OF-HOUSE \?L30
	FSET? KITCHEN-WINDOW,OPENBIT \?L32
	CALL GOTO,KITCHEN >STACK
	RSTACK
?L32:	PRINTI "The window is closed."
	CRLF
	CALL THIS-IS-IT,KITCHEN-WINDOW >STACK
	RSTACK
?L30:	PRINTR "I can't see how to get in from here."
?L29:	EQUAL? PRSA,V?BURN \FALSE
	PRINTI "You must be joking."
	CRLF
	CALL PRINT-ID,STR?80 >STACK
	RSTACK

	.FUNCT GO-NEXT,TBL,VAL
	CALL LKP,HERE,TBL >VAL
	ZERO? VAL /FALSE
	CALL GOTO,VAL >STACK
	ZERO? STACK \TRUE
	RETURN 2

	.FUNCT FOREST-F
	EQUAL? PRSA,V?WALK-AROUND \?L1
	EQUAL? HERE,WEST-OF-HOUSE,NORTH-OF-HOUSE,SOUTH-OF-HOUSE /?L5
	EQUAL? HERE,EAST-OF-HOUSE \?L3
?L5:	PRINTI "You aren't even in the forest."
	CRLF
?L3:	CALL GO-NEXT,FOREST-AROUND >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?DISEMBARK \?L9
	PRINTR "You will have to specify a direction."
?L9:	EQUAL? PRSA,V?FIND \?L12
	PRINTR "You cannot see the forest for the trees."
?L12:	EQUAL? PRSA,V?LISTEN \FALSE
	PRINTR "The pines and the hemlocks seem to be murmuring."

	.FUNCT MOUNTAIN-RANGE-F
	EQUAL? PRSA,V?CLIMB-FOO,V?CLIMB-DOWN,V?CLIMB-UP \FALSE
	PRINTR "Don't you believe me? The mountains are impassable!"

	.FUNCT WATER-F,AV,W,PI?
	EQUAL? PRSA,V?SGIVE /FALSE
	EQUAL? PRSA,V?BOARD,V?THROUGH \?L3
	CALL PICK-ONE,SWIMYUKS >STACK
	PRINT STACK
	CRLF
	RTRUE
?L3:	EQUAL? PRSA,V?FILL \?L6
	SET 'W,PRSI
	SET 'PRSA,V?PUT
	SET 'PRSI,PRSO
	SET 'PRSO,W
	SET 'PI?,0
	JUMP ?L10
?L6:	EQUAL? PRSO,GLOBAL-WATER /?L8
	EQUAL? PRSO,WATER \?L7
?L8:	SET 'W,PRSO
	SET 'PI?,0
	JUMP ?L10
?L7:	SET 'W,PRSI
	ZERO? W /?L10
	SET 'PI?,1
?L10:	EQUAL? W,GLOBAL-WATER \?L15
	SET 'W,WATER
	EQUAL? PRSA,V?PUT,V?TAKE \?L15
	CALL REMOVE-CAREFULLY,W
?L15:	ZERO? PI? /?L19
	SET 'PRSI,W
	JUMP ?L21
?L19:	SET 'PRSO,W
?L21:	LOC WINNER >AV
	FSET? AV,VEHBIT /?L22
	SET 'AV,0
?L22:	EQUAL? PRSA,V?PUT,V?TAKE \?L25
	ZERO? PI? \?L75
	ZERO? AV /?L27
	EQUAL? AV,PRSI /?L29
	ZERO? PRSI \?L76
	IN? W,AV /?L27
?L29:	PRINTI "There is now a puddle in the bottom of the "
	PRINTD AV
	PRINTI "."
	CRLF
	CALL REMOVE-CAREFULLY,PRSO
	MOVE PRSO,AV
	RTRUE
?L27:	ZERO? PRSI /?L32
?L76:	EQUAL? PRSI,BOTTLE /?L32
	PRINTI "The water leaks out of the "
	PRINTD PRSI
	PRINTI " and evaporates immediately."
	CRLF
	CALL REMOVE-CAREFULLY,W >STACK
	RSTACK
?L32:	IN? BOTTLE,WINNER \?L35
	FSET? BOTTLE,OPENBIT /?L36
	PRINTI "The bottle is closed."
	CRLF
	CALL THIS-IS-IT,BOTTLE >STACK
	RSTACK
?L36:	FIRST? BOTTLE >STACK /?L40
	MOVE WATER,BOTTLE
	PRINTR "The bottle is now full of water."
?L40:	PRINTR "The water slips through your fingers."
?L35:	IN? PRSO,BOTTLE \?L46
	EQUAL? PRSA,V?TAKE \?L46
	ZERO? PRSI \?L46
	PRINTR "It's in the bottle. Perhaps you should take that instead."
?L46:	PRINTR "The water slips through your fingers."
?L25:	ZERO? PI? /?L52
?L75:	EQUAL? PRSA,V?PUT \?L53
	CALL GLOBAL-IN?,RIVER,HERE >STACK
	ZERO? STACK /?L53
	CALL PERFORM,V?PUT,PRSO,RIVER
	RTRUE
?L53:	PRINTR "Nice try."
?L52:	EQUAL? PRSA,V?GIVE,V?DROP \?L58
	EQUAL? PRSA,V?DROP \?L59
	IN? WATER,BOTTLE \?L59
	FSET? BOTTLE,OPENBIT /?L59
	PRINTR "The bottle is closed."
?L59:	CALL REMOVE-CAREFULLY,WATER
	ZERO? AV /?L64
	PRINTI "There is now a puddle in the bottom of the "
	PRINTD AV
	PRINTI "."
	CRLF
	MOVE WATER,AV
	RTRUE
?L64:	PRINTI "The water spills to the floor and evaporates immediately."
	CRLF
	CALL REMOVE-CAREFULLY,WATER >STACK
	RSTACK
?L58:	EQUAL? PRSA,V?THROW \FALSE
	PRINTI "The water splashes on the walls and evaporates immediately."
	CRLF
	CALL REMOVE-CAREFULLY,WATER >STACK
	RSTACK

	.FUNCT KITCHEN-WINDOW-F
	EQUAL? PRSA,V?CLOSE,V?OPEN \?L1
	SET 'KITCHEN-WINDOW-FLAG,1
	CALL OPEN-CLOSE,KITCHEN-WINDOW,STR?82,STR?81 >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?EXAMINE \?L3
	ZERO? KITCHEN-WINDOW-FLAG \?L3
	PRINTR "The window is slightly ajar, but not enough to allow entry."
?L3:	EQUAL? PRSA,V?THROUGH,V?BOARD,V?WALK \?L6
	EQUAL? HERE,KITCHEN \?L7
	CALL DO-WALK,P?EAST
	RTRUE
?L7:	CALL DO-WALK,P?WEST
	RTRUE
?L6:	EQUAL? PRSA,V?LOOK-INSIDE \FALSE
	PRINTI "You can see "
	EQUAL? HERE,KITCHEN \?L13
	PRINTR "a clear area leading towards a forest."
?L13:	PRINTI "what appears to be a kitchen."
	CRLF
	CALL PRINT-ID,STR?83 >STACK
	RSTACK

	.FUNCT GHOSTS-F
	EQUAL? PRSA,V?TELL \?L1
	PRINTI "The spirits jeer loudly and ignore you."
	CRLF
	SET 'P-CONT,0
	RETURN P-CONT
?L1:	EQUAL? PRSA,V?EXORCISE \?L5
	PRINTR "Only the ceremony itself has any effect."
?L5:	EQUAL? PRSA,V?MUNG,V?ATTACK \?L8
	EQUAL? PRSO,GHOSTS \?L8
	PRINTI "How can you attack a spirit with material objects?"
	CRLF
	CALL PRINT-ID,STR?84 >STACK
	RSTACK
?L8:	PRINTR "You seem unable to interact with these spirits."

	.FUNCT BASKET-F
	EQUAL? PRSA,V?RAISE \?L1
	ZERO? CAGE-TOP /?L3
	CALL PICK-ONE,DUMMY >STACK
	PRINT STACK
	CRLF
	RTRUE
?L3:	MOVE RAISED-BASKET,SHAFT-ROOM
	MOVE LOWERED-BASKET,LOWER-SHAFT
	SET 'CAGE-TOP,1
	CALL THIS-IS-IT,RAISED-BASKET
	PRINTR "The basket is raised to the top of the shaft."
?L1:	EQUAL? PRSA,V?LOWER \?L10
	ZERO? CAGE-TOP \?L11
	CALL PICK-ONE,DUMMY >STACK
	PRINT STACK
	CRLF
	RTRUE
?L11:	MOVE RAISED-BASKET,LOWER-SHAFT
	MOVE LOWERED-BASKET,SHAFT-ROOM
	CALL THIS-IS-IT,LOWERED-BASKET
	PRINTI "The basket is lowered to the bottom of the shaft."
	CRLF
	SET 'CAGE-TOP,0
	ZERO? LIT /TRUE
	CALL LIT?,HERE >LIT
	ZERO? LIT \TRUE
	PRINTR "It is now pitch black."
?L10:	EQUAL? PRSO,LOWERED-BASKET /?L24
	EQUAL? PRSI,LOWERED-BASKET \?L23
?L24:	PRINTR "The basket is at the other end of the chain."
?L23:	EQUAL? PRSA,V?TAKE \FALSE
	EQUAL? PRSO,RAISED-BASKET,LOWERED-BASKET \FALSE
	PRINTR "The cage is securely fastened to the iron chain."

	.FUNCT BAT-F
	EQUAL? PRSA,V?TELL \?L1
	CALL FWEEP,6
	SET 'P-CONT,0
	RETURN P-CONT
?L1:	EQUAL? PRSA,V?MUNG,V?ATTACK,V?TAKE \FALSE
	LOC GARLIC >STACK
	EQUAL? STACK,WINNER,HERE \?L4
	PRINTR "You can't reach him; he's on the ceiling."
?L4:	CALL PRINT-ID,STR?85
	CALL FLY-ME >STACK
	RSTACK

	.FUNCT FLY-ME
	CALL FWEEP,4
	PRINTI "The bat grabs you by the scruff of your neck and lifts you away...."
	CRLF
	CRLF
	CALL PICK-ONE,BAT-DROPS >STACK
	CALL GOTO,STACK,0
	EQUAL? HERE,ENTRANCE-TO-HADES /TRUE
	CALL V-FIRST-LOOK
	RTRUE

	.FUNCT FWEEP,N
?L1:	DLESS? 'N,1 /?L2
	PRINTI "    Fweep!"
	CRLF
	JUMP ?L1
?L2:	CRLF
	RTRUE

	.FUNCT BELL-F
	EQUAL? PRSA,V?RING \FALSE
	EQUAL? HERE,LLD-ROOM \?L3
	ZERO? LLD-FLAG /FALSE
?L3:	PRINTR "Ding, dong."

	.FUNCT HOT-BELL-F
	EQUAL? PRSA,V?TAKE \?L1
	PRINTR "The bell is very hot and cannot be taken."
?L1:	EQUAL? PRSA,V?RUB /?L6
	EQUAL? PRSA,V?RING \?L5
	ZERO? PRSI /?L5
?L6:	FSET? PRSI,BURNBIT \?L7
	PRINTI "The "
	PRINTD PRSI
	PRINTI " burns and is consumed."
	CRLF
	CALL PRINT-ID,STR?86
	CALL REMOVE-CAREFULLY,PRSI >STACK
	RSTACK
?L7:	EQUAL? PRSI,HANDS \?L11
	PRINTR "The bell is too hot to touch."
?L11:	PRINTI "The heat from the bell is too intense."
	CRLF
	CALL PRINT-ID,STR?87 >STACK
	RSTACK
?L5:	EQUAL? PRSA,V?POUR-ON \?L17
	CALL REMOVE-CAREFULLY,PRSO
	PRINTI "The water cools the bell and is evaporated."
	CRLF
	CALL QUEUE,I-XBH,0
	CALL I-XBH >STACK
	RSTACK
?L17:	EQUAL? PRSA,V?RING \FALSE
	PRINTI "The bell is too hot to reach."
	CRLF
	CALL PRINT-ID,STR?88 >STACK
	RSTACK

	.FUNCT BOARDED-WINDOW-FCN
	EQUAL? PRSA,V?OPEN \?L1
	PRINTI "The windows are boarded and can't be opened."
	CRLF
	CALL PRINT-ID,STR?89 >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?MUNG \FALSE
	PRINTI "You can't break the windows open."
	CRLF
	CALL PRINT-ID,STR?90 >STACK
	RSTACK

	.FUNCT NAILS-PSEUDO
	EQUAL? PRSA,V?TAKE \FALSE
	PRINTI "The nails, deeply imbedded in the door, cannot be removed."
	CRLF
	CALL PRINT-ID,STR?91 >STACK
	RSTACK

	.FUNCT CRACK-FCN
	EQUAL? PRSA,V?THROUGH \FALSE
	PRINTR "You can't fit through the crack."

	.FUNCT KITCHEN-FCN,RARG
	EQUAL? RARG,M-LOOK \?L1
	PRINTI "You are in the kitchen of the white house. A table seems to have been used recently for the preparation of food. A passage leads to the west and a dark staircase can be seen leading upward. A dark chimney leads down and to the east is a small window which is "
	FSET? KITCHEN-WINDOW,OPENBIT \?L5
	PRINTR "open."
?L5:	PRINTR "slightly ajar."
?L1:	EQUAL? RARG,M-BEG \FALSE
	EQUAL? PRSA,V?CLIMB-UP \FALSE
	EQUAL? PRSO,STAIRS \?L13
	CALL DO-WALK,P?UP >STACK
	RSTACK
?L13:	EQUAL? PRSA,V?CLIMB-UP \FALSE
	EQUAL? PRSO,STAIRS \FALSE
	PRINTR "There are no stairs leading down."

	.FUNCT STONE-BARROW-FCN,RARG
	EQUAL? RARG,M-BEG \FALSE
	EQUAL? PRSA,V?ENTER /?L3
	EQUAL? PRSA,V?WALK \?L4
	EQUAL? PRSO,P?WEST,P?IN /?L3
?L4:	EQUAL? PRSA,V?THROUGH \FALSE
	EQUAL? PRSO,BARROW \FALSE
?L3:	PRINTI "Inside the Barrow
As you enter the barrow, the door closes inexorably behind you. Around you it is dark, but ahead is an enormous cavern, brightly lit. Through its center runs a wide stream. Spanning the stream is a small wooden footbridge, and beyond a path leads into a dark tunnel. Above the bridge, floating in the air, is a large sign. It reads:  All ye who stand before this bridge have completed a great and perilous adventure which has tested your wit and courage. You have mastered"
	GETB 0,1 >STACK
	BTST STACK,8 /?L7
	PRINTI " the first part of the ZORK trilogy. Those who pass over this bridge must be prepared to undertake an even greater adventure that will severely test your skill and bravery!

The ZORK trilogy continues with ""ZORK II: The Wizard of Frobozz"" and is completed in ""ZORK III: The Dungeon Master."""
	CRLF
	CALL SCORE-UPD,10
	JUMP ?L11
?L7:	PRINTI " ZORK: The Great Underground Empire.
"
	CRLF
?L11:	CALL FINISH >STACK
	RSTACK

	.FUNCT BARROW-DOOR-FCN
	EQUAL? PRSA,V?CLOSE,V?OPEN \FALSE
	PRINTR "The door is too heavy."

	.FUNCT BARROW-FCN
	EQUAL? PRSA,V?THROUGH \FALSE
	CALL DO-WALK,P?WEST >STACK
	RSTACK

	.FUNCT TROPHY-CASE-FCN
	EQUAL? PRSA,V?TAKE \FALSE
	EQUAL? PRSO,TROPHY-CASE \FALSE
	PRINTI "The trophy case is securely fastened to the wall."
	CRLF
	CALL PRINT-ID,STR?92 >STACK
	RSTACK

	.FUNCT LIVING-ROOM-FCN,RARG,RUG?,TC,?TMP
	EQUAL? RARG,M-LOOK \?L1
	PRINTI "You are in the living room. There is a doorway to the east"
	ZERO? MAGIC-FLAG /?L5
	PRINTI ". To the west is a cyclops-shaped opening in an old wooden door, above which is some strange gothic lettering, "
	JUMP ?L9
?L5:	PRINTI ", a wooden door with strange gothic lettering to the west, which appears to be nailed shut, "
?L9:	PRINTI "a trophy case, "
	SET 'RUG?,RUG-MOVED
	ZERO? RUG? /?L18
	FSET? TRAP-DOOR,OPENBIT \?L14
	PRINTR "and a rug lying beside an open trap door."
?L14:	ZERO? RUG? /?L18
	PRINTR "and a closed trap door at your feet."
?L18:	FSET? TRAP-DOOR,OPENBIT \?L21
	PRINTR "and an open trap door at your feet."
?L21:	PRINTR "and a large oriental rug in the center of the room."
?L1:	EQUAL? RARG,M-END \FALSE
	EQUAL? PRSA,V?TAKE /?L30
	EQUAL? PRSA,V?PUT \FALSE
	EQUAL? PRSI,TROPHY-CASE \FALSE
?L30:	IN? PRSO,TROPHY-CASE \?L31
	CALL TOUCH-ALL,PRSO
?L31:	SET '?TMP,BASE-SCORE
	CALL OTVAL-FROB >STACK
	ADD ?TMP,STACK >SCORE
	CALL SCORE-UPD,0
	RFALSE

	.FUNCT TOUCH-ALL,OBJ,F
	FIRST? OBJ >F \TRUE
?L4:	FSET F,TOUCHBIT
	FIRST? F >STACK \?L7
	CALL TOUCH-ALL,F
?L7:	NEXT? F >F /?L4
	RTRUE

	.FUNCT OTVAL-FROB,O=TROPHY-CASE,F,SCORE?1=0
	FIRST? O >F /?L4
	RETURN SCORE?1
?L4:	GETP F,P?TVALUE >STACK
	ADD SCORE?1,STACK >SCORE?1
	FIRST? F >STACK \?L7
	CALL OTVAL-FROB,F
?L7:	NEXT? F >F /?L4
	RETURN SCORE?1

	.FUNCT TRAP-DOOR-FCN
	EQUAL? PRSA,V?RAISE \?L1
	CALL PERFORM,V?OPEN,TRAP-DOOR
	RTRUE
?L1:	EQUAL? PRSA,V?CLOSE,V?OPEN \?L3
	EQUAL? HERE,LIVING-ROOM \?L3
	CALL OPEN-CLOSE,PRSO,STR?94,STR?93 >STACK
	RSTACK
?L3:	EQUAL? PRSA,V?LOOK-UNDER \?L4
	EQUAL? HERE,LIVING-ROOM \?L4
	FSET? TRAP-DOOR,OPENBIT \?L5
	PRINTR "You see a rickety staircase descending into darkness."
?L5:	PRINTR "It's closed."
?L4:	EQUAL? HERE,CELLAR \FALSE
	EQUAL? PRSA,V?UNLOCK,V?OPEN \?L13
	FSET? TRAP-DOOR,OPENBIT /?L13
	PRINTR "The door is locked from above."
?L13:	EQUAL? PRSA,V?CLOSE \?L17
	FSET? TRAP-DOOR,OPENBIT /?L17
	FCLEAR TRAP-DOOR,TOUCHBIT
	FCLEAR TRAP-DOOR,OPENBIT
	PRINTR "The door closes and locks."
?L17:	EQUAL? PRSA,V?CLOSE,V?OPEN \FALSE
	CALL PICK-ONE,DUMMY >STACK
	PRINT STACK
	CRLF
	RTRUE

	.FUNCT CELLAR-FCN,RARG
	EQUAL? RARG,M-LOOK \?L1
	PRINTR "You are in a dark and damp cellar with a narrow passageway leading north, and a crawlway to the south. On the west is the bottom of a steep metal ramp which is unclimbable."
?L1:	EQUAL? RARG,M-ENTER \FALSE
	FSET? TRAP-DOOR,OPENBIT \FALSE
	FSET? TRAP-DOOR,TOUCHBIT /FALSE
	FCLEAR TRAP-DOOR,OPENBIT
	FSET TRAP-DOOR,TOUCHBIT
	PRINTI "The trap door crashes shut, and you hear someone barring it."
	CRLF
	CRLF
	RTRUE

	.FUNCT CHIMNEY-F
	EQUAL? PRSA,V?EXAMINE \FALSE
	PRINTI "The chimney leads "
	EQUAL? HERE,KITCHEN \?L5
	PRINTI "down"
	JUMP ?L9
?L5:	PRINTI "up"
?L9:	PRINTR "ward, and looks climbable."

	.FUNCT UP-CHIMNEY-FUNCTION,F
	FIRST? WINNER >F /?L1
	PRINTI "Going up empty-handed is a bad idea."
	CRLF
	RFALSE
?L1:	NEXT? F >F \?L6
	NEXT? F >STACK /?L5
?L6:	IN? LAMP,WINNER \?L5
	FSET? TRAP-DOOR,OPENBIT /?L7
	FCLEAR TRAP-DOOR,TOUCHBIT
?L7:	RETURN KITCHEN
?L5:	PRINTI "You can't get up there with what you're carrying."
	CRLF
	RFALSE

	.FUNCT TRAP-DOOR-EXIT
	ZERO? RUG-MOVED /?L1
	FSET? TRAP-DOOR,OPENBIT \?L3
	RETURN CELLAR
?L3:	PRINTI "The trap door is closed."
	CRLF
	CALL THIS-IS-IT,TRAP-DOOR
	RFALSE
?L1:	PRINTI "You can't go that way."
	CRLF
	RFALSE

	.FUNCT RUG-FCN
	EQUAL? PRSA,V?RAISE \?L1
	PRINTI "The rug is too heavy to lift"
	ZERO? RUG-MOVED /?L5
	PRINTR "."
?L5:	PRINTR ", but in trying to take it you have noticed an irregularity beneath it."
?L1:	EQUAL? PRSA,V?PUSH,V?MOVE \?L12
	ZERO? RUG-MOVED /?L13
	PRINTR "Having moved the carpet previously, you find it impossible to move it again."
?L13:	PRINTI "With a great effort, the rug is moved to one side of the room, revealing the dusty cover of a closed trap door."
	CRLF
	FCLEAR TRAP-DOOR,INVISIBLE
	CALL THIS-IS-IT,TRAP-DOOR
	SET 'RUG-MOVED,1
	RETURN RUG-MOVED
?L12:	EQUAL? PRSA,V?TAKE \?L20
	PRINTI "The rug is extremely heavy and cannot be carried."
	CRLF
	CALL PRINT-ID,STR?95 >STACK
	RSTACK
?L20:	EQUAL? PRSA,V?LOOK-UNDER \?L23
	ZERO? RUG-MOVED \?L23
	FSET? TRAP-DOOR,OPENBIT /?L23
	PRINTR "Underneath the rug is a closed trap door. As you drop the corner of the rug, the trap door is once again concealed from view."
?L23:	EQUAL? PRSA,V?CLIMB-ON \FALSE
	ZERO? RUG-MOVED \?L27
	FSET? TRAP-DOOR,OPENBIT /?L27
	PRINTR "As you sit, you notice an irregularity underneath it. Rather than be uncomfortable, you stand up again."
?L27:	PRINTR "I suppose you think it's a magic carpet?"

	.FUNCT AXE-F
	ZERO? TROLL-FLAG \FALSE
	CALL WEAPON-FUNCTION,AXE,TROLL >STACK
	RSTACK

	.FUNCT STILETTO-FUNCTION
	CALL WEAPON-FUNCTION,STILETTO,THIEF >STACK
	RSTACK

	.FUNCT WEAPON-FUNCTION,W,V
	IN? V,HERE \FALSE
	EQUAL? PRSA,V?TAKE \FALSE
	IN? W,V \?L4
	PRINTI "The "
	PRINTD V
	PRINTI " swings it out of your reach."
	CRLF
	CALL PRINT-ID,STR?96
	RTRUE
?L4:	PRINTI "The "
	PRINTD W
	PRINTR " seems white-hot. You can't hold on to it."

	.FUNCT TROLL-FCN,MODE=0
	EQUAL? PRSA,V?TELL \?L1
	SET 'P-CONT,0
	PRINTR "The troll isn't much of a conversationalist."
?L1:	EQUAL? MODE,F-BUSY? \?L5
	IN? AXE,TROLL /FALSE
	IN? AXE,HERE \?L8
	CALL ZPROB,75 >STACK
	ZERO? STACK /?L8
	FSET AXE,NDESCBIT
	FCLEAR AXE,WEAPONBIT
	MOVE AXE,TROLL
	PUTP TROLL,P?LDESC,STR?97
	IN? TROLL,HERE \TRUE
	PRINTR "The troll, angered and humiliated, recovers his weapon. He appears to have an axe to grind with you."
?L8:	IN? TROLL,HERE \FALSE
	PUTP TROLL,P?LDESC,STR?98
	PRINTR "The troll, disarmed, cowers in terror, pleading for his life in the guttural tongue of the trolls."
?L5:	EQUAL? MODE,F-DEAD \?L17
	IN? AXE,TROLL \?L18
	MOVE AXE,HERE
	FCLEAR AXE,NDESCBIT
	FSET AXE,WEAPONBIT
?L18:	SET 'TROLL-FLAG,1
	RETURN TROLL-FLAG
?L17:	EQUAL? MODE,F-UNCONSCIOUS \?L21
	FCLEAR TROLL,FIGHTBIT
	IN? AXE,TROLL \?L22
	MOVE AXE,HERE
	FCLEAR AXE,NDESCBIT
	FSET AXE,WEAPONBIT
?L22:	PUTP TROLL,P?LDESC,STR?99
	SET 'TROLL-FLAG,1
	RETURN TROLL-FLAG
?L21:	EQUAL? MODE,F-CONSCIOUS \?L25
	IN? TROLL,HERE \?L26
	FSET TROLL,FIGHTBIT
	PRINTI "The troll stirs, quickly resuming a fighting stance."
	CRLF
?L26:	IN? AXE,TROLL \?L31
	PUTP TROLL,P?LDESC,STR?97
	JUMP ?L34
?L31:	IN? AXE,TROLL-ROOM \?L33
	FSET AXE,NDESCBIT
	FCLEAR AXE,WEAPONBIT
	MOVE AXE,TROLL
	PUTP TROLL,P?LDESC,STR?97
	JUMP ?L34
?L33:	PUTP TROLL,P?LDESC,STR?100
?L34:	SET 'TROLL-FLAG,0
	RETURN TROLL-FLAG
?L25:	EQUAL? MODE,F-FIRST? \?L35
	RANDOM 100 >STACK
	GRTR? 33,STACK \FALSE
	FSET TROLL,FIGHTBIT
	SET 'P-CONT,0
	RTRUE
?L35:	ZERO? MODE \FALSE
	EQUAL? PRSA,V?EXAMINE \?L40
	GETP TROLL,P?LDESC >STACK
	PRINT STACK
	CRLF
	RTRUE
?L40:	EQUAL? PRSA,V?GIVE,V?THROW \?L46
	ZERO? PRSO /?L46
	EQUAL? PRSI,TROLL /?L45
?L46:	EQUAL? PRSA,V?MUNG,V?MOVE,V?TAKE \?L44
?L45:	CALL AWAKEN,TROLL
	EQUAL? PRSA,V?GIVE,V?THROW \?L47
	EQUAL? PRSO,AXE \?L49
	IN? AXE,WINNER \?L49
	PRINTI "The troll scratches his head in confusion, then takes the axe."
	CRLF
	CALL PRINT-ID,STR?101
	FSET TROLL,FIGHTBIT
	MOVE AXE,TROLL
	RTRUE
?L49:	EQUAL? PRSO,TROLL,AXE \?L53
	PRINTI "You would have to get the "
	PRINTD PRSO
	PRINTR " first, and that seems unlikely."
?L53:	EQUAL? PRSA,V?THROW \?L57
	PRINTI "The troll, who is remarkably coordinated, catches the "
	PRINTD PRSO
	FSET? PRSO,WEAPONBIT /?L61
	PUSH 0
	JUMP ?L62
?L61:	PUSH 1
?L62:	CALL PRINT-ID,STR?102,STACK
	JUMP ?L63
?L57:	PRINTI "The troll, who is not overly proud, graciously accepts the gift"
?L63:	RANDOM 100 >STACK
	GRTR? 20,STACK \?L66
	EQUAL? PRSO,KNIFE,SWORD,AXE \?L70
	CALL REMOVE-CAREFULLY,PRSO
	PRINTI " and eats it hungrily. Poor troll, he dies from an internal hemorrhage and his carcass disappears in a sinister black fog."
	CRLF
	CALL PRINT-ID,STR?103
	CALL REMOVE-CAREFULLY,TROLL
	GETP TROLL,P?ACTION >STACK
	CALL STACK,F-DEAD >STACK
	SET 'TROLL-FLAG,1
	RETURN TROLL-FLAG
?L66:	EQUAL? PRSO,KNIFE,SWORD,AXE \?L70
	MOVE PRSO,HERE
	PRINTI " and, being for the moment sated, throws it back. Fortunately, the troll has poor control, and the "
	PRINTD PRSO
	PRINTI " falls to the floor. He does not look pleased."
	CRLF
	FSET TROLL,FIGHTBIT
	RTRUE
?L70:	PRINTI " and not having the most discriminating tastes, gleefully eats it."
	CRLF
	CALL DANGEROUS-TO-GIVE-TROLL? >STACK
	CALL PRINT-ID,STR?104,STACK
	CALL REMOVE-CAREFULLY,PRSO >STACK
	RSTACK
?L47:	EQUAL? PRSA,V?MOVE,V?TAKE \?L76
	PRINTR "The troll spits in your face, grunting ""Better luck next time"" in a rather barbarous accent."
?L76:	EQUAL? PRSA,V?MUNG \FALSE
	PRINTI "The troll laughs at your puny gesture."
	CRLF
	CALL PRINT-ID,STR?105 >STACK
	RSTACK
?L44:	EQUAL? PRSA,V?LISTEN \?L83
	PRINTR "Every so often the troll says something, probably uncomplimentary, in his guttural tongue."
?L83:	ZERO? TROLL-FLAG /FALSE
	EQUAL? PRSA,V?HELLO \FALSE
	PRINTR "Unfortunately, the troll can't hear you."

	.FUNCT LEAVES-APPEAR
	FSET? GRATE,OPENBIT /FALSE
	ZERO? GRATE-REVEALED \FALSE
	EQUAL? PRSA,V?TAKE,V?MOVE \?L3
	PRINTI "In disturbing the pile of leaves, a grating is revealed."
	CRLF
	JUMP ?L7
?L3:	PRINTI "With the leaves moved, a grating is revealed."
	CRLF
?L7:	FCLEAR GRATE,INVISIBLE
	SET 'GRATE-REVEALED,1
	RFALSE

	.FUNCT LEAF-PILE
	EQUAL? PRSA,V?COUNT \?L1
	PRINTR "There are 69,105 leaves here."
?L1:	EQUAL? PRSA,V?BURN \?L5
	CALL LEAVES-APPEAR
	CALL REMOVE-CAREFULLY,PRSO
	IN? PRSO,HERE \?L6
	PRINTI "The leaves burn."
	CRLF
	CALL PRINT-ID,STR?106 >STACK
	RSTACK
?L6:	CALL PRINT-ID,STR?107
	CALL JIGS-UP,STR?108 >STACK
	RSTACK
?L5:	EQUAL? PRSA,V?CUT \?L11
	PRINTI "You rustle the leaves around, making quite a mess."
	CRLF
	CALL LEAVES-APPEAR
	RTRUE
?L11:	EQUAL? PRSA,V?TAKE,V?MOVE \?L14
	EQUAL? PRSA,V?MOVE \?L15
	PRINTI "Done."
	CRLF
?L15:	ZERO? GRATE-REVEALED \FALSE
	CALL LEAVES-APPEAR
	EQUAL? PRSA,V?TAKE \TRUE
	RFALSE
?L14:	EQUAL? PRSA,V?LOOK-UNDER \FALSE
	ZERO? GRATE-REVEALED \FALSE
	PRINTR "Underneath the pile of leaves is a grating. As you release the leaves, the grating is once again concealed from view."

	.FUNCT CLEARING-FCN,RARG
	EQUAL? RARG,M-ENTER \?L1
	ZERO? GRATE-REVEALED \FALSE
	FSET GRATE,INVISIBLE
	RTRUE
?L1:	EQUAL? RARG,M-LOOK \FALSE
	PRINTI "You are in a clearing, with a forest surrounding you on all sides. A path leads south."
	FSET? GRATE,OPENBIT \?L9
	CRLF
	PRINTR "There is an open grating, descending into darkness."
?L9:	ZERO? GRATE-REVEALED /?L13
	CRLF
	PRINTI "There is a grating securely fastened into the ground."
?L13:	CRLF
	RTRUE

	.FUNCT MAZE-11-FCN,RARG
	EQUAL? RARG,M-ENTER \?L1
	FCLEAR GRATE,INVISIBLE
	RTRUE
?L1:	EQUAL? RARG,M-LOOK \FALSE
	PRINTI "You are in a small room near the maze. There are twisty passages in the immediate vicinity."
	CRLF
	FSET? GRATE,OPENBIT \?L6
	PRINTR "Above you is an open grating with sunlight pouring in."
?L6:	ZERO? GRUNLOCK /?L10
	PRINTR "Above you is a grating."
?L10:	PRINTR "Above you is a grating locked with a skull-and-crossbones lock."

	.FUNCT GRATE-FUNCTION
	EQUAL? PRSA,V?OPEN \?L1
	EQUAL? PRSI,KEYS \?L1
	CALL PERFORM,V?UNLOCK,GRATE,KEYS
	RTRUE
?L1:	EQUAL? PRSA,V?LOCK \?L3
	EQUAL? HERE,GRATING-ROOM \?L4
	SET 'GRUNLOCK,0
	PRINTR "The grate is locked."
?L4:	EQUAL? HERE,GRATING-CLEARING \FALSE
	PRINTR "You can't lock it from this side."
?L3:	EQUAL? PRSA,V?UNLOCK \?L12
	EQUAL? PRSO,GRATE \?L12
	EQUAL? HERE,GRATING-ROOM \?L13
	EQUAL? PRSI,KEYS \?L13
	SET 'GRUNLOCK,1
	PRINTR "The grate is unlocked."
?L13:	EQUAL? HERE,GRATING-CLEARING \?L17
	EQUAL? PRSI,KEYS \?L17
	PRINTR "You can't reach the lock from here."
?L17:	PRINTI "Can you unlock a grating with a "
	PRINTD PRSI
	PRINTR "?"
?L12:	EQUAL? PRSA,V?PICK \?L23
	PRINTI "You can't pick the lock."
	CRLF
	CALL PRINT-ID,STR?109 >STACK
	RSTACK
?L23:	EQUAL? PRSA,V?CLOSE,V?OPEN \?L26
	ZERO? GRUNLOCK /?L27
	EQUAL? HERE,CLEARING \?L29
	PUSH STR?111
	JUMP ?L31
?L29:	PUSH STR?112
?L31:	CALL OPEN-CLOSE,GRATE,STACK,STR?110
	FSET? GRATE,OPENBIT \?L32
	EQUAL? HERE,CLEARING /?L34
	ZERO? GRATE-REVEALED \?L34
	PRINTI "A pile of leaves falls onto your head and to the ground."
	CRLF
	SET 'GRATE-REVEALED,1
	MOVE LEAVES,HERE
?L34:	FSET GRATING-ROOM,ONBIT
	RTRUE
?L32:	FCLEAR GRATING-ROOM,ONBIT
	RTRUE
?L27:	PRINTR "The grating is locked."
?L26:	EQUAL? PRSA,V?PUT \FALSE
	EQUAL? PRSI,GRATE \FALSE
	GETP PRSO,P?SIZE >STACK
	GRTR? STACK,20 \?L44
	PRINTR "It won't fit through the grating."
?L44:	MOVE PRSO,GRATING-ROOM
	PRINTI "The "
	PRINTD PRSO
	PRINTR " goes through the grating into the darkness below."

	.FUNCT MAZE-DIODES
	PRINTI "You won't be able to get back up to the tunnel you are going through when it gets to the next room."
	CRLF
	CRLF
	EQUAL? HERE,MAZE-2 \?L3
	RETURN MAZE-4
?L3:	EQUAL? HERE,MAZE-7 \?L5
	RETURN DEAD-END-1
?L5:	EQUAL? HERE,MAZE-9 \?L6
	RETURN MAZE-11
?L6:	EQUAL? HERE,MAZE-12 \FALSE
	RETURN MAZE-5

	.FUNCT RUSTY-KNIFE-FCN
	EQUAL? PRSA,V?TAKE \?L1
	IN? SWORD,WINNER \FALSE
	PRINTI "As you touch the rusty knife, your sword gives a single pulse of blinding blue light."
	CRLF
	RFALSE
?L1:	EQUAL? PRSI,RUSTY-KNIFE \?L9
	EQUAL? PRSA,V?ATTACK /?L8
?L9:	EQUAL? PRSA,V?SWING \FALSE
	EQUAL? PRSO,RUSTY-KNIFE \FALSE
	ZERO? PRSI /FALSE
?L8:	CALL REMOVE-CAREFULLY,RUSTY-KNIFE
	CALL PRINT-ID,STR?113
	CALL JIGS-UP,STR?114 >STACK
	RSTACK

	.FUNCT KNIFE-F
	EQUAL? PRSA,V?TAKE \FALSE
	FCLEAR ATTIC-TABLE,NDESCBIT
	RFALSE

	.FUNCT SKELETON
	EQUAL? PRSA,V?MOVE,V?RUB,V?TAKE /?L3
	EQUAL? PRSA,V?LOWER,V?RAISE,V?PUSH /?L3
	EQUAL? PRSA,V?KISS,V?KICK,V?ATTACK \FALSE
?L3:	PRINTI "A ghost appears in the room and is appalled at your desecration of the remains of a fellow adventurer. He casts a curse on your valuables and banishes them to the Land of the Living Dead. The ghost leaves, muttering obscenities."
	CRLF
	CALL PRINT-ID,STR?115
	CALL ROB,HERE,LAND-OF-LIVING-DEAD,100
	CALL ROB,ADVENTURER,LAND-OF-LIVING-DEAD
	RTRUE

	.FUNCT TORCH-OBJECT
	EQUAL? PRSA,V?EXAMINE \?L1
	PRINTR "The torch is burning."
?L1:	EQUAL? PRSA,V?POUR-ON \?L5
	EQUAL? PRSI,TORCH \?L5
	PRINTR "The water evaporates before it gets close."
?L5:	EQUAL? PRSA,V?LAMP-OFF \FALSE
	FSET? PRSO,ONBIT \FALSE
	PRINTI "You nearly burn your hand trying to extinguish the flame."
	CRLF
	CALL PRINT-ID,STR?116 >STACK
	RSTACK

	.FUNCT MIRROR-ROOM,RARG
	EQUAL? RARG,M-LOOK \FALSE
	PRINTI "You are in a large square room with tall ceilings. On the south wall is an enormous mirror which fills the entire wall. There are exits on the other three sides of the room."
	CRLF
	ZERO? MIRROR-MUNG /FALSE
	PRINTR "Unfortunately, the mirror has been destroyed by your recklessness."

	.FUNCT MIRROR-MIRROR,RM2=MIRROR-ROOM-2,L1,L2,N
	ZERO? MIRROR-MUNG \?L1
	EQUAL? PRSA,V?RUB \?L1
	EQUAL? PRSI,0,HANDS /?L3
	PRINTI "You feel a faint tingling transmitted through the "
	PRINTD PRSI
	PRINTR "."
?L3:	EQUAL? HERE,RM2 \?L8
	SET 'RM2,MIRROR-ROOM-1
?L8:	FIRST? HERE >L1 /?L11
?L11:	FIRST? RM2 >L2 /?L12
?L12:	ZERO? L1 /?L14
	NEXT? L1 >N /?L18
?L18:	MOVE L1,RM2
	SET 'L1,N
	JUMP ?L12
?L14:	ZERO? L2 /?L20
	NEXT? L2 >N /?L24
?L24:	MOVE L2,HERE
	SET 'L2,N
	JUMP ?L14
?L20:	CALL GOTO,RM2,0
	PRINTR "There is a rumble from deep within the earth and the room shakes."
?L1:	EQUAL? PRSA,V?EXAMINE,V?LOOK-INSIDE \?L27
	ZERO? MIRROR-MUNG /?L28
	PRINTR "The mirror is broken into many pieces."
?L28:	PRINTR "There is an ugly person staring back at you."
?L27:	EQUAL? PRSA,V?TAKE \?L35
	PRINTR "The mirror is many times your size. Give up."
?L35:	EQUAL? PRSA,V?ATTACK,V?THROW,V?MUNG \FALSE
	ZERO? MIRROR-MUNG /?L39
	PRINTR "Haven't you done enough damage already?"
?L39:	CALL PRINT-ID,STR?117
	SET 'MIRROR-MUNG,1
	SET 'LUCKY,0
	PRINTR "You have broken the mirror. I hope you have a seven years' supply of good luck handy."

	.FUNCT TORCH-ROOM-FCN,RARG
	EQUAL? RARG,M-LOOK \FALSE
	PRINTI "This is a large room with a prominent doorway leading to a down staircase. Above you is a large dome. Up around the edge of the dome (20 feet up) is a wooden railing. In the center of the room sits a white marble pedestal."
	CRLF
	ZERO? DOME-FLAG /FALSE
	PRINTR "A piece of rope descends from the railing above, ending some five feet above your head."

	.FUNCT DOME-ROOM-FCN,RARG
	EQUAL? RARG,M-LOOK \?L1
	PRINTI "You are at the periphery of a large dome, which forms the ceiling of another room below. Protecting you from a precipitous drop is a wooden railing which circles the dome."
	CRLF
	ZERO? DOME-FLAG /FALSE
	PRINTR "Hanging down from the railing is a rope which ends about ten feet from the floor below."
?L1:	EQUAL? RARG,M-ENTER \FALSE
	ZERO? DEAD /?L11
	PRINTI "As you enter the dome you feel a strong pull as if from a wind drawing you over the railing and down."
	CRLF
	MOVE WINNER,TORCH-ROOM
	SET 'HERE,TORCH-ROOM
	RTRUE
?L11:	EQUAL? PRSA,V?LEAP \FALSE
	CALL PRINT-ID,STR?118
	CALL JIGS-UP,STR?119 >STACK
	RSTACK

	.FUNCT LLD-ROOM,RARG
	EQUAL? RARG,M-LOOK \?L1
	PRINTI "You are outside a large gateway, on which is inscribed

  Abandon every hope all ye who enter here!

The gate is open; through it you can see a desolation, with a pile of mangled bodies in one corner. Thousands of voices, lamenting some hideous fate, can be heard."
	CRLF
	ZERO? LLD-FLAG \FALSE
	ZERO? DEAD \FALSE
	PRINTR "The way through the gate is barred by evil spirits, who jeer at your attempts to pass."
?L1:	EQUAL? RARG,M-BEG \?L10
	EQUAL? PRSA,V?EXORCISE \?L11
	ZERO? LLD-FLAG \FALSE
	IN? BELL,WINNER \?L15
	IN? BOOK,WINNER \?L15
	IN? CANDLES,WINNER \?L15
	PRINTR "You must perform the ceremony."
?L15:	PRINTR "You aren't equipped for an exorcism."
?L11:	ZERO? LLD-FLAG \?L23
	EQUAL? PRSA,V?RING \?L23
	EQUAL? PRSO,BELL \?L23
	SET 'XB,1
	CALL REMOVE-CAREFULLY,BELL
	CALL THIS-IS-IT,HOT-BELL
	MOVE HOT-BELL,HERE
	PRINTI "The bell suddenly becomes red hot and falls to the ground. The wraiths, as if paralyzed, stop their jeering and slowly turn to face you. On their ashen faces, the expression of a long-forgotten terror takes shape."
	CRLF
	IN? CANDLES,WINNER \?L26
	PRINTI "In your confusion, the candles drop to the ground (and they are out)."
	CRLF
	MOVE CANDLES,HERE
	FCLEAR CANDLES,ONBIT
	CALL INT,I-CANDLES >STACK
	PUT STACK,0,0
?L26:	CALL QUEUE,I-XB,6 >STACK
	PUT STACK,0,1
	CALL QUEUE,I-XBH,20 >STACK
	PUT STACK,0,1
	RTRUE
?L23:	ZERO? XC /FALSE
	EQUAL? PRSA,V?READ \FALSE
	EQUAL? PRSO,BOOK \FALSE
	ZERO? LLD-FLAG \FALSE
	PRINTI "Each word of the prayer reverberates through the hall in a deafening confusion. As the last word fades, a voice, loud and commanding, speaks: ""Begone, fiends!"" A heart-stopping scream fills the cavern, and the spirits, sensing a greater power, flee through the walls."
	CRLF
	CALL REMOVE-CAREFULLY,GHOSTS
	SET 'LLD-FLAG,1
	CALL INT,I-XC >STACK
	PUT STACK,0,0
	RTRUE
?L10:	EQUAL? RARG,M-END \FALSE
	ZERO? XB /FALSE
	IN? CANDLES,WINNER \FALSE
	FSET? CANDLES,ONBIT \FALSE
	ZERO? XC \FALSE
	SET 'XC,1
	PRINTI "The flames flicker wildly and appear to dance. The earth beneath your feet trembles, and your legs nearly buckle beneath you. The spirits cower at your unearthly power."
	CRLF
	CALL INT,I-XB >STACK
	PUT STACK,0,0
	CALL QUEUE,I-XC,3 >STACK
	PUT STACK,0,1
	RTRUE

	.FUNCT I-XB
	ZERO? XC \?L3
	EQUAL? HERE,ENTRANCE-TO-HADES \?L3
	PRINTI "The tension of this ceremony is broken, and the wraiths, amused but shaken at your clumsy attempt, resume their hideous jeering."
	CRLF
?L3:	SET 'XB,0
	RETURN XB

	.FUNCT I-XC
	SET 'XC,0
	CALL I-XB >STACK
	RSTACK

	.FUNCT I-XBH
	CALL REMOVE-CAREFULLY,HOT-BELL
	MOVE BELL,ENTRANCE-TO-HADES
	EQUAL? HERE,ENTRANCE-TO-HADES \FALSE
	PRINTR "The bell appears to have cooled down."

	.FUNCT DAM-ROOM-FCN,RARG
	EQUAL? RARG,M-LOOK \FALSE
	PRINTI "You are standing on the top of the Flood Control Dam #3, which was quite a tourist attraction in times far distant. There are paths to the north, south, and west, and a scramble down."
	CRLF
	ZERO? LOW-TIDE /?L5
	ZERO? GATES-OPEN /?L9
	PRINTI "The water level behind the dam is low: The sluice gates have been opened. Water rushes through the dam and downstream."
	CRLF
	JUMP ?L15
?L5:	ZERO? GATES-OPEN /?L9
	PRINTI "The sluice gates are open, and water rushes through the dam. The water level behind the dam is still high."
	CRLF
	JUMP ?L15
?L9:	ZERO? LOW-TIDE /?L12
	PRINTI "The sluice gates are closed. The water level in the reservoir is quite low, but the level is rising quickly."
	CRLF
	JUMP ?L15
?L12:	PRINTI "The sluice gates on the dam are closed. Behind the dam, there can be seen a wide reservoir. Water is pouring over the top of the now abandoned dam."
	CRLF
?L15:	PRINTI "There is a control panel here, on which a large metal bolt is mounted. Directly above the bolt is a small green plastic bubble"
	ZERO? GATE-FLAG /?L20
	PRINTI " which is glowing serenely"
?L20:	PRINTR "."

	.FUNCT BOLT-F
	EQUAL? PRSA,V?TURN \?L1
	EQUAL? PRSI,WRENCH \?L3
	ZERO? GATE-FLAG /?L5
	FCLEAR RESERVOIR-SOUTH,TOUCHBIT
	ZERO? GATES-OPEN /?L7
	SET 'GATES-OPEN,0
	FCLEAR LOUD-ROOM,TOUCHBIT
	PRINTI "The sluice gates close and water starts to collect behind the dam."
	CRLF
	CALL QUEUE,I-RFILL,8 >STACK
	PUT STACK,0,1
	CALL QUEUE,I-REMPTY,0
	RTRUE
?L7:	SET 'GATES-OPEN,1
	PRINTI "The sluice gates open and water pours through the dam."
	CRLF
	CALL QUEUE,I-REMPTY,8 >STACK
	PUT STACK,0,1
	CALL QUEUE,I-RFILL,0
	RTRUE
?L5:	PRINTR "The bolt won't turn with your best effort."
?L3:	PRINTI "The bolt won't turn using the "
	PRINTD PRSI
	PRINTR "."
?L1:	EQUAL? PRSA,V?TAKE \?L20
	CALL PRINT-ID,STR?120
	CALL INTEGRAL-PART >STACK
	RSTACK
?L20:	EQUAL? PRSA,V?OIL \FALSE
	PRINTR "Hmm. It appears the tube contained glue, not oil. Turning the bolt won't get any easier...."

	.FUNCT BUBBLE-F
	EQUAL? PRSA,V?TAKE \FALSE
	CALL PRINT-ID,STR?121
	CALL INTEGRAL-PART >STACK
	RSTACK

	.FUNCT INTEGRAL-PART
	PRINTR "It is an integral part of the control panel."

	.FUNCT I-RFILL
	FSET RESERVOIR,NONLANDBIT
	FCLEAR RESERVOIR,RLANDBIT
	FCLEAR DEEP-CANYON,TOUCHBIT
	FCLEAR LOUD-ROOM,TOUCHBIT
	IN? TRUNK,RESERVOIR \?L1
	FSET TRUNK,INVISIBLE
?L1:	SET 'LOW-TIDE,0
	EQUAL? HERE,RESERVOIR \?L3
	LOC WINNER >STACK
	FSET? STACK,VEHBIT \?L5
	PRINTR "The boat lifts gently out of the mud and is now floating on the reservoir."
?L5:	CALL PRINT-ID,STR?122
	CALL JIGS-UP,STR?123
	RTRUE
?L3:	EQUAL? HERE,DEEP-CANYON \?L10
	PRINTR "A sound, like that of flowing water, starts to come from below."
?L10:	EQUAL? HERE,LOUD-ROOM \?L13
	PRINTI "All of a sudden, an alarmingly loud roaring sound fills the room. Filled with fear, you scramble away."
	CRLF
	CALL PICK-ONE,LOUD-RUNS >STACK
	CALL GOTO,STACK
	RTRUE
?L13:	EQUAL? HERE,RESERVOIR-NORTH,RESERVOIR-SOUTH \TRUE
	PRINTR "You notice that the water level has risen to the point that it is impossible to cross."

	.FUNCT I-REMPTY
	FSET RESERVOIR,RLANDBIT
	FCLEAR RESERVOIR,NONLANDBIT
	FCLEAR DEEP-CANYON,TOUCHBIT
	FCLEAR LOUD-ROOM,TOUCHBIT
	FCLEAR TRUNK,INVISIBLE
	SET 'LOW-TIDE,1
	EQUAL? HERE,RESERVOIR \?L1
	LOC WINNER >STACK
	FSET? STACK,VEHBIT \?L1
	PRINTR "The water level has dropped to the point at which the boat can no longer stay afloat. It sinks into the mud."
?L1:	EQUAL? HERE,DEEP-CANYON \?L5
	PRINTR "The roar of rushing water is quieter now."
?L5:	EQUAL? HERE,RESERVOIR-NORTH,RESERVOIR-SOUTH \TRUE
	PRINTR "The water level is now quite low here and you could easily cross over to the other side."

	.FUNCT BUTTON-F
	EQUAL? PRSA,V?READ \?L1
	PRINTR "They're greek to you."
?L1:	EQUAL? PRSA,V?PUSH \FALSE
	EQUAL? PRSO,BLUE-BUTTON \?L6
	ZERO? WATER-LEVEL \?L8
	FCLEAR LEAK,INVISIBLE
	PRINTI "There is a rumbling sound and a stream of water appears to burst from the east wall of the room (apparently, a leak has occurred in a pipe)."
	CRLF
	CALL PRINT-ID,STR?124
	SET 'WATER-LEVEL,1
	CALL QUEUE,I-MAINT-ROOM,-1 >STACK
	PUT STACK,0,1
	RTRUE
?L8:	PRINTR "The blue button appears to be jammed."
?L6:	EQUAL? PRSO,RED-BUTTON \?L15
	PRINTI "The lights within the room "
	FSET? HERE,ONBIT \?L18
	FCLEAR HERE,ONBIT
	PRINTR "shut off."
?L18:	FSET HERE,ONBIT
	PRINTR "come on."
?L15:	EQUAL? PRSO,BROWN-BUTTON \?L25
	FCLEAR DAM-ROOM,TOUCHBIT
	SET 'GATE-FLAG,0
	PRINTR "Click."
?L25:	EQUAL? PRSO,YELLOW-BUTTON \FALSE
	FCLEAR DAM-ROOM,TOUCHBIT
	SET 'GATE-FLAG,1
	PRINTR "Click."

	.FUNCT TOOL-CHEST-FCN
	EQUAL? PRSA,V?EXAMINE \?L1
	PRINTR "The chests are all empty."
?L1:	EQUAL? PRSA,V?PUT,V?OPEN,V?TAKE \?L5
	CALL REMOVE-CAREFULLY,TOOL-CHEST
	PRINTI "The chests are so rusty and corroded that they crumble when you touch them."
	CRLF
	CALL PRINT-ID,STR?125 >STACK
	RSTACK
?L5:	EQUAL? PRSA,V?OPEN \FALSE
	PRINTR "The chests are already open."

	.FUNCT I-MAINT-ROOM,HERE?
	EQUAL? HERE,MAINTENANCE-ROOM /?L1
	SET 'HERE?,0
	JUMP ?L2
?L1:	SET 'HERE?,1
?L2:	ZERO? HERE? /?L3
	PRINTI "The water level here is now "
	DIV WATER-LEVEL,2 >STACK
	GET DROWNINGS,STACK >STACK
	PRINT STACK
	CRLF
?L3:	INC 'WATER-LEVEL
	LESS? WATER-LEVEL,14 /?L10
	CALL MUNG-ROOM,MAINTENANCE-ROOM,STR?126
	CALL QUEUE,I-MAINT-ROOM,0
	ZERO? HERE? /TRUE
	CALL PRINT-ID,STR?127
	CALL JIGS-UP,STR?128
	RTRUE
?L10:	IN? WINNER,INFLATED-BOAT \TRUE
	EQUAL? HERE,MAINTENANCE-ROOM,DAM-ROOM,DAM-LOBBY \TRUE
	CALL JIGS-UP,STR?129
	RTRUE

	.FUNCT LEAK-FUNCTION
	GRTR? WATER-LEVEL,0 \FALSE
	EQUAL? PRSA,V?PUT-ON,V?PUT \?L3
	EQUAL? PRSO,PUTTY \?L3
	CALL FIX-MAINT-LEAK >STACK
	RSTACK
?L3:	EQUAL? PRSA,V?PLUG \FALSE
	EQUAL? PRSI,PUTTY \?L6
	CALL FIX-MAINT-LEAK >STACK
	RSTACK
?L6:	CALL WITH-TELL,PRSI >STACK
	RSTACK

	.FUNCT FIX-MAINT-LEAK
	SET 'WATER-LEVEL,-1
	CALL QUEUE,I-MAINT-ROOM,0
	PRINTR "By some miracle of Zorkian technology, you have managed to stop the leak in the dam."

	.FUNCT PUTTY-FCN
	EQUAL? PRSA,V?OIL \?L4
	EQUAL? PRSI,PUTTY /?L3
?L4:	EQUAL? PRSA,V?PUT \FALSE
	EQUAL? PRSO,PUTTY \FALSE
?L3:	PRINTR "The all-purpose gunk isn't a lubricant."

	.FUNCT TUBE-FUNCTION
	EQUAL? PRSA,V?PUT \?L1
	EQUAL? PRSI,TUBE \?L1
	PRINTR "The tube refuses to accept anything."
?L1:	EQUAL? PRSA,V?SQUEEZE \FALSE
	FSET? PRSO,OPENBIT \?L10
	IN? PUTTY,PRSO \?L6
	MOVE PUTTY,WINNER
	PRINTR "The viscous material oozes into your hand."
?L6:	FSET? PRSO,OPENBIT \?L10
	PRINTR "The tube is apparently empty."
?L10:	PRINTR "The tube is closed."

	.FUNCT DAM-FUNCTION
	EQUAL? PRSA,V?CLOSE,V?OPEN \?L1
	PRINTR "Sounds reasonable, but this isn't how."
?L1:	EQUAL? PRSA,V?PLUG \FALSE
	EQUAL? PRSI,HANDS \?L6
	PRINTR "Are you the little Dutch boy, then? Sorry, this is a big dam."
?L6:	PRINTI "With a "
	PRINTD PRSI
	PRINTR "? Do you know how big this dam is? You could only stop a tiny leak with that."

	.FUNCT WITH-TELL,OBJ
	PRINTI "With a "
	PRINTD OBJ
	PRINTR "?"

	.FUNCT RESERVOIR-SOUTH-FCN,RARG
	EQUAL? RARG,M-LOOK \FALSE
	ZERO? LOW-TIDE /?L3
	ZERO? GATES-OPEN /?L7
	PRINTI "You are in a long room, to the north of which was formerly a lake. However, with the water level lowered, there is merely a wide stream running through the center of the room."
	JUMP ?L13
?L3:	ZERO? GATES-OPEN /?L7
	PRINTI "You are in a long room. To the north is a large lake, too deep to cross. You notice, however, that the water level appears to be dropping at a rapid rate. Before long, it might be possible to cross to the other side from here."
	JUMP ?L13
?L7:	ZERO? LOW-TIDE /?L10
	PRINTI "You are in a long room, to the north of which is a wide area which was formerly a reservoir, but now is merely a stream. You notice, however, that the level of the stream is rising quickly and that before long it will be impossible to cross here."
	JUMP ?L13
?L10:	PRINTI "You are in a long room on the south shore of a large lake, far too deep and wide for crossing."
?L13:	CRLF
	PRINTR "There is a path along the stream to the east or west, a steep pathway climbing southwest along the edge of a chasm, and a path leading into a canyon to the southeast."

	.FUNCT RESERVOIR-FCN,RARG
	EQUAL? RARG,M-END \?L1
	LOC WINNER >STACK
	FSET? STACK,VEHBIT /?L1
	ZERO? GATES-OPEN \?L1
	ZERO? LOW-TIDE /?L1
	PRINTR "You notice that the water level here is rising rapidly. The currents are also becoming stronger. Staying here seems quite perilous!"
?L1:	EQUAL? RARG,M-LOOK \FALSE
	ZERO? LOW-TIDE /?L6
	PRINTR "You are on what used to be a large lake, but which is now a large mud pile. There are ""shores"" to the north and south."
?L6:	PRINTR "You are on the lake. Beaches can be seen north and south. Upstream a small stream enters the lake through a narrow cleft in the rocks. The dam can be seen downstream."

	.FUNCT RESERVOIR-NORTH-FCN,RARG
	EQUAL? RARG,M-LOOK \FALSE
	ZERO? LOW-TIDE /?L3
	ZERO? GATES-OPEN /?L7
	PRINTI "You are in a large cavernous room, the south of which was formerly a lake. However, with the water level lowered, there is merely a wide stream running through there."
	JUMP ?L13
?L3:	ZERO? GATES-OPEN /?L7
	PRINTI "You are in a large cavernous area. To the south is a wide lake, whose water level appears to be falling rapidly."
	JUMP ?L13
?L7:	ZERO? LOW-TIDE /?L10
	PRINTI "You are in a cavernous area, to the south of which is a very wide stream. The level of the stream is rising rapidly, and it appears that before long it will be impossible to cross to the other side."
	JUMP ?L13
?L10:	PRINTI "You are in a large cavernous room, north of a large lake."
?L13:	CRLF
	PRINTR "There is a slimy stairway leaving the room to the north."

	.FUNCT BOTTLE-FUNCTION,E?=0
	EQUAL? PRSA,V?THROW \?L1
	EQUAL? PRSO,BOTTLE \?L1
	CALL REMOVE-CAREFULLY,PRSO
	SET 'E?,1
	PRINTI "The bottle hits the far wall and shatters."
	CRLF
	CALL PRINT-ID,STR?130
	JUMP ?L9
?L1:	EQUAL? PRSA,V?MUNG \?L5
	SET 'E?,1
	CALL REMOVE-CAREFULLY,PRSO
	PRINTI "A brilliant maneuver destroys the bottle."
	CRLF
	CALL PRINT-ID,STR?131
	JUMP ?L9
?L5:	EQUAL? PRSA,V?SHAKE \?L9
	FSET? PRSO,OPENBIT \?L9
	IN? WATER,PRSO \?L9
	SET 'E?,1
?L9:	ZERO? E? /FALSE
	IN? WATER,PRSO \?L13
	PRINTI "The water spills to the floor and evaporates."
	CRLF
	CALL REMOVE-CAREFULLY,WATER
	RTRUE
?L13:	ZERO? E? \TRUE
	RFALSE

	.FUNCT CYCLOPS-FCN,COUNT
	SET 'COUNT,CYCLOWRATH
	EQUAL? WINNER,CYCLOPS \?L1
	ZERO? CYCLOPS-FLAG /?L3
	PRINTR "No use talking to him. He's fast asleep."
?L3:	EQUAL? PRSA,V?ODYSSEUS \?L7
	SET 'WINNER,ADVENTURER
	CALL PERFORM,V?ODYSSEUS
	RTRUE
?L7:	PRINTR "The cyclops prefers eating to making conversation."
?L1:	ZERO? CYCLOPS-FLAG /?L11
	EQUAL? PRSA,V?EXAMINE \?L12
	PRINTR "The cyclops is sleeping like a baby, albeit a very ugly one."
?L12:	EQUAL? PRSA,V?ATTACK,V?KICK,V?ALARM /?L17
	EQUAL? PRSA,V?MUNG,V?BURN \FALSE
?L17:	PRINTI "The cyclops yawns and stares at the thing that woke him up."
	CRLF
	CALL PRINT-ID,STR?132
	SET 'CYCLOPS-FLAG,0
	FSET CYCLOPS,FIGHTBIT
	LESS? COUNT,0 \?L20
	SUB 0,COUNT >CYCLOWRATH
	RETURN CYCLOWRATH
?L20:	SET 'CYCLOWRATH,COUNT
	RETURN CYCLOWRATH
?L11:	EQUAL? PRSA,V?EXAMINE \?L24
	PRINTR "A hungry cyclops is standing at the foot of the stairs."
?L24:	EQUAL? PRSA,V?GIVE \?L27
	EQUAL? PRSI,CYCLOPS \?L27
	EQUAL? PRSO,LUNCH \?L28
	LESS? COUNT,0 /?L30
	CALL REMOVE-CAREFULLY,LUNCH
	PRINTI "The cyclops says ""Mmm Mmm. I love hot peppers! But oh, could I use a drink. Perhaps I could drink the blood of that thing.""  From the gleam in his eye, it could be surmised that you are ""that thing""."
	CRLF
	SUB 0,COUNT >STACK
	CALL MIN,-1,STACK >CYCLOWRATH
?L30:	CALL QUEUE,I-CYCLOPS,-1 >STACK
	PUT STACK,0,1
	RTRUE
?L28:	EQUAL? PRSO,WATER /?L36
	EQUAL? PRSO,BOTTLE \?L35
	IN? WATER,BOTTLE \?L35
?L36:	LESS? COUNT,0 \?L37
	CALL REMOVE-CAREFULLY,WATER
	MOVE BOTTLE,HERE
	FSET BOTTLE,OPENBIT
	FCLEAR CYCLOPS,FIGHTBIT
	PRINTI "The cyclops takes the bottle, checks that it's open, and drinks the water. A moment later, he lets out a yawn that nearly blows you over, and then falls fast asleep (what did you put in that drink, anyway?)."
	CRLF
	SET 'CYCLOPS-FLAG,1
	RETURN CYCLOPS-FLAG
?L37:	PRINTR "The cyclops apparently is not thirsty and refuses your generous offer."
?L35:	EQUAL? PRSO,GARLIC \?L44
	PRINTR "The cyclops may be hungry, but there is a limit."
?L44:	PRINTI "The cyclops is not so stupid as to eat THAT!"
	CRLF
	CALL PRINT-ID,STR?133 >STACK
	RSTACK
?L27:	EQUAL? PRSA,V?MUNG,V?ATTACK,V?THROW \?L50
	CALL QUEUE,I-CYCLOPS,-1 >STACK
	PUT STACK,0,1
	EQUAL? PRSA,V?MUNG \?L51
	PRINTI """Do you think I'm as stupid as my father was?"", he says, dodging."
	CRLF
	CALL PRINT-ID,STR?134 >STACK
	RSTACK
?L51:	PRINTI "The cyclops shrugs but otherwise ignores your pitiful attempt."
	CRLF
	CALL PRINT-ID,STR?135
	EQUAL? PRSA,V?THROW \TRUE
	MOVE PRSO,HERE
	RTRUE
?L50:	EQUAL? PRSA,V?TAKE \?L61
	PRINTR "The cyclops doesn't take kindly to being grabbed."
?L61:	EQUAL? PRSA,V?TIE \?L64
	PRINTI "You cannot tie the cyclops, though he is fit to be tied."
	CRLF
	CALL PRINT-ID,STR?136 >STACK
	RSTACK
?L64:	EQUAL? PRSA,V?LISTEN \FALSE
	PRINTR "You can hear his stomach rumbling."

	.FUNCT I-CYCLOPS
	ZERO? CYCLOPS-FLAG \TRUE
	ZERO? DEAD \TRUE
	EQUAL? HERE,CYCLOPS-ROOM /?L4
	CALL INT,I-CYCLOPS >STACK
	PUT STACK,0,0
	RTRUE
?L4:	LESS? CYCLOWRATH,0 \?L8
	SUB 0,CYCLOWRATH >STACK
	JUMP ?L10
?L8:	PUSH CYCLOWRATH
?L10:	GRTR? STACK,5 \?L6
	CALL INT,I-CYCLOPS >STACK
	PUT STACK,0,0
	CALL PRINT-ID,STR?137
	CALL JIGS-UP,STR?138 >STACK
	RSTACK
?L6:	LESS? CYCLOWRATH,0 \?L12
	DEC 'CYCLOWRATH
	JUMP ?L14
?L12:	INC 'CYCLOWRATH
?L14:	ZERO? CYCLOPS-FLAG \FALSE
	LESS? CYCLOWRATH,0 \?L19
	SUB 0,CYCLOWRATH >STACK
	JUMP ?L21
?L19:	PUSH CYCLOWRATH
?L21:	DEC 'STACK
	GET CYCLOMAD,STACK >STACK
	PRINT STACK
	CRLF
	RTRUE

	.FUNCT CYCLOPS-ROOM-FCN,RARG
	EQUAL? RARG,M-LOOK \?L1
	PRINTI "This room has an exit on the northwest, and a staircase leading up."
	CRLF
	ZERO? CYCLOPS-FLAG /?L5
	ZERO? MAGIC-FLAG \?L10
	PRINTR "The cyclops is sleeping blissfully at the foot of the stairs."
?L5:	ZERO? MAGIC-FLAG /?L9
?L10:	PRINTR "The east wall, previously solid, now has a cyclops-sized opening in it."
?L9:	ZERO? CYCLOWRATH \?L12
	PRINTR "A cyclops, who looks prepared to eat horses (much less mere adventurers), blocks the staircase. From his state of health, and the bloodstains on the walls, you gather that he is not very friendly, though he likes people."
?L12:	GRTR? CYCLOWRATH,0 \?L15
	PRINTR "The cyclops is standing in the corner, eyeing you closely. I don't think he likes you very much. He looks extremely hungry, even for a cyclops."
?L15:	LESS? CYCLOWRATH,0 \FALSE
	PRINTR "The cyclops, having eaten the hot peppers, appears to be gasping. His enflamed tongue protrudes from his man-sized mouth."
?L1:	EQUAL? RARG,M-ENTER \FALSE
	ZERO? CYCLOWRATH /TRUE
	CALL INT,I-CYCLOPS >STACK
	PUT STACK,0,1
	RTRUE

	.FUNCT LOUD-ROOM-FCN,RARG,WRD
	EQUAL? RARG,M-LOOK \?L1
	PRINTI "This is a large room with a ceiling which cannot be detected from the ground. There is a narrow passage from east to west and a stone stairway leading upward."
	ZERO? LOUD-FLAG \?L7
	ZERO? GATES-OPEN \?L5
	ZERO? LOW-TIDE /?L5
?L7:	PRINTR " The room is eerie in its quietness."
?L5:	PRINTR " The room is deafeningly loud with an undetermined rushing sound. The sound seems to reverberate from all of the walls, making it difficult even to think."
?L1:	EQUAL? RARG,M-END \?L13
	ZERO? GATES-OPEN /?L13
	ZERO? LOW-TIDE \?L13
	PRINTI "It is unbearably loud here, with an ear-splitting roar seeming to come from all around you. There is a pounding in your head which won't stop. With a tremendous effort, you scramble out of the room."
	CRLF
	CRLF
	CALL PICK-ONE,LOUD-RUNS >STACK
	CALL GOTO,STACK
	RFALSE
?L13:	EQUAL? RARG,M-ENTER \FALSE
	ZERO? LOUD-FLAG \FALSE
	ZERO? GATES-OPEN \?L61
	ZERO? LOW-TIDE \FALSE
	ZERO? GATES-OPEN /?L20
?L61:	ZERO? LOW-TIDE /FALSE
?L20:	CALL V-FIRST-LOOK
	ZERO? P-CONT /?L22
	PRINTI "The rest of your commands have been lost in the noise."
	CRLF
	SET 'P-CONT,0
?L22:	ZERO? SUPER-BRIEF \?L29
	CRLF
?L29:	PRINTI ">"
	READ P-INBUF,P-LEXV
	GETB P-LEXV,P-LEXWORDS >STACK
	ZERO? STACK \?L34
	PRINTI "I beg your pardon?"
	CRLF
	JUMP ?L22
?L34:	GET P-LEXV,1 >WRD
	EQUAL? WRD,W?GO,W?WALK,W?RUN \?L39
	GET P-LEXV,3 >WRD
	JUMP ?L41
?L39:	EQUAL? WRD,W?SAY \?L41
	GET P-LEXV,5 >WRD
?L41:	EQUAL? WRD,W?SAVE \?L43
	CALL V-SAVE
	JUMP ?L22
?L43:	EQUAL? WRD,W?RESTORE \?L45
	CALL V-RESTORE
	JUMP ?L22
?L45:	EQUAL? WRD,W?Q,W?QUIT \?L46
	CALL V-QUIT
	JUMP ?L22
?L46:	EQUAL? WRD,W?W,W?WEST \?L47
	CALL GOTO,ROUND-ROOM >STACK
	RSTACK
?L47:	EQUAL? WRD,W?E,W?EAST \?L48
	CALL GOTO,DAMP-CAVE >STACK
	RSTACK
?L48:	EQUAL? WRD,W?U,W?UP \?L49
	CALL GOTO,DEEP-CANYON >STACK
	RSTACK
?L49:	EQUAL? WRD,W?BUG \?L50
	PRINTI "That's only your opinion."
	CRLF
	JUMP ?L22
?L50:	EQUAL? WRD,W?ECHO \?L53
	SET 'LOUD-FLAG,1
	FCLEAR BAR,SACREDBIT
	PRINTI "The acoustics of the room change subtly."
	CRLF
	ZERO? SUPER-BRIEF \TRUE
	CRLF
	RTRUE
?L53:	CALL V-ECHO
	JUMP ?L22

	.FUNCT DEEP-CANYON-F,RARG
	EQUAL? RARG,M-LOOK \FALSE
	PRINTI "You are on the south edge of a deep canyon. Passages lead off to the east, northwest and southwest. A stairway leads down."
	ZERO? GATES-OPEN /?L14
	ZERO? LOW-TIDE \?L5
	PRINTR " You can hear a loud roaring sound, like that of rushing water, from below."
?L5:	ZERO? GATES-OPEN \?L9
?L14:	ZERO? LOW-TIDE /?L9
	CRLF
	RTRUE
?L9:	PRINTR " You can hear the sound of flowing water from below."

	.FUNCT THIEF-VS-ADVENTURER,HERE?,ROBBED?,WINNER-ROBBED?=0
	ZERO? DEAD \?L1
	EQUAL? HERE,TREASURE-ROOM /FALSE
?L1:	ZERO? THIEF-HERE \?L3
	ZERO? DEAD \?L4
	ZERO? HERE? \?L81
	RANDOM 100 >STACK
	GRTR? 30,STACK \?L4
	IN? STILETTO,THIEF \FALSE
	FCLEAR THIEF,INVISIBLE
	PRINTI "Someone carrying a large bag is casually leaning against one of the walls here. He does not speak, but it is clear from his aspect that the bag will be taken only over his dead body."
	CRLF
	SET 'THIEF-HERE,1
	RTRUE
?L4:	ZERO? HERE? /?L15
?L81:	FSET? THIEF,FIGHTBIT \?L11
	CALL WINNING?,THIEF >STACK
	ZERO? STACK \?L11
	PRINTI "Your opponent, determining discretion to be the better part of valor, decides to terminate this little contretemps. With a rueful nod of his head, he steps backward into the gloom and disappears."
	CRLF
	FSET THIEF,INVISIBLE
	FCLEAR THIEF,FIGHTBIT
	CALL RECOVER-STILETTO
	RTRUE
?L11:	ZERO? HERE? /?L15
	FSET? THIEF,FIGHTBIT \?L14
	RANDOM 100 >STACK
	GRTR? 90,STACK /FALSE
?L14:	ZERO? HERE? /?L15
	RANDOM 100 >STACK
	GRTR? 30,STACK \?L15
	PRINTI "The holder of the large bag just left, looking disgusted. Fortunately, he took nothing."
	CRLF
	FSET THIEF,INVISIBLE
	CALL RECOVER-STILETTO
	RTRUE
?L15:	RANDOM 100 >STACK
	GRTR? 70,STACK /FALSE
	ZERO? DEAD \FALSE
	CALL ROB,HERE,THIEF,100 >STACK
	ZERO? STACK /?L20
	SET 'ROBBED?,HERE
	JUMP ?L22
?L20:	CALL ROB,WINNER,THIEF >STACK
	ZERO? STACK /?L22
	SET 'ROBBED?,PLAYER
?L22:	SET 'THIEF-HERE,1
	ZERO? ROBBED? /?L24
	ZERO? HERE? \?L82
	PRINTI "A seedy-looking individual with a large bag just wandered through the room. On the way through, he quietly abstracted some valuables from "
	EQUAL? ROBBED?,HERE \?L28
	PRINTI "the room"
	JUMP ?L32
?L28:	PRINTI "your possession"
?L32:	PRINTI ", mumbling something about ""Doing unto others before..."""
	CRLF
	CALL STOLE-LIGHT?
	RFALSE
?L24:	ZERO? HERE? /?L37
?L82:	CALL RECOVER-STILETTO
	ZERO? ROBBED? /?L38
	PRINTI "The thief just left, still carrying his large bag. You may not have noticed that he "
	EQUAL? ROBBED?,PLAYER \?L42
	PRINTI "robbed you blind first."
	JUMP ?L46
?L42:	PRINTI "appropriated the valuables in the room."
?L46:	CRLF
	CALL STOLE-LIGHT?
	JUMP ?L49
?L38:	PRINTI "The thief, finding nothing of value, left disgusted."
	CRLF
?L49:	FSET THIEF,INVISIBLE
	SET 'HERE?,0
	RTRUE
?L37:	PRINTR "A ""lean and hungry"" gentleman just wandered through, carrying a large bag. Finding nothing of value, he left disgruntled."
?L3:	ZERO? HERE? /FALSE
	RANDOM 100 >STACK
	GRTR? 30,STACK \FALSE
	CALL ROB,HERE,THIEF,100 >STACK
	ZERO? STACK /?L61
	SET 'ROBBED?,HERE
	JUMP ?L63
?L61:	CALL ROB,WINNER,THIEF >STACK
	ZERO? STACK /?L63
	SET 'ROBBED?,PLAYER
?L63:	ZERO? ROBBED? /?L65
	PRINTI "The thief just left, still carrying his large bag. You may not have noticed that he "
	EQUAL? ROBBED?,PLAYER \?L69
	PRINTI "robbed you blind first."
	JUMP ?L73
?L69:	PRINTI "appropriated the valuables in the room."
?L73:	CRLF
	CALL STOLE-LIGHT?
	JUMP ?L76
?L65:	PRINTI "The thief, finding nothing of value, left disgusted."
	CRLF
?L76:	FSET THIEF,INVISIBLE
	SET 'HERE?,0
	CALL RECOVER-STILETTO
	RFALSE

	.FUNCT STOLE-LIGHT?,OLD-LIT
	SET 'OLD-LIT,LIT
	CALL LIT?,HERE >LIT
	ZERO? LIT \TRUE
	ZERO? OLD-LIT /TRUE
	PRINTR "The thief seems to have left you in the dark."

	.FUNCT HACK-TREASURES,X
	CALL RECOVER-STILETTO
	FSET THIEF,INVISIBLE
	FIRST? TREASURE-ROOM >X \TRUE
?L4:	FCLEAR X,INVISIBLE
	NEXT? X >X /?L4
	RTRUE

	.FUNCT DEPOSIT-BOOTY,RM,X,N,FLG=0
	FIRST? THIEF >X /?L4
	RETURN FLG
?L1:	ZERO? X \?L4
	RETURN FLG
?L4:	NEXT? X >N /?L7
?L7:	EQUAL? X,STILETTO,LARGE-BAG /?L11
	GETP X,P?TVALUE >STACK
	GRTR? STACK,0 \?L11
	MOVE X,RM
	SET 'FLG,1
	EQUAL? X,EGG \?L11
	SET 'EGG-SOLVE,1
	FSET EGG,OPENBIT
?L11:	SET 'X,N
	JUMP ?L1

	.FUNCT ROB-MAZE,RM,X,N
	FIRST? RM >X /?L4
	RFALSE
?L1:	ZERO? X /FALSE
?L4:	NEXT? X >N /?L7
?L7:	FSET? X,TAKEBIT \?L8
	FSET? X,INVISIBLE /?L8
	RANDOM 100 >STACK
	GRTR? 40,STACK \?L8
	PRINTI "You hear, off in the distance, someone saying ""My, I wonder what this fine "
	PRINTD X
	PRINTI " is doing here."""
	CRLF
	CALL ZPROB,60 >STACK
	ZERO? STACK /TRUE
	MOVE X,THIEF
	FSET X,TOUCHBIT
	FSET X,INVISIBLE
	RTRUE
?L8:	SET 'X,N
	JUMP ?L1

	.FUNCT ROBBER-FUNCTION,MODE=0,FLG=0,X,N
	EQUAL? PRSA,V?TELL \?L1
	PRINTI "The thief is a strong, silent type."
	CRLF
	SET 'P-CONT,0
	RETURN P-CONT
?L1:	ZERO? MODE \?L5
	EQUAL? PRSA,V?HELLO \?L6
	GETP THIEF,P?LDESC >STACK
	EQUAL? STACK,ROBBER-U-DESC \?L6
	PRINTR "The thief, being temporarily incapacitated, is unable to acknowledge your greeting with his usual graciousness."
?L6:	EQUAL? PRSO,KNIFE \?L10
	EQUAL? PRSA,V?THROW \?L10
	FSET? THIEF,FIGHTBIT /?L10
	MOVE PRSO,HERE
	CALL ZPROB,10 >STACK
	ZERO? STACK /?L11
	PRINTI "You evidently frightened the robber, though you didn't hit him. He flees"
	CALL PRINT-ID,STR?139
	REMOVE LARGE-BAG
	SET 'X,0
	IN? STILETTO,THIEF \?L15
	REMOVE STILETTO
	SET 'X,1
?L15:	FIRST? THIEF >STACK \?L18
	CALL MOVE-ALL,THIEF,HERE
	PRINTI ", but the contents of his bag fall on the floor."
	JUMP ?L22
?L18:	PRINTI "."
?L22:	MOVE LARGE-BAG,THIEF
	ZERO? X /?L25
	MOVE STILETTO,THIEF
?L25:	CRLF
	FSET THIEF,INVISIBLE
	RTRUE
?L11:	PRINTI "You missed. The thief makes no attempt to take the knife, though it would be a fine addition to the collection in his bag. He does seem angered by your attempt."
	CRLF
	FSET THIEF,FIGHTBIT
	RTRUE
?L10:	EQUAL? PRSA,V?GIVE,V?THROW \?L31
	EQUAL? PRSO,0,THIEF /?L31
	EQUAL? PRSI,THIEF \?L31
	GETP THIEF,P?STRENGTH >STACK
	LESS? STACK,0 \?L32
	GETP THIEF,P?STRENGTH >STACK
	SUB 0,STACK >STACK
	PUTP THIEF,P?STRENGTH,STACK
	CALL INT,I-THIEF >STACK
	PUT STACK,0,1
	CALL RECOVER-STILETTO
	PUTP THIEF,P?LDESC,ROBBER-C-DESC
	PRINTI "Your proposed victim suddenly recovers consciousness."
	CRLF
?L32:	MOVE PRSO,THIEF
	GETP PRSO,P?TVALUE >STACK
	GRTR? STACK,0 \?L37
	SET 'THIEF-ENGROSSED,1
	PRINTI "The thief is taken aback by your unexpected generosity, but accepts the "
	PRINTD PRSO
	PRINTR " and stops to admire its beauty."
?L37:	PRINTI "The thief places the "
	PRINTD PRSO
	PRINTR " in his bag and thanks you politely."
?L31:	EQUAL? PRSA,V?TAKE \?L44
	PRINTR "Once you got him, what would you do with him?"
?L44:	EQUAL? PRSA,V?LOOK-INSIDE,V?EXAMINE \?L47
	PRINTR "The thief is a slippery character with beady eyes that flit back and forth. He carries, along with an unmistakable arrogance, a large bag over his shoulder and a vicious stiletto, whose blade is aimed menacingly in your direction. I'd watch out if I were you."
?L47:	EQUAL? PRSA,V?LISTEN \FALSE
	PRINTR "The thief says nothing, as you have not been formally introduced."
?L5:	EQUAL? MODE,F-BUSY? \?L54
	IN? STILETTO,THIEF /FALSE
	LOC THIEF >STACK
	IN? STILETTO,STACK \FALSE
	MOVE STILETTO,THIEF
	FSET STILETTO,NDESCBIT
	IN? THIEF,HERE \TRUE
	PRINTR "The robber, somewhat surprised at this turn of events, nimbly retrieves his stiletto."
?L54:	EQUAL? MODE,F-DEAD \?L64
	MOVE STILETTO,HERE
	FCLEAR STILETTO,NDESCBIT
	CALL DEPOSIT-BOOTY,HERE >X
	EQUAL? HERE,TREASURE-ROOM \?L65
	FIRST? HERE >X /?L70
?L72:	PRINTI "The chalice is now safe to take."
	CRLF
	JUMP ?L89
?L70:	EQUAL? X,CHALICE,THIEF,ADVENTURER /?L74
	FCLEAR X,INVISIBLE
	ZERO? FLG \?L75
	SET 'FLG,1
	PRINTI "As the thief dies, the power of his magic decreases, and his treasures reappear:"
	CRLF
?L75:	PRINTI "  A "
	PRINTD X
	FIRST? X >STACK \?L82
	CALL SEE-INSIDE?,X >STACK
	ZERO? STACK /?L82
	PRINTI ", with "
	CALL PRINT-CONTENTS,X
?L82:	CRLF
?L74:	NEXT? X >X /?L70
	JUMP ?L72
?L65:	ZERO? X /?L89
	PRINTI "His booty remains."
	CRLF
?L89:	CALL INT,I-THIEF >STACK
	PUT STACK,0,0
	RTRUE
?L64:	EQUAL? MODE,F-FIRST? \?L93
	ZERO? THIEF-HERE /FALSE
	FSET? THIEF,INVISIBLE /FALSE
	RANDOM 100 >STACK
	GRTR? 20,STACK \FALSE
	FSET THIEF,FIGHTBIT
	SET 'P-CONT,0
	RTRUE
?L93:	EQUAL? MODE,F-UNCONSCIOUS \?L97
	CALL INT,I-THIEF >STACK
	PUT STACK,0,0
	FCLEAR THIEF,FIGHTBIT
	MOVE STILETTO,HERE
	FCLEAR STILETTO,NDESCBIT
	PUTP THIEF,P?LDESC,ROBBER-U-DESC
	RTRUE
?L97:	EQUAL? MODE,F-CONSCIOUS \FALSE
	LOC THIEF >STACK
	EQUAL? STACK,HERE \?L99
	FSET THIEF,FIGHTBIT
	PRINTI "The robber revives, briefly feigning continued unconsciousness, and, when he sees his moment, scrambles away from you."
	CRLF
?L99:	CALL INT,I-THIEF >STACK
	PUT STACK,0,1
	PUTP THIEF,P?LDESC,ROBBER-C-DESC
	CALL RECOVER-STILETTO >STACK
	RSTACK

	.FUNCT LARGE-BAG-F
	EQUAL? PRSA,V?TAKE \?L1
	GETP THIEF,P?LDESC >STACK
	EQUAL? STACK,ROBBER-U-DESC \?L3
	PRINTI "Sadly for you, the robber collapsed on top of the bag. Trying to take it would wake him."
	CRLF
	CALL PRINT-ID,STR?140 >STACK
	RSTACK
?L3:	PRINTI "The bag will be taken over his dead body."
	CRLF
	CALL PRINT-ID,STR?141 >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?PUT \?L10
	EQUAL? PRSI,LARGE-BAG \?L10
	PRINTR "It would be a good trick."
?L10:	EQUAL? PRSA,V?CLOSE,V?OPEN \?L13
	PRINTR "Getting close enough would be a good trick."
?L13:	EQUAL? PRSA,V?LOOK-INSIDE,V?EXAMINE \FALSE
	PRINTR "The bag is underneath the thief, so one can't say what, if anything, is inside."

	.FUNCT MOVE-ALL,FROM,TO,X,N
	FIRST? FROM >X \FALSE
?L3:	ZERO? X /TRUE
	NEXT? X >N /?L8
?L8:	FCLEAR X,INVISIBLE
	MOVE X,TO
	SET 'X,N
	JUMP ?L3

	.FUNCT CHALICE-FCN
	EQUAL? PRSA,V?TAKE \?L1
	IN? PRSO,TREASURE-ROOM \FALSE
	IN? THIEF,TREASURE-ROOM \FALSE
	FSET? THIEF,FIGHTBIT \FALSE
	FSET? THIEF,INVISIBLE /FALSE
	GETP THIEF,P?LDESC >STACK
	EQUAL? STACK,ROBBER-U-DESC /FALSE
	PRINTR "You'd be stabbed in the back first."
?L1:	EQUAL? PRSA,V?PUT \?L8
	EQUAL? PRSI,CHALICE \?L8
	PRINTR "You can't. It's not a very good chalice, is it?"
?L8:	CALL DUMB-CONTAINER >STACK
	RSTACK

	.FUNCT TREASURE-ROOM-FCN,RARG,TL
	EQUAL? RARG,M-ENTER \FALSE
	CALL INT,I-THIEF >STACK
	GET STACK,C-ENABLED? >STACK
	EQUAL? STACK,1 \FALSE
	ZERO? DEAD \FALSE
	IN? THIEF,HERE /?L3
	PRINTI "You hear a scream of anguish as you violate the robber's hideaway. Using passages unknown to you, he rushes to its defense."
	CRLF
	MOVE THIEF,HERE
?L3:	FSET THIEF,FIGHTBIT
	FCLEAR THIEF,INVISIBLE
	CALL THIEF-IN-TREASURE >STACK
	RSTACK

	.FUNCT THIEF-IN-TREASURE,F,N
	FIRST? HERE >F \TRUE
	NEXT? F >STACK \?L2
	PRINTI "The thief gestures mysteriously, and the treasures in the room suddenly vanish."
	CRLF
	CRLF
?L2:	ZERO? F /TRUE
?L9:	EQUAL? F,CHALICE,THIEF /?L11
	FSET F,INVISIBLE
?L11:	NEXT? F >F /?L9
	RTRUE

	.FUNCT FRONT-DOOR-FCN
	EQUAL? PRSA,V?OPEN \?L1
	PRINTR "The door cannot be opened."
?L1:	EQUAL? PRSA,V?BURN \?L5
	PRINTI "You cannot burn this door."
	CRLF
	CALL PRINT-ID,STR?142 >STACK
	RSTACK
?L5:	EQUAL? PRSA,V?MUNG \?L8
	PRINTI "You can't seem to damage the door."
	CRLF
	CALL PRINT-ID,STR?143 >STACK
	RSTACK
?L8:	EQUAL? PRSA,V?LOOK-BEHIND \FALSE
	PRINTR "It won't open."

	.FUNCT BODY-FUNCTION
	EQUAL? PRSA,V?TAKE \?L1
	PRINTI "A force keeps you from taking the bodies."
	CRLF
	CALL PRINT-ID,STR?144 >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?BURN,V?MUNG \FALSE
	CALL PRINT-ID,STR?145
	CALL JIGS-UP,STR?146 >STACK
	RSTACK

	.FUNCT BLACK-BOOK
	EQUAL? PRSA,V?OPEN \?L1
	PRINTR "The book is already open to page 569."
?L1:	EQUAL? PRSA,V?CLOSE \?L5
	PRINTR "As hard as you try, the book cannot be closed."
?L5:	EQUAL? PRSA,V?TURN /?L9
	EQUAL? PRSA,V?READ-PAGE \?L8
	EQUAL? PRSI,INTNUM \?L8
	EQUAL? P-NUMBER,569 /?L8
?L9:	PRINTR "Beside page 569, there is only one other page with any legible printing on it. Most of it is unreadable, but the subject seems to be the banishment of evil. Apparently, certain noises, lights, and prayers are efficacious in this regard."
?L8:	EQUAL? PRSA,V?BURN \FALSE
	CALL REMOVE-CAREFULLY,PRSO
	CALL PRINT-ID,STR?147
	CALL JIGS-UP,STR?148 >STACK
	RSTACK

	.FUNCT PAINTING-FCN
	EQUAL? PRSA,V?MUNG \FALSE
	PUTP PRSO,P?TVALUE,0
	PUTP PRSO,P?LDESC,STR?149
	PRINTI "Congratulations! Unlike the other vandals, who merely stole the artist's masterpieces, you have destroyed one."
	CRLF
	CALL PRINT-ID,STR?150 >STACK
	RSTACK

	.FUNCT LANTERN
	EQUAL? PRSA,V?THROW \?L1
	PRINTI "The lamp has smashed into the floor, and the light has gone out."
	CRLF
	CALL PRINT-ID,STR?151
	CALL INT,I-LANTERN >STACK
	PUT STACK,0,0
	CALL REMOVE-CAREFULLY,LAMP
	MOVE BROKEN-LAMP,HERE
	RTRUE
?L1:	EQUAL? PRSA,V?LAMP-ON \?L5
	FSET? LAMP,RMUNGBIT \?L6
	PRINTR "A burned-out lamp won't light."
?L6:	CALL INT,I-LANTERN >STACK
	PUT STACK,0,1
	RFALSE
?L5:	EQUAL? PRSA,V?LAMP-OFF \?L11
	FSET? LAMP,RMUNGBIT \?L12
	PRINTR "The lamp has already burned out."
?L12:	CALL INT,I-LANTERN >STACK
	PUT STACK,0,0
	RFALSE
?L11:	EQUAL? PRSA,V?EXAMINE \FALSE
	PRINTI "The lamp "
	FSET? LAMP,RMUNGBIT \?L20
	PRINTR "has burned out."
?L20:	FSET? LAMP,ONBIT \?L24
	PRINTR "is on."
?L24:	PRINTR "is turned off."

	.FUNCT MAILBOX-F
	EQUAL? PRSA,V?TAKE \FALSE
	EQUAL? PRSO,MAILBOX \FALSE
	PRINTI "It is securely anchored."
	CRLF
	CALL PRINT-ID,STR?152 >STACK
	RSTACK

	.FUNCT MATCH-FUNCTION,CNT
	EQUAL? PRSA,V?BURN,V?LAMP-ON \?L1
	EQUAL? PRSO,MATCH \?L1
	GRTR? MATCH-COUNT,0 \?L8
	DEC 'MATCH-COUNT
	GRTR? MATCH-COUNT,0 /?L6
?L8:	PRINTR "I'm afraid that you have run out of matches."
?L6:	EQUAL? HERE,LOWER-SHAFT,TIMBER-ROOM \?L10
	PRINTR "This room is drafty, and the match goes out instantly."
?L10:	FSET MATCH,FLAMEBIT
	FSET MATCH,ONBIT
	CALL QUEUE,I-MATCH,2 >STACK
	PUT STACK,0,1
	PRINTI "One of the matches starts to burn."
	CRLF
	ZERO? LIT \TRUE
	SET 'LIT,1
	CALL V-LOOK
	RTRUE
?L1:	EQUAL? PRSA,V?LAMP-OFF \?L19
	FSET? MATCH,FLAMEBIT \?L19
	PRINTI "The match is out."
	CRLF
	FCLEAR MATCH,FLAMEBIT
	FCLEAR MATCH,ONBIT
	CALL LIT?,HERE >LIT
	ZERO? LIT \?L22
	PRINTI "It's pitch black in here!"
	CRLF
?L22:	CALL QUEUE,I-MATCH,0
	RTRUE
?L19:	EQUAL? PRSA,V?OPEN,V?COUNT \?L27
	PRINTI "You have "
	SUB MATCH-COUNT,1 >CNT
	GRTR? CNT,0 /?L30
	PRINTI "no"
	JUMP ?L34
?L30:	PRINTN CNT
?L34:	PRINTI " match"
	EQUAL? CNT,1 /?L39
	PRINTR "es."
?L39:	PRINTR "."
?L27:	EQUAL? PRSA,V?EXAMINE \FALSE
	FSET? MATCH,ONBIT \?L47
	PRINTR "The match is burning."
?L47:	PRINTR "The matchbook isn't very interesting, except for what's written on it."

	.FUNCT I-MATCH
	PRINTI "The match has gone out."
	CRLF
	CALL PRINT-ID,STR?153
	FCLEAR MATCH,FLAMEBIT
	FCLEAR MATCH,ONBIT
	CALL LIT?,HERE >LIT
	RTRUE

	.FUNCT I-LANTERN,TICK,TBL
	SET 'TBL,LAMP-TABLE
	GET TBL,0 >TICK
	CALL QUEUE,I-LANTERN,TICK >STACK
	PUT STACK,0,1
	CALL LIGHT-INT,LAMP,TBL,TICK
	ZERO? TICK /FALSE
	ADD TBL,4 >LAMP-TABLE
	RETURN LAMP-TABLE

	.FUNCT I-CANDLES,TICK,TBL
	SET 'TBL,CANDLE-TABLE
	FSET CANDLES,TOUCHBIT
	GET TBL,0 >TICK
	CALL QUEUE,I-CANDLES,TICK >STACK
	PUT STACK,0,1
	CALL LIGHT-INT,CANDLES,TBL,TICK
	ZERO? TICK /FALSE
	ADD TBL,4 >CANDLE-TABLE
	RETURN CANDLE-TABLE

	.FUNCT LIGHT-INT,OBJ,TBL,TICK
	ZERO? TICK \?L1
	FCLEAR OBJ,ONBIT
	FSET OBJ,RMUNGBIT
?L1:	CALL HELD?,OBJ >STACK
	ZERO? STACK \?L6
	IN? OBJ,HERE \FALSE
?L6:	ZERO? TICK \?L7
	PRINTI "You'd better have more light than from the "
	PRINTD OBJ
	PRINTR "."
?L7:	GET TBL,1 >STACK
	PRINT STACK
	CRLF
	RTRUE

	.FUNCT MIN,N1,N2
	LESS? N1,N2 \?L1
	RETURN N1
?L1:	RETURN N2

	.FUNCT CANDLES-FCN
	FSET? CANDLES,TOUCHBIT /?L1
	CALL INT,I-CANDLES >STACK
	PUT STACK,0,1
?L1:	EQUAL? CANDLES,PRSI /FALSE
	EQUAL? PRSA,V?BURN,V?LAMP-ON \?L7
	FSET? CANDLES,RMUNGBIT \?L9
	PRINTR "Alas, there's not much left of the candles. Certainly not enough to burn."
?L9:	ZERO? PRSI \?L13
	FSET? MATCH,FLAMEBIT \?L14
	PRINTI "(with the match)"
	CRLF
	CALL PERFORM,V?LAMP-ON,CANDLES,MATCH
	RTRUE
?L14:	PRINTI "You should say what to light them with."
	CRLF
	RETURN 2
?L13:	EQUAL? PRSI,MATCH \?L23
	FSET? MATCH,ONBIT \?L23
	PRINTI "The candles are "
	FSET? CANDLES,ONBIT \?L26
	PRINTR "already lit."
?L26:	FSET CANDLES,ONBIT
	PRINTI "lit."
	CRLF
	CALL INT,I-CANDLES >STACK
	PUT STACK,0,1
	RTRUE
?L23:	EQUAL? PRSI,TORCH \?L33
	FSET? CANDLES,ONBIT \?L34
	PRINTR "You realize, just in time, that the candles are already lighted."
?L34:	PRINTI "The heat from the torch is so intense that the candles are vaporized."
	CRLF
	CALL REMOVE-CAREFULLY,CANDLES >STACK
	RSTACK
?L33:	PRINTR "You have to light them with something that's burning, you know."
?L7:	EQUAL? PRSA,V?COUNT \?L44
	PRINTR "Let's see, how many objects in a pair? Don't tell me, I'll get it."
?L44:	EQUAL? PRSA,V?LAMP-OFF \?L47
	CALL INT,I-CANDLES >STACK
	PUT STACK,0,0
	FSET? CANDLES,ONBIT \?L48
	PRINTI "The flame is extinguished."
	FCLEAR CANDLES,ONBIT
	FSET CANDLES,TOUCHBIT
	CALL LIT?,HERE >LIT
	ZERO? LIT \?L52
	PRINTI " It's really dark in here...."
?L52:	CRLF
	RTRUE
?L48:	PRINTR "The candles are not lighted."
?L47:	EQUAL? PRSA,V?PUT \?L60
	FSET? PRSI,BURNBIT \?L60
	PRINTR "That wouldn't be smart."
?L60:	EQUAL? PRSA,V?EXAMINE \FALSE
	PRINTI "The candles are "
	FSET? CANDLES,ONBIT \?L66
	PRINTR "burning."
?L66:	PRINTR "out."

	.FUNCT CAVE2-ROOM,RARG
	EQUAL? RARG,M-END \FALSE
	IN? CANDLES,WINNER \FALSE
	CALL ZPROB,50 >STACK
	ZERO? STACK /FALSE
	FSET? CANDLES,ONBIT \FALSE
	CALL INT,I-CANDLES >STACK
	PUT STACK,0,0
	FCLEAR CANDLES,ONBIT
	PRINTI "A gust of wind blows out your candles!"
	CRLF
	CALL LIT?,HERE >LIT
	ZERO? LIT \FALSE
	PRINTR "It is now completely dark."

	.FUNCT SWORD-FCN,G
	EQUAL? PRSA,V?TAKE \?L1
	EQUAL? WINNER,ADVENTURER \?L1
	CALL QUEUE,I-SWORD,-1 >STACK
	PUT STACK,0,1
	RFALSE
?L1:	EQUAL? PRSA,V?EXAMINE \FALSE
	GETP SWORD,P?TVALUE >G
	EQUAL? G,1 \?L4
	PRINTR "Your sword is glowing with a faint blue glow."
?L4:	EQUAL? G,2 \FALSE
	PRINTR "Your sword is glowing very brightly."

	.FUNCT BOOM-ROOM,RARG,DUMMY?=0,FLAME
	EQUAL? RARG,M-END \FALSE
	EQUAL? RARG,M-END \?L3
	EQUAL? PRSA,V?BURN,V?LAMP-ON \?L3
	EQUAL? PRSO,CANDLES,TORCH,MATCH \?L3
	SET 'DUMMY?,1
?L3:	CALL HELD?,CANDLES >STACK
	ZERO? STACK /?L9
	FSET? CANDLES,ONBIT /?L8
?L9:	CALL HELD?,TORCH >STACK
	ZERO? STACK /?L10
	FSET? TORCH,ONBIT /?L8
?L10:	CALL HELD?,MATCH >STACK
	ZERO? STACK /FALSE
	FSET? MATCH,ONBIT \FALSE
?L8:	ZERO? DUMMY? /?L11
	PRINTI "How sad for an aspiring adventurer to light a "
	PRINTD PRSO
	PRINTI " in a room which reeks of gas. Fortunately, there is justice in the world."
	CRLF
	JUMP ?L15
?L11:	PRINTI "Oh dear. It appears that the smell coming from this room was coal gas. I would have thought twice about carrying flaming objects in here."
	CRLF
	CALL PRINT-ID,STR?154
?L15:	CALL JIGS-UP,STR?155 >STACK
	RSTACK

	.FUNCT BAT-D,FOO
	LOC GARLIC >STACK
	EQUAL? STACK,WINNER,HERE \?L1
	PRINTR "In the corner of the room on the ceiling is a large vampire bat who is obviously deranged and holding his nose."
?L1:	PRINTR "A large vampire bat, hanging from the ceiling, swoops down at you!"

	.FUNCT BATS-ROOM,RARG
	EQUAL? RARG,M-LOOK \?L1
	PRINTR "You are in a small room which has doors only to the east and south."
?L1:	EQUAL? RARG,M-ENTER \FALSE
	ZERO? DEAD \FALSE
	LOC GARLIC >STACK
	EQUAL? STACK,WINNER,HERE /FALSE
	CALL V-LOOK
	CRLF
	CALL FLY-ME >STACK
	RSTACK

	.FUNCT MACHINE-ROOM-FCN,RARG
	EQUAL? RARG,M-LOOK \FALSE
	PRINTI "This is a large, cold room whose sole exit is to the north. In one corner there is a machine which is reminiscent of a clothes dryer. On its face is a switch which is labelled ""START"". The switch does not appear to be manipulable by any human hand (unless the fingers are about 1/16 by 1/4 inch). On the front of the machine is a large lid, which is "
	FSET? MACHINE,OPENBIT \?L5
	PRINTR "open."
?L5:	PRINTR "closed."

	.FUNCT MACHINE-F
	EQUAL? PRSA,V?TAKE \?L1
	EQUAL? PRSO,MACHINE \?L1
	PRINTR "It is far too large to carry."
?L1:	EQUAL? PRSA,V?OPEN \?L5
	FSET? MACHINE,OPENBIT \?L6
	CALL PICK-ONE,DUMMY >STACK
	PRINT STACK
	CRLF
	RTRUE
?L6:	FIRST? MACHINE >STACK \?L10
	PRINTI "The lid opens, revealing "
	CALL PRINT-CONTENTS,MACHINE
	PRINTI "."
	CRLF
	FSET MACHINE,OPENBIT
	RTRUE
?L10:	PRINTI "The lid opens."
	CRLF
	FSET MACHINE,OPENBIT
	RTRUE
?L5:	EQUAL? PRSA,V?CLOSE \?L18
	FSET? MACHINE,OPENBIT \?L19
	PRINTI "The lid closes."
	CRLF
	FCLEAR MACHINE,OPENBIT
	RTRUE
?L19:	CALL PICK-ONE,DUMMY >STACK
	PRINT STACK
	CRLF
	RTRUE
?L18:	EQUAL? PRSA,V?LAMP-ON \FALSE
	ZERO? PRSI \?L27
	PRINTR "It's not clear how to turn it on with your bare hands."
?L27:	CALL PERFORM,V?TURN,MACHINE-SWITCH,PRSI
	RTRUE

	.FUNCT MSWITCH-FUNCTION,O
	EQUAL? PRSA,V?TURN \FALSE
	EQUAL? PRSI,SCREWDRIVER \?L3
	FSET? MACHINE,OPENBIT \?L5
	PRINTR "The machine doesn't seem to want to do anything."
?L5:	PRINTI "The machine comes to life (figuratively) with a dazzling display of colored lights and bizarre noises. After a few moments, the excitement abates."
	CRLF
	IN? COAL,MACHINE \?L12
	CALL REMOVE-CAREFULLY,COAL
	MOVE DIAMOND,MACHINE
	RTRUE
?L12:	FIRST? MACHINE >O \?L16
	CALL REMOVE-CAREFULLY,O
	JUMP ?L12
?L16:	MOVE GUNK,MACHINE
	RTRUE
?L3:	PRINTI "It seems that a "
	PRINTD PRSI
	PRINTR " won't do."

	.FUNCT GUNK-FUNCTION
	CALL REMOVE-CAREFULLY,GUNK
	PRINTR "The slag was rather insubstantial, and crumbles into dust at your touch."

	.FUNCT NO-OBJS,RARG,F
	EQUAL? RARG,M-BEG \FALSE
	FIRST? WINNER >F /?L3
?L3:	SET 'EMPTY-HANDED,1
	ZERO? F /?L5
?L6:	CALL WEIGHT,F >STACK
	GRTR? STACK,4 \?L8
	SET 'EMPTY-HANDED,0
	JUMP ?L5
?L8:	NEXT? F >F /?L6
?L5:	EQUAL? HERE,LOWER-SHAFT \FALSE
	ZERO? LIT /FALSE
	CALL SCORE-UPD,LIGHT-SHAFT
	SET 'LIGHT-SHAFT,0
	RFALSE

	.FUNCT SOUTH-TEMPLE-FCN,RARG
	EQUAL? RARG,M-BEG \FALSE
	IN? COFFIN,WINNER /?L3
	SET 'COFFIN-CURE,1
	RFALSE
?L3:	SET 'COFFIN-CURE,0
	RFALSE

	.FUNCT WHITE-CLIFFS-FUNCTION,RARG
	EQUAL? RARG,M-END \FALSE
	IN? INFLATED-BOAT,WINNER \?L3
	SET 'DEFLATE,0
	RETURN DEFLATE
?L3:	SET 'DEFLATE,1
	RETURN DEFLATE

	.FUNCT SCEPTRE-FUNCTION
	EQUAL? PRSA,V?RAISE,V?WAVE \FALSE
	EQUAL? HERE,ARAGAIN-FALLS /?L5
	EQUAL? HERE,END-OF-RAINBOW \?L3
?L5:	ZERO? RAINBOW-FLAG \?L6
	FCLEAR POT-OF-GOLD,INVISIBLE
	PRINTI "Suddenly, the rainbow appears to become solid and, I venture, walkable (I think the giveaway was the stairs and bannister)."
	CRLF
	EQUAL? HERE,END-OF-RAINBOW \?L10
	IN? POT-OF-GOLD,END-OF-RAINBOW \?L10
	PRINTI "A shimmering pot of gold appears at the end of the rainbow."
	CRLF
?L10:	SET 'RAINBOW-FLAG,1
	RETURN RAINBOW-FLAG
?L6:	CALL ROB,ON-RAINBOW,WALL
	PRINTI "The rainbow seems to have become somewhat run-of-the-mill."
	CRLF
	SET 'RAINBOW-FLAG,0
	RTRUE
?L3:	EQUAL? HERE,ON-RAINBOW \?L18
	SET 'RAINBOW-FLAG,0
	CALL PRINT-ID,STR?156
	CALL JIGS-UP,STR?157 >STACK
	RSTACK
?L18:	PRINTR "A dazzling display of color briefly emanates from the sceptre."

	.FUNCT FALLS-ROOM,RARG
	EQUAL? RARG,M-LOOK \FALSE
	PRINTI "You are at the top of Aragain Falls, an enormous waterfall with a drop of about 450 feet. The only path here is on the north end."
	CRLF
	ZERO? RAINBOW-FLAG /?L5
	PRINTR "A solid rainbow spans the falls."
?L5:	PRINTR "A beautiful rainbow can be seen over the falls and to the west."

	.FUNCT RAINBOW-FCN
	EQUAL? PRSA,V?THROUGH,V?CROSS \?L1
	EQUAL? HERE,CANYON-VIEW \?L3
	PRINTR "From here?!?"
?L3:	ZERO? RAINBOW-FLAG /?L8
	EQUAL? HERE,ARAGAIN-FALLS \?L10
	CALL GOTO,END-OF-RAINBOW >STACK
	RSTACK
?L10:	EQUAL? HERE,END-OF-RAINBOW \?L12
	CALL GOTO,ARAGAIN-FALLS >STACK
	RSTACK
?L12:	PRINTR "You'll have to say which way..."
?L8:	PRINTI "Can you walk on water vapor?"
	CRLF
	CALL PRINT-ID,STR?158 >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?LOOK-UNDER \FALSE
	PRINTR "The Frigid River flows under the rainbow."

	.FUNCT DBOAT-FUNCTION
	EQUAL? PRSA,V?PUT-ON,V?PUT \?L1
	EQUAL? PRSO,PUTTY \?L1
	CALL FIX-BOAT >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?FILL,V?INFLATE \?L3
	PRINTR "No chance. Some moron punctured it."
?L3:	EQUAL? PRSA,V?PLUG \FALSE
	EQUAL? PRSI,PUTTY \?L7
	CALL FIX-BOAT >STACK
	RSTACK
?L7:	CALL WITH-TELL,PRSI >STACK
	RSTACK

	.FUNCT FIX-BOAT
	PRINTI "Well done. The boat is repaired."
	CRLF
	CALL PRINT-ID,STR?159
	LOC PUNCTURED-BOAT >STACK
	MOVE INFLATABLE-BOAT,STACK
	CALL REMOVE-CAREFULLY,PUNCTURED-BOAT >STACK
	RSTACK

	.FUNCT RIVER-FUNCTION
	EQUAL? PRSA,V?PUT \?L1
	EQUAL? PRSI,RIVER \FALSE
	EQUAL? PRSO,ME \?L5
	CALL PRINT-ID,STR?160
	CALL JIGS-UP,STR?161 >STACK
	RSTACK
?L5:	EQUAL? PRSO,INFLATED-BOAT \?L7
	PRINTR "You should get in the boat then launch it."
?L7:	FSET? PRSO,BURNBIT \?L10
	CALL REMOVE-CAREFULLY,PRSO
	PRINTI "The "
	PRINTD PRSO
	PRINTI " floats for a moment, then sinks."
	CRLF
	CALL PRINT-ID,STR?162 >STACK
	RSTACK
?L10:	CALL REMOVE-CAREFULLY,PRSO
	PRINTI "The "
	PRINTD PRSO
	PRINTI " splashes into the water and is gone forever."
	CRLF
	CALL PRINT-ID,STR?163 >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?THROUGH,V?LEAP \FALSE
	PRINTR "A look before leaping reveals that the river is wide and dangerous, with swift currents and large, half-hidden rocks. You decide to forgo your swim."

	.FUNCT I-RIVER,RM
	EQUAL? HERE,RIVER-1,RIVER-2,RIVER-3 /?L1
	EQUAL? HERE,RIVER-4,RIVER-5 /?L1
	CALL INT,I-RIVER >STACK
	PUT STACK,0,0
	RTRUE
?L1:	CALL LKP,HERE,RIVER-NEXT >RM
	ZERO? RM /?L3
	PRINTI "The flow of the river carries you downstream."
	CRLF
	CRLF
	CALL GOTO,RM
	CALL LKP,HERE,RIVER-SPEEDS >STACK
	CALL QUEUE,I-RIVER,STACK >STACK
	PUT STACK,0,1
	RTRUE
?L3:	CALL PRINT-ID,STR?164
	CALL JIGS-UP,STR?165 >STACK
	RSTACK

	.FUNCT RBOAT-FUNCTION,RARG=0,TMP
	EQUAL? RARG,M-ENTER,M-END,M-LOOK /FALSE
	EQUAL? RARG,M-BEG \?L3
	EQUAL? PRSA,V?WALK \?L4
	EQUAL? PRSO,P?LAND,P?EAST,P?WEST /FALSE
	EQUAL? HERE,RESERVOIR \?L8
	EQUAL? PRSO,P?NORTH,P?SOUTH /FALSE
?L8:	EQUAL? HERE,IN-STREAM \?L9
	EQUAL? PRSO,P?SOUTH /FALSE
?L9:	PRINTR "Read the label for the boat's instructions."
?L4:	EQUAL? PRSA,V?LAUNCH \?L13
	EQUAL? HERE,RIVER-1,RIVER-2,RIVER-3 /?L16
	EQUAL? HERE,RIVER-4,RESERVOIR,IN-STREAM \?L14
?L16:	PRINTI "You are on the "
	EQUAL? HERE,RESERVOIR \?L19
	PRINTI "reservoir"
	JUMP ?L26
?L19:	EQUAL? HERE,IN-STREAM \?L23
	PRINTI "stream"
	JUMP ?L26
?L23:	PRINTI "river"
?L26:	PRINTR ", or have you forgotten?"
?L14:	CALL GO-NEXT,RIVER-LAUNCH >TMP
	EQUAL? TMP,1 \?L31
	CALL LKP,HERE,RIVER-SPEEDS >STACK
	CALL QUEUE,I-RIVER,STACK >STACK
	PUT STACK,0,1
	RTRUE
?L31:	EQUAL? TMP,2 /TRUE
	PRINTR "You can't launch it here."
?L13:	EQUAL? PRSA,V?DROP \?L38
	FSET? PRSO,WEAPONBIT /?L37
?L38:	EQUAL? PRSA,V?PUT \?L39
	FSET? PRSO,WEAPONBIT \?L39
	EQUAL? PRSI,INFLATED-BOAT /?L37
?L39:	EQUAL? PRSA,V?MUNG,V?ATTACK \?L36
	FSET? PRSI,WEAPONBIT \?L36
?L37:	CALL REMOVE-CAREFULLY,INFLATED-BOAT
	MOVE PUNCTURED-BOAT,HERE
	CALL ROB,INFLATED-BOAT,HERE
	MOVE WINNER,HERE
	PRINTI "It seems that the "
	EQUAL? PRSA,V?PUT,V?DROP \?L42
	PRINTD PRSO
	JUMP ?L46
?L42:	PRINTD PRSI
?L46:	PRINTI " didn't agree with the boat, as evidenced by the loud hissing noise issuing therefrom. With a pathetic sputter, the boat deflates, leaving you without."
	CRLF
	FSET? HERE,NONLANDBIT \TRUE
	CRLF
	EQUAL? HERE,RESERVOIR,IN-STREAM \?L53
	CALL PRINT-ID,STR?166
	CALL JIGS-UP,STR?167
	RTRUE
?L53:	CALL PRINT-ID,STR?168
	CALL JIGS-UP,STR?169
	RTRUE
?L36:	EQUAL? PRSA,V?LAUNCH \FALSE
	PRINTR "You're not in the boat!"
?L3:	EQUAL? PRSA,V?BOARD \?L61
	IN? SCEPTRE,WINNER /?L64
	IN? KNIFE,WINNER /?L64
	IN? SWORD,WINNER /?L64
	IN? RUSTY-KNIFE,WINNER /?L64
	IN? AXE,WINNER /?L64
	IN? STILETTO,WINNER \FALSE
?L64:	PRINTI "Oops! Something sharp seems to have slipped and punctured the boat. The boat deflates to the sounds of hissing, sputtering, and cursing."
	CRLF
	CALL PRINT-ID,STR?170
	CALL REMOVE-CAREFULLY,INFLATED-BOAT
	MOVE PUNCTURED-BOAT,HERE
	CALL THIS-IS-IT,PUNCTURED-BOAT
	RTRUE
?L61:	EQUAL? PRSA,V?FILL,V?INFLATE \?L68
	PRINTR "Inflating it further would probably burst it."
?L68:	EQUAL? PRSA,V?DEFLATE \FALSE
	LOC WINNER >STACK
	EQUAL? STACK,INFLATED-BOAT \?L72
	PRINTI "You can't deflate the boat while you're in it."
	CRLF
	CALL PRINT-ID,STR?171 >STACK
	RSTACK
?L72:	IN? INFLATED-BOAT,HERE /?L76
	PRINTR "The boat must be on the ground to be deflated."
?L76:	PRINTI "The boat deflates."
	CRLF
	SET 'DEFLATE,1
	CALL REMOVE-CAREFULLY,INFLATED-BOAT
	MOVE INFLATABLE-BOAT,HERE
	CALL THIS-IS-IT,INFLATABLE-BOAT >STACK
	RSTACK

	.FUNCT BREATHE
	CALL PERFORM,V?INFLATE,PRSO,LUNGS >STACK
	RSTACK

	.FUNCT IBOAT-FUNCTION
	EQUAL? PRSA,V?FILL,V?INFLATE \FALSE
	IN? INFLATABLE-BOAT,HERE /?L3
	PRINTR "The boat must be on the ground to be inflated."
?L3:	EQUAL? PRSI,PUMP \?L7
	PRINTI "The boat inflates and appears seaworthy."
	CRLF
	FSET? BOAT-LABEL,TOUCHBIT /?L10
	PRINTI "A tan label is lying inside the boat."
	CRLF
?L10:	SET 'DEFLATE,0
	CALL REMOVE-CAREFULLY,INFLATABLE-BOAT
	MOVE INFLATED-BOAT,HERE
	CALL THIS-IS-IT,INFLATED-BOAT >STACK
	RSTACK
?L7:	EQUAL? PRSI,LUNGS \?L15
	PRINTR "You don't have enough lung power to inflate it."
?L15:	PRINTI "With a "
	PRINTD PRSI
	PRINTR "? Surely you jest!"

	.FUNCT RIVR4-ROOM,RARG
	EQUAL? RARG,M-END \FALSE
	IN? BUOY,WINNER \FALSE
	ZERO? BUOY-FLAG /FALSE
	PRINTI "You notice something funny about the feel of the buoy."
	CRLF
	SET 'BUOY-FLAG,0
	RETURN BUOY-FLAG

	.FUNCT SAND-FUNCTION
	EQUAL? PRSA,V?DIG \FALSE
	EQUAL? PRSI,SHOVEL \FALSE
	IGRTR? 'BEACH-DIG,3 \?L3
	SET 'BEACH-DIG,-1
	IN? SCARAB,HERE \?L5
	FSET SCARAB,INVISIBLE
?L5:	CALL PRINT-ID,STR?172
	CALL JIGS-UP,STR?173 >STACK
	RSTACK
?L3:	EQUAL? BEACH-DIG,3 \?L7
	FSET? SCARAB,INVISIBLE \FALSE
	PRINTI "You can see a scarab here in the sand."
	CRLF
	CALL THIS-IS-IT,SCARAB
	FCLEAR SCARAB,INVISIBLE
	RTRUE
?L7:	GET BDIGS,BEACH-DIG >STACK
	PRINT STACK
	CRLF
	RTRUE

	.FUNCT TREE-ROOM,RARG,F
	EQUAL? RARG,M-LOOK \?L1
	PRINTI "You are about 10 feet above the ground nestled among some large branches. The nearest branch above you is above your reach."
	CRLF
	FIRST? PATH >F \FALSE
	NEXT? F >STACK \FALSE
	PRINTI "On the ground below you can see:  "
	CALL PRINT-CONTENTS,PATH
	PRINTR "."
?L1:	EQUAL? RARG,M-BEG \?L12
	EQUAL? PRSA,V?CLIMB-DOWN \?L13
	EQUAL? PRSO,TREE,ROOMS \?L13
	CALL DO-WALK,P?DOWN >STACK
	RSTACK
?L13:	EQUAL? PRSA,V?CLIMB-FOO,V?CLIMB-UP \?L15
	EQUAL? PRSO,TREE \?L15
	CALL DO-WALK,P?UP >STACK
	RSTACK
?L15:	EQUAL? PRSA,V?DROP \FALSE
	CALL IDROP >STACK
	ZERO? STACK /TRUE
	EQUAL? PRSO,NEST \?L19
	IN? EGG,NEST \?L19
	PRINTI "The nest falls to the ground, and the egg spills out of it, seriously damaged."
	CRLF
	CALL PRINT-ID,STR?174
	CALL REMOVE-CAREFULLY,EGG
	MOVE BROKEN-EGG,PATH
	RTRUE
?L19:	EQUAL? PRSO,EGG \?L22
	PRINTI "The egg falls to the ground and springs open, seriously damaged."
	CALL PRINT-ID,STR?175
	MOVE EGG,PATH
	CALL BAD-EGG
	CRLF
	RTRUE
?L22:	EQUAL? PRSO,WINNER,TREE /?L25
	MOVE PRSO,PATH
	PRINTI "The "
	PRINTD PRSO
	PRINTR " falls to the ground."
?L25:	EQUAL? PRSA,V?LEAP \FALSE
	CALL PRINT-ID,STR?176
	CALL JIGS-UP,STR?177 >STACK
	RSTACK
?L12:	EQUAL? RARG,M-ENTER \FALSE
	CALL QUEUE,I-FOREST-ROOM,-1 >STACK
	PUT STACK,0,1
	RTRUE

	.FUNCT EGG-OBJECT
	EQUAL? PRSA,V?MUNG,V?OPEN \?L1
	EQUAL? PRSO,EGG \?L1
	FSET? PRSO,OPENBIT \?L3
	PRINTR "The egg is already open."
?L3:	ZERO? PRSI \?L7
	PRINTR "You have neither the tools nor the expertise."
?L7:	EQUAL? PRSI,HANDS \?L10
	PRINTI "I doubt you could do that without damaging it."
	CRLF
	CALL PRINT-ID,STR?178 >STACK
	RSTACK
?L10:	FSET? PRSI,WEAPONBIT /?L14
	FSET? PRSI,TOOLBIT /?L14
	EQUAL? PRSA,V?MUNG \?L13
?L14:	PRINTI "The egg is now open, but the clumsiness of your attempt has seriously compromised its esthetic appeal."
	CALL PRINT-ID,STR?179
	CALL BAD-EGG
	CRLF
	RTRUE
?L13:	FSET? PRSO,FIGHTBIT \?L17
	PRINTI "Not to say that using the "
	PRINTD PRSI
	PRINTR " isn't original too..."
?L17:	PRINTI "The concept of using a "
	PRINTD PRSI
	PRINTI " is certainly original."
	CRLF
	FSET PRSO,FIGHTBIT
	RTRUE
?L1:	EQUAL? PRSA,V?HATCH,V?CLIMB-ON \?L23
	PRINTI "There is a noticeable crunch from beneath you, and inspection reveals that the egg is lying open, badly damaged."
	CALL PRINT-ID,STR?180
	CALL BAD-EGG
	CRLF
	RTRUE
?L23:	EQUAL? PRSA,V?THROW,V?MUNG,V?OPEN \FALSE
	EQUAL? PRSA,V?THROW \?L27
	MOVE PRSO,HERE
?L27:	PRINTI "Your rather indelicate handling of the egg has caused it some damage, although you have succeeded in opening it."
	CALL PRINT-ID,STR?181
	CALL BAD-EGG
	CRLF
	RTRUE

	.FUNCT BAD-EGG,L
	IN? CANARY,EGG \?L1
	PRINTI " "
	GETP BROKEN-CANARY,P?FDESC >STACK
	PRINT STACK
	JUMP ?L5
?L1:	CALL REMOVE-CAREFULLY,BROKEN-CANARY
?L5:	LOC EGG >STACK
	MOVE BROKEN-EGG,STACK
	CALL REMOVE-CAREFULLY,EGG
	RTRUE

	.FUNCT CANARY-OBJECT
	EQUAL? PRSA,V?WIND \FALSE
	EQUAL? PRSO,CANARY \?L3
	ZERO? SING-SONG \?L5
	CALL FOREST-ROOM? >STACK
	ZERO? STACK /?L5
	PRINTI "The canary chirps, slightly off-key, an aria from a forgotten opera. From out of the greenery flies a lovely songbird. It perches on a limb just over your head and opens its beak to sing. As it does so a beautiful brass bauble drops from its mouth, bounces off the top of your head, and lands glimmering in the grass. As the canary winds down, the songbird flies away."
	CRLF
	SET 'SING-SONG,1
	EQUAL? HERE,UP-A-TREE \?L9
	PUSH PATH
	JUMP ?L11
?L9:	PUSH HERE
?L11:	MOVE BAUBLE,STACK
	RTRUE
?L5:	PRINTR "The canary chirps blithely, if somewhat tinnily, for a short time."
?L3:	PRINTR "There is an unpleasant grinding noise from inside the canary."

	.FUNCT FOREST-ROOM?
	EQUAL? HERE,FOREST-1,FOREST-2,FOREST-3 /TRUE
	EQUAL? HERE,PATH,UP-A-TREE /TRUE
	RFALSE

	.FUNCT I-FOREST-ROOM
	CALL FOREST-ROOM? >STACK
	ZERO? STACK \?L1
	CALL INT,I-FOREST-ROOM >STACK
	PUT STACK,0,0
	RFALSE
?L1:	RANDOM 100 >STACK
	GRTR? 15,STACK \FALSE
	PRINTR "You hear in the distance the chirping of a song bird."

	.FUNCT FOREST-ROOM,RARG
	EQUAL? RARG,M-ENTER \?L1
	CALL QUEUE,I-FOREST-ROOM,-1 >STACK
	PUT STACK,0,1
	RTRUE
?L1:	EQUAL? RARG,M-BEG \FALSE
	EQUAL? PRSA,V?CLIMB-UP,V?CLIMB-FOO \FALSE
	EQUAL? PRSO,TREE \FALSE
	CALL DO-WALK,P?UP >STACK
	RSTACK

	.FUNCT WCLIF-OBJECT
	EQUAL? PRSA,V?CLIMB-FOO,V?CLIMB-DOWN,V?CLIMB-UP \FALSE
	PRINTR "The cliff is too steep for climbing."

	.FUNCT CLIFF-OBJECT
	EQUAL? PRSA,V?LEAP /?L3
	EQUAL? PRSA,V?PUT \?L1
	EQUAL? PRSO,ME \?L1
?L3:	PRINTI "That would be very unwise. Perhaps even fatal."
	CRLF
	CALL PRINT-ID,STR?182 >STACK
	RSTACK
?L1:	EQUAL? PRSI,CLIMBABLE-CLIFF \FALSE
	EQUAL? PRSA,V?THROW-OFF,V?PUT \FALSE
	PRINTI "The "
	PRINTD PRSO
	PRINTI " tumbles into the river and is seen no more."
	CRLF
	CALL PRINT-ID,STR?183
	CALL REMOVE-CAREFULLY,PRSO >STACK
	RSTACK

	.FUNCT ROPE-FUNCTION,RLOC
	EQUAL? HERE,DOME-ROOM /?L1
	SET 'DOME-FLAG,0
	EQUAL? PRSA,V?TIE \FALSE
	PRINTR "You can't tie the rope to that."
?L1:	EQUAL? PRSA,V?TIE \?L8
	EQUAL? PRSI,RAILING \FALSE
	ZERO? DOME-FLAG /?L11
	PRINTR "The rope is already tied to it."
?L11:	PRINTI "The rope drops over the side and comes within ten feet of the floor."
	CRLF
	SET 'DOME-FLAG,1
	FSET ROPE,NDESCBIT
	LOC ROPE >RLOC
	ZERO? RLOC /?L20
	IN? RLOC,ROOMS /TRUE
?L20:	MOVE ROPE,HERE
	RTRUE
?L8:	EQUAL? PRSA,V?CLIMB-DOWN \?L23
	EQUAL? PRSO,ROPE,ROOMS \?L23
	ZERO? DOME-FLAG /?L23
	CALL DO-WALK,P?DOWN >STACK
	RSTACK
?L23:	EQUAL? PRSA,V?TIE-UP \?L24
	EQUAL? ROPE,PRSI \?L24
	FSET? PRSO,ACTORBIT \?L25
	GETP PRSO,P?STRENGTH >STACK
	LESS? STACK,0 \?L27
	PRINTI "Your attempt to tie up the "
	PRINTD PRSO
	PRINTI " awakens him."
	CALL PRINT-ID,STR?184
	CALL AWAKEN,PRSO >STACK
	RSTACK
?L27:	PRINTI "The "
	PRINTD PRSO
	PRINTI " struggles and you cannot tie him up."
	CRLF
	CALL PRINT-ID,STR?185 >STACK
	RSTACK
?L25:	PRINTI "Why would you tie up a "
	PRINTD PRSO
	PRINTR "?"
?L24:	EQUAL? PRSA,V?UNTIE \?L37
	ZERO? DOME-FLAG /?L38
	SET 'DOME-FLAG,0
	FCLEAR ROPE,NDESCBIT
	PRINTR "The rope is now untied."
?L38:	PRINTR "It is not tied to anything."
?L37:	EQUAL? PRSA,V?DROP \?L45
	EQUAL? HERE,DOME-ROOM \?L45
	ZERO? DOME-FLAG \?L45
	MOVE ROPE,TORCH-ROOM
	PRINTR "The rope drops gently to the floor below."
?L45:	EQUAL? PRSA,V?TAKE \FALSE
	ZERO? DOME-FLAG /FALSE
	PRINTR "The rope is tied to the railing."

	.FUNCT UNTIE-FROM
	EQUAL? PRSO,ROPE \?L1
	ZERO? DOME-FLAG /?L1
	EQUAL? PRSI,RAILING \?L1
	CALL PERFORM,V?UNTIE,PRSO >STACK
	RSTACK
?L1:	PRINTR "It's not attached to that!"

	.FUNCT SLIDE-FUNCTION
	EQUAL? PRSA,V?CLIMB-DOWN,V?CLIMB-UP,V?THROUGH /?L3
	EQUAL? PRSA,V?CLIMB-FOO /?L3
	EQUAL? PRSA,V?PUT \FALSE
	EQUAL? PRSO,ME \?L1
?L3:	EQUAL? HERE,CELLAR \?L4
	CALL DO-WALK,P?WEST
	RTRUE
?L4:	PRINTI "You tumble down the slide...."
	CRLF
	CALL GOTO,CELLAR >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?PUT \FALSE
	CALL SLIDER,PRSO >STACK
	RSTACK

	.FUNCT SLIDER,OBJ
	FSET? OBJ,TAKEBIT \?L1
	PRINTI "The "
	PRINTD OBJ
	PRINTI " falls into the slide and is gone."
	CRLF
	EQUAL? OBJ,WATER \?L5
	CALL REMOVE-CAREFULLY,OBJ >STACK
	RSTACK
?L5:	MOVE OBJ,CELLAR
	RTRUE
?L1:	CALL PICK-ONE,YUKS >STACK
	PRINT STACK
	CRLF
	RTRUE

	.FUNCT SANDWICH-BAG-FCN
	EQUAL? PRSA,V?SMELL \FALSE
	IN? LUNCH,PRSO \FALSE
	PRINTR "It smells of hot peppers."

	.FUNCT DEAD-FUNCTION,FOO=0,M
	EQUAL? PRSA,V?WALK \?L1
	EQUAL? HERE,TIMBER-ROOM \FALSE
	EQUAL? PRSO,P?WEST \FALSE
	PRINTR "You cannot enter in your condition."
?L1:	EQUAL? PRSA,V?SUPER-BRIEF,V?VERBOSE,V?BRIEF /FALSE
	EQUAL? PRSA,V?RESTORE,V?SAVE,V?VERSION /FALSE
	EQUAL? PRSA,V?RESTART,V?QUIT /FALSE
	EQUAL? PRSA,V?ALARM,V?MUNG,V?ATTACK /?L11
	EQUAL? PRSA,V?SWING \?L10
?L11:	PRINTI "All such attacks are vain in your condition."
	CRLF
	EQUAL? PRSA,V?MUNG,V?ATTACK /?L15
	PUSH 0
	JUMP ?L14
?L15:	CALL IS-PERSON? >STACK
?L14:	CALL PRINT-ID,STR?186,STACK
	EQUAL? PRSA,V?MUNG,V?ATTACK /?L17
	PUSH 0
	JUMP ?L16
?L17:	CALL IS-OBJ-PROP-ANIMAL? >STACK
?L16:	CALL PRINT-ID,STR?187,STACK
	EQUAL? PRSA,V?MUNG,V?ATTACK /?L19
	PUSH 0
	JUMP ?L18
?L19:	CALL IS-PART-OF-SELF-OR-SELF? >STACK
?L18:	CALL PRINT-ID,STR?188,STACK >STACK
	RSTACK
?L10:	EQUAL? PRSA,V?EAT,V?CLOSE,V?OPEN /?L21
	EQUAL? PRSA,V?DEFLATE,V?INFLATE,V?DRINK /?L21
	EQUAL? PRSA,V?TIE,V?BURN,V?TURN /?L21
	EQUAL? PRSA,V?RUB,V?UNTIE \?L20
?L21:	PRINTR "Even such an action is beyond your capabilities."
?L20:	EQUAL? PRSA,V?WAIT \?L24
	PRINTR "Might as well. You've got an eternity."
?L24:	EQUAL? PRSA,V?LAMP-ON \?L27
	PRINTR "You need no light to guide you."
?L27:	EQUAL? PRSA,V?SCORE \?L30
	PRINTR "You're dead! How can you think of your score?"
?L30:	EQUAL? PRSA,V?RUB,V?TAKE \?L33
	PRINTI "Your hand passes through its object."
	CRLF
	EQUAL? PRSA,V?TAKE /?L37
	PUSH 0
	JUMP ?L36
?L37:	CALL IS-THEFT? >STACK
?L36:	CALL PRINT-ID,STR?189,STACK
	EQUAL? PRSA,V?RUB /?L39
	PUSH 0
	JUMP ?L38
?L39:	CALL IS-PERSON? >STACK
?L38:	CALL PRINT-ID,STR?190,STACK >STACK
	RSTACK
?L33:	EQUAL? PRSA,V?INVENTORY,V?THROW,V?DROP \?L40
	PRINTR "You have no possessions."
?L40:	EQUAL? PRSA,V?DIAGNOSE \?L43
	PRINTR "You are dead."
?L43:	EQUAL? PRSA,V?LOOK \?L46
	PRINTI "The room looks strange and unearthly"
	FIRST? HERE >STACK /?L49
	PRINTI "."
	JUMP ?L53
?L49:	PRINTI " and objects appear indistinct."
?L53:	CRLF
	FSET? HERE,ONBIT /?L56
	PRINTI "Although there is no light, the room seems dimly illuminated."
	CRLF
?L56:	CRLF
	RFALSE
?L46:	EQUAL? PRSA,V?PRAY \?L61
	EQUAL? HERE,SOUTH-TEMPLE \?L62
	FCLEAR LAMP,INVISIBLE
	PUTP WINNER,P?ACTION,0
	SET 'ALWAYS-LIT,0
	SET 'DEAD,0
	IN? TROLL,TROLL-ROOM \?L64
	SET 'TROLL-FLAG,0
?L64:	PRINTI "From the distance the sound of a lone trumpet is heard. The room becomes very bright and you feel disembodied. In a moment, the brightness fades and you find yourself rising as if from a long sleep, deep in the woods. In the distance you can faintly hear a songbird and the sounds of the forest."
	CRLF
	CRLF
	CALL GOTO,FOREST-1 >STACK
	RSTACK
?L62:	PRINTR "Your prayers are not heard."
?L61:	PRINTI "You can't even do that."
	CRLF
	SET 'P-CONT,0
	RETURN 2

	.FUNCT LAKE-PSEUDO
	ZERO? LOW-TIDE /?L1
	PRINTR "There's not much lake left...."
?L1:	EQUAL? PRSA,V?CROSS \?L5
	PRINTR "It's too wide to cross."
?L5:	EQUAL? PRSA,V?THROUGH \FALSE
	PRINTR "You can't swim in this lake."

	.FUNCT STREAM-PSEUDO
	EQUAL? PRSA,V?THROUGH,V?SWIM \?L1
	PRINTR "You can't swim in the stream."
?L1:	EQUAL? PRSA,V?CROSS \FALSE
	PRINTR "The other side is a sheer rock cliff."

	.FUNCT CHASM-PSEUDO
	EQUAL? PRSA,V?LEAP /?L3
	EQUAL? PRSA,V?PUT \?L1
	EQUAL? PRSO,ME \?L1
?L3:	PRINTI "You look before leaping, and realize that you would never survive."
	CRLF
	CALL PRINT-ID,STR?191 >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?CROSS \?L6
	PRINTR "It's too far to jump, and there's no bridge."
?L6:	EQUAL? PRSA,V?THROW-OFF,V?PUT \FALSE
	EQUAL? PRSI,PSEUDO-OBJECT \FALSE
	PRINTI "The "
	PRINTD PRSO
	PRINTI " drops out of sight into the chasm."
	CRLF
	CALL IS-OBJECT-OR-PROPERTY? >STACK
	CALL PRINT-ID,STR?192,STACK
	CALL REMOVE-CAREFULLY,PRSO >STACK
	RSTACK

	.FUNCT DOME-PSEUDO
	EQUAL? PRSA,V?KISS \FALSE
	PRINTR "No."

	.FUNCT GATE-PSEUDO
	EQUAL? PRSA,V?THROUGH \?L1
	CALL DO-WALK,P?IN
	RTRUE
?L1:	PRINTR "The gate is protected by an invisible force. It makes your teeth ache to touch it."

	.FUNCT DOOR-PSEUDO
	EQUAL? PRSA,V?CLOSE,V?OPEN \?L1
	PRINTR "The door won't budge."
?L1:	EQUAL? PRSA,V?THROUGH \FALSE
	CALL DO-WALK,P?SOUTH >STACK
	RSTACK

	.FUNCT PAINT-PSEUDO
	EQUAL? PRSA,V?MUNG \FALSE
	PRINTR "Some paint chips away, revealing more paint."

	.FUNCT GAS-PSEUDO
	EQUAL? PRSA,V?BREATHE \?L1
	PRINTR "There is too much gas to blow away."
?L1:	EQUAL? PRSA,V?SMELL \FALSE
	PRINTR "It smells like coal gas in here."

	.FUNCT DO-FIGHT,LEN,CNT,RES,O,OO,OUT=0
?L1:	SET 'CNT,0
?L3:	INC 'CNT
	EQUAL? CNT,LEN \?L5
	SET 'RES,1
	JUMP ?L4
?L5:	GET VILLAINS,CNT >OO
	GET OO,V-VILLAIN >O
	FSET? O,FIGHTBIT \?L3
	GETP O,P?ACTION >STACK
	CALL STACK,F-BUSY? >STACK
	ZERO? STACK \?L3
	CALL VILLAIN-BLOW,OO,OUT >RES
	ZERO? RES \?L11
	SET 'RES,0
	JUMP ?L4
?L11:	EQUAL? RES,UNCONSCIOUS \?L3
	RANDOM 3 >STACK
	ADD 1,STACK >OUT
	JUMP ?L3
?L4:	ZERO? RES /TRUE
	ZERO? OUT /TRUE
	DEC 'OUT
	ZERO? OUT \?L1
	RTRUE

	.FUNCT REMARK,REMARK?1,D,W,LEN,CNT=0,STR
	GET REMARK?1,0 >LEN
?L1:	IGRTR? 'CNT,LEN /?L2
	GET REMARK?1,CNT >STR
	EQUAL? STR,F-WEP \?L6
	PRINTD W
	JUMP ?L1
?L6:	EQUAL? STR,F-DEF \?L8
	PRINTD D
	JUMP ?L1
?L8:	PRINT STR
	JUMP ?L1
?L2:	CRLF
	RTRUE

	.FUNCT FIGHT-STRENGTH,ADJUST?=1,S
	DIV SCORE-MAX,5 >STACK
	DIV SCORE,STACK >STACK
	ADD STRENGTH-MIN,STACK >S
	ZERO? ADJUST? /?L1
	GETP WINNER,P?STRENGTH >STACK
	ADD S,STACK >STACK
	RSTACK
?L1:	RETURN S

	.FUNCT VILLAIN-STRENGTH,OO,VILLAIN,OD,TMP
	GET OO,V-VILLAIN >VILLAIN
	GETP VILLAIN,P?STRENGTH >OD
	LESS? OD,0 /?L9
	EQUAL? VILLAIN,THIEF \?L3
	ZERO? THIEF-ENGROSSED /?L3
	GRTR? OD,2 \?L5
	SET 'OD,2
?L5:	SET 'THIEF-ENGROSSED,0
?L3:	ZERO? PRSI /?L9
	FSET? PRSI,WEAPONBIT \?L9
	GET OO,V-BEST >STACK
	EQUAL? STACK,PRSI \?L9
	GET OO,V-BEST-ADV >STACK
	SUB OD,STACK >TMP
	LESS? TMP,1 \?L11
	SET 'TMP,1
?L11:	SET 'OD,TMP
?L9:	RETURN OD

	.FUNCT FIND-WEAPON,O,W
	FIRST? O >W \FALSE
?L2:	EQUAL? W,STILETTO,AXE,SWORD /?L9
	EQUAL? W,KNIFE,RUSTY-KNIFE \?L7
?L9:	RETURN W
?L7:	NEXT? W >W /?L2
	RFALSE

	.FUNCT VILLAIN-BLOW,OO,OUT?,VILLAIN,REMARKS,DWEAPON,ATT,DEF,OA,OD,TBL,RES,NWEAPON
	GET OO,V-VILLAIN >VILLAIN
	GET OO,V-MSGS >REMARKS
	FCLEAR WINNER,STAGGERED
	FSET? VILLAIN,STAGGERED \?L1
	PRINTI "The "
	PRINTD VILLAIN
	PRINTI " slowly regains his feet."
	CRLF
	FCLEAR VILLAIN,STAGGERED
	RTRUE
?L1:	CALL VILLAIN-STRENGTH,OO >ATT
	SET 'OA,ATT
	CALL FIGHT-STRENGTH >DEF
	GRTR? DEF,0 \TRUE
	CALL FIGHT-STRENGTH,0 >OD
	CALL FIND-WEAPON,WINNER >DWEAPON
	LESS? DEF,0 \?L9
	SET 'RES,KILLED
	JUMP ?L11
?L9:	EQUAL? DEF,1 \?L12
	GRTR? ATT,2 \?L14
	SET 'ATT,3
?L14:	SUB ATT,1 >STACK
	GET DEF1-RES,STACK >TBL
	JUMP ?L21
?L12:	EQUAL? DEF,2 \?L17
	GRTR? ATT,3 \?L18
	SET 'ATT,4
?L18:	SUB ATT,1 >STACK
	GET DEF2-RES,STACK >TBL
	JUMP ?L21
?L17:	GRTR? DEF,2 \?L21
	SUB ATT,DEF >ATT
	LESS? ATT,-1 \?L22
	SET 'ATT,-2
	JUMP ?L24
?L22:	GRTR? ATT,1 \?L24
	SET 'ATT,2
?L24:	ADD ATT,2 >STACK
	GET DEF3-RES,STACK >TBL
?L21:	RANDOM 9 >STACK
	DEC 'STACK
	GET TBL,STACK >RES
	ZERO? OUT? /?L31
	EQUAL? RES,STAGGER \?L29
	SET 'RES,HESITATE
	JUMP ?L31
?L29:	SET 'RES,SITTING-DUCK
?L31:	EQUAL? RES,STAGGER \?L33
	ZERO? DWEAPON /?L33
	CALL ZPROB,25 >STACK
	ZERO? STACK /?L33
	SET 'RES,LOSE-WEAPON
?L33:	SUB RES,1 >STACK
	GET REMARKS,STACK >STACK
	CALL RANDOM-ELEMENT,STACK >STACK
	CALL REMARK,STACK,WINNER,DWEAPON
?L11:	EQUAL? RES,MISSED,HESITATE,UNCONSCIOUS /?L58
	EQUAL? RES,KILLED /?L41
	EQUAL? RES,SITTING-DUCK \?L40
?L41:	SET 'DEF,0
	JUMP ?L58
?L40:	EQUAL? RES,LIGHT-WOUND \?L42
	DLESS? 'DEF,0 \?L43
	SET 'DEF,0
?L43:	GRTR? LOAD-ALLOWED,50 \?L58
	SUB LOAD-ALLOWED,10 >LOAD-ALLOWED
	JUMP ?L58
?L42:	EQUAL? RES,SERIOUS-WOUND \?L49
	SUB DEF,2 >DEF
	LESS? DEF,0 \?L50
	SET 'DEF,0
?L50:	GRTR? LOAD-ALLOWED,50 \?L58
	SUB LOAD-ALLOWED,20 >LOAD-ALLOWED
	JUMP ?L58
?L49:	EQUAL? RES,STAGGER \?L56
	FSET WINNER,STAGGERED
	JUMP ?L58
?L56:	MOVE DWEAPON,HERE
	CALL FIND-WEAPON,WINNER >NWEAPON
	ZERO? NWEAPON /?L58
	PRINTI "Fortunately, you still have a "
	PRINTD NWEAPON
	PRINTI "."
	CRLF
?L58:	CALL WINNER-RESULT,DEF,RES,OD >STACK
	RSTACK

	.FUNCT HERO-BLOW,OO,VILLAIN,OUT?=0,DWEAPON,ATT,DEF,CNT=0,OA,OD,TBL,RES,NWEAPON,LEN
	GET VILLAINS,0 >LEN
?L1:	INC 'CNT
	EQUAL? CNT,LEN /?L2
	GET VILLAINS,CNT >OO
	GET OO,V-VILLAIN >STACK
	EQUAL? STACK,PRSO \?L1
?L2:	FSET PRSO,FIGHTBIT
	FSET? WINNER,STAGGERED \?L9
	PRINTI "You are still recovering from that last blow, so your attack is ineffective."
	CRLF
	FCLEAR WINNER,STAGGERED
	RTRUE
?L9:	CALL FIGHT-STRENGTH >ATT
	LESS? ATT,1 \?L14
	SET 'ATT,1
?L14:	SET 'OA,ATT
	GET OO,V-VILLAIN >VILLAIN
	CALL VILLAIN-STRENGTH,OO >DEF
	SET 'OD,DEF
	ZERO? OD \?L17
	EQUAL? PRSO,WINNER \?L19
	CALL JIGS-UP,STR?193 >STACK
	RSTACK
?L19:	PRINTI "Attacking the "
	PRINTD VILLAIN
	PRINTR " is pointless."
?L17:	CALL FIND-WEAPON,VILLAIN >DWEAPON
	ZERO? DWEAPON /?L27
	LESS? DEF,0 \?L25
?L27:	PRINTI "The "
	LESS? DEF,0 \?L30
	PRINTI "unconscious"
	JUMP ?L34
?L30:	PRINTI "unarmed"
?L34:	PRINTI " "
	PRINTD VILLAIN
	PRINTI " cannot defend himself: He dies."
	CRLF
	SET 'RES,KILLED
	JUMP ?L39
?L25:	EQUAL? DEF,1 \?L40
	GRTR? ATT,2 \?L42
	SET 'ATT,3
?L42:	SUB ATT,1 >STACK
	GET DEF1-RES,STACK >TBL
	JUMP ?L49
?L40:	EQUAL? DEF,2 \?L45
	GRTR? ATT,3 \?L46
	SET 'ATT,4
?L46:	SUB ATT,1 >STACK
	GET DEF2-RES,STACK >TBL
	JUMP ?L49
?L45:	GRTR? DEF,2 \?L49
	SUB ATT,DEF >ATT
	LESS? ATT,-1 \?L50
	SET 'ATT,-2
	JUMP ?L52
?L50:	GRTR? ATT,1 \?L52
	SET 'ATT,2
?L52:	ADD ATT,2 >STACK
	GET DEF3-RES,STACK >TBL
?L49:	RANDOM 9 >STACK
	DEC 'STACK
	GET TBL,STACK >RES
	ZERO? OUT? /?L59
	EQUAL? RES,STAGGER \?L57
	SET 'RES,HESITATE
	JUMP ?L59
?L57:	SET 'RES,SITTING-DUCK
?L59:	EQUAL? RES,STAGGER \?L61
	ZERO? DWEAPON /?L61
	RANDOM 100 >STACK
	GRTR? 25,STACK \?L61
	SET 'RES,LOSE-WEAPON
?L61:	SUB RES,1 >STACK
	GET HERO-MELEE,STACK >STACK
	CALL RANDOM-ELEMENT,STACK >STACK
	CALL REMARK,STACK,PRSO,PRSI
?L39:	EQUAL? RES,MISSED,HESITATE /?L79
	EQUAL? RES,UNCONSCIOUS \?L67
	SUB 0,DEF >DEF
	JUMP ?L79
?L67:	EQUAL? RES,KILLED /?L69
	EQUAL? RES,SITTING-DUCK \?L68
?L69:	SET 'DEF,0
	JUMP ?L79
?L68:	EQUAL? RES,LIGHT-WOUND \?L70
	DLESS? 'DEF,0 \?L79
	SET 'DEF,0
	JUMP ?L79
?L70:	EQUAL? RES,SERIOUS-WOUND \?L74
	SUB DEF,2 >DEF
	LESS? DEF,0 \?L79
	SET 'DEF,0
	JUMP ?L79
?L74:	EQUAL? RES,STAGGER \?L78
	FSET PRSO,STAGGERED
	JUMP ?L79
?L78:	FCLEAR DWEAPON,NDESCBIT
	FSET DWEAPON,WEAPONBIT
	MOVE DWEAPON,HERE
	CALL THIS-IS-IT,DWEAPON
?L79:	CALL VILLAIN-RESULT,PRSO,DEF,RES >STACK
	RSTACK

	.FUNCT WINNER-RESULT,DEF,RES,OD,?TMP
	ZERO? DEF \?L1
	PUSH -10000
	JUMP ?L3
?L1:	SUB DEF,OD >STACK
?L3:	PUTP WINNER,P?STRENGTH,STACK
	SUB DEF,OD >STACK
	LESS? STACK,0 \?L4
	CALL QUEUE,I-CURE,CURE-WAIT >STACK
	PUT STACK,0,1
?L4:	CALL FIGHT-STRENGTH >STACK
	GRTR? STACK,0 /?L7
	SET '?TMP,WINNER
	CALL FIGHT-STRENGTH,0 >STACK
	SUB 0,STACK >STACK
	INC 'STACK
	PUTP ?TMP,P?STRENGTH,STACK
	CALL PRINT-ID,STR?194
	CALL JIGS-UP,STR?195
	RFALSE
?L7:	RETURN RES

	.FUNCT VILLAIN-RESULT,VILLAIN,DEF,RES
	PUTP VILLAIN,P?STRENGTH,DEF
	ZERO? DEF \?L1
	FCLEAR VILLAIN,FIGHTBIT
	PRINTI "Almost as soon as the "
	PRINTD VILLAIN
	PRINTI " breathes his last breath, a cloud of sinister black fog envelops him, and when the fog lifts, the carcass has disappeared."
	CRLF
	CALL REMOVE-CAREFULLY,VILLAIN
	GETP VILLAIN,P?ACTION >STACK
	CALL STACK,F-DEAD >STACK
	RETURN RES
?L1:	EQUAL? RES,UNCONSCIOUS \?L5
	GETP VILLAIN,P?ACTION >STACK
	CALL STACK,F-UNCONSCIOUS >STACK
?L5:	RETURN RES

	.FUNCT WINNING?,V,VS,PS
	GETP V,P?STRENGTH >VS
	CALL FIGHT-STRENGTH >STACK
	SUB VS,STACK >PS
	GRTR? PS,3 \?L1
	RANDOM 100 >STACK
	GRTR? 90,STACK /TRUE
	RFALSE
?L1:	GRTR? PS,0 \?L5
	RANDOM 100 >STACK
	GRTR? 75,STACK /TRUE
	RFALSE
?L5:	ZERO? PS \?L8
	RANDOM 100 >STACK
	GRTR? 50,STACK /TRUE
	RFALSE
?L8:	GRTR? VS,1 \?L11
	RANDOM 100 >STACK
	GRTR? 25,STACK /TRUE
	RFALSE
?L11:	RANDOM 100 >STACK
	GRTR? 10,STACK \FALSE
	RTRUE

	.FUNCT I-CURE,S
	GETP WINNER,P?STRENGTH >S
	GRTR? S,0 \?L1
	SET 'S,0
	PUTP WINNER,P?STRENGTH,S
	JUMP ?L3
?L1:	LESS? S,0 \?L5
	INC 'S
	PUTP WINNER,P?STRENGTH,S
?L3:	LESS? S,0 \?L5
	LESS? LOAD-ALLOWED,LOAD-MAX \?L7
	ADD LOAD-ALLOWED,10 >LOAD-ALLOWED
?L7:	CALL QUEUE,I-CURE,CURE-WAIT >STACK
	PUT STACK,0,1
	RTRUE
?L5:	SET 'LOAD-ALLOWED,LOAD-MAX
	CALL INT,I-CURE >STACK
	PUT STACK,0,0
	RTRUE

	.FUNCT I-FIGHT,FIGHT?=0,LEN,CNT,OO,O,P
	GET VILLAINS,0 >LEN
	ZERO? DEAD \FALSE
	SET 'CNT,0
?L4:	INC 'CNT
	EQUAL? CNT,LEN /?L5
	GET VILLAINS,CNT >OO
	GET OO,V-VILLAIN >O
	IN? O,HERE \?L9
	FSET? O,INVISIBLE /?L9
	EQUAL? O,THIEF \?L11
	ZERO? THIEF-ENGROSSED /?L11
	SET 'THIEF-ENGROSSED,0
	JUMP ?L4
?L11:	GETP O,P?STRENGTH >STACK
	LESS? STACK,0 \?L13
	GET OO,V-PROB >P
	ZERO? P /?L14
	RANDOM 100 >STACK
	GRTR? P,STACK \?L14
	PUT OO,V-PROB,0
	CALL AWAKEN,O
	JUMP ?L4
?L14:	ADD P,25 >STACK
	PUT OO,V-PROB,STACK
	JUMP ?L4
?L13:	FSET? O,FIGHTBIT /?L18
	GETP O,P?ACTION >STACK
	CALL STACK,F-FIRST? >STACK
	ZERO? STACK /?L4
?L18:	SET 'FIGHT?,1
	JUMP ?L4
?L9:	FSET? O,FIGHTBIT \?L21
	GETP O,P?ACTION >STACK
	CALL STACK,F-BUSY? >STACK
?L21:	EQUAL? O,THIEF \?L24
	SET 'THIEF-ENGROSSED,0
?L24:	FCLEAR WINNER,STAGGERED
	FCLEAR O,STAGGERED
	FCLEAR O,FIGHTBIT
	CALL AWAKEN,O
	JUMP ?L4
?L5:	ZERO? FIGHT? /FALSE
	CALL DO-FIGHT,LEN >STACK
	RSTACK

	.FUNCT AWAKEN,O,S
	GETP O,P?STRENGTH >S
	LESS? S,0 \TRUE
	SUB 0,S >STACK
	PUTP O,P?STRENGTH,STACK
	GETP O,P?ACTION >STACK
	CALL STACK,F-CONSCIOUS >STACK
	RTRUE

	.FUNCT I-SWORD,DEM,G,NG=0,P,T,L
	CALL INT,I-SWORD >DEM
	GETP SWORD,P?TVALUE >G
	IN? SWORD,ADVENTURER \?L1
	CALL INFESTED?,HERE >STACK
	ZERO? STACK /?L3
	SET 'NG,2
	JUMP ?L7
?L3:	SET 'P,0
?L6:	NEXTP HERE,P >P
	ZERO? P /?L7
	LESS? P,P?LAND /?L6
	GETPT HERE,P >T
	PTSIZE T >L
	EQUAL? L,UEXIT,CEXIT,DEXIT \?L6
	GETB T,0 >STACK
	CALL INFESTED?,STACK >STACK
	ZERO? STACK /?L6
	SET 'NG,1
?L7:	EQUAL? NG,G /FALSE
	EQUAL? NG,2 \?L20
	PRINTI "Your sword has begun to glow very brightly."
	CRLF
	JUMP ?L26
?L20:	EQUAL? NG,1 \?L23
	PRINTI "Your sword is glowing with a faint blue glow."
	CRLF
	JUMP ?L26
?L23:	ZERO? NG \?L26
	PRINTI "Your sword is no longer glowing."
	CRLF
?L26:	PUTP SWORD,P?TVALUE,NG
	RTRUE
?L1:	PUT DEM,C-ENABLED?,0
	RFALSE

	.FUNCT INFESTED?,R,F
	FIRST? R >F \FALSE
?L4:	FSET? F,ACTORBIT \?L6
	FSET? F,INVISIBLE \TRUE
?L6:	NEXT? F >F /?L4
	RFALSE

	.FUNCT I-THIEF,RM,ROBJ,HERE?,ONCE=0,FLG=0
	LOC THIEF >RM
?L1:	FSET? THIEF,INVISIBLE /?L5
	SET 'HERE?,1
	JUMP ?L6
?L5:	SET 'HERE?,0
?L6:	ZERO? HERE? /?L3
	LOC THIEF >RM
?L3:	EQUAL? RM,TREASURE-ROOM \?L8
	EQUAL? RM,HERE /?L47
	ZERO? HERE? /?L10
	CALL HACK-TREASURES
	SET 'HERE?,0
?L10:	CALL DEPOSIT-BOOTY,TREASURE-ROOM
	JUMP ?L28
?L8:	EQUAL? RM,HERE \?L13
?L47:	FSET? RM,ONBIT /?L13
	IN? TROLL,HERE /?L13
	CALL THIEF-VS-ADVENTURER,HERE? >STACK
	ZERO? STACK \TRUE
	FSET? THIEF,INVISIBLE \?L28
	SET 'HERE?,0
	JUMP ?L28
?L13:	IN? THIEF,RM \?L21
	FSET? THIEF,INVISIBLE /?L21
	FSET THIEF,INVISIBLE
	SET 'HERE?,0
?L21:	FSET? RM,TOUCHBIT \?L28
	CALL ROB,RM,THIEF,75
	FSET? RM,MAZEBIT \?L26
	FSET? HERE,MAZEBIT \?L26
	CALL ROB-MAZE,RM >FLG
	JUMP ?L28
?L26:	CALL STEAL-JUNK,RM >FLG
?L28:	ZERO? ONCE \?L32
	SET 'ONCE,1
	JUMP ?L33
?L32:	SET 'ONCE,0
?L33:	ZERO? ONCE /?L30
	ZERO? HERE? \?L30
	CALL RECOVER-STILETTO
?L34:	ZERO? RM /?L36
	NEXT? RM >RM /?L39
?L36:	FIRST? ROOMS >RM /?L39
?L39:	FSET? RM,SACREDBIT /?L34
	FSET? RM,RLANDBIT \?L34
	MOVE THIEF,RM
	FCLEAR THIEF,FIGHTBIT
	FSET THIEF,INVISIBLE
	SET 'THIEF-HERE,0
	JUMP ?L1
?L30:	EQUAL? RM,TREASURE-ROOM /?L44
	CALL DROP-JUNK,RM
?L44:	RETURN FLG

	.FUNCT DROP-JUNK,RM,X,N,FLG=0
	FIRST? THIEF >X /?L4
	RETURN FLG
?L1:	ZERO? X \?L4
	RETURN FLG
?L4:	NEXT? X >N /?L7
?L7:	EQUAL? X,STILETTO,LARGE-BAG /?L11
	GETP X,P?TVALUE >STACK
	ZERO? STACK \?L11
	CALL ZPROB,30 >STACK
	ZERO? STACK /?L11
	FCLEAR X,INVISIBLE
	MOVE X,RM
	ZERO? FLG \?L11
	EQUAL? RM,HERE \?L11
	PRINTI "The robber, rummaging through his bag, dropped a few items he found valueless."
	CRLF
	SET 'FLG,1
?L11:	SET 'X,N
	JUMP ?L1

	.FUNCT RECOVER-STILETTO
	LOC THIEF >STACK
	IN? STILETTO,STACK \FALSE
	FSET STILETTO,NDESCBIT
	MOVE STILETTO,THIEF
	RTRUE

	.FUNCT STEAL-JUNK,RM,X,N
	FIRST? RM >X /?L4
	RFALSE
?L1:	ZERO? X /FALSE
?L4:	NEXT? X >N /?L7
?L7:	GETP X,P?TVALUE >STACK
	ZERO? STACK \?L18
	FSET? X,TAKEBIT \?L18
	FSET? X,SACREDBIT /?L18
	FSET? X,INVISIBLE /?L18
	EQUAL? X,STILETTO /?L10
	CALL ZPROB,10 >STACK
	ZERO? STACK /?L18
?L10:	MOVE X,THIEF
	FSET X,TOUCHBIT
	FSET X,INVISIBLE
	EQUAL? X,ROPE \?L11
	SET 'DOME-FLAG,0
?L11:	EQUAL? RM,HERE \FALSE
	PRINTI "You suddenly notice that the "
	PRINTD X
	PRINTR " vanished."
?L18:	SET 'X,N
	JUMP ?L1

	.FUNCT ROB,WHAT,WHERE,PROB=0,N,X,ROBBED?=0
	FIRST? WHAT >X /?L4
	RETURN ROBBED?
?L1:	ZERO? X \?L4
	RETURN ROBBED?
?L4:	NEXT? X >N /?L7
?L7:	FSET? X,INVISIBLE /?L8
	FSET? X,SACREDBIT /?L8
	GETP X,P?TVALUE >STACK
	GRTR? STACK,0 \?L8
	ZERO? PROB /?L10
	RANDOM 100 >STACK
	GRTR? PROB,STACK \?L8
?L10:	MOVE X,WHERE
	FSET X,TOUCHBIT
	EQUAL? WHERE,THIEF \?L11
	FSET X,INVISIBLE
?L11:	SET 'ROBBED?,1
?L8:	SET 'X,N
	JUMP ?L1

	.FUNCT V-DIAGNOSE,MS,WD,RS,?TMP
	CALL FIGHT-STRENGTH,0 >MS
	GETP WINNER,P?STRENGTH >WD
	ADD MS,WD >RS
	CALL INT,I-CURE >STACK
	GET STACK,C-ENABLED? >STACK
	ZERO? STACK \?L1
	SET 'WD,0
	JUMP ?L3
?L1:	SUB 0,WD >WD
?L3:	ZERO? WD \?L4
	PRINTI "You are in perfect health."
	JUMP ?L21
?L4:	PRINTI "You have "
	EQUAL? WD,1 \?L11
	PRINTI "a light wound,"
	JUMP ?L21
?L11:	EQUAL? WD,2 \?L15
	PRINTI "a serious wound,"
	JUMP ?L21
?L15:	EQUAL? WD,3 \?L18
	PRINTI "several wounds,"
	JUMP ?L21
?L18:	GRTR? WD,3 \?L21
	PRINTI "serious wounds,"
?L21:	ZERO? WD /?L25
	PRINTI " which will be cured after "
	SUB WD,1 >STACK
	MUL CURE-WAIT,STACK >?TMP
	CALL INT,I-CURE >STACK
	GET STACK,C-TICK >STACK
	ADD ?TMP,STACK >STACK
	PRINTN STACK
	PRINTI " moves."
?L25:	CRLF
	PRINTI "You can "
	ZERO? RS \?L34
	PRINTI "expect death soon"
	JUMP ?L47
?L34:	EQUAL? RS,1 \?L38
	PRINTI "be killed by one more light wound"
	JUMP ?L47
?L38:	EQUAL? RS,2 \?L41
	PRINTI "be killed by a serious wound"
	JUMP ?L47
?L41:	EQUAL? RS,3 \?L44
	PRINTI "survive one serious wound"
	JUMP ?L47
?L44:	GRTR? RS,3 \?L47
	PRINTI "survive several wounds"
?L47:	PRINTI "."
	CRLF
	ZERO? DEATHS /FALSE
	PRINTI "You have been killed "
	EQUAL? DEATHS,1 \?L57
	PRINTI "once"
	JUMP ?L61
?L57:	PRINTI "twice"
?L61:	PRINTR "."

	.FUNCT V-SCORE,ASK?=1
	PRINTI "Your score is "
	PRINTN SCORE
	PRINTI " (total of 360 points), in "
	PRINTN MOVES
	EQUAL? MOVES,1 \?L9
	PRINTI " move."
	JUMP ?L13
?L9:	PRINTI " moves."
?L13:	CRLF
	PRINTI "This gives you the rank of "
	GRTR? SCORE,349 \?L18
	PRINTI "Master Adventurer"
	JUMP ?L40
?L18:	GRTR? SCORE,330 \?L22
	PRINTI "Wizard"
	JUMP ?L40
?L22:	GRTR? SCORE,300 \?L25
	PRINTI "Master"
	JUMP ?L40
?L25:	GRTR? SCORE,200 \?L28
	PRINTI "Adventurer"
	JUMP ?L40
?L28:	GRTR? SCORE,100 \?L31
	PRINTI "Junior Adventurer"
	JUMP ?L40
?L31:	GRTR? SCORE,50 \?L34
	PRINTI "Novice Adventurer"
	JUMP ?L40
?L34:	GRTR? SCORE,25 \?L37
	PRINTI "Amateur Adventurer"
	JUMP ?L40
?L37:	PRINTI "Beginner"
?L40:	PRINTI "."
	CRLF
	RETURN SCORE

	.FUNCT JIGS-UP,DESC,PLAYER?=0
	SET 'WINNER,ADVENTURER
	ZERO? DEAD /?L1
	PRINTI "
It takes a talented person to be killed while already dead. YOU are such a talent. Unfortunately, it takes a talented person to deal with it. I am not such a talent. Sorry."
	CRLF
	CALL FINISH
?L1:	PRINT DESC
	CRLF
	ZERO? LUCKY \?L8
	PRINTI "Bad luck, huh?"
	CRLF
?L8:	CALL SCORE-UPD,-10
	PRINTI " 
   ****  You have died  **** 

"
	LOC WINNER >STACK
	FSET? STACK,VEHBIT \?L17
	MOVE WINNER,HERE
?L17:	LESS? DEATHS,2 /?L20
	PRINTI "You clearly are a suicidal maniac. We don't allow psychotics in the cave, since they may harm other adventurers. Your remains will be installed in the Land of the Living Dead, where your fellow adventurers may gloat over them."
	CRLF
	CALL FINISH >STACK
	RSTACK
?L20:	INC 'DEATHS
	MOVE WINNER,HERE
	FSET? SOUTH-TEMPLE,TOUCHBIT \?L25
	PRINTI "As you take your last breath, you feel relieved of your burdens. The feeling passes as you find yourself before the gates of Hell, where the spirits jeer at you and deny you entry. Your senses are disturbed. The objects in the dungeon appear indistinct, bleached of color, even unreal."
	CRLF
	CRLF
	SET 'DEAD,1
	SET 'TROLL-FLAG,1
	SET 'ALWAYS-LIT,1
	PUTP WINNER,P?ACTION,DEAD-FUNCTION
	CALL GOTO,ENTRANCE-TO-HADES
	JUMP ?L29
?L25:	PRINTI "Now, let's take a look here... Well, you probably deserve another chance. I can't quite fix you up completely, but you can't have everything."
	CRLF
	CRLF
	CALL GOTO,FOREST-1
?L29:	FCLEAR TRAP-DOOR,TOUCHBIT
	SET 'P-CONT,0
	CALL RANDOMIZE-OBJECTS
	CALL KILL-INTERRUPTS
	RETURN 2

	.FUNCT RANDOMIZE-OBJECTS,R=0,F,N,L
	IN? LAMP,WINNER \?L1
	MOVE LAMP,LIVING-ROOM
?L1:	IN? COFFIN,WINNER \?L4
	MOVE COFFIN,EGYPT-ROOM
?L4:	PUTP SWORD,P?TVALUE,0
	FIRST? WINNER >N /?L7
?L7:	GET ABOVE-GROUND,0 >L
?L8:	SET 'F,N
	ZERO? F /TRUE
	NEXT? F >N /?L13
?L13:	GETP F,P?TVALUE >STACK
	GRTR? STACK,0 \?L14
	ZERO? R \?L20
?L27:	FIRST? ROOMS >R /?L20
?L20:	FSET? R,RLANDBIT \?L22
	FSET? R,ONBIT /?L22
	RANDOM 100 >STACK
	GRTR? 50,STACK \?L22
	MOVE F,R
	JUMP ?L8
?L22:	NEXT? R >R /?L20
	JUMP ?L27
?L14:	RANDOM L >STACK
	GET ABOVE-GROUND,STACK >STACK
	MOVE F,STACK
	JUMP ?L8

	.FUNCT KILL-INTERRUPTS
	CALL INT,I-XB >STACK
	PUT STACK,0,0
	CALL INT,I-XC >STACK
	PUT STACK,0,0
	CALL INT,I-CYCLOPS >STACK
	PUT STACK,0,0
	CALL INT,I-LANTERN >STACK
	PUT STACK,0,0
	CALL INT,I-CANDLES >STACK
	PUT STACK,0,0
	CALL INT,I-SWORD >STACK
	PUT STACK,0,0
	CALL INT,I-FOREST-ROOM >STACK
	PUT STACK,0,0
	CALL INT,I-MATCH >STACK
	PUT STACK,0,0
	FCLEAR MATCH,ONBIT
	RTRUE

	.FUNCT BAG-OF-COINS-F
	CALL STUPID-CONTAINER,BAG-OF-COINS,STR?196 >STACK
	RSTACK

	.FUNCT TRUNK-F
	CALL STUPID-CONTAINER,TRUNK,STR?197 >STACK
	RSTACK

	.FUNCT STUPID-CONTAINER,OBJ,STR
	EQUAL? PRSA,V?CLOSE,V?OPEN \?L1
	PRINTI "The "
	PRINT STR
	PRINTR " are safely inside; there's no need to do that."
?L1:	EQUAL? PRSA,V?EXAMINE,V?LOOK-INSIDE \?L5
	PRINTI "There are lots of "
	PRINT STR
	PRINTR " in there."
?L5:	EQUAL? PRSA,V?PUT \FALSE
	EQUAL? PRSI,OBJ \FALSE
	PRINTI "Don't be silly. It wouldn't be a "
	PRINTD OBJ
	PRINTR " anymore."

	.FUNCT DUMB-CONTAINER
	EQUAL? PRSA,V?LOOK-INSIDE,V?CLOSE,V?OPEN \?L1
	PRINTR "You can't do that."
?L1:	EQUAL? PRSA,V?EXAMINE \FALSE
	PRINTI "It looks pretty much like a "
	PRINTD PRSO
	PRINTR "."

	.FUNCT GARLIC-F
	EQUAL? PRSA,V?EAT \FALSE
	CALL REMOVE-CAREFULLY,PRSO
	PRINTR "What the heck! You won't make friends this way, but nobody around here is too friendly anyhow. Gulp!"

	.FUNCT CHAIN-PSEUDO
	EQUAL? PRSA,V?MOVE,V?TAKE \?L1
	PRINTR "The chain is secure."
?L1:	EQUAL? PRSA,V?LOWER,V?RAISE \?L5
	PRINTR "Perhaps you should do that to the basket."
?L5:	EQUAL? PRSA,V?EXAMINE \FALSE
	PRINTR "The chain secures a basket within the shaft."

	.FUNCT TROLL-ROOM-F,RARG
	EQUAL? RARG,M-ENTER \FALSE
	IN? TROLL,HERE \FALSE
	CALL THIS-IS-IT,TROLL >STACK
	RSTACK

	.INSERT "./annotated_games/zork1/zork1_str"
	.END
