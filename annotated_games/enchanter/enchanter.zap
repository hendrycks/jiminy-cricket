	.INSERT "enchanter/enchanter_freq"
	.INSERT "enchanter/enchanter_data"

	.FUNCT QUEUE,RTN,TICK,CINT
	CALL INT,RTN >CINT
	PUT CINT,C-TICK,TICK
	RETURN CINT

	.FUNCT INT,RTN,DEMON=0,E,C,INT?1
	ADD C-TABLE,C-TABLELEN >E
	ADD C-TABLE,C-INTS >C
?L1:	EQUAL? C,E \?L3
	SUB C-INTS,C-INTLEN >C-INTS
	ZERO? DEMON /?L5
	SUB C-DEMONS,C-INTLEN >C-DEMONS
?L5:	ADD C-TABLE,C-INTS >INT?1
	PUT INT?1,C-RTN,RTN
	RETURN INT?1
?L3:	GET C,C-RTN >STACK
	EQUAL? STACK,RTN \?L7
	RETURN C
?L7:	ADD C,C-INTLEN >C
	JUMP ?L1

	.FUNCT CLOCKER,C,E,TICK,FLG=0
	ZERO? CLOCK-WAIT /?L1
	SET 'CLOCK-WAIT,0
	RFALSE
?L1:	ZERO? P-WON /?L4
	PUSH C-INTS
	JUMP ?L6
?L4:	PUSH C-DEMONS
?L6:	ADD C-TABLE,STACK >C
	ADD C-TABLE,C-TABLELEN >E
?L7:	EQUAL? C,E \?L9
	INC 'MOVES
	RETURN FLG
?L9:	GET C,C-ENABLED? >STACK
	ZERO? STACK /?L15
	GET C,C-TICK >TICK
	ZERO? TICK /?L15
	SUB TICK,1 >STACK
	PUT C,C-TICK,STACK
	GRTR? TICK,1 /?L15
	GET C,C-RTN >STACK
	CALL STACK >STACK
	ZERO? STACK /?L15
	SET 'FLG,1
?L15:	ADD C,C-INTLEN >C
	JUMP ?L7

	.FUNCT PRINTA,O
	FSET? O,VOWELBIT \?L3
	PUSH STR?4
	JUMP ?L5
?L3:	PUSH STR?5
?L5:	PRINT STACK
	PRINTD O
	RTRUE

	.FUNCT RANDOM-ELEMENT,FROB
	GET FROB,0 >STACK
	RANDOM STACK >STACK
	GET FROB,STACK >STACK
	RSTACK

	.FUNCT PICK-ONE,FROB,L,CNT,RND,MSG,RFROB
	GET FROB,0 >L
	GET FROB,1 >CNT
	DEC 'L
	ADD FROB,2 >FROB
	MUL CNT,2 >STACK
	ADD FROB,STACK >RFROB
	SUB L,CNT >STACK
	RANDOM STACK >RND
	GET RFROB,RND >MSG
	GET RFROB,1 >STACK
	PUT RFROB,RND,STACK
	PUT RFROB,1,MSG
	INC 'CNT
	EQUAL? CNT,L \?L1
	SET 'CNT,0
?L1:	PUT FROB,0,CNT
	RETURN MSG

	.FUNCT GO
START::
?L0:	PUTB P-LEXV,0,59
	CALL QUEUE,I-TIRED,MOVES-PER-DAY >STACK
	PUT STACK,0,1
	CALL QUEUE,I-THIRST,41 >STACK
	PUT STACK,0,1
	CALL QUEUE,I-HUNGER,67 >STACK
	PUT STACK,0,1
	CALL QUEUE,I-TIME,-1 >STACK
	PUT STACK,0,1
	CALL QUEUE,I-SCURRY,5 >STACK
	PUT STACK,0,1
	CALL QUEUE,I-MUNG-ROOM,50 >STACK
	PUT STACK,0,1
	CALL QUEUE,I-GUARDS-ARRIVE,0 >STACK
	PUT STACK,0,1
	CALL QUEUE,I-ADVENTURER,0 >STACK
	PUT STACK,0,1
	SET 'LIT,1
	SET 'WINNER,PLAYER
	SET 'HERE,WEST-FORK
	SET 'P-IT-OBJECT,0
	FSET? HERE,TOUCHBIT /?L1
	PRINTI "It must be the warlock Krill. The odd disappearances, the mysterious dissolution of regions sacred to the Circle, the lessening of the Powers -- these could only be his handiwork. The Circle gathers and its leader, the esteemed Belboz, reveals to them an ancient document which portends evil days much like our own.

""Krill's evil must be unmade,"" he begins, ""but to send a powerful Enchanter is ill-omened. It would be ruinous to reveal oversoon our full powers."" A ripple of concern spreads over the face of each Enchanter. Belboz pauses, and collects his resolve. ""Have hope! This has been written by a hand far wiser than mine!""

He recites a short spell and you appear. Belboz approaches, transfixing you with his gaze, and hands you the document. The other Enchanters await his decree. ""These words, written ages ago, can have only one meaning. You, a novice Enchanter with but a few simple spells in your Book, must seek out Krill, explore the Castle he has overthrown, and learn his secrets. Only then may his vast evil be lessened or, with good fortune, destroyed.""

The Circle rises and intones a richly woven spell, whose many textures imbue the small, darkened chamber with warmth and hope. There is a surge of power; you are Sent."
	CRLF
	CRLF
	CALL V-VERSION
	CRLF
?L1:	MOVE WINNER,HERE
	CALL V-LOOK
	CALL MAIN-LOOP
	JUMP ?L0

	.FUNCT MAIN-LOOP,TRASH
?L1:	CALL MAIN-LOOP-1 >TRASH
	JUMP ?L1

	.FUNCT MAIN-LOOP-1,ICNT,OCNT,NUM,CNT,OBJ,TBL,V,PTBL,OBJ1,TMP
	SET 'CNT,0
	SET 'OBJ,0
	SET 'PTBL,1
	CALL PARSER >P-WON
	ZERO? P-WON /?L1
	GET P-PRSI,P-MATCHLEN >ICNT
	GET P-PRSO,P-MATCHLEN >OCNT
	ZERO? P-IT-OBJECT /?L3
	CALL ACCESSIBLE?,P-IT-OBJECT >STACK
	ZERO? STACK /?L3
	SET 'TMP,0
?L5:	IGRTR? 'CNT,ICNT /?L6
	GET P-PRSI,CNT >STACK
	EQUAL? STACK,IT \?L5
	PUT P-PRSI,CNT,P-IT-OBJECT
	SET 'TMP,1
?L6:	ZERO? TMP \?L16
	SET 'CNT,0
?L15:	IGRTR? 'CNT,OCNT /?L16
	GET P-PRSO,CNT >STACK
	EQUAL? STACK,IT \?L15
	PUT P-PRSO,CNT,P-IT-OBJECT
?L16:	SET 'CNT,0
?L3:	ZERO? OCNT \?L25
	SET 'NUM,OCNT
	JUMP ?L32
?L25:	GRTR? OCNT,1 \?L27
	SET 'TBL,P-PRSO
	ZERO? ICNT \?L28
	SET 'OBJ,0
	JUMP ?L30
?L28:	GET P-PRSI,1 >OBJ
?L30:	SET 'NUM,OCNT
	JUMP ?L32
?L27:	GRTR? ICNT,1 \?L31
	SET 'PTBL,0
	SET 'TBL,P-PRSI
	GET P-PRSO,1 >OBJ
	SET 'NUM,ICNT
	JUMP ?L32
?L31:	SET 'NUM,1
?L32:	ZERO? OBJ \?L33
	EQUAL? ICNT,1 \?L33
	GET P-PRSI,1 >OBJ
?L33:	EQUAL? PRSA,V?WALK \?L36
	CALL PERFORM,PRSA,PRSO >V
	JUMP ?L58
?L36:	ZERO? NUM \?L38
	GETB P-SYNTAX,P-SBITS >STACK
	BAND STACK,P-SONUMS >STACK
	ZERO? STACK \?L39
	CALL PERFORM,PRSA >V
	SET 'PRSO,0
	JUMP ?L58
?L39:	ZERO? LIT \?L41
	PRINTI "It's too dark to see."
	CRLF
	JUMP ?L58
?L41:	PRINTI "There isn't anything to "
	GET P-ITBL,P-VERBN >TMP
	ZERO? P-OFLAG \?L49
	ZERO? P-MERGED /?L47
?L49:	GET TMP,0 >STACK
	PRINTB STACK
	JUMP ?L50
?L47:	GETB TMP,3 >STACK
	GETB TMP,2 >STACK
	CALL WORD-PRINT,STACK,STACK
?L50:	PRINTI "!"
	CRLF
	SET 'V,0
	JUMP ?L58
?L38:	SET 'P-NOT-HERE,0
	SET 'P-MULT,0
	GRTR? NUM,1 \?L54
	SET 'P-MULT,1
?L54:	SET 'TMP,0
?L57:	IGRTR? 'CNT,NUM \?L59
	GRTR? P-NOT-HERE,0 \?L61
	PRINTI "The "
	EQUAL? P-NOT-HERE,NUM /?L65
	PRINTI "other "
?L65:	PRINTI "object"
	EQUAL? P-NOT-HERE,1 /?L72
	PRINTI "s"
?L72:	PRINTI " that you mentioned "
	EQUAL? P-NOT-HERE,1 /?L79
	PRINTI "are"
	JUMP ?L83
?L79:	PRINTI "is"
?L83:	PRINTI "n't here."
	CRLF
	JUMP ?L58
?L61:	ZERO? TMP \?L58
	PRINTI "I don't know what you're referring to."
	CRLF
	JUMP ?L58
?L59:	ZERO? PTBL /?L93
	GET P-PRSO,CNT >OBJ1
	JUMP ?L95
?L93:	GET P-PRSI,CNT >OBJ1
?L95:	ZERO? PTBL /?L96
	SET 'PRSO,OBJ1
	JUMP ?L98
?L96:	SET 'PRSO,OBJ
?L98:	ZERO? PTBL /?L99
	SET 'PRSI,OBJ
	JUMP ?L101
?L99:	SET 'PRSI,OBJ1
?L101:	EQUAL? PRSA,V?ERASE-LINE,V?MAKE-LINE /?L110
	GRTR? NUM,1 /?L105
	GET P-ITBL,P-NC1 >STACK
	GET STACK,0 >STACK
	EQUAL? STACK,W?ALL \?L110
?L105:	EQUAL? OBJ1,NOT-HERE-OBJECT \?L106
	INC 'P-NOT-HERE
	JUMP ?L57
?L106:	EQUAL? P-GETFLAGS,P-ALL \?L108
	EQUAL? PRSA,V?TAKE \?L109
	LOC OBJ1 >STACK
	EQUAL? STACK,WINNER,HERE,OBJ \?L57
?L108:	EQUAL? PRSA,V?TAKE \?L109
	ZERO? PRSI /?L109
	GET P-ITBL,P-NC1 >STACK
	GET STACK,0 >STACK
	EQUAL? STACK,W?ALL \?L109
	IN? PRSO,PRSI \?L57
?L109:	EQUAL? OBJ1,IT \?L111
	PRINTD P-IT-OBJECT
	JUMP ?L113
?L111:	PRINTD OBJ1
?L113:	PRINTI ": "
?L110:	SET 'TMP,1
	CALL PERFORM,PRSA,PRSO,PRSI >V
	EQUAL? V,M-FATAL \?L57
?L58:	EQUAL? V,M-FATAL /?L122
	LOC WINNER >STACK
	ZERO? STACK /?L122
	LOC WINNER >STACK
	GETP STACK,P?ACTION >STACK
	CALL STACK,M-END >V
?L122:	EQUAL? PRSA,V?SCORE,V?RESTORE,V?SAVE /?L129
	EQUAL? PRSA,V?VERSION /?L129
	SET 'L-PRSA,PRSA
	SET 'L-PRSO,PRSO
	SET 'L-PRSI,PRSI
?L129:	EQUAL? V,M-FATAL \?L133
	SET 'P-CONT,0
	JUMP ?L133
?L1:	SET 'P-CONT,0
?L133:	ZERO? P-WON /FALSE
	EQUAL? PRSA,V?SUPER-BRIEF,V?BRIEF,V?TELL /TRUE
	EQUAL? PRSA,V?VERSION,V?SAVE,V?VERBOSE /TRUE
	EQUAL? PRSA,V?RESTART,V?QUIT,V?TIME /TRUE
	EQUAL? PRSA,V?UNSCRIPT,V?SCRIPT,V?SCORE /TRUE
	EQUAL? PRSA,V?RESTORE /TRUE
	CALL CLOCKER >V
	RETURN V

	.FUNCT PERFORM,A,O=0,I=0,V,OA,OO,OI
	SET 'OA,PRSA
	SET 'OO,PRSO
	SET 'OI,PRSI
	EQUAL? IT,I,O \?L1
	CALL ACCESSIBLE?,P-IT-OBJECT >STACK
	ZERO? STACK \?L1
	PRINTI "I don't see what you are referring to."
	CRLF
	RETURN 2
?L1:	EQUAL? O,IT \?L8
	SET 'O,P-IT-OBJECT
?L8:	EQUAL? I,IT \?L11
	SET 'I,P-IT-OBJECT
?L11:	SET 'PRSA,A
	SET 'PRSO,O
	ZERO? PRSO /?L14
	EQUAL? PRSA,V?WALK /?L14
	SET 'P-IT-OBJECT,PRSO
?L14:	SET 'PRSI,I
	EQUAL? NOT-HERE-OBJECT,PRSO,PRSI \?L17
	CALL NOT-HERE-OBJECT-F >V
	ZERO? V /?L17
	SET 'P-WON,0
	JUMP ?L27
?L17:	SET 'O,PRSO
	SET 'I,PRSI
	GETP WINNER,P?ACTION >STACK
	CALL STACK >V
	ZERO? V \?L27
	LOC WINNER >STACK
	GETP STACK,P?ACTION >STACK
	CALL STACK,M-BEG >V
	ZERO? V \?L27
	GET PREACTIONS,A >STACK
	CALL STACK >V
	ZERO? V \?L27
	ZERO? I /?L24
	GETP I,P?ACTION >STACK
	CALL STACK >V
	ZERO? V \?L27
?L24:	ZERO? O /?L26
	EQUAL? A,V?WALK /?L25
	LOC O >STACK
	ZERO? STACK /?L25
	LOC O >STACK
	GETP STACK,P?CONTFCN >STACK
	CALL STACK >V
	ZERO? V \?L27
?L25:	ZERO? O /?L26
	EQUAL? A,V?WALK /?L26
	GETP O,P?ACTION >STACK
	CALL STACK >V
	ZERO? V \?L27
?L26:	GET ACTIONS,A >STACK
	CALL STACK >V
	ZERO? V /?L27
?L27:	SET 'PRSA,OA
	SET 'PRSO,OO
	SET 'PRSI,OI
	RETURN V

	.FUNCT I-TIME
	EQUAL? HASTED?,ME \?L1
	MOD MOVES,2 >STACK
	ZERO? STACK /TRUE
?L1:	IGRTR? 'TOD,127 \?L4
	SET 'TOD,0
	SUB NIGHTFALL,20 >NIGHTFALL
	INC 'LOSSAGE
	SUB DUSK,20 >DUSK
	ADD MOLESTED,5 >MOLESTED
	ADD MUNCHED,5 >MUNCHED
	LESS? NIGHTFALL,0 \?L4
	PRINTI "Belboz appears before you, in a magical sending. He speaks, his voice soft and saddened. ""You have failed. Universal night has now fallen. Krill and his creatures now may freely roam the earth. The power of the Circle is diminished, if not broken. I go to prepare the last defense."" The sending vanishes."
	CRLF
	CALL FINISH
?L4:	EQUAL? TOD,NIGHTFALL \?L10
	LOC PLAYER >STACK
	FSET? STACK,ONBIT \?L10
	PRINTI "The darkened sky is now full of bright stars. It is night."
	CRLF
	LESS? NIGHTFALL,97 \TRUE
	PRINTR "Today seemed shorter than yesterday, somehow."
?L10:	EQUAL? TOD,SUNRISE \?L19
	LOC PLAYER >STACK
	FSET? STACK,ONBIT \?L19
	PRINTR "The sun has now risen above the hills."
?L19:	EQUAL? TOD,DUSK \FALSE
	LOC PLAYER >STACK
	FSET? STACK,ONBIT \FALSE
	PRINTI "The sun starts to set behind the Lonely Mountain in the west."
	CRLF
	LESS? NIGHTFALL,97 \TRUE
	PRINTR "The day is coming to an end earlier than you would have expected."

	.FUNCT PARSER,PTR=P-LEXSTART,WRD,VAL=0,VERB=0,OF-FLAG=0,OWINNER,OMERGED,LEN,DIR=0,NW=0,LW=0,CNT=-1
?L1:	IGRTR? 'CNT,P-ITBLLEN /?L2
	ZERO? P-OFLAG \?L6
	GET P-ITBL,CNT >STACK
	PUT P-OTBL,CNT,STACK
?L6:	PUT P-ITBL,CNT,0
	JUMP ?L1
?L2:	SET 'OWINNER,WINNER
	SET 'OMERGED,P-MERGED
	SET 'P-ADVERB,0
	SET 'P-MERGED,0
	SET 'P-END-ON-PREP,0
	PUT P-PRSO,P-MATCHLEN,0
	PUT P-PRSI,P-MATCHLEN,0
	PUT P-BUTS,P-MATCHLEN,0
	ZERO? QUOTE-FLAG \?L9
	EQUAL? WINNER,PLAYER /?L9
	SET 'WINNER,PLAYER
	CALL META-LOC,PLAYER >HERE
	CALL LIT?,HERE >LIT
?L9:	ZERO? RESERVE-PTR /?L12
	SET 'PTR,RESERVE-PTR
	CALL STUFF,RESERVE-LEXV,P-LEXV
	ZERO? SUPER-BRIEF \?L14
	EQUAL? PLAYER,WINNER \?L14
	CRLF
?L14:	SET 'RESERVE-PTR,0
	SET 'P-CONT,0
	JUMP ?L21
?L12:	ZERO? P-CONT /?L17
	SET 'PTR,P-CONT
	ZERO? SUPER-BRIEF \?L18
	EQUAL? PLAYER,WINNER \?L18
	EQUAL? PRSA,V?SAY /?L18
	CRLF
?L18:	SET 'P-CONT,0
	JUMP ?L21
?L17:	SET 'WINNER,PLAYER
	SET 'QUOTE-FLAG,0
	LOC WINNER >STACK
	FSET? STACK,VEHBIT /?L22
	LOC WINNER >HERE
?L22:	CALL LIT?,HERE >LIT
	ZERO? SUPER-BRIEF \?L25
	CRLF
?L25:	PRINTI ">"
	READ P-INBUF,P-LEXV
?L21:	GETB P-LEXV,P-LEXWORDS >P-LEN
	ZERO? P-LEN \?L30
	PRINTI "I beg your pardon?"
	CRLF
	RFALSE
?L30:	GET P-LEXV,PTR >WRD
	EQUAL? WRD,W?OOPS \?L35
	ADD PTR,P-LEXELEN >STACK
	GET P-LEXV,STACK >STACK
	EQUAL? STACK,W?$PERIOD,W?$COMMA \?L37
	ADD PTR,P-LEXELEN >PTR
	DEC 'P-LEN
?L37:	GRTR? P-LEN,1 /?L40
	PRINTI "I can't help your clumsiness."
	CRLF
	RFALSE
?L40:	GET OOPS-TABLE,O-PTR >STACK
	ZERO? STACK /?L44
	GRTR? P-LEN,2 \?L49
	ADD PTR,P-LEXELEN >STACK
	GET P-LEXV,STACK >STACK
	EQUAL? STACK,W?$QUOTE \?L45
	PRINTI "Sorry, you can't correct mistakes in quoted text."
	CRLF
	RFALSE
?L45:	GRTR? P-LEN,2 \?L49
	PRINTI "Warning: only the first word after OOPS is used."
	CRLF
?L49:	ADD PTR,P-LEXELEN >STACK
	GET P-LEXV,STACK >STACK
	GET OOPS-TABLE,O-PTR >STACK
	PUT AGAIN-LEXV,STACK,STACK
	SET 'WINNER,OWINNER
	GET OOPS-TABLE,O-PTR >STACK
	MUL STACK,P-LEXELEN >STACK
	ADD STACK,3 >STACK
	MUL PTR,P-LEXELEN >STACK
	ADD STACK,7 >STACK
	GETB P-LEXV,STACK >STACK
	MUL PTR,P-LEXELEN >STACK
	ADD STACK,6 >STACK
	GETB P-LEXV,STACK >STACK
	CALL INBUF-ADD,STACK,STACK,STACK
	CALL STUFF,AGAIN-LEXV,P-LEXV
	GETB P-LEXV,P-LEXWORDS >P-LEN
	GET OOPS-TABLE,O-START >PTR
	CALL INBUF-STUFF,OOPS-INBUF,P-INBUF
	JUMP ?L56
?L44:	PUT OOPS-TABLE,O-END,0
	PRINTI "There was no word to replace!"
	CRLF
	RFALSE
?L35:	EQUAL? WRD,W?AGAIN,W?G /?L57
	SET 'P-NUMBER,0
?L57:	PUT OOPS-TABLE,O-END,0
?L56:	GET P-LEXV,PTR >STACK
	EQUAL? STACK,W?AGAIN,W?G \?L60
	GETB OOPS-INBUF,1 >STACK
	ZERO? STACK \?L62
	PRINTI "Beg pardon?"
	CRLF
	RFALSE
?L62:	ZERO? P-OFLAG /?L66
	PRINTI "It's difficult to repeat fragments."
	CRLF
	RFALSE
?L66:	ZERO? P-WON \?L69
	PRINTI "That would just repeat a mistake."
	CRLF
	RFALSE
?L69:	GRTR? P-LEN,1 \?L72
	ADD PTR,P-LEXELEN >STACK
	GET P-LEXV,STACK >STACK
	EQUAL? STACK,W?$PERIOD,W?$COMMA,W?THEN /?L75
	ADD PTR,P-LEXELEN >STACK
	GET P-LEXV,STACK >STACK
	EQUAL? STACK,W?AND \?L73
?L75:	ADD PTR,4 >PTR
	GETB P-LEXV,P-LEXWORDS >STACK
	SUB STACK,2 >STACK
	PUTB P-LEXV,P-LEXWORDS,STACK
	JUMP ?L79
?L73:	PRINTI "I couldn't understand that sentence."
	CRLF
	RFALSE
?L72:	ADD PTR,P-LEXELEN >PTR
	GETB P-LEXV,P-LEXWORDS >STACK
	DEC 'STACK
	PUTB P-LEXV,P-LEXWORDS,STACK
?L79:	GETB P-LEXV,P-LEXWORDS >STACK
	GRTR? STACK,0 \?L80
	CALL STUFF,P-LEXV,RESERVE-LEXV
	SET 'RESERVE-PTR,PTR
	JUMP ?L82
?L80:	SET 'RESERVE-PTR,0
?L82:	SET 'WINNER,OWINNER
	SET 'P-MERGED,OMERGED
	CALL INBUF-STUFF,OOPS-INBUF,P-INBUF
	CALL STUFF,AGAIN-LEXV,P-LEXV
	SET 'CNT,-1
	SET 'DIR,AGAIN-DIR
?L83:	IGRTR? 'CNT,P-ITBLLEN /?L90
	GET P-OTBL,CNT >STACK
	PUT P-ITBL,CNT,STACK
	JUMP ?L83
?L60:	CALL STUFF,P-LEXV,AGAIN-LEXV
	CALL INBUF-STUFF,P-INBUF,OOPS-INBUF
	PUT OOPS-TABLE,O-START,PTR
	MUL 4,P-LEN >STACK
	PUT OOPS-TABLE,O-LENGTH,STACK
	GETB P-LEXV,P-LEXWORDS >STACK
	MUL P-LEXELEN,STACK >STACK
	ADD PTR,STACK >STACK
	MUL 2,STACK >LEN
	SUB LEN,2 >STACK
	GETB P-LEXV,STACK >STACK
	SUB LEN,1 >STACK
	GETB P-LEXV,STACK >STACK
	ADD STACK,STACK >STACK
	PUT OOPS-TABLE,O-END,STACK
	SET 'RESERVE-PTR,0
	SET 'LEN,P-LEN
	SET 'P-DIR,0
	SET 'P-NCN,0
	SET 'P-GETFLAGS,0
?L89:	DLESS? 'P-LEN,0 \?L91
	SET 'QUOTE-FLAG,0
	JUMP ?L90
?L91:	GET P-LEXV,PTR >WRD
	ZERO? WRD \?L94
	CALL NUMBER?,PTR >WRD
	ZERO? WRD /?L93
?L94:	ZERO? P-LEN \?L95
	SET 'NW,0
	JUMP ?L97
?L95:	ADD PTR,P-LEXELEN >STACK
	GET P-LEXV,STACK >NW
?L97:	EQUAL? WRD,W?TO \?L98
	EQUAL? VERB,ACT?TELL \?L98
	SET 'WRD,W?$QUOTE
	JUMP ?L103
?L98:	EQUAL? WRD,W?THEN \?L103
	GRTR? P-LEN,0 \?L103
	ZERO? VERB \?L103
	ZERO? QUOTE-FLAG \?L103
	EQUAL? LW,0,W?$PERIOD \?L101
	SET 'WRD,W?THE
	JUMP ?L103
?L101:	PUT P-ITBL,P-VERB,ACT?TELL
	PUT P-ITBL,P-VERBN,0
	SET 'WRD,W?$QUOTE
?L103:	EQUAL? WRD,W?THEN,W?$PERIOD,W?$QUOTE \?L105
	EQUAL? WRD,W?$QUOTE \?L111
	ZERO? QUOTE-FLAG /?L109
	SET 'QUOTE-FLAG,0
	JUMP ?L111
?L109:	SET 'QUOTE-FLAG,1
?L111:	ZERO? P-LEN /?L113
	ADD PTR,P-LEXELEN >P-CONT
?L113:	PUTB P-LEXV,P-LEXWORDS,P-LEN
	JUMP ?L90
?L105:	CALL WT?,WRD,PS?DIRECTION,P1?DIRECTION >VAL
	ZERO? VAL /?L115
	EQUAL? VERB,0,ACT?WALK,ACT?FLY \?L115
	EQUAL? LEN,1 /?L116
	EQUAL? LEN,2 \?L117
	EQUAL? VERB,ACT?WALK /?L116
?L117:	EQUAL? NW,W?THEN,W?$PERIOD,W?$QUOTE \?L118
	LESS? LEN,2 \?L116
?L118:	ZERO? QUOTE-FLAG /?L119
	EQUAL? LEN,2 \?L119
	EQUAL? NW,W?$QUOTE /?L116
?L119:	GRTR? LEN,2 \?L115
	EQUAL? NW,W?$COMMA,W?AND \?L115
?L116:	SET 'DIR,VAL
	EQUAL? NW,W?$COMMA,W?AND \?L120
	ADD PTR,P-LEXELEN >STACK
	PUT P-LEXV,STACK,W?THEN
?L120:	GRTR? LEN,2 /?L156
	SET 'QUOTE-FLAG,0
	JUMP ?L90
?L115:	CALL WT?,WRD,PS?VERB,P1?VERB >VAL
	ZERO? VAL /?L126
	ZERO? VERB \?L126
	SET 'VERB,VAL
	PUT P-ITBL,P-VERB,VAL
	PUT P-ITBL,P-VERBN,P-VTBL
	PUT P-VTBL,0,WRD
	MUL PTR,2 >STACK
	ADD STACK,2 >CNT
	GETB P-LEXV,CNT >STACK
	PUTB P-VTBL,2,STACK
	ADD CNT,1 >STACK
	GETB P-LEXV,STACK >STACK
	PUTB P-VTBL,3,STACK
	JUMP ?L156
?L126:	CALL WT?,WRD,PS?PREPOSITION,0 >VAL
	ZERO? VAL \?L128
	EQUAL? WRD,W?ALL,W?ONE /?L129
	CALL WT?,WRD,PS?ADJECTIVE >STACK
	ZERO? STACK \?L129
	CALL WT?,WRD,PS?OBJECT >STACK
	ZERO? STACK /?L127
?L129:	SET 'VAL,0
?L128:	GRTR? P-LEN,1 \?L130
	EQUAL? NW,W?OF \?L130
	ZERO? VAL \?L169
	EQUAL? WRD,W?ALL,W?ONE,W?A /?L130
	SET 'OF-FLAG,1
	JUMP ?L156
?L130:	ZERO? VAL /?L132
?L169:	ZERO? P-LEN /?L133
	EQUAL? NW,W?THEN,W?$PERIOD \?L132
?L133:	SET 'P-END-ON-PREP,1
	LESS? P-NCN,2 \?L156
	PUT P-ITBL,P-PREP1,VAL
	PUT P-ITBL,P-PREP1N,WRD
	JUMP ?L156
?L132:	EQUAL? P-NCN,2 \?L137
	PRINTI "There were too many nouns in that sentence."
	CRLF
	RFALSE
?L137:	INC 'P-NCN
	SET 'P-ACT,VERB
	CALL CLAUSE,PTR,VAL,WRD >PTR
	ZERO? PTR /FALSE
	LESS? PTR,0 \?L156
	SET 'QUOTE-FLAG,0
	JUMP ?L90
?L127:	EQUAL? WRD,W?OF \?L146
	ZERO? OF-FLAG /?L149
	EQUAL? NW,W?$PERIOD,W?THEN \?L147
?L149:	CALL CANT-USE,PTR
	RFALSE
?L147:	SET 'OF-FLAG,0
	JUMP ?L156
?L146:	CALL WT?,WRD,PS?BUZZ-WORD >STACK
	ZERO? STACK \?L156
	EQUAL? VERB,ACT?TELL \?L152
	CALL WT?,WRD,PS?VERB,P1?VERB >STACK
	ZERO? STACK /?L152
	EQUAL? WINNER,PLAYER \?L152
	PRINTI "Please consult your manual for the correct way to talk to other people or creatures."
	CRLF
	RFALSE
?L152:	CALL CANT-USE,PTR
	RFALSE
?L93:	CALL UNKNOWN-WORD,PTR
	RFALSE
?L156:	SET 'LW,WRD
	ADD PTR,P-LEXELEN >PTR
	JUMP ?L89
?L90:	PUT OOPS-TABLE,O-PTR,0
	ZERO? DIR /?L157
	SET 'PRSA,V?WALK
	EQUAL? VERB,ACT?FLY \?L159
	SET 'TRY-FLY,1
	JUMP ?L161
?L159:	SET 'TRY-FLY,0
?L161:	SET 'PRSO,DIR
	SET 'P-OFLAG,0
	SET 'P-WALK-DIR,DIR
	SET 'AGAIN-DIR,DIR
	RETURN AGAIN-DIR
?L157:	ZERO? P-OFLAG /?L163
	CALL ORPHAN-MERGE
?L163:	SET 'P-WALK-DIR,0
	SET 'AGAIN-DIR,0
	CALL SYNTAX-CHECK >STACK
	ZERO? STACK /FALSE
	CALL SNARF-OBJECTS >STACK
	ZERO? STACK /FALSE
	CALL MANY-CHECK >STACK
	ZERO? STACK /FALSE
	CALL TAKE-CHECK >STACK
	ZERO? STACK \TRUE
	RFALSE

	.FUNCT STUFF,SRC,DEST,MAX=29,PTR=P-LEXSTART,CTR=1,BPTR
	GETB SRC,0 >STACK
	PUTB DEST,0,STACK
	GETB SRC,1 >STACK
	PUTB DEST,1,STACK
?L1:	GET SRC,PTR >STACK
	PUT DEST,PTR,STACK
	MUL PTR,2 >STACK
	ADD STACK,2 >BPTR
	GETB SRC,BPTR >STACK
	PUTB DEST,BPTR,STACK
	MUL PTR,2 >STACK
	ADD STACK,3 >BPTR
	GETB SRC,BPTR >STACK
	PUTB DEST,BPTR,STACK
	ADD PTR,P-LEXELEN >PTR
	IGRTR? 'CTR,MAX \?L1
	RTRUE

	.FUNCT INBUF-STUFF,SRC,DEST,CNT
	GETB SRC,0 >STACK
	SUB STACK,1 >CNT
?L1:	GETB SRC,CNT >STACK
	PUTB DEST,CNT,STACK
	DLESS? 'CNT,0 \?L1
	RTRUE

	.FUNCT INBUF-ADD,LEN,BEG,SLOT,DBEG,CTR=0,TMP,?TMP
	GET OOPS-TABLE,O-END >TMP
	ZERO? TMP /?L1
	SET 'DBEG,TMP
	JUMP ?L3
?L1:	GET OOPS-TABLE,O-LENGTH >TMP
	GETB AGAIN-LEXV,TMP >?TMP
	ADD TMP,1 >STACK
	GETB AGAIN-LEXV,STACK >STACK
	ADD ?TMP,STACK >DBEG
?L3:	ADD DBEG,LEN >STACK
	PUT OOPS-TABLE,O-END,STACK
?L4:	ADD BEG,CTR >STACK
	GETB P-INBUF,STACK >STACK
	ADD DBEG,CTR >STACK
	PUTB OOPS-INBUF,STACK,STACK
	INC 'CTR
	EQUAL? CTR,LEN \?L4
	PUTB AGAIN-LEXV,SLOT,DBEG
	SUB SLOT,1 >STACK
	PUTB AGAIN-LEXV,STACK,LEN
	RTRUE

	.FUNCT WT?,PTR,BIT,B1=5,OFFS=P-P1OFF,TYP
	GETB PTR,P-PSOFF >TYP
	BTST TYP,BIT \FALSE
	GRTR? B1,4 /TRUE
	BAND TYP,P-P1BITS >TYP
	EQUAL? TYP,B1 /?L6
	INC 'OFFS
?L6:	GETB PTR,OFFS >STACK
	RSTACK

	.FUNCT CLAUSE,PTR,VAL,WRD,OFF,NUM,ANDFLG=0,FIRST??=1,NW,LW=0
	SUB P-NCN,1 >STACK
	MUL STACK,2 >OFF
	ZERO? VAL /?L1
	ADD P-PREP1,OFF >NUM
	PUT P-ITBL,NUM,VAL
	ADD NUM,1 >STACK
	PUT P-ITBL,STACK,WRD
	ADD PTR,P-LEXELEN >PTR
	JUMP ?L3
?L1:	INC 'P-LEN
?L3:	ZERO? P-LEN \?L4
	DEC 'P-NCN
	RETURN -1
?L4:	ADD P-NC1,OFF >NUM
	MUL PTR,2 >STACK
	ADD P-LEXV,STACK >STACK
	PUT P-ITBL,NUM,STACK
	GET P-LEXV,PTR >STACK
	EQUAL? STACK,W?THE,W?A,W?AN \?L7
	GET P-ITBL,NUM >STACK
	ADD STACK,4 >STACK
	PUT P-ITBL,NUM,STACK
?L7:	DLESS? 'P-LEN,0 \?L12
	MUL PTR,2 >STACK
	ADD P-LEXV,STACK >STACK
	ADD NUM,1 >STACK
	PUT P-ITBL,STACK,STACK
	RETURN -1
?L12:	GET P-LEXV,PTR >WRD
	ZERO? WRD \?L17
	CALL NUMBER?,PTR >WRD
	ZERO? WRD /?L15
?L17:	ZERO? P-LEN \?L18
	SET 'NW,0
	JUMP ?L20
?L18:	ADD PTR,P-LEXELEN >STACK
	GET P-LEXV,STACK >NW
?L20:	EQUAL? WRD,W?AND,W?$COMMA \?L21
	SET 'ANDFLG,1
	JUMP ?L42
?L21:	EQUAL? WRD,W?ALL,W?ONE \?L23
	EQUAL? NW,W?OF \?L42
	DEC 'P-LEN
	ADD PTR,P-LEXELEN >PTR
	JUMP ?L42
?L23:	EQUAL? WRD,W?THEN,W?$PERIOD /?L28
	CALL WT?,WRD,PS?PREPOSITION >STACK
	ZERO? STACK /?L27
	GET P-ITBL,P-VERB >STACK
	ZERO? STACK /?L27
	ZERO? FIRST?? \?L27
?L28:	INC 'P-LEN
	MUL PTR,2 >STACK
	ADD P-LEXV,STACK >STACK
	ADD NUM,1 >STACK
	PUT P-ITBL,STACK,STACK
	SUB PTR,P-LEXELEN >STACK
	RSTACK
?L27:	CALL WT?,WRD,PS?OBJECT >STACK
	ZERO? STACK /?L29
	GRTR? P-LEN,0 \?L30
	EQUAL? NW,W?OF \?L30
	EQUAL? WRD,W?ALL,W?ONE \?L42
?L30:	CALL WT?,WRD,PS?ADJECTIVE,P1?ADJECTIVE >STACK
	ZERO? STACK /?L32
	ZERO? NW /?L32
	CALL WT?,NW,PS?OBJECT >STACK
	ZERO? STACK \?L42
?L32:	ZERO? ANDFLG \?L33
	EQUAL? NW,W?BUT,W?EXCEPT,W?AND /?L33
	EQUAL? NW,W?$COMMA /?L33
	ADD PTR,2 >STACK
	MUL STACK,2 >STACK
	ADD P-LEXV,STACK >STACK
	ADD NUM,1 >STACK
	PUT P-ITBL,STACK,STACK
	RETURN PTR
?L33:	SET 'ANDFLG,0
	JUMP ?L42
?L29:	ZERO? P-MERGED \?L36
	ZERO? P-OFLAG \?L36
	GET P-ITBL,P-VERB >STACK
	ZERO? STACK /?L35
?L36:	CALL WT?,WRD,PS?ADJECTIVE >STACK
	ZERO? STACK \?L42
	CALL WT?,WRD,PS?BUZZ-WORD >STACK
	ZERO? STACK \?L42
?L35:	ZERO? ANDFLG /?L38
	CALL WT?,WRD,PS?DIRECTION >STACK
	ZERO? STACK \?L39
	CALL WT?,WRD,PS?VERB >STACK
	ZERO? STACK /?L38
?L39:	SUB PTR,4 >PTR
	ADD PTR,2 >STACK
	PUT P-LEXV,STACK,W?THEN
	ADD P-LEN,2 >P-LEN
	JUMP ?L42
?L38:	CALL WT?,WRD,PS?PREPOSITION >STACK
	ZERO? STACK \?L42
	CALL CANT-USE,PTR
	RFALSE
?L15:	CALL UNKNOWN-WORD,PTR
	RFALSE
?L42:	SET 'LW,WRD
	SET 'FIRST??,0
	ADD PTR,P-LEXELEN >PTR
	JUMP ?L7

	.FUNCT NUMBER?,PTR,CNT,BPTR,CHR,SUM=0,TIM=0
	MUL PTR,2 >STACK
	ADD P-LEXV,STACK >STACK
	GETB STACK,2 >CNT
	MUL PTR,2 >STACK
	ADD P-LEXV,STACK >STACK
	GETB STACK,3 >BPTR
?L1:	DLESS? 'CNT,0 /?L2
	GETB P-INBUF,BPTR >CHR
	EQUAL? CHR,58 \?L6
	SET 'TIM,SUM
	SET 'SUM,0
	JUMP ?L10
?L6:	GRTR? SUM,10000 /FALSE
	LESS? CHR,58 \FALSE
	GRTR? CHR,47 \FALSE
	SUB CHR,48 >STACK
	MUL SUM,10 >STACK
	ADD STACK,STACK >SUM
?L10:	INC 'BPTR
	JUMP ?L1
?L2:	PUT P-LEXV,PTR,W?INTNUM
	GRTR? SUM,1000 /FALSE
	ZERO? TIM /?L13
	LESS? TIM,8 \?L14
	ADD TIM,12 >TIM
	JUMP ?L16
?L14:	GRTR? TIM,23 /FALSE
?L16:	MUL TIM,60 >STACK
	ADD SUM,STACK >SUM
?L13:	SET 'P-NUMBER,SUM
	RETURN W?INTNUM

	.FUNCT ORPHAN-MERGE,CNT=-1,TEMP,VERB,BEG,END,ADJ=0,WRD,?TMP
	SET 'P-OFLAG,0
	GET P-ITBL,P-VERBN >STACK
	GET STACK,0 >WRD
	CALL WT?,WRD,PS?VERB,P1?VERB >?TMP
	GET P-OTBL,P-VERB >STACK
	EQUAL? ?TMP,STACK /?L3
	CALL WT?,WRD,PS?ADJECTIVE >STACK
	ZERO? STACK /?L1
?L3:	SET 'ADJ,1
	JUMP ?L4
?L1:	CALL WT?,WRD,PS?OBJECT,P1?OBJECT >STACK
	ZERO? STACK /?L4
	ZERO? P-NCN \?L4
	PUT P-ITBL,P-VERB,0
	PUT P-ITBL,P-VERBN,0
	ADD P-LEXV,2 >STACK
	PUT P-ITBL,P-NC1,STACK
	ADD P-LEXV,6 >STACK
	PUT P-ITBL,P-NC1L,STACK
	SET 'P-NCN,1
?L4:	GET P-ITBL,P-VERB >VERB
	ZERO? VERB /?L6
	ZERO? ADJ \?L6
	GET P-OTBL,P-VERB >STACK
	EQUAL? VERB,STACK \FALSE
?L6:	EQUAL? P-NCN,2 /FALSE
	GET P-OTBL,P-NC1 >STACK
	EQUAL? STACK,1 \?L9
	GET P-ITBL,P-PREP1 >TEMP
	GET P-OTBL,P-PREP1 >STACK
	EQUAL? TEMP,STACK /?L12
	ZERO? TEMP \FALSE
?L12:	ZERO? ADJ /?L13
	ADD P-LEXV,2 >STACK
	PUT P-OTBL,P-NC1,STACK
	GET P-ITBL,P-NC1L >STACK
	ZERO? STACK \?L15
	ADD P-LEXV,6 >STACK
	PUT P-ITBL,P-NC1L,STACK
?L15:	ZERO? P-NCN \?L21
	SET 'P-NCN,1
	JUMP ?L21
?L13:	GET P-ITBL,P-NC1 >STACK
	PUT P-OTBL,P-NC1,STACK
?L21:	GET P-ITBL,P-NC1L >STACK
	PUT P-OTBL,P-NC1L,STACK
	JUMP ?L42
?L9:	GET P-OTBL,P-NC2 >STACK
	EQUAL? STACK,1 \?L23
	GET P-ITBL,P-PREP1 >TEMP
	GET P-OTBL,P-PREP2 >STACK
	EQUAL? TEMP,STACK /?L26
	ZERO? TEMP \FALSE
?L26:	ZERO? ADJ /?L29
	ADD P-LEXV,2 >STACK
	PUT P-ITBL,P-NC1,STACK
	GET P-ITBL,P-NC1L >STACK
	ZERO? STACK \?L29
	ADD P-LEXV,6 >STACK
	PUT P-ITBL,P-NC1L,STACK
?L29:	GET P-ITBL,P-NC1 >STACK
	PUT P-OTBL,P-NC2,STACK
	GET P-ITBL,P-NC1L >STACK
	PUT P-OTBL,P-NC2L,STACK
	SET 'P-NCN,2
	JUMP ?L42
?L23:	ZERO? P-ACLAUSE /?L42
	EQUAL? P-NCN,1 /?L35
	ZERO? ADJ \?L35
	SET 'P-ACLAUSE,0
	RFALSE
?L35:	GET P-ITBL,P-NC1 >BEG
	ZERO? ADJ /?L38
	ADD P-LEXV,2 >BEG
	SET 'ADJ,0
?L38:	GET P-ITBL,P-NC1L >END
?L41:	GET BEG,0 >WRD
	EQUAL? BEG,END \?L43
	ZERO? ADJ /?L45
	CALL ACLAUSE-WIN,ADJ
	JUMP ?L42
?L45:	SET 'P-ACLAUSE,0
	RFALSE
?L43:	ZERO? ADJ \?L48
	GETB WRD,P-PSOFF >STACK
	BTST STACK,PS?ADJECTIVE /?L49
	EQUAL? WRD,W?ALL,W?ONE \?L48
?L49:	SET 'ADJ,WRD
	JUMP ?L51
?L48:	EQUAL? WRD,W?ONE \?L50
	CALL ACLAUSE-WIN,ADJ
	JUMP ?L42
?L50:	GETB WRD,P-PSOFF >STACK
	BTST STACK,PS?OBJECT \?L51
	EQUAL? WRD,P-ANAM \?L52
	CALL ACLAUSE-WIN,ADJ
	JUMP ?L42
?L52:	CALL NCLAUSE-WIN
	JUMP ?L42
?L51:	ADD BEG,P-WORDLEN >BEG
	ZERO? END \?L41
	SET 'END,BEG
	SET 'P-NCN,1
	SUB BEG,4 >STACK
	PUT P-ITBL,P-NC1,STACK
	PUT P-ITBL,P-NC1L,BEG
	JUMP ?L41
?L42:	GET P-OVTBL,0 >STACK
	PUT P-VTBL,0,STACK
	GETB P-OVTBL,2 >STACK
	PUTB P-VTBL,2,STACK
	GETB P-OVTBL,3 >STACK
	PUTB P-VTBL,3,STACK
	PUT P-OTBL,P-VERBN,P-VTBL
	PUTB P-VTBL,2,0
?L60:	IGRTR? 'CNT,P-ITBLLEN \?L62
	SET 'P-MERGED,1
	RTRUE
?L62:	GET P-OTBL,CNT >STACK
	PUT P-ITBL,CNT,STACK
	JUMP ?L60

	.FUNCT ACLAUSE-WIN,ADJ
	GET P-OTBL,P-VERB >STACK
	PUT P-ITBL,P-VERB,STACK
	PUT P-CCTBL,CC-SBPTR,P-ACLAUSE
	ADD P-ACLAUSE,1 >STACK
	PUT P-CCTBL,CC-SEPTR,STACK
	PUT P-CCTBL,CC-DBPTR,P-ACLAUSE
	ADD P-ACLAUSE,1 >STACK
	PUT P-CCTBL,CC-DEPTR,STACK
	CALL CLAUSE-COPY,P-OTBL,P-OTBL,ADJ
	GET P-OTBL,P-NC2 >STACK
	ZERO? STACK /?L1
	SET 'P-NCN,2
?L1:	SET 'P-ACLAUSE,0
	RTRUE

	.FUNCT NCLAUSE-WIN
	PUT P-CCTBL,CC-SBPTR,P-NC1
	PUT P-CCTBL,CC-SEPTR,P-NC1L
	PUT P-CCTBL,CC-DBPTR,P-ACLAUSE
	ADD P-ACLAUSE,1 >STACK
	PUT P-CCTBL,CC-DEPTR,STACK
	CALL CLAUSE-COPY,P-ITBL,P-OTBL
	GET P-OTBL,P-NC2 >STACK
	ZERO? STACK /?L1
	SET 'P-NCN,2
?L1:	SET 'P-ACLAUSE,0
	RTRUE

	.FUNCT WORD-PRINT,CNT,BUF
?L1:	DLESS? 'CNT,0 /TRUE
	GETB P-INBUF,BUF >STACK
	PRINTC STACK
	INC 'BUF
	JUMP ?L1

	.FUNCT UNKNOWN-WORD,PTR,BUF,?TMP
	PUT OOPS-TABLE,O-PTR,PTR
	EQUAL? PRSA,V?SAY \?L1
	PRINTI "Nothing happens."
	CRLF
	RFALSE
?L1:	PRINTI "I don't know the word """
	MUL PTR,2 >BUF
	ADD P-LEXV,BUF >STACK
	GETB STACK,2 >?TMP
	ADD P-LEXV,BUF >STACK
	GETB STACK,3 >STACK
	CALL WORD-PRINT,?TMP,STACK
	PRINTI """."
	CRLF
	SET 'QUOTE-FLAG,0
	SET 'P-OFLAG,0
	RETURN P-OFLAG

	.FUNCT CANT-USE,PTR,BUF,?TMP
	EQUAL? PRSA,V?SAY \?L1
	PRINTI "Nothing happens."
	CRLF
	RFALSE
?L1:	PRINTI "You used the word """
	MUL PTR,2 >BUF
	ADD P-LEXV,BUF >STACK
	GETB STACK,2 >?TMP
	ADD P-LEXV,BUF >STACK
	GETB STACK,3 >STACK
	CALL WORD-PRINT,?TMP,STACK
	PRINTI """ in a way that I don't understand."
	CRLF
	SET 'QUOTE-FLAG,0
	SET 'P-OFLAG,0
	RETURN P-OFLAG

	.FUNCT SYNTAX-CHECK,SYN,LEN,NUM,OBJ,DRIVE1=0,DRIVE2=0,PREP,VERB,TMP
	GET P-ITBL,P-VERB >VERB
	ZERO? VERB \?L1
	PRINTI "There was no verb in that sentence!"
	CRLF
	RFALSE
?L1:	SUB 255,VERB >STACK
	GET VERBS,STACK >SYN
	GETB SYN,0 >LEN
	INC 'SYN
?L6:	GETB SYN,P-SBITS >STACK
	BAND STACK,P-SONUMS >NUM
	GRTR? P-NCN,NUM /?L15
	LESS? NUM,1 /?L10
	ZERO? P-NCN \?L10
	GET P-ITBL,P-PREP1 >PREP
	ZERO? PREP /?L11
	GETB SYN,P-SPREP1 >STACK
	EQUAL? PREP,STACK \?L10
?L11:	SET 'DRIVE1,SYN
	JUMP ?L15
?L10:	GET P-ITBL,P-PREP1 >STACK
	GETB SYN,P-SPREP1 >STACK
	EQUAL? STACK,STACK \?L15
	EQUAL? NUM,2 \?L13
	EQUAL? P-NCN,1 \?L13
	SET 'DRIVE2,SYN
	JUMP ?L15
?L13:	GET P-ITBL,P-PREP2 >STACK
	GETB SYN,P-SPREP2 >STACK
	EQUAL? STACK,STACK \?L15
	CALL SYNTAX-FOUND,SYN
	RTRUE
?L15:	DLESS? 'LEN,1 \?L18
	ZERO? DRIVE1 \?L53
	ZERO? DRIVE2 \?L7
	PRINTI "That sentence isn't one I recognize."
	CRLF
	RFALSE
?L18:	ADD SYN,P-SYNLEN >SYN
	JUMP ?L6
?L7:	ZERO? DRIVE1 /?L27
?L53:	GETB DRIVE1,P-SPREP1 >STACK
	GETB DRIVE1,P-SLOC1 >STACK
	GETB DRIVE1,P-SFWIM1 >STACK
	CALL GWIM,STACK,STACK,STACK >OBJ
	ZERO? OBJ /?L27
	PUT P-PRSO,P-MATCHLEN,1
	PUT P-PRSO,1,OBJ
	CALL SYNTAX-FOUND,DRIVE1 >STACK
	RSTACK
?L27:	ZERO? DRIVE2 /?L29
	GETB DRIVE2,P-SPREP2 >STACK
	GETB DRIVE2,P-SLOC2 >STACK
	GETB DRIVE2,P-SFWIM2 >STACK
	CALL GWIM,STACK,STACK,STACK >OBJ
	ZERO? OBJ /?L29
	PUT P-PRSI,P-MATCHLEN,1
	PUT P-PRSI,1,OBJ
	CALL SYNTAX-FOUND,DRIVE2 >STACK
	RSTACK
?L29:	EQUAL? VERB,ACT?FIND \?L30
	PRINTI "That question can't be answered."
	CRLF
	RFALSE
?L30:	EQUAL? WINNER,PLAYER /?L33
	CALL CANT-ORPHAN >STACK
	RSTACK
?L33:	CALL ORPHAN,DRIVE1,DRIVE2
	PRINTI "What do you want to "
	GET P-OTBL,P-VERBN >TMP
	ZERO? TMP \?L37
	PRINTI "tell"
	JUMP ?L42
?L37:	GETB P-VTBL,2 >STACK
	ZERO? STACK \?L41
	GET TMP,0 >STACK
	PRINTB STACK
	JUMP ?L42
?L41:	GETB TMP,3 >STACK
	GETB TMP,2 >STACK
	CALL WORD-PRINT,STACK,STACK
	PUTB P-VTBL,2,0
?L42:	ZERO? DRIVE2 /?L43
	PRINTI " "
	CALL THING-PRINT,1,1
?L43:	SET 'P-OFLAG,1
	ZERO? DRIVE1 /?L48
	GETB DRIVE1,P-SPREP1 >STACK
	JUMP ?L50
?L48:	GETB DRIVE2,P-SPREP2 >STACK
?L50:	CALL PREP-PRINT,STACK
	PRINTI "?"
	CRLF
	RFALSE

	.FUNCT CANT-ORPHAN
	PRINTI """I don't understand! What are you referring to?"""
	CRLF
	RFALSE

	.FUNCT ORPHAN,D1,D2,CNT=-1
	ZERO? P-MERGED \?L1
	PUT P-OCLAUSE,P-MATCHLEN,0
?L1:	GET P-VTBL,0 >STACK
	PUT P-OVTBL,0,STACK
	GETB P-VTBL,2 >STACK
	PUTB P-OVTBL,2,STACK
	GETB P-VTBL,3 >STACK
	PUTB P-OVTBL,3,STACK
?L4:	IGRTR? 'CNT,P-ITBLLEN /?L5
	GET P-ITBL,CNT >STACK
	PUT P-OTBL,CNT,STACK
	JUMP ?L4
?L5:	EQUAL? P-NCN,2 \?L9
	PUT P-CCTBL,CC-SBPTR,P-NC2
	PUT P-CCTBL,CC-SEPTR,P-NC2L
	PUT P-CCTBL,CC-DBPTR,P-NC2
	PUT P-CCTBL,CC-DEPTR,P-NC2L
	CALL CLAUSE-COPY,P-ITBL,P-OTBL
?L9:	LESS? P-NCN,1 /?L12
	PUT P-CCTBL,CC-SBPTR,P-NC1
	PUT P-CCTBL,CC-SEPTR,P-NC1L
	PUT P-CCTBL,CC-DBPTR,P-NC1
	PUT P-CCTBL,CC-DEPTR,P-NC1L
	CALL CLAUSE-COPY,P-ITBL,P-OTBL
?L12:	ZERO? D1 /?L15
	GETB D1,P-SPREP1 >STACK
	PUT P-OTBL,P-PREP1,STACK
	PUT P-OTBL,P-NC1,1
	RTRUE
?L15:	ZERO? D2 /FALSE
	GETB D2,P-SPREP2 >STACK
	PUT P-OTBL,P-PREP2,STACK
	PUT P-OTBL,P-NC2,1
	RTRUE

	.FUNCT THING-PRINT,PRSO?,THE?=0,BEG,END
	ZERO? PRSO? /?L1
	GET P-ITBL,P-NC1 >BEG
	GET P-ITBL,P-NC1L >END
	JUMP ?L3
?L1:	GET P-ITBL,P-NC2 >BEG
	GET P-ITBL,P-NC2L >END
?L3:	CALL BUFFER-PRINT,BEG,END,THE? >STACK
	RSTACK

	.FUNCT BUFFER-PRINT,BEG,END,CP,NOSP=1,WRD,FIRST??=1,PN=0,Q?=0
?L1:	EQUAL? BEG,END /TRUE
	GET BEG,0 >WRD
	EQUAL? WRD,W?$COMMA \?L6
	PRINTI ", "
	JUMP ?L11
?L6:	ZERO? NOSP /?L10
	SET 'NOSP,0
	JUMP ?L11
?L10:	PRINTI " "
?L11:	EQUAL? WRD,W?$PERIOD,W?$COMMA \?L14
	SET 'NOSP,1
	JUMP ?L18
?L14:	EQUAL? WRD,W?ME \?L16
	PRINTD ME
	SET 'PN,1
	JUMP ?L18
?L16:	EQUAL? WRD,W?INTNUM \?L17
	PRINTN P-NUMBER
	SET 'PN,1
	JUMP ?L18
?L17:	ZERO? FIRST?? /?L19
	ZERO? PN \?L19
	ZERO? CP /?L19
	PRINTI "the "
?L19:	ZERO? P-OFLAG \?L26
	ZERO? P-MERGED /?L24
?L26:	PRINTB WRD
	JUMP ?L28
?L24:	EQUAL? WRD,W?IT \?L27
	CALL ACCESSIBLE?,P-IT-OBJECT >STACK
	ZERO? STACK /?L27
	PRINTD P-IT-OBJECT
	JUMP ?L28
?L27:	GETB BEG,3 >STACK
	GETB BEG,2 >STACK
	CALL WORD-PRINT,STACK,STACK
?L28:	SET 'FIRST??,0
?L18:	ADD BEG,P-WORDLEN >BEG
	JUMP ?L1

	.FUNCT PREP-PRINT,PREP,WRD
	ZERO? PREP /FALSE
	PRINTI " "
	CALL PREP-FIND,PREP >WRD
	PRINTB WRD
	RTRUE

	.FUNCT CLAUSE-COPY,SRC,DEST,INSRT=0,BEG,END
	GET P-CCTBL,CC-SBPTR >STACK
	GET SRC,STACK >BEG
	GET P-CCTBL,CC-SEPTR >STACK
	GET SRC,STACK >END
	GET P-OCLAUSE,P-MATCHLEN >STACK
	MUL STACK,P-LEXELEN >STACK
	ADD STACK,2 >STACK
	ADD P-OCLAUSE,STACK >STACK
	GET P-CCTBL,CC-DBPTR >STACK
	PUT DEST,STACK,STACK
?L1:	EQUAL? BEG,END \?L3
	GET P-OCLAUSE,P-MATCHLEN >STACK
	MUL STACK,P-LEXELEN >STACK
	ADD STACK,2 >STACK
	ADD P-OCLAUSE,STACK >STACK
	GET P-CCTBL,CC-DEPTR >STACK
	PUT DEST,STACK,STACK
	RTRUE
?L3:	ZERO? INSRT /?L6
	GET BEG,0 >STACK
	EQUAL? P-ANAM,STACK \?L6
	CALL CLAUSE-ADD,INSRT
?L6:	GET BEG,0 >STACK
	CALL CLAUSE-ADD,STACK
	ADD BEG,P-WORDLEN >BEG
	JUMP ?L1

	.FUNCT CLAUSE-ADD,WRD,PTR
	GET P-OCLAUSE,P-MATCHLEN >STACK
	ADD STACK,2 >PTR
	SUB PTR,1 >STACK
	PUT P-OCLAUSE,STACK,WRD
	PUT P-OCLAUSE,PTR,0
	PUT P-OCLAUSE,P-MATCHLEN,PTR
	RTRUE

	.FUNCT PREP-FIND,PREP,CNT=0,SIZE
	GET PREPOSITIONS,0 >STACK
	MUL STACK,2 >SIZE
?L1:	IGRTR? 'CNT,SIZE /FALSE
	GET PREPOSITIONS,CNT >STACK
	EQUAL? STACK,PREP \?L1
	SUB CNT,1 >STACK
	GET PREPOSITIONS,STACK >STACK
	RSTACK

	.FUNCT SYNTAX-FOUND,SYN
	SET 'P-SYNTAX,SYN
	GETB SYN,P-SACTION >PRSA
	RETURN PRSA

	.FUNCT GWIM,GBIT,LBIT,PREP,OBJ
	EQUAL? GBIT,RLANDBIT \?L1
	RETURN ROOMS
?L1:	SET 'P-GWIMBIT,GBIT
	SET 'P-SLOCBITS,LBIT
	PUT P-MERGE,P-MATCHLEN,0
	CALL GET-OBJECT,P-MERGE,0 >STACK
	ZERO? STACK /?L4
	SET 'P-GWIMBIT,0
	GET P-MERGE,P-MATCHLEN >STACK
	EQUAL? STACK,1 \FALSE
	GET P-MERGE,1 >OBJ
	PRINTI "("
	ZERO? PREP /?L10
	ZERO? P-END-ON-PREP \?L10
	CALL PREP-FIND,PREP >PREP
	PRINTB PREP
	EQUAL? PREP,W?OUT \?L12
	PRINTI " of"
?L12:	PRINTI " "
	EQUAL? OBJ,HANDS \?L19
	PRINTI "your hands"
	JUMP ?L23
?L19:	PRINTI "the "
	PRINTD OBJ
?L23:	PRINTI ")"
	CRLF
	RETURN OBJ
?L10:	PRINTD OBJ
	PRINTI ")"
	CRLF
	RETURN OBJ
?L4:	SET 'P-GWIMBIT,0
	RFALSE

	.FUNCT SNARF-OBJECTS,OPTR,IPTR,L
	PUT P-BUTS,P-MATCHLEN,0
	GET P-ITBL,P-NC2 >IPTR
	ZERO? IPTR /?L3
	GETB P-SYNTAX,P-SLOC2 >P-SLOCBITS
	GET P-ITBL,P-NC2L >STACK
	CALL SNARFEM,IPTR,STACK,P-PRSI >STACK
	ZERO? STACK /FALSE
?L3:	GET P-ITBL,P-NC1 >OPTR
	ZERO? OPTR /?L8
	GETB P-SYNTAX,P-SLOC1 >P-SLOCBITS
	GET P-ITBL,P-NC1L >STACK
	CALL SNARFEM,OPTR,STACK,P-PRSO >STACK
	ZERO? STACK /FALSE
?L8:	GET P-BUTS,P-MATCHLEN >STACK
	ZERO? STACK /TRUE
	GET P-PRSO,P-MATCHLEN >L
	ZERO? OPTR /?L13
	CALL BUT-MERGE,P-PRSO >P-PRSO
?L13:	ZERO? IPTR /TRUE
	ZERO? OPTR /?L18
	GET P-PRSO,P-MATCHLEN >STACK
	EQUAL? L,STACK \TRUE
?L18:	CALL BUT-MERGE,P-PRSI >P-PRSI
	RTRUE

	.FUNCT BUT-MERGE,TBL,LEN,BUTLEN,CNT=1,MATCHES=0,OBJ,NTBL
	GET TBL,P-MATCHLEN >LEN
	PUT P-MERGE,P-MATCHLEN,0
?L1:	DLESS? 'LEN,0 /?L2
	GET TBL,CNT >OBJ
	CALL ZMEMQ,OBJ,P-BUTS >STACK
	ZERO? STACK \?L6
	ADD MATCHES,1 >STACK
	PUT P-MERGE,STACK,OBJ
	INC 'MATCHES
?L6:	INC 'CNT
	JUMP ?L1
?L2:	PUT P-MERGE,P-MATCHLEN,MATCHES
	SET 'NTBL,P-MERGE
	SET 'P-MERGE,TBL
	RETURN NTBL

	.FUNCT SNARFEM,PTR,EPTR,TBL,BUT=0,LEN,WV,WRD,NW,WAS-ALL=0
	SET 'P-AND,0
	EQUAL? P-GETFLAGS,P-ALL \?L1
	SET 'WAS-ALL,1
?L1:	SET 'P-GETFLAGS,0
	PUT TBL,P-MATCHLEN,0
	GET PTR,0 >WRD
?L4:	EQUAL? PTR,EPTR \?L6
?L57:	ZERO? BUT /?L9
	PUSH BUT
	JUMP ?L8
?L9:	PUSH TBL
?L8:	CALL GET-OBJECT,STACK >WV
	ZERO? WAS-ALL /?L10
	SET 'P-GETFLAGS,P-ALL
?L10:	RETURN WV
?L6:	ADD PTR,P-WORDLEN >STACK
	EQUAL? EPTR,STACK \?L14
	SET 'NW,0
	JUMP ?L16
?L14:	GET PTR,P-LEXELEN >NW
?L16:	EQUAL? WRD,W?ALL \?L17
	SET 'P-GETFLAGS,P-ALL
	EQUAL? NW,W?OF \?L52
	ADD PTR,P-WORDLEN >PTR
	JUMP ?L52
?L17:	EQUAL? WRD,W?BUT,W?EXCEPT \?L22
	ZERO? BUT /?L26
	PUSH BUT
	JUMP ?L25
?L26:	PUSH TBL
?L25:	CALL GET-OBJECT,STACK >STACK
	ZERO? STACK /FALSE
	SET 'BUT,P-BUTS
	PUT BUT,P-MATCHLEN,0
	JUMP ?L52
?L22:	EQUAL? WRD,W?A,W?ONE \?L27
	ZERO? P-ADJ \?L28
	SET 'P-GETFLAGS,P-ONE
	EQUAL? NW,W?OF \?L52
	ADD PTR,P-WORDLEN >PTR
	JUMP ?L52
?L28:	SET 'P-NAM,P-ONEOBJ
	ZERO? BUT /?L37
	PUSH BUT
	JUMP ?L36
?L37:	PUSH TBL
?L36:	CALL GET-OBJECT,STACK >STACK
	ZERO? STACK /FALSE
	ZERO? NW /TRUE
	JUMP ?L52
?L27:	EQUAL? WRD,W?AND,W?$COMMA \?L40
	EQUAL? NW,W?AND,W?$COMMA /?L40
	SET 'P-AND,1
	ZERO? BUT /?L44
	PUSH BUT
	JUMP ?L43
?L44:	PUSH TBL
?L43:	CALL GET-OBJECT,STACK >STACK
	ZERO? STACK /FALSE
	JUMP ?L52
?L40:	CALL WT?,WRD,PS?BUZZ-WORD >STACK
	ZERO? STACK \?L52
	EQUAL? WRD,W?AND,W?$COMMA /?L52
	EQUAL? WRD,W?OF \?L47
	ZERO? P-GETFLAGS \?L52
	SET 'P-GETFLAGS,P-INHIBIT
	JUMP ?L52
?L47:	CALL WT?,WRD,PS?ADJECTIVE,P1?ADJECTIVE >WV
	ZERO? WV /?L51
	ZERO? P-ADJ \?L51
	SET 'P-ADJ,WV
	SET 'P-ADJN,WRD
	JUMP ?L52
?L51:	CALL WT?,WRD,PS?OBJECT,P1?OBJECT >STACK
	ZERO? STACK /?L52
	SET 'P-NAM,WRD
	SET 'P-ONEOBJ,WRD
?L52:	EQUAL? PTR,EPTR /?L57
	ADD PTR,P-WORDLEN >PTR
	SET 'WRD,NW
	JUMP ?L4

	.FUNCT GET-OBJECT,TBL,VRB=1,BITS,LEN,XBITS,TLEN,GCHECK=0,OLEN=0,OBJ
	SET 'XBITS,P-SLOCBITS
	GET TBL,P-MATCHLEN >TLEN
	BTST P-GETFLAGS,P-INHIBIT /TRUE
	ZERO? P-NAM \?L11
	ZERO? P-ADJ /?L8
	CALL WT?,P-ADJN,PS?OBJECT,P1?OBJECT >STACK
	ZERO? STACK /?L6
	SET 'P-NAM,P-ADJN
	SET 'P-ADJ,0
	JUMP ?L8
?L6:	CALL NULL-F >STACK
	ZERO? STACK /?L8
?L8:	ZERO? P-NAM \?L11
	ZERO? P-ADJ \?L11
	EQUAL? P-GETFLAGS,P-ALL /?L79
	ZERO? P-GWIMBIT \?L11
	ZERO? VRB /FALSE
	PRINTI "There seems to be a noun missing in that sentence!"
	CRLF
	RFALSE
?L11:	EQUAL? P-GETFLAGS,P-ALL \?L21
?L79:	ZERO? P-SLOCBITS \?L19
?L21:	SET 'P-SLOCBITS,-1
?L19:	SET 'P-TABLE,TBL
?L23:	ZERO? GCHECK /?L25
	CALL GLOBAL-CHECK,TBL
	JUMP ?L31
?L25:	ZERO? LIT /?L28
	FCLEAR PLAYER,TRANSBIT
	CALL DO-SL,HERE,SOG,SIR
	FSET PLAYER,TRANSBIT
?L28:	CALL DO-SL,PLAYER,SH,SC
	GET TBL,0 >STACK
	EQUAL? STACK,TLEN \?L31
	ZERO? P-ADJ /?L33
	EQUAL? P-NAM,W?SPELL,0 \?L33
	SET 'P-NAM,P-ADJN
?L33:	CALL SPELL-CHECK,TBL,P-NAM
?L31:	GET TBL,P-MATCHLEN >STACK
	SUB STACK,TLEN >LEN
	BTST P-GETFLAGS,P-ALL /?L51
	BTST P-GETFLAGS,P-ONE \?L39
	ZERO? LEN /?L39
	EQUAL? LEN,1 /?L40
	RANDOM LEN >STACK
	GET TBL,STACK >STACK
	PUT TBL,1,STACK
	PRINTI "(How about the "
	GET TBL,1 >STACK
	PRINTD STACK
	PRINTI "?)"
	CRLF
?L40:	PUT TBL,P-MATCHLEN,1
	JUMP ?L51
?L39:	GRTR? LEN,1 /?L48
	ZERO? LEN \?L77
	EQUAL? P-SLOCBITS,-1 /?L51
?L48:	EQUAL? P-SLOCBITS,-1 \?L49
	SET 'P-SLOCBITS,XBITS
	SET 'OLEN,LEN
	GET TBL,P-MATCHLEN >STACK
	SUB STACK,LEN >STACK
	PUT TBL,P-MATCHLEN,STACK
	JUMP ?L23
?L49:	ZERO? LEN \?L52
	SET 'LEN,OLEN
?L52:	EQUAL? WINNER,PLAYER /?L55
	CALL CANT-ORPHAN
	RFALSE
?L55:	ZERO? VRB /?L61
	ZERO? P-NAM /?L57
	CALL WHICH-PRINT,TLEN,LEN,TBL
	EQUAL? TBL,P-PRSO \?L58
	SET 'P-ACLAUSE,P-NC1
	JUMP ?L60
?L58:	SET 'P-ACLAUSE,P-NC2
?L60:	SET 'P-AADJ,P-ADJ
	SET 'P-ANAM,P-NAM
	CALL ORPHAN,0,0
	SET 'P-OFLAG,1
	JUMP ?L61
?L57:	ZERO? VRB /?L61
	PRINTI "There seems to be a noun missing in that sentence!"
	CRLF
?L61:	SET 'P-NAM,0
	SET 'P-ADJ,0
	RFALSE
?L51:	ZERO? LEN \?L77
	ZERO? GCHECK /?L66
	ZERO? VRB /?L73
	SET 'P-SLOCBITS,XBITS
	ZERO? LIT \?L72
	EQUAL? PRSA,V?TELL \?L70
?L72:	CALL OBJ-FOUND,NOT-HERE-OBJECT,TBL
	SET 'P-XNAM,P-NAM
	SET 'P-XADJ,P-ADJ
	SET 'P-XADJN,P-ADJN
	SET 'P-NAM,0
	SET 'P-ADJ,0
	SET 'P-ADJN,0
	RTRUE
?L70:	PRINTI "It's too dark to see!"
	CRLF
?L73:	SET 'P-NAM,0
	SET 'P-ADJ,0
	RFALSE
?L66:	ZERO? LEN \?L77
	SET 'GCHECK,1
	JUMP ?L23
?L77:	SET 'P-SLOCBITS,XBITS
	SET 'P-NAM,0
	SET 'P-ADJ,0
	RTRUE

	.FUNCT MOBY-FIND,TBL,FOO,LEN
	SET 'P-SLOCBITS,-1
	SET 'P-NAM,P-XNAM
	SET 'P-ADJ,P-XADJ
	PUT TBL,P-MATCHLEN,0
	FIRST? ROOMS >FOO \?L3
?L4:	CALL SEARCH-LIST,FOO,TBL,P-SRCALL
	NEXT? FOO >FOO /?L4
?L3:	GET TBL,P-MATCHLEN >LEN
	ZERO? LEN \?L8
	CALL DO-SL,LOCAL-GLOBALS,1,1
?L8:	GET TBL,P-MATCHLEN >LEN
	ZERO? LEN \?L11
	CALL DO-SL,ROOMS,1,1
?L11:	GET TBL,P-MATCHLEN >LEN
	EQUAL? LEN,1 \?L14
	GET TBL,1 >P-MOBY-FOUND
?L14:	SET 'P-NAM,0
	SET 'P-ADJ,0
	RETURN LEN

	.FUNCT WHICH-PRINT,TLEN,LEN,TBL,OBJ,RLEN
	SET 'RLEN,LEN
	PRINTI "Which "
	ZERO? P-OFLAG \?L5
	ZERO? P-MERGED \?L5
	ZERO? P-AND /?L3
?L5:	ZERO? P-NAM /?L6
	PUSH P-NAM
	JUMP ?L9
?L6:	ZERO? P-ADJ /?L8
	PUSH P-ADJN
	JUMP ?L9
?L8:	PUSH W?ONE
?L9:	PRINTB STACK
	JUMP ?L10
?L3:	EQUAL? TBL,P-PRSO /?L11
	PUSH 0
	JUMP ?L12
?L11:	PUSH 1
?L12:	CALL THING-PRINT,STACK
?L10:	PRINTI " do you mean, "
?L15:	INC 'TLEN
	GET TBL,TLEN >OBJ
	PRINTI "the "
	PRINTD OBJ
	EQUAL? LEN,2 \?L19
	EQUAL? RLEN,2 /?L21
	PRINTI ","
?L21:	PRINTI " or "
	JUMP ?L28
?L19:	GRTR? LEN,2 \?L28
	PRINTI ", "
?L28:	DLESS? 'LEN,1 \?L15
	PRINTR "?"

	.FUNCT GLOBAL-CHECK,TBL,LEN,RMG,RMGL,CNT=0,OBJ,OBITS,FOO
	GET TBL,P-MATCHLEN >LEN
	SET 'OBITS,P-SLOCBITS
	GETPT HERE,P?GLOBAL >RMG
	ZERO? RMG /?L4
	PTSIZE RMG >STACK
	SUB STACK,1 >RMGL
?L3:	GETB RMG,CNT >OBJ
	CALL THIS-IT?,OBJ,TBL >STACK
	ZERO? STACK /?L5
	CALL OBJ-FOUND,OBJ,TBL
?L5:	IGRTR? 'CNT,RMGL \?L3
?L4:	GETPT HERE,P?PSEUDO >RMG
	ZERO? RMG /?L15
	PTSIZE RMG >STACK
	DIV STACK,4 >STACK
	SUB STACK,1 >RMGL
	SET 'CNT,0
?L14:	MUL CNT,2 >STACK
	GET RMG,STACK >STACK
	EQUAL? P-NAM,STACK \?L16
	SET 'LAST-PSEUDO-LOC,HERE
	MUL CNT,2 >STACK
	INC 'STACK
	GET RMG,STACK >STACK
	PUTP PSEUDO-OBJECT,P?ACTION,STACK
	GETPT PSEUDO-OBJECT,P?ACTION >STACK
	SUB STACK,5 >FOO
	GET P-NAM,0 >STACK
	PUT FOO,0,STACK
	GET P-NAM,1 >STACK
	PUT FOO,1,STACK
	CALL OBJ-FOUND,PSEUDO-OBJECT,TBL
	JUMP ?L15
?L16:	IGRTR? 'CNT,RMGL \?L14
?L15:	GET TBL,P-MATCHLEN >STACK
	EQUAL? STACK,LEN \FALSE
	SET 'P-SLOCBITS,-1
	SET 'P-TABLE,TBL
	CALL DO-SL,GLOBAL-OBJECTS,1,1
	SET 'P-SLOCBITS,OBITS
	GET TBL,P-MATCHLEN >STACK
	ZERO? STACK \FALSE
	EQUAL? PRSA,V?LOOK-INSIDE,V?SEARCH,V?EXAMINE \FALSE
	CALL DO-SL,ROOMS,1,1 >STACK
	RSTACK

	.FUNCT DO-SL,OBJ,BIT1,BIT2,BTS
	ADD BIT1,BIT2 >STACK
	BTST P-SLOCBITS,STACK \?L1
	CALL SEARCH-LIST,OBJ,P-TABLE,P-SRCALL >STACK
	RSTACK
?L1:	BTST P-SLOCBITS,BIT1 \?L4
	CALL SEARCH-LIST,OBJ,P-TABLE,P-SRCTOP >STACK
	RSTACK
?L4:	BTST P-SLOCBITS,BIT2 \TRUE
	CALL SEARCH-LIST,OBJ,P-TABLE,P-SRCBOT >STACK
	RSTACK

	.FUNCT SEARCH-LIST,OBJ,TBL,LVL,FLS,NOBJ
	FIRST? OBJ >OBJ \FALSE
?L3:	EQUAL? LVL,P-SRCBOT /?L5
	GETPT OBJ,P?SYNONYM >STACK
	ZERO? STACK /?L5
	CALL THIS-IT?,OBJ,TBL >STACK
	ZERO? STACK /?L5
	CALL OBJ-FOUND,OBJ,TBL
?L5:	EQUAL? LVL,P-SRCTOP \?L10
	FSET? OBJ,SEARCHBIT /?L10
	FSET? OBJ,SURFACEBIT \?L8
?L10:	FIRST? OBJ >NOBJ \?L8
	FSET? OBJ,OPENBIT /?L11
	FSET? OBJ,TRANSBIT \?L8
?L11:	FSET? OBJ,SURFACEBIT \?L12
	PUSH P-SRCALL
	JUMP ?L15
?L12:	FSET? OBJ,SEARCHBIT \?L14
	PUSH P-SRCALL
	JUMP ?L15
?L14:	PUSH P-SRCTOP
?L15:	CALL SEARCH-LIST,OBJ,TBL,STACK >FLS
?L8:	NEXT? OBJ >OBJ /?L3
	RTRUE

	.FUNCT OBJ-FOUND,OBJ,TBL,PTR
	GET TBL,P-MATCHLEN >PTR
	ADD PTR,1 >STACK
	PUT TBL,STACK,OBJ
	ADD PTR,1 >STACK
	PUT TBL,P-MATCHLEN,STACK
	RTRUE

	.FUNCT TAKE-CHECK
	GETB P-SYNTAX,P-SLOC1 >STACK
	CALL ITAKE-CHECK,P-PRSO,STACK >STACK
	ZERO? STACK /FALSE
	GETB P-SYNTAX,P-SLOC2 >STACK
	CALL ITAKE-CHECK,P-PRSI,STACK >STACK
	RSTACK

	.FUNCT ITAKE-CHECK,TBL,IBITS,PTR,OBJ,TAKEN
	GET TBL,P-MATCHLEN >PTR
	ZERO? PTR /TRUE
	BTST IBITS,SHAVE /?L3
	BTST IBITS,STAKE \TRUE
?L3:	DLESS? 'PTR,0 /TRUE
	ADD PTR,1 >STACK
	GET TBL,STACK >OBJ
	EQUAL? OBJ,IT \?L15
	CALL ACCESSIBLE?,P-IT-OBJECT >STACK
	ZERO? STACK \?L11
	PRINTI "I don't see what you're referring to."
	CRLF
	RFALSE
?L11:	SET 'OBJ,P-IT-OBJECT
?L15:	CALL HELD?,OBJ >STACK
	ZERO? STACK \?L3
	EQUAL? OBJ,HANDS,ME /?L3
	SET 'PRSO,OBJ
	FSET? OBJ,TRYTAKEBIT \?L19
	SET 'TAKEN,1
	JUMP ?L23
?L19:	EQUAL? WINNER,ADVENTURER /?L21
	SET 'TAKEN,0
	JUMP ?L23
?L21:	BTST IBITS,STAKE \?L22
	CALL ITAKE,0 >STACK
	EQUAL? STACK,1 \?L22
	SET 'TAKEN,0
	JUMP ?L23
?L22:	SET 'TAKEN,1
?L23:	ZERO? TAKEN /?L41
	BTST IBITS,SHAVE \?L24
	EQUAL? WINNER,ADVENTURER \?L24
	EQUAL? OBJ,NOT-HERE-OBJECT \?L26
	PRINTI "You don't have that!"
	CRLF
	RFALSE
?L26:	PRINTI "You don't have the "
	PRINTD OBJ
	PRINTI "."
	CRLF
	RFALSE
?L24:	ZERO? TAKEN \?L3
?L41:	EQUAL? WINNER,ADVENTURER \?L3
	PRINTI "(Taken)"
	CRLF
	JUMP ?L3

	.FUNCT MANY-CHECK,LOSS=0,TMP
	GET P-PRSO,P-MATCHLEN >STACK
	GRTR? STACK,1 \?L1
	GETB P-SYNTAX,P-SLOC1 >STACK
	BTST STACK,SMANY /?L1
	SET 'LOSS,1
	JUMP ?L3
?L1:	GET P-PRSI,P-MATCHLEN >STACK
	GRTR? STACK,1 \?L3
	GETB P-SYNTAX,P-SLOC2 >STACK
	BTST STACK,SMANY /?L3
	SET 'LOSS,2
?L3:	ZERO? LOSS /TRUE
	PRINTI "You can't use multiple "
	EQUAL? LOSS,2 \?L9
	PRINTI "in"
?L9:	PRINTI "direct objects with """
	GET P-ITBL,P-VERBN >TMP
	ZERO? TMP \?L16
	PRINTI "tell"
	JUMP ?L22
?L16:	ZERO? P-OFLAG \?L21
	ZERO? P-MERGED /?L20
?L21:	GET TMP,0 >STACK
	PRINTB STACK
	JUMP ?L22
?L20:	GETB TMP,3 >STACK
	GETB TMP,2 >STACK
	CALL WORD-PRINT,STACK,STACK
?L22:	PRINTI """."
	CRLF
	RFALSE

	.FUNCT ZMEMQ,ITM,TBL,SIZE=-1,CNT=1
	ZERO? TBL /FALSE
	LESS? SIZE,0 /?L4
	SET 'CNT,0
	JUMP ?L6
?L4:	GET TBL,0 >SIZE
?L6:	GET TBL,CNT >STACK
	EQUAL? ITM,STACK \?L9
	MUL CNT,2 >STACK
	ADD TBL,STACK >STACK
	RSTACK
?L9:	IGRTR? 'CNT,SIZE \?L6
	RFALSE

	.FUNCT ZMEMQB,ITM,TBL,SIZE,CNT=0
?L1:	GETB TBL,CNT >STACK
	EQUAL? ITM,STACK /TRUE
	IGRTR? 'CNT,SIZE \?L1
	RFALSE

	.FUNCT LIT?,RM,RMBIT=1,OHERE,LIT?1=0
	ZERO? ALWAYS-LIT /?L1
	EQUAL? WINNER,PLAYER /TRUE
?L1:	SET 'P-GWIMBIT,ONBIT
	SET 'OHERE,HERE
	SET 'HERE,RM
	ZERO? RMBIT /?L6
	FSET? RM,ONBIT \?L4
	SET 'LIT?1,1
	JUMP ?L14
?L4:	ZERO? RMBIT /?L6
	GRTR? TOD,NIGHTFALL /?L6
	FSET? RM,LIGHTBIT \?L6
	SET 'LIT?1,1
	JUMP ?L14
?L6:	PUT P-MERGE,P-MATCHLEN,0
	SET 'P-TABLE,P-MERGE
	SET 'P-SLOCBITS,-1
	EQUAL? OHERE,RM \?L10
	CALL DO-SL,WINNER,1,1
	EQUAL? WINNER,PLAYER /?L10
	IN? PLAYER,RM \?L10
	CALL DO-SL,PLAYER,1,1
?L10:	CALL DO-SL,RM,1,1
	GET P-TABLE,P-MATCHLEN >STACK
	GRTR? STACK,0 \?L14
	SET 'LIT?1,1
?L14:	SET 'HERE,OHERE
	SET 'P-GWIMBIT,0
	RETURN LIT?1

	.FUNCT PRSO-PRINT,PTR
	ZERO? P-MERGED \?L3
	GET P-ITBL,P-NC1 >PTR
	GET PTR,0 >STACK
	EQUAL? STACK,W?IT \?L1
?L3:	PRINTI " "
	PRINTD PRSO
	RTRUE
?L1:	GET P-ITBL,P-NC1L >STACK
	CALL BUFFER-PRINT,PTR,STACK,0 >STACK
	RSTACK

	.FUNCT PRSI-PRINT,PTR
	ZERO? P-MERGED \?L3
	GET P-ITBL,P-NC2 >PTR
	GET PTR,0 >STACK
	EQUAL? STACK,W?IT \?L1
?L3:	PRINTI " "
	PRINTD PRSO
	RTRUE
?L1:	GET P-ITBL,P-NC2L >STACK
	CALL BUFFER-PRINT,PTR,STACK,0 >STACK
	RSTACK

	.FUNCT THIS-IT?,OBJ,TBL,SYNS
	FSET? OBJ,INVISIBLE /FALSE
	ZERO? P-NAM /?L3
	GETPT OBJ,P?SYNONYM >SYNS
	PTSIZE SYNS >STACK
	DIV STACK,2 >STACK
	DEC 'STACK
	CALL ZMEMQ,P-NAM,SYNS,STACK >STACK
	ZERO? STACK /FALSE
?L3:	ZERO? P-ADJ /?L4
	GETPT OBJ,P?ADJECTIVE >SYNS
	ZERO? SYNS /FALSE
	PTSIZE SYNS >STACK
	DEC 'STACK
	CALL ZMEMQB,P-ADJ,SYNS,STACK >STACK
	ZERO? STACK /FALSE
?L4:	ZERO? P-GWIMBIT /TRUE
	FSET? OBJ,P-GWIMBIT /TRUE
	RFALSE

	.FUNCT ACCESSIBLE?,OBJ,L,?TMP
	LOC OBJ >L
	FSET? OBJ,INVISIBLE /FALSE
	ZERO? L /FALSE
	EQUAL? L,GLOBAL-OBJECTS /TRUE
	EQUAL? L,LOCAL-GLOBALS \?L5
	CALL GLOBAL-IN?,OBJ,HERE >STACK
	ZERO? STACK \TRUE
?L5:	CALL META-LOC,OBJ >?TMP
	LOC WINNER >STACK
	EQUAL? ?TMP,HERE,STACK \FALSE
	LOC WINNER >STACK
	EQUAL? L,WINNER,HERE,STACK /TRUE
	FSET? L,OPENBIT \FALSE
	CALL ACCESSIBLE?,L >STACK
	ZERO? STACK /FALSE
	RTRUE

	.FUNCT META-LOC,OBJ
?L1:	ZERO? OBJ /FALSE
	IN? OBJ,GLOBAL-OBJECTS \?L5
	RETURN GLOBAL-OBJECTS
?L5:	IN? OBJ,ROOMS \?L7
	RETURN OBJ
?L7:	LOC OBJ >OBJ
	JUMP ?L1

	.FUNCT V-VERBOSE
	SET 'VERBOSE,1
	SET 'SUPER-BRIEF,0
	PRINTR "Maximum verbosity."

	.FUNCT V-BRIEF
	SET 'VERBOSE,0
	SET 'SUPER-BRIEF,0
	PRINTR "Brief descriptions."

	.FUNCT V-SUPER-BRIEF
	SET 'SUPER-BRIEF,1
	PRINTR "Super-brief descriptions."

	.FUNCT V-LOOK
	EQUAL? PRSO,0,ROOMS /?L1
	CALL PERFORM,V?EXAMINE,PRSO
	RTRUE
?L1:	CALL DESCRIBE-ROOM,1 >STACK
	ZERO? STACK /FALSE
	CALL DESCRIBE-OBJECTS,1 >STACK
	RSTACK

	.FUNCT V-FIRST-LOOK
	CALL DESCRIBE-ROOM >STACK
	ZERO? STACK /FALSE
	ZERO? SUPER-BRIEF \FALSE
	CALL DESCRIBE-OBJECTS >STACK
	RSTACK

	.FUNCT V-EXAMINE
	GETP PRSO,P?TEXT >STACK
	ZERO? STACK /?L1
	GETP PRSO,P?TEXT >STACK
	PRINT STACK
	CRLF
	RTRUE
?L1:	FSET? PRSO,CONTBIT /?L6
	FSET? PRSO,DOORBIT \?L5
?L6:	CALL V-LOOK-INSIDE >STACK
	RSTACK
?L5:	PRINTI "You see nothing special about the "
	PRINTD PRSO
	PRINTR "."

	.FUNCT DESCRIBE-ROOM,LOOK?=0,V?,STR,AV
	SET 'V?,LOOK?
	ZERO? V? \?L1
	SET 'V?,VERBOSE
?L1:	ZERO? LIT \?L3
	PRINTI "It is pitch black and there is evil in the darkness."
	CRLF
	RFALSE
?L3:	FSET? HERE,TOUCHBIT /?L8
	FSET HERE,TOUCHBIT
	SET 'V?,1
?L8:	IN? HERE,ROOMS \?L11
	PRINTD HERE
	CRLF
?L11:	ZERO? LOOK? \?L18
	ZERO? SUPER-BRIEF \TRUE
?L18:	LOC WINNER >AV
	FSET? AV,VEHBIT \?L19
	PRINTI "(You are in the "
	PRINTD AV
	PRINTI ".)"
	CRLF
?L19:	ZERO? V? /?L29
	GETP HERE,P?ACTION >STACK
	CALL STACK,M-LOOK >STACK
	ZERO? STACK \TRUE
	ZERO? V? /?L29
	FSET? HERE,RMUNGBIT \?L26
	GETP HERE,P?MUNGDESC >STR
	ZERO? STR /?L26
	PRINT STR
	CRLF
	JUMP ?L37
?L26:	ZERO? V? /?L29
	GETP HERE,P?LDESC >STR
	ZERO? STR /?L29
	FSET? HERE,RMUNGBIT \?L30
	EQUAL? HERE,ALTAR,JUNCTION /?L30
	PRINTI "Everything you see is grey and lifeless, as though covered with a veil of ash. Sound is muted and there is a faint acrid odor."
	CRLF
?L30:	PRINT STR
	CRLF
	JUMP ?L37
?L29:	GETP HERE,P?ACTION >STACK
	CALL STACK,M-FLASH >STACK
?L37:	EQUAL? HERE,AV /?L38
	FSET AV,VEHBIT
	GETP AV,P?ACTION >STACK
	CALL STACK,M-LOOK >STACK
?L38:	FSET? HERE,LIGHTBIT \TRUE
	GRTR? TOD,NIGHTFALL \?L43
	PRINTR "The stars shine down on you from a clear, dark sky."
?L43:	GRTR? TOD,DUSK \?L46
	PRINTR "The darkening sky is lit by a waning moon."
?L46:	LESS? TOD,DAWN /TRUE
	ADD DAWN,3 >STACK
	LESS? TOD,STACK \TRUE
	PRINTR "The sun is rising over the lands to the east."

	.FUNCT DESCRIBE-OBJECTS,V?=0
	ZERO? LIT /?L1
	FIRST? HERE >STACK \FALSE
	ZERO? V? \?L5
	SET 'V?,VERBOSE
?L5:	CALL PRINT-CONT,HERE,V?,-1 >STACK
	RSTACK
?L1:	PRINTR "You can't see anything in the dark."

	.FUNCT LIGHTED?,OBJ
	FSET? OBJ,LIGHTBIT \FALSE
	FSET? OBJ,ONBIT \FALSE
	PRINTI " (providing light)"
	RTRUE

	.FUNCT DESCRIBE-OBJECT,OBJ,V?,LEVEL,STR=0,AV
	SET 'DESC-OBJECT,OBJ
	ZERO? LEVEL \?L8
	GETP OBJ,P?DESCFCN >STACK
	CALL STACK,M-OBJDESC >STACK
	ZERO? STACK \TRUE
	ZERO? LEVEL \?L8
	FSET? OBJ,TOUCHBIT /?L5
	GETP OBJ,P?FDESC >STR
	ZERO? STR \?L4
?L5:	GETP OBJ,P?LDESC >STR
	ZERO? STR /?L3
?L4:	PRINT STR
	CALL LIGHTED?,OBJ
	JUMP ?L13
?L3:	ZERO? LEVEL \?L8
	PRINTI "There is "
	CALL PRINTA,OBJ
	PRINTI " here"
	CALL LIGHTED?,OBJ
	PRINTI "."
	JUMP ?L13
?L8:	GET INDENTS,LEVEL >STACK
	PRINT STACK
	PRINTI "A"
	FSET? OBJ,VOWELBIT \?L18
	PRINTI "n"
?L18:	EQUAL? OBJ,BREAD \?L23
	GETP OBJ,P?SIZE >STACK
	LESS? STACK,8 \?L36
	PRINTI " partially eaten"
	JUMP ?L36
?L23:	EQUAL? OBJ,WATER \?L36
	GETP OBJ,P?SIZE >STACK
	LESS? STACK,2 \?L31
	PRINTI " very"
?L31:	GETP OBJ,P?SIZE >STACK
	LESS? STACK,3 \?L36
	PRINTI " small"
?L36:	PRINTI " "
	PRINTD OBJ
	CALL LIGHTED?,OBJ
?L13:	ZERO? LEVEL \?L44
	LOC WINNER >AV
	ZERO? AV /?L44
	FSET? AV,VEHBIT \?L44
	PRINTI " (outside the "
	PRINTD AV
	PRINTI ")"
?L44:	CRLF
	CALL SEE-INSIDE?,OBJ >STACK
	ZERO? STACK /FALSE
	FIRST? OBJ >STACK \FALSE
	CALL PRINT-CONT,OBJ,V?,LEVEL >STACK
	RSTACK

	.FUNCT PRINT-CONT,OBJ,V?=0,LEVEL=0,Y,1ST?,AV,STR,PV?=0,INV?=0
	FIRST? OBJ >Y \TRUE
	LOC WINNER >AV
	ZERO? AV /?L4
	FSET? AV,VEHBIT /?L6
?L4:	SET 'AV,0
?L6:	SET '1ST?,1
	LOC OBJ >STACK
	EQUAL? WINNER,OBJ,STACK \?L7
	SET 'INV?,1
	JUMP ?L11
?L7:	ZERO? Y \?L12
?L58:	ZERO? 1ST? \?L14
	PUSH 1
	JUMP ?L11
?L14:	PUSH 0
	JUMP ?L11
?L12:	EQUAL? Y,AV \?L16
	SET 'PV?,1
	JUMP ?L24
?L16:	EQUAL? Y,WINNER /?L24
	FSET? Y,INVISIBLE /?L24
	FSET? Y,TOUCHBIT /?L24
	GETP Y,P?FDESC >STR
	ZERO? STR /?L24
	FSET? Y,NDESCBIT /?L19
	PRINT STR
	CALL LIGHTED?,Y
	CRLF
?L19:	CALL SEE-INSIDE?,Y >STACK
	ZERO? STACK /?L24
	LOC Y >STACK
	GETP STACK,P?DESCFCN >STACK
	ZERO? STACK \?L24
	FIRST? Y >STACK \?L24
	CALL PRINT-CONT,Y,V?,0
?L24:	NEXT? Y >Y /?L12
	JUMP ?L58
?L11:	FIRST? OBJ >Y /?L32
?L57:	ZERO? PV? /?L34
	ZERO? AV /?L34
	FIRST? AV >STACK \?L34
	CALL PRINT-CONT,AV,V?,LEVEL
?L34:	ZERO? 1ST? \FALSE
	RTRUE
?L32:	EQUAL? Y,AV,PLAYER /?L53
	FSET? Y,INVISIBLE /?L53
	ZERO? INV? \?L41
	FSET? Y,TOUCHBIT /?L41
	GETP Y,P?FDESC >STACK
	ZERO? STACK \?L53
?L41:	FSET? Y,NDESCBIT /?L42
	ZERO? 1ST? /?L44
	CALL FIRSTER,OBJ,LEVEL >STACK
	ZERO? STACK /?L48
	LESS? LEVEL,0 \?L48
	SET 'LEVEL,0
?L48:	INC 'LEVEL
	SET '1ST?,0
?L44:	CALL DESCRIBE-OBJECT,Y,V?,LEVEL
	JUMP ?L53
?L42:	FIRST? Y >STACK \?L53
	CALL SEE-INSIDE?,Y >STACK
	ZERO? STACK /?L53
	CALL PRINT-CONT,Y,V?,LEVEL
?L53:	NEXT? Y >Y /?L32
	JUMP ?L57

	.FUNCT FIRSTER,OBJ,LEVEL
	EQUAL? OBJ,WINNER \?L1
	PRINTR "You are carrying:"
?L1:	IN? OBJ,ROOMS /FALSE
	GRTR? LEVEL,0 \?L6
	GET INDENTS,LEVEL >STACK
	PRINT STACK
?L6:	EQUAL? OBJ,ADVENTURER \?L11
	PRINTR "The adventurer is carrying:"
?L11:	FSET? OBJ,SURFACEBIT \?L15
	PRINTI "Sitting on the "
	PRINTD OBJ
	PRINTR " is:"
?L15:	PRINTI "The "
	PRINTD OBJ
	PRINTR " contains:"

	.FUNCT V-SCORE,ASK?=1
	PRINTI "Your score is "
	PRINTN SCORE
	PRINTI " of a possible "
	PRINTN SCORE-MAX
	PRINTI ", in "
	PRINTN MOVES
	EQUAL? MOVES,1 \?L7
	PRINTI " move."
	JUMP ?L11
?L7:	PRINTI " moves."
?L11:	CRLF
	LESS? SCORE,0 \?L14
	PRINTI "This gives you the rank of Menace to Society."
	CRLF
	RETURN SCORE
?L14:	PRINTI "This puts you in the class of "
	DIV SCORE,50 >STACK
	GET RANKINGS,STACK >STACK
	PRINT STACK
	PRINTI "."
	CRLF
	RETURN SCORE

	.FUNCT FINISH,REPEATING=0
	CRLF
	ZERO? REPEATING \?L1
	CALL V-SCORE
	CRLF
?L1:	PRINTI "[EVENT: GAME OVER]Would you like to restart the game from the beginning, restore a saved game position, or end this session of the game?
(Type RESTART, RESTORE, or QUIT):

>"
	READ P-INBUF,P-LEXV
	GET P-LEXV,1 >STACK
	EQUAL? STACK,W?RESTART \?L6
	RESTART
?L6:	GET P-LEXV,1 >STACK
	EQUAL? STACK,W?RESTORE \?L10
	RESTORE \?L11
	PRINTR "Okay."
?L11:	PRINTI "Failed."
	CRLF
	CALL FINISH,1 >STACK
	RSTACK
?L10:	QUIT

	.FUNCT V-QUIT,ASK?=1,SCOR
	CALL V-SCORE
	ZERO? ASK? /?L3
	PRINTI "Do you wish to leave the game? (Y is affirmative): "
	CALL YES? >STACK
	ZERO? STACK \?L3
	ZERO? ASK? \?L1
?L3:	QUIT
?L1:	PRINTR "Ok."

	.FUNCT YES?
	PRINTI ">"
	READ P-INBUF,P-LEXV
	GET P-LEXV,1 >STACK
	EQUAL? STACK,W?YES,W?Y \FALSE
	RTRUE

	.FUNCT V-VERSION,CNT=17
	PRINTI "ENCHANTER
Infocom interactive fiction - a fantasy story
Copyright (C) 1983, 1984, 1986 by Infocom, Inc. All rights reserved.
ENCHANTER is a registered trademark of Infocom, Inc.
Release "
	GET 0,1 >STACK
	BAND STACK,2047 >STACK
	PRINTN STACK
	PRINTI " / Serial number "
?L5:	IGRTR? 'CNT,23 /?L6
	GETB 0,CNT >STACK
	PRINTC STACK
	JUMP ?L5
?L6:	CRLF
	RTRUE

	.FUNCT JIGS-UP,DESC,SURVIVE?=1,BOTH=0,OZMOOD?=0,CHEATED?=0
	EQUAL? DEATH-CHEATED,WINNER,ME /?L1
	SET 'CHEATED?,0
	JUMP ?L2
?L1:	SET 'CHEATED?,1
?L2:	ZERO? SURVIVE? \?L4
	SET 'OZMOOD?,0
	JUMP ?L3
?L4:	SET 'OZMOOD?,CHEATED?
?L3:	SET 'DEATH-CHEATED,0
	ZERO? DESC /?L5
	PRINT DESC
	CRLF
?L5:	EQUAL? PLAYER,WINNER /?L10
	PRINTI "
*** The "
	PRINTD WINNER
	PRINTI " has died *** 

"
	ZERO? OZMOOD? /?L14
	PRINTI "Fortunately the "
	PRINTD WINNER
	PRINTI " has been magically protected from violent death and appears to be none the worse for his horrible experience."
	CRLF
	JUMP ?L18
?L14:	ZERO? CHEATED? /?L19
	PRINTI "Unfortunately, even the ozmoo spell was not enough to protect the "
	PRINTD WINNER
	PRINTI " from this eventuality."
	CRLF
?L19:	REMOVE WINNER
?L18:	SET 'WINNER,PLAYER
	LOC WINNER >HERE
	CALL LIT?,HERE >LIT
	RETURN 2
?L10:	CALL FORGET-ALL
	PRINTI " 
   ****  You have died  **** 

"
	ZERO? OZMOOD? /?L29
	PRINTI "Fortunately, you had the foresight to protect yourself against this eventuality by a judicious use of the ozmoo spell. You survive this horrible experience none the worse for wear, if somewhat chastened."
	CRLF
	JUMP ?L43
?L29:	ZERO? CHEATED? /?L34
	PRINTI "Unfortunately, even the ozmoo spell was not enough to protect you from this eventuality."
	CRLF
?L34:	IGRTR? 'DEATHS,3 \?L39
	PRINTI "You awaken among the members of the Circle. Belboz the Necromancer is exhausted, and the other members of the Circle are disgusted. ""I told you Krill was too powerful for such as this,"" says one. ""We must send someone who has a chance to defeat a warlock of Krill's experience and guile."" Acrimonious discussion begins, as you are waved away to join the apprentices in the scullery. A long acquaintance with potatoes and dirty pots is about to begin."
	CRLF
	CALL PRINT-ID,STR?6
	CALL FINISH
	JUMP ?L43
?L39:	PRINTI "You awaken among the members of the Circle. Belboz the Necromancer looks tired, and scattered about are the remains of the components of a spell of great healing power. The other members of the Circle are pleased to see you revived, but worried by the setback. ""I think Krill is too powerful,"" says one. ""This inexperienced wizard will never defeat one so puissant as he."" Quiet discussion ensues, with well-concealed acrimony beneath the surface."
	CRLF
	CALL HELD?,DISPEL-SCROLL >STACK
	ZERO? STACK \?L48
	CALL HELD?,BANISH-SCROLL >STACK
	ZERO? STACK /?L75
?L48:	CALL HELD?,DISPEL-SCROLL >STACK
	ZERO? STACK /?L49
	CALL HELD?,BANISH-SCROLL >STACK
	ZERO? STACK /?L49
	SET 'BOTH,1
?L49:	PRINTI "Belboz tilts his head, as if sensing something amiss. He examines your possessions and is taken aback: ""You have acquired "
	ZERO? BOTH /?L54
	PRINTI "scrolls"
	JUMP ?L58
?L54:	PRINTI "a scroll"
?L58:	PRINTI " of great power. Using spells of this kind requires surpassing wisdom."" With a wave of his hand, the scroll"
	ZERO? BOTH /?L63
	PRINTI "s disappear"
	JUMP ?L67
?L63:	PRINTI " disappears"
?L67:	PRINTI "."
	CRLF
	CALL HELD?,DISPEL-SCROLL >STACK
	ZERO? STACK /?L72
	REMOVE DISPEL-SCROLL
?L72:	CALL HELD?,BANISH-SCROLL >STACK
	ZERO? STACK /?L75
	REMOVE BANISH-SCROLL
?L75:	MOVE SPELL-BOOK,WINNER
	FCLEAR SPELL-BOOK,NDESCBIT
	FSET SPELL-BOOK,TAKEBIT
	FSET? JUG,TOUCHBIT \?L79
	MOVE JUG,EAST-FORK
?L79:	FSET? BREAD,TOUCHBIT \?L82
	GETP BREAD,P?SIZE >STACK
	GRTR? STACK,0 \?L82
	MOVE BREAD,EAST-FORK
?L82:	PRINTI "Debate ensues, with Belboz returning frequently to the contents of the ancient manuscript. His wishes prevail, and it is agreed to send you back...."
	CRLF
	SET 'THIRST-COUNT,0
	SET 'HUNGER-COUNT,0
	SET 'LOCKED-IN-TOWER,0
?L43:	CRLF
	CALL RANDOMIZE-OBJECTS
	ZERO? OZMOOD? \?L87
	CALL KILL-INTERRUPTS
	CALL GOTO,EAST-FORK
?L87:	SET 'P-CONT,0
	RETURN 2

	.FUNCT RANDOMIZE-OBJECTS,F,N
	FIRST? WINNER >F /?L11
	RTRUE
?L1:	ZERO? F /TRUE
?L11:	NEXT? F >N /?L6
?L6:	FSET? F,SCROLLBIT \?L7
	MOVE F,HERE
?L7:	SET 'F,N
	JUMP ?L1

	.FUNCT KILL-INTERRUPTS
	SET 'ADVENTURER-CHARMED,0
	CALL STOP-FLYING
	CALL QUEUE,I-TURTLE,0
	CALL QUEUE,I-TAKE-TO-ALTAR,0
	CALL QUEUE,I-GANG,0
	CALL QUEUE,I-GUARDS-ARRIVE,0
	RTRUE

	.FUNCT V-RESTORE
	RESTORE \?L1
	PRINTI "Ok."
	CRLF
	CALL V-FIRST-LOOK >STACK
	RSTACK
?L1:	PRINTR "Failed."

	.FUNCT V-SAVE
	SAVE \?L1
	PRINTR "Ok."
?L1:	PRINTR "Failed."

	.FUNCT V-RESTART
	CALL V-SCORE,1
	PRINTI "Do you wish to restart? (Y is affirmative): "
	CALL YES? >STACK
	ZERO? STACK /FALSE
	PRINTI "Restarting."
	CRLF
	RESTART

	.FUNCT V-WALK-AROUND
	CALL USE-DIRECTIONS >STACK
	RSTACK

	.FUNCT USE-DIRECTIONS
	PRINTR "You should use compass directions if you wish to move."

	.FUNCT V-LAUNCH
	FSET? PRSO,VEHBIT \?L1
	PRINTR "You can't launch that by saying ""launch""!"
?L1:	PRINTR "How in blazes does one launch that?"

	.FUNCT V-WALK,PT,PTS,STR,OBJ,RM
	ZERO? TRY-FLY /?L1
	CALL PRE-FLY >STACK
	ZERO? STACK \TRUE
?L1:	ZERO? P-WALK-DIR \?L4
	CALL PERFORM,V?WALK-TO,PRSO
	RTRUE
?L4:	GETPT HERE,PRSO >PT
	ZERO? PT /?L6
	PTSIZE PT >PTS
	EQUAL? PTS,UEXIT \?L7
	GETB PT,REXIT >STACK
	CALL GOTO,STACK >STACK
	RSTACK
?L7:	EQUAL? PTS,NEXIT \?L9
	GET PT,NEXITSTR >STACK
	PRINT STACK
	CRLF
	RETURN 2
?L9:	EQUAL? PTS,FEXIT \?L14
	GET PT,FEXITFCN >STACK
	CALL STACK >RM
	ZERO? RM /?L15
	CALL GOTO,RM >STACK
	RSTACK
?L15:	RETURN 2
?L14:	EQUAL? PTS,CEXIT \?L20
	GETB PT,CEXITFLAG >STACK
	VALUE STACK >STACK
	ZERO? STACK /?L21
	GETB PT,REXIT >STACK
	CALL GOTO,STACK >STACK
	RSTACK
?L21:	GET PT,CEXITSTR >STR
	ZERO? STR /?L23
	PRINT STR
	CRLF
	RETURN 2
?L23:	EQUAL? WINNER,TURTLE \?L28
	LOC PLAYER >STACK
	IN? TURTLE,STACK \?L29
	PRINTI """I can't go that way."""
	CRLF
	RETURN 2
?L29:	CALL NO-RESPONSE
	RETURN 2
?L28:	CALL OUTSIDE?,HERE >STACK
	ZERO? STACK /?L36
	PRINTI "There's no path in that direction."
	CRLF
	RETURN 2
?L36:	PRINTI "You can't go that way."
	CRLF
	RETURN 2
?L20:	EQUAL? PTS,DEXIT \FALSE
	GETB PT,DEXITOBJ >OBJ
	FSET? OBJ,OPENBIT \?L47
	GETB PT,REXIT >STACK
	CALL GOTO,STACK >STACK
	RSTACK
?L47:	GET PT,DEXITSTR >STR
	ZERO? STR /?L49
	PRINT STR
	CRLF
	CALL THIS-IS-IT,OBJ
	RETURN 2
?L49:	PRINTI "The "
	PRINTD OBJ
	PRINTI " is closed."
	CRLF
	CALL THIS-IS-IT,OBJ
	RETURN 2
?L6:	EQUAL? WINNER,PLAYER \?L60
	ZERO? LIT \?L60
	RANDOM 100 >STACK
	GRTR? 90,STACK \?L60
	CALL PRINT-ID,STR?7
	CALL JIGS-UP,STR?8
	RETURN 2
?L60:	EQUAL? WINNER,TURTLE \?L63
	LOC PLAYER >STACK
	IN? TURTLE,STACK \?L64
	PRINTI """I can't go that way."""
	CRLF
	RETURN 2
?L64:	CALL NO-RESPONSE
	RETURN 2
?L63:	PRINTI "You can't go that way."
	CRLF
	RETURN 2

	.FUNCT THIS-IS-IT,OBJ
	SET 'P-IT-OBJECT,OBJ
	RETURN P-IT-OBJECT

	.FUNCT V-INVENTORY
	FIRST? WINNER >STACK \?L1
	CALL PRINT-CONT,WINNER >STACK
	RSTACK
?L1:	PRINTR "You are empty-handed."

	.FUNCT PRE-TAKE
	IN? PRSO,WINNER \?L1
	PRINTR "You already have it."
?L1:	LOC PRSO >STACK
	ZERO? STACK /?L7
	LOC PRSO >STACK
	FSET? STACK,CONTBIT \?L7
	LOC PRSO >STACK
	FSET? STACK,OPENBIT /?L7
	PRINTR "You can't reach that."
?L7:	ZERO? PRSI /?L10
	EQUAL? PRSO,ME \?L11
	CALL PERFORM,V?DROP,PRSI
	RTRUE
?L11:	LOC PRSO >STACK
	EQUAL? PRSI,STACK /?L13
	PRINTI "The "
	PRINTD PRSO
	PRINTI " isn't in the "
	PRINTD PRSI
	PRINTR "."
?L13:	SET 'PRSI,0
	RFALSE
?L10:	LOC WINNER >STACK
	EQUAL? PRSO,STACK \FALSE
	PRINTR "You are in it!"

	.FUNCT V-TAKE
	CALL ITAKE >STACK
	EQUAL? STACK,1 \FALSE
	PRINTI "Taken."
	CRLF
	CALL IS-THEFT? >STACK
	CALL PRINT-ID,STR?9,STACK >STACK
	RSTACK

	.FUNCT ITAKE,VB=1,CNT,OBJ,?TMP
	FSET? PRSO,TAKEBIT /?L1
	ZERO? VB /FALSE
	CALL PICK-ONE,YUKS >STACK
	PRINT STACK
	CRLF
	RFALSE
?L1:	LOC PRSO >STACK
	IN? STACK,WINNER /?L8
	CALL WEIGHT,PRSO >?TMP
	CALL WEIGHT,WINNER >STACK
	ADD ?TMP,STACK >STACK
	GRTR? STACK,LOAD-ALLOWED \?L8
	ZERO? VB /?L9
	PRINTI "Your load is too heavy"
	LESS? LOAD-ALLOWED,LOAD-MAX \?L13
	PRINTI ", especially in light of your exhaustion."
	JUMP ?L17
?L13:	PRINTI "."
?L17:	CRLF
?L9:	RETURN 2
?L8:	CALL CCOUNT,WINNER >CNT
	GRTR? CNT,FUMBLE-NUMBER \?L23
	MUL CNT,FUMBLE-PROB >?TMP
	RANDOM 100 >STACK
	GRTR? ?TMP,STACK \?L23
	PRINTI "You're holding too many things already."
	CRLF
	RETURN 2
?L23:	MOVE PRSO,WINNER
	FSET PRSO,TOUCHBIT
	RTRUE

	.FUNCT V-PUT-ON
	FSET? PRSI,SURFACEBIT \?L1
	CALL V-PUT >STACK
	RSTACK
?L1:	PRINTI "There's no good surface on the "
	PRINTD PRSI
	PRINTR "."

	.FUNCT PRE-PUT
	IN? PRSO,GLOBAL-OBJECTS /?L3
	FSET? PRSO,TAKEBIT /FALSE
?L3:	PRINTR "Nice try."

	.FUNCT V-PUT,?TMP
	FSET? PRSI,OPENBIT /?L7
	FSET? PRSI,DOORBIT /?L4
	FSET? PRSI,CONTBIT /?L4
	FSET? PRSI,VEHBIT /?L4
	PRINTR "I can't do that."
?L4:	FSET? PRSI,OPENBIT /?L7
	PRINTI "The "
	PRINTD PRSI
	PRINTR " isn't open."
?L7:	EQUAL? PRSI,PRSO \?L11
	PRINTR "How can you do that?"
?L11:	IN? PRSO,PRSI \?L14
	PRINTI "The "
	PRINTD PRSO
	PRINTI " is already in the "
	PRINTD PRSI
	PRINTR "."
?L14:	CALL WEIGHT,PRSI >?TMP
	CALL WEIGHT,PRSO >STACK
	ADD ?TMP,STACK >?TMP
	GETP PRSI,P?SIZE >STACK
	SUB ?TMP,STACK >?TMP
	GETP PRSI,P?CAPACITY >STACK
	GRTR? ?TMP,STACK \?L17
	PRINTR "There's no room."
?L17:	CALL HELD?,PRSO >STACK
	ZERO? STACK \?L20
	CALL ITAKE >STACK
	EQUAL? STACK,M-FATAL,0 /TRUE
?L20:	MOVE PRSO,PRSI
	FSET PRSO,TOUCHBIT
	PRINTR "Done."

	.FUNCT PRE-GIVE
	CALL HELD?,PRSO >STACK
	ZERO? STACK \FALSE
	PRINTR "That's easy for you to say since you don't even have it."

	.FUNCT PRE-SGIVE
	CALL PERFORM,V?GIVE,PRSI,PRSO
	RTRUE

	.FUNCT HELD?,OBJ
	ZERO? OBJ /FALSE
	IN? OBJ,WINNER /TRUE
	IN? OBJ,ROOMS /FALSE
	IN? OBJ,GLOBAL-OBJECTS /FALSE
	LOC OBJ >STACK
	CALL HELD?,STACK >STACK
	RSTACK

	.FUNCT V-GIVE
	FSET? PRSI,VICBIT /?L1
	PRINTI "You can't give "
	CALL PRINTA,PRSO
	PRINTI " to "
	CALL PRINTA,PRSI
	PRINTR "!"
?L1:	PRINTI "The "
	PRINTD PRSI
	PRINTR " refuses it politely."

	.FUNCT V-SGIVE
	PRINTR "**Bug"

	.FUNCT V-DROP
	CALL IDROP >STACK
	ZERO? STACK /FALSE
	PRINTR "Dropped."

	.FUNCT V-THROW
	CALL IDROP >STACK
	ZERO? STACK /FALSE
	PRINTR "Thrown."

	.FUNCT IDROP
	IN? PRSO,WINNER /?L5
	LOC PRSO >STACK
	IN? STACK,WINNER /?L1
	PRINTI "You're not carrying the "
	PRINTD PRSO
	PRINTI "."
	CRLF
	RFALSE
?L1:	IN? PRSO,WINNER /?L5
	LOC PRSO >STACK
	FSET? STACK,OPENBIT /?L5
	PRINTI "The "
	PRINTD PRSO
	PRINTI " is closed."
	CRLF
	RFALSE
?L5:	LOC WINNER >STACK
	MOVE PRSO,STACK
	RTRUE

	.FUNCT V-OPEN,F,STR
	FSET? PRSO,CONTBIT /?L1
	PRINTI "You must tell me how to do that to "
	CALL PRINTA,PRSO
	PRINTR "."
?L1:	GETP PRSO,P?CAPACITY >STACK
	ZERO? STACK /?L5
	FSET? PRSO,OPENBIT \?L6
	PRINTR "It is already open."
?L6:	FSET PRSO,OPENBIT
	FIRST? PRSO >STACK \?L13
	FSET? PRSO,TRANSBIT \?L11
?L13:	PRINTR "Opened."
?L11:	FIRST? PRSO >F \?L16
	NEXT? F >STACK /?L16
	GETP F,P?FDESC >STR
	ZERO? STR /?L16
	PRINTI "The "
	PRINTD PRSO
	PRINTI " opens."
	CRLF
	PRINT STR
	CRLF
	RTRUE
?L16:	PRINTI "Opening the "
	PRINTD PRSO
	PRINTI " reveals "
	CALL PRINT-CONTENTS,PRSO
	PRINTR "."
?L5:	FSET? PRSO,DOORBIT \?L26
	FSET? PRSO,OPENBIT \?L27
	PRINTR "It is already open."
?L27:	PRINTI "The "
	PRINTD PRSO
	PRINTI " opens."
	CRLF
	FSET PRSO,OPENBIT
	RTRUE
?L26:	PRINTI "The "
	PRINTD PRSO
	PRINTR " fails to open."

	.FUNCT PRINT-CONTENTS,OBJ,F,N,1ST?=1
	FIRST? OBJ >F \FALSE
?L3:	NEXT? F >N /?L5
?L5:	ZERO? 1ST? /?L6
	SET '1ST?,0
	JUMP ?L11
?L6:	PRINTI ", "
	ZERO? N \?L11
	PRINTI "and "
?L11:	CALL PRINTA,F
	SET 'F,N
	ZERO? F \?L3
	RTRUE

	.FUNCT V-CLOSE
	FSET? PRSO,CONTBIT /?L1
	PRINTI "You must tell me how to do that to "
	CALL PRINTA,PRSO
	PRINTR "."
?L1:	FSET? PRSO,SURFACEBIT /?L5
	GETP PRSO,P?CAPACITY >STACK
	ZERO? STACK /?L5
	FSET? PRSO,OPENBIT \?L6
	FCLEAR PRSO,OPENBIT
	PRINTR "Closed."
?L6:	PRINTR "It is already closed."
?L5:	FSET? PRSO,DOORBIT \?L13
	FSET? PRSO,OPENBIT \?L14
	PRINTI "The "
	PRINTD PRSO
	PRINTI " is now closed."
	CRLF
	FCLEAR PRSO,OPENBIT
	RTRUE
?L14:	PRINTR "It is already closed."
?L13:	PRINTR "You cannot close that."

	.FUNCT CCOUNT,OBJ,CNT=0,X
	FIRST? OBJ >X \?L4
?L3:	INC 'CNT
	NEXT? X >X /?L3
?L4:	RETURN CNT

	.FUNCT WEIGHT,OBJ,CONT,WT=0
	FIRST? OBJ >CONT \?L4
?L3:	CALL WEIGHT,CONT >STACK
	ADD WT,STACK >WT
	NEXT? CONT >CONT /?L3
?L4:	GETP OBJ,P?SIZE >STACK
	ADD WT,STACK >STACK
	RSTACK

	.FUNCT V-SCRIPT
	GET 0,8 >STACK
	BOR STACK,1 >STACK
	PUT 0,8,STACK
	PRINTI "Here begins"
	PRINT COPR-NOTICE
	CRLF
	RTRUE

	.FUNCT V-UNSCRIPT
	PRINTI "Here ends"
	PRINT COPR-NOTICE
	CRLF
	GET 0,8 >STACK
	BAND STACK,-2 >STACK
	PUT 0,8,STACK
	RTRUE

	.FUNCT PRE-MOVE
	EQUAL? PRSO,EGG-KNOB-1,EGG-KNOB-2,EGG-KNOB-3 /FALSE
	EQUAL? PRSO,EGG-KNOB-4,EGG-KNOB-5 /FALSE
	CALL HELD?,PRSO >STACK
	ZERO? STACK /FALSE
	PRINTR "I don't juggle objects!"

	.FUNCT V-MOVE
	FSET? PRSO,TAKEBIT \?L1
	PRINTI "Moving the "
	PRINTD PRSO
	PRINTR " reveals nothing."
?L1:	PRINTI "You can't move the "
	PRINTD PRSO
	PRINTR "."

	.FUNCT V-LAMP-ON
	FSET? PRSO,LIGHTBIT \?L1
	FSET? PRSO,ONBIT \?L3
	PRINTR "It is already on."
?L3:	FSET PRSO,ONBIT
	PRINTI "The "
	PRINTD PRSO
	PRINTI " is now on."
	CRLF
	ZERO? LIT \TRUE
	CALL LIT?,HERE >LIT
	CRLF
	CALL V-LOOK
	RTRUE
?L1:	PRINTR "You can't turn that on."

	.FUNCT V-LAMP-OFF
	FSET? PRSO,LIGHTBIT \?L1
	FSET? PRSO,ONBIT /?L3
	PRINTR "It is already off."
?L3:	FCLEAR PRSO,ONBIT
	EQUAL? ETERNAL-FLAME,LANTERN /?L8
	FCLEAR PRSO,LIGHTBIT
?L8:	ZERO? LIT /?L11
	CALL LIT?,HERE >LIT
?L11:	PRINTI "The "
	PRINTD PRSO
	PRINTI " is now off."
	CRLF
	CALL LIT?,HERE >LIT
	CALL LIT?,HERE,0 >STACK
	ZERO? STACK \TRUE
	EQUAL? HERE,GALLERY \?L20
	CALL DESCRIBE-PORTRAIT-GALLERY >STACK
	ZERO? STACK \TRUE
?L20:	PRINTR "It is now pitch black."
?L1:	FSET? PRSO,ONBIT \?L25
	PRINTR "It's not easy to see how. It's glowing by magic."
?L25:	PRINTR "You can't turn that off."

	.FUNCT V-WAIT,NUM=3
	PRINTI "Time passes..."
	CRLF
?L3:	DLESS? 'NUM,0 /?L4
	CALL CLOCKER >STACK
	ZERO? STACK /?L3
?L4:	SET 'CLOCK-WAIT,1
	RETURN CLOCK-WAIT

	.FUNCT V-WAIT-FOR
	LOC PRSO >STACK
	EQUAL? STACK,HERE,WINNER \?L1
	PRINTR "It's already here!"
?L1:	PRINTR "You will probably be waiting quite a while."

	.FUNCT PRE-BOARD,AV
	LOC WINNER >AV
	FSET? PRSO,VEHBIT \?L1
	FSET? AV,VEHBIT \FALSE
	PRINTI "You are already in the "
	PRINTD AV
	PRINTI ", cretin!"
	CRLF
	RETURN 2
?L1:	PRINTI "You can't get into the "
	PRINTD PRSO
	PRINTI "!"
	CRLF
	RETURN 2

	.FUNCT V-BOARD,AV
	PRINTI "You are now in the "
	PRINTD PRSO
	PRINTI "."
	CRLF
	MOVE WINNER,PRSO
	GETP PRSO,P?ACTION >STACK
	CALL STACK,M-ENTER >STACK
	RTRUE

	.FUNCT V-DISEMBARK
	LOC WINNER >STACK
	EQUAL? STACK,PRSO /?L1
	PRINTI "You're not in that!"
	CRLF
	RETURN 2
?L1:	PRINTI "You are on your feet again."
	CRLF
	MOVE WINNER,HERE
	RTRUE

	.FUNCT GOTO,RM,V?=1,OLIT,OHERE
	SET 'OHERE,HERE
	SET 'OLIT,LIT
	MOVE WINNER,RM
	SET 'HERE,RM
	CALL LIT?,HERE >LIT
	EQUAL? WINNER,PLAYER \?L1
	ZERO? OLIT \?L1
	ZERO? LIT \?L1
	RANDOM 100 >STACK
	GRTR? 85,STACK \?L1
	CALL PRINT-ID,STR?10
	CALL JIGS-UP,STR?11
	RTRUE
?L1:	GETP HERE,P?ACTION >STACK
	CALL STACK,M-ENTER >STACK
	EQUAL? WINNER,PLAYER \?L6
	SET 'ADV-OLD-LOC,0
	IN? ADVENTURER,OHERE \?L6
	ZERO? ADVENTURER-CHARMED /?L6
	CALL WINNER-HAS-TREASURE? >STACK
	ZERO? STACK /?L6
	EQUAL? HERE,T-A,TEMPLE,CLOSET /?L6
	EQUAL? HERE,WEST-CASTLE /?L6
	PRINTI "The adventurer, proceeding cautiously, follows you. He seems to be paying particular attention to your possessions."
	CRLF
	CRLF
	MOVE ADVENTURER,HERE
	SET 'ADVENTURER-STAY,1
?L6:	EQUAL? HERE,RM \TRUE
	EQUAL? PLAYER,WINNER /?L14
	EQUAL? HERE,CLOSET,ENGINE-ROOM /TRUE
	IN? PLAYER,OHERE \?L15
	PRINTI "The "
	PRINTD WINNER
	PRINTR ", ever the good friend, leaves you."
?L15:	EQUAL? HERE,CLOSET,ENGINE-ROOM /TRUE
	IN? PLAYER,HERE \TRUE
	PRINTI "The "
	PRINTD WINNER
	PRINTR " returns to you."
?L14:	ZERO? V? /TRUE
	CALL V-FIRST-LOOK
	RTRUE

	.FUNCT WINNER-HAS-TREASURE?
	IN? EGG,WINNER /TRUE
	IN? MAGIC-KNIFE,WINNER /TRUE
	IN? JEWELLED-BOX,WINNER /TRUE
	IN? SILVER-SPOON,WINNER /TRUE
	RFALSE

	.FUNCT V-BACK
	CALL USE-DIRECTIONS >STACK
	RSTACK

	.FUNCT V-POUR-ON
	PRINTR "You can't pour that on anything!"

	.FUNCT V-SPRAY
	CALL V-SQUEEZE >STACK
	RSTACK

	.FUNCT V-SSPRAY
	CALL PERFORM,V?SPRAY,PRSI,PRSO >STACK
	RSTACK

	.FUNCT V-SQUEEZE
	FSET? PRSO,VILLAIN \?L1
	PRINTI "The "
	PRINTD PRSO
	PRINTR " does not understand this."
?L1:	PRINTR "How singularly useless."

	.FUNCT PRE-OIL
	PRINTR "You probably put spinach in your gas tank, too."

	.FUNCT V-OIL
	PRINTR "That's not very useful."

	.FUNCT V-ADVENT
	PRINTR "A hollow voice says ""Fool."""

	.FUNCT V-DRINK,S
	EQUAL? PRSO,WATER \?L1
	FSET? PRSO,RMUNGBIT \?L1
	PRINTI "Ooh! The water tastes terrible, and even the slightest amount makes you ill."
	CRLF
	CALL PRINT-ID,STR?12 >STACK
	RSTACK
?L1:	EQUAL? PRSO,GLOBAL-WATER \?L5
	EQUAL? HERE,BEACH,FOREST-2 \?L5
	PRINTI "Ooh! That tastes terrible!"
	CRLF
	CALL PRINT-ID,STR?13 >STACK
	RSTACK
?L5:	EQUAL? PRSO,WATER,GLOBAL-WATER /?L8
	PRINTR "You can't drink that!"
?L8:	CALL INT,I-THIRST >STACK
	GET STACK,C-TICK >S
	GRTR? S,60 \?L12
	PRINTR "You aren't the least bit thirsty."
?L12:	ADD S,39 >STACK
	CALL QUEUE,I-THIRST,STACK
	SET 'THIRST-COUNT,0
	ADD SCORE,DRINK-POINT >SCORE
	SET 'DRINK-POINT,0
	PRINTI "The delicious spring water tasted great"
	CALL PRINT-ID,STR?14
	EQUAL? HERE,SHADY-BROOK \?L19
	PRINTR "."
?L19:	EQUAL? PRSO,WATER \?L23
	GETP PRSO,P?SIZE >STACK
	SUB STACK,1 >S
	PUTP PRSO,P?SIZE,S
	ZERO? S \?L24
	REMOVE WATER
?L24:	GET JUG-FILLS,S >STACK
	PRINT STACK
	CRLF
	RTRUE
?L23:	PRINTR "."

	.FUNCT V-EAT
	PRINTI "Did they teach you to eat that in survival school?"
	CRLF
	CALL DANGEROUS-FOOD? >STACK
	CALL PRINT-ID,STR?15,STACK >STACK
	RSTACK

	.FUNCT V-CURSES
	CALL PRINT-ID,STR?16
	ZERO? PRSO /?L1
	FSET? PRSO,VILLAIN \?L3
	PRINTR "Insults of this nature won't help you."
?L3:	PRINTR "What a loony!"
?L1:	PRINTR "Such language from an enchanter!"

	.FUNCT V-LISTEN
	PRINTI "The "
	PRINTD PRSO
	PRINTR " makes no sound."

	.FUNCT V-FOLLOW
	PRINTR "You're nuts!"

	.FUNCT V-STAY
	PRINTR "You will be lost without me!"

	.FUNCT V-PRAY
	PRINTR "If you pray enough, your prayers may be answered."

	.FUNCT V-LEAP,TX,S
	ZERO? PRSO /?L1
	IN? PRSO,HERE \?L3
	FSET? PRSO,VILLAIN \?L5
	PRINTI "The "
	PRINTD PRSO
	PRINTR " is too big to jump over."
?L5:	CALL V-SKIP >STACK
	RSTACK
?L3:	PRINTR "That would be a good trick."
?L1:	GETPT HERE,P?DOWN >TX
	ZERO? TX /?L13
	PTSIZE TX >S
	EQUAL? S,2 /?L16
	EQUAL? S,4 \?L14
	GETB TX,1 >STACK
	VALUE STACK >STACK
	ZERO? STACK \?L14
?L16:	PRINTI "This was not a very safe place to try jumping."
	CRLF
	CALL PRINT-ID,STR?17
	CALL PICK-ONE,JUMPLOSS >STACK
	CALL JIGS-UP,STACK >STACK
	RSTACK
?L14:	CALL V-SKIP >STACK
	RSTACK
?L13:	CALL V-SKIP >STACK
	RSTACK

	.FUNCT V-SKIP
	PRINTR "Wasn't that fun?"

	.FUNCT V-LEAVE
	CALL DO-WALK,P?OUT >STACK
	RSTACK

	.FUNCT V-HELLO
	ZERO? PRSO /?L1
	FSET? PRSO,VILLAIN \?L3
	PRINTI "The "
	PRINTD PRSO
	PRINTR " bows his head to you in greeting."
?L3:	PRINTI "I think that only schizophrenics say ""Hello"" to a "
	PRINTD PRSO
	PRINTR "."
?L1:	CALL PICK-ONE,HELLOS >STACK
	PRINT STACK
	CRLF
	RTRUE

	.FUNCT PRE-READ
	EQUAL? PRSO,SPELL-BOOK /FALSE
	ZERO? LIT \?L3
	PRINTR "It is impossible to read in the dark."
?L3:	ZERO? PRSI /FALSE
	FSET? PRSI,TRANSBIT /FALSE
	PRINTI "How does one look through "
	CALL PRINTA,PRSI
	PRINTR "?"

	.FUNCT V-READ
	FSET? PRSO,READBIT /?L1
	PRINTI "How can I read "
	CALL PRINTA,PRSO
	PRINTR "?"
?L1:	GETP PRSO,P?TEXT >STACK
	PRINT STACK
	CRLF
	RTRUE

	.FUNCT V-LOOK-UNDER
	PRINTR "There is nothing but dust there."

	.FUNCT V-LOOK-BEHIND
	PRINTI "There is nothing behind the "
	PRINTD PRSO
	PRINTR "."

	.FUNCT V-LOOK-INSIDE
	FSET? PRSO,DOORBIT \?L1
	FSET? PRSO,OPENBIT \?L3
	PRINTI "The "
	PRINTD PRSO
	PRINTR " is open."
?L3:	PRINTI "The "
	PRINTD PRSO
	PRINTR " is closed."
?L1:	FSET? PRSO,CONTBIT \?L10
	FSET? PRSO,VICBIT \?L11
	PRINTR "There is nothing special to be seen."
?L11:	CALL SEE-INSIDE?,PRSO >STACK
	ZERO? STACK /?L15
	FIRST? PRSO >STACK \?L16
	CALL PRINT-CONT,PRSO >STACK
	ZERO? STACK \TRUE
?L16:	FSET? PRSO,SURFACEBIT \?L18
	PRINTI "There is nothing on the "
	PRINTD PRSO
	PRINTR "."
?L18:	PRINTI "The "
	PRINTD PRSO
	PRINTR " is empty."
?L15:	PRINTI "The "
	PRINTD PRSO
	PRINTR " is closed."
?L10:	PRINTI "You can't look inside "
	CALL PRINTA,PRSO
	PRINTR "."

	.FUNCT SEE-INSIDE?,OBJ
	FSET? OBJ,INVISIBLE /FALSE
	FSET? OBJ,TRANSBIT /TRUE
	FSET? OBJ,OPENBIT /TRUE
	RFALSE

	.FUNCT V-REPENT
	PRINTR "It could very well be too late!"

	.FUNCT PRE-BURN
	CALL IS-PERSON? >STACK
	CALL PRINT-ID,STR?18,STACK
	CALL IS-OBJ-PROP-ANIMAL? >STACK
	CALL PRINT-ID,STR?19,STACK
	CALL IS-SELF? >STACK
	CALL PRINT-ID,STR?20,STACK
	ZERO? PRSI \?L1
	PRINTR "Your blazing gaze is insufficient."
?L1:	EQUAL? PRSI,ETERNAL-FLAME /FALSE
	PRINTI "With "
	CALL PRINTA,PRSI
	PRINTR "??!?"

	.FUNCT V-BURN
	FSET? PRSO,BURNBIT \?L1
	IN? PRSO,WINNER \?L3
	REMOVE PRSO
	PRINTI "The "
	PRINTD PRSO
	PRINTI " catches fire."
	CRLF
	CALL PRINT-ID,STR?21
	CALL JIGS-UP,STR?22 >STACK
	RSTACK
?L3:	REMOVE PRSO
	PRINTI "The "
	PRINTD PRSO
	PRINTI " catches fire and is consumed."
	CRLF
	CALL PRINT-ID,STR?23 >STACK
	RSTACK
?L1:	PRINTI "I don't think you can burn "
	CALL PRINTA,PRSO
	PRINTR "."

	.FUNCT V-TURN
	PRINTR "This has no effect."

	.FUNCT V-PUMP
	PRINTR "It's not clear how."

	.FUNCT V-INFLATE
	PRINTR "How can you inflate that?"

	.FUNCT V-DEFLATE
	PRINTR "Come on, now!"

	.FUNCT V-LOCK
	PRINTR "It doesn't seem to work."

	.FUNCT V-PICK
	PRINTR "You can't pick that."

	.FUNCT V-UNLOCK
	CALL V-LOCK >STACK
	RSTACK

	.FUNCT V-CUT
	FSET? PRSO,VILLAIN \?L1
	CALL PERFORM,V?KILL,PRSO,PRSI >STACK
	RSTACK
?L1:	FSET? PRSO,BURNBIT \?L3
	FSET? PRSI,WEAPONBIT \?L7
	CALL PRINT-ID,STR?24
	REMOVE PRSO
	PRINTI "Your skillful "
	PRINTD PRSI
	PRINTI "smanship slices the "
	PRINTD PRSO
	PRINTR " into innumerable slivers which evaporate instantaneously."
?L3:	FSET? PRSI,WEAPONBIT /?L6
?L7:	PRINTI "I doubt that the ""cutting edge"" of "
	CALL PRINTA,PRSI
	PRINTI " is adequate."
	CRLF
	CALL IS-PERSON? >STACK
	CALL PRINT-ID,STR?25,STACK
	CALL IS-OBJ-PROP-ANIMAL? >STACK
	CALL PRINT-ID,STR?26,STACK >STACK
	RSTACK
?L6:	PRINTI "Strange concept, cutting the "
	PRINTD PRSO
	PRINTI "...."
	CRLF
	CALL IS-PERSON? >STACK
	CALL PRINT-ID,STR?27,STACK
	CALL IS-OBJ-PROP-ANIMAL? >STACK
	CALL PRINT-ID,STR?28,STACK >STACK
	RSTACK

	.FUNCT PRE-HIT
	ZERO? PRSI /FALSE
	IN? PRSI,WINNER /FALSE
	PRINTI "You don't have the "
	PRINTD PRSI
	PRINTR "."

	.FUNCT V-KILL
	CALL IKILL,STR?29 >STACK
	RSTACK

	.FUNCT IKILL,STR
	ZERO? PRSO \?L1
	PRINTI "There is nothing here to "
	PRINT STR
	PRINTI "."
	CRLF
	CALL IS-PERSON? >STACK
	CALL PRINT-ID,STR?30,STACK
	CALL IS-OBJ-PROP-ANIMAL? >STACK
	CALL PRINT-ID,STR?31,STACK
	CALL IS-SELF? >STACK
	CALL PRINT-ID,STR?32,STACK >STACK
	RSTACK
?L1:	FSET? PRSO,VILLAIN /?L5
	FSET? PRSO,VICBIT /?L5
	PRINTI "I've known strange people, but fighting a "
	PRINTD PRSO
	PRINTR "?"
?L5:	ZERO? PRSI /?L9
	EQUAL? PRSI,HANDS \?L8
?L9:	PRINTI "Trying to "
	PRINT STR
	PRINTI " a "
	PRINTD PRSO
	PRINTR " with your bare hands is suicidal."
?L8:	IN? PRSI,WINNER /?L12
	PRINTI "You aren't even holding the "
	PRINTD PRSI
	PRINTR "."
?L12:	FSET? PRSI,WEAPONBIT /?L15
	PRINTI "Trying to "
	PRINT STR
	PRINTI " the "
	PRINTD PRSO
	PRINTI " with a "
	PRINTD PRSI
	PRINTR " is suicidal."
?L15:	PRINTR "You'd never survive the attack."

	.FUNCT V-ATTACK
	CALL IKILL,STR?33 >STACK
	RSTACK

	.FUNCT V-SWING
	ZERO? PRSI \?L1
	PRINTR "Whoosh!"
?L1:	CALL PERFORM,V?ATTACK,PRSI,PRSO >STACK
	RSTACK

	.FUNCT V-KICK
	CALL HACK-HACK,STR?34 >STACK
	RSTACK

	.FUNCT V-WAVE
	CALL HACK-HACK,STR?35 >STACK
	RSTACK

	.FUNCT V-WAVE-AT
	PRINTI "Despite your friendly nature, the "
	PRINTD PRSO
	PRINTR " isn't likely to respond."

	.FUNCT V-RAISE
	CALL HACK-HACK,STR?36 >STACK
	RSTACK

	.FUNCT V-LOWER
	CALL HACK-HACK,STR?36 >STACK
	RSTACK

	.FUNCT V-RUB
	CALL IS-PERSON? >STACK
	CALL PRINT-ID,STR?37,STACK
	CALL HACK-HACK,STR?38 >STACK
	RSTACK

	.FUNCT V-PUSH
	CALL HACK-HACK,STR?39 >STACK
	RSTACK

	.FUNCT V-PUSH-TO
	PRINTR "You can't push things to that."

	.FUNCT V-MUNG
	CALL IS-PERSON? >STACK
	CALL PRINT-ID,STR?40,STACK
	CALL IS-OBJ-PROP-ANIMAL? >STACK
	CALL PRINT-ID,STR?41,STACK
	CALL IS-SELF? >STACK
	CALL PRINT-ID,STR?42,STACK
	FSET? PRSO,VICBIT /?L1
	CALL HACK-HACK,STR?43 >STACK
	RSTACK
?L1:	ZERO? PRSI \?L3
	PRINTI "Trying to break the "
	PRINTD PRSO
	PRINTR " with your bare hands is suicidal."
?L3:	FSET? PRSI,WEAPONBIT /?L6
	PRINTI "Trying to destroy the "
	PRINTD PRSO
	PRINTI " with a "
	PRINTD PRSI
	PRINTR " is quite self-destructive."
?L6:	PRINTR "You can't."

	.FUNCT HACK-HACK,STR
	IN? PRSO,GLOBAL-OBJECTS \?L1
	EQUAL? PRSA,V?LOWER,V?RAISE,V?WAVE \?L1
	PRINTI "The "
	PRINTD PRSO
	PRINTR " isn't here!"
?L1:	PRINT STR
	PRINTD PRSO
	CALL PICK-ONE,HO-HUM >STACK
	PRINT STACK
	CRLF
	RTRUE

	.FUNCT WORD-TYPE,OBJ,WORD,SYNS
	GETPT OBJ,P?SYNONYM >SYNS
	PTSIZE SYNS >STACK
	DIV STACK,2 >STACK
	DEC 'STACK
	CALL ZMEMQ,WORD,SYNS,STACK >STACK
	RSTACK

	.FUNCT V-KNOCK
	CALL WORD-TYPE,PRSO,W?DOOR >STACK
	ZERO? STACK /?L1
	PRINTR "I don't think that anybody's home."
?L1:	PRINTI "Why knock on "
	CALL PRINTA,PRSO
	PRINTR "?"

	.FUNCT V-YELL
	PRINTR "Aarrrrrgggggggghhhhhhhhhhh!"

	.FUNCT V-PLUG
	PRINTR "This has no effect."

	.FUNCT V-EXORCISE
	PRINTR "You can't do that with mere words!"

	.FUNCT V-SHAKE,X
	FSET? PRSO,VILLAIN \?L1
	PRINTR "Be real."
?L1:	FSET? PRSO,TAKEBIT /?L5
	PRINTR "You can't take it; thus, you can't shake it!"
?L5:	PRINTR "There's no point in shaking that."

	.FUNCT PRE-DIG
	ZERO? PRSI \?L1
	SET 'PRSI,HANDS
?L1:	FSET? PRSO,TOOLBIT \?L4
	SET 'PRSI,PRSO
	SET 'PRSO,GROUND
?L4:	FSET? PRSI,TOOLBIT /FALSE
	PRINTI "Digging with the "
	PRINTD PRSI
	PRINTR " is very silly."

	.FUNCT V-DIG
	PRINTR "The ground is unsuitable for digging here."

	.FUNCT V-SMELL
	PRINTI "It smells just like "
	CALL PRINTA,PRSO
	PRINTR "."

	.FUNCT GLOBAL-IN?,OBJ1,OBJ2,TX
	GETPT OBJ2,P?GLOBAL >TX
	ZERO? TX /FALSE
	PTSIZE TX >STACK
	DEC 'STACK
	CALL ZMEMQB,OBJ1,TX,STACK >STACK
	RSTACK

	.FUNCT V-SWIM
	ZERO? PRSO \?L1
	CALL GLOBAL-IN?,GLOBAL-WATER,HERE >STACK
	ZERO? STACK /?L1
	SET 'PRSO,GLOBAL-WATER
?L1:	EQUAL? PRSO,GLOBAL-WATER,SEA \?L4
	PRINTI "You'd probably drown."
	CRLF
	CALL PRINT-ID,STR?44 >STACK
	RSTACK
?L4:	EQUAL? PRSO,WATER \?L8
	PRINTR "This is a very small brook. Forget it."
?L8:	PRINTR "There's nothing to swim in!"

	.FUNCT V-UNTIE
	PRINTR "This cannot be tied, so it cannot be untied!"

	.FUNCT PRE-TIE
	EQUAL? PRSI,WINNER \FALSE
	PRINTR "You can't tie it to yourself."

	.FUNCT V-TIE
	PRINTI "You can't tie the "
	PRINTD PRSO
	PRINTR " to that."

	.FUNCT V-TIE-UP
	PRINTR "You could certainly never tie it with that!"

	.FUNCT V-MELT
	PRINTI "I'm not sure that "
	CALL PRINTA,PRSO
	PRINTI " can be melted."
	CRLF
	CALL IS-PERSON? >STACK
	CALL PRINT-ID,STR?45,STACK
	CALL IS-OBJ-PROP-ANIMAL? >STACK
	CALL PRINT-ID,STR?46,STACK
	CALL IS-SELF? >STACK
	CALL PRINT-ID,STR?47,STACK >STACK
	RSTACK

	.FUNCT V-MUMBLE
	PRINTR "You'll have to speak up if you expect me to hear you!"

	.FUNCT V-ALARM
	PRINTI "The "
	PRINTD PRSO
	PRINTR " isn't sleeping."

	.FUNCT V-ZORK
	PRINTR "ZORK (R) - A trilogy of fantasy classics from INFOCOM. "

	.FUNCT V-CLIMB-ON
	FSET? PRSO,VEHBIT \?L1
	CALL V-CLIMB-UP,P?UP,1 >STACK
	RSTACK
?L1:	PRINTI "You can't climb onto the "
	PRINTD PRSO
	PRINTR "."

	.FUNCT V-CLIMB-FOO
	CALL V-CLIMB-UP,P?UP,1 >STACK
	RSTACK

	.FUNCT V-CLIMB-UP,DIR=P?UP,OBJ=0,X
	GETPT HERE,DIR >STACK
	ZERO? STACK /?L1
	CALL DO-WALK,DIR
	RTRUE
?L1:	ZERO? OBJ \?L12
	PRINTR "You can't go that way."
?L12:	GETPT PRSO,P?SYNONYM >X
	PTSIZE X >STACK
	CALL ZMEMQ,W?WALL,X,STACK >STACK
	ZERO? STACK /?L6
	PRINTR "Climbing the walls is to no avail."
?L6:	PRINTR "Bizarre!"

	.FUNCT V-LIE-DOWN
	EQUAL? HERE,BEDROOM \?L1
	CALL PERFORM,V?BOARD,BED
	RTRUE
?L1:	CALL PERFORM,V?SLEEP
	RTRUE

	.FUNCT V-CLIMB-DOWN
	CALL V-CLIMB-UP,P?DOWN >STACK
	RSTACK

	.FUNCT V-SEND
	FSET? PRSO,VILLAIN \?L1
	PRINTI "Why would you send for the "
	PRINTD PRSO
	PRINTR "?"
?L1:	CALL PICK-ONE,YUKS >STACK
	PRINT STACK
	CRLF
	RTRUE

	.FUNCT V-WIND
	PRINTI "You cannot wind up "
	CALL PRINTA,PRSO
	PRINTR "."

	.FUNCT V-COUNT
	PRINTR "You have lost your mind."

	.FUNCT V-PUT-UNDER
	PRINTR "You can't put anything under that."

	.FUNCT V-PLAY
	EQUAL? PRSO,KRILL,GLOBAL-KRILL \?L1
	PRINTI "You are so engrossed in the role of the "
	PRINTD PRSO
	PRINTI " that you kill yourself, just as he would have done!"
	CRLF
	CALL PRINT-ID,STR?48
	CALL JIGS-UP,0 >STACK
	RSTACK
?L1:	PRINTR "How peculiar!"

	.FUNCT V-ENTER
	CALL DO-WALK,P?IN >STACK
	RSTACK

	.FUNCT V-EXIT
	CALL DO-WALK,P?OUT >STACK
	RSTACK

	.FUNCT V-CROSS
	PRINTR "You can't cross that!"

	.FUNCT V-SEARCH
	PRINTR "You find nothing unusual."

	.FUNCT V-FIND,L
	LOC PRSO >L
	EQUAL? PRSO,HANDS \?L1
	PRINTR "Within six feet of your head, assuming you haven't left that somewhere."
?L1:	EQUAL? PRSO,ME \?L5
	PRINTR "You're around here somewhere..."
?L5:	IN? PRSO,WINNER \?L8
	PRINTR "You have it!"
?L8:	IN? PRSO,HERE /?L12
	IN? PRSO,LOCAL-GLOBALS /?L12
	EQUAL? PRSO,PSEUDO-OBJECT,ROAD \?L11
?L12:	PRINTR "It's right in front of you."
?L11:	FSET? L,VILLAIN \?L15
	PRINTI "The "
	PRINTD L
	PRINTR " has it."
?L15:	FSET? L,CONTBIT \?L18
	PRINTI "It's in the "
	PRINTD L
	PRINTR "."
?L18:	PRINTR "Beats me, but it's not here."

	.FUNCT V-TELL
	EQUAL? PRSO,TURTLE,ADVENTURER,FROG \?L1
	ZERO? P-CONT /?L3
	SET 'WINNER,PRSO
	LOC WINNER >HERE
	RETURN HERE
?L3:	PRINTI "The "
	PRINTD PRSO
	PRINTR " looks at you expectantly, as though he thought you were about to talk."
?L1:	PRINTI "You can't talk to the "
	PRINTD PRSO
	PRINTI "!"
	CRLF
	SET 'QUOTE-FLAG,0
	SET 'P-CONT,0
	RETURN 2

	.FUNCT V-ANSWER
	PRINTI "Nobody seems to be awaiting your answer."
	CRLF
	SET 'P-CONT,0
	SET 'QUOTE-FLAG,0
	RTRUE

	.FUNCT V-REPLY
	PRINTI "It is hardly likely that the "
	PRINTD PRSO
	PRINTI " is interested."
	CRLF
	SET 'P-CONT,0
	SET 'QUOTE-FLAG,0
	RTRUE

	.FUNCT V-KISS
	PRINTI "I'd sooner kiss a pig."
	CRLF
	CALL IS-PERSON? >STACK
	CALL PRINT-ID,STR?49,STACK >STACK
	RSTACK

	.FUNCT V-RAPE
	PRINTI "What a (ahem!) strange idea."
	CRLF
	CALL IS-PERSON? >STACK
	CALL PRINT-ID,STR?50,STACK
	CALL IS-ANIMAL? >STACK
	CALL PRINT-ID,STR?51,STACK >STACK
	RSTACK

	.FUNCT FIND-IN,WHERE,WHAT,W
	FIRST? WHERE >W \FALSE
?L2:	FSET? W,WHAT \?L7
	RETURN W
?L7:	NEXT? W >W /?L2
	RFALSE

	.FUNCT V-SAY,V
	CALL FIND-IN,HERE,VICBIT >V
	ZERO? V /?L1
	PRINTI "You must address the "
	PRINTD V
	PRINTR " directly."
?L1:	GET P-LEXV,P-CONT >STACK
	EQUAL? STACK,W?HELLO \?L5
	SET 'QUOTE-FLAG,0
	RTRUE
?L5:	SET 'QUOTE-FLAG,0
	SET 'P-CONT,0
	PRINTR "Talking to yourself is said to be a sign of impending mental collapse."

	.FUNCT V-SPIN
	PRINTR "You can't spin that!"

	.FUNCT V-THROUGH,M
	FSET? PRSO,DOORBIT \?L1
	CALL OTHER-SIDE,PRSO >STACK
	CALL DO-WALK,STACK
	RTRUE
?L1:	FSET? PRSO,VEHBIT \?L3
	CALL PERFORM,V?BOARD,PRSO
	RTRUE
?L3:	FSET? PRSO,TAKEBIT /?L4
	PRINTI "You hit your head against the "
	PRINTD PRSO
	PRINTR " as you attempt this feat."
?L4:	IN? PRSO,WINNER \?L7
	PRINTR "That would involve quite a contortion!"
?L7:	CALL PICK-ONE,YUKS >STACK
	PRINT STACK
	CRLF
	RTRUE

	.FUNCT V-WEAR
	PRINTI "You can't wear the "
	PRINTD PRSO
	PRINTR "."

	.FUNCT V-THROW-OFF
	PRINTR "You can't throw anything off that!"

	.FUNCT V-$0024VERIFY
	EQUAL? PRSO,INTNUM \?L1
	EQUAL? P-NUMBER,4338 \?L1
	PRINTN SERIAL
	CRLF
	RTRUE
?L1:	ZERO? PRSO /?L5
	PRINTR "I don't understand that sentence."
?L5:	PRINTI "Verifying disk..."
	CRLF
	VERIFY \?L11
	PRINTR "The disk is correct."
?L11:	CRLF
	PRINTR "** Disk Failure **"

	.FUNCT V-STAND
	LOC WINNER >STACK
	FSET? STACK,VEHBIT \?L1
	LOC WINNER >STACK
	CALL PERFORM,V?DISEMBARK,STACK
	RTRUE
?L1:	PRINTR "You are already standing, I think."

	.FUNCT V-PUT-BEHIND
	PRINTR "That hiding place is too obvious."

	.FUNCT DO-WALK,DIR
	SET 'P-WALK-DIR,DIR
	CALL PERFORM,V?WALK,DIR >STACK
	RSTACK

	.FUNCT V-WALK-TO
	IN? PRSO,HERE /?L3
	CALL GLOBAL-IN?,PRSO,HERE >STACK
	ZERO? STACK /?L1
?L3:	PRINTR "It's here!"
?L1:	PRINTR "You should supply a direction!"

	.FUNCT OTHER-SIDE,DOBJ,P=0,TX
?L1:	NEXTP HERE,P >P
	LESS? P,P?OUT /FALSE
	GETPT HERE,P >TX
	PTSIZE TX >STACK
	EQUAL? STACK,DEXIT \?L1
	GETB TX,DEXITOBJ >STACK
	EQUAL? STACK,DOBJ \?L1
	RETURN P

	.FUNCT V-DRINK-FROM
	EQUAL? PRSO,GLOBAL-WATER \?L1
	CALL PERFORM,V?DRINK,PRSO
	RTRUE
?L1:	EQUAL? PRSO,JUG \?L3
	IN? WATER,JUG \?L3
	CALL PERFORM,V?DRINK,WATER
	RTRUE
?L3:	PRINTR "How peculiar!"

	.FUNCT V-LEAN-ON
	PRINTR "Are you so very tired, then?"

	.FUNCT V-MAKE-LINE-TO
	FSET? PRSO,POINTBIT \?L1
	FSET? PRSI,POINTBIT \?L1
	IN? PENCIL,WINNER /?L3
	PRINTR "You're not holding anything you can make it with."
?L3:	ZERO? PENCIL-COUNT \?L7
	PRINTR "There's not enough left of the pencil to make a line with."
?L7:	GETP PRSI,P?POINT >STACK
	GET TMAZE-ROOMS,STACK >STACK
	GETP PRSO,P?POINT >STACK
	GET TMAZE-ROOMS,STACK >STACK
	CALL CONNECT,STACK,STACK >STACK
	RSTACK
?L1:	PRINTR "That's silly."

	.FUNCT V-MAKE-LINE
	ZERO? PRSI /?L5
	FSET? PRSI,POINTBIT \?L1
	CALL PERFORM,V?MAKE-LINE-TO,PRSO,PRSI
	RETURN 2
?L1:	EQUAL? PRSI,0,PENCIL /?L5
	PRINTR "You won't write anything with that!"
?L5:	CALL 2OBJS? >STACK
	ZERO? STACK \?L8
	RETURN 2
?L8:	GET P-PRSO,2 >STACK
	GET P-PRSO,1 >STACK
	CALL PERFORM,V?MAKE-LINE-TO,STACK,STACK
	RETURN 2

	.FUNCT V-ERASE-LINE-TO
	FSET? PRSO,POINTBIT \?L1
	FSET? PRSI,POINTBIT \?L1
	IN? PENCIL,WINNER /?L3
	PRINTR "You're not holding anything you can erase it with."
?L3:	ZERO? ERASER-COUNT \?L7
	PRINTR "There's not enough left of the eraser."
?L7:	GETP PRSI,P?POINT >STACK
	GET TMAZE-ROOMS,STACK >STACK
	GETP PRSO,P?POINT >STACK
	GET TMAZE-ROOMS,STACK >STACK
	CALL DISCONNECT,STACK,STACK >STACK
	RSTACK
?L1:	PRINTR "That's silly."

	.FUNCT V-ERASE-LINE
	EQUAL? PRSI,0,PENCIL /?L1
	PRINTR "You won't erase anything with that!"
?L1:	GET P-PRSO,0 >STACK
	EQUAL? STACK,1 \?L5
	GET P-PRSO,1 >STACK
	EQUAL? STACK,PENCIL \?L6
	PRINTR "If you want to erase one of the pencil lines, you should specify the line. For example, ""ERASE THE LINE BETWEEN X AND Z."""
?L6:	GET P-PRSO,1 >STACK
	FSET? STACK,POINTBIT \?L10
	PRINTR "You can't seem to erase the marking."
?L10:	PRINTR "You can't erase that!"
?L5:	CALL 2OBJS? >STACK
	ZERO? STACK \?L16
	RETURN 2
?L16:	GET P-PRSO,2 >STACK
	GET P-PRSO,1 >STACK
	CALL PERFORM,V?ERASE-LINE-TO,STACK,STACK
	RETURN 2

	.FUNCT 2OBJS?
	GET P-PRSO,0 >STACK
	EQUAL? STACK,2 /TRUE
	PUT P-PRSO,0,1
	PRINTI "That sentence doesn't make sense."
	CRLF
	RFALSE

	.FUNCT V-REACH-IN,OBJ
	FSET? PRSO,CONTBIT \?L3
	FSET? PRSO,VILLAIN \?L1
?L3:	PRINTR "What a maroon!"
?L1:	FSET? PRSO,OPENBIT /?L6
	PRINTR "It's not open."
?L6:	FIRST? PRSO >OBJ \?L10
	FSET? OBJ,INVISIBLE /?L10
	FSET? OBJ,TAKEBIT /?L9
?L10:	PRINTR "It's empty."
?L9:	PRINTI "You reach into the "
	PRINTD PRSO
	PRINTR " and feel something."

	.FUNCT ROB,WHO,WHERE=0,HIDE?=0,N,X,ROBBED?=0
	FIRST? WHO >X /?L4
	RETURN ROBBED?
?L1:	ZERO? X \?L4
	RETURN ROBBED?
?L4:	NEXT? X >N /?L7
?L7:	CALL RIPOFF,X,WHERE >STACK
	ZERO? STACK /?L8
	ZERO? HIDE? /?L10
	FSET X,NDESCBIT
?L10:	SET 'ROBBED?,X
?L8:	SET 'X,N
	JUMP ?L1

	.FUNCT BLT,WHO,WHERE,N,X,CNT=0
	FIRST? WHO >X /?L4
	RETURN CNT
?L1:	ZERO? X \?L4
	RETURN CNT
?L4:	NEXT? X >N /?L7
?L7:	MOVE X,WHERE
	INC 'CNT
	SET 'X,N
	JUMP ?L1

	.FUNCT RIPOFF,X,WHERE
	FSET? X,INVISIBLE /FALSE
	FSET? X,SCROLLBIT /FALSE
	EQUAL? X,BREAD,JUG /FALSE
	FSET? X,TOUCHBIT \FALSE
	FSET? X,TAKEBIT \FALSE
	EQUAL? X,STRONG-BOX /FALSE
	ZERO? WHERE /?L6
	IN? X,WHERE /FALSE
	ZERO? WHERE /?L6
	MOVE X,WHERE
	RTRUE
?L6:	REMOVE X
	RTRUE

	.FUNCT V-POINT
	IN? ADVENTURER,HERE \?L1
	IN? PRSO,ADVENTURER \?L3
	CALL PERFORM,V?ASK-FOR,ADVENTURER,PRSO
	RTRUE
?L3:	ZERO? ADVENTURER-CHARMED /?L5
	PRINTI "The adventurer nods as if in approval of the "
	PRINTD PRSO
	PRINTR "."
?L5:	PRINTI "The adventurer backs off from the "
	PRINTD PRSO
	PRINTR "."
?L1:	PRINTR "Not much use in that...."

	.FUNCT V-ASK-FOR
	EQUAL? PRSO,ADVENTURER \?L1
	IN? PRSI,PRSO /?L3
	PRINTR "He's not holding that!"
?L3:	ZERO? ADVENTURER-CHARMED /?L7
	FSET? PRSI,TREASURE \?L8
	PRINTR "The adventurer politely refuses, indicating its great beauty and value."
?L8:	EQUAL? PRSI,LANTERN,SWORD \?L12
	PRINTR "The adventurer refuses, indicating its utter necessity in his travels."
?L12:	MOVE PRSI,WINNER
	PRINTI "The adventurer, not seeing any use in keeping the "
	PRINTD PRSI
	PRINTR " anyway, hands it to you gladly."
?L7:	PRINTR "The adventurer waves you off with an aggressive gesture."
?L1:	PRINTI "The "
	PRINTD PRSO
	PRINTR " is not likely to oblige."

	.FUNCT V-THANK
	ZERO? PRSO /?L1
	FSET? PRSO,VILLAIN \?L1
	PRINTI "The "
	PRINTD PRSO
	PRINTR " seems less than overjoyed."
?L1:	PRINTR "The Circle will revoke your certificate if you keep this up."

	.FUNCT V-FILL
	ZERO? PRSI \?L1
	CALL GLOBAL-IN?,GLOBAL-WATER,HERE >STACK
	ZERO? STACK /?L3
	CALL PERFORM,V?FILL,PRSO,GLOBAL-WATER >STACK
	RSTACK
?L3:	PRINTR "There's nothing to fill it with."
?L1:	PRINTR "I don't see how you propose to do that."

	.FUNCT V-ESCAPE
	PRINTI "There is no escape from the "
	PRINTD PRSO
	PRINTR "!"

	.FUNCT V-WRITE-WITH
	EQUAL? PRSO,PENCIL \?L1
	IN? TMAP,WINNER \?L3
	CALL WRITE-HINT
	RTRUE
?L3:	PRINTR "There's nothing good to write on."
?L1:	PRINTR "You can't write with that!"

	.FUNCT WRITE-HINT
	PRINTR "You can't draw on it arbitrarily. Rather, the pencil seems to home in on various points on the map, daring you to draw a line between them."

	.FUNCT V-WRITE-ON,SPELL
	EQUAL? PRSI,PENCIL /?L3
	ZERO? PRSI \?L14
	IN? PENCIL,WINNER \?L1
?L3:	EQUAL? PRSO,TMAP \?L4
	CALL WRITE-HINT
	RTRUE
?L4:	FSET? PRSO,SCROLLBIT \?L6
	FIRST? PRSO >STACK \?L6
	FIRST? PRSO >SPELL /?L7
?L7:	FSET SPELL,RMUNGBIT
	PRINTR "You've written on the scroll all right, but you've also defaced the spell written on it."
?L6:	PRINTR "You can't write on that!"
?L1:	ZERO? PRSI /?L13
?L14:	PRINTR "You can't write with that!"
?L13:	PRINTR "You have nothing to write with!"

	.FUNCT V-AVOID
	PRINTR "Perhaps that is unavoidable."

	.FUNCT V-SHOW
	PRINTI "I doubt the "
	PRINTD PRSI
	PRINTR " is interested."

	.FUNCT PRE-SSHOW
	CALL PERFORM,V?SHOW,PRSI,PRSO
	RTRUE

	.FUNCT V-SSHOW
	CALL V-SGIVE >STACK
	RSTACK

	.FUNCT PRE-BRING
	EQUAL? PRSO,ME /FALSE
	PRINTR "I don't understand that sentence."

	.FUNCT V-BRING
	EQUAL? WINNER,PLAYER \?L1
	PRINTR "Are you talking to yourself again?"
?L1:	PRINTR """You can get it yourself!"""

	.FUNCT V-DRAW-ON
	FSET? PRSO,SCROLLBIT \?L1
	CALL PERFORM,V?WRITE-ON,PRSO
	RTRUE
?L1:	PRINTR "You can't draw on that!"

	.FUNCT V-SHARPEN
	EQUAL? PRSI,MAGIC-KNIFE,SWORD \?L1
	EQUAL? PRSO,MAGIC-KNIFE,SWORD \?L3
	PRINTR "It's plenty sharp already."
?L3:	EQUAL? PRSO,PENCIL \?L7
	PRINTR "The pencil can't be sharpened. Perhaps it is magical."
?L7:	PRINTR "You can't sharpen that."
?L1:	PRINTR "You'll never sharpen anything with that!"

	.FUNCT V-FORGET
	PRINTR "You might also try not thinking about a purple hippopotamus!"

	.FUNCT PRE-FLY
	ZERO? FLYING? \FALSE
	ZERO? PRSO /?L3
	PRINTR "What a loon!"
?L3:	PRINTR "You are probably a loon, although you can't fly."

	.FUNCT V-HIDE
	ZERO? PRSO \?L1
	PRINTI "You'll have to say which direction you want to go."
	CRLF
	RETURN 2
?L1:	EQUAL? PRSI,ADVENTURER /?L8
	ZERO? PRSI \?L23
	IN? ADVENTURER,HERE \?L7
?L8:	FSET? PRSO,TREASURE \?L9
	PRINTI "Too late. The adventurer has already noticed the "
	PRINTD PRSO
	PRINTR "."
?L9:	PRINTR "He isn't interested in that anyway."
?L7:	ZERO? PRSI /?L20
?L23:	FSET? PRSI,VICBIT \?L16
	PRINTI "Why? The "
	PRINTD PRSI
	PRINTR " isn't interested in it."
?L16:	ZERO? PRSI \FALSE
?L20:	PRINTR "From what? From whom? Why?"

	.FUNCT V-CHASTISE
	PRINTR "Use prepositions to indicate precisely what you want to do: LOOK AT THE OBJECT, LOOK INSIDE THE OBJECT, LOOK FOR THE OBJECT, etc."

	.FUNCT V-GAG
	EQUAL? PRSO,ME /?L1
	PRINTR "What a concept!"
?L1:	EQUAL? PRSI,SILVER-SPOON /?L5
	PRINTI "With a "
	PRINTD PRSO
	PRINTR "?"
?L5:	PRINTR "Grody to the max! Like, totally!"

	.FUNCT V-GROSS-OUT
	FSET? PRSO,VILLAIN \?L1
	PRINTR "Let's not be disgusting!"
?L1:	PRINTR "Gag me with a spoon!"

	.FUNCT V-WHO
	FSET? PRSO,VILLAIN \?L1
	CALL PERFORM,V?EXAMINE,PRSO
	RTRUE
?L1:	PRINTR "That's not a person!"

	.FUNCT PRINT-DESC1,OBJ
	ZERO? OBJ /FALSE
	PRINTD OBJ
	RTRUE

	.FUNCT PRINT-ID,ID,CONDITION=1
	ZERO? CONDITION /FALSE
	PRINTI "[ID: "
	PRINT ID
	PRINTI ", PRSO: "
	CALL PRINT-DESC1,PRSO
	PRINTI ", PRSI: "
	CALL PRINT-DESC1,PRSI
	PRINTI "]"
	RTRUE

	.FUNCT PRINT-DEBUG,TEXT,CONDITION=1
	ZERO? CONDITION /FALSE
	PRINTI "DEBUG FLAG: "
	PRINT TEXT
	RTRUE

	.FUNCT IS-THEFT?
	EQUAL? PRSA,V?TAKE \FALSE
	EQUAL? PRSO,BREAD,EGG,FLATHEAD-PORTRAIT /TRUE
	EQUAL? PRSO,FROBOZZ-PORTRAIT,GLOBE,JEWEL-CHESTS /TRUE
	EQUAL? PRSO,JEWELLED-BOX,JUG,LIGHTED-PORTRAIT /TRUE
	EQUAL? PRSO,MAGIC-KNIFE,MAGIC-ROPE,MAPS /TRUE
	EQUAL? PRSO,MIRROR,PORTRAITS,STRONG-BOX \FALSE
	RTRUE

	.FUNCT IS-OBJECT-OR-PROPERTY?
	EQUAL? PRSO,ARCH,BANISH-SCROLL,BANQUET-ILLUSION /TRUE
	EQUAL? PRSO,BATTERED-LANTERN,BEACH-OBJ,BED /TRUE
	EQUAL? PRSO,BEDPOST,BEDPOST-BUTTON,BENCHES /TRUE
	EQUAL? PRSO,BLACK-PASSAGE,BRAMBLES,BREAD /TRUE
	EQUAL? PRSO,CEILING,CHARM-SCROLL,CHEAT-DEATH-SCROLL /TRUE
	EQUAL? PRSO,COMPARTMENT,CORRIDOR,COURTYARD /TRUE
	EQUAL? PRSO,CREDITS-SCROLL,DAMAGED-SCROLL,DISPEL-SCROLL /TRUE
	EQUAL? PRSO,DISTANT-CASTLE,DOOR-REALITY,EGG /TRUE
	EQUAL? PRSO,EGG-KNOB-1,EGG-KNOB-2,EGG-KNOB-3 /TRUE
	EQUAL? PRSO,EGG-KNOB-4,EGG-KNOB-5,ETERNAL-FLAME /TRUE
	EQUAL? PRSO,FLATHEAD-PORTRAIT,FLOATING-SIGN,FLY-SCROLL /TRUE
	EQUAL? PRSO,FOREST,FOUNDATION,FROBOZZ-PORTRAIT /TRUE
	EQUAL? PRSO,GLOBE,HASTE-SCROLL,HEATHER /TRUE
	EQUAL? PRSO,HOVEL,IRON-GATE,IRON-GATE-CHAINS /TRUE
	EQUAL? PRSO,JEWEL-CHESTS,JEWELLED-BOX,JUG /TRUE
	EQUAL? PRSO,LANTERN,LAWN,LEGEND-BOOK /TRUE
	EQUAL? PRSO,LIGHTED-PORTRAIT,LIGHTS,LILY-PAD /TRUE
	EQUAL? PRSO,LITTER,LONG-ROAD-SIGN,MACHINERY /TRUE
	EQUAL? PRSO,MAGIC-KNIFE,MAGIC-ROPE,MAPS /TRUE
	EQUAL? PRSO,MEADOW-OBJ,MIRROR,MIRROR-STUFF /TRUE
	EQUAL? PRSO,MOUNTAIN,NEWT-SCROLL,NORTH-BLOCK /TRUE
	EQUAL? PRSO,NORTH-CELL-DOOR,NORTH-GATE-OBJ,OPEN-SCROLL /TRUE
	EQUAL? PRSO,OVEN,PATH-SIGN,PEDESTAL /TRUE
	EQUAL? PRSO,PENCIL,PORTRAIT-NICHE,PORTRAITS /TRUE
	EQUAL? PRSO,PROTECTION-SCROLL,QUENCH-SCROLL,RAT-HOLE /TRUE
	EQUAL? PRSO,RAT-NEST,REPAIR-SCROLL,ROAD /TRUE
	EQUAL? PRSO,RUSTY-GATE,SCRAMBLED-EGG,SEA-STUFF /TRUE
	EQUAL? PRSO,SHACK-OBJ,SHACK-OVEN,SHARDS /TRUE
	EQUAL? PRSO,SILVER-SPOON,SKELETON,STAIRS /TRUE
	EQUAL? PRSO,STATUE,STONE-WALL,STRONG-BOX /TRUE
	EQUAL? PRSO,SUMMON-SCROLL,SWITCHES,SWORD /TRUE
	EQUAL? PRSO,TEMPLE-OBJ,TMAP,TOWER /TRUE
	EQUAL? PRSO,TOWER-N-DOOR,TOWER-S-DOOR,TREES /TRUE
	EQUAL? PRSO,TURRET,UNDERGROWTH,WALLS /TRUE
	EQUAL? PRSO,WINDOW \FALSE
	RTRUE

	.FUNCT IS-PERSON?
	EQUAL? PRSO,ADVENTURER,ADVENTURER-LG,GUARDS /TRUE
	EQUAL? PRSO,GLOBAL-TURTLE,GLOBAL-KRILL,TURTLE /TRUE
	EQUAL? PRSO,KRILL,GLOBAL-CRONE,GANG-OF-FOUR /TRUE
	EQUAL? PRSO,GANG-OF-N,BELBOZ,ENTHARION \FALSE
	RTRUE

	.FUNCT IS-ANIMAL?
	EQUAL? PRSO,FROG,MONSTERS-1,GLIMPSE-1 /TRUE
	EQUAL? PRSO,GLIMPSE-2,DRAGON,SHAPE \FALSE
	RTRUE

	.FUNCT IS-SELF?
	EQUAL? PRSO,ME \FALSE
	RTRUE

	.FUNCT IS-PART-OF-SELF?
	EQUAL? PRSO,HANDS \FALSE
	RTRUE

	.FUNCT IS-SELF-OR-PART-OF-SELF?,?TMP
	CALL IS-SELF? >?TMP
	ZERO? ?TMP /?L2
	RETURN ?TMP
?L2:	CALL IS-PART-OF-SELF? >STACK
	RSTACK

	.FUNCT IS-YOUR-PROPERTY?
	EQUAL? PRSO,SPELL-BOOK \FALSE
	RTRUE

	.FUNCT DANGEROUS-DRINK?
	EQUAL? PRSO,SEA \FALSE
	RTRUE

	.FUNCT DANGEROUS-FOOD?
	CALL IS-PART-OF-SELF? >STACK
	ZERO? STACK \?L2
	CALL IS-OBJECT-OR-PROPERTY? >STACK
	ZERO? STACK /FALSE
?L2:	EQUAL? PRSO,FOOD \TRUE
	RFALSE

	.FUNCT IS-OBJ-PROP-ANIMAL?,?TMP
	CALL IS-OBJECT-OR-PROPERTY? >?TMP
	ZERO? ?TMP /?L2
	RETURN ?TMP
?L2:	CALL IS-ANIMAL? >STACK
	RSTACK

	.FUNCT V-$0024COMMAND
	DIRIN 1
	RTRUE

	.FUNCT V-$0024RANDOM
	EQUAL? PRSO,INTNUM /?L1
	PRINTR "Illegal call to #RANDOM."
?L1:	SUB 0,P-NUMBER >STACK
	RANDOM STACK >STACK
	RTRUE

	.FUNCT V-$0024RECORD
	DIROUT D-RECORD-ON
	RTRUE

	.FUNCT V-$0024UNRECORD
	DIROUT D-RECORD-OFF
	RTRUE

	.FUNCT NULL-F
	RFALSE

	.FUNCT GROUND-F
	EQUAL? PRSA,V?CLIMB-FOO,V?CLIMB-ON,V?CLIMB-UP /?L3
	EQUAL? PRSA,V?BOARD \FALSE
?L3:	PRINTR "You've got better things to do."

	.FUNCT CORRIDOR-F
	EQUAL? PRSA,V?WALK-TO,V?THROUGH \FALSE
	CALL USE-DIRECTIONS >STACK
	RSTACK

	.FUNCT WALLS-F
	EQUAL? WALLS,PRSO \?L1
	EQUAL? HERE,NORTH-CELL \?L1
	CALL PERFORM,PRSA,STONE-WALL >STACK
	RSTACK
?L1:	FSET? HERE,RMUNGBIT \?L3
	EQUAL? PRSA,V?EXAMINE \?L4
	PRINTR "The wall is stained and noisome."
?L4:	EQUAL? PRSA,V?LISTEN \FALSE
	PRINTR "That's noisome, not noisy!"
?L3:	EQUAL? PRSA,V?LOOK-INSIDE \FALSE
	PRINTR "They're translucent, not transparent!"

	.FUNCT CRETIN
	EQUAL? PRSA,V?ESCAPE \?L1
	PRINTR "There's no escaping yourself."
?L1:	EQUAL? PRSA,V?PUT \?L5
	EQUAL? PRSO,EGG \?L5
	PRINTR "If you don't succeed, there will be plenty of egg on your face."
?L5:	EQUAL? PRSA,V?BURN \?L8
	PRINTI "Ouch!"
	CRLF
	CALL PRINT-ID,STR?52 >STACK
	RSTACK
?L8:	EQUAL? PRSA,V?LISTEN \?L11
	PRINTR "Yes?"
?L11:	EQUAL? PRSA,V?ALARM \?L14
	PRINTR "You are obviously awake already."
?L14:	EQUAL? PRSA,V?GUNCHO \?L17
	PRINTI "You vanish into oblivion where, to the relief of much of the Circle, you will be unable to do much harm."
	CRLF
	CALL PRINT-ID,STR?53
	CALL FINISH >STACK
	RSTACK
?L17:	EQUAL? PRSA,V?FROTZ \?L20
	FSET PLAYER,ONBIT
	SET 'ALWAYS-LIT,1
	PRINTR "You are bathed in a sickly yellow light, bright enough to read by."
?L20:	EQUAL? PRSA,V?BLORB \?L23
	CALL PRINT-ID,STR?54
	CALL JIGS-UP,STR?55,0
	RTRUE
?L23:	EQUAL? PRSA,V?KULCAD \?L24
	PRINTR "You seem real enough already."
?L24:	EQUAL? PRSA,V?EXAMINE \?L27
	PRINTR "You are not a pretty sight."
?L27:	EQUAL? PRSA,V?GIVE \?L30
	PRINTR "I think you're a little confused."
?L30:	EQUAL? PRSA,V?ATTACK,V?MUNG,V?KILL \?L33
	PRINTI "You don't need my help to do that!"
	CRLF
	CALL PRINT-ID,STR?56 >STACK
	RSTACK
?L33:	EQUAL? PRSA,V?FIND \?L36
	PRINTR "You're right here!"
?L36:	EQUAL? PRSA,V?CUT \FALSE
	EQUAL? PRSI,MAGIC-KNIFE \FALSE
	PRINTI "I should think one experience with that knife would be enough. I wouldn't press my luck."
	CRLF
	CALL PRINT-ID,STR?57 >STACK
	RSTACK

	.FUNCT WINDOW-F
	EQUAL? PRSA,V?LOOK-INSIDE \?L1
	GRTR? TOD,NIGHTFALL \?L3
	PRINTR "It's too dark to make out much of anything."
?L3:	GETP HERE,P?TEXT >STACK
	PRINT STACK
	CRLF
	RTRUE
?L1:	EQUAL? PRSA,V?OPEN \?L10
	PRINTR "You can't open it."
?L10:	EQUAL? PRSA,V?CLOSE \FALSE
	PRINTR "It already is."

	.FUNCT SEA-F
	EQUAL? HERE,BEACH /?L1
	PRINTR "The sea is off beyond the beach."
?L1:	EQUAL? PRSA,V?THROUGH \?L5
	PRINTR "You would drown."
?L5:	EQUAL? PRSA,V?EXAMINE \FALSE
	PRINTR "The sea is very rough. I wouldn't go in."

	.FUNCT FOREST-F
	EQUAL? PRSA,V?THROUGH \FALSE
	CALL USE-DIRECTIONS >STACK
	RSTACK

	.FUNCT TEMPLE-OBJ-F
	EQUAL? HERE,COURTYARD-2,COURTYARD-3 /?L3
	EQUAL? HERE,COURTYARD-4,COURTYARD-7 \FALSE
?L3:	EQUAL? PRSA,V?THROUGH \?L4
	CALL GOTO,TEMPLE
	RTRUE
?L4:	EQUAL? PRSA,V?LISTEN \FALSE
	PRINTR "You can hear a howling chant coming from inside the temple."

	.FUNCT COURTYARD-F
	EQUAL? PRSA,V?WALK-AROUND \?L1
	EQUAL? HERE,INSIDE-GATE /?L1
	EQUAL? HERE,COURTYARD-7,COURTYARD-6,COURTYARD-4 \?L3
	CALL DO-WALK,P?WEST >STACK
	RSTACK
?L3:	CALL DO-WALK,P?EAST >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?THROUGH \FALSE
	EQUAL? HERE,INSIDE-GATE \FALSE
	CALL DO-WALK,P?EAST >STACK
	RSTACK

	.FUNCT TOWER-F
	EQUAL? PRSA,V?BOARD,V?CLIMB-FOO,V?CLIMB-UP \?L1
	EQUAL? HERE,PURLOINED-ROOM,SE-TOWER /?L3
	EQUAL? HERE,NW-TOWER,SW-TOWER \?L1
?L3:	CALL DO-WALK,P?UP >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?CLIMB-FOO,V?CLIMB-DOWN \?L4
	EQUAL? HERE,JEWEL-ROOM,MAP-ROOM /?L5
	EQUAL? HERE,ENGINE-ROOM,BEDROOM \?L4
?L5:	CALL DO-WALK,P?DOWN >STACK
	RSTACK
?L4:	EQUAL? PRSA,V?CLIMB-FOO,V?CLIMB-UP \FALSE
	PRINTR "They are a bit far away to climb from here, and anyway the walls would be impossible to scale."

	.FUNCT JUG-F,E?=0
	EQUAL? PRSA,V?CLOSE,V?OPEN \?L1
	PRINTR "The jug has no cover. It can't be opened or closed."
?L1:	EQUAL? PRSA,V?MUNG,V?THROW \?L5
	REMOVE PRSO
	SET 'E?,1
	PRINTI "The jug shatters into innumerable pieces."
	CRLF
	JUMP ?L9
?L5:	EQUAL? PRSA,V?SHAKE \?L9
	FSET? PRSO,OPENBIT \?L9
	SET 'E?,1
?L9:	EQUAL? PRSA,V?LOOK-INSIDE,V?EXAMINE \?L13
	PRINTI "The jug is "
	IN? WATER,PRSO /?L17
	PRINTR "empty."
?L17:	GETP WATER,P?SIZE >STACK
	GET JUG-AMTS,STACK >STACK
	PRINT STACK
	CRLF
	RTRUE
?L13:	ZERO? E? /FALSE
	IN? WATER,PRSO \TRUE
	PRINTI "The water spills to the ground and evaporates."
	CRLF
	REMOVE WATER
	RTRUE

	.FUNCT WATER-FUNCTION,AV,W,PI?
	EQUAL? PRSA,V?EXAMINE \?L1
	EQUAL? PRSO,GLOBAL-WATER \?L1
	EQUAL? HERE,BEACH \?L3
	PRINTR "The ocean streches out as far as the eye can see to the south and east."
?L3:	EQUAL? HERE,FOREST-2 \?L7
	PRINTR "The water is dark and murky, and lily pads cover most of the surface. I wouldn't drink the stuff."
?L7:	PRINTR "The brook runs slowly through thick vegetation."
?L1:	EQUAL? PRSA,V?THROUGH \?L13
	EQUAL? PRSO,GLOBAL-WATER \?L13
	PRINTR "You have better things to do with your time than go swimming."
?L13:	EQUAL? PRSA,V?DRINK-FROM \?L16
	EQUAL? PRSO,GLOBAL-WATER \?L16
	CALL V-DRINK-FROM
	RTRUE
?L16:	EQUAL? PRSA,V?SGIVE /FALSE
	EQUAL? PRSA,V?THROUGH \?L18
	PRINTR "Swimming here is fraught with peril."
?L18:	EQUAL? PRSA,V?FILL \?L21
	SET 'W,PRSI
	SET 'PRSA,V?PUT
	SET 'PRSI,PRSO
	SET 'PRSO,W
	SET 'PI?,0
	JUMP ?L23
?L21:	EQUAL? PRSO,GLOBAL-WATER,WATER \?L22
	SET 'W,PRSO
	SET 'PI?,0
	JUMP ?L23
?L22:	SET 'W,PRSI
	SET 'PI?,1
?L23:	EQUAL? W,GLOBAL-WATER \?L29
	EQUAL? PRSA,V?DRINK /FALSE
	SET 'W,WATER
	EQUAL? PRSA,V?PUT,V?TAKE \?L29
	REMOVE W
?L29:	ZERO? PI? /?L33
	SET 'PRSI,W
	JUMP ?L35
?L33:	SET 'PRSO,W
?L35:	LOC WINNER >AV
	EQUAL? PRSA,V?PUT,V?TAKE \?L36
	ZERO? PI? \?L82
	EQUAL? PRSI,0,JUG /?L38
	EQUAL? PRSI,SEA,GLOBAL-WATER \?L40
	PRINTI "Ok, but there was plenty enough there already."
	CRLF
	REMOVE W
	RTRUE
?L40:	GETP PRSI,P?CAPACITY >STACK
	ZERO? STACK /?L44
	PRINTI "The water leaks out of the "
	PRINTD PRSI
	PRINTI " and evaporates immediately."
	CRLF
	REMOVE W
	RTRUE
?L44:	PRINTI "The "
	PRINTD PRSI
	PRINTR " isn't a very good container."
?L38:	IN? JUG,WINNER \?L50
	FSET? JUG,OPENBIT /?L51
	PRINTR "The jug is closed."
?L51:	CALL GLOBAL-IN?,GLOBAL-WATER,HERE >STACK
	ZERO? STACK /?L55
	IN? WATER,JUG \?L58
	GETP WATER,P?SIZE >STACK
	LESS? STACK,4 \?L56
?L58:	MOVE WATER,JUG
	PUTP WATER,P?SIZE,4
	PRINTI "The jug is now full of "
	EQUAL? HERE,BEACH \?L61
	FSET WATER,RMUNGBIT
	PRINTI "sea"
	JUMP ?L68
?L61:	EQUAL? HERE,FOREST-2 \?L65
	FSET WATER,RMUNGBIT
	PRINTI "foul algae-infested "
	JUMP ?L68
?L65:	FCLEAR WATER,RMUNGBIT
?L68:	PRINTR "water."
?L56:	PRINTR "The jug is already full."
?L55:	PRINTR "The only water here is in the jug."
?L50:	IN? PRSO,JUG \?L77
	EQUAL? PRSA,V?TAKE \?L77
	ZERO? PRSI \?L77
	SET 'PRSO,JUG
	CALL ITAKE
	SET 'PRSO,W
	RETURN PRSO
?L77:	PRINTR "The water slips through your fingers."
?L36:	ZERO? PI? /?L81
?L82:	PRINTR "Nice try."
?L81:	EQUAL? PRSA,V?GIVE,V?DROP \?L84
	REMOVE WATER
	EQUAL? PRSI,SEA,GLOBAL-WATER \?L85
	PRINTR "Ok, but there was plenty enough there already."
?L85:	PRINTR "The water spills to the ground and evaporates."
?L84:	EQUAL? PRSA,V?POUR-ON \?L92
	REMOVE WATER
	PRINTI "The water cascades off the "
	PRINTD PRSI
	PRINTR " and onto the ground."
?L92:	EQUAL? PRSA,V?THROW \FALSE
	PRINTI "The water splashes over everything and evaporates."
	CRLF
	REMOVE WATER
	RTRUE

	.FUNCT SKY-F,EL
	FSET? HERE,ONBIT \?L1
	EQUAL? PRSA,V?EXAMINE \?L1
	DIV TOD,10 >EL
	PRINTI "It would be "
	GET TIME-TABLE,EL >STACK
	PRINT STACK
	PRINTI " now."
	GRTR? TOD,NIGHTFALL \?L5
	PRINTI " Bright stars shine down on the earth."
?L5:	CRLF
	RTRUE
?L1:	PRINTR "That would be difficult from here."

	.FUNCT NOT-HERE-OBJECT-F,TBL,PRSO?=1,OBJ
	EQUAL? PRSO,NOT-HERE-OBJECT \?L5
	EQUAL? PRSI,NOT-HERE-OBJECT \?L1
	PRINTR "Those things aren't here!"
?L1:	EQUAL? PRSO,NOT-HERE-OBJECT \?L5
	SET 'TBL,P-PRSO
	JUMP ?L6
?L5:	SET 'TBL,P-PRSI
	SET 'PRSO?,0
?L6:	ZERO? PRSO? /?L17
	EQUAL? PRSA,V?ZIFMIA /?L11
	EQUAL? PRSA,V?CAST \?L17
	EQUAL? PRSO,SUMMON-SPELL \?L17
?L11:	CALL FIND-NOT-HERE,TBL,PRSO? >OBJ
	ZERO? OBJ /FALSE
	EQUAL? OBJ,NOT-HERE-OBJECT \TRUE
?L17:	EQUAL? WINNER,PLAYER \?L20
	PRINTI "You can't see any "
	CALL NOT-HERE-PRINT,PRSO?
	PRINTI " here!"
	CRLF
	JUMP ?L26
?L20:	PRINTI "The "
	PRINTD WINNER
	PRINTI " seems confused. ""I don't see any "
	CALL NOT-HERE-PRINT,PRSO?
	PRINTI " here!"""
	CRLF
?L26:	SET 'P-CONT,0
	SET 'QUOTE-FLAG,0
	RTRUE

	.FUNCT FIND-NOT-HERE,TBL,PRSO?,M-F,OBJ
	CALL MOBY-FIND,TBL >M-F
	ZERO? DEBUG /?L1
	PRINTI "[Moby-found "
	PRINTN M-F
	PRINTI " objects"
	PRINTI "]"
	CRLF
?L1:	GRTR? M-F,1 \?L6
	GET TBL,1 >STACK
	GETP STACK,P?GLOBAL >OBJ
	ZERO? OBJ /?L6
	SET 'M-F,1
	SET 'P-MOBY-FOUND,OBJ
?L6:	EQUAL? 1,M-F \?L9
	ZERO? DEBUG /?L11
	PRINTI "[Namely: "
	PRINTD P-MOBY-FOUND
	PRINTI "]"
	CRLF
?L11:	ZERO? PRSO? /?L16
	SET 'PRSO,P-MOBY-FOUND
	RFALSE
?L16:	SET 'PRSI,P-MOBY-FOUND
	RFALSE
?L9:	ZERO? PRSO? \?L19
	PRINTI "You wouldn't find any "
	CALL NOT-HERE-PRINT,PRSO?
	PRINTR " there."
?L19:	RETURN NOT-HERE-OBJECT

	.FUNCT GLOBAL-NOT-HERE-PRINT,OBJ
	SET 'P-CONT,0
	SET 'QUOTE-FLAG,0
	PRINTI "You can't see"
	EQUAL? OBJ,GLOBAL-KRILL /?L3
	PRINTI " any"
?L3:	EQUAL? OBJ,PRSO \?L8
	CALL PRSO-PRINT
	JUMP ?L10
?L8:	CALL PRSI-PRINT
?L10:	PRINTR " here."

	.FUNCT NOT-HERE-PRINT,PRSO?
	ZERO? P-OFLAG /?L1
	ZERO? P-XADJ /?L3
	PRINTB P-XADJN
?L3:	ZERO? P-XNAM /FALSE
	PRINTB P-XNAM
	RTRUE
?L1:	ZERO? PRSO? /?L9
	GET P-ITBL,P-NC1L >STACK
	GET P-ITBL,P-NC1 >STACK
	CALL BUFFER-PRINT,STACK,STACK,0 >STACK
	RSTACK
?L9:	GET P-ITBL,P-NC2L >STACK
	GET P-ITBL,P-NC2 >STACK
	CALL BUFFER-PRINT,STACK,STACK,0 >STACK
	RSTACK

	.FUNCT BELBOZ-F
	EQUAL? PRSA,V?ZIFMIA \?L1
	PRINTI "A vision of the great Belboz begins to take shape before you, but "
	GETP HERE,P?TMAZE >STACK
	ZERO? STACK /?L5
	PRINTR "as soon as he realizes where you are, he disappears, a look of fear upon his face."
?L5:	PRINTR "with a curt word and a waggle of his finger, he disappears again, shaking his head in disappointment."
?L1:	EQUAL? PRSA,V?WHO,V?EXAMINE \FALSE
	PRINTR "Belboz is, in effect, your boss, professor, patron, and ultimate superior. He is the head of the Circle of Enchanters."

	.FUNCT GLOBAL-ROOM-F
	EQUAL? PRSA,V?EXAMINE,V?LOOK \?L1
	CALL PERFORM,V?LOOK
	RTRUE
?L1:	EQUAL? PRSA,V?WALK-AROUND \FALSE
	PRINTR "Walking around the room reveals nothing else of interest. If you want to move elsewhere, simply indicate the direction you wish to move in."

	.FUNCT BRAMBLES-F
	CALL OUTSIDE?,HERE >STACK
	ZERO? STACK \?L1
	PRINTR "The only brambles here are in your head."
?L1:	EQUAL? PRSA,V?LOOK-INSIDE,V?SEARCH \FALSE
	PRINTR "There's nothing in the brambles now. Count your blessings."

	.FUNCT GLOBAL-HOLE-F
	EQUAL? PRSA,V?DIG \?L1
	PRINTR "It's not worth the bother."
?L1:	CALL GLOBAL-NOT-HERE-PRINT,GLOBAL-HOLE >STACK
	RSTACK

	.FUNCT TERROR-F
	EQUAL? PRSA,V?ZIFMIA \?L1
	PRINTR "As you cast the zifmia spell, you are overpowered with such a sense of malice that you cannot continue. All in all, a good thing probably."
?L1:	EQUAL? PRSA,V?VAXUM \?L5
	PRINTR "The terror may be friendlier, but with friends like that...."
?L5:	EQUAL? PRSA,V?GUNCHO \FALSE
	REMOVE TERROR
	PRINTR "The room fills with a horrible noise, darkens to pitch blackness, and then lightens. The weight of fear lifts."

	.FUNCT TMAP-F
	EQUAL? PRSA,V?KULCAD \?L1
	PRINTI "At once, a maze of lines forms, connecting all of the spots on the map. Suddenly, the world becomes still and cold."
	CRLF
	CRLF
	CALL END-OF-WORLD
	RTRUE
?L1:	EQUAL? PRSA,V?PUT,V?CLOSE,V?OPEN \?L5
	PRINTR "You can't do that."
?L5:	EQUAL? PRSA,V?DRAW-ON \?L8
	IN? PENCIL,WINNER \?L9
	CALL WRITE-HINT
	RTRUE
?L9:	PRINTR "You have nothing to draw with."
?L8:	EQUAL? PRSA,V?LOOK-INSIDE,V?EXAMINE,V?READ \FALSE
	PRINTI "The map consists of a drawing with nine points, each represented by a strange character, with interconnecting thin pencil lines. Using your native alphabet, it looks like this:"
	CRLF
	CALL DRAW-TMAZE >STACK
	RSTACK

	.FUNCT PENCIL-F
	EQUAL? PRSA,V?KULCAD \?L1
	PRINTI "As the pencil dissolves into nothingness, everything becomes still and cold."
	CRLF
	CRLF
	CALL END-OF-WORLD
	RTRUE
?L1:	EQUAL? PRSA,V?EXAMINE \FALSE
	PRINTI "The pencil is very old and covered with finely inlaid runes. The point is "
	GET PENCIL-TBL,PENCIL-COUNT >STACK
	PRINT STACK
	PRINTI " and the attached eraser is "
	GET ERASER-TBL,ERASER-COUNT >STACK
	PRINT STACK
	PRINTR "."

	.FUNCT BLACK-PASSAGE-F
	EQUAL? PRSA,V?EXAMINE \FALSE
	PRINTR "The passages are perfectly round and black; the walls seem to be made of carbon."

	.FUNCT TMAZE-F,RARG,TBL,NEX=0,FLG=0,OFFS=0,PLU=0
	IN? BANISH-SCROLL,WINNER \?L1
	EQUAL? HERE,T-A \?L1
	ZERO? TERROR-TRAPPED /?L1
	GRTR? TERROR-POINT,0 \?L1
	PRINTI "You hear a horrible anguished scream through the walls of the cavern as the terror realizes that it is trapped and its scroll of power stolen!"
	CRLF
	CRLF
	ADD SCORE,TERROR-POINT >SCORE
	SET 'TERROR-POINT,0
?L1:	EQUAL? RARG,M-LOOK \?L6
	PRINTI "This is a peculiar room, whose cream-colored walls are thin and translucent."
	CRLF
	GETP HERE,P?TMAZE >TBL
?L10:	GET TBL,OFFS >STACK
	EQUAL? STACK,-1 /?L11
	ADD OFFS,1 >STACK
	GET TBL,STACK >STACK
	EQUAL? STACK,1 \?L14
	INC 'NEX
?L14:	ADD OFFS,2 >OFFS
	JUMP ?L10
?L11:	ZERO? NEX \?L16
	PRINTR "There is not a single exit from this place."
?L16:	EQUAL? NEX,1 \?L20
	PRINTI "An exit is"
	JUMP ?L23
?L20:	SET 'PLU,1
	PRINTI "Passages go"
?L23:	PRINTI " to the "
	SET 'OFFS,0
?L28:	GET TBL,OFFS >STACK
	EQUAL? STACK,-1 /?L29
	ADD OFFS,1 >STACK
	GET TBL,STACK >STACK
	EQUAL? STACK,1 \?L32
	DIV OFFS,2 >STACK
	GET TMAZE-DIRS,STACK >STACK
	PRINT STACK
	GRTR? NEX,2 \?L35
	SET 'FLG,1
	PRINTI ", "
	JUMP ?L39
?L35:	EQUAL? NEX,2 \?L39
	ZERO? FLG /?L40
	PRINTI ","
?L40:	PRINTI " and "
?L39:	DEC 'NEX
?L32:	ADD OFFS,2 >OFFS
	JUMP ?L28
?L29:	PRINTI " and "
	ZERO? PLU /?L51
	PRINTI "they are"
	JUMP ?L55
?L51:	PRINTI "it is"
?L55:	PRINTR " very strange indeed, perfectly round and black as pitch."
?L6:	EQUAL? RARG,M-BEG \FALSE
	IN? TERROR,HERE \?L61
	EQUAL? PRSA,V?WALK \FALSE
	PRINTI "Your feet are leaden with fear, and cold sweat runs down your back as you make your way to the door, but you make no progress. Your mind tells you you are running, but you aren't getting anywhere."
	CRLF
	CALL PRINT-ID,STR?58 >STACK
	RSTACK
?L61:	EQUAL? PRSA,V?WALK \FALSE
	EQUAL? HERE,T-A \?L69
	EQUAL? PRSO,P?UP \?L69
	CALL GOTO,DUNGEON
	RTRUE
?L69:	GRTR? PRSO,P?UP \?L71
	GETP HERE,P?TMAZE >TBL
	SUB PRSO,P?UP >STACK
	MUL STACK,2 >STACK
	SUB STACK,1 >OFFS
	GET TBL,OFFS >STACK
	EQUAL? STACK,1 \?L71
	SUB OFFS,1 >STACK
	GET TBL,STACK >STACK
	CALL GOTO,STACK
	IN? TERROR,HERE \?L72
	PRINTI "An evil presence pervades the room, its source unseen. Fear seeps into your mind, like fog. You look fearfully around. There is something horrible here."
	CRLF
	CALL PRINT-ID,STR?59
	RTRUE
?L72:	LOC TERROR >STACK
	CALL CONNECTED?,HERE,STACK >STACK
	ZERO? STACK /TRUE
	PRINTR "You sense that near this place an evil presence lurks. It seems close by and is moving."
?L71:	PRINTR "You can't go that way."

	.FUNCT END-OF-WORLD
	PRINTI "You suddenly feel weak and your knees buckle. Just as you collapse to the ground, you find yourself in the presence of the Circle. They seem tense and frightened and ask desperately about your recent doings. As you tell your tale of the map and pencil, they recoil in horror. ""The Terror is released!"" cries one. Belboz sinks into his throne. ""We are doomed!"" he gasps. One by one, the wizards flee to prepare a hopeless defense."
	CRLF
	CALL PRINT-ID,STR?60
	SET 'SCORE,-10
	CALL FINISH >STACK
	RSTACK

	.FUNCT DRAW-TMAZE
	CALL FIXED-FONT-ON
	CRLF
	PRINTI "B"
	CALL ECN,T-A,T-H
	PRINTI "J"
	CRLF
	CALL CN,T-A,T-SOUTH
	CALL CN,T-A,T-SE
	PRINTI "     "
	CALL CN,T-E,T-SW
	CALL CN,T-E,T-SOUTH
	CALL CN,T-E,T-SE
	CRLF
	CALL CN,T-A,T-SOUTH
	PRINTI " "
	CALL CN,T-A,T-SE
	PRINTI "   "
	CALL CN,T-E,T-SW
	PRINTI " "
	CALL CN,T-E,T-SOUTH
	PRINTI " "
	CALL CN,T-E,T-SE
	CRLF
	CALL CN,T-A,T-SOUTH
	PRINTI "  "
	CALL CN,T-A,T-SE
	PRINTI " "
	CALL CN,T-E,T-SW
	PRINTI "  "
	CALL CN,T-E,T-SOUTH
	PRINTI "  "
	CALL CN,T-E,T-SE
	CRLF
	CALL CN,T-A,T-SOUTH
	PRINTI "   K"
	CALL ECN,T-C,T-E
	PRINTI "V"
	CRLF
	CALL CN,T-A,T-SOUTH
	PRINTI "  "
	CALL CN,T-C,T-SW
	CALL CN,T-C,T-SOUTH
	CALL CN,T-C,T-SE
	PRINTI "  "
	CALL CN,T-E,T-SOUTH
	PRINTI "  "
	CALL CN,T-G,T-SW
	CALL CN,T-G,T-SOUTH
	CALL CN,T-G,T-SE
	CRLF
	CALL CN,T-A,T-SOUTH
	PRINTI " "
	CALL CN,T-C,T-SW
	PRINTI " "
	CALL CN,T-C,T-SOUTH
	PRINTI " "
	CALL CN,T-C,T-SE
	PRINTI " "
	CALL CN,T-E,T-SOUTH
	PRINTI " "
	CALL CN,T-G,T-SW
	PRINTI " "
	CALL CN,T-G,T-SOUTH
	PRINTI " "
	CALL CN,T-G,T-SE
	CRLF
	CALL CN,T-A,T-SOUTH
	CALL CN,T-C,T-SW
	PRINTI "  "
	CALL CN,T-C,T-SOUTH
	PRINTI "  "
	CALL CN,T-C,T-SE
	CALL CN,T-E,T-SOUTH
	CALL CN,T-G,T-SW
	PRINTI "  "
	CALL CN,T-G,T-SOUTH
	PRINTI "  "
	CALL CN,T-G,T-SE
	CRLF
	PRINTI "R"
	CALL ECN,T-B,T-C
	PRINTI "M"
	CALL ECN,T-F,T-G
	PRINTI "F"
	CRLF
	PRINTI " "
	CALL CN,T-B,T-SE
	PRINTI "  "
	CALL CN,T-C,T-SOUTH
	PRINTI "  "
	CALL CN,T-F,T-SW
	PRINTI " "
	CALL CN,T-F,T-SE
	PRINTI "  "
	CALL CN,T-G,T-SOUTH
	PRINTI "  "
	CALL CN,T-H,T-SW
	CRLF
	PRINTI "  "
	CALL CN,T-B,T-SE
	PRINTI " "
	CALL CN,T-C,T-SOUTH
	PRINTI " "
	CALL CN,T-F,T-SW
	PRINTI "   "
	CALL CN,T-F,T-SE
	PRINTI " "
	CALL CN,T-G,T-SOUTH
	PRINTI " "
	CALL CN,T-H,T-SW
	CRLF
	PRINTI "   "
	CALL CN,T-B,T-SE
	CALL CN,T-C,T-SOUTH
	CALL CN,T-F,T-SW
	PRINTI "     "
	CALL CN,T-F,T-SE
	CALL CN,T-G,T-SOUTH
	CALL CN,T-H,T-SW
	CRLF
	PRINTI "    H"
	CALL ECN,T-D,T-H
	PRINTI "P"
	CRLF
	CRLF
	CALL FIXED-FONT-OFF
	RTRUE

	.FUNCT FIXED-FONT-ON
	GET 0,8 >STACK
	BOR STACK,2 >STACK
	PUT 0,8,STACK
	RTRUE

	.FUNCT FIXED-FONT-OFF
	GET 0,8 >STACK
	BAND STACK,-3 >STACK
	PUT 0,8,STACK
	RTRUE

	.FUNCT CN,L,DIR
	GETP L,P?TMAZE >STACK
	GET STACK,DIR >STACK
	ZERO? STACK /?L1
	GET T-DIR-TABLE,DIR >STACK
	PRINT STACK
	RTRUE
?L1:	PRINTI " "
	RTRUE

	.FUNCT ECN,L,DN,FLG=0
	GETP L,P?TMAZE >STACK
	GET STACK,T-EAST >STACK
	ZERO? STACK /?L1
	SET 'FLG,1
	PRINTI "---"
	JUMP ?L5
?L1:	PRINTI "   "
?L5:	GETP DN,P?TMAZE >STACK
	GET STACK,T-SOUTH >STACK
	ZERO? STACK /?L8
	ZERO? FLG /?L10
	PRINTI "+"
	JUMP ?L20
?L10:	PRINTI "!"
	JUMP ?L20
?L8:	ZERO? FLG /?L17
	PRINTI "-"
	JUMP ?L20
?L17:	PRINTI " "
?L20:	ZERO? FLG /?L23
	PRINTI "---"
	RTRUE
?L23:	PRINTI "   "
	RTRUE

	.FUNCT CONNECT,RM1,RM2,FLIP=0,TBL,RMX
	GETP RM1,P?TMAZE >TBL
?L1:	GET TBL,0 >RMX
	EQUAL? RMX,-1 \?L3
	PRINTR "The pencil doesn't seem to allow that line to be drawn."
?L3:	EQUAL? RMX,RM2 \?L7
	GET TBL,1 >STACK
	ZERO? STACK \?L8
	ZERO? FLIP \?L14
	CALL CONNECT,RM2,RM1,1
	DEC 'PENCIL-COUNT
	PRINTI "A thin line now connects the two spots on the map, but the pencil point is "
	GET PENCIL-TBL,PENCIL-COUNT >STACK
	PRINT STACK
	PRINTI "."
	CRLF
	EQUAL? HERE,RM1,RM2 \?L14
	CALL DESCRIBE-NEW-EXIT,RM1,RM2
?L14:	PUT TBL,1,1
	LOC TERROR >STACK
	ZERO? STACK /TRUE
	LOC TERROR >STACK
	CALL TWALK,STACK >STACK
	ZERO? STACK /TRUE
	SET 'TERROR-TRAPPED,0
	CALL QUEUE,I-TERROR,-1 >STACK
	PUT STACK,0,1
	RTRUE
?L8:	PRINTR "There is already a line connecting those spots."
?L7:	ADD TBL,4 >TBL
	JUMP ?L1

	.FUNCT DISCONNECT,RM1,RM2,FLIP=0,TBL,RMX
	GETP RM1,P?TMAZE >TBL
?L1:	GET TBL,0 >RMX
	EQUAL? RMX,-1 \?L3
	PRINTR "Those two spots aren't connected on the map."
?L3:	EQUAL? RMX,RM2 \?L7
	GET TBL,1 >STACK
	ZERO? STACK \?L8
	PRINTR "Those two spots aren't connected on the map."
?L8:	ZERO? FLIP \?L17
	CALL DISCONNECT,RM2,RM1,1
	DEC 'ERASER-COUNT
	PRINTI "The line between the two spots is erased, leaving the eraser "
	GET ERASER-TBL,ERASER-COUNT >STACK
	PRINT STACK
	PRINTI "."
	CRLF
	EQUAL? HERE,RM1,RM2 \?L17
	CALL DESCRIBE-NEW-EXIT,RM1,RM2,0
?L17:	PUT TBL,1,0
	RTRUE
?L7:	ADD TBL,4 >TBL
	JUMP ?L1

	.FUNCT DESCRIBE-NEW-EXIT,RM1,RM2,MAKE?=1,TMP,TBL,OFFS=0
	EQUAL? RM2,HERE \?L1
	SET 'TMP,RM1
	SET 'RM1,RM2
	SET 'RM2,TMP
?L1:	GETP RM1,P?TMAZE >TBL
?L4:	GET TBL,OFFS >TMP
	EQUAL? TMP,RM2 /?L5
	EQUAL? TMP,-1 \?L8
	PRINTI "*ERROR* BAD-EXIT DESCRIBE-NEW-EXIT"
	CRLF
	JUMP ?L5
?L8:	ADD OFFS,2 >OFFS
	JUMP ?L4
?L5:	PRINTI "Suddenly, the "
	ZERO? MAKE? /?L14
	PRINTI "wall"
	JUMP ?L18
?L14:	PRINTI "black passage"
?L18:	PRINTI " to the "
	DIV OFFS,2 >STACK
	GET TMAZE-DIRS,STACK >STACK
	PRINT STACK
	ZERO? MAKE? /?L25
	PRINTI " opens to form a perfectly round and black passage"
	JUMP ?L29
?L25:	PRINTI " closes off"
?L29:	PRINTR "!"

	.FUNCT CONNECTED?,RM1,RM2,TBL,RMX
	GETP RM1,P?TMAZE >TBL
	ZERO? TBL /FALSE
?L1:	GET TBL,0 >RMX
	EQUAL? RMX,-1 /FALSE
	EQUAL? RMX,RM2 \?L11
	GET TBL,1 >STACK
	ZERO? STACK \TRUE
	RFALSE
?L11:	ADD TBL,4 >TBL
	JUMP ?L1

	.FUNCT I-TERROR,RM,NRM,FLG=0
	ZERO? TERROR-TRAPPED /?L1
	LOC TERROR >RM
	CALL CONNECTED?,HERE,RM >STACK
	ZERO? STACK /FALSE
	MOVE TERROR,HERE
	PRINT TERROR-ARRIVES
	CRLF
	RTRUE
?L1:	LOC TERROR >RM
	CALL TWALK,RM >STACK
	ZERO? STACK /?L8
	SET 'TERROR-TRAPPED,0
	SET 'TWAIT,0
	GET PATH-TBL,2 >STACK
	GET TMAZE-ROOMS,STACK >NRM
	MOVE TERROR,NRM
	EQUAL? HERE,NRM \?L9
	PRINT TERROR-ARRIVES
	CRLF
	SET 'FLG,1
	JUMP ?L16
?L9:	CALL CONNECTED?,HERE,NRM >STACK
	ZERO? STACK /?L13
	PRINTI "Somewhere near, an evil presence lurks, probing your mind. It seems to be moving quickly."
	CRLF
	SET 'FLG,1
	JUMP ?L16
?L13:	CALL CONNECTED?,HERE,RM >STACK
	ZERO? STACK /?L16
	PRINTI "You can no longer sense the evil presence nearby."
	CRLF
	SET 'FLG,1
?L16:	ZERO? TERROR-MOVED \?L20
	SET 'TERROR-MOVED,1
	INC 'LOSSAGE
	SET 'FLG,1
	PRINTI "You feel that two powerful, evil forces are searching each other out. As they meet, the air lightens. Belboz appears before you. ""Something has disturbed the ancient Terror. Krill himself knows this and will try to use it to his purposes. Already, they may have joined together. You must not allow the Terror to escape, or we are all doomed!"" He fades into the gloom."
	CRLF
?L20:	EQUAL? NRM,T-A \?L31
	CALL END-OF-WORLD
	EQUAL? HERE,T-A \?L27
	SET 'FLG,1
	PRINTI "The presence seems to grow stronger each passing second, beating you down with its awesome power."
	CRLF
	CALL PRINT-ID,STR?61
	RETURN FLG
?L27:	SET 'FLG,1
	PRINTI "At once, a strange and horrible feeling wells up inside of you. An unseen yet awesomely powerful force, exuding pure evil, seems to fill the very chamber."
	CRLF
	CALL PRINT-ID,STR?62
?L31:	RETURN FLG
?L8:	CALL TNULL-F >STACK
	ZERO? STACK \TRUE
	IGRTR? 'TWAIT,6 /TRUE
	CALL TWALK1 >RM
	ZERO? RM /TRUE
	LOC TERROR >NRM
	EQUAL? NRM,T-I /TRUE
	CALL CONNECTED?,NRM,T-I >STACK
	ZERO? STACK /?L41
	MOVE TERROR,T-I
	JUMP ?L42
?L41:	CALL CONNECTED?,NRM,T-F >STACK
	ZERO? STACK /?L42
	MOVE TERROR,T-F
?L42:	IN? TERROR,HERE \?L44
	PRINT TERROR-ARRIVES
	CRLF
	RTRUE
?L44:	PRINTI "From somewhere nearby, an unseen force probes you, and you are gripped by a sickening feeling."
	CRLF
	CALL PRINT-ID,STR?63
	RTRUE

	.FUNCT TNULL-F
	SET 'TERROR-TRAPPED,1
	RFALSE

	.FUNCT TWALK,RM
	SET 'TWALK-LEVEL,0
	SET 'TTRIES,0
	SET 'PSTART,RM
	CALL PATH-OUT?,RM >STACK
	RSTACK

	.FUNCT TWALK1,TBL,RM,NRM,OFFS=1,CNT
	LOC TERROR >RM
	GETP RM,P?CAPACITY >STACK
	GET TWALK-PATHS,STACK >TBL
	GET TBL,0 >CNT
?L1:	GRTR? OFFS,CNT /FALSE
	GET TBL,OFFS >STACK
	GET TMAZE-ROOMS,STACK >NRM
	CALL CONNECTED?,RM,NRM >STACK
	ZERO? STACK /?L5
	RETURN NRM
?L5:	INC 'OFFS
	JUMP ?L1

	.FUNCT PATH-OUT?,RM,OFFS=1,TBL,CNT=0,NRM
	INC 'TTRIES
	INC 'TWALK-LEVEL
	GETP RM,P?CAPACITY >STACK
	PUT PATH-TBL,TWALK-LEVEL,STACK
	EQUAL? RM,T-A \?L1
	DEC 'TWALK-LEVEL
	RTRUE
?L1:	GRTR? TWALK-LEVEL,TWALK-MAX \?L3
	DEC 'TWALK-LEVEL
	RFALSE
?L3:	GETP RM,P?CAPACITY >STACK
	GET TWALK-PATHS,STACK >TBL
	GET TBL,0 >CNT
	ZERO? CNT \?L5
	DEC 'TWALK-LEVEL
	RTRUE
?L5:	GRTR? OFFS,CNT \?L10
	DEC 'TWALK-LEVEL
	RFALSE
?L10:	GET TBL,OFFS >STACK
	GET TMAZE-ROOMS,STACK >NRM
	CALL CONNECTED?,RM,NRM >STACK
	ZERO? STACK /?L12
	EQUAL? NRM,PSTART /?L12
	CALL PATH-OUT?,NRM >STACK
	ZERO? STACK /?L12
	DEC 'TWALK-LEVEL
	RTRUE
?L12:	INC 'OFFS
	JUMP ?L5

	.FUNCT LEGEND-BOOK-F
	EQUAL? PRSA,V?CLOSE \?L1
	FSET? PRSO,OPENBIT \?L1
	FCLEAR PRSO,OPENBIT
	PRINTR "Closed."
?L1:	EQUAL? PRSA,V?LOOK-INSIDE,V?EXAMINE,V?READ /?L6
	EQUAL? PRSA,V?OPEN \?L5
?L6:	FSET PRSO,OPENBIT
	PRINTR "The first page of the book was the table of contents. Only two chapter names can be read: The Legend of the Unseen Terror and The Legend of the Great Implementers."
?L5:	EQUAL? PRSA,V?TURN \FALSE
	PRINTR "Rather than turning pages, why don't you simply read the legends."

	.FUNCT LEGEND-TWO-F
	EQUAL? PRSA,V?ZIFMIA \FALSE
	ZERO? IMP-SEEN \FALSE
	SET 'IMP-SEEN,1
	PRINTR "The implementers of the world, Marc Blank and Dave Lebling, appear before you, looking quite as confused as yourself. They speak:
Dave: ""What's happening here?""
Marc: ""Uh, I dunno. YOU wrote this code, not me.""
Dave: ""Hmm. Another day, another bug. Let's see here...""
They disappear a moment later.
Dave's voice: ""That should do it."""

	.FUNCT LANDING-EXIT-F
	ZERO? STAIR-SOLVED? /?L1
	PRINTI "There is no floor there, and the pit beneath you is of great, if not infinite, depth. You fall forever."
	CALL PRINT-ID,STR?64
	CALL FINISH >STACK
	RSTACK
?L1:	RETURN ENDLESS-STAIR

	.FUNCT ADVENTURER-DROPS-OUT
	PRINTI "The adventurer seems to have dropped out of existence. In a voice that seems to recede into the void, you hear his final word: ""Restore...."" You muse about how a mere adventurer might come to possess a spell of such power."
	CRLF
	REMOVE ADVENTURER
	CALL QUEUE,I-ADVENTURER,0
	RTRUE

	.FUNCT STAIRS-F
	EQUAL? HERE,JUNCTION \?L1
	PRINTR "The stairs are to the east. You'll have to go there to get a look."
?L1:	EQUAL? HERE,ENDLESS-STAIR \FALSE
	EQUAL? PRSA,V?KULCAD \FALSE
	CALL STAIR-DISPEL >STACK
	RSTACK

	.FUNCT STAIR-DISPEL
	CALL QUEUE,I-HUNGER,0
	CALL QUEUE,I-THIRST,0
	CALL QUEUE,I-TIRED,0
	CALL QUEUE,I-TURTLE,0
	SET 'STAIR-SOLVED?,1
	ADD SCORE,STAIR-POINT >SCORE
	SET 'STAIR-POINT,0
	CALL DESTROY-ALL,WINNER,REAL-STAIR >DROPPED-SOME?
	MOVE FLY-SCROLL,WINNER
	PRINTI "The stairway begins to dissolve before your eyes, leaving a circular area with exits east and west, but remarkable mainly for its absence of a floor. Indeed, you find yourself standing in midair above a deep pit with the sort of comical look which is found mainly among duped cartoon characters. Frantically, you grab for the solid bannister"
	ZERO? DROPPED-SOME? /?L3
	PRINTI ", dropping your heavier possessions in your desire to save yourself"
?L3:	PRINTI "! But the bannister shifts and dissolves as well, leaving you grasping what appears to be an ornate scroll."
	CRLF
	CALL THIS-IS-IT,FLY-SCROLL
	CALL QUEUE,I-FALL-FOREVER,5 >STACK
	PUT STACK,0,1
	CALL QUEUE,I-FALL,-1 >STACK
	PUT STACK,0,1
	CALL INT,I-TIRED >STACK
	PUT STACK,0,0
	CALL GOTO,REAL-STAIR,0
	RTRUE

	.FUNCT ENDLESS-UP
	CALL ENDLESS-UP-DOWN,1
	RETURN ENDLESS-STAIR

	.FUNCT ENDLESS-DOWN
	CALL ENDLESS-UP-DOWN,0
	RETURN ENDLESS-STAIR

	.FUNCT ENDLESS-UP-DOWN,UP?
	FCLEAR ENDLESS-STAIR,TOUCHBIT
	CALL STAIR-TO-TABLE,STAIR-LOC
	PRINTI "You "
	ZERO? UP? /?L3
	PRINTI "climb"
	INC 'STAIR-LOC
	JUMP ?L7
?L3:	PRINTI "descend"
	DEC 'STAIR-LOC
?L7:	PRINTI " the stairs, making one circuit of the tower."
	CRLF
	CALL TABLE-TO-STAIR,STAIR-LOC >STACK
	RSTACK

	.FUNCT ENDLESS-STAIR-F,RARG
	EQUAL? RARG,M-LOOK \?L1
	PRINTI "This is a winding stair, stretching up and down out of sight. The walls are mossy and damp."
	EQUAL? STAIR-LOC,STAIR-START \?L5
	PRINTI " An exit leads west to a landing."
?L5:	CRLF
	RTRUE
?L1:	EQUAL? RARG,M-ENTER \FALSE
	EQUAL? WINNER,PLAYER /FALSE
	LOC PLAYER >STACK
	IN? WINNER,STACK /FALSE
	REMOVE WINNER
	SET 'P-CONT,0
	SET 'QUOTE-FLAG,0
	RFALSE

	.FUNCT ENDLESS-EXIT-F
	EQUAL? STAIR-LOC,STAIR-START \?L1
	RETURN LANDING
?L1:	PRINTI "You can't go that way."
	CRLF
	RFALSE

	.FUNCT STAIR-TO-TABLE,SLOC,TBL,CNT=0,F,N
	FIRST? ENDLESS-STAIR >F /?L1
?L1:	SET 'TBL,STAIR-TABLE
?L2:	ZERO? F /TRUE
	NEXT? F >N /?L7
?L7:	EQUAL? F,WINNER /?L12
	FSET? F,TAKEBIT \?L12
?L11:	GET TBL,CNT >STACK
	ZERO? STACK \?L13
	PUT TBL,CNT,SLOC
	ADD CNT,1 >STACK
	PUT TBL,STACK,F
	ADD CNT,2 >CNT
	REMOVE F
	JUMP ?L12
?L13:	ADD CNT,2 >CNT
	JUMP ?L11
?L12:	SET 'F,N
	JUMP ?L2

	.FUNCT TABLE-TO-STAIR,SLOC,TBL,CNT=0
	SET 'TBL,STAIR-TABLE
?L1:	LESS? CNT,STAIR-TABLE-LENGTH \TRUE
	GET TBL,CNT >STACK
	EQUAL? STACK,SLOC \?L5
	PUT TBL,CNT,0
	ADD CNT,1 >STACK
	GET TBL,STACK >STACK
	MOVE STACK,ENDLESS-STAIR
?L5:	ADD CNT,2 >CNT
	JUMP ?L1

	.FUNCT REAL-STAIR-EXIT-F
	SET 'FALL-COUNT,0
	ZERO? FLYING? /?L1
	PRINTI "Effortlessly, you float "
	EQUAL? PRSO,P?DOWN \?L5
	SET 'FALL-COUNT,1
	PRINTI "downward."
	CRLF
	CALL DESTROY-ALL,HERE,PIT
	RETURN PIT
?L5:	EQUAL? PRSO,P?EAST \?L9
	ADD SCORE,FLY-POINT >SCORE
	SET 'FLY-POINT,0
	CALL STOP-FLYING
	PRINTI "eastward and settle to the ground."
	CRLF
	RETURN WARLOCK-TOWER
?L9:	EQUAL? PRSO,P?WEST \FALSE
	CALL STOP-FLYING
	PRINTI "westward and settle to the ground."
	CRLF
	RETURN LANDING
?L1:	PRINTI "You must think you can fly."
	CRLF
	RFALSE

	.FUNCT PIT-EXIT-F
	ZERO? FLYING? /?L1
	PRINTI "Effortlessly, you float "
	EQUAL? PRSO,P?DOWN \?L5
	INC 'FALL-COUNT
	PRINTI "downward."
	CRLF
	JUMP ?L9
?L5:	DEC 'FALL-COUNT
	PRINTI "upward."
	CRLF
?L9:	ZERO? FALL-COUNT \?L12
	CALL DESTROY-ALL,HERE,REAL-STAIR
	RETURN REAL-STAIR
?L12:	CALL DESTROY-ALL,HERE,PIT
	FCLEAR PIT,TOUCHBIT
	RETURN PIT
?L1:	PRINTI "You must think you can fly."
	CRLF
	RFALSE

	.FUNCT PIT-F,RARG
	EQUAL? RARG,M-BEG \FALSE
	EQUAL? PRSA,V?DROP \?L3
	CALL HELD?,PRSO >STACK
	ZERO? STACK /?L3
	FSET PRSO,NDESCBIT
	FCLEAR PRSO,TAKEBIT
	PRINTI "The "
	PRINTD PRSO
	PRINTR " falls out of sight below you."
?L3:	EQUAL? PRSA,V?EXAMINE,V?TAKE \FALSE
	CALL HELD?,PRSO >STACK
	ZERO? STACK \FALSE
	PRINTI "The "
	PRINTD PRSO
	PRINTR " is out of reach below you."

	.FUNCT STOP-FLYING
	SET 'FLYING?,0
	CALL QUEUE,I-FALL,0
	CALL QUEUE,I-FALL-FOREVER,0
	CALL QUEUE,I-FLY,0
	RTRUE

	.FUNCT I-FALL
	ZERO? FLYING? \TRUE
	INC 'FALL-COUNT
	PRINTI "You plummet downward, deeper into the pit, but the bottom is still not visible."
	ZERO? DROPPED-SOME? /TRUE
	PRINTR " Far ahead of you fall your former possessions."

	.FUNCT I-FALL-FOREVER
	PRINTI "You plummet deeper and deeper into the pit! Oddly enough, you never seem to hit bottom. After many years, only tattered remnants of you remain, still falling."
	CRLF
	CALL PRINT-ID,STR?65
	CALL FINISH >STACK
	RSTACK

	.FUNCT DESTROY-ALL,WHO,WHERE,N,X,DEST?=0
	FIRST? WHO >X /?L4
	RETURN DEST?
?L1:	ZERO? X \?L4
	RETURN DEST?
?L4:	NEXT? X >N /?L7
?L7:	EQUAL? X,WINNER /?L8
	GETP X,P?SIZE >STACK
	GRTR? STACK,4 \?L8
	CALL REMOVE-ALL,X
	MOVE X,WHERE
	FSET X,NDESCBIT
	FCLEAR X,TAKEBIT
	SET 'DEST?,1
?L8:	SET 'X,N
	JUMP ?L1

	.FUNCT REMOVE-ALL,WHAT,N,X
	FIRST? WHAT >X /?L4
	RTRUE
?L1:	ZERO? X /TRUE
?L4:	NEXT? X >N /?L7
?L7:	REMOVE X
	SET 'X,N
	JUMP ?L1

	.FUNCT WARLOCK-TOWER-F,RARG
	EQUAL? RARG,M-ENTER \FALSE
	FSET WARLOCK-TOWER,TOUCHBIT
	PRINTI "As you enter, you realize that this is Krill's secret chamber, protected by powerful illusions now broken by your skills. Before you stands Krill, engaged in the casting of some complex and horrific magic. Krill turns to face you, surprised and annoyed by your intrusion. You have seen him before: cloaked in black, he sacrificed you at the Altar before his hoard. His yellow eyes glisten and he breathes deeply. In a voice as deep as the great caverns of the earth, he speaks: ""Fool! Parlor magician! You dare to defile my chamber with your worm-like presence. I shall not waste words with you. Goodbye, spell-monger!"""
	EQUAL? HASTED?,PLAYER \?L5
	PRINTI " He pauses. ""Ah! You seem to be in a hurry, campfire-conjurer! Slow down and enjoy the show!"" He waves his hand, and you are robbed of your energy."
?L5:	PRINTI " Krill snaps his fingers loudly, and a giant dragon appears, breathing gouts of flame. He moves ever closer, red eyes bulging with malice!"
	CRLF
	CRLF
	MOVE DRAGON,HERE
	CALL QUEUE,I-DRAGON,2 >STACK
	PUT STACK,0,1
	RTRUE

	.FUNCT GLOBAL-KRILL-F
	EQUAL? PRSA,V?GIVE,V?HELLO,V?GUNCHO \?L1
	PRINTR "Krill is not here, and lucky for you."
?L1:	EQUAL? PRSA,V?ZIFMIA \?L5
	CALL PRINT-ID,STR?66
	CALL JIGS-UP,STR?67,0 >STACK
	RSTACK
?L5:	EQUAL? PRSA,V?WHO,V?EXAMINE \?L6
	PRINTR "Krill is an evil warlock who was banished from the Circle of Enchanters. His malice was thought to be forever ended, his reign of terror a dim and frightful memory. But he has returned, and his power must be destroyed lest the Circle's great works be overthrown."
?L6:	CALL GLOBAL-NOT-HERE-PRINT,GLOBAL-KRILL
	RTRUE

	.FUNCT DRAGON-F
	EQUAL? PRSA,V?GONDAR \?L1
	PRINTI "The dragon's flame is doused in a torrent of water as you cast the gondar spell! He disappears with a torturous scream."
	CALL PRINT-ID,STR?68
	REMOVE DRAGON
	CALL SECOND-ACT >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?NITFOL,V?VAXUM \?L5
	PRINTI "The dragon pauses and roars out a benevolent greeting, which, to your chagrin, fries you to a delicate crisp."
	CRLF
	CALL PRINT-ID,STR?69
	CALL FINISH >STACK
	RSTACK
?L5:	EQUAL? PRSA,V?GUNCHO \?L8
	PRINTI "Unfortunately, the dragon is practically on top of you, and before you can finish saying the guncho spell he blasts you to beyond well-done."
	CRLF
	CALL PRINT-ID,STR?70
	CALL FINISH >STACK
	RSTACK
?L8:	EQUAL? PRSA,V?CLEESH \?L11
	PRINTR "The dragon, being reptilian himself, is unaffected."
?L11:	EQUAL? PRSA,V?MUNG,V?ATTACK,V?KILL \FALSE
	PRINTI "Your strength isn't nearly enough to best the dragon!"
	CRLF
	CALL PRINT-ID,STR?71 >STACK
	RSTACK

	.FUNCT SECOND-ACT,GUNCH=0
	CRLF
	PRINTI "Krill "
	ZERO? GUNCH /?L3
	PRINTI "seems shaken, but regains his composure."
	JUMP ?L7
?L3:	PRINTI "seems to be somewhat amused."
?L7:	CRLF
	CRLF
	PRINTI """A fine spell, wizard-worm, but your luck has ended!"" With another snap of his fingers, he summons a being whose essence is evil. It has a shape which is masked by its blackness and exudes a foul, fetid odor. In its hand is a large battle axe. At a signal from Krill, it advances!"
	CRLF
	CALL QUEUE,I-SHAPE,2 >STACK
	PUT STACK,0,1
	MOVE SHAPE,HERE
	RTRUE

	.FUNCT I-DRAGON
	IN? DRAGON,HERE \?L1
	EQUAL? DEATH-CHEATED,ME /?L5
	ZERO? PROTECTED-FROM-EVIL /?L3
?L5:	PRINT NO-LONGER-PROTECTED
	CRLF
?L3:	PRINTI "The dragon engulfs you in flame. As you perish, you can hear Krill's mocking laughter."
	CRLF
	CALL PRINT-ID,STR?72
	CALL FINISH
?L1:	CALL QUEUE,I-DRAGON,0
	RTRUE

	.FUNCT SHAPE-F
	EQUAL? PRSA,V?VAXUM \?L1
	PRINTI "The monster hesitates, stops, smiles, and disappears."
	CRLF
	CALL THIRD-ACT >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?CLEESH \?L5
	PRINTI "The monster hesitates, trembles, then turns into a newt. Poor monster. Its battle axe, now unsupported, falls on it, slicing it neatly in half."
	CRLF
	CALL PRINT-ID,STR?73
	CALL THIRD-ACT >STACK
	RSTACK
?L5:	EQUAL? PRSA,V?NITFOL \?L8
	PRINTI """Yum, yum!"" are the last words you hear."
	CRLF
	CALL PRINT-ID,STR?74
	CALL FINISH >STACK
	RSTACK
?L8:	EQUAL? PRSA,V?GUNCHO \?L11
	PRINTI "The monster pauses for a moment as you begin the guncho spell, then swiftly cleaves you with its axe before you can finish!"
	CRLF
	CALL PRINT-ID,STR?75
	CALL FINISH >STACK
	RSTACK
?L11:	EQUAL? PRSA,V?MUNG,V?ATTACK,V?KILL \FALSE
	PRINTI "Your effort is useless. It is still coming closer!"
	CRLF
	CALL PRINT-ID,STR?76 >STACK
	RSTACK

	.FUNCT THIRD-ACT
	REMOVE SHAPE
	CRLF
	PRINTI "Krill seems to be losing patience.

""I am through playing games, carnival-clown! You shall return to your Circle, but I am afraid that all the little pieces will prove hard to reassemble!"" He laughs hideously and starts a guttural chant which shakes the very tower."
	CRLF
	SET 'KRILL-KILL,1
	CALL QUEUE,I-BYE,2 >STACK
	PUT STACK,0,1
	RTRUE

	.FUNCT I-SHAPE
	IN? SHAPE,HERE \?L1
	EQUAL? DEATH-CHEATED,ME /?L5
	ZERO? PROTECTED-FROM-EVIL /?L3
?L5:	PRINT NO-LONGER-PROTECTED
	CRLF
?L3:	PRINTI "The monster hits you with its battle axe! You fall, dead, as the laughter of Krill reaches a crescendo!"
	CRLF
	CALL PRINT-ID,STR?77
	CALL FINISH
?L1:	CALL QUEUE,I-SHAPE,0
	RTRUE

	.FUNCT I-BYE
	EQUAL? HERE,WARLOCK-TOWER \FALSE
	CRLF
	PRINTI "Krill finishes his spell and his harsh laughter is all that remains! You are in a void, without sight, sound, or sensation. You scream at the top of your lungs, but nothing happens. You break into a cold sweat as you ponder the infinite, beyond all help and hope!"
	CRLF
	CALL PRINT-ID,STR?78
	CALL FINISH >STACK
	RSTACK

	.FUNCT KRILL-F
	EQUAL? PRSA,V?EXAMINE \?L1
	PRINTR "Krill is not a pretty sight! Enough said."
?L1:	EQUAL? PRSA,V?GUNCHO \?L5
	ZERO? KRILL-KILL /?L5
	PRINTI "Krill recoils as he hears the first words of the guncho spell. For a few seconds he continues with the spell he was casting, trying to finish before you. He fumbles some syllables! Then he steps back and, with his hands outstretched toward you, lets out a bloodcurdling scream. His face twisted, and his body vibrating with the effort of resisting the enchantment, he utters a spell of power, and is gone! After a quiet moment, a rumble begins deep in the earth. It strengthens as the tower starts to sway. The floor gives way beneath you and you tumble down towards the sea ... then you are surrounded by a burst of light.

You realize that you are with the Circle. The Eldest of the Circle, Belboz, rises and speaks: ""The evil of Krill is ended this day. From beyond hope, you have proved yourself great and worthy. Our hearts are gladdened at your return."" A chair appears at his right hand and he motions for you to sit beside him. He smiles warmly. ""Join with us,"" he says, ""and tell us of your quest!""

Here ends the first chapter of the Enchanter saga, in which, by virtue of your skills, you have joined the Circle of Enchanters. Further adventures await you as the Enchanter series continues."
	CRLF
	CRLF
	CALL PRINT-ID,STR?79
	ADD SCORE,WARLOCK-POINT >SCORE
	USL
	CALL FINISH >STACK
	RSTACK
?L5:	EQUAL? PRSA,V?CLEESH \?L8
	PRINTR "Krill shimmers for a moment, then laughs heartily. The laugh sounds vaguely like a croak, but perhaps it is only your imagination."
?L8:	EQUAL? PRSA,V?VAXUM \?L11
	PRINTR "The spell seems to have no influence over Krill. You wouldn't much like to see him smile, anyway."
?L11:	EQUAL? PRSA,V?GUNCHO \?L14
	PRINTI "The look of surprise on Krill's face as you recite the first few syllables of the guncho spell is exceeded only by your look of disappointment as you are "
	IN? SHAPE,HERE \?L17
	PUSH STR?80
	JUMP ?L19
?L17:	PUSH STR?81
?L19:	PRINT STACK
	CRLF
	CALL PRINT-ID,STR?82
	CALL FINISH >STACK
	RSTACK
?L14:	EQUAL? PRSA,V?HELLO \FALSE
	PRINTR "Krill grins and the sight is ghastly."

	.FUNCT I-MUNG-ROOM,TELL?=1,RM,TBL
	CALL QUEUE,I-MUNG-ROOM,20 >STACK
	PUT STACK,0,1
	SET 'TBL,MUNG-ROOM-TABLE
?L1:	GET TBL,0 >RM
	ZERO? RM /?L11
	FSET? RM,RMUNGBIT \?L2
	ADD TBL,2 >TBL
	JUMP ?L1
?L2:	ZERO? RM /?L11
	FSET RM,RMUNGBIT
	FCLEAR RM,TOUCHBIT
	ZERO? TELL? /?L11
	EQUAL? RM,HERE \?L11
	PRINTI "Suddenly, you sense a great wind of evil magic blowing around you. You are weighed down by its power, and only your sorcerous training permits you to withstand it. When you regain your composure, your surroundings have changed."
	CRLF
?L11:	RETURN RM

	.FUNCT V-SPELLS,CNT,S,ANY=0,OS=0,TMP
	GET ALL-SPELLS,0 >CNT
	PRINTI "The gnusto spell, the only thing you seem to have learned well after many years at the University, remains yours forever. Other than that, you have "
?L3:	ZERO? CNT \?L5
	ZERO? OS /?L7
	CALL SPELL-PRINT,OS,ANY,1
	SET 'ANY,1
?L7:	ZERO? ANY \?L10
	PRINTR "no spells memorized."
?L10:	PRINTR " committed to memory."
?L5:	GET ALL-SPELLS,CNT >STACK
	CALL SPELL-TIMES,STACK >TMP
	ZERO? TMP /?L18
	ZERO? OS /?L20
	CALL SPELL-PRINT,OS,ANY
	SET 'ANY,1
?L20:	SET 'OS,TMP
?L18:	DEC 'CNT
	JUMP ?L3

	.FUNCT SPELL-TIMES,S
	GETP S,P?COUNT >STACK
	GRTR? STACK,0 \FALSE
	IN? S,SPELL-BOOK \?L3
	RETURN S
?L3:	EQUAL? S,DISPEL-SPELL \?L5
	IN? DISPEL-SPELL,DISPEL-SCROLL /?L5
	RETURN S
?L5:	EQUAL? S,BANISH-SPELL \FALSE
	IN? BANISH-SPELL,BANISH-SCROLL /FALSE
	RETURN S

	.FUNCT SPELL-PRINT,S,ANY,PAND?=0,CNT
	ZERO? ANY /?L7
	ZERO? PAND? /?L3
	PRINTI " and "
	JUMP ?L7
?L3:	PRINTI ", "
?L7:	PRINTI "the "
	PRINTD S
	GETP S,P?COUNT >CNT
	GRTR? CNT,5 \?L13
	PRINTI " many times"
	RETURN S
?L13:	PRINTI " "
	SUB CNT,1 >STACK
	GET COUNTERS,STACK >STACK
	PRINT STACK
	RETURN S

	.FUNCT SPELL-BOOK-F,F
	FIRST? SPELL-BOOK >F /?L1
?L1:	EQUAL? PRSA,V?EXAMINE \?L2
	PRINTR "The title is ""My Spell Book"". The book looks pretty new, and it doesn't seem to have much written in it yet. There are some spells written in the book in glowing letters, with marginal notes about how to cast them and what their effects are."
?L2:	EQUAL? PRSA,V?CLOSE,V?OPEN \?L6
	PRINTR "Thanks to its magic properties, the spell book is always open to the right place at the right time, but it is also always closed. This innovation eliminates tedious page turning and hunting for spells in tight situations. Many wizardly lives have been saved by this small advance in magical technology."
?L6:	EQUAL? PRSA,V?READ \FALSE
	ZERO? LIT \?L10
	PRINTI "Though it is dark, the magic writing of your spells casts enough light that you can read them."
	CRLF
?L10:	PRINTI "
My Spell Book

"
	ZERO? F /TRUE
?L19:	PRINTI "The "
	PRINTD F
	PRINTI " ("
	GETP F,P?TEXT >STACK
	PRINT STACK
	PRINTI ")."
	CRLF
	NEXT? F >F /?L19
	RTRUE

	.FUNCT SPELL-CHECK,TBL,WRD,OBJ=0
	EQUAL? WRD,W?GNUSTO \?L1
	SET 'OBJ,WRITE-MAGIC-SPELL
	JUMP ?L18
?L1:	EQUAL? WRD,W?FROTZ \?L3
	SET 'OBJ,LIGHT-SPELL
	JUMP ?L18
?L3:	EQUAL? WRD,W?OZMOO \?L4
	SET 'OBJ,CHEAT-DEATH-SPELL
	JUMP ?L18
?L4:	EQUAL? WRD,W?ZIFMIA \?L5
	SET 'OBJ,SUMMON-SPELL
	JUMP ?L18
?L5:	EQUAL? WRD,W?VAXUM \?L6
	SET 'OBJ,CHARM-SPELL
	JUMP ?L18
?L6:	EQUAL? WRD,W?REZROV \?L7
	SET 'OBJ,OPEN-SPELL
	JUMP ?L18
?L7:	EQUAL? WRD,W?NITFOL \?L8
	SET 'OBJ,TALK-TO-ANIMALS-SPELL
	JUMP ?L18
?L8:	EQUAL? WRD,W?EXEX \?L9
	SET 'OBJ,HASTE-SPELL
	JUMP ?L18
?L9:	EQUAL? WRD,W?KULCAD \?L10
	SET 'OBJ,DISPEL-SPELL
	JUMP ?L18
?L10:	EQUAL? WRD,W?MELBOR \?L11
	SET 'OBJ,PROTECTION-SPELL
	JUMP ?L18
?L11:	EQUAL? WRD,W?BLORB \?L12
	SET 'OBJ,STRONG-BOX-SPELL
	JUMP ?L18
?L12:	EQUAL? WRD,W?GUNCHO \?L13
	SET 'OBJ,BANISH-SPELL
	JUMP ?L18
?L13:	EQUAL? WRD,W?KREBF \?L14
	SET 'OBJ,REPAIR-SPELL
	JUMP ?L18
?L14:	EQUAL? WRD,W?CLEESH \?L15
	SET 'OBJ,NEWT-SPELL
	JUMP ?L18
?L15:	EQUAL? WRD,W?IZYUK \?L16
	SET 'OBJ,FLY-SPELL
	JUMP ?L18
?L16:	EQUAL? WRD,W?GONDAR \?L17
	SET 'OBJ,QUENCH-SPELL
	JUMP ?L18
?L17:	EQUAL? WRD,W?FILFRE \?L18
	SET 'OBJ,CREDITS-SPELL
?L18:	ZERO? OBJ /TRUE
	CALL OBJ-FOUND,OBJ,TBL
	RTRUE

	.FUNCT PRE-QUICK-CAST,MEM?,SPELL,SCROLL
	EQUAL? PRSA,V?GNUSTO \?L1
	SET 'SPELL,WRITE-MAGIC-SPELL
	JUMP ?L19
?L1:	EQUAL? PRSA,V?FROTZ \?L3
	SET 'SPELL,LIGHT-SPELL
	JUMP ?L19
?L3:	EQUAL? PRSA,V?OZMOO \?L4
	SET 'SPELL,CHEAT-DEATH-SPELL
	JUMP ?L19
?L4:	EQUAL? PRSA,V?ZIFMIA \?L5
	SET 'SPELL,SUMMON-SPELL
	JUMP ?L19
?L5:	EQUAL? PRSA,V?VAXUM \?L6
	SET 'SPELL,CHARM-SPELL
	JUMP ?L19
?L6:	EQUAL? PRSA,V?REZROV \?L7
	SET 'SPELL,OPEN-SPELL
	JUMP ?L19
?L7:	EQUAL? PRSA,V?NITFOL \?L8
	SET 'SPELL,TALK-TO-ANIMALS-SPELL
	JUMP ?L19
?L8:	EQUAL? PRSA,V?EXEX \?L9
	SET 'SPELL,HASTE-SPELL
	JUMP ?L19
?L9:	EQUAL? PRSA,V?KULCAD \?L10
	SET 'SPELL,DISPEL-SPELL
	JUMP ?L19
?L10:	EQUAL? PRSA,V?MELBOR \?L11
	SET 'SPELL,PROTECTION-SPELL
	JUMP ?L19
?L11:	EQUAL? PRSA,V?BLORB \?L12
	SET 'SPELL,STRONG-BOX-SPELL
	JUMP ?L19
?L12:	EQUAL? PRSA,V?GUNCHO \?L13
	SET 'SPELL,BANISH-SPELL
	JUMP ?L19
?L13:	EQUAL? PRSA,V?GONDAR \?L14
	SET 'SPELL,QUENCH-SPELL
	JUMP ?L19
?L14:	EQUAL? PRSA,V?KREBF \?L15
	SET 'SPELL,REPAIR-SPELL
	JUMP ?L19
?L15:	EQUAL? PRSA,V?CLEESH \?L16
	SET 'SPELL,NEWT-SPELL
	JUMP ?L19
?L16:	EQUAL? PRSA,V?IZYUK \?L17
	SET 'SPELL,FLY-SPELL
	JUMP ?L19
?L17:	EQUAL? PRSA,V?FILFRE \?L18
	SET 'SPELL,CREDITS-SPELL
	JUMP ?L19
?L18:	PRINTR "**OOOPS!**"
?L19:	FSET? SPELL,RMUNGBIT \?L22
	PRINTR "The spell is defaced beyond recognition."
?L22:	LOC SPELL >SCROLL
	ZERO? SCROLL /?L40
	FSET? SCROLL,SCROLLBIT \?L40
	IN? SCROLL,WINNER \?L29
	REMOVE SCROLL
	EQUAL? PRSO,KRILL /?L31
	PRINTI "As you cast the spell, the "
	PRINTD SCROLL
	PRINTI " vanishes!"
	CRLF
?L31:	PUTP SPELL,P?COUNT,1
	JUMP ?L40
?L29:	FSET? SPELL,TOUCHBIT /?L37
	IN? SCROLL,HERE \?L36
?L37:	PRINTI "You don't have the "
	PRINTD SPELL
	PRINTR " memorized, nor do you have the scroll on which it is written."
?L36:	PRINTI "The "
	PRINTD SPELL
	PRINTR " is not committed to memory, and you haven't seen any scroll on which it is written."
?L40:	GETP SPELL,P?COUNT >MEM?
	EQUAL? SPELL,WRITE-MAGIC-SPELL /FALSE
	GRTR? MEM?,0 /?L46
	PRINTI "You don't have the "
	PRINTD SPELL
	PRINTR " committed to memory!"
?L46:	SUB MEM?,1 >STACK
	PUTP SPELL,P?COUNT,STACK
	INC 'SPELL-ROOM
	EQUAL? PRSA,V?GUNCHO,V?KULCAD \FALSE
	CALL QUEUE,MORE-PROBE,1 >STACK
	PUT STACK,0,1
	RFALSE

	.FUNCT SCROLL-F,SPELL
	EQUAL? PRSA,V?TAKE \?L1
	FIRST? PRSO >SPELL /?L3
?L3:	FSET SPELL,TOUCHBIT
	RFALSE
?L1:	EQUAL? PRSA,V?CUT \?L4
	EQUAL? PRSI,MAGIC-KNIFE \?L4
	REMOVE PRSO
	PRINTR "The magic dagger reduces the scroll to shreds. The shreds shrivel up into tiny spitballs. The spitballs evaporate."
?L4:	EQUAL? PRSA,V?BURN \?L7
	EQUAL? PRSI,ETERNAL-FLAME \?L7
	REMOVE PRSO
	PRINTI "The "
	PRINTD PRSO
	PRINTR " burns cheerily. Interestingly, the flame is sort of purple and rather bright. Not even ashes remain."
?L7:	EQUAL? PRSA,V?READ,V?EXAMINE \FALSE
	FIRST? PRSO >SPELL \?L11
	FSET? SPELL,RMUNGBIT \?L13
	PRINTR "The scroll is defaced. The spell on it cannot be read."
?L13:	PRINTI "The scroll reads """
	PRINTD SPELL
	PRINTI ": "
	GETP SPELL,P?TEXT >STACK
	PRINT STACK
	PRINTI """."
	EQUAL? SPELL,BANISH-SPELL,DISPEL-SPELL \?L20
	PRINTI " The spell seems very long and extremely complicated."
?L20:	CRLF
	RTRUE
?L11:	PRINTR "Nothing useful can be made out on the scroll."

	.FUNCT SPELL-F,MEM?,FORGET=0
	EQUAL? PRSA,V?READ \?L1
	IN? PRSO,SPELL-BOOK /FALSE
	LOC PRSO >STACK
	IN? STACK,WINNER /FALSE
	PRINTR "You can't do that without having the spell in your book or on a scroll in your hand."
?L1:	EQUAL? PRSA,V?LEARN,V?MEMORIZE \?L8
	IN? PRSO,SPELL-BOOK /?L9
	LOC PRSO >STACK
	IN? STACK,WINNER \?L11
	PRINTR "You haven't written that spell into your book yet. Until you do, you can't memorize the spell."
?L11:	CALL V-LEARN >STACK
	RSTACK
?L9:	IN? SPELL-BOOK,WINNER /?L16
	PRINTR "You don't have your spell book. How do you expect to memorize a spell without a spell book?"
?L16:	EQUAL? PRSO,WRITE-MAGIC-SPELL \?L19
	PRINTR "You already know that spell by heart."
?L19:	ZERO? LIT \?L22
	PRINTR "It will be hard to learn that spell in the dark."
?L22:	GETP PRSO,P?COUNT >MEM?
	ZERO? SPELL-ROOM \?L26
	EQUAL? SPELL-MAX,1 \?L28
	PRINTR "You can't concentrate well enough to learn the spell."
?L28:	EQUAL? MEM?,SPELL-MAX /?L34
	CALL FORGET-SPELL,PRSO
	INC 'MEM?
	PUTP PRSO,P?COUNT,MEM?
	SET 'FORGET,1
	JUMP ?L34
?L26:	DEC 'SPELL-ROOM
	INC 'MEM?
	PUTP PRSO,P?COUNT,MEM?
?L34:	PRINTI "Using your best study habits, you learn the "
	PRINTD PRSO
	GRTR? MEM?,1 \?L37
	PRINTI " yet another time"
?L37:	PRINTI "."
	CRLF
	ZERO? FORGET /TRUE
	PRINTR "You have so much buzzing around in your head, though, that it's likely that something may have been forgotten in the shuffle."
?L8:	EQUAL? PRSA,V?DROP,V?TAKE \FALSE
	CALL PICK-ONE,YUKS >STACK
	PRINT STACK
	CRLF
	RTRUE

	.FUNCT FORGET-SPELL,SPL,NSPL,F,CNT,TBL,NUM=0,SP=0
	FIRST? SPELL-BOOK >F /?L1
?L1:	SET 'TBL,FORGET-TBL
	ZERO? F /?L3
?L4:	GETP F,P?COUNT >CNT
	GRTR? CNT,0 \?L8
?L7:	SET 'SP,F
	PUT TBL,1,F
	INC 'NUM
	ADD TBL,2 >TBL
	DLESS? 'CNT,1 \?L7
?L8:	NEXT? F >F /?L4
?L3:	GRTR? NUM,0 \?L14
	GETP SP,P?COUNT >STACK
	EQUAL? STACK,NUM \?L14
	SUB NUM,1 >STACK
	PUTP SP,P?COUNT,STACK
	RTRUE
?L14:	PUT FORGET-TBL,0,NUM
	ZERO? NUM /TRUE
?L17:	CALL RANDOM-ELEMENT,FORGET-TBL >NSPL
	EQUAL? NSPL,SPL /?L17
	GETP NSPL,P?COUNT >STACK
	DEC 'STACK
	PUTP NSPL,P?COUNT,STACK
	RTRUE

	.FUNCT FORGET-ALL,F
	SET 'SPELL-ROOM,SPELL-MAX
	FIRST? SPELL-BOOK >F \TRUE
?L4:	PUTP F,P?COUNT,0
	NEXT? F >F /?L4
	RTRUE

	.FUNCT V-CAST,VRB
	FSET? PRSO,SPELLBIT /?L1
	PRINTI "You might as well be casting with a fly rod, as to try to cast "
	CALL PRINTA,PRSO
	PRINTR "."
?L1:	EQUAL? PRSO,WRITE-MAGIC-SPELL \?L6
	SET 'VRB,V?GNUSTO
	JUMP ?L24
?L6:	EQUAL? PRSO,LIGHT-SPELL \?L8
	SET 'VRB,V?FROTZ
	JUMP ?L24
?L8:	EQUAL? PRSO,CHEAT-DEATH-SPELL \?L9
	SET 'VRB,V?OZMOO
	JUMP ?L24
?L9:	EQUAL? PRSO,SUMMON-SPELL \?L10
	SET 'VRB,V?ZIFMIA
	JUMP ?L24
?L10:	EQUAL? PRSO,CHARM-SPELL \?L11
	SET 'VRB,V?VAXUM
	JUMP ?L24
?L11:	EQUAL? PRSO,OPEN-SPELL \?L12
	SET 'VRB,V?REZROV
	JUMP ?L24
?L12:	EQUAL? PRSO,TALK-TO-ANIMALS-SPELL \?L13
	SET 'VRB,V?NITFOL
	JUMP ?L24
?L13:	EQUAL? PRSO,HASTE-SPELL \?L14
	SET 'VRB,V?EXEX
	JUMP ?L24
?L14:	EQUAL? PRSO,DISPEL-SPELL \?L15
	SET 'VRB,V?KULCAD
	JUMP ?L24
?L15:	EQUAL? PRSO,PROTECTION-SPELL \?L16
	SET 'VRB,V?MELBOR
	JUMP ?L24
?L16:	EQUAL? PRSO,STRONG-BOX-SPELL \?L17
	SET 'VRB,V?BLORB
	JUMP ?L24
?L17:	EQUAL? PRSO,BANISH-SPELL \?L18
	SET 'VRB,V?GUNCHO
	JUMP ?L24
?L18:	EQUAL? PRSO,QUENCH-SPELL \?L19
	SET 'VRB,V?GONDAR
	JUMP ?L24
?L19:	EQUAL? PRSO,REPAIR-SPELL \?L20
	SET 'VRB,V?KREBF
	JUMP ?L24
?L20:	EQUAL? PRSO,NEWT-SPELL \?L21
	SET 'VRB,V?CLEESH
	JUMP ?L24
?L21:	EQUAL? PRSO,FLY-SPELL \?L22
	SET 'VRB,V?IZYUK
	JUMP ?L24
?L22:	EQUAL? PRSO,CREDITS-SPELL \?L23
	SET 'VRB,V?FILFRE
	JUMP ?L24
?L23:	PRINTR "**OOPS**"
?L24:	ZERO? PRSI \?L29
	EQUAL? VRB,V?KREBF,V?FILFRE \?L27
	CALL PERFORM,VRB
	RTRUE
?L27:	ZERO? PRSI \?L29
	PRINTR "You might as well be casting it away as not cast it on something."
?L29:	CALL PERFORM,VRB,PRSI
	RTRUE

	.FUNCT V-LEARN
	PRINTR "You don't have that spell, if indeed that is a spell."

	.FUNCT V-MEMORIZE
	CALL V-LEARN >STACK
	RSTACK

	.FUNCT V-GNUSTO,SCROLL
	IN? SPELL-BOOK,WINNER /?L1
	PRINTR "The spell quests around in your hands, looking for your spell book, and not finding it, fades reluctantly."
?L1:	FSET? PRSO,SPELLBIT /?L5
	PRINTI "You can't inscribe "
	EQUAL? PRSO,ME \?L8
	PRINTI "yourself"
	JUMP ?L12
?L8:	CALL PRINTA,PRSO
?L12:	PRINTR " in your spell book!"
?L5:	IN? PRSO,SPELL-BOOK \?L17
	PRINTR "You already have that spell inscribed in your book!"
?L17:	FSET? PRSO,RMUNGBIT \?L20
	PRINTR "The spell is defaced beyond recognition."
?L20:	LOC PRSO >SCROLL
	FSET? SCROLL,SCROLLBIT \?L24
	CALL HELD?,SCROLL >STACK
	ZERO? STACK /?L24
	EQUAL? PRSO,DISPEL-SPELL,BANISH-SPELL,CREDITS-SPELL \?L26
	PRINTI "Your spell book begins to glow softly. In a spectacular effort of magic, the powers of the gnusto spell attempt to copy the "
	PRINTD PRSO
	PRINTI " into your book, but the spell is too long, too complicated, and too powerful. The glow fades, but fortunately the "
	PRINTD SCROLL
	PRINTI " remains intact."
	CRLF
	EQUAL? PRSO,DISPEL-SPELL,BANISH-SPELL \TRUE
	CALL MORE-PROBE,0
	RTRUE
?L26:	REMOVE SCROLL
	MOVE PRSO,SPELL-BOOK
	PUTP PRSO,P?COUNT,0
	PRINTI "Your spell book begins to glow softly. Slowly, ornately, the words of the "
	PRINTD PRSO
	PRINTR " are inscribed, glowing even more brightly than the book itself. The book's brightness fades, but the spell remains! However, the scroll on which it was written vanishes as the last word is copied."
?L24:	PRINTR "You must have a legible spell scroll in your hands before the gnusto spell will work on it."

	.FUNCT MORE-PROBE,CAST?=1
	EQUAL? HERE,PIT,REAL-STAIR,ENDLESS-STAIR /TRUE
	EQUAL? HERE,WARLOCK-TOWER /TRUE
	IGRTR? 'PROBE,3 \?L4
	PRINTI "The warlock Krill appears before you, clad in deepest black. ""You are a fool, wizard-worm! You and your Circle!"" He spits in your face, causing a wound through which a foul poison enters your body. Krill's demonic laughter is the last sound you hear."
	CRLF
	CALL FINISH >STACK
	RSTACK
?L4:	CRLF
	GET PROBE-TBL,PROBE >STACK
	PRINT STACK
	CRLF
	ZERO? CAST? \?L12
	EQUAL? PROBE,2 \?L13
	IN? KRILL,HERE /?L13
?L12:	ZERO? BELBOZ-WARNING \?L13
	SET 'BELBOZ-WARNING,1
	CRLF
	PRINTI "Belboz appears before you, hard and stern. ""While you have quested for Krill's lair, the Circle has not been idle. We have tried to shield your presence from him, but "
	ZERO? CAST? /?L17
	PRINTI "your use of such a powerful spell might endanger us all!"
	JUMP ?L21
?L17:	PRINTI "your foolish attempt to copy such a powerful spell cannot be ignored!"
?L21:	PRINTI " As we have sensed it, so surely must Krill! Be careful, brave Enchanter!"" His image fades."
	CRLF
?L13:	INC 'LOSSAGE
	RTRUE

	.FUNCT V-FROTZ,OLIT
	SET 'OLIT,LIT
	IN? PRSO,LOCAL-GLOBALS /?L1
	FSET? PRSO,TAKEBIT /?L3
	FSET? PRSO,VICBIT \?L1
?L3:	FSET PRSO,LIGHTBIT
	FSET PRSO,ONBIT
	PRINTI "There is an almost blinding flash of light as the "
	PRINTD PRSO
	PRINTI " begins to glow! It slowly fades to a less painful level, but the "
	PRINTD PRSO
	PRINTI " is now quite usable as a light source."
	CRLF
	ADD SCORE,LIGHT-POINT >SCORE
	SET 'LIGHT-POINT,0
	CALL LIT?,HERE >LIT
	ZERO? OLIT \TRUE
	ZERO? LIT /TRUE
	CRLF
	CALL PERFORM,V?LOOK
	RTRUE
?L1:	CALL V-VAXUM >STACK
	RSTACK

	.FUNCT V-OZMOO
	PRINTI "A huge puff of orange smoke envelops "
	SET 'DEATH-CHEATED,PRSO
	EQUAL? PRSO,ME \?L3
	CALL QUEUE,I-DEATH-CHEATED-END,8 >STACK
	PUT STACK,0,1
	PRINTR "you, but you feel no different."
?L3:	PRINTI "the "
	PRINTD PRSO
	PRINTR ". Other than that, not much happens."

	.FUNCT I-DEATH-CHEATED-END
	SET 'DEATH-CHEATED,0
	EQUAL? DEATH-CHEATED,ME \TRUE
	PRINTR "You feel a bit lightheaded for a moment, but the feeling quickly passes."

	.FUNCT V-ZIFMIA
	FSET? PRSO,TAKEBIT /?L3
	IN? PRSO,LOCAL-GLOBALS \?L1
?L3:	PRINTR "The zifmia spell is for summoning beings, not things!"
?L1:	FSET? PRSO,VICBIT \?L6
	IN? PRSO,HERE /?L6
	CALL NO-ZIF >STACK
	RSTACK
?L6:	CALL V-VAXUM >STACK
	RSTACK

	.FUNCT NO-ZIF
	PRINTR "If you will remember from Thaumaturgy 201, summoning of beings works only if the being can be seen, unless the being possesses great magic of his own."

	.FUNCT V-VAXUM
	PRINTR "Although you complete the spell, nothing seems to have happened."

	.FUNCT V-GONDAR
	CALL V-VAXUM >STACK
	RSTACK

	.FUNCT V-REZROV
	FSET? PRSO,CONTBIT \?L1
	FSET? PRSO,OPENBIT \?L3
	PRINTI "It's open already. Why bother?"
	CRLF
	JUMP ?L7
?L3:	PRINTI "The "
	PRINTD PRSO
	PRINTI " opens. Kind of like swatting a fly with a sledge hammer, if you ask me."
	CRLF
?L7:	FSET PRSO,OPENBIT
	RTRUE
?L1:	CALL V-VAXUM >STACK
	RSTACK

	.FUNCT I-TALK-TO-ANIMAL
	EQUAL? TALK-TO-ANIMAL?,TURTLE \?L3
	ZERO? TURTLE-FOLLOWS /?L3
	SET 'TURTLE-FOLLOWS,0
	IN? TURTLE,HERE \?L3
	PRINTI "The turtle no longer seems to understand you, loses interest in you, and stops following."
	CRLF
?L3:	SET 'TALK-TO-ANIMAL?,0
	RETURN TALK-TO-ANIMAL?

	.FUNCT V-NITFOL
	FSET? PRSO,VILLAIN \?L1
	SET 'TALK-TO-ANIMAL?,PRSO
	CALL QUEUE,I-TALK-TO-ANIMAL,20 >STACK
	PUT STACK,0,1
	EQUAL? PRSO,ME \?L3
	PRINTR "You now understand everything you say to yourself, which is more than I can do. You didn't study too hard in Thaumaturgy 101, did you? This spell should be cast on the creature you wish to talk to!"
?L3:	EQUAL? PRSO,FROG \?L8
	PRINTI "One of the frogs"
	JUMP ?L12
?L8:	PRINTI "The "
	PRINTD PRSO
?L12:	PRINTR " looks at you for a moment, and you look at it. ""Hello,"" it says."
?L1:	PRINTI "This seems to have no effect on "
	CALL PRINTA,PRSO
	PRINTR "."

	.FUNCT I-HASTE
	EQUAL? HASTED?,ME \?L1
	ADD HUNGER-COUNT,2 >HUNGER-COUNT
	CALL QUEUE,I-HUNGER,3 >STACK
	PUT STACK,0,1
	ADD THIRST-COUNT,2 >THIRST-COUNT
	CALL QUEUE,I-THIRST,4 >STACK
	PUT STACK,0,1
	CALL QUEUE,I-TIRED,5 >STACK
	PUT STACK,0,1
	PRINTI "The effects of the exex spell have worn off. You are ravenous, parched, and tired."
	CRLF
?L1:	SET 'HASTED?,0
	RETURN HASTED?

	.FUNCT V-EXEX
	ZERO? HASTED? /?L1
	PRINTR "Nothing seems to happen. Perhaps the spell needs time before it can be cast again."
?L1:	FSET? PRSO,VILLAIN \?L5
	SET 'HASTED?,PRSO
	EQUAL? PRSO,ME \?L6
	SET 'HASTED?,PLAYER
	EQUAL? HERE,WARLOCK-TOWER \?L8
	PRINTR "Krill, nobody's fool, hears you start the exex spell and hastily improvises one of his own which entirely counteracts it. The spell acts so well, in fact, that you are frozen solid."
?L8:	CALL QUEUE,I-HASTE,45 >STACK
	PUT STACK,0,1
	PRINTR "You feel energetic and zippy."
?L6:	CALL QUEUE,I-HASTE,15 >STACK
	PUT STACK,0,1
	PRINTI "The "
	PRINTD PRSO
	PRINTR " shimmers, then vibrates in place for a few seconds, but doesn't take any notice of the change."
?L5:	CALL V-VAXUM >STACK
	RSTACK

	.FUNCT V-KULCAD
	PRINTI "It appears that the "
	PRINTD PRSO
	PRINTR " was real, since nothing happens."

	.FUNCT V-MELBOR
	EQUAL? PRSO,ME \?L1
	SET 'PROTECTED-FROM-EVIL,1
	PRINTR "A wave of warmth courses through you, leaving you with a feeling of great internal strength."
?L1:	CALL V-VAXUM >STACK
	RSTACK

	.FUNCT V-BLORB,OBJ
	ZERO? STRONG-BOX-FLAG /?L1
	CALL V-VAXUM
	RTRUE
?L1:	FSET? PRSO,TAKEBIT /?L6
	EQUAL? PRSO,ADVENTURER \?L4
?L6:	EQUAL? PRSO,ADVENTURER,TURTLE \?L7
	REMOVE PRSO
	EQUAL? PRSO,ADVENTURER \?L9
	CALL QUEUE,I-ADVENTURER,0
	JUMP ?L12
?L9:	CALL QUEUE,I-TURTLE,0
	JUMP ?L12
?L7:	MOVE PRSO,STRONG-BOX
?L12:	SET 'STRONG-BOX-FLAG,1
	MOVE STRONG-BOX,HERE
	PRINTI "A glowing strong box forms out of the air, carefully enclosing the "
	PRINTD PRSO
	PRINTR ", which disappears from view. The strong box rests on the ground."
?L4:	CALL V-VAXUM >STACK
	RSTACK

	.FUNCT STRONG-BOX-F,OBJ
	EQUAL? PRSA,V?TAKE \?L1
	PRINTR "The strong box is apparently stuck to the ground, or welded there, or tied with magical ropes. It won't move."
?L1:	EQUAL? PRSA,V?KULCAD,V?REZROV,V?OPEN \FALSE
	SET 'STRONG-BOX-FLAG,0
	FIRST? STRONG-BOX >OBJ \?L6
	MOVE OBJ,HERE
	CALL THIS-IS-IT,OBJ
?L6:	REMOVE STRONG-BOX
	EQUAL? PRSA,V?OPEN \?L11
	PUSH STR?83
	JUMP ?L12
?L11:	EQUAL? PRSA,V?REZROV \?L13
	PUSH STR?84
	JUMP ?L12
?L13:	EQUAL? PRSA,V?KULCAD \?L14
	PUSH STR?85
	JUMP ?L12
?L14:	PUSH 0
?L12:	PRINT STACK
	PRINTI " the strong box, it vanishes, and "
	ZERO? OBJ /?L16
	PRINTI "the "
	PRINTD OBJ
	PRINTI " re"
	JUMP ?L20
?L16:	PRINTI "nothing "
?L20:	PRINTR "appears in its place."

	.FUNCT V-GUNCHO
	FSET? PRSO,VICBIT \?L1
	REMOVE PRSO
	PRINTI "The "
	PRINTD PRSO
	PRINTR " disappears, fading with stately speed into a misty shadow, shimmering and wavering, which then is gone."
?L1:	CALL V-VAXUM >STACK
	RSTACK

	.FUNCT V-KREBF
	ZERO? PRSO /?L3
	EQUAL? PRSO,GLOBAL-ROOM \?L1
?L3:	FSET? HERE,RMUNGBIT \?L4
	FCLEAR HERE,RMUNGBIT
	FCLEAR HERE,TOUCHBIT
	PRINTR "There is a slow brightening of the illumination, and color flows back into your surroundings. There is a touch of spring in the air."
?L4:	PRINTR "Nothing happens. Perhaps there was no damage here to repair."
?L1:	FSET? PRSO,SCROLLBIT \?L14
	FIRST? PRSO >STACK \?L14
	FIRST? PRSO >PRSO /?L14
?L14:	FSET? PRSO,RMUNGBIT /?L16
	PRINTR "Nothing happens."
?L16:	FCLEAR PRSO,RMUNGBIT
	FSET? PRSO,SPELLBIT \?L21
	PRINTI "The "
	PRINTD PRSO
	PRINTR " becomes readable again."
?L21:	PRINTR "Nothing obvious happens."

	.FUNCT V-CLEESH
	EQUAL? PRSO,ME \?L1
	PRINTI "You are turned into a newt, and scurry off to find your friends in the swamp. You are distracted by various yummy insects along the way, but eventually settle into a nice gooey part of the morass and live happily ever after, at least until you are devoured by a heron."
	CRLF
	CALL FINISH >STACK
	RSTACK
?L1:	EQUAL? PRSO,ADVENTURER,ADVENTURER-LG \?L5
	CALL NO-MORE-ADVENTURER
	CALL QUEUE,I-ADVENTURER,0
	REMOVE ADVENTURER
	PRINTR "The adventurer turns into a fairly large newt, which scuttles off and is lost to sight."
?L5:	FSET? PRSO,VICBIT \?L8
	FSET? PRSO,VILLAIN \?L8
	PRINTI "The "
	PRINTD PRSO
	PRINTR " looks sort of green and slimy for a moment, but he gets better."
?L8:	PRINTI "Turning the "
	PRINTD PRSO
	PRINTR " into a newt is a remarkable idea."

	.FUNCT V-IZYUK
	ZERO? PRSO /?L3
	EQUAL? PRSO,ME \?L1
?L3:	SET 'FLYING?,1
	CALL QUEUE,I-FLY,4 >STACK
	PUT STACK,0,1
	CALL QUEUE,I-FALL-FOREVER,0
	PRINTR "Your descent slows, and you are floating serenely in midair. The tower surrounds you, with wide-cut openings to the east and west. You could probably fly in either direction if you wished."
?L1:	PRINTI "You can't make the "
	PRINTD PRSO
	PRINTR " fly!"

	.FUNCT I-FLY
	SET 'FLYING?,0
	LOC WINNER >STACK
	EQUAL? STACK,PIT,REAL-STAIR \?L1
	PRINTI "The izyuk spell has worn off! You plummet deeper and deeper into the pit! Oddly enough, you never seem to hit bottom. After many years, only tattered remnants of you remain, still falling."
	CRLF
	CALL FINISH >STACK
	RSTACK
?L1:	PRINTR "You settle gently to the ground."

	.FUNCT V-FILFRE
	PRINTI "In a blinding burst of pyrotechnics, the air lights up with fireworks and dazzling explosions of multicolored fire! In sizzling sparks and roiling smoke is written:
"
	CALL FIXED-FONT-ON
	PRINTI "
  Enchanter
     by
Dave Lebling
     and
 Marc Blank

Copyright 1983, by Infocom, Inc.

"
	CALL FIXED-FONT-OFF
	PRINTR "After a while, the smoke dissipates and the lights dim. You remain slightly dazzled for a while, but fortunately, this wears off."

	.FUNCT JEWELLED-BOX-A
	IN? HERE,JEWELLED-BOX \TRUE
	GRTR? BOX-POINT,0 \TRUE
	ZERO? ROPE-MAGIC? /?L3
	PRINTR "The adventurer notes the box and tries to untie the rope from around it. His frustration is evident by the words he uses to describe the rope."
?L3:	PUTP JEWELLED-BOX,P?LDESC,STR?86
	PRINTR "The adventurer walks up to the box and becomes quickly entangled in the partly untied rope that is knotted around it. He looks like a cat who has been playing with a ball of yarn."

	.FUNCT JEWELLED-BOX-F
	IN? MAGIC-ROPE,JEWELLED-BOX \?L1
	EQUAL? PRSA,V?SHAKE \?L3
	PRINTR "It seems that there's something inside, but it's not clear what."
?L3:	EQUAL? PRSA,V?UNLOCK \?L7
	PRINTR "Who said anything about its being locked?"
?L7:	EQUAL? PRSA,V?REZROV \?L10
	ZERO? ROPE-MAGIC? /?L11
	PRINTR "The magic in the rope is strong enough to prevent the rezrov spell from working."
?L11:	PRINTI "The rope dissolves and the jewelled box flies open!"
	CRLF
	CALL ROPE-DISSOLVES
	FSET JEWELLED-BOX,OPENBIT
	RTRUE
?L10:	EQUAL? PRSA,V?LOOK-INSIDE,V?OPEN \?L18
	PRINTR "With all that rope around it, you haven't a prayer."
?L18:	EQUAL? PRSA,V?EXAMINE \?L21
	PRINTR "It is closed and wrapped in tight coils of thin rope."
?L21:	EQUAL? PRSA,V?CLOSE \?L24
	PRINTR "It isn't open, which seems to be the problem at hand."
?L24:	EQUAL? PRSA,V?PUT \FALSE
	EQUAL? PRSI,JEWELLED-BOX \FALSE
	PRINTR "That won't work until the box is open."
?L1:	EQUAL? PRSA,V?OPEN \FALSE
	IN? PROTECTION-SCROLL,JEWELLED-BOX \FALSE
	CALL THIS-IS-IT,PROTECTION-SCROLL
	RFALSE

	.FUNCT MAGIC-ROPE-F
	EQUAL? PRSA,V?UNTIE \?L1
	PRINTI "After a few moments of reflection, you tackle the knots, one at a time. Although you succeed with some regularity at untangling small areas of the rope, you "
	ZERO? ROPE-MAGIC? /?L5
	PRINTR "find that new knots seem to be forming as you watch, taunting you into deep despair."
?L5:	PUTP JEWELLED-BOX,P?LDESC,STR?86
	PRINTR "can't make any headway against the enormous tangle. It would take forever to finish."
?L1:	EQUAL? PRSA,V?GUNCHO \?L12
	REMOVE MAGIC-ROPE
	REMOVE JEWELLED-BOX
	PRINTI "The "
	PRINTD PRSO
	PRINTI " disappears, but unfortunately the "
	PRINTD JEWELLED-BOX
	PRINTR " disappears as well."
?L12:	EQUAL? PRSA,V?REZROV \?L15
	CALL JEWELLED-BOX-F
	RTRUE
?L15:	EQUAL? PRSA,V?TAKE \?L16
	PRINTR "The rope is so entangled around the box that the idea is ridiculous."
?L16:	EQUAL? PRSA,V?MUNG,V?CUT \?L19
	ZERO? PRSI \?L20
	PRINTR "You can't hurt it with your bare hands."
?L20:	EQUAL? PRSI,MAGIC-KNIFE \?L24
	CALL ROPE-DISSOLVES
	PRINTR "At the mere touch of the magic knife, the rope gives way. Before your eyes, the strands, now moving this way, now moving that way, untangle themselves into a single strand which falls to the floor alongside the box, where it dissolves into the air without a sound."
?L24:	FSET? PRSI,WEAPONBIT \?L27
	ZERO? ROPE-MAGIC? /?L28
	PRINTR "The rope seems to be pretty strong stuff. You don't seem to be making the least progress in breaking it."
?L28:	PRINTR "The rope cuts cleanly, and falls to pieces on the floor. It must have been pretty rotten."
?L27:	PRINTI "You certainly won't get anywhere using the "
	PRINTD PRSI
	PRINTR "!"
?L19:	EQUAL? PRSA,V?KULCAD \?L38
	SET 'ROPE-MAGIC?,0
	PRINTR "Nothing obvious happens, but when you examine the rope, it lacks a certain something you saw in it before. It now looks sort of ordinary, like a clothesline."
?L38:	EQUAL? PRSA,V?DROP \FALSE
	CALL PERFORM,V?DROP,JEWELLED-BOX
	RTRUE

	.FUNCT ROPE-DISSOLVES
	SET 'ROPE-MAGIC?,0
	ADD SCORE,BOX-POINT >SCORE
	SET 'BOX-POINT,0
	REMOVE MAGIC-ROPE
	MOVE PROTECTION-SCROLL,JEWELLED-BOX
	FCLEAR JEWELLED-BOX,OPENBIT
	FSET JEWELLED-BOX,TOUCHBIT
	PUTP JEWELLED-BOX,P?LDESC,STR?87
	RTRUE

	.FUNCT MAGIC-KNIFE-F
	EQUAL? PRSA,V?EXAMINE \FALSE
	PRINTR "The dagger is inlaid with fine jewels. It would be a handsome addition to anyone's weapon collection."

	.FUNCT MAPS-F
	EQUAL? PRSA,V?TAKE \?L1
	PRINTI "Most of the maps are murals painted onto the walls. The others are securely mounted."
	CRLF
	CALL PRINT-ID,STR?88 >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?EXAMINE \FALSE
	PRINTR "The maps on the walls were made in the Elder days, when the face of the earth was different. You can recognize the ancient cities of Galepath and Mareilon on the shores of the Sea from your legends class at the University, but you have trouble discerning any other places. One map shows a proud castle standing on a cliff rising above the Sea. Largoneth it was, the once-proud home of Entharion the Wise, King of Quendor. As you realize that this place was the King's Map Room, you are filled with wonder at the ancient days."

	.FUNCT ENTHARION-F
	EQUAL? PRSA,V?WHO,V?EXAMINE \?L1
	PRINTR "You can remember little of the legends of Entharion the Wise. Perhaps you should have paid more attention in Legends class."
?L1:	EQUAL? PRSA,V?ZIFMIA \FALSE
	PRINTR "Poor Entharion, he's been dead these many years. You would need more than a summoning spell to get him here."

	.FUNCT GLOBE-F
	EQUAL? PRSA,V?EXAMINE \FALSE
	PRINTR "The globe represents the world as it was thought to be in the ancient days. Very little can be recognized of the seas or land masses."

	.FUNCT PEDESTAL-F
	EQUAL? PRSA,V?EXAMINE \FALSE
	PRINTR "A globe is sitting on it."

	.FUNCT PURLOINED-ROOM-F,RARG
	EQUAL? RARG,M-LOOK \?L1
	ZERO? DOOR-ILLUSION-GONE \?L3
	PRINTI "A more incongruous place than this would be difficult to believe. The room itself is nothing more than a small room at the base of the northeast tower with a narrow passageway entering from the west. Standing in front of you to the north, however, is a door surpassing anything you could have imagined. For starters, its massive lock is wrapped in a dozen six-inch thick iron chains. In addition, a certain five-headed monster sporting razor-sharp spears for tongues seems to be imbedded within its heavy oak frame. One is almost embarrassed to mention the gargoyles spewing flame and sulphurous ash which ornament either side of the door, or the ninety-seven slimy groping tentacles which taunt you ever closer to certain death. A sign, floating serenely above the door and glowing hideously in purple letters, offers the following rude understatement: "
	GETP FLOATING-SIGN,P?TEXT >STACK
	PRINT STACK
	PRINTR "."
?L3:	PRINTI "This rather unobtrusive room at the base of the northwest tower sports a small passageway to the west and a small, rickety door to the north which is "
	FSET? DOOR-REALITY,OPENBIT \?L12
	PRINTI "open"
	JUMP ?L16
?L12:	PRINTI "closed"
?L16:	PRINTR "."
?L1:	EQUAL? RARG,M-BEG \FALSE
	EQUAL? PRSA,V?WALK \FALSE
	EQUAL? PRSO,P?UP,P?NORTH \FALSE
	ZERO? DOOR-ILLUSION-GONE \FALSE
	EQUAL? WINNER,PLAYER \?L22
	CALL PERFORM,V?OPEN,DOOR-ILLUSION
	RTRUE
?L22:	PRINTR """I'd like to, but the door's closed."""

	.FUNCT DOOR-ILLUSION-F
	ZERO? DOOR-ILLUSION-GONE \FALSE
	EQUAL? PRSA,V?KULCAD \?L3
	PRINTI "As the last syllable of the kulcad spell echoes through the chamber, the door itself seems to dissolve. Slowly at first, then quickly, each of its rather unlovely ornaments turns pale, then transparent, then - nothing! What remains is a simple, wooden door which is standing shut. You move hesitantly toward the door. Nothing. You pause for a moment to regain your composure."
	CRLF
	SET 'DOOR-KULCAD,1
	FSET DOOR-ILLUSION,INVISIBLE
	FCLEAR DOOR-REALITY,INVISIBLE
	FCLEAR DOOR-REALITY,OPENBIT
	FCLEAR DOOR-REALITY,LOCKEDBIT
	SET 'DOOR-ILLUSION-GONE,1
	REMOVE MONSTERS-1
	REMOVE MONSTERS-2
	REMOVE MONSTERS-3
	RTRUE
?L3:	EQUAL? PRSA,V?SHOW \?L7
	EQUAL? PRSI,ADVENTURER \?L7
	CALL PERFORM,V?POINT,PRSO
	RTRUE
?L7:	EQUAL? PRSA,V?POINT \?L8
	IN? ADVENTURER,HERE \?L8
	SET 'ADVENTURER-STAY,1
	ZERO? ADVENTURER-CHARMED /?L9
	PRINTI "As you motion toward the monstrous door, the adventurer follows the imaginary line which proceeds thence from your outstretched arm."
	CRLF
	CRLF
	CALL NO-ILLUSIONS
	RTRUE
?L9:	PRINTR "The adventurer seems frightened, and he backs up toward the door."
?L8:	EQUAL? PRSA,V?UNLOCK,V?RUB,V?OPEN /?L17
	EQUAL? PRSA,V?ATTACK,V?KILL,V?MUNG /?L17
	EQUAL? PRSA,V?KNOCK \?L16
?L17:	IGRTR? 'BEATEN-UP,4 \?L18
	CALL PRINT-ID,STR?89
	CALL JIGS-UP,STR?90
	RTRUE
?L18:	CALL PICK-ONE,ILLUSION-HACKS >STACK
	PRINT STACK
	CALL PRINT-ID,STR?91 >STACK
	PRINT STACK
	CRLF
	CALL PICK-ONE,SIGN-TEXTS >STACK
	PUTP FLOATING-SIGN,P?TEXT,STACK
	RTRUE
?L16:	EQUAL? PRSA,V?REZROV \FALSE
	PRINTR "As you cast the rezrov spell, the door shudders briefly, and a few tentacles pause in their unending motion. The two gargoyles look at each other, perplexed. After a tense moment, the sign above the door flashes briefly: ""Fat Chance""."

	.FUNCT MIRROR-F
	FSET? HERE,NDESCBIT \?L1
	EQUAL? PRSA,V?KREBF \?L3
	FCLEAR HERE,NDESCBIT
	PRINTI "Shards of glass fly into the air, solving a jigsaw puzzle of a million pieces. The mirror is repaired!"
	CRLF
	CALL PRINT-ID,STR?92 >STACK
	RSTACK
?L3:	PRINTR "There's no mirror left here after the way you treated it."
?L1:	EQUAL? PRSA,V?EXAMINE,V?LOOK-INSIDE \?L10
	PRINTI "The scene behind the ""mirror"" is an underground landscape."
	FSET? ADVENTURER-LG,INVISIBLE /?L13
	PRINTI " A weary adventurer is standing there, dejected."
?L13:	CRLF
	RTRUE
?L10:	EQUAL? PRSA,V?ATTACK,V?MUNG \FALSE
	PRINTI "The mirror here smashes into tiny shards. Behind the mirror is a bare rock wall."
	CRLF
	CALL PRINT-ID,STR?93
	CALL NO-MORE-ADVENTURER
	FSET HERE,NDESCBIT
	RTRUE

	.FUNCT SHARDS-F
	FSET? HERE,NDESCBIT /?L1
	PRINTR "There are no shards of glass here...yet."
?L1:	EQUAL? PRSA,V?PUT,V?MOVE,V?TAKE /?L6
	EQUAL? PRSA,V?RUB \FALSE
?L6:	PRINTI "You would slice your fingers on them."
	CRLF
	CALL PRINT-ID,STR?94 >STACK
	RSTACK

	.FUNCT MIRROR-HALL-F,RARG,RM
	EQUAL? RARG,M-LOOK \?L1
	GETP HERE,P?COUNT >RM
	GET MIRROR-HALL-TBL1,RM >STACK
	PRINT STACK
	FSET? HERE,NDESCBIT \?L5
	PRINTI " Hall of Mirrors. Where there used to be a large mirror mounted on the wall is only an empty frame. Shards of mirror cover the floor."
	CRLF
	JUMP ?L9
?L5:	PRINTI " Hall of Mirrors. The hall itself is astounding and not a little bit confusing. To be sure, its northern wall is glass, but it does not seem to reflect anything within the hall. Rather, it seems to be a window on another world. This other world appears to be a large underground labyrinth, filled with tunnels, caves, and peculiar rock formations."
	CRLF
?L9:	ZERO? ADVENTURER-LOC /FALSE
	CALL DESCRIBE-ADVENTURER >STACK
	RSTACK
?L1:	EQUAL? RARG,M-ENTER \?L15
	MOVE GLOBAL-ADVENTURER,GLOBAL-OBJECTS
	RFALSE
?L15:	EQUAL? RARG,M-END \FALSE
	FSET? HERE,NDESCBIT /FALSE
	ZERO? ADVENTURER-SUMMONED \FALSE
	FSET? ADVENTURER-LG,INVISIBLE \FALSE
	RANDOM 100 >STACK
	GRTR? 15,STACK \FALSE
	SET 'ADVENTURER-LOC,HERE
	CALL QUEUE,I-LG-ADVENTURER,-1 >STACK
	PUT STACK,0,1
	PRINTI "From the other side of the ""mirror"" a bedraggled adventurer comes into view, carrying a brass lantern and an elvish sword, which is glowing dimly. He stops and stares in your direction."
	CRLF
	SET 'ADVENTURER-SEEN,1
	FCLEAR ADVENTURER-LG,INVISIBLE
	RTRUE

	.FUNCT MIRROR-STUFF-F
	FSET? HERE,NDESCBIT \?L1
	CALL GLOBAL-NOT-HERE-PRINT,MIRROR-STUFF >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?EXAMINE \FALSE
	PRINTR "The scene is an underground world, quite dissimilar from your own."

	.FUNCT NO-MORE-ADVENTURER
	FSET ADVENTURER-LG,INVISIBLE
	SET 'ADVENTURER-LOC,0
	CALL QUEUE,I-LG-ADVENTURER,0
	RTRUE

	.FUNCT I-LG-ADVENTURER
	ZERO? ADVENTURER-SUMMONED \?L3
	EQUAL? HERE,ADVENTURER-LOC /?L1
?L3:	CALL NO-MORE-ADVENTURER
	RFALSE
?L1:	RANDOM 100 >STACK
	GRTR? 25,STACK \FALSE
	PRINTI "The adventurer, after checking his compass, walks off."
	CRLF
	CALL NO-MORE-ADVENTURER
	RTRUE

	.FUNCT DESCRIBE-ADVENTURER
	PRINTI "A bedraggled adventurer, carrying a brass lantern and a dimly glowing elvish sword, can be seen through the ""mirror"". He "
	CALL PICK-ONE,ADVENTURER-FEEBLES >STACK
	PRINT STACK
	PRINTR "."

	.FUNCT GLOBAL-ADVENTURER-F
	EQUAL? PRSA,V?ZIFMIA \?L1
	CALL NO-ZIF >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?FOLLOW \?L3
	ZERO? ADVENTURER-SUMMONED /?L3
	EQUAL? ADV-OLD-LOC,HERE \?L4
	CALL GOTO,ADV-NEW-LOC
	RTRUE
?L4:	PRINTR "You have lost track of him."
?L3:	CALL GLOBAL-NOT-HERE-PRINT,GLOBAL-ADVENTURER
	RTRUE

	.FUNCT ADVENTURER-LG-F
	EQUAL? PRSA,V?EXAMINE \?L1
	CALL DESCRIBE-ADVENTURER >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?WAVE-AT \?L3
	PRINTR "He doesn't seem to notice your gesture."
?L3:	EQUAL? PRSA,V?ZIFMIA \?L6
	PRINTI "All at once, the bedraggled adventurer appears before you, brightly glowing sword in hand. His jaw has dropped and his eyes are bulging. His eyes dart this way and that, as if looking for a way to escape."
	CRLF
	CALL PRINT-ID,STR?95
	ADD SCORE,SUMMON-POINT >SCORE
	SET 'SUMMON-POINT,0
	MOVE ADVENTURER,HERE
	SET 'ADVENTURER-SUMMONED,1
	SET 'ADVENTURER-STAY,1
	CALL QUEUE,I-ADVENTURER,-1 >STACK
	PUT STACK,0,1
	CALL THIS-IS-IT,ADVENTURER
	RTRUE
?L6:	EQUAL? PRSA,V?CLEESH \?L9
	PRINTR "The spell has no effect, perhaps because he isn't here."
?L9:	EQUAL? PRSA,V?GUNCHO \FALSE
	PRINTI "Behind the ""mirror"", the luckless adventurer seems to fade away. He shimmers briefly and then vanishes without a trace."
	CRLF
	CALL NO-MORE-ADVENTURER
	SET 'ADVENTURER-SUMMONED,1
	RETURN ADVENTURER-SUMMONED

	.FUNCT ADVENTURER-C
	EQUAL? PRSA,V?TAKE \?L1
	CALL PERFORM,V?ASK-FOR,ADVENTURER,PRSO
	RTRUE
?L1:	EQUAL? PRSA,V?READ \FALSE
	ZERO? ADVENTURER-CHARMED \?L4
	PRINTR "The adventurer pulls back as you approach."
?L4:	PRINTI "The adventurer moves closer so that you might read it."
	CRLF
	RFALSE

	.FUNCT ADVENTURER-D,RARG
	PRINTI "There is a bedraggled and weary adventurer standing here. He is carrying "
	CALL PRINT-CONTENTS,ADVENTURER
	ZERO? ADVENTURER-CHARMED /?L3
	PRINTI ". He seems pleased to see you and frequently smiles in your direction"
?L3:	PRINTR "."

	.FUNCT SWORD-F
	EQUAL? PRSA,V?EXAMINE \FALSE
	PRINTR "The sword is of elvish workmanship and is glowing brightly."

	.FUNCT ADVENTURER-ACTOR
	EQUAL? PRSA,V?FOLLOW \?L1
	ZERO? ADVENTURER-CHARMED /?L3
	PRINTR """Sorry, but I've got better things to do than follow you."""
?L3:	PRINTR """I'd sooner follow Dimwit Flathead!"""
?L1:	EQUAL? PRSA,V?EXAMINE \?L10
	ZERO? ADVENTURER-CHARMED \?L11
	PRINTR "He glances suspiciously at it."
?L11:	EQUAL? PRSO,DOOR-ILLUSION \?L15
	PRINTR """It's a door."""
?L15:	PRINTI """It's "
	CALL PRINTA,PRSO
	PRINTR "."""
?L10:	EQUAL? PRSA,V?THROUGH,V?OPEN \?L21
	EQUAL? PRSO,DOOR-ILLUSION \?L21
	ZERO? ADVENTURER-CHARMED /?L22
	SET 'WINNER,PLAYER
	LOC WINNER >HERE
	CALL PERFORM,V?POINT,DOOR-ILLUSION
	RTRUE
?L22:	PRINTR "The adventurer looks at you suspiciously. ""Can't you open it yourself?"""
?L21:	EQUAL? PRSA,V?HELLO \?L27
	ZERO? ADVENTURER-CHARMED /?L28
	PRINTR """Hello. Nice to meet you."""
?L28:	ZERO? PRSO /?L32
	PRINTI "The "
	PRINTD PRSO
	PRINTR " steps away from you."
?L32:	PRINTR "The adventurer steps warily away."
?L27:	EQUAL? PRSA,V?UNTIE \?L38
	EQUAL? PRSO,MAGIC-ROPE \?L38
	ZERO? ADVENTURER-CHARMED /?L38
	PRINTR "The adventurer tries to untie the rope, but he only becomes entangled. He gives up and glares suspiciously at you."
?L38:	EQUAL? PRSA,V?ATTACK,V?MUNG \?L41
	EQUAL? PRSO,DOOR-ILLUSION \?L41
	PRINTI "He pauses as if searching for the right thing to say. ""I've known strange people, but fighting a wooden door?"""
	CRLF
	CALL PRINT-ID,STR?96 >STACK
	RSTACK
?L41:	EQUAL? PRSA,V?MUNG,V?CUT \?L44
	EQUAL? PRSO,MAGIC-ROPE \?L44
	ZERO? ADVENTURER-CHARMED \?L45
	PRINTI """Not bloody likely! There's magic there!"""
	CRLF
	CALL PRINT-ID,STR?97 >STACK
	RSTACK
?L45:	ZERO? ROPE-MAGIC? \?L49
	CALL ROPE-DISSOLVES
	MOVE JEWELLED-BOX,ADVENTURER
	LOC ADVENTURER >STACK
	MOVE PROTECTION-SCROLL,STACK
	PRINTR "The adventurer draws his sword and slices the rope cleanly into so much fluff. He opens the box, revealing a scroll! He drops this on the ground disdainfully but retains the box."
?L49:	ZERO? PRSI /?L53
	EQUAL? PRSI,SWORD \?L52
?L53:	PRINTR """Ooo! Nice idea!"" He slashes at the rope with his sword, but to no avail. The rope is impervious to the magic of this weapon! He looks crestfallen."
?L52:	PRINTR """I doubt that would work."""
?L44:	EQUAL? PRSA,V?SSHOW,V?SGIVE /FALSE
	EQUAL? PRSA,V?SHOW,V?GIVE \?L60
	EQUAL? PRSI,ME \?L60
	EQUAL? PRSA,V?GIVE \?L61
	CALL PERFORM,V?ASK-FOR,ADVENTURER,PRSO
	RTRUE
?L61:	ZERO? ADVENTURER-CHARMED /?L63
	PRINTI "The "
	PRINTD ADVENTURER
	PRINTI " allows you a quick look at the "
	PRINTD PRSO
	PRINTR "."
?L63:	PRINTI "The "
	PRINTD ADVENTURER
	PRINTR " gives you a suspicious look and attempts to conceal his possessions."
?L60:	PRINTR """I'll do what I please, thank you."""

	.FUNCT ADVENTURER-F
	EQUAL? WINNER,ADVENTURER \?L1
	CALL ADVENTURER-ACTOR >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?WAVE-AT \?L3
	ZERO? ADVENTURER-CHARMED /?L4
	PRINTR "The adventurer waves right back."
?L4:	PRINTR "The adventurer steps back a few paces."
?L3:	EQUAL? PRSA,V?FOLLOW \?L11
	PRINTR "He's right here!"
?L11:	EQUAL? PRSA,V?KILL,V?ATTACK \?L14
	SET 'ADVENTURER-CHARMED,0
	CALL PRINT-ID,STR?98
	CALL JIGS-UP,STR?99 >STACK
	RSTACK
?L14:	EQUAL? PRSA,V?NITFOL \?L15
	PRINTR "He already speaks your language, but now a bit better."
?L15:	EQUAL? PRSA,V?GUNCHO \?L18
	PRINTI "The adventurer blurs as though you were seeing him from a distance, wavers like a mirage, and then vanishes."
	CRLF
	REMOVE ADVENTURER
	CALL QUEUE,I-ADVENTURER,0 >STACK
	RSTACK
?L18:	EQUAL? PRSA,V?FROTZ \?L21
	PRINTI "The adventurer is now bathed in light, much to his amazement."
	CRLF
	SET 'ADVENTURER-CHARMED,0
	FSET ADVENTURER,LIGHTBIT
	FSET ADVENTURER,ONBIT
	RTRUE
?L21:	EQUAL? PRSA,V?VAXUM \?L24
	SET 'ADVENTURER-STAY,1
	SET 'ADVENTURER-CHARMED,1
	CALL QUEUE,I-ADVENTURER-UNCHARM,20 >STACK
	PUT STACK,0,1
	PRINTR "The adventurer smiles at you with an air of good will."
?L24:	EQUAL? PRSA,V?HELLO \?L27
	ZERO? ADVENTURER-CHARMED /?L28
	PRINTI "The "
	PRINTD PRSO
	PRINTR " waves back and says ""Hello!"""
?L28:	PRINTI "The "
	PRINTD PRSO
	PRINTR " keeps his distance, eyeing you cautiously."
?L27:	EQUAL? PRSA,V?SEARCH \?L35
	PRINTI "The "
	PRINTD PRSO
	PRINTR " isn't inclined to allow himself to be searched."
?L35:	EQUAL? PRSA,V?MUNG \?L38
	PRINTI "The "
	PRINTD PRSO
	PRINTI " dodges your blow and becomes very wary of you."
	CRLF
	CALL PRINT-ID,STR?100
	SET 'ADVENTURER-CHARMED,0
	RTRUE
?L38:	EQUAL? PRSA,V?GIVE \?L41
	EQUAL? PRSI,ADVENTURER \?L41
	ZERO? ADVENTURER-CHARMED \?L42
	PRINTI "The "
	PRINTD PRSI
	PRINTI " eyes you suspiciously. Why, he thinks, is this sorcerer handing me something"
	FSET? PRSO,TREASURE \?L46
	PRINTI ", especially something valuable"
?L46:	PRINTR "?"
?L42:	ZERO? SAILOR? /?L53
	SUB MOVES,SAILOR? >STACK
	LESS? STACK,2 \?L53
	MOVE PRSO,ADVENTURER
	PRINTI "A wide smile comes over his face as he takes the "
	PRINTD PRSO
	PRINTR ", as though your action resolved for him some great mystery."
?L53:	FSET? PRSO,TREASURE \?L56
	PRINTI "The "
	PRINTD PRSI
	PRINTI " gratefully accepts the offer of the "
	PRINTD PRSO
	PRINTI ". He is fascinated by its beauty and stops to thank you."
	CRLF
	MOVE PRSO,ADVENTURER
	RTRUE
?L56:	PRINTI "The "
	PRINTD PRSI
	PRINTR " refuses your offer politely."
?L41:	EQUAL? PRSA,V?SHOW \?L62
	EQUAL? PRSI,ADVENTURER \?L62
	ZERO? ADVENTURER-CHARMED \?L63
	PRINTR "He ignores you pointedly."
?L63:	EQUAL? PRSO,DOOR-ILLUSION /FALSE
	FSET? PRSO,TREASURE \?L68
	PRINTI "His eyes light up at the sight of the "
	PRINTD PRSO
	PRINTI "."
	CRLF
	SET 'ADVENTURER-STAY,1
	RETURN ADVENTURER-STAY
?L68:	PRINTR "He yawns briefly, indicating his disinterest."
?L62:	EQUAL? PRSA,V?TAKE \FALSE
	EQUAL? PRSI,ADVENTURER \FALSE
	CALL PERFORM,V?ASK-FOR,PRSI,PRSO
	RTRUE

	.FUNCT I-ADVENTURER-UNCHARM
	SET 'ADVENTURER-CHARMED,0
	IN? ADVENTURER,HERE \FALSE
	PRINTR "The adventurer looks at you as if seeing you for the first time. It's not clear that he likes what he sees, either."

	.FUNCT I-ADVENTURER,L,NL
	LOC ADVENTURER >L
	FSET? L,ONBIT \?L1
	FCLEAR LANTERN,ONBIT
	JUMP ?L3
?L1:	FSET LANTERN,ONBIT
?L3:	INC 'ADVENTURER-MOVE
	ZERO? ADVENTURER-MOVE /TRUE
	GETP L,P?ADVFCN >STACK
	CALL STACK >STACK
	ZERO? STACK \TRUE
	ZERO? ADVENTURER-STAY /?L7
	SET 'ADVENTURER-STAY,0
	EQUAL? HERE,L \FALSE
	ZERO? ADVENTURER-CHARMED /FALSE
	PRINTI "The adventurer"
	CALL PICK-ONE,ADVENTURER-LOITERS >STACK
	PRINT STACK
	CRLF
	RTRUE
?L7:	EQUAL? L,MIRROR-HALL-1,MIRROR-HALL-2,MIRROR-HALL-3 /?L14
	EQUAL? L,MIRROR-HALL-4,NORTH-GATE \?L13
?L14:	CALL NEXT-HALL,L,1 >NL
	CALL TREASURE-HERE?,NL >STACK
	ZERO? STACK /?L15
	CALL MOVE-ADVENTURER,NL >STACK
	RSTACK
?L15:	LESS? ADVENTURER-MOVE,5 \?L17
	CALL NEXT-HALL,L,0 >STACK
	CALL MOVE-ADVENTURER,STACK >STACK
	RSTACK
?L17:	CALL ADVENTURER-DECIDE,L >STACK
	RSTACK
?L13:	RANDOM 100 >STACK
	GRTR? 25,STACK \?L19
	EQUAL? HERE,L \?L19
	PRINTI "The adventurer "
	ZERO? ADVENTURER-CHARMED /?L22
	ZERO? SAILOR? \?L24
	RANDOM 100 >STACK
	GRTR? 16,STACK \?L24
	SET 'SAILOR?,MOVES
	PRINTR "waves at you and asks ""Hello, Sailor?"" Strange, you've never even been to sea."
?L24:	CALL PICK-ONE,ADVENTURER-NICE >STACK
	PRINT STACK
	CRLF
	RTRUE
?L22:	CALL PICK-ONE,ADVENTURER-QUIPS >STACK
	PRINT STACK
	CRLF
	RTRUE
?L19:	CALL ADVENTURER-TAKE,L >STACK
	ZERO? STACK /?L34
	SET 'ADVENTURER-STAY,0
	RTRUE
?L34:	ZERO? ADV-HASTE \?L36
	EQUAL? HASTED?,ADVENTURER \?L36
	SET 'ADV-HASTE,1
	CALL ADVENTURER-DECIDE,L
	CALL I-ADVENTURER
	RTRUE
?L36:	SET 'ADV-HASTE,0
	CALL ADVENTURER-DECIDE,L
	RTRUE

	.FUNCT MOVE-ADVENTURER,RM,L,CNT=0,OBJ,DIR
	LOC ADVENTURER >L
	EQUAL? L,NORTH-GATE \?L1
	EQUAL? RM,PURLOINED-ROOM \?L1
	CALL TREASURE-HERE?,RM >STACK
	ZERO? STACK \?L1
	FSET PURLOINED-ROOM,VILLAIN
	EQUAL? HERE,L \TRUE
	PRINTR "The adventurer starts toward the east but, seeing nothing of interest, changes his mind."
?L1:	EQUAL? RM,TEMPLE \?L8
	EQUAL? HERE,L \?L9
	PRINTI "The adventurer looks as if he might go into the temple, but then he thinks better of it."
	CRLF
?L9:	FSET TEMPLE,VILLAIN
	RTRUE
?L8:	EQUAL? RM,T-A \?L14
	EQUAL? HERE,L \?L15
	PRINTI "The adventurer starts to descend further, but chickens out. He won't make Dungeon Master at that rate!"
	CRLF
?L15:	FSET T-A,VILLAIN
	SET 'RM,DIM-DESCENT
	JUMP ?L20
?L14:	EQUAL? RM,WEST-CASTLE \?L20
	EQUAL? HERE,L \?L21
	PRINTI "The adventurer peers through the gate, but he decides against passing through."
	CRLF
?L21:	FSET WEST-CASTLE,VILLAIN
	SET 'RM,COURTYARD-1
?L20:	EQUAL? HERE,L \?L27
	PRINTI "The adventurer "
	EQUAL? HASTED?,ADVENTURER \?L31
	PRINTI "rockets out of"
	JUMP ?L35
?L31:	PRINTI "leaves"
?L35:	PRINTI " the room"
	CALL DOOR-FROM?,L,RM >OBJ
	ZERO? OBJ /?L40
	PRINTI " through the "
	PRINTD OBJ
?L40:	PRINTI ", heading "
	CALL DIR-FROM,L,RM >DIR
	EQUAL? DIR,P?UP,P?DOWN /?L47
	PRINTI "to "
?L47:	CALL DIR-PRINT,DIR
	SET 'ADV-NEW-LOC,RM
	SET 'ADV-OLD-LOC,L
	PRINTI "."
	CRLF
	JUMP ?L59
?L27:	EQUAL? HERE,RM \?L59
	EQUAL? HERE,PURLOINED-ROOM \?L55
	FSET? MAP-ROOM,VILLAIN /?L55
	CALL TREASURE-HERE?,HERE >STACK
	ZERO? STACK /?L55
	PRINTI "An adventurer peeks into the room, sees the "
	CALL TREASURE-HERE?,HERE >STACK
	PRINTD STACK
	PRINTI ", and enters."
	CRLF
	JUMP ?L59
?L55:	PRINTI "A bedraggled adventurer "
	EQUAL? HASTED?,ADVENTURER \?L62
	PRINTI "speeds"
	JUMP ?L66
?L62:	PRINTI "walks"
?L66:	PRINTI " into the room from "
	CALL DIR-FROM,RM,L >STACK
	CALL DIR-PRINT,STACK
	CALL DOOR-FROM?,RM,L >OBJ
	ZERO? OBJ /?L71
	PRINTI ", coming through the "
	PRINTD OBJ
?L71:	PRINTI "."
	CRLF
?L59:	MOVE ADVENTURER,RM
	FSET RM,VILLAIN
	EQUAL? RM,PURLOINED-ROOM /FALSE
	CALL ADVENTURER-TAKE,RM >STACK
	RSTACK

	.FUNCT DOOR-FROM?,HERE?1,THERE,P,L,TX
	SET 'P,0
?L1:	NEXTP HERE?1,P >P
	ZERO? P /FALSE
	LESS? P,P?OUT /?L1
	GETPT HERE?1,P >TX
	PTSIZE TX >L
	EQUAL? L,DEXIT \?L1
	GETB TX,REXIT >STACK
	EQUAL? STACK,THERE \?L1
	GETB TX,DEXITOBJ >STACK
	RSTACK

	.FUNCT ADVENTURER-TAKE,RM,F,N,TR=0,CNT=0,OBJ
	FIRST? RM >F /?L4
	JUMP ?L3
?L1:	ZERO? F /?L3
?L4:	NEXT? F >N /?L7
?L7:	FSET? F,TAKEBIT \?L13
	FSET? F,INVISIBLE /?L13
	EQUAL? F,STRONG-BOX /?L13
	FSET? F,TREASURE /?L10
	RANDOM 100 >STACK
	GRTR? 25,STACK \?L13
?L10:	GETP F,P?ADVFCN >STACK
	CALL STACK >STACK
	ZERO? STACK \?L13
	MOVE F,ADVENTURER
	INC 'CNT
	SET 'OBJ,F
	FSET? F,TREASURE \?L13
	SET 'TR,1
?L13:	SET 'F,N
	JUMP ?L1
?L3:	EQUAL? HERE,RM \FALSE
	GRTR? CNT,0 \FALSE
	PRINTI "The adventurer stoops over and picks up "
	EQUAL? CNT,1 \?L22
	PRINTI "the "
	PRINTD OBJ
	JUMP ?L26
?L22:	PRINTI "some objects"
?L26:	ZERO? TR /?L29
	PRINTI " and seems pleased by his discovery"
?L29:	PRINTR "."

	.FUNCT DIR-FROM,HERE?1,THERE,P,L,TX,O
	SET 'P,0
?L1:	NEXTP HERE?1,P >P
	ZERO? P /FALSE
	EQUAL? P,P?IN /?L1
	LESS? P,P?OUT /?L1
	GETPT HERE?1,P >TX
	PTSIZE TX >L
	EQUAL? L,DEXIT,UEXIT,CEXIT \?L1
	GETB TX,REXIT >STACK
	EQUAL? STACK,THERE \?L1
	RETURN P

	.FUNCT DIR-PRINT,DIR,CNT=0
?L1:	GET DIR-STRINGS,CNT >STACK
	EQUAL? STACK,DIR \?L3
	EQUAL? DIR,P?UP,P?DOWN /?L5
	PRINTI "the "
?L5:	ADD CNT,1 >STACK
	GET DIR-STRINGS,STACK >STACK
	PRINT STACK
	RTRUE
?L3:	INC 'CNT
	JUMP ?L1

	.FUNCT ADVENTURER-DECIDE,L,P,S,TX
	NEXTP L,0 >P
	PUT ADV-POSS,0,0
?L1:	LESS? P,P?OUT /?L2
	GETPT L,P >TX
	PTSIZE TX >S
	EQUAL? S,UEXIT /?L8
	EQUAL? S,DEXIT \?L9
	GETB TX,DEXITOBJ >STACK
	FSET? STACK,LOCKEDBIT \?L8
?L9:	EQUAL? S,CEXIT \?L6
	GETB TX,CEXITFLAG >STACK
	VALUE STACK >STACK
	ZERO? STACK /?L6
?L8:	GETB TX,REXIT >S
	GET ADV-POSS,0 >STACK
	ADD STACK,1 >TX
	PUT ADV-POSS,0,TX
	PUT ADV-POSS,TX,S
?L6:	NEXTP L,P >P
	JUMP ?L1
?L2:	GET ADV-POSS,0 >S
	ZERO? S \?L11
	PRINTI "**BUG: Can't move from "
	LOC ADVENTURER >STACK
	PRINTD STACK
	PRINTR "!"
?L11:	EQUAL? S,1 \?L15
	GET ADV-POSS,1 >STACK
	CALL MOVE-ADVENTURER,STACK >STACK
	RSTACK
?L15:	SET 'P,0
?L17:	IGRTR? 'P,S /?L18
	GET ADV-POSS,P >TX
	FSET? TX,VILLAIN /?L17
	CALL MOVE-ADVENTURER,TX
	RTRUE
?L18:	CALL RANDOM-ELEMENT,ADV-POSS >STACK
	CALL MOVE-ADVENTURER,STACK >STACK
	RSTACK

	.FUNCT NEXT-HALL,RM,L-R=1,TBL,OFFS=0,NR
	SET 'TBL,HALL-TBL
?L1:	GET TBL,OFFS >NR
	EQUAL? NR,RM \?L7
	ZERO? L-R /?L5
	ADD OFFS,1 >STACK
	GET TBL,STACK >STACK
	RSTACK
?L5:	SUB OFFS,1 >STACK
	GET TBL,STACK >STACK
	RSTACK
?L7:	INC 'OFFS
	JUMP ?L1

	.FUNCT TREASURE-HERE?,RM,F
	FIRST? RM >F \FALSE
?L4:	FSET? F,TREASURE \?L6
	RETURN F
?L6:	NEXT? F >F /?L4
	RFALSE

	.FUNCT PURLOINED-ROOM-A,TX
	CALL TREASURE-HERE?,PURLOINED-ROOM >TX
	ZERO? TX /?L1
	SET 'ADVENTURER-STAY,1
	EQUAL? HERE,PURLOINED-ROOM \FALSE
	MOVE TX,ADVENTURER
	FSET? DOOR-REALITY,INVISIBLE \FALSE
	PRINTI "The adventurer stops to pick up the "
	PRINTD TX
	PRINTI ". As he rises, he casts a cursory glance at the door, then he notices you. "
	ZERO? ADVENTURER-CHARMED /?L9
	PRINTI "He smiles at you as he pockets the "
	PRINTD TX
	PRINTI "."
	CRLF
	RFALSE
?L9:	PRINTI "He straightens quickly, glaring at you with distrust."
	CRLF
	RFALSE
?L1:	ZERO? ADVENTURER-NOTES-DOOR \FALSE
	SET 'ADVENTURER-NOTES-DOOR,1
	SET 'ADVENTURER-STAY,1
	FSET? DOOR-REALITY,INVISIBLE \FALSE
	PRINTI "The adventurer glances around the room in a businesslike way and makes a few notes on his map."
	CRLF
	RFALSE

	.FUNCT NO-ILLUSIONS
	FSET DOOR-ILLUSION,INVISIBLE
	FCLEAR DOOR-REALITY,INVISIBLE
	FCLEAR DOOR-REALITY,LOCKEDBIT
	FSET DOOR-REALITY,OPENBIT
	SET 'DOOR-ILLUSION-GONE,1
	PRINTI "The seemingly fearless adventurer shrugs and walks purposefully toward the door, ignoring all harm to his person in the form of knives, tentacles, and molten lead. As three buckets of the latter pour over his head, he casts you a perplexed look.
""Did you try the doorknob?"" he asks, as twenty-seven knives delicately skewer him.
Before you can answer, he reaches for one of the gargoyle heads which, by sheerest coincidence, has just flooded him in red-orange flame, and turns it gently.
""I think it's unlocked,"" he says, stoically ignoring the host of human-sized rats which feed on his incinerated torso.
His left hand, broken and bloodied, pulls at the gargoyle head.
""I'm going on ahead!"" he cries, opening a simple wooden door.
Wooden door? You rub your eyes for a moment and look again as he goes through it. Yes, just a plain wooden door."
	CRLF
	ADD SCORE,DOOR-POINT >SCORE
	SET 'DOOR-POINT,0
	MOVE ADVENTURER,MAP-ROOM
	SET 'ADVENTURER-STAY,1
	RETURN ADVENTURER-STAY

	.FUNCT INSIDE-GATE-F,RARG
	EQUAL? RARG,M-ENTER \?L1
	ZERO? CASTLE-ENTER \?L1
	SET 'CASTLE-ENTER,1
	PRINTI "As you pass through the gate, you feel that your mind is being probed. After a moment, it is released or, perhaps, discarded as uninteresting."
	CRLF
	CRLF
	RTRUE
?L1:	EQUAL? RARG,M-LOOK \FALSE
	PRINTR "You are just inside what appears to be the main entrance to the castle. An iron gate, standing wide open, looms to the west. Through it, a narrow road can be seen winding through low, smoky hills. Before you, to the east, is a huge open courtyard. To the north and the south are archways leading to the interior of the castle."

	.FUNCT IRON-GATE-F
	EQUAL? PRSA,V?UNLOCK,V?OPEN \?L1
	PRINTI "The gate is secure; it cannot be unlocked."
	CRLF
	CALL PRINT-ID,STR?101 >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?CLOSE \?L5
	PRINTR "It is too heavy to move."
?L5:	EQUAL? PRSA,V?REZROV \FALSE
	ADD SCORE,ENTRY-POINT >SCORE
	SET 'ENTRY-POINT,0
	PRINTI "The chains of the iron gate fly into the air and vanish. The gate flies open and a blast of cold air fills your lungs."
	CRLF
	CALL PRINT-ID,STR?102
	FSET IRON-GATE-CHAINS,INVISIBLE
	FSET IRON-GATE,OPENBIT
	RTRUE

	.FUNCT ARCH-F
	EQUAL? PRSA,V?THROUGH \FALSE
	EQUAL? HERE,PEBBLED-PATH \?L3
	CALL DO-WALK,P?SOUTH >STACK
	RSTACK
?L3:	EQUAL? HERE,INSIDE-GATE \?L5
	PRINTR "You should specify a compass direction, since there are two archways."
?L5:	CALL DO-WALK,P?NORTH >STACK
	RSTACK

	.FUNCT BED-F,RARG=0
	EQUAL? RARG,M-BEG \?L1
	EQUAL? PRSA,V?WALK \?L3
	PRINTR "You'll have to get up first. The bed is so comfy you would almost rather not."
?L3:	EQUAL? PRSA,V?WEAR,V?CLIMB-ON,V?BOARD \?L7
	PRINTR "You already are."
?L7:	EQUAL? PRSA,V?PUSH,V?MOVE,V?TAKE /?L11
	EQUAL? PRSA,V?CLOSE,V?OPEN,V?RUB \FALSE
?L11:	IN? PRSO,WINNER /FALSE
	PRINTR "You can't do that from your resting position."
?L1:	EQUAL? RARG,M-END /FALSE
	EQUAL? BED,PRSO,PRSI \FALSE
	EQUAL? PRSA,V?WEAR,V?CLIMB-ON,V?BOARD \?L17
	CALL PRINT-ID,STR?103
	MOVE WINNER,BED
	SUB MOVES,LAST-SLEEP >STACK
	LESS? STACK,MOVES-PER-DAY \?L18
	PRINTR "The bed is very comfortable and soft. In fact, you feel sort of sleepy just lying on it."
?L18:	PRINTI "Lying on this soft bed puts you to sleep."
	CRLF
	CALL PERFORM,V?SLEEP
	RTRUE
?L17:	EQUAL? PRSA,V?WALK-TO \?L25
	CALL PERFORM,V?BOARD,BED
	RTRUE
?L25:	EQUAL? PRSA,V?DROP,V?DISEMBARK \?L26
	IN? WINNER,BED \?L26
	MOVE WINNER,HERE
	PRINTR "Ah, that was a comfortable bed! But you're now on your own feet again."
?L26:	EQUAL? PRSA,V?EXAMINE \?L29
	EQUAL? PRSO,BED \?L29
	PRINTR "The feather bed looks as though it would be quite comfy to sleep on."
?L29:	EQUAL? PRSA,V?SHAKE \FALSE
	EQUAL? PRSO,BED \FALSE
	FIRST? BEDPOST >STACK \FALSE
	PRINTR "When you shake the bed, one of the bedposts rattles as though something were loose inside it."

	.FUNCT BEDPOST-F
	EQUAL? PRSA,V?SEARCH,V?EXAMINE \?L1
	FSET? BEDPOST,OPENBIT \?L3
	PRINTR "The bedpost is open."
?L3:	IN? BEDPOST-BUTTON,BED \?L7
	PRINTR "A careful examination reveals the outline of a small compartment, and near it an ornate carving which looks like a button. You could never have found it on your own."
?L7:	PRINTR "A careful examination reveals a thin line which might well be the outline of a small compartment, but the mechanism for opening it is not discernable."
?L1:	EQUAL? PRSA,V?OPEN \?L13
	PRINTI "Maybe it can be opened, but it's unclear how."
	CRLF
	CALL PRINT-ID,STR?104 >STACK
	RSTACK
?L13:	EQUAL? PRSA,V?REZROV \?L16
	FSET BEDPOST,OPENBIT
	IN? CHARM-SCROLL,BEDPOST \?L17
	ADD SCORE,CHARM-POINT >SCORE
	SET 'CHARM-POINT,0
	CALL THIS-IS-IT,CHARM-SCROLL
	PRINT POPS-OPEN
	CRLF
	RTRUE
?L17:	PRINTI "The bedpost pops open."
	CRLF
	CALL PRINT-ID,STR?105 >STACK
	RSTACK
?L16:	EQUAL? PRSA,V?SHAKE \FALSE
	FIRST? BEDPOST >STACK \FALSE
	PRINTR "There is something rustling around inside the bedpost."

	.FUNCT COMPARTMENT-F
	IN? BEDPOST-BUTTON,BED /?L1
	EQUAL? PRSA,V?SEARCH,V?EXAMINE \?L1
	PRINTR "A very thin line indicates that a hidden compartment might be imbedded in the bedpost, but it's not clear how to open it."
?L1:	CALL PERFORM,PRSA,BEDPOST
	RTRUE

	.FUNCT BEDPOST-BUTTON-F
	EQUAL? PRSA,V?PUSH \FALSE
	FSET BEDPOST,OPENBIT
	ADD SCORE,CHARM-POINT >SCORE
	SET 'CHARM-POINT,0
	IN? CHARM-SCROLL,BEDPOST \TRUE
	CALL THIS-IS-IT,CHARM-SCROLL
	PRINT POPS-OPEN
	CRLF
	RTRUE

	.FUNCT CELL-F
	EQUAL? PRSA,V?THROUGH \?L1
	EQUAL? HERE,DUNGEON \?L1
	CALL DO-WALK,P?NORTH >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?DROP \?L3
	EQUAL? HERE,NORTH-CELL \?L3
	CALL DO-WALK,P?SOUTH >STACK
	RSTACK
?L3:	EQUAL? PRSA,V?SEARCH \FALSE
	EQUAL? HERE,NORTH-CELL \FALSE
	CALL PERFORM,V?LOOK
	RTRUE

	.FUNCT NORTH-CELL-F,RARG
	EQUAL? RARG,M-LOOK \FALSE
	PRINTI "This is a damp and unhealthy dungeon cell with writing on the walls. The rusty door of the cell is "
	CALL PRINT-ID,STR?106
	FSET? NORTH-CELL-DOOR,OPENBIT \?L5
	PRINTI "open."
	JUMP ?L9
?L5:	PRINTI "closed."
?L9:	ZERO? NORTH-BLOCK-FLAG /?L21
	PRINTR " A square block sits beside a passage in the eastern wall."
?L21:	FSET? NORTH-BLOCK,NDESCBIT /?L16
	PRINTI " A square block in the east wall seems to be loose."
?L16:	CRLF
	RTRUE

	.FUNCT CELL-DOOR-F
	EQUAL? PRSA,V?OPEN \?L4
	FSET? PRSO,OPENBIT \?L3
?L4:	EQUAL? PRSA,V?CLOSE \FALSE
	FSET? PRSO,OPENBIT \FALSE
?L3:	PRINTI "The door is very rusty and reluctantly "
	FSET? PRSO,OPENBIT \?L7
	FCLEAR PRSO,OPENBIT
	PRINTI "close"
	JUMP ?L11
?L7:	FSET PRSO,OPENBIT
	PRINTI "open"
?L11:	PRINTR "s."

	.FUNCT STONE-WALL-F
	EQUAL? PRSA,V?READ,V?EXAMINE \FALSE
	PRINTI "The wall is covered with graffiti and scratchings marking time's passage."
	CRLF
	EQUAL? HERE,NORTH-CELL \TRUE
	ZERO? NORTH-BLOCK-FLAG \TRUE
	FCLEAR NORTH-BLOCK,NDESCBIT
	PRINTR "You notice that the mortar holding a square block has been chipped away, and the block is loose."

	.FUNCT NORTH-BLOCK-F
	EQUAL? PRSA,V?TAKE,V?MOVE \FALSE
	ZERO? NORTH-BLOCK-FLAG \?L3
	SET 'NORTH-BLOCK-FLAG,1
	PRINTR "You pull the block out of the crumbling wall, revealing a dark passage leading east."
?L3:	PRINTR "It's too heavy."

	.FUNCT SECRET-PASSAGE-F,RARG
	EQUAL? RARG,M-LOOK \FALSE
	PRINTI "This is a crudely carved secret passage. It appears to have been hollowed out by (perhaps) generations of prisoners."
	ZERO? NORTH-BLOCK-FLAG /?L5
	PRINTI " A passage leads west."
	JUMP ?L9
?L5:	PRINTI " A square block in the western wall seems to be loose."
?L9:	PRINTR " A short, crudely hewn passage leads up."

	.FUNCT SOUTH-GATE-F,RARG
	EQUAL? RARG,M-LOOK \FALSE
	PRINTI "This interior courtyard stands at the southern entrance to the castle, where a small rusty gate "
	FSET? RUSTY-GATE,OPENBIT \?L5
	PRINTI "is standing open and slowly swaying in a gentle sea breeze"
	JUMP ?L9
?L5:	PRINTI "stands closed"
?L9:	PRINTR ". Beyond the gate can be seen a small meadow and, beyond that, a white beach on a misty sea. Passages enter the castle proper to the north, east, and west."

	.FUNCT BANQUET-STUFF-F
	EQUAL? PRSA,V?CLOSE,V?OPEN,V?REZROV /?L3
	EQUAL? PRSA,V?EXAMINE,V?LOOK-INSIDE \FALSE
?L3:	FSET? PRSO,CONTBIT \FALSE
	FCLEAR PRSO,CONTBIT
	CALL PERFORM,PRSA,PRSO
	FSET PRSO,CONTBIT
	RTRUE

	.FUNCT BANQUET-ILLUSION-F
	EQUAL? PRSA,V?KULCAD \?L1
	REMOVE BANQUET-ILLUSION
	PRINTR "The festive banquet setting dissolves, leaving a large hall littered with broken benches."
?L1:	EQUAL? PRSA,V?BOARD,V?CLIMB-ON \?L5
	EQUAL? PRSO,BENCHES,BTABLES \?L5
	PRINTR "It's not worth the bother."
?L5:	EQUAL? PRSA,V?MOVE,V?TAKE \FALSE
	IN? BANQUET-ILLUSION,HERE \?L9
	PRINTR "They seem to be protected by some magic; you can't budge them."
?L9:	PRINTR "You realize there is no point in that."

	.FUNCT BANQUET-FOOD-F
	EQUAL? PRSA,V?TAKE,V?EAT \?L1
	PRINTI "The food is quite delicious, but somehow unsatisfying."
	CRLF
	CALL PRINT-ID,STR?107 >STACK
	RSTACK
?L1:	CALL BANQUET-ILLUSION-F >STACK
	RSTACK

	.FUNCT GUARD-WARNING-F,RARG,LP
	LOC PLAYER >LP
	EQUAL? RARG,M-LOOK \?L1
	EQUAL? LP,BANQUET-HALL \?L3
	FSET? BANQUET-HALL,RMUNGBIT \?L5
	REMOVE BANQUET-ILLUSION
	PRINTI "This desolate hall is nearly empty, save for a few long benches which are scattered throughout the room. The walls seem to be scorched, and everywhere are signs of decay. A sickening odor pervades the room, and wisps of acrid black smoke can be seen to the north. A wide passage leads south, and a small one opens to the east."
	CRLF
	JUMP ?L18
?L5:	IN? BANQUET-ILLUSION,BANQUET-HALL \?L9
	PRINTI "A banquet has been set here for hundreds. Long benches fill the room, each covered with finest linen and set with golden cutlery and glittering crystal. Luscious food weighs down each table, and candles light the room with a festive glow. The room can be entered by a north-south corridor and a small opening to the east, from which an odd, acrid smell issues."
	CRLF
	JUMP ?L18
?L9:	PRINTI "This hall is completely empty, except for some long benches which are scattered throughout the room."
	CRLF
	JUMP ?L18
?L3:	EQUAL? LP,LIBRARY \FALSE
	GETP LP,P?LDESC >STACK
	PRINT STACK
	CRLF
?L18:	IN? GANG-OF-FOUR,LP /TRUE
	PRINTI "To the "
	EQUAL? LP,LIBRARY \?L23
	PRINTI "south"
	JUMP ?L27
?L23:	PRINTI "north"
?L27:	PRINTR " you can hear the sound of a group of low, guttural voices."
?L1:	EQUAL? RARG,M-BEG \?L33
	EQUAL? WINNER,PLAYER \?L33
	EQUAL? PRSA,V?WALK \?L33
	ZERO? PROTECTED-FROM-EVIL \?L33
	IN? GANG-OF-FOUR,LP \?L33
	EQUAL? LP,LIBRARY \?L37
	EQUAL? PRSO,P?SOUTH /?L36
?L37:	EQUAL? LP,BANQUET-HALL \FALSE
	EQUAL? PRSO,P?NORTH \FALSE
?L36:	PRINTI "In your confused and fearful state, you have blundered right into the advancing guards! They grab you, not too gently, and take you away. You end up at a huge temple."
	CRLF
	CRLF
	CALL PRINT-ID,STR?108
	CALL QUEUE,I-GUARDS-ARRIVE,0
	CALL QUEUE,I-GANG,0
	CALL TAKE-TO-TOWER
	RTRUE
?L33:	EQUAL? RARG,M-END \FALSE
	RANDOM 100 >STACK
	GRTR? 30,STACK \FALSE
	EQUAL? LP,LIBRARY,BANQUET-HALL \FALSE
	IN? GANG-OF-FOUR,LP /FALSE
	EQUAL? WINNER,PLAYER \?L42
	PRINTI "The low, guttural voices seem to be coming in your direction."
	CRLF
?L42:	CALL QUEUE,I-GUARDS-ARRIVE,2 >STACK
	PUT STACK,0,1
	RTRUE

	.FUNCT I-GUARDS-ARRIVE,LP
	LOC PLAYER >LP
	EQUAL? LP,LIBRARY,BANQUET-HALL \FALSE
	PRINTI "A group of four hunched and hairy shapes walks into your presence. "
	ZERO? PROTECTED-FROM-EVIL \?L5
	MOVE GANG-OF-FOUR,LP
	PRINTI "They seem surprised to see you. After whispering a few guttural words to each other, they start to move toward you purposefully."
	CRLF
	SET 'GANG-FOLLOWS,0
	CALL QUEUE,I-GANG,1 >STACK
	PUT STACK,0,1
	RTRUE
?L5:	PRINTR "They don't seem to take much notice of you, and they soon depart."

	.FUNCT I-GANG
	INC 'GANG-FOLLOWS
	LOC PLAYER >STACK
	IN? GANG-OF-FOUR,STACK \?L1
	REMOVE GANG-OF-FOUR
	ZERO? PROTECTED-FROM-EVIL /?L3
	PRINTR "The group of hunched and hairy shapes glances at you disinterestedly, wanders around the room for a while, and then departs."
?L3:	PRINTI "The group of hunched and hairy shapes takes you in their arms and escorts you into a huge temple."
	CRLF
	CRLF
	CALL PRINT-ID,STR?109
	CALL TAKE-TO-TOWER
	RTRUE
?L1:	LOC PLAYER >STACK
	FSET? STACK,RMUNGBIT \?L10
	PRINTI "The group of shapes follows you, intent on your capture! They seem to come alive in the desolation which fills this room."
	CRLF
	LOC PLAYER >STACK
	MOVE GANG-OF-FOUR,STACK
	CALL QUEUE,I-GANG,1
	RTRUE
?L10:	LESS? GANG-FOLLOWS,LOSSAGE \?L13
	PRINTI "The group of shapes follows you into this undespoiled room, emboldened and eager for blood."
	CRLF
	LOC PLAYER >STACK
	MOVE GANG-OF-FOUR,STACK
	CALL QUEUE,I-GANG,1
	RTRUE
?L13:	PRINTI "Fortunately for you, the gang has stopped following! You relax for a moment and heave a sigh of relief."
	CRLF
	REMOVE GANG-OF-FOUR
	RFALSE

	.FUNCT GANG-OF-FOUR-F
	EQUAL? PRSA,V?CLEESH \?L1
	PRINTI "The group of shapes turns into a small convention of newts, who run away."
	CRLF
	CALL QUEUE,I-GANG,0
	REMOVE GANG-OF-FOUR
	RTRUE
?L1:	EQUAL? PRSA,V?VAXUM \?L5
	ZERO? PROTECTED-FROM-EVIL \FALSE
	PRINTI "The shapes, who were on the verge of reaching you, seem to waver in their resolve. After a moment's pause, they leave the room together, talking in a less guttural tone which might correspond to cheerfulness."
	CRLF
	REMOVE GANG-OF-FOUR
	CALL QUEUE,I-GANG,0
	RTRUE
?L5:	EQUAL? PRSA,V?GUNCHO \?L11
	PRINTI "The shapes"
	ZERO? PROTECTED-FROM-EVIL \?L14
	PRINTI ", on the verge of reaching you,"
?L14:	PRINTI " disappear, seeming to dwindle into the distance while remaining in the same spot. Eventually you can see them no longer."
	CRLF
	REMOVE GANG-OF-FOUR
	RTRUE
?L11:	EQUAL? PRSA,V?ZIFMIA \?L21
	ZERO? PROTECTED-FROM-EVIL /?L21
	CALL QUEUE,I-GANG,2 >STACK
	PUT STACK,0,1
	PRINTR "The shapes, previously ignoring you, now approach with menace in their eyes."
?L21:	EQUAL? PRSA,V?FROTZ \?L24
	PRINTI "The shapes glow brightly from the frotz spell. This apparently doesn't appeal to them, as they shriek with horror and attempt to avert their gaze from themselves. Within a moment, they have run screaming from the room."
	CRLF
	CALL PRINT-ID,STR?110
	REMOVE GANG-OF-FOUR
	RTRUE
?L24:	EQUAL? PRSA,V?NITFOL \FALSE
	ZERO? PROTECTED-FROM-EVIL \FALSE
	PRINTI "The shapes, whose language you understand instinctively, say something on the order of ""Blood for sacrifice!"", ""Master pleased!"", and other not-so-soothing words as they approach."
	CRLF
	CALL PRINT-ID,STR?111 >STACK
	RSTACK

	.FUNCT LITTER-F
	EQUAL? PRSA,V?TAKE \?L1
	PRINTR "You have no use for those things."
?L1:	EQUAL? PRSA,V?EXAMINE \FALSE
	PRINTR "They look as if they haven't been disturbed in a long time."

	.FUNCT RAT-NEST-F
	EQUAL? PRSA,V?TAKE \?L1
	PRINTI "What on earth for?"
	CRLF
	CALL PRINT-ID,STR?112 >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?MUNG,V?RUB \?L5
	PRINTR "You poke around in the nest, but there doesn't seem to be anything of interest in there."
?L5:	EQUAL? PRSA,V?LOOK-INSIDE \FALSE
	PRINTR "There's nothing in there."

	.FUNCT OVEN-F
	EQUAL? PRSA,V?REACH-IN,V?EXAMINE,V?LOOK-INSIDE \?L1
	PRINTR "The oven contains nothing of interest, unless of course you have a hankering for rat's nests."
?L1:	EQUAL? PRSA,V?REZROV,V?OPEN \?L5
	FSET? OVEN,OPENBIT \?L6
	PRINTR "The oven is already open."
?L6:	FSET OVEN,OPENBIT
	PRINTR "Opened."
?L5:	EQUAL? PRSA,V?CLOSE \FALSE
	FSET? OVEN,OPENBIT /?L14
	PRINTR "The oven is already closed."
?L14:	FCLEAR OVEN,OPENBIT
	PRINTR "Closed."

	.FUNCT HEAP-F
	EQUAL? PRSA,V?TAKE \?L1
	PRINTI "That would be rather undignified."
	CRLF
	CALL PRINT-ID,STR?113 >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?DIG,V?LOOK-INSIDE,V?SEARCH \FALSE
	PRINTI "There is nothing but rotted food there."
	CRLF
	CALL PRINT-ID,STR?114 >STACK
	RSTACK

	.FUNCT JUNCTION-F,RARG
	EQUAL? RARG,M-BEG \FALSE
	EQUAL? WINNER,PLAYER \FALSE
	ZERO? PROTECTED-FROM-EVIL \FALSE
	PRINTI "A host of hunched and hairy shapes walk into the hall before you can do anything and, seeing you, take you in their arms and escort you to the west into a huge temple."
	CRLF
	CRLF
	CALL PRINT-ID,STR?115
	CALL GOTO,TEMPLE >STACK
	RSTACK

	.FUNCT ADV-VS-GANG,L
	LOC ADVENTURER >L
	IN? WINNER,L \?L1
	IN? GANG-OF-FOUR,L \?L1
	IN? WINNER,LIBRARY \?L3
	PUSH NORTH-GATE
	JUMP ?L5
?L3:	PUSH EAST-HALL
?L5:	MOVE ADVENTURER,STACK
	PRINTR "The adventurer softly, silently, and stealthily disappears."
?L1:	IN? ADVENTURER,JUNCTION \FALSE
	LOC WINNER >STACK
	EQUAL? STACK,LIBRARY,BANQUET-HALL \FALSE
	PRINTI "You hear yelling, oaths, and the crash of metal coming from the "
	IN? WINNER,LIBRARY \?L11
	PUSH STR?116
	JUMP ?L13
?L11:	PUSH STR?117
?L13:	PRINT STACK
	PRINTI ". It sounds like a swordfight! Suddenly, everything is quiet."
	CRLF
	RANDOM 100 >STACK
	GRTR? 70,STACK \?L14
	IN? WINNER,LIBRARY \?L16
	PUSH NORTH-GATE
	JUMP ?L18
?L16:	PUSH EAST-HALL
?L18:	MOVE ADVENTURER,STACK
	SET 'ADV-OLD-LOC,HERE
	LOC ADVENTURER >ADV-NEW-LOC
	PRINTI "Then the adventurer, running at an impressive speed, tears by you heading "
	IN? WINNER,LIBRARY \?L21
	PUSH STR?117
	JUMP ?L23
?L21:	PUSH STR?116
?L23:	PRINT STACK
	PRINTR ". He seems to have been in a fight."
?L14:	REMOVE ADVENTURER
	MOVE SKELETON,TOWER-S
	CALL QUEUE,I-ADVENTURER,0 >STACK
	RSTACK

	.FUNCT SKELETON-F
	EQUAL? PRSA,V?TAKE \?L1
	PRINTR "They're quite heavy, and you don't need them anyway."
?L1:	EQUAL? PRSA,V?KILL,V?ATTACK,V?MUNG \FALSE
	PRINTI "Show some respect! Especially considering that he got that way because of you!"
	CRLF
	CALL PRINT-ID,STR?118 >STACK
	RSTACK

	.FUNCT VOICES-F
	EQUAL? HERE,ENGINE-ROOM,SE-TOWER \?L1
	EQUAL? PRSA,V?EXAMINE,V?LISTEN \FALSE
	PRINTR "The noise is loud and screeching."
?L1:	EQUAL? HERE,COURTYARD-3,ALTAR \?L8
	EQUAL? PRSA,V?LISTEN \FALSE
	PRINTR "The voices are chanting something horrifying."
?L8:	EQUAL? PRSA,V?LISTEN \?L14
	PRINTR "You can't make out what they are saying, though it would be fair to say it's not too pleasant."
?L14:	EQUAL? PRSA,V?ZIFMIA \?L17
	PRINTI "The voices seem to be approaching. I hope you know what you're doing."
	CRLF
	CALL QUEUE,I-GUARDS-ARRIVE,1 >STACK
	PUT STACK,0,1
	RTRUE
?L17:	EQUAL? PRSA,V?NITFOL \FALSE
	PRINTR "You can't use that spell on voices, only beings."

	.FUNCT TUBES-PSEUDO
	EQUAL? PRSA,V?LOOK-INSIDE \?L1
	PRINTR "They are all empty."
?L1:	EQUAL? PRSA,V?TAKE \FALSE
	PRINTR "As you touch each one, it crumbles to ash."

	.FUNCT ASHES-PSEUDO
	EQUAL? PRSA,V?TAKE \?L1
	PRINTR "The ash slips through your fingers."
?L1:	EQUAL? PRSA,V?EXAMINE \?L5
	EQUAL? HERE,LIBRARY \?L6
	PRINTR "The ashes have rat tracks in them. Little rat thoroughfares head here and there, but most head in one direction."
?L6:	PRINTR "The ashes are black and greasy."
?L5:	EQUAL? PRSA,V?LOOK-INSIDE,V?SEARCH \FALSE
	PRINTI "You find nothing of interest in the ashes"
	EQUAL? HERE,LIBRARY \?L16
	PRINTI ", other than rat tracks heading this way and that"
?L16:	PRINTR "."

	.FUNCT RAT-TRACKS-F
	EQUAL? PRSA,V?EXAMINE,V?FOLLOW \FALSE
	PRINTI "There are plenty of rat tracks here, going in various directions. One prominent rodentine thoroughfare stands out though, going as it does into a small hole in the wall."
	CRLF
	MOVE RAT-HOLE,HERE
	RTRUE

	.FUNCT RAT-HOLE-F,OBJ
	FIRST? RAT-HOLE >OBJ /?L1
?L1:	EQUAL? PRSA,V?EXAMINE \?L2
	PRINTR "You can't see anything in the rat hole."
?L2:	EQUAL? PRSA,V?REACH-IN \?L6
	PRINTI "You reach around for a moment and come up "
	CALL PRINT-ID,STR?119
	ZERO? OBJ \?L9
	PRINTR "empty."
?L9:	PRINTI "with something. It's "
	CALL PRINTA,OBJ
	PRINTI "."
	CRLF
	CALL THIS-IS-IT,OBJ
	FCLEAR OBJ,INVISIBLE
	ADD SCORE,QUENCH-POINT >SCORE
	SET 'QUENCH-POINT,0
	FSET RAT-HOLE,NDESCBIT
	MOVE OBJ,WINNER
	RTRUE
?L6:	EQUAL? PRSA,V?LOOK-INSIDE \?L16
	PRINTR "It's too dark to see anything inside the hole."
?L16:	EQUAL? PRSA,V?PUT \?L19
	EQUAL? PRSI,RAT-HOLE \?L19
	FIRST? RAT-HOLE >STACK \?L20
	PRINTR "Something's blocking up the hole from inside."
?L20:	GETP PRSO,P?SIZE >STACK
	GRTR? STACK,5 \?L24
	PRINTR "It won't fit."
?L24:	FSET PRSO,INVISIBLE
	MOVE PRSO,PRSI
	PRINTR "Done."
?L19:	EQUAL? PRSA,V?CLOSE \FALSE
	PRINTR "How absurd!"

	.FUNCT NORTH-GATE-OBJ-F
	EQUAL? PRSA,V?REZROV \?L1
	FSET? PRSO,OPENBIT /?L1
	PRINTI "The rusted north gate magically creaks open far enough for you to leave."
	CRLF
	FSET PRSO,OPENBIT
	FCLEAR PRSO,LOCKEDBIT
	RTRUE
?L1:	EQUAL? PRSA,V?OPEN \FALSE
	FSET? PRSO,LOCKEDBIT \FALSE
	PRINTR "The gate is rusted shut."

	.FUNCT FOREST-1-F,RARG
	EQUAL? RARG,M-ENTER \FALSE
	IN? REPAIR-SCROLL,HERE \FALSE
	FSET? REPAIR-SCROLL,TOUCHBIT /FALSE
	CALL THIS-IS-IT,REPAIR-SCROLL
	RFALSE

	.FUNCT SWAMP-F,RARG=0
	EQUAL? RARG,M-END \FALSE
	EQUAL? PRSA,V?TELL /FALSE
	PRINTI "The sounds of frogs and other swamp dwellers fill the air."
	EQUAL? TALK-TO-ANIMAL?,FROG \?L13
	FSET? NEWT-SCROLL,INVISIBLE /?L7
	PRINTI " The frogs are discussing "
	CALL PICK-ONE,FROG-TALKS >STACK
	PRINT STACK
	JUMP ?L13
?L7:	PRINTI " The frogs say ""Look under the lily pad. Breep!"""
?L13:	CRLF
	RFALSE

	.FUNCT SWAMP-PSEUDO
	EQUAL? PRSA,V?EXAMINE \?L1
	CALL PERFORM,V?LOOK
	RTRUE
?L1:	EQUAL? PRSA,V?THROUGH \FALSE
	PRINTI "There is probably quicksand there. At best you would get horribly muddy."
	CRLF
	CALL PRINT-ID,STR?120 >STACK
	RSTACK

	.FUNCT FROG-F
	EQUAL? WINNER,FROG \?L1
	EQUAL? PRSA,V?HELLO /?L1
	PRINTR """Breep! No, thank you. Breep!"""
?L1:	EQUAL? PRSA,V?LISTEN,V?HELLO \FALSE
	PRINTI """Breep! "
	EQUAL? TALK-TO-ANIMAL?,FROG \?L8
	CALL PICK-ONE,FROGGERS >STACK
	PRINT STACK
	PRINTI " "
?L8:	PRINTR "Breep!"""

	.FUNCT LILY-PAD-F
	EQUAL? PRSA,V?EXAMINE \?L1
	PRINTR "There's not much to say about the lily pads except that they seem to make a cheery home for the frogs."
?L1:	EQUAL? PRSA,V?CLIMB-ON,V?THROUGH \?L5
	PRINTI "You sink into the goo, crushing a lily pad."
	CRLF
	CALL PRINT-ID,STR?121 >STACK
	RSTACK
?L5:	EQUAL? PRSA,V?LOOK-UNDER \FALSE
	FSET? NEWT-SCROLL,INVISIBLE \?L9
	FCLEAR NEWT-SCROLL,INVISIBLE
	MOVE NEWT-SCROLL,WINNER
	PRINTR "There is a damp scroll there, which you take into your hand."
?L9:	PRINTR "There is nothing there but goo."

	.FUNCT ALTAR-PSEUDO
	EQUAL? PRSA,V?EXAMINE \?L1
	PRINTR "A close examination of the altar nearly sickens you. It fairly screams with the memory of the horrors it has seen since the coming of Krill. Its original white marble has been crusted with blood and desecrated by the minions of the evil Warlock."
?L1:	EQUAL? HERE,TEMPLE \?L5
	EQUAL? PRSA,V?CLIMB-ON,V?CLIMB-FOO,V?CLIMB-UP /?L6
	EQUAL? PRSA,V?WALK-TO \?L5
?L6:	CALL DO-WALK,P?UP
	RTRUE
?L5:	EQUAL? PRSA,V?RUB,V?WALK-TO,V?CLIMB-ON /?L8
	EQUAL? PRSA,V?CLIMB-FOO,V?CLIMB-UP \FALSE
?L8:	PRINTR "There is nothing you would like less than nearing the altar."

	.FUNCT STATUE-F
	EQUAL? PRSA,V?EXAMINE \?L1
	PRINTR "It is an enormous statue of a loathsome creature, dark and vile, with dripping fangs and razor-sharp talons. It appears almost to be motioning with its outstretched talons for you to approach."
?L1:	EQUAL? PRSA,V?RUB \FALSE
	PRINTI "Your sensibilities are offended by the very idea."
	CRLF
	CALL PRINT-ID,STR?122 >STACK
	RSTACK

	.FUNCT GANG-OF-N-F
	EQUAL? PRSA,V?GUNCHO \?L1
	PRINTI "The majority of the mass of figures fades away into nothingness. Enough remain, however, to continue the service (or whatever it is)."
	CRLF
	CALL PRINT-ID,STR?123 >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?FROTZ \?L5
	PRINTI "A few select figures suddenly start to give off light, to the horror of the remaining ones, who rip them to shreds in an instant."
	CRLF
	CALL PRINT-ID,STR?124 >STACK
	RSTACK
?L5:	EQUAL? PRSA,V?VAXUM \?L8
	PRINTR "Nothing seems to have happened, although a few of the figures seem to be chanting in a less guttural tone."
?L8:	EQUAL? PRSA,V?ZIFMIA \?L11
	PRINTI "Something appears to have snapped. The figures, who were so peacefully ignoring you, now seem to have taken a different, and less pleasant, tack."
	CRLF
	CALL TAKE-TO-TOWER >STACK
	RSTACK
?L11:	EQUAL? PRSA,V?CLEESH \FALSE
	PRINTR "Some of the figures hunch down even more and scuttle off."

	.FUNCT GUARDS-F
	EQUAL? PRSA,V?VAXUM \?L1
	PRINTR "The guards outside your cell cheer up a bit, upsetting a larger figure who could well be their boss. They are dismissed and replaced by other guards who don't seem to have the air of bonhomie shared by the others."
?L1:	EQUAL? PRSA,V?CLEESH \?L5
	PRINTR "A couple of the guards turn into newts, running this way and that. They are quickly replaced, however, by others. Perhaps turning into a newt is a commonplace around these parts."
?L5:	EQUAL? PRSA,V?GUNCHO \?L8
	PRINTI "A few guards disappear, seeming to vanish with distance while still standing in front of you. They are replaced quite quickly and efficiently by others. To judge by the reaction to your show of magical prowess, you would think these things happen every day."
	CRLF
	CALL PRINT-ID,STR?125 >STACK
	RSTACK
?L8:	EQUAL? PRSA,V?ZIFMIA \?L11
	PRINTI "Oh, no. You've done it now. The guards approach, and they don't look very pleased."
	CRLF
	CALL QUEUE,I-TAKE-TO-ALTAR,1 >STACK
	RSTACK
?L11:	EQUAL? PRSA,V?EXAMINE \?L14
	PRINTR "They are hunched and hairy shapes, but more detail cannot be discerned."
?L14:	EQUAL? PRSA,V?MUNG,V?ATTACK,V?KILL \?L17
	PRINTI "You can't reach them from in here, and you wouldn't have a prayer even if you could."
	CRLF
	CALL PRINT-ID,STR?126 >STACK
	RSTACK
?L17:	EQUAL? PRSA,V?LISTEN \?L20
	PRINTR "The guards make low, grumbling sounds that could pass for speech, but it is incomprehensible to you."
?L20:	EQUAL? PRSA,V?HELLO,V?TELL \?L23
	PRINTR "They go right on ignoring you. They don't seem to be much on conversation, although from time to time they grumble in an unsettling sort of way."
?L23:	ZERO? GUARDS-HEARD \?L26
	EQUAL? PRSA,V?NITFOL \FALSE
	SET 'GUARDS-HEARD,1
	PRINTR "The guards are having a delightful conversation, after a fashion:
Guard 1: ""Brgh! Last night, good bloodbath!""
Guard 2: ""Yes. Quite. Best in weeks. Have you seen the new sacrifice?""
Guard 1: ""Brggh! No! Just get here.""
Guard 2: ""It's a scrawny one. Not too much meat.""
Guard 1: ""Brrrgh! No meat! Not had good meal in many days!""
Guard 2: ""Perhaps tonight...""
Voice: ""Stop your yapping, both of you!""
The yapping stops abruptly."
?L26:	EQUAL? PRSA,V?NITFOL \FALSE
	PRINTR "The guards aren't speaking much."

	.FUNCT TOWER-DOOR-F
	EQUAL? PRSA,V?OPEN,V?UNLOCK \?L1
	ZERO? LOCKED-IN-TOWER /?L1
	PRINTI "The door is locked from the outside."
	ZERO? PROTECTED-FROM-EVIL \?L5
	PRINTI " even if you could open it, the guards would undoubtedly return you with little difficulty"
?L5:	PRINTR "."
?L1:	EQUAL? PRSA,V?KNOCK \?L12
	PRINTR "It would only get the attention of the guards."
?L12:	EQUAL? PRSA,V?REZROV \FALSE
	PRINTI "The locked cell door opens with a powerful snap! Unfortunately, the guards seem to have heard the snap and approach!"
	CRLF
	FSET PRSO,OPENBIT
	SET 'LOCKED-IN-TOWER,0
	CALL QUEUE,I-TAKE-TO-ALTAR,1
	RTRUE

	.FUNCT TOWER-S-F,RARG
	EQUAL? RARG,M-LOOK \FALSE
	ZERO? SACRIFICED? /?L3
	PRINTI "This prison cell is similar to the one in which you were held captive prior to your sacrifice."
	JUMP ?L7
?L3:	PRINTI "This is a small prison cell in the south tower of the temple."
?L7:	PRINTI " A window in the cell door looks out on the temple itself."
	CRLF
	EQUAL? ANYTHING-TAKEN,SCROLLS-TAKEN /TRUE
	GRTR? ANYTHING-TAKEN,0 \TRUE
	GRTR? SCROLLS-TAKEN,0 \TRUE
	PRINTR "The guards must have brought your possessions here, but something is definitely missing!"

	.FUNCT CELL-PSEUDO
	EQUAL? PRSA,V?ESCAPE \?L1
	ZERO? LOCKED-IN-TOWER /?L1
	PRINTR "That poses a difficult problem. There's only one way out, and that would mean tackling a few hundred unpleasant creatures."
?L1:	EQUAL? PRSA,V?DROP \?L5
	EQUAL? HERE,TOWER-S \?L6
	CALL DO-WALK,P?NORTH >STACK
	RSTACK
?L6:	CALL DO-WALK,P?SOUTH >STACK
	RSTACK
?L5:	EQUAL? PRSA,V?OPEN \?L9
	EQUAL? HERE,TOWER-S \?L10
	CALL PERFORM,V?OPEN,TOWER-S-DOOR
	RTRUE
?L10:	CALL PERFORM,V?OPEN,TOWER-N-DOOR
	RTRUE
?L9:	EQUAL? PRSA,V?SEARCH \FALSE
	CALL PERFORM,V?LOOK
	RTRUE

	.FUNCT TEMPLE-F,RARG
	EQUAL? RARG,M-END \FALSE
	IN? PLAYER,TEMPLE \FALSE
	ZERO? PROTECTED-FROM-EVIL \FALSE
	ZERO? LETTER-OF-TRANSIT \FALSE
	CRLF
	CALL TAKE-TO-TOWER >STACK
	RSTACK

	.FUNCT TAKE-TO-TOWER
	SET 'LOCKED-IN-TOWER,1
	SET 'WINNER,PLAYER
	SET 'P-CONT,0
	SET 'QUOTE-FLAG,0
	SET 'ADVENTURER-CHARMED,0
	CALL QUEUE,I-TURTLE,0
	PRINTI "A low noise begins behind you, and you turn to see hundreds of hunched and hairy shapes. A guttural chant issues from their throats. Near you stands a figure draped in a robe of deepest black, brandishing a vicious dagger. The chant grows louder as the robed figure approaches the altar. As the shapes grab you, the figure in black speaks: ""Take the victim to the tower. I shall prepare for the sacrifice!"" The figures, whose form you can barely guess, take you from here through the northern door and into a prison cell. They "
	CALL PRINT-ID,STR?127
	CALL BLT,PLAYER,TOWER-S >ANYTHING-TAKEN
	ZERO? ANYTHING-TAKEN /?L3
	PRINTI "take your possessions from you and "
?L3:	PRINTI "close the door with a crash!"
	CRLF
	CRLF
	SET 'SCROLLS-TAKEN,0
	CALL GOTO,TOWER-N
	IN? DISPEL-SCROLL,TOWER-S \?L10
	REMOVE DISPEL-SCROLL
	SET 'SCROLLS-TAKEN,1
?L10:	IN? BANISH-SCROLL,TOWER-S \?L13
	REMOVE BANISH-SCROLL
	INC 'SCROLLS-TAKEN
?L13:	CALL QUEUE,I-TAKE-TO-ALTAR,4 >STACK
	PUT STACK,0,1
	RTRUE

	.FUNCT I-TAKE-TO-ALTAR
	ZERO? PROTECTED-FROM-EVIL /?L1
	PRINTR "A gang of hunched and hairy shapes appear, look around cursorily, and then depart."
?L1:	CRLF
	PRINTI "A host of hunched and hairy shapes appear through the window. The cell door opens and you are marched solemnly to the temple and, from there, up the steps to the altar. The large, black figure approaches menacingly. He reaches into his cloak and pulls out a "
	ZERO? DAGGER-SEEN /?L8
	PRINTI "blood-drenched scimitar"
	JUMP ?L12
?L8:	PRINTI "great, glowing dagger"
?L12:	PRINTI ". He pulls you onto the altar, and with a murmur of approval from the throng, he plunges the blade into your heart!"
	CRLF
	SET 'SACRIFICED?,1
	EQUAL? DEATH-CHEATED,ME /?L17
	SET 'WINNER,PLAYER
	CALL PRINT-ID,STR?128
	CALL JIGS-UP,0,0 >STACK
	RSTACK
?L17:	SET 'LOCKED-IN-TOWER,0
	CRLF
	PRINTI "You feel yourself filled with a strange warmth as your eyes slowly open. You are lying on the altar"
	ZERO? DAGGER-SEEN \?L22
	PRINTI ", a glowing dagger in your chest"
?L22:	PRINTI ". You are in no pain, however. The large figure is gone, but the throng of shapes, taking no notice of your movement, is chanting in the temple below."
	ZERO? DAGGER-SEEN \?L29
	PRINTI " You slowly remove the dagger from your chest, but you are not harmed. The blade shines faintly in the light of the flickering torches."
?L29:	CRLF
	CRLF
	ADD SCORE,TEMPLE-POINT >SCORE
	SET 'TEMPLE-POINT,0
	ZERO? DAGGER-SEEN \?L34
	SET 'DAGGER-SEEN,1
	MOVE MAGIC-KNIFE,WINNER
?L34:	CALL QUEUE,I-LETTER-OF-TRANSIT,10 >STACK
	PUT STACK,0,1
	SET 'LETTER-OF-TRANSIT,1
	CALL GOTO,ALTAR >STACK
	RSTACK

	.FUNCT I-LETTER-OF-TRANSIT
	EQUAL? HERE,TEMPLE \?L1
	CALL QUEUE,I-LETTER-OF-TRANSIT,3
	RFALSE
?L1:	SET 'LETTER-OF-TRANSIT,0
	RFALSE

	.FUNCT GALLERY-A
	IN? ADVENTURER,HERE \FALSE
	ZERO? PORTRAIT-COMMENT \FALSE
	FSET? FLATHEAD-PORTRAIT,INVISIBLE /FALSE
	ZERO? ADVENTURER-CHARMED /FALSE
	SET 'PORTRAIT-COMMENT,1
	PRINTR "The adventurer stops and stares at the portraits. ""I've met him!"" he gasps, pointing at the Wizard of Frobozz. He doesn't appear eager to meet him again, though. ""And there's old Flathead! What a sight!"" He glances at the other portraits briefly and then re-checks his map."

	.FUNCT GALLERY-F,RARG
	EQUAL? RARG,M-ENTER \?L1
	CALL LIT?,HERE,0 >STACK
	ZERO? STACK \?L1
	ZERO? SUPER-BRIEF /?L3
	ZERO? GALLERY-POINT /?L3
	CALL DESCRIBE-PORTRAIT-GALLERY
?L3:	FCLEAR HERE,TOUCHBIT
	RTRUE
?L1:	EQUAL? RARG,M-LOOK \FALSE
	CALL LIT?,HERE,0 >STACK
	ZERO? STACK /?L7
	ZERO? GALLERY-POINT /?L9
	REMOVE LIGHTED-PORTRAIT
?L9:	SET 'VISITED-GALLERY?,1
	PRINTI "The east-west corridor opens into a gallery. The walls are lined with portraits, some of apparently great value. All of the eyes seem to follow you as you pass, and the entire room is subtly disturbing."
	CRLF
	IN? PORTRAIT-NICHE,GALLERY \FALSE
	PRINTR "A small niche can be seen in the wall behind the spot where a painting had been hanging."
?L7:	CALL DESCRIBE-PORTRAIT-GALLERY >STACK
	ZERO? STACK \FALSE
	PRINTR "It is pitch black."

	.FUNCT DESCRIBE-PORTRAIT-GALLERY
	IN? ETERNAL-FLAME,PORTRAIT-NICHE \FALSE
	FSET? ETERNAL-FLAME,ONBIT \FALSE
	ZERO? GALLERY-POINT /?L3
	MOVE LIGHTED-PORTRAIT,HERE
?L3:	ZERO? VISITED-GALLERY? /?L6
	PRINTI "An eerie orange glow casts a pale, flickering light on the portrait gallery."
	JUMP ?L10
?L6:	SET 'VISITED-GALLERY?,1
	PRINTI "The east-west corridor opens into a portrait gallery. The gallery is lit by an eerie orange glow."
?L10:	PRINTR " The eyes of the figures portrayed on the canvases seem to be faintly illuminated and follow your every movement. After a moment, the source of light becomes clear: a single lighted portrait flickers as if a flame were burning behind it."

	.FUNCT PORTRAITS-F
	EQUAL? PRSA,V?MOVE,V?TAKE \?L1
	PRINTI "The portraits are large and extremely heavy; they can be neither taken nor moved."
	CRLF
	CALL PRINT-ID,STR?129 >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?LOOK-UNDER,V?LOOK-BEHIND \?L5
	PRINTR "There are hundreds of canvases here; you look behind one or two at random but find nothing of interest."
?L5:	EQUAL? PRSA,V?EXAMINE \FALSE
	PRINTI "The portraits represent a wide cross-section of races. Elves, gnomes, dwarves, wizards, warlocks, and just plain folk are all here. Some of them are known to you, such as Lord Dimwit Flathead of the Great Underground Empire, depicted here in excessive detail, and the Wizard of Frobozz, shown in a typical pose of anguished bewilderment."
	CRLF
	FCLEAR FLATHEAD-PORTRAIT,INVISIBLE
	FCLEAR FROBOZZ-PORTRAIT,INVISIBLE
	RTRUE

	.FUNCT FLATHEAD-PORTRAIT-F
	EQUAL? PRSA,V?ZIFMIA \?L1
	PRINTR "Poor Flathead, the years have not been kind to him. Just as well, probably."
?L1:	EQUAL? PRSA,V?EXAMINE \FALSE
	PRINTR "This rather dull man stumbled into royalty in the Great Underground Empire, and much to everyone's chagrin. Named by his people Lord Dimwit Flathead the Excessive, he was best known for his outrageousness in style, policy, and engineering. His portrait captures him in the classic pose of imbecility, astride his gaudy throne."

	.FUNCT FROBOZZ-PORTRAIT-F
	EQUAL? PRSA,V?ZIFMIA \?L1
	PRINTR "The Wizard doesn't seem to respond to the summons. Perhaps he is too busy molesting adventurers in ZORK II."
?L1:	EQUAL? PRSA,V?EXAMINE \FALSE
	PRINTR "The Wizard of Frobozz was a former member of the Circle of Enchanters, but he was removed for forgetfulness bordering on senility. The lively wit of his youth having been replaced by a semisadistic mischievousness coupled with an inability to pronounce words beginning with other than the letter ""F"", he was ""retired"" to a small, unoccupied corner of the Great Underground Empire, hopefully out of harm's way."

	.FUNCT LIGHTED-PORTRAIT-F
	EQUAL? PRSA,V?LOOK-BEHIND \?L1
	FSET? PRSO,TOUCHBIT /?L1
	ADD SCORE,GALLERY-POINT >SCORE
	SET 'GALLERY-POINT,0
	MOVE PORTRAIT-NICHE,HERE
	FSET PRSO,TOUCHBIT
	PRINTI "Behind the portrait is a small niche. You find that the portrait is much lighter than the others and place it on the ground."
	FCLEAR HERE,ONBIT
	FIRST? PORTRAIT-NICHE >STACK \?L5
	PRINTI " Sitting in the niche is "
	CALL PRINT-CONTENTS,PORTRAIT-NICHE
	PRINTI "."
?L5:	CRLF
	RTRUE
?L1:	EQUAL? PRSA,V?EXAMINE \?L12
	FSET? PRSO,TOUCHBIT /?L13
	PRINTR "The portrait, of an obscure adventurer, is not notable except for the fact that it is lighted from behind by a flickering orange light."
?L13:	PRINTR "The portrait, of some obscure personage carrying a brass lantern and an elvish sword of great antiquity, is mediocre at best."
?L12:	EQUAL? PRSA,V?TAKE,V?MOVE \FALSE
	FSET? PRSO,TOUCHBIT /FALSE
	FCLEAR PRSO,NDESCBIT
	FSET PRSO,TOUCHBIT
	ADD SCORE,GALLERY-POINT >SCORE
	SET 'GALLERY-POINT,0
	MOVE PORTRAIT-NICHE,HERE
	PRINTI "The portrait is quite light. You remove it from the wall and place it on the ground, revealing a small niche in the wall"
	CALL PRINT-ID,STR?130
	FIRST? PORTRAIT-NICHE >STACK \?L23
	PRINTI ", in which sits "
	CALL PRINT-CONTENTS,PORTRAIT-NICHE
?L23:	PRINTR "."

	.FUNCT PORTRAIT-NICHE-F
	EQUAL? PRSA,V?CLOSE,V?OPEN \FALSE
	PRINTR "You can't do that."

	.FUNCT ETERNAL-FLAME-F
	EQUAL? PRSA,V?KULCAD,V?GONDAR \?L1
	PRINTI "The flame flickers for a moment, then goes out."
	CRLF
	FCLEAR ETERNAL-FLAME,ONBIT
	FCLEAR ETERNAL-FLAME,LIGHTBIT
	RTRUE
?L1:	EQUAL? PRSA,V?LAMP-ON \?L5
	FSET? ETERNAL-FLAME,ONBIT /?L5
	PRINTR "You can't relight the candles."
?L5:	EQUAL? PRSA,V?LAMP-OFF \FALSE
	PRINTI "The flame cannot be extinguished, no matter how hard you try."
	CRLF
	CALL PRINT-ID,STR?131 >STACK
	RSTACK

	.FUNCT JEWEL-CHESTS-F
	EQUAL? PRSA,V?EXAMINE,V?LOOK-INSIDE \?L1
	PRINTI "There's nothing inside."
	CRLF
	CALL PRINT-ID,STR?132 >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?CLOSE,V?OPEN \?L5
	PRINTR "Don't bother. There's nothing inside anyway."
?L5:	EQUAL? PRSA,V?PUT \FALSE
	PRINTR "A waste of time. You'd probably forget where you put it."

	.FUNCT EGG-KNOB-STATE,KNOB,VER?=0
	ZERO? VER? \?L3
	FSET? KNOB,OPENBIT \FALSE
?L3:	PRINTI "The "
	PRINTD KNOB
	FSET? KNOB,OPENBIT \?L6
	PRINTI " has been "
	JUMP ?L10
?L6:	ZERO? VER? /?L10
	PRINTI " has not yet been "
?L10:	GETP KNOB,P?TEXT >STACK
	PRINT STACK
	PRINTI ". "
	RTRUE

	.FUNCT EGG-F
	EQUAL? PRSA,V?LOOK-INSIDE \?L1
	FSET? EGG,OPENBIT /?L1
	PRINTR "The egg isn't open!"
?L1:	EQUAL? PRSA,V?EXAMINE \?L5
	PRINTI "This ornamented egg is both beautiful and complex. The egg itself is mother-of-pearl, but decorated with delicate gold traceries inlaid with jewels and other precious metals. On the surface are a lapis handle, an emerald knob, a silver slide, a golden crank, and a diamond-studded button carefully and unobtrusively imbedded in the decorations. These various protuberances are likely to be connected with some machinery inside."
	CRLF
	CALL EGG-KNOB-STATE,EGG-KNOB-1
	CALL EGG-KNOB-STATE,EGG-KNOB-2
	CALL EGG-KNOB-STATE,EGG-KNOB-3
	CALL EGG-KNOB-STATE,EGG-KNOB-4
	CALL EGG-KNOB-STATE,EGG-KNOB-5
	PRINTI "The "
	PRINTD PRSO
	PRINTI " is "
	FSET? PRSO,OPENBIT \?L10
	PRINTR "open."
?L10:	PRINTR "closed."
?L5:	EQUAL? PRSA,V?PUT \?L17
	EQUAL? PRSI,EGG \?L17
	PRINTI "You can't put the "
	PRINTD PRSO
	PRINTI " inside the egg without damaging it."
	CRLF
	CALL PRINT-ID,STR?133 >STACK
	RSTACK
?L17:	EQUAL? PRSA,V?REZROV \?L20
	FSET? EGG,OPENBIT /?L20
	FSET EGG,OPENBIT
	ADD SCORE,EGG-POINT >SCORE
	SET 'EGG-POINT,0
	PRINTI "The egg seems to come to life and each piece slides effortlessly in the correct pattern. The egg opens"
	IN? DAMAGED-SCROLL,EGG \?L23
	FCLEAR DAMAGED-SCROLL,INVISIBLE
	CALL THIS-IS-IT,DAMAGED-SCROLL
	PRINTI ", revealing a shredded scroll inside, nestled among a profusion of shredders, knives, and other sharp instruments, cunningly connected to the knobs, buttons, etc. on the outside"
?L23:	PRINTR "."
?L20:	EQUAL? PRSA,V?LOOK-INSIDE \?L30
	FSET? PRSO,OPENBIT \?L30
	FIRST? PRSO >STACK /?L30
	PRINTR "On the inside of the egg are many complex cutting devices."
?L30:	EQUAL? PRSA,V?OPEN \?L33
	FSET? EGG,OPENBIT /?L33
	PRINTR "That seems to be the problem."
?L33:	EQUAL? PRSA,V?CLOSE \?L36
	FSET? EGG,OPENBIT \?L36
	FCLEAR EGG-KNOB-1,OPENBIT
	FCLEAR EGG-KNOB-2,OPENBIT
	FCLEAR EGG-KNOB-3,OPENBIT
	FCLEAR EGG-KNOB-4,OPENBIT
	FCLEAR EGG-KNOB-5,OPENBIT
	PRINTI "As you close the egg, all of the pieces slide back into place, locking it shut."
	CRLF
	FCLEAR EGG,OPENBIT
	RTRUE
?L36:	EQUAL? PRSA,V?MUNG \FALSE
	PRINTI "The egg is smashed into little tiny pieces by the force of your blow."
	CALL PRINT-ID,STR?134
	IN? DAMAGED-SCROLL,EGG \?L42
	FCLEAR DAMAGED-SCROLL,INVISIBLE
	MOVE DAMAGED-SCROLL,SCRAMBLED-EGG
	PRINTI " Inside the now broken egg are the remains of a small spell scroll, damaged beyond hope of learning."
?L42:	CRLF
	LOC EGG >STACK
	MOVE SCRAMBLED-EGG,STACK
	REMOVE EGG
	RTRUE

	.FUNCT EGG-KNOB-F
	EQUAL? PRSA,V?TURN,V?OPEN,V?REZROV /?L3
	EQUAL? PRSA,V?PUSH,V?MOVE \?L1
?L3:	FSET? PRSO,OPENBIT \?L4
	PRINTR "It's already in the open position."
?L4:	FSET PRSO,OPENBIT
	EQUAL? PRSA,V?REZROV \?L9
	ADD SCORE,EGG-POINT >SCORE
	SET 'EGG-POINT,0
	PRINTI "The "
	PRINTD PRSO
	PRINTR " vibrates, moving this way and that, becoming almost plastic, and finally moves to the open position."
?L9:	FSET? EGG,OPENBIT \?L13
	PRINTI "The "
	PRINTD PRSO
	PRINTI " moves, and a cunning and diabolically engineered set of gears, knives, grinders, and slicers moves across the interior of the egg."
	CRLF
	IN? DAMAGED-SCROLL,EGG \TRUE
	PRINTR "The scroll resting there is now shredded beyond recognition."
?L13:	PRINTI "The "
	PRINTD PRSO
	PRINTI " moves to the open position, after some resistance and a few odd noises from some machinery which resides inside the egg."
	CRLF
	FSET? EGG-KNOB-1,OPENBIT \TRUE
	FSET? EGG-KNOB-2,OPENBIT \TRUE
	FSET? EGG-KNOB-3,OPENBIT \TRUE
	FSET? EGG-KNOB-4,OPENBIT \TRUE
	FSET? EGG-KNOB-5,OPENBIT \TRUE
	ADD SCORE,EGG-POINT >SCORE
	SET 'EGG-POINT,0
	FSET EGG,OPENBIT
	PRINTI "The egg falls open"
	IN? DAMAGED-SCROLL,EGG \?L28
	FCLEAR DAMAGED-SCROLL,INVISIBLE
	CALL THIS-IS-IT,DAMAGED-SCROLL
	PRINTI ", revealing a shredded scroll inside"
?L28:	PRINTR "."
?L1:	EQUAL? PRSA,V?TAKE \?L36
	PRINTI "The "
	PRINTD PRSO
	PRINTI " is an integral part of the egg and thus cannot be taken."
	CRLF
	CALL PRINT-ID,STR?135 >STACK
	RSTACK
?L36:	EQUAL? PRSA,V?EXAMINE \?L39
	CALL EGG-KNOB-STATE,PRSO,1
	CRLF
	RTRUE
?L39:	EQUAL? PRSA,V?CLOSE \?L40
	FSET? PRSO,OPENBIT \?L41
	PRINTI "The "
	PRINTD PRSO
	PRINTI " closes easily, but more noises issue from the interior."
	CRLF
	FCLEAR PRSO,OPENBIT
	RTRUE
?L41:	PRINTR "It's already closed."
?L40:	EQUAL? PRSA,V?MUNG \FALSE
	CALL PERFORM,V?MUNG,EGG
	RTRUE

	.FUNCT SCRAMBLED-EGG-F,L,F
	LOC SCRAMBLED-EGG >L
	EQUAL? PRSA,V?KREBF \FALSE
	FIRST? SCRAMBLED-EGG >F \?L3
	MOVE F,EGG
?L3:	CALL THIS-IS-IT,EGG
	REMOVE SCRAMBLED-EGG
	MOVE EGG,L
	PRINTR "The egg is returned to its former pristine beauty!"

	.FUNCT DAMAGED-SCROLL-F,L
	LOC DAMAGED-SCROLL >L
	EQUAL? PRSA,V?KREBF \FALSE
	REMOVE DAMAGED-SCROLL
	MOVE SUMMON-SCROLL,L
	CALL THIS-IS-IT,SUMMON-SCROLL
	ADD SCORE,REPAIR-POINT >SCORE
	SET 'REPAIR-POINT,0
	PRINTI "The scroll reforms, its slices and cuts rejoining, until there is a whole scroll, somewhat faded, in its place!"
	CRLF
	CALL PRINT-ID,STR?136 >STACK
	RSTACK

	.FUNCT V-TIME,EL
	DIV TOD,10 >EL
	PRINTI "It would be "
	GET TIME-TABLE,EL >STACK
	PRINT STACK
	PRINTR " now."

	.FUNCT GLOBAL-SLEEP-F
	EQUAL? PRSA,V?TAKE,V?WALK-TO \?L1
	IN? WINNER,BEDROOM \?L3
	MOVE WINNER,BED
?L3:	CALL PERFORM,V?SLEEP
	RTRUE
?L1:	EQUAL? PRSA,V?FIND \FALSE
	PRINTR "Why not find a bed to sleep in?"

	.FUNCT I-THIRST
	IGRTR? 'THIRST-COUNT,5 \?L1
	SET 'THIRST-COUNT,0
	CALL QUEUE,I-THIRST,40
	SET 'WINNER,PLAYER
	CALL PRINT-ID,STR?137
	CALL JIGS-UP,STR?138,0 >STACK
	RSTACK
?L1:	GET THIRST-TABLE,THIRST-COUNT >STACK
	PRINT STACK
	CRLF
	CALL QUEUE,I-THIRST,10 >STACK
	RSTACK

	.FUNCT I-HUNGER
	IGRTR? 'HUNGER-COUNT,5 \?L1
	SET 'HUNGER-COUNT,0
	CALL QUEUE,I-HUNGER,47
	SET 'WINNER,PLAYER
	CALL PRINT-ID,STR?139
	CALL JIGS-UP,STR?140,0 >STACK
	RSTACK
?L1:	GET HUNGER-TABLE,HUNGER-COUNT >STACK
	PRINT STACK
	CRLF
	CALL QUEUE,I-HUNGER,10 >STACK
	RSTACK

	.FUNCT I-TIRED,FORG=0
	IN? WINNER,BED \?L1
	PRINTI "The bed sure is comfortable and you are becoming tired."
	CRLF
	CALL V-SLEEP,1
	RETURN 2
?L1:	GRTR? LOAD-ALLOWED,10 \?L8
	SUB LOAD-ALLOWED,10 >LOAD-ALLOWED
?L8:	GRTR? FUMBLE-NUMBER,1 \?L11
	DEC 'FUMBLE-NUMBER
?L11:	INC 'FUMBLE-PROB
	GRTR? SPELL-MAX,1 \?L19
	DEC 'SPELL-MAX
	ZERO? SPELL-ROOM /?L39
	DEC 'SPELL-ROOM
	ZERO? SPELL-ROOM \?L19
?L39:	SET 'FORG,1
	CALL FORGET-SPELL,DISPEL-SPELL
?L19:	CALL QUEUE,I-TIRED,10 >STACK
	PUT STACK,0,1
	IGRTR? 'AWAKE,10 \?L23
	PRINTI "You drop in your tracks from exhaustion."
	CRLF
	CALL PRINT-ID,STR?141
	CRLF
	CALL V-SLEEP
	RETURN 2
?L23:	PRINTI "You are "
	GET TIRED-TELL,AWAKE >STACK
	PRINT STACK
	ZERO? FORG /?L32
	PRINTI " and the spells you've memorized are becoming confused"
?L32:	PRINTR "."

	.FUNCT V-DIAGNOSE
	LESS? AWAKE,0 \?L1
	PRINTI "You are wide awake"
	JUMP ?L5
?L1:	PRINTI "You are "
	GET TIRED-TELL,AWAKE >STACK
	PRINT STACK
?L5:	PRINTI ". You are "
	GET THIRST-TELL,THIRST-COUNT >STACK
	PRINT STACK
	PRINTI " and "
	GET HUNGER-TELL,HUNGER-COUNT >STACK
	PRINT STACK
	PRINTR "."

	.FUNCT V-SLEEP,TOLD?=0,TILL-TIRED,MUNGED?
	SUB MOVES,LAST-SLEEP >STACK
	SUB MOVES-PER-DAY,STACK >TILL-TIRED
	CALL PRINT-ID,STR?142
	EQUAL? HERE,REAL-STAIR,PIT \?L1
	PRINTR "To sleep here would be fatal!"
?L1:	GRTR? TILL-TIRED,10 \?L5
	PRINTR "You settle down to sleep, but you really aren't tired, so you thrash around for a while and then give up."
?L5:	EQUAL? HERE,ENGINE-ROOM,CLOSET,SE-TOWER \?L8
	PRINTR "You try to sleep but it's too noisy."
?L8:	EQUAL? HERE,BEDROOM \?L11
	IN? WINNER,BED /?L11
	ZERO? BED-WARNING \?L11
	GRTR? AWAKE,10 /?L11
	SET 'BED-WARNING,1
	PRINTR "You might try getting into the bed first. It would be more comfortable."
?L11:	GRTR? TILL-TIRED,0 \?L15
	IN? WINNER,BED \?L15
	ZERO? TOLD? \?L15
	PRINTI "You're not all that tired, but the bed is very comfortable."
	CRLF
?L15:	INC 'REAL-SPELL-MAX
	SET 'SPELL-MAX,REAL-SPELL-MAX
	SET 'SPELL-ROOM,SPELL-MAX
	SET 'LAST-SLEEP,MOVES
	ADD MOVES,MOVES-PER-SLEEP >MOVES
	ADD TOD,MOVES-PER-SLEEP >STACK
	MOD STACK,128 >TOD
	SET 'LOAD-ALLOWED,LOAD-MAX
	SET 'FUMBLE-NUMBER,7
	SET 'FUMBLE-PROB,8
	CALL QUEUE,I-TIRED,MOVES-PER-DAY >STACK
	PUT STACK,0,1
	SET 'AWAKE,-1
	CALL FORGET-ALL
	FSET? HERE,RMUNGBIT /?L20
	SET 'MUNGED?,0
	JUMP ?L21
?L20:	SET 'MUNGED?,1
?L21:	CALL I-MUNG-ROOM,0
	CALL I-MUNG-ROOM,0
	CALL I-MUNG-ROOM,0
	ZERO? MUNGED? \?L22
	FSET? HERE,RMUNGBIT \?L22
	PRINTI "You fall asleep quickly and begin to dream. The dream turns into a nightmare of decay and desolation, as your surroundings turn grey and lifeless. You feel a great weight, like a pile of ashes, constricting your movements, and then you bolt awake!"
	CRLF
	CALL PRINT-ID,STR?143
	RTRUE
?L22:	IN? WINNER,BED \?L26
	IN? BEDPOST-BUTTON,BED /?L26
	GRTR? CHARM-POINT,0 \?L26
	MOVE BEDPOST-BUTTON,BED
	PRINTR "You fall asleep quickly, the bed being so comfortable. You dream as well, of this very room. A beautiful damsel, obviously noble, is standing by the bed holding a scroll in one hand and resting the other on the bedpost. Turning to block your view, she does something you can't see. Then she gets in bed and turns out the light, but before she does you can see she is no longer carrying the scroll... You wake."
?L26:	PRINTI "Ah, sleep! It's been a long day, indeed. The rest will do you good. "
	IN? WINNER,BED \?L32
	PRINTI "You make yourself comfortable on the bed"
	JUMP ?L39
?L32:	CALL OUTSIDE?,HERE >STACK
	ZERO? STACK /?L36
	PRINTI "You spread your cloak under the open sky"
	JUMP ?L39
?L36:	PRINTI "You spread your cloak on the floor"
?L39:	PRINTI " and drift off, renewing your powers and refreshing your mind ... Time passes as you snore blissfully."
	CRLF
	CALL PRINT-ID,STR?144
	CRLF
	CALL OUTSIDE?,HERE >STACK
	ZERO? STACK /?L44
	ZERO? PROTECTED-FROM-EVIL \?L44
	RANDOM 100 >STACK
	GRTR? MOLESTED,STACK \?L44
	RANDOM 100 >STACK
	GRTR? MUNCHED,STACK \?L46
	CALL PRINT-ID,STR?145
	CALL JIGS-UP,STR?146
	RETURN 2
?L46:	CALL ROB,WINNER
	CALL ROB,HERE
	PRINTI "You don't sleep too well, and you awake at least once with the feeling that something has jostled you in the dark."
	CRLF
	CALL PRINT-ID,STR?147 >STACK
	RSTACK
?L44:	ZERO? GALLERY-POINT /?L56
	ZERO? GALLERY-DREAM \?L53
	SET 'GALLERY-DREAM,1
	PRINTI "After a while, your sleep is disturbed by a strange dream. You are wandering in a darkened place, for you have no light or other possessions. You feel that you are being watched! You are surrounded by faces, their eyes following you. They drift in and out, staring at you with proud indifference. One face, brightly lit (unlike the rest), draws you closer and closer. As you touch it, you wake."
	CRLF
	CALL PRINT-ID,STR?148 >STACK
	RSTACK
?L53:	ZERO? GALLERY-POINT /?L56
	RANDOM 100 >STACK
	GRTR? 70,STACK \?L56
	PRINTR "Your sleep is disturbed by the strange dream of an earlier night. You are in the dark, with no light or other possessions. You are surrounded by many faces, their eyes following you. The one brightly lit face beckons you closer and closer. You wake, convinced that the dream holds a message for you."
?L56:	ZERO? DOOR-KULCAD \?L82
	ZERO? DOOR-DREAM \?L59
	FSET? DOOR-REALITY,INVISIBLE \?L59
	SET 'DOOR-DREAM,1
	PRINTI "You dream of a nondescript room in which a cartoonish figure casually opens a simple wooden door and ascends the flight of stairs which lies behind. The scene fades to black, but you awaken in a cold sweat."
	CRLF
	CALL PRINT-ID,STR?149 >STACK
	RSTACK
?L59:	ZERO? DOOR-KULCAD /?L62
?L82:	ZERO? DOOR-DREAM-2 \?L62
	SET 'DOOR-DREAM-2,1
	PRINTI "You dream of climbing in an unfamiliar place. You seem to climb forever, beyond reason. A fleeting hope arises in you, and you search furiously in your spell book and possessions for something. After a moment, you become frantic as you realize that you don't have it! You bolt awake in a cold sweat."
	CRLF
	CALL PRINT-ID,STR?150 >STACK
	RSTACK
?L62:	ZERO? PROTECTED-FROM-EVIL \?L65
	RANDOM 100 >STACK
	GRTR? 50,STACK \?L65
	CALL ROB,HERE,WARLOCK-TOWER
	RANDOM 100 >STACK
	GRTR? 50,STACK \?L66
	CALL ROB,WINNER,WARLOCK-TOWER
?L66:	LOC WINNER >STACK
	EQUAL? HERE,STACK /?L69
	LOC WINNER >STACK
	CALL ROB,STACK,WARLOCK-TOWER
?L69:	PRINTI "You sleep fitfully. At one point it seems that some evil presence is searching nearby. The tense feeling passes, but it's replaced by one of foreboding."
	CRLF
	CALL PRINT-ID,STR?151 >STACK
	RSTACK
?L65:	RANDOM 100 >STACK
	GRTR? 50,STACK \?L74
	PRINTI "You sleep uneventfully, dreamlessly, and awake refreshed."
	CRLF
	CALL PRINT-ID,STR?152 >STACK
	RSTACK
?L74:	CALL PICK-ONE,DREAMS >STACK
	PRINT STACK
	PRINTR " You awaken."

	.FUNCT MACHINERY-F
	EQUAL? PRSA,V?EXAMINE \?L1
	PRINTR "The machinery is extremely noisy and complicated. Other than that, you can't imagine of what use it is to anybody."
?L1:	EQUAL? PRSA,V?AVOID \?L5
	CALL HAMMER-F
	RTRUE
?L5:	EQUAL? PRSA,V?EXEX \FALSE
	PRINTR "The machinery may or may not have been sped up, the facts being hard to determine."

	.FUNCT ENGINE-ROOM-F,RARG
	EQUAL? RARG,M-LOOK \FALSE
	PRINTI "The room is filled with noise: crashing and smashing, gurgling of water, grinding of gears, and horrible screeching of metal. Huge devices of obscure purpose provide these effects. The most notable is a huge hammer that smashes continually against the stone floor: it makes any crossing of the room a dangerous enterprise. The whole construction brings to mind the words ""Infernal Machine."" Far off to the southeast is another room."
	IN? DISPEL-SCROLL,CLOSET \?L5
	PRINTI " You can barely make out something on the floor of that room. It might be a scroll, but from here you can't tell for sure."
?L5:	CRLF
	IN? TURTLE,CLOSET \TRUE
	PRINTR "Across the room you can see the rainbow turtle, who frequently looks your way."

	.FUNCT HAMMER-F
	EQUAL? PRSA,V?WALK-AROUND,V?AVOID \?L1
	PRINTR "It's hard to see how you'll avoid a painful experience."
?L1:	EQUAL? PRSA,V?EXEX \FALSE
	SET 'HAMMER-EXEX,1
	PRINTR "The crashing of the hammer has become more frequent."

	.FUNCT SE-TOWER-F,RARG=0
	EQUAL? RARG,M-BEG \FALSE
	EQUAL? PRSA,V?WALK \FALSE
	EQUAL? PRSO,P?UP \?L3
	CALL QUEUE,I-CRASH,2 >STACK
	PUT STACK,0,1
	RFALSE
?L3:	CALL INT,I-CRASH >STACK
	PUT STACK,0,0
	RFALSE

	.FUNCT LIGHTS-F
	EQUAL? PRSA,V?EXAMINE,V?READ \FALSE
	PRINTR "The lights and displays hold no meaning for you. A random number generator may be controlling the whole thing, for all you know."

	.FUNCT I-CRASH
	LOC PLAYER >STACK
	EQUAL? STACK,ENGINE-ROOM,CLOSET,SE-TOWER /?L1
	CALL INT,I-CRASH >STACK
	PUT STACK,0,0
	RFALSE
?L1:	ZERO? CRASH? \?L4
	SET 'CRASH?,1
	JUMP ?L5
?L4:	SET 'CRASH?,0
?L5:	ZERO? CRASH? \?L8
	ZERO? HAMMER-EXEX /?L6
?L8:	PRINTI """Crash!"" A huge hammer smashes against the stone floor"
	IN? PLAYER,CLOSET \?L11
	PRINTI " outside"
?L11:	PRINTI "."
	CRLF
?L6:	ZERO? FAST? \?L21
	ZERO? HAMMER-EXEX /?L19
?L21:	PUSH 1
	JUMP ?L22
?L19:	PUSH 2
?L22:	CALL QUEUE,I-CRASH,STACK >STACK
	PUT STACK,0,1
	RTRUE

	.FUNCT CROSS-ENGINE-ROOM
	EQUAL? HASTED?,WINNER \?L1
	SET 'FAST?,1
	EQUAL? WINNER,TURTLE \?L3
	PRINTI "As the turtle starts across, he seems to set off something, for the machinery speeds up and the noise level becomes almost unbearable. Luckily, he makes it to the other side safely!"
	CRLF
	RETURN CLOSET
?L3:	PRINTI "You zip across the room easily, but you must have touched something dangerous along the way, because the machinery speeds up, going faster and faster."
	CRLF
	RETURN CLOSET
?L1:	EQUAL? WINNER,TURTLE \?L10
	CALL INT,I-TURTLE >STACK
	PUT STACK,0,0
	PRINTI "The poor turtle starts, but he's just too slow. About halfway across the room he is dispatched by the enormous hammer, leaving only a rainbow colored smudge on the floor."
	CALL PRINT-ID,STR?153
	EQUAL? DEATH-CHEATED,TURTLE \?L13
	SET 'DEATH-CHEATED,0
	CRLF
	CRLF
	PRINTI "But wait! Amazingly, the smudge reforms into a turtle again! The revived turtle just has time to turn his head in wonderment when the hammer smashes down again, remaking the rainbow smudge."
	CALL PRINT-ID,STR?154
?L13:	PRINTI " Even that disappears at the next blow of the hammer."
	CRLF
	CALL JIGS-UP,0,0
	RFALSE
?L10:	ZERO? FAST? \?L21
	ZERO? CRASH? /?L20
?L21:	PRINTI "You start across the room, but less than halfway across, the huge hammer crashes down, right on top of you!"
	CRLF
	CALL PRINT-ID,STR?155
	EQUAL? DEATH-CHEATED,ME \?L24
	PRINTI "Startlingly, you revive from this fatal blow, but even more startlingly, the first thing you see is the same huge hammer descending upon you!"
	CRLF
	CALL PRINT-ID,STR?156
?L24:	CALL JIGS-UP,0,0
	RFALSE
?L20:	SET 'FAST?,1
	PRINTI "You make it across the room, but just barely; just as you duck through the door, a huge hammer crashes down behind, missing by an inch. Something you stepped on along the way clicked as well, and with a horrible screeching noise, the machinery speeds up, crashing faster and faster until it's twice as fast as before."
	CRLF
	CRLF
	RETURN CLOSET

	.FUNCT RECROSS-ENGINE-ROOM
	EQUAL? WINNER,TURTLE \?L1
	EQUAL? HASTED?,TURTLE \?L3
	IN? DISPEL-SCROLL,CLOSET \?L5
	SET 'TURTLE-REPORT?,1
?L5:	PRINTI "The turtle fairly zips across the engine room, dodging the giant hammers and gears. Suddenly he sets off a trap, and sharp spears fly at him from all directions! But they bounce harmlessly off his shell! He avoids one last crash of a huge hammer, but even at his speed, it's a near thing! With one more burst of speed, he reaches "
	IN? PLAYER,ENGINE-ROOM \?L10
	PUSH STR?157
	JUMP ?L12
?L10:	PUSH STR?158
?L12:	PRINT STACK
	PRINTI " safely!"
	CRLF
	RETURN ENGINE-ROOM
?L3:	CALL INT,I-TURTLE >STACK
	PUT STACK,0,0
	PRINTI "The turtle starts across the room, as hammers and gears slowly turn and crash. Partway across the room, he sets off a trap! Spears fly at him from all directions! They just bounce off his shell, and he is unhurt. Unfortunately, at about this time, a enormous hammer smashes down. This does not bounce off his shell, and the poor creature expires."
	CRLF
	CALL PRINT-ID,STR?159
	EQUAL? DEATH-CHEATED,TURTLE \?L16
	PRINTI "Astoundingly, the turtle renews himself! Unfortunately, he makes it no further, for the hammer is still too much for even his armor."
	CRLF
	CALL PRINT-ID,STR?160
?L16:	CALL JIGS-UP,0,0
	RFALSE
?L1:	IN? DISPEL-SCROLL,WINNER \?L22
	REMOVE DISPEL-SPELL
	REMOVE DISPEL-SCROLL
?L22:	EQUAL? HASTED?,WINNER \?L25
	PRINTI "You rush across the engine room, your speed enabling you to avoid the gigantic hammers and gears; at this speed they appear to move with great deliberation. Unfortunately, you set off a trap, and many sharp spears fly at you from all directions! They seem to move pretty fast. Too fast, in fact. You can't dodge them, and you are severely skewered."
	JUMP ?L29
?L25:	PRINTI "You run across the room, trying to dodge the crashing machinery, and you are succeeding for a while until you set off a trap. A volley of sharp spears, powered by cunning machinery, comes at you from all directions. You are skewered! The huge hammer crashes down for the coup de grace."
?L29:	CRLF
	EQUAL? DEATH-CHEATED,ME \?L32
	PRINTI "In an astounding feat of magic, you are reassembled and revived. In an even more astounding feat of trap design, you are dispatched again almost before you can take a breath."
	CRLF
?L32:	CALL PRINT-ID,STR?161
	CALL JIGS-UP,0,0
	RFALSE

	.FUNCT WAVES-F
	EQUAL? PRSA,V?THROUGH,V?SWIM \FALSE
	PRINTI "Don't press your luck. You'd probably drown."
	CRLF
	CALL PRINT-ID,STR?162 >STACK
	RSTACK

	.FUNCT SEA-STUFF-F
	EQUAL? PRSA,V?EXAMINE \?L1
	PRINTR "There's nothing much interesting to see."
?L1:	EQUAL? PRSA,V?TAKE \FALSE
	PRINTR "Why bother?"

	.FUNCT NO-RESPONSE
	PRINTR "You hear no response."

	.FUNCT TURTLE-F,NEAR?
	LOC PLAYER >STACK
	IN? TURTLE,STACK /?L1
	SET 'NEAR?,0
	JUMP ?L2
?L1:	SET 'NEAR?,1
?L2:	EQUAL? WINNER,TURTLE \?L3
	MOVE GLOBAL-TURTLE,GLOBAL-OBJECTS
	ZERO? TURTLE-TIRED? /?L5
	ZERO? NEAR? /?L7
	PRINTR "The turtle is asleep and appears oblivious to your words."
?L7:	CALL NO-RESPONSE
	RTRUE
?L5:	CALL QUEUE,I-TURTLE,-1 >STACK
	PUT STACK,0,1
	FSET TURTLE,TOUCHBIT
	EQUAL? TALK-TO-ANIMAL?,TURTLE /?L13
	ZERO? NEAR? /?L15
	PRINTI "The turtle looks at you quizzically. It's clear he would like to understand you, but he doesn't. He responds, but it's only snaps, hisses, and clicks to you."
	CRLF
	JUMP ?L19
?L15:	CALL NO-RESPONSE
?L19:	SET 'P-CONT,0
	SET 'QUOTE-FLAG,0
	RTRUE
?L13:	EQUAL? PRSA,V?WALK \?L20
	SET 'TURTLE-FOLLOWS,0
	INC 'TF-COUNT
	IN? TURTLE,INSIDE-GATE \?L21
	EQUAL? PRSO,P?WEST \?L21
	SET 'P-CONT,0
	SET 'QUOTE-FLAG,0
	PRINTR """Uh, no thanks. I prefer to stay near my beach. I don't see much yummy seaweed out that way."""
?L21:	IN? TURTLE,DIM-DESCENT \?L25
	EQUAL? PRSO,P?DOWN,P?SOUTH \?L25
	SET 'P-CONT,0
	SET 'QUOTE-FLAG,0
	PRINTR """Uh, no thanks. It looks dark and scary down there, and I get a kind of bad feeling about it, like you get when you eat old seaweed."""
?L25:	EQUAL? PRSO,P?UP \?L28
	LOC TURTLE >STACK
	CALL GLOBAL-IN?,STAIRS,STACK >STACK
	ZERO? STACK /?L28
	ZERO? NEAR? /FALSE
	PRINTI "The turtle huffs and puffs up the stairs. ""Pretty steep stairs for a turtle, friend..."""
	CRLF
	RFALSE
?L28:	EQUAL? PRSO,P?DOWN \?L34
	LOC TURTLE >STACK
	CALL GLOBAL-IN?,STAIRS,STACK >STACK
	ZERO? STACK /?L34
	ZERO? NEAR? /?L35
	PRINTI """Those stairs are pretty steep. I'll follow you down, but I'm not going alone!"""
	CRLF
?L35:	SET 'P-CONT,0
	SET 'QUOTE-FLAG,0
	RTRUE
?L34:	GRTR? TF-COUNT,4 \FALSE
	MOD TF-COUNT,6 >STACK
	ZERO? STACK \FALSE
	CALL TURTLE-TIRES
	RFALSE
?L20:	EQUAL? PRSA,V?WHO \?L42
	ZERO? NEAR? /?L43
	PRINTR """Never heard of him."""
?L43:	CALL NO-RESPONSE >STACK
	RSTACK
?L42:	EQUAL? PRSA,V?THANK \?L48
	CALL TURTLE-THANKS,NEAR? >STACK
	RSTACK
?L48:	EQUAL? PRSA,V?STAY \?L49
	EQUAL? PRSO,GLOBAL-ROOM,0 \?L49
	SET 'TURTLE-FOLLOWS,0
	ZERO? NEAR? /?L50
	PRINTR "The turtle hisses, ""Okay, I'll stay here for a while."""
?L50:	CALL NO-RESPONSE >STACK
	RSTACK
?L49:	EQUAL? PRSA,V?FOLLOW \?L55
	EQUAL? PRSO,ME,0 \?L56
	SET 'TURTLE-FOLLOWS,1
	SET 'TF-COUNT,0
	SET 'TURTLE-TIRED-TELL,0
	ZERO? NEAR? /?L58
	PRINTR "The turtle hisses, ""I will follow you."""
?L58:	CALL NO-RESPONSE >STACK
	RSTACK
?L56:	ZERO? NEAR? /?L63
	PRINTR "The turtle hisses, ""I'd follow you, but not that!"""
?L63:	CALL NO-RESPONSE >STACK
	RSTACK
?L55:	EQUAL? PRSA,V?BRING,V?TAKE \?L67
	LOC PLAYER >STACK
	IN? TURTLE,STACK /?L67
	EQUAL? PRSA,V?BRING \?L68
	SET 'PRSO,PRSI
	SET 'PRSI,0
?L68:	CALL ITAKE,0
	EQUAL? PRSA,V?BRING \?L71
	EQUAL? HERE,CLOSET \?L73
	PUSH P?NW
	JUMP ?L75
?L73:	PUSH P?SE
?L75:	CALL DO-WALK,STACK
	RTRUE
?L71:	EQUAL? HERE,CLOSET \TRUE
	IN? PLAYER,ENGINE-ROOM \TRUE
	PRINTI "The turtle sticks his head through the door across the mechanical wasteland."
	IN? DISPEL-SCROLL,TURTLE \?L81
	PRINTI " In his mouth is a scroll of some sort."
?L81:	CRLF
	RTRUE
?L67:	EQUAL? PRSA,V?TAKE \?L87
	FSET? PRSO,SCROLLBIT /FALSE
	ZERO? NEAR? /?L90
	PRINTR """I don't think I can carry that too easily."""
?L90:	CALL NO-RESPONSE >STACK
	RSTACK
?L87:	EQUAL? PRSA,V?OPEN \?L96
	FSET? PRSO,DOORBIT \?L96
	ZERO? NEAR? /?L97
	PRINTR """I can't reach the latch. I'm a turtle, not an ostrich."""
?L97:	CALL NO-RESPONSE >STACK
	RSTACK
?L96:	EQUAL? PRSA,V?HELLO \?L102
	ZERO? NEAR? /?L103
	PRINTI """"
	CALL PICK-ONE,TURTLE-REMARKS >STACK
	PRINT STACK
	PRINTR """"
?L103:	CALL NO-RESPONSE >STACK
	RSTACK
?L102:	LOC PLAYER >STACK
	IN? TURTLE,STACK /?L109
	LOC PLAYER >STACK
	LOC STACK >STACK
	IN? TURTLE,STACK \?L108
?L109:	PRINTR """I'm only a turtle, you know, even if I can talk!"""
?L108:	CALL NO-RESPONSE
	RTRUE
?L3:	EQUAL? PRSA,V?TELL \?L113
	EQUAL? PRSO,GLOBAL-TURTLE \?L140
	ZERO? TURTLE-TIRED? /?L114
	PRINTI "The turtle remains asleep."
	CRLF
	SET 'P-CONT,0
	SET 'QUOTE-FLAG,0
	RETURN 2
?L114:	CALL OPPOSITE-SIDES? >STACK
	ZERO? STACK /?L120
	SET 'P-CONT,0
	SET 'QUOTE-FLAG,0
	PRINTR "The turtle seems to bend its head as if to listen, but with all this noise it's not very likely that he hears you."
?L120:	SET 'P-MERGED,1
	CALL GLOBAL-NOT-HERE-PRINT,GLOBAL-TURTLE
	RTRUE
?L113:	EQUAL? PRSO,GLOBAL-TURTLE \?L140
	EQUAL? PRSA,V?YELL,V?WAVE-AT \?L124
	CALL OPPOSITE-SIDES? >STACK
	ZERO? STACK /?L124
	PRINTI "The turtle takes notice, "
	EQUAL? HERE,CLOSET \?L127
	PRINTR "then glances at the rapidly pounding hammer. With a motion which might correspond to a shrug of the shoulder, he turns away, embarrassed."
?L127:	PRINTI "nods his head, and starts in your direction."
	CRLF
	SET 'WINNER,TURTLE
	LOC TURTLE >HERE
	EQUAL? HERE,CLOSET \?L134
	PUSH P?NW
	JUMP ?L136
?L134:	PUSH P?SE
?L136:	CALL DO-WALK,STACK
	RTRUE
?L124:	EQUAL? PRSO,GLOBAL-TURTLE \?L140
	EQUAL? PRSA,V?EXAMINE \?L137
	CALL OPPOSITE-SIDES? >STACK
	ZERO? STACK /?L137
	PRINTR "He is standing on the other side of the machinery."
?L137:	EQUAL? PRSO,GLOBAL-TURTLE \?L140
	CALL GLOBAL-NOT-HERE-PRINT,GLOBAL-TURTLE
	RTRUE
?L140:	EQUAL? PRSA,V?THROUGH,V?CLIMB-FOO,V?CLIMB-UP \?L141
	PRINTI "The turtle doesn't allow you to get on his back."
	CRLF
	CALL PRINT-ID,STR?163 >STACK
	RSTACK
?L141:	EQUAL? PRSA,V?RUB \?L144
	PRINTI "The turtle seems to appreciate the attention."
	CRLF
	CALL PRINT-ID,STR?164 >STACK
	RSTACK
?L144:	EQUAL? PRSA,V?CLEESH \?L147
	PRINTR "As he is already a reptile, the spell has little effect."
?L147:	EQUAL? PRSA,V?CLOSE,V?OPEN \?L150
	PRINTR "Come now, you can't do that!"
?L150:	EQUAL? PRSA,V?REZROV \?L153
	PRINTI "The turtle's shell pops off his back. Mortified, he retrieves it."
	CRLF
	CALL PRINT-ID,STR?165 >STACK
	RSTACK
?L153:	EQUAL? PRSA,V?GUNCHO \?L156
	ZERO? TURTLE-TIRED? /?L157
	PRINTI "The sleeping turtle seems to shrink to nothing, and vanishes!"
	CRLF
	JUMP ?L161
?L157:	PRINTI "The turtle barely has time to retract his head before he is consumed in flame!"
	CRLF
?L161:	CALL PRINT-ID,STR?166
	REMOVE TURTLE
	RTRUE
?L156:	EQUAL? PRSA,V?VAXUM \?L164
	ZERO? TURTLE-TIRED? /?L165
	PRINTR "The snoring sounds more friendly."
?L165:	PRINTR "The turtle seems to make a friendly gesture, but then again turtles are pretty friendly anyway."
?L164:	EQUAL? PRSA,V?MUNG \?L172
	PRINTI "The turtle's shell is so thick and hard that your blow has no effect. The lovely colors on his back are not even marred."
	CALL PRINT-ID,STR?167
	ZERO? TURTLE-TIRED? /?L175
	PRINTR " He doesn't even wake up."
?L175:	PRINTR " He does withdraw into his shell briefly, but then emerges again."
?L172:	ZERO? TURTLE-TIRED? /?L182
	PRINTI "The turtle remains asleep."
	CRLF
	SET 'P-CONT,0
	RETURN 2
?L182:	EQUAL? PRSA,V?THANK \?L187
	EQUAL? TALK-TO-ANIMAL?,TURTLE \?L187
	CALL TURTLE-THANKS,1 >STACK
	RSTACK
?L187:	EQUAL? PRSA,V?TAKE \?L188
	EQUAL? TURTLE,PRSO \?L188
	PRINTR "The turtle is much too large to take."
?L188:	EQUAL? PRSA,V?GIVE \?L191
	PRINTI "The turtle extends his head towards the "
	PRINTD PRSO
	PRINTR ", but decides it's not very interesting, and withdraws."
?L191:	EQUAL? PRSA,V?HELLO \FALSE
	PRINTI """"
	CALL PICK-ONE,TURTLE-REMARKS >STACK
	PRINT STACK
	PRINTR """"

	.FUNCT TURTLE-THANKS,NEAR?
	ZERO? TURTLE-POINT \?L1
	MOVE TURTLE,BEACH
	ZERO? NEAR? /?L3
	PRINTR """Glad to be of help. I think I'll get back to the beach, now."" The turtle departs."
?L3:	PRINTR "There is no response."
?L1:	ZERO? NEAR? /?L10
	PRINTR """You're very welcome! It's nice to have someone to talk to for a change."""
?L10:	CALL NO-RESPONSE
	RTRUE

	.FUNCT OPPOSITE-SIDES?
	EQUAL? HERE,ENGINE-ROOM,CLOSET \FALSE
	LOC TURTLE >STACK
	EQUAL? STACK,ENGINE-ROOM,CLOSET \FALSE
	LOC TURTLE >STACK
	EQUAL? HERE,STACK \TRUE
	RFALSE

	.FUNCT I-TURTLE,LP
	LOC PLAYER >LP
	FSET TURTLE,TOUCHBIT
	ZERO? TURTLE-FOLLOWS /?L1
	IN? TURTLE,LP /?L1
	INC 'TF-COUNT
	EQUAL? LP,WEST-CASTLE,DUNGEON,BED \?L3
	SET 'TURTLE-FOLLOWS,0
	PRINTR "The turtle won't follow any further."
?L3:	EQUAL? LP,CLOSET \?L9
	IN? TURTLE,ENGINE-ROOM /?L8
?L9:	EQUAL? LP,ENGINE-ROOM \?L7
	IN? TURTLE,CLOSET \?L7
?L8:	SET 'TURTLE-FOLLOWS,0
	PRINTR "The turtle seems hesitant to follow you across the room. He looks at you as if he wants an explicit order."
?L7:	MOVE TURTLE,LP
	EQUAL? LP,ENDLESS-STAIR \?L13
	PRINTI "You notice that the turtle is no longer following you. In fact, he seems to have vanished entirely."
	CRLF
	REMOVE TURTLE
	CALL QUEUE,I-TURTLE,0
	SET 'TURTLE-FOLLOWS,0
	RTRUE
?L13:	EQUAL? LP,ENGINE-ROOM \?L17
	PRINTR """Pretty steep stairs for a turtle, friend. But if you say so..."""
?L17:	EQUAL? HASTED?,TURTLE \?L20
	PRINTR "The turtle, moving with terrific speed, follows you."
?L20:	GRTR? TF-COUNT,4 \?L23
	CALL TURTLE-TIRES >STACK
	RSTACK
?L23:	PRINTR "The turtle, at his own leisurely pace, follows you."
?L1:	ZERO? TURTLE-REPORT? /?L27
	LOC TURTLE >STACK
	IN? PLAYER,STACK \?L27
	SET 'TURTLE-REPORT?,0
	PRINTR "The returned turtle reports that the door across the way opens into a room with much magic in it: bright lights and other things he doesn't understand too well. He says there is an object of rolled paper lying on the floor as well."
?L27:	IN? DISPEL-SCROLL,TURTLE \FALSE
	IN? TURTLE,LP \FALSE
	EQUAL? HERE,CLOSET /FALSE
	MOVE DISPEL-SCROLL,LP
	CALL THIS-IS-IT,DISPEL-SCROLL
	ADD SCORE,TURTLE-POINT >SCORE
	SET 'TURTLE-POINT,0
	PRINTR "The turtle drops a brittle scroll at your feet. ""Not bad, huh?"""

	.FUNCT TURTLE-TIRES
	ZERO? TURTLE-FOLLOWS /FALSE
	GRTR? TF-COUNT,20 \?L4
	SET 'TURTLE-TIRED?,1
	SET 'TURTLE-FOLLOWS,0
	CALL INT,I-TURTLE >STACK
	PUT STACK,0,0
	PRINTR "The turtle has closed his shell, and fallen asleep. A quiet snoring sound issues from somewhere within."
?L4:	ZERO? TURTLE-TIRED-TELL \?L8
	SET 'TURTLE-TIRED-TELL,1
	PRINTR """How long do you expect me to follow you around, anyway? I'm getting kind of tired, too. You would if you had a shell as heavy as mine. It's all right for now, though."""
?L8:	PRINTR "The turtle, at his own leisurely pace, follows you."

	.FUNCT WEST-CASTLE-F,RARG
	EQUAL? RARG,M-LOOK \FALSE
	PRINTI "You are outside the western entrance to the castle. To the east stands an iron gate which is "
	FSET? IRON-GATE,OPENBIT \?L5
	PRINTI "wide open"
	JUMP ?L9
?L5:	PRINTI "closed and chained"
?L9:	PRINTR ". A winding road starts here and proceeds to the west."

	.FUNCT UNDERGROWTH-F
	EQUAL? PRSA,V?EXAMINE \?L1
	PRINTR "The undergrowth is thick. You would never get through it."
?L1:	EQUAL? PRSA,V?MUNG,V?CUT \FALSE
	PRINTI "You could spend a few days doing this without much progress."
	CRLF
	CALL PRINT-ID,STR?168 >STACK
	RSTACK

	.FUNCT PATH-SIGN-F
	EQUAL? PRSA,V?READ,V?EXAMINE \FALSE
	CALL FIXED-FONT-ON
	PRINTI "
  - Shady Brook Trail -

    Old Lingolf House
        1000 feet
"
	CALL FIXED-FONT-OFF
	RTRUE

	.FUNCT FOUNDATION-F
	EQUAL? PRSA,V?THROUGH \?L1
	PRINTI "No way."
	CRLF
	CALL PRINT-ID,STR?169 >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?WHO \?L5
	PRINTR "There's no way of knowing."
?L5:	EQUAL? PRSA,V?LOOK-INSIDE,V?SEARCH \FALSE
	PRINTR "There is nothing but stone there."

	.FUNCT DISTANT-CASTLE-F
	EQUAL? PRSA,V?EXAMINE \?L1
	PRINTR "The castle is far to the east and flanked by dark towers. From this distance, not much detail can be discerned."
?L1:	EQUAL? PRSA,V?WALK-TO \FALSE
	PRINTR "There's no direct path from here, although roads lead there. Try specifying a compass direction in order to move around."

	.FUNCT SHACK-OBJ-F
	EQUAL? PRSA,V?THROUGH \?L1
	EQUAL? HERE,SHACK-ROOM \?L1
	CALL GOTO,SHACK
	RTRUE
?L1:	EQUAL? PRSA,V?DROP \FALSE
	EQUAL? HERE,SHACK \FALSE
	CALL GOTO,SHACK-ROOM
	RTRUE

	.FUNCT BATTERED-LANTERN-F
	EQUAL? PRSA,V?ERASE-LINE \?L1
	PRINTR "Aladdin you're not."
?L1:	EQUAL? PRSA,V?LAMP-ON \?L5
	PRINTR "The lamp seems to be broken, most likely beyond repair."
?L5:	EQUAL? PRSA,V?EXAMINE \?L8
	PRINTR "The lamp is made of brass and is old and battered. It doesn't seem likely that any use can be made of it."
?L8:	EQUAL? PRSA,V?LAMP-OFF \FALSE
	FSET? PRSO,ONBIT /FALSE
	PRINTR "It isn't on!"

	.FUNCT SHACK-STUFF
	EQUAL? PRSA,V?PUT \FALSE
	EQUAL? PRSI,PSEUDO-OBJECT \FALSE
	PRINTR "They are overturned and don't make good surfaces."

	.FUNCT SHACK-OVEN-F
	EQUAL? PRSA,V?LAMP-OFF,V?LAMP-ON \?L1
	PRINTR "It's not working."
?L1:	EQUAL? PRSA,V?EXAMINE \FALSE
	PRINTR "Strangely, the oven is still slightly warm, as if it had been used recently."

	.FUNCT BREAD-F,AMT,S
	EQUAL? PRSA,V?EXAMINE \?L1
	PRINTI "There's "
	GETP BREAD,P?SIZE >STACK
	GET BREAD-EXAMINES,STACK >STACK
	PRINT STACK
	PRINTR " left."
?L1:	EQUAL? PRSA,V?EAT \?L5
	CALL INT,I-HUNGER >STACK
	GET STACK,C-TICK >S
	GRTR? S,60 \?L6
	PRINTR "You aren't the least bit hungry."
?L6:	GETP BREAD,P?SIZE >STACK
	SUB STACK,1 >AMT
	PUTP BREAD,P?SIZE,AMT
	ADD SCORE,EAT-POINT >SCORE
	SET 'EAT-POINT,0
	PRINTI "Mmm. That tasted great! "
	CALL PRINT-ID,STR?170
	GET BREAD-AMTS,AMT >STACK
	PRINT STACK
	CRLF
	ZERO? AMT \?L15
	REMOVE BREAD
?L15:	ADD S,47 >STACK
	CALL QUEUE,I-HUNGER,STACK
	SET 'HUNGER-COUNT,0
	RTRUE
?L5:	EQUAL? PRSA,V?BURN \?L18
	EQUAL? PRSI,ETERNAL-FLAME \?L18
	PRINTR "Toast without jam? What a silly idea!"
?L18:	EQUAL? PRSA,V?MUNG,V?CUT \FALSE
	EQUAL? PRSI,MAGIC-KNIFE \FALSE
	PRINTR "It seems silly to cut up your bread when it's more easily carried in one piece. Besides, you might get crumbs all over your spell book."

	.FUNCT TREES-F
	EQUAL? PRSA,V?CLIMB-FOO,V?CLIMB-UP \?L1
	PRINTI "The trees are not suitable for climbing."
	CRLF
	CALL PRINT-ID,STR?171 >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?EXAMINE \FALSE
	FSET? HERE,RMUNGBIT \?L6
	PRINTR "The trees are short and stunted and covered in a thick, grey ash. The roots themselves are blackened and foul-smelling."
?L6:	PRINTR "The trees are mostly short and stunted."

	.FUNCT HOVEL-F
	EQUAL? HERE,VILLAGE \FALSE
	EQUAL? PRSA,V?WALK-TO,V?THROUGH \FALSE
	CALL DO-WALK,P?SOUTH
	RTRUE

	.FUNCT HOVEL-KLUDGE
	PRINTI "It is dark and smoky in here, but this is a place of great disorder, and its odor is indescribable. A pile of rags sits near a small pot which is bubbling and steaming over a tiny fire. The pile of rags sports a gnarled hand which busies itself with the noisome stew. A closer look reveals a withered crone at the other end of the hand."
	CRLF
	ZERO? CRONE-MOVE \?L3
	CRLF
	PRINTI "The creature looks you over keenly and speaks: ""I should have thought they would send someone more ... more ..."" She laughs in an unsettling way. ""They've all left! A great storm is brewing in the east, my friend, and all have fled before it!"" She starts to chuckle. ""Take this and begone!"" With a wave of her hand, you find yourself reeling out of the door of the hovel, holding some sort of scroll in your hand."
	CRLF
	MOVE OPEN-SCROLL,WINNER
	SET 'CRONE-MOVE,MOVES
	RFALSE
?L3:	SUB MOVES,CRONE-MOVE >STACK
	LESS? STACK,20 \?L7
	PRINTI "As you enter the crone's hovel, she booms at you: ""Are you here again? What a wizard!"" Her emphasis on the word ""wizard"" is filled with derision. ""Make a small effort, would you, to make your Circle proud of you?"" The same horrible emphasis on ""proud"" fills you with revulsion. ""Go!"" You find yourself back in the village."
	CRLF
	CALL PRINT-ID,STR?172
	RFALSE
?L7:	SET 'CRONE-MOVE,MOVES
	PRINTI "As you enter, the woman in rags wags her head slowly. ""You've returned, have you? You need help perhaps? Well, I've given you all the help in my meager store. You want more? Leave me!"" You find yourself in the village."
	CRLF
	CALL PRINT-ID,STR?173
	RFALSE

	.FUNCT GLOBAL-CRONE-F
	EQUAL? PRSA,V?ZIFMIA \?L1
	PRINTR "Slowly, the old woman, swathed in rags, appears before you. She seems to be staring through you and speaks slowly and sullenly: ""I thought I might see you again, my friend! I gave you all the aid that I can. The rest is up to you..."" She disappears."
?L1:	EQUAL? PRSA,V?EXAMINE \?L5
	PRINTR "The crone was presumably the village wise woman and its last remaining inhabitant."
?L5:	PRINTR "The crone isn't here."

	.FUNCT LONG-ROAD-F,RARG
	EQUAL? RARG,M-LOOK \FALSE
	PRINTI "You are walking along the road. It wends its way through low hills, sparse forests, and occasional subsistence farms. To the west, things seem lighter and more pleasant. To the east they seem oppressive and dark. A worn sign sits beside the road here."
	EQUAL? ROAD-LOC,ROAD-START \?L5
	PRINTI " The deserted village is to the east."
?L5:	CRLF
	RTRUE

	.FUNCT FARM-PSEUDO
	EQUAL? PRSA,V?THROUGH,V?EXAMINE \FALSE
	PRINTR "It's a poor, run-down farm, and not of interest."

	.FUNCT LONG-ROAD-SIGN-F
	EQUAL? PRSA,V?READ,V?EXAMINE \FALSE
	SUB ROAD-LOC,ROAD-START >STACK
	GRTR? STACK,11 \?L3
	PRINTR "The sign is too worn to be read."
?L3:	PRINTI """"
	SUB ROAD-LOC,ROAD-START >STACK
	GET SIGN-TBL,STACK >STACK
	PRINT STACK
	PRINTR """"

	.FUNCT LONG-ROAD-EXIT-F
	EQUAL? ROAD-LOC,ROAD-START \?L1
	EQUAL? PRSO,P?EAST \?L1
	RETURN WEST-FORK
?L1:	FCLEAR LONG-ROAD,TOUCHBIT
	CALL ROAD-TO-TABLE,ROAD-LOC
	EQUAL? PRSO,P?WEST \?L4
	INC 'ROAD-LOC
	JUMP ?L6
?L4:	EQUAL? PRSO,P?EAST \?L6
	DEC 'ROAD-LOC
?L6:	CALL TABLE-TO-ROAD,ROAD-LOC
	RETURN LONG-ROAD

	.FUNCT ROAD-TO-TABLE,SLOC,TBL,CNT=0,F,N
	FIRST? LONG-ROAD >F /?L1
?L1:	SET 'TBL,ROAD-TABLE
?L2:	ZERO? F /TRUE
	NEXT? F >N /?L7
?L7:	EQUAL? F,WINNER /?L12
	FSET? F,TAKEBIT \?L12
?L11:	GET TBL,CNT >STACK
	ZERO? STACK \?L13
	PUT TBL,CNT,SLOC
	ADD CNT,1 >STACK
	PUT TBL,STACK,F
	ADD CNT,2 >CNT
	REMOVE F
	JUMP ?L12
?L13:	ADD CNT,2 >CNT
	JUMP ?L11
?L12:	SET 'F,N
	JUMP ?L2

	.FUNCT TABLE-TO-ROAD,SLOC,TBL,CNT=0
	SET 'TBL,ROAD-TABLE
?L1:	LESS? CNT,ROAD-TABLE-LENGTH \TRUE
	GET TBL,CNT >STACK
	EQUAL? STACK,SLOC \?L5
	PUT TBL,CNT,0
	ADD CNT,1 >STACK
	GET TBL,STACK >STACK
	MOVE STACK,LONG-ROAD
?L5:	ADD CNT,2 >CNT
	JUMP ?L1

	.FUNCT ROAD-F
	EQUAL? PRSA,V?TAKE,V?FOLLOW \?L1
	PRINTR "You should supply a compass direction in which to follow the path."
?L1:	EQUAL? PRSA,V?DROP \FALSE
	CALL OUTSIDE?,HERE >STACK
	ZERO? STACK /?L6
	PRINTR "It's much safer to stay on the path, especially in these times."
?L6:	PRINTR "You'll have to give a direction."

	.FUNCT HILLS-F
	EQUAL? PRSA,V?EXAMINE \?L1
	PRINTR "The hills are mostly low and shrouded in a fine mist-like haze. They stretch out mainly to the west."
?L1:	EQUAL? PRSA,V?CLIMB-FOO,V?CLIMB-UP \FALSE
	CALL PERFORM,V?LEAVE,ROAD
	RTRUE

	.FUNCT MOUNTAIN-F
	EQUAL? PRSA,V?LEAP \?L1
	EQUAL? HERE,VISTA \?L1
	CALL PRINT-ID,STR?174
	CALL JIGS-UP,STR?175 >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?CLIMB-UP,V?CLIMB-FOO \?L3
	EQUAL? HERE,VISTA \?L4
	PRINTR "You are here!"
?L4:	EQUAL? HERE,VILLAGE,MOUNTAIN-TRAIL \?L8
	CALL DO-WALK,P?UP >STACK
	RSTACK
?L8:	PRINTR "There's no way up the mountain from here."
?L3:	EQUAL? PRSA,V?EXAMINE \FALSE
	PRINTR "The mountain is tall and proud, and its shining peak stands above the low-hanging clouds."

	.FUNCT OUTSIDE?,RM
	FSET? RM,LIGHTBIT \FALSE
	EQUAL? RM,SHACK,INSIDE-GATE,PEBBLED-PATH /FALSE
	EQUAL? RM,COURTYARD-1,COURTYARD-2,COURTYARD-3 /FALSE
	EQUAL? RM,COURTYARD-4,COURTYARD-5,COURTYARD-6 /FALSE
	EQUAL? RM,COURTYARD-7 /FALSE
	EQUAL? RM,SHACK-ROOM,BEDROOM \TRUE
	RFALSE

	.FUNCT I-SCURRY
	RANDOM 20 >STACK
	ADD 15,STACK >STACK
	CALL QUEUE,I-SCURRY,STACK >STACK
	PUT STACK,0,1
	RANDOM 100 >STACK
	GRTR? 25,STACK \FALSE
	CALL OUTSIDE?,HERE >STACK
	ZERO? STACK /?L3
	LESS? NIGHTFALL,70 \?L5
	RANDOM 100 >STACK
	GRTR? 50,STACK \?L5
	PRINTR "You hear noises in the brambles. Snorting noises are followed by loud crashing and finally a hideous squeal of triumph."
?L5:	PRINTR "You hear a rustling in the brambles nearby, and you catch a glimpse of something small and furry as it scurries away."
?L3:	EQUAL? HERE,PIT,REAL-STAIR,PURLOINED-ROOM /FALSE
	EQUAL? HERE,WARLOCK-TOWER /FALSE
	GETP HERE,P?TMAZE >STACK
	ZERO? STACK \FALSE
	LOC WINNER >STACK
	EQUAL? STACK,DUNGEON,NORTH-CELL /?L16
	LOC WINNER >STACK
	EQUAL? STACK,SECRET-PASSAGE \?L15
?L16:	PRINTR "You hear, almost beyond your hearing, the soft rattle of chains, and a cold wind blows over the back of your neck."
?L15:	GRTR? TOD,NIGHTFALL \?L19
	CALL PICK-ONE,NIGHT-GLIMPSES >STACK
	PRINT STACK
	CRLF
	RTRUE
?L19:	CALL PICK-ONE,GLIMPSES >STACK
	PRINT STACK
	CRLF
	RTRUE

	.FUNCT GLIMPSE-F
	GRTR? MOVES,0 \?L1
	PRINTR "You can't see that anymore."
?L1:	PRINTR "You see no such thing."

	.INSERT "enchanter/enchanter_str"
	.END
