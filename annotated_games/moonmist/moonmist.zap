	.TIME
	.INSERT "./annotated_games/moonmist/moonmist_freq"
	.INSERT "./annotated_games/moonmist/moonmist_data"

	.FUNCT PRINT-DESC1,OBJ
	ZERO? OBJ /FALSE
	PRINTD OBJ
	RTRUE

	.FUNCT PRINT-ID,ID,CONDITION=1
	ZERO? CONDITION /FALSE
	PRINTI "[ID: "
	PRINT ID
	PRINTI ", PRSO: "
	CALL PRINT-DESC1,PRSO
	PRINTI ", PRSI: "
	CALL PRINT-DESC1,PRSI
	PRINTI "]"
	RTRUE

	.FUNCT PRINT-DEBUG,TEXT,CONDITION=1
	ZERO? CONDITION /FALSE
	PRINTI "DEBUG FLAG: "
	PRINT TEXT
	RTRUE

	.FUNCT IS-THEFT?
	EQUAL? PRSA,V?TAKE \FALSE
	EQUAL? PRSO,ANDIRON,ARMOR,ARTIFACT /TRUE
	EQUAL? PRSO,BELL,BLOWGUN,BOOKCASE /TRUE
	EQUAL? PRSO,BOTTLE,BROCHURE,BUFFALO-HEAD /TRUE
	EQUAL? PRSO,BUST,CANDLE,CANE /TRUE
	EQUAL? PRSO,CASTLE,COAT-RACK,COFFIN /TRUE
	EQUAL? PRSO,COMPUTER,CORPSE,COSTUME /TRUE
	EQUAL? PRSO,CREST,DESK,DINNER-2 /TRUE
	EQUAL? PRSO,DINNER-OUTFIT,DRAGON,DRAGON-EYE /TRUE
	EQUAL? PRSO,DRESSING-TABLE-LG,EARRING,EXERCISE-OUTFIT /TRUE
	EQUAL? PRSO,EYE,FIGURINE,FIREPLACE /TRUE
	EQUAL? PRSO,FLOOR,FRONT-DOOR,FRONT-GATE /TRUE
	EQUAL? PRSO,GLASS-EYE,HORN,INKWELL /TRUE
	EQUAL? PRSO,IRON-MAIDEN,JACK-TAPE,JEWEL /TRUE
	EQUAL? PRSO,JEWELRY-CASE,JOURNAL,LADDER /TRUE
	EQUAL? PRSO,LAMP,LENS,LENS-1 /TRUE
	EQUAL? PRSO,LENS-2,LENS-BOX,LETTER /TRUE
	EQUAL? PRSO,LETTER-DEE,LETTER-MAID,LEVER /TRUE
	EQUAL? PRSO,LOVER-PIC,LUMBER-CHEST,LUMBER-RING /TRUE
	EQUAL? PRSO,MACE,MAGAZINE,MEMENTO /TRUE
	EQUAL? PRSO,MEMENTO-2,MIRROR-GLOBAL,MUSTACHE /TRUE
	EQUAL? PRSO,NECKLACE,NECKLACE-OF-D,NIGHTSTAND-LG /TRUE
	EQUAL? PRSO,OIL-PAINTING,OTHER-OUTFIT,PAINT /TRUE
	EQUAL? PRSO,PAINTING-GALLERY,PIANO,PUNCHBOWL /TRUE
	EQUAL? PRSO,RECORDER,RHINO-HEAD,SIDEBOARD /TRUE
	EQUAL? PRSO,SKELETON,SKULL,TAMARA-EVIDENCE /TRUE
	EQUAL? PRSO,TAPESTRY,TELESCOPE,UMBRELLA-STAND /TRUE
	EQUAL? PRSO,VIVIEN-BOX,VIVIEN-DIARY,VIVIEN-STUFF /TRUE
	EQUAL? PRSO,WAR-CLUB,WARDROBE-LG,WENDISH-BOOK /TRUE
	EQUAL? PRSO,WENDISH-KIT,WENDISH-STUFF,WINE-RACK /TRUE
	EQUAL? PRSO,WYVERN \FALSE
	RTRUE

	.FUNCT IS-OBJECT-OR-PROPERTY?
	EQUAL? PRSO,ANDIRON,ARMOR,ARTIFACT /TRUE
	EQUAL? PRSO,BATHROOM,BED,BELL /TRUE
	EQUAL? PRSO,BLOWGUN,BOOKCASE,BOOKS-GLOBAL /TRUE
	EQUAL? PRSO,BOTTLE,BRICKS,BROCHURE /TRUE
	EQUAL? PRSO,BUFFALO-HEAD,BUST,CANDLE /TRUE
	EQUAL? PRSO,CANE,CASTLE,CHAIR /TRUE
	EQUAL? PRSO,CHAIR-DINING,COAT-RACK,COFFIN /TRUE
	EQUAL? PRSO,COMPUTER,CORPSE,COSTUME /TRUE
	EQUAL? PRSO,CREST,DESK,DINNER /TRUE
	EQUAL? PRSO,DINNER-2,DINNER-OUTFIT,DRAGON /TRUE
	EQUAL? PRSO,DRAGON-EYE,DRESSING-BENCH,DRESSING-MIRROR /TRUE
	EQUAL? PRSO,DRESSING-TABLE,DRESSING-TABLE-LG,EARRING /TRUE
	EQUAL? PRSO,EXERCISE-OUTFIT,EYE,FIGURINE /TRUE
	EQUAL? PRSO,FIREPLACE,FLOOR,FRONT-DOOR /TRUE
	EQUAL? PRSO,FRONT-GATE,GLASS-EYE,HANDS /TRUE
	EQUAL? PRSO,HAUNTING,HISTORY-BOOK,HOLE-IN-WALL /TRUE
	EQUAL? PRSO,HORN,HYDE-CHAIR,IAN-CHAIR /TRUE
	EQUAL? PRSO,INKWELL,IRIS-CHAIR,IRON-MAIDEN /TRUE
	EQUAL? PRSO,JACK-TAPE,JEWEL,JEWELRY-CASE /TRUE
	EQUAL? PRSO,JOURNAL,KEYHOLE,LADDER /TRUE
	EQUAL? PRSO,LAMP,LENS,LENS-1 /TRUE
	EQUAL? PRSO,LENS-2,LENS-BOX,LETTER /TRUE
	EQUAL? PRSO,LETTER-DEE,LETTER-MAID,LEVER /TRUE
	EQUAL? PRSO,LIBRARY-CHAIR,LOVER-PIC,LUMBER-CHEST /TRUE
	EQUAL? PRSO,LUMBER-RING,MACE,MAGAZINE /TRUE
	EQUAL? PRSO,MEMENTO,MEMENTO-2,MIRROR-GLOBAL /TRUE
	EQUAL? PRSO,MUSTACHE,NECKLACE,NECKLACE-OF-D /TRUE
	EQUAL? PRSO,NIGHTLAMP,NIGHTSTAND,NIGHTSTAND-LG /TRUE
	EQUAL? PRSO,OIL-PAINTING,OTHER-OUTFIT,PAINT /TRUE
	EQUAL? PRSO,PAINTING-GALLERY,PASSAGE,PEEPHOLE /TRUE
	EQUAL? PRSO,PEEPHOLE-2,PIANO,POND /TRUE
	EQUAL? PRSO,PRIEST-DOOR,PUNCHBOWL,RECORDER /TRUE
	EQUAL? PRSO,RHINO-HEAD,SECRET-DINING-DOOR,SECRET-DRAWING-DOOR /TRUE
	EQUAL? PRSO,SECRET-HYDE-DOOR,SECRET-IAN-DOOR,SECRET-IRIS-DOOR /TRUE
	EQUAL? PRSO,SECRET-JACK-DOOR,SECRET-LIBRARY-DOOR,SECRET-SITTING-DOOR /TRUE
	EQUAL? PRSO,SECRET-TAMARA-DOOR,SECRET-VIVIEN-DOOR,SECRET-WENDISH-DOOR /TRUE
	EQUAL? PRSO,SECRET-YOUR-DOOR,SIDEBOARD,SKELETON /TRUE
	EQUAL? PRSO,SKULL,STAINED-WINDOW,STAIRS /TRUE
	EQUAL? PRSO,TABLE-DINING,TABLE-LIBRARY,TABLE-RANDOM /TRUE
	EQUAL? PRSO,TAMARA-BED,TAMARA-EVIDENCE,TAPESTRY /TRUE
	EQUAL? PRSO,TELESCOPE,TOWER,TURN /TRUE
	EQUAL? PRSO,TWEED-OUTFIT,UMBRELLA-STAND,VICTORIA-CHAIR /TRUE
	EQUAL? PRSO,VIVIEN-BOX,VIVIEN-CHAIR,VIVIEN-DIARY /TRUE
	EQUAL? PRSO,VIVIEN-STUFF,VOICE,WALL /TRUE
	EQUAL? PRSO,WAR-CLUB,WARDROBE,WARDROBE-LG /TRUE
	EQUAL? PRSO,WELL,WENDISH-BOOK,WENDISH-CHAIR /TRUE
	EQUAL? PRSO,WENDISH-KIT,WENDISH-STUFF,WINDOW /TRUE
	EQUAL? PRSO,WINE-RACK,WRITING-DESK,WYVERN \FALSE
	RTRUE

	.FUNCT IS-PERSON?
	EQUAL? PRSO,BUTLER,COUSIN,CREW-GLOBAL /TRUE
	EQUAL? PRSO,DEALER,DEB,DOCTOR /TRUE
	EQUAL? PRSO,FRIEND,HEAD,HER /TRUE
	EQUAL? PRSO,HIM,LORD,LOVER /TRUE
	EQUAL? PRSO,MAID,OFFICER,PAINTER \FALSE
	RTRUE

	.FUNCT IS-SELF?
	EQUAL? PRSO,PLAYER,PLAYER-NAME \FALSE
	RTRUE

	.FUNCT IS-YOUR-PROPERTY?
	EQUAL? PRSO,YOUR-BATHROOM-DOOR,YOUR-CHAIR,YOUR-MIRROR /TRUE
	EQUAL? PRSO,YOUR-SWITCH,CHEST-OF-DRAWERS,LUGGAGE /TRUE
	EQUAL? PRSO,SLEEP-OUTFIT,CAR \FALSE
	RTRUE

	.FUNCT DANGEROUS-FOOD?
	CALL IS-OBJECT-OR-PROPERTY? >STACK
	ZERO? STACK /FALSE
	EQUAL? PRSO,DINNER,DINNER-2 \TRUE
	RFALSE

	.FUNCT GO
START::
?L0:	CALL V-VERSION
	CALL INTRO
	CALL MAIN-LOOP
	JUMP ?L0

	.FUNCT PRINTT,OBJ
	EQUAL? OBJ,TURN \?L1
	LESS? 1,P-NUMBER \?L1
	PRINTC 32
	PRINTN P-NUMBER
	PRINTI " minutes"
	RTRUE
?L1:	EQUAL? OBJ,WINDOW \?L5
	PRINTI " the window"
	RTRUE
?L5:	CALL THE?,OBJ
	PRINTC 32
	PRINTD OBJ
	RTRUE

	.FUNCT THE?,OBJ
	FSET? OBJ,NARTICLEBIT /?L11
	IN? OBJ,ROOMS /?L5
	FSET? OBJ,SEENBIT \?L3
?L5:	PRINTI " the"
	JUMP ?L11
?L3:	FSET? OBJ,VOWELBIT \?L8
	PRINTI " an"
	JUMP ?L11
?L8:	PRINTI " a"
?L11:	FSET OBJ,SEENBIT
	RTRUE

	.FUNCT START-SENTENCE,OBJ
	CALL THIS-IS-IT,OBJ
	EQUAL? OBJ,PLAYER \?L1
	PRINTI "You"
	RTRUE
?L1:	EQUAL? OBJ,NIGHTLAMP \?L5
	PRINTI "Your lamp"
	RTRUE
?L5:	EQUAL? OBJ,LUGGAGE \?L8
	PRINTI "Your luggage"
	RTRUE
?L8:	EQUAL? OBJ,BED \?L11
	PRINTI "Your bed"
	RTRUE
?L11:	EQUAL? OBJ,YOUR-COLOR \?L14
	PRINTI "Your favorite color"
	RTRUE
?L14:	EQUAL? OBJ,YOUR-ROOM \?L17
	PRINTI "Your room"
	RTRUE
?L17:	EQUAL? OBJ,YOUR-BATHROOM \?L20
	PRINTI "Your bathroom"
	RTRUE
?L20:	EQUAL? OBJ,YOUR-CLOSET \?L23
	PRINTI "Your secret entrance"
	RTRUE
?L23:	EQUAL? OBJ,DINNER \?L26
	PRINTI "Your dinner"
	RTRUE
?L26:	FSET? OBJ,NARTICLEBIT /?L39
	FSET? OBJ,SEENBIT \?L32
	PRINTI "The "
	JUMP ?L39
?L32:	FSET? OBJ,VOWELBIT \?L36
	PRINTI "An "
	JUMP ?L39
?L36:	PRINTI "A "
?L39:	FSET OBJ,SEENBIT
	PRINTD OBJ
	RTRUE

	.FUNCT PRINTA,O
	FSET? O,NARTICLEBIT /?L6
	FSET? O,VOWELBIT \?L3
	PRINTI "an "
	JUMP ?L6
?L3:	PRINTI "a "
?L6:	PRINTD O
	RTRUE

	.FUNCT THIS-IS-IT,OBJ
	EQUAL? OBJ,0,NOT-HERE-OBJECT,PLAYER /TRUE
	EQUAL? OBJ,INTDIR,GLOBAL-HERE,ROOMS /TRUE
	EQUAL? PRSA,V?WALK \?L4
	EQUAL? OBJ,PRSO /TRUE
?L4:	FSET? OBJ,PERSONBIT /?L6
	GET P-ADJW,NOW-PRSI >STACK
	PUT P-IT-WORDS,0,STACK
	GET P-NAMW,NOW-PRSI >STACK
	PUT P-IT-WORDS,1,STACK
	FSET IT,TOUCHBIT
	SET 'P-IT-OBJECT,OBJ
	RTRUE
?L6:	FSET? OBJ,FEMALE \?L8
	FSET HER,TOUCHBIT
	SET 'P-HER-OBJECT,OBJ
	RTRUE
?L8:	FSET HIM,TOUCHBIT
	SET 'P-HIM-OBJECT,OBJ
	RTRUE

	.FUNCT NO-PRONOUN?,OBJ,CAP=0
	EQUAL? OBJ,PLAYER /FALSE
	FSET? OBJ,PERSONBIT /?L3
	EQUAL? OBJ,P-IT-OBJECT \?L12
	FSET? IT,TOUCHBIT \?L12
	RFALSE
?L3:	FSET? OBJ,FEMALE \?L7
	EQUAL? OBJ,P-HER-OBJECT \?L12
	FSET? HER,TOUCHBIT \?L12
	RFALSE
?L7:	EQUAL? OBJ,P-HIM-OBJECT \?L12
	FSET? HIM,TOUCHBIT /FALSE
?L12:	ZERO? CAP \?L15
	CALL PRINTT,OBJ
	JUMP ?L19
?L15:	EQUAL? CAP,1,1 \?L19
	CALL START-SENTENCE,OBJ
?L19:	CALL THIS-IS-IT,OBJ
	RTRUE

	.FUNCT HE-SHE-IT,OBJ,CAP=0,VERB=0
	CALL NO-PRONOUN?,OBJ,CAP >STACK
	ZERO? STACK \?L35
	FSET? OBJ,PERSONBIT /?L3
	ZERO? CAP \?L4
	PRINTI " it"
	JUMP ?L35
?L4:	EQUAL? CAP,1,1 \?L35
	PRINTI "It"
	JUMP ?L35
?L3:	EQUAL? OBJ,PLAYER \?L12
	ZERO? CAP \?L13
	PRINTI " you"
	JUMP ?L35
?L13:	EQUAL? CAP,1,1 \?L35
	PRINTI "You"
	JUMP ?L35
?L12:	FSET? OBJ,FEMALE \?L21
	ZERO? CAP \?L22
	PRINTI " she"
	JUMP ?L35
?L22:	EQUAL? CAP,1,1 \?L35
	PRINTI "She"
	JUMP ?L35
?L21:	ZERO? CAP \?L31
	PRINTI " he"
	JUMP ?L35
?L31:	EQUAL? CAP,1,1 \?L35
	PRINTI "He"
?L35:	ZERO? VERB /FALSE
	PRINTC 32
	EQUAL? OBJ,PLAYER \?L41
	EQUAL? VERB,STR?44 \?L43
	PRINTI "are"
	RTRUE
?L43:	EQUAL? VERB,STR?45 \?L47
	PRINTI "have"
	RTRUE
?L47:	EQUAL? VERB,STR?46 \?L50
	PRINTI "try"
	RTRUE
?L50:	EQUAL? VERB,STR?47 \?L53
	PRINTI "empty"
	RTRUE
?L53:	PRINT VERB
	RTRUE
?L41:	PRINT VERB
	EQUAL? VERB,STR?50,STR?49,STR?48 /?L64
	EQUAL? VERB,STR?46,STR?47 \?L62
?L64:	PRINTC 101
?L62:	EQUAL? VERB,STR?44,STR?45 /FALSE
	PRINTC 115
	RTRUE

	.FUNCT HIM-HER-IT,OBJ,CAP=0,POSSESS?=0
	CALL NO-PRONOUN?,OBJ,CAP >STACK
	ZERO? STACK /?L1
	ZERO? POSSESS? /TRUE
	PRINTI "'s"
	RTRUE
?L1:	FSET? OBJ,PERSONBIT /?L8
	ZERO? CAP \?L9
	PRINTI " it"
	JUMP ?L13
?L9:	PRINTI "It"
?L13:	ZERO? POSSESS? /TRUE
	PRINTC 115
	RTRUE
?L8:	EQUAL? OBJ,PLAYER \?L21
	ZERO? CAP \?L22
	PRINTI " you"
	JUMP ?L26
?L22:	PRINTI "You"
?L26:	ZERO? POSSESS? /TRUE
	PRINTC 114
	RTRUE
?L21:	FSET? OBJ,FEMALE \?L34
	ZERO? CAP \?L35
	PRINTI " her"
	RTRUE
?L35:	PRINTI "Her"
	RTRUE
?L34:	ZERO? POSSESS? /?L43
	ZERO? CAP \?L45
	PRINTI " his"
	RTRUE
?L45:	PRINTI "His"
	RTRUE
?L43:	ZERO? CAP \?L53
	PRINTI " him"
	RTRUE
?L53:	PRINTI "Him"
	RTRUE

	.FUNCT QUEUE,RTN,TICK,CINT
	CALL INT,RTN >CINT
	PUT CINT,C-TICK,TICK
	PUT CINT,C-ENABLED?,1
	RETURN CINT

	.FUNCT INT,RTN,DEMON=0,E,C,INT?1
	ADD C-TABLE,C-TABLELEN >E
	ADD C-TABLE,C-INTS >C
?L1:	EQUAL? C,E \?L3
	SUB C-INTS,C-INTLEN >C-INTS
	ADD C-TABLE,C-INTS >INT?1
	PUT INT?1,C-RTN,RTN
	RETURN INT?1
?L3:	GET C,C-RTN >STACK
	EQUAL? STACK,RTN \?L5
	RETURN C
?L5:	ADD C,C-INTLEN >C
	JUMP ?L1

	.FUNCT QUEUED?,RTN,C
	CALL INT,RTN >C
	GET C,C-ENABLED? >STACK
	ZERO? STACK /FALSE
	GET C,C-TICK >STACK
	RSTACK

	.FUNCT CLOCKER,C,E,TICK,FLG=0,VAL
	ZERO? CLOCK-WAIT /?L1
	SET 'CLOCK-WAIT,0
	RFALSE
?L1:	IGRTR? 'PRESENT-TIME,1139 \?L4
	CALL TIMES-UP
?L4:	IGRTR? 'MOVES,59 \?L9
	SET 'MOVES,0
	IGRTR? 'SCORE,23 \?L9
	SET 'SCORE,0
?L9:	ADD C-TABLE,C-INTS >C
	ADD C-TABLE,C-TABLELEN >E
?L13:	EQUAL? C,E \?L15
	RETURN FLG
?L15:	GET C,C-ENABLED? >STACK
	ZERO? STACK /?L22
	GET C,C-TICK >TICK
	ZERO? TICK /?L22
	SUB TICK,1 >STACK
	PUT C,C-TICK,STACK
	GRTR? TICK,1 /?L22
	GET C,C-RTN >STACK
	CALL STACK >VAL
	ZERO? VAL /?L22
	ZERO? FLG /?L24
	EQUAL? VAL,M-FATAL \?L22
?L24:	SET 'FLG,VAL
?L22:	ADD C,C-INTLEN >C
	JUMP ?L13

	.FUNCT I-FOLLOW,GARG=0,FLG=0,CNT=0,GT,VAL=0
?L1:	IGRTR? 'CNT,GHOST-NEW-C \?L3
	RETURN FLG
?L3:	GET GOAL-TABLES,CNT >GT
	GET GT,GOAL-S >STACK
	ZERO? STACK /?L1
	GET GT,GOAL-ENABLE >STACK
	ZERO? STACK /?L1
	GET CHARACTER-TABLE,CNT >STACK
	CALL FOLLOW-GOAL,STACK >VAL
	ZERO? VAL /?L1
	EQUAL? FLG,M-FATAL /?L1
	SET 'FLG,VAL
	JUMP ?L1

	.FUNCT I-ATTENTION,GARG=0,FLG=0,CNT=0,ATT,GT,PER,RM
?L1:	IGRTR? 'CNT,GHOST-NEW-C /?L2
	GET GOAL-TABLES,CNT >GT
	GET GT,ATTENTION >ATT
	GRTR? ATT,0 \?L1
	DEC 'ATT
	GET CHARACTER-TABLE,CNT >PER
	EQUAL? PER,CONFESSED,CAPTOR,FOLLOWER /?L1
	SET 'GOAL-PERSON,PER
	ZERO? ATT \?L12
	LESS? BED-TIME,PRESENT-TIME /?L16
	GET GT,GOAL-FUNCTION >STACK
	EQUAL? STACK,X-RETIRES \?L14
?L16:	ADD 1,CNT >STACK
	GET CHAR-ROOM-TABLE,STACK >RM
	IN? PER,RM \?L17
	CALL GOODNIGHT,RM,PER
	JUMP ?L22
?L17:	PUT GT,GOAL-FUNCTION,X-RETIRES
	CALL ESTABLISH-GOAL,PER,RM
	JUMP ?L22
?L14:	GET GT,GOAL-QUEUED >RM
	ZERO? RM /?L20
	PUT GT,GOAL-QUEUED,0
	CALL ESTABLISH-GOAL,PER,RM
	JUMP ?L22
?L20:	PUTP PER,P?LDESC,17
	PUT GT,GOAL-ENABLE,1
	JUMP ?L22
?L12:	EQUAL? ATT,1 \?L22
	IN? PER,HERE \?L22
	GET GT,GOAL-FUNCTION >STACK
	CALL D-APPLY,STR?51,STACK,G-IMPATIENT >STACK
	ZERO? STACK /?L22
	SET 'FLG,1
?L22:	PUT GT,ATTENTION,ATT
	JUMP ?L1
?L2:	RETURN FLG

	.FUNCT MAIN-LOOP,X
?L1:	CALL MAIN-LOOP-1 >X
	JUMP ?L1

	.FUNCT MAIN-LOOP-1,ICNT,OCNT,NUM,CNT,OBJ,V,PTBL,OBJ1,TMP,X,GW
	SET 'CNT,0
	SET 'OBJ,0
	SET 'PTBL,1
	CALL PARSER >P-WON
	ZERO? P-WON /?L1
	SET 'CLOCK-WAIT,0
	GETB P-PRSI,P-MATCHLEN >ICNT
	GETB P-PRSO,P-MATCHLEN >OCNT
	ZERO? OCNT \?L3
	ZERO? ICNT /?L5
?L3:	ZERO? P-IT-OBJECT /?L5
	CALL ACCESSIBLE?,P-IT-OBJECT >STACK
	ZERO? STACK /?L5
	SET 'TMP,0
?L6:	IGRTR? 'CNT,ICNT /?L7
	GETB P-PRSI,CNT >STACK
	EQUAL? STACK,IT \?L6
	PUTB P-PRSI,CNT,P-IT-OBJECT
	CALL TELL-I-ASSUME,P-IT-OBJECT
	SET 'TMP,1
?L7:	SET 'CNT,0
?L16:	IGRTR? 'CNT,OCNT /?L17
	GETB P-PRSO,CNT >STACK
	EQUAL? STACK,IT \?L16
	PUTB P-PRSO,CNT,P-IT-OBJECT
	CALL TELL-I-ASSUME,P-IT-OBJECT
?L17:	SET 'CNT,0
?L5:	ZERO? OCNT \?L25
	SET 'NUM,OCNT
	JUMP ?L32
?L25:	GRTR? OCNT,1 \?L27
	ZERO? ICNT \?L28
	SET 'OBJ,0
	JUMP ?L30
?L28:	GETB P-PRSI,1 >OBJ
?L30:	SET 'NUM,OCNT
	JUMP ?L32
?L27:	GRTR? ICNT,1 \?L31
	SET 'PTBL,0
	GETB P-PRSO,1 >OBJ
	SET 'NUM,ICNT
	JUMP ?L32
?L31:	SET 'NUM,1
?L32:	ZERO? OBJ \?L33
	EQUAL? ICNT,1 \?L33
	GETB P-PRSI,1 >OBJ
?L33:	EQUAL? PRSA,V?WALK \?L36
	CALL PERFORM,PRSA,PRSO >V
	JUMP ?L70
?L36:	ZERO? NUM \?L40
	GETB P-SYNTAX,P-SBITS >STACK
	BAND STACK,P-SONUMS >STACK
	ZERO? STACK \?L41
	CALL PERFORM,PRSA >V
	SET 'PRSO,0
	JUMP ?L70
?L41:	ZERO? LIT \?L43
	CALL SEE-VERB? >STACK
	ZERO? STACK /?L43
	SET 'QUOTE-FLAG,0
	SET 'P-CONT,0
	CALL TOO-DARK
	JUMP ?L70
?L43:	SET 'QUOTE-FLAG,0
	SET 'P-CONT,0
	PRINTI "(There isn't any"
	ZERO? PTBL /?L146
	GETB P-SYNTAX,P-SFWIM1 >STACK
	EQUAL? STACK,PERSONBIT /?L49
	ZERO? PTBL \?L47
?L146:	GETB P-SYNTAX,P-SFWIM2 >STACK
	EQUAL? STACK,PERSONBIT \?L47
?L49:	PRINTI "one"
	JUMP ?L53
?L47:	PRINTI "thing"
?L53:	PRINTI " to "
	GET P-ITBL,P-VERBN >TMP
	EQUAL? PRSA,V?TELL \?L58
	PRINTI "talk to"
	JUMP ?L64
?L58:	ZERO? P-MERGED \?L63
	ZERO? P-OFLAG /?L62
?L63:	GET TMP,0 >STACK
	PRINTB STACK
	JUMP ?L64
?L62:	GETB TMP,3 >STACK
	GETB TMP,2 >STACK
	CALL WORD-PRINT,STACK,STACK >V
?L64:	PRINTI "!)"
	CRLF
	SET 'V,0
	JUMP ?L70
?L40:	ZERO? PTBL /?L67
	GRTR? NUM,1 \?L67
	EQUAL? PRSA,V?COMPARE \?L67
	CALL PERFORM,PRSA,OBJECT-PAIR >V
	JUMP ?L70
?L67:	SET 'X,0
	SET 'TMP,0
	SET 'GW,0
?L69:	IGRTR? 'CNT,NUM \?L71
	GRTR? X,0 \?L73
	PRINTI "The "
	EQUAL? X,NUM /?L77
	PRINTI "other "
?L77:	PRINTI "object"
	EQUAL? X,1 /?L84
	PRINTC 115
?L84:	PRINTI " that you mentioned "
	EQUAL? X,1 /?L91
	PRINTI "are"
	JUMP ?L95
?L91:	PRINTI "is"
?L95:	PRINTI "n't here."
	CRLF
	JUMP ?L70
?L73:	ZERO? TMP \?L70
	CALL MORE-SPECIFIC
	JUMP ?L70
?L71:	ZERO? PTBL /?L103
	GETB P-PRSO,CNT >OBJ1
	JUMP ?L105
?L103:	GETB P-PRSI,CNT >OBJ1
?L105:	GRTR? NUM,1 /?L108
	GET P-ITBL,P-NC1 >STACK
	GET STACK,0 >STACK
	EQUAL? STACK,W?ALL \?L114
?L108:	EQUAL? OBJ1,NOT-HERE-OBJECT \?L109
	INC 'X
	JUMP ?L69
?L109:	EQUAL? P-GETFLAGS,P-ALL \?L111
	CALL VERB-ALL-TEST,OBJ1,OBJ >STACK
	ZERO? STACK /?L69
?L111:	CALL ACCESSIBLE?,OBJ1 >STACK
	ZERO? STACK /?L69
	EQUAL? OBJ1,PLAYER /?L69
	EQUAL? OBJ1,COSTUME \?L119
	ZERO? GW \?L69
	SET 'GW,1
?L119:	EQUAL? OBJ1,IT \?L121
	PRINTD P-IT-OBJECT
	JUMP ?L123
?L121:	PRINTD OBJ1
?L123:	PRINTI ": "
?L114:	SET 'TMP,1
	ZERO? PTBL /?L127
	PUSH OBJ1
	JUMP ?L129
?L127:	PUSH OBJ
?L129:	CALL QCONTEXT-CHECK,STACK >V
	ZERO? PTBL /?L130
	SET 'PRSO,OBJ1
	SET 'PRSI,OBJ
	JUMP ?L132
?L130:	SET 'PRSO,OBJ
	SET 'PRSI,OBJ1
?L132:	CALL PERFORM,PRSA,PRSO,PRSI >V
	EQUAL? V,M-FATAL \?L69
?L70:	SET 'OPRSO,PRSO
	EQUAL? V,M-FATAL \?L139
	SET 'P-CONT,0
	JUMP ?L139
?L1:	SET 'CLOCK-WAIT,1
	SET 'P-CONT,0
?L139:	ZERO? CLOCK-WAIT \?L142
	ZERO? P-WON /?L142
	CALL GAME-VERB? >STACK
	ZERO? STACK \?L142
	SET 'CLOCKER-RUNNING,1
	CALL CLOCKER >V
	SET 'CLOCKER-RUNNING,2
?L142:	SET 'PRSA,0
	SET 'PRSO,0
	SET 'PRSI,0
	RETURN PRSI

	.FUNCT TELL-I-ASSUME,OBJ,STR=0
	ZERO? STR \?L3
	EQUAL? OPRSO,OBJ /FALSE
	FSET? OBJ,SECRETBIT /FALSE
?L3:	PRINT I-ASSUME
	ZERO? STR /?L6
	PRINT STR
?L6:	CALL PRINTT,OBJ
	PRINTR ".]"

	.FUNCT VERB-ALL-TEST,O,I,L
	LOC O >L
	EQUAL? O,PAINT /FALSE
	EQUAL? PRSA,V?GIVE,V?DROP \?L3
	EQUAL? O,NOW-WEARING /FALSE
	EQUAL? L,WINNER \FALSE
	RTRUE
?L3:	EQUAL? PRSA,V?PUT-IN,V?PUT \?L8
	EQUAL? O,I,NOW-WEARING /FALSE
	IN? O,I /FALSE
	RTRUE
?L8:	EQUAL? PRSA,V?TAKE \?L13
	FSET? O,SECRETBIT /FALSE
	FSET? O,TAKEBIT /?L16
	FSET? O,TRYTAKEBIT \FALSE
?L16:	ZERO? I /?L18
	EQUAL? L,I /?L26
	RFALSE
?L18:	EQUAL? L,HERE \?L26
	EQUAL? O,CANDLE \TRUE
	EQUAL? P-PRSA-WORD,W?RAISE,W?LIFT /TRUE
	RFALSE
?L26:	FSET? L,PERSONBIT /TRUE
	FSET? L,SURFACEBIT /TRUE
	FSET? L,CONTBIT \FALSE
	FSET? L,OPENBIT \FALSE
	RTRUE
?L13:	ZERO? I /TRUE
	EQUAL? O,I /FALSE
	RTRUE

	.FUNCT GAME-VERB?
	EQUAL? PRSA,V?$0024VERIFY,V?VERSION,V?VERBOSE /TRUE
	EQUAL? PRSA,V?UNSCRIPT,V?TIME,V?TELL /TRUE
	EQUAL? PRSA,V?SUPER-BRIEF,V?SCRIPT,V?SCORE /TRUE
	EQUAL? PRSA,V?SAVE,V?RESTORE,V?RESTART /TRUE
	EQUAL? PRSA,V?QUIT,V?BRIEF /TRUE
	RFALSE

	.FUNCT QCONTEXT-CHECK,PER,OTHER,WHO=0,N=0
	EQUAL? PRSA,V?HELP /?L3
	EQUAL? PRSA,V?TELL-ABOUT,V?SHOW \FALSE
	EQUAL? PER,PLAYER \FALSE
?L3:	FIRST? HERE >OTHER \?L6
?L7:	FSET? OTHER,PERSONBIT \?L9
	FSET? OTHER,INVISIBLE /?L9
	EQUAL? OTHER,PLAYER /?L9
	INC 'N
	SET 'WHO,OTHER
?L9:	NEXT? OTHER >OTHER /?L7
?L6:	EQUAL? 1,N \?L12
	ZERO? QCONTEXT \?L12
	SET 'QCONTEXT,WHO
?L12:	CALL QCONTEXT-GOOD? >STACK
	ZERO? STACK /FALSE
	EQUAL? WINNER,PLAYER \FALSE
	SET 'WINNER,QCONTEXT
	PRINTI "(said to "
	PRINTD QCONTEXT
	PRINTR ")"

	.FUNCT QCONTEXT-GOOD?,?TMP
	ZERO? QCONTEXT /FALSE
	FSET? QCONTEXT,PERSONBIT \FALSE
	FSET? QCONTEXT,MUNGBIT /FALSE
	SET '?TMP,HERE
	CALL META-LOC,QCONTEXT >STACK
	EQUAL? ?TMP,STACK \FALSE
	RETURN QCONTEXT

	.FUNCT NOT-IT,WHO
	EQUAL? WHO,P-HER-OBJECT \?L1
	FCLEAR HER,TOUCHBIT
	RTRUE
?L1:	EQUAL? WHO,P-HIM-OBJECT \?L3
	FCLEAR HIM,TOUCHBIT
	RTRUE
?L3:	EQUAL? WHO,P-IT-OBJECT \FALSE
	FCLEAR IT,TOUCHBIT
	RTRUE

	.FUNCT NOT-HERE-OBJECT-F,TBL,PRSO?=0,OBJ=0
	EQUAL? PRSO,NOT-HERE-OBJECT \?L7
	EQUAL? PRSI,NOT-HERE-OBJECT \?L1
	PRINTI "(Those things aren't here!)"
	CRLF
	RETURN 2
?L1:	EQUAL? PRSO,NOT-HERE-OBJECT \?L7
	SET 'TBL,P-PRSO
	SET 'PRSO?,1
	JUMP ?L8
?L7:	SET 'TBL,P-PRSI
?L8:	EQUAL? P-XADJ,A?MY \?L16
	EQUAL? P-XNAM,W?EYE,W?EYES \?L11
	SET 'OBJ,EYE
	JUMP ?L14
?L11:	EQUAL? P-XNAM,W?HANDS,W?HAND \?L13
	SET 'OBJ,HANDS
	JUMP ?L14
?L13:	EQUAL? P-XNAM,W?HEAD \?L14
	SET 'OBJ,HEAD
?L14:	ZERO? OBJ /?L16
	ZERO? PRSO? /?L18
	SET 'PRSO,OBJ
	RFALSE
?L18:	SET 'PRSI,OBJ
	RFALSE
?L16:	EQUAL? P-ADJN,W?YOUR,W?HER,W?HIS \?L23
	ZERO? P-NAM /?L23
	CALL RESOLVE-YOUR-HER-HIS
?L23:	ZERO? PRSO? /?L57
	CALL PRSO-VERB? >STACK
	ZERO? STACK \?L28
	ZERO? PRSO? \?L37
?L57:	CALL PRSI-VERB? >STACK
	ZERO? STACK /?L37
?L28:	CALL FIND-NOT-HERE,TBL,PRSO? >OBJ
	ZERO? OBJ /FALSE
	EQUAL? OBJ,NOT-HERE-OBJECT /?L37
	RETURN 2
?L37:	PRINTC 40
	CALL HE-SHE-IT,WINNER,1
	PRINTI " can't "
	EQUAL? PRSA,V?LISTEN \?L41
	PRINTI "hear"
	JUMP ?L45
?L41:	PRINTI "see"
?L45:	CALL CAPITAL-NOUN?,P-XNAM >STACK
	ZERO? STACK \?L48
	PRINTI " any"
?L48:	CALL NOT-HERE-PRINT
	PRINTI " right here!)"
	CRLF
	RETURN 2

	.FUNCT PRSO-VERB?
	EQUAL? PRSA,V?WALK-TO,V?WAIT-FOR,V?USE /TRUE
	EQUAL? PRSA,V?THROUGH,V?TELL,V?TALK-ABOUT /TRUE
	EQUAL? PRSA,V?LEAVE,V?FOLLOW,V?FIND /TRUE
	EQUAL? PRSA,V?DESCRIBE,V?DRESS,V?DISEMBARK /TRUE
	EQUAL? PRSA,V?CLIMB-UP,V?CLIMB-DOWN,V?BOARD /TRUE
	EQUAL? PRSA,V?ASK-CONTEXT-FOR,V?ASK-CONTEXT-ABOUT /TRUE
	EQUAL? WINNER,PLAYER /FALSE
	EQUAL? PRSA,V?SSHOW,V?TAKE,V?GIVE /TRUE
	RFALSE

	.FUNCT PRSI-VERB?
	EQUAL? PRSA,V?TELL-ABOUT,V?TAKE-TO,V?SEARCH-FOR /TRUE
	EQUAL? PRSA,V?ASK-FOR,V?ASK-ABOUT /TRUE
	EQUAL? WINNER,PLAYER /FALSE
	EQUAL? PRSA,V?SHOW,V?SGIVE,V?SSHOW /TRUE
	RFALSE

	.FUNCT GEN-TEST,OBJ
	CALL VISIBLE?,OBJ >STACK
	ZERO? STACK \TRUE
	CALL CORRIDOR-LOOK,OBJ >STACK
	ZERO? STACK \TRUE
	EQUAL? PRSA,V?FOLLOW /?L5
	CALL REMOTE-VERB? >STACK
	ZERO? STACK /FALSE
?L5:	FSET? OBJ,PERSONBIT \FALSE
	FSET? OBJ,SEENBIT /TRUE
	RFALSE

	.FUNCT NOT-SECRET-TEST,OBJ
	FSET? OBJ,SECRETBIT \TRUE
	FSET? OBJ,SEENBIT /TRUE
	RFALSE

	.FUNCT PRUNE,TBL,LEN,FCN,CNT=1,OBJ
?L1:	GETB TBL,CNT >OBJ
	CALL FCN,OBJ >STACK
	ZERO? STACK \?L5
	DEC 'LEN
	CALL ELIMINATE,TBL,CNT,LEN
	GRTR? CNT,LEN \?L1
?L5:	IGRTR? 'CNT,LEN \?L1
	PUTB TBL,P-MATCHLEN,LEN
	RETURN LEN

	.FUNCT ELIMINATE,TBL,CNT,N
?L1:	ADD 1,CNT >STACK
	GETB TBL,STACK >STACK
	PUTB TBL,CNT,STACK
	IGRTR? 'CNT,N \?L1
	RTRUE

	.FUNCT MOBY-FIND,TBL,OBJ=1,LEN,FOO
	SET 'P-NAM,P-XNAM
	SET 'P-ADJ,P-XADJ
	PUTB TBL,P-MATCHLEN,0
?L1:	CALL META-LOC,OBJ,1 >FOO
	ZERO? FOO /?L5
	CALL THIS-IT?,OBJ >FOO
	ZERO? FOO /?L5
	CALL OBJ-FOUND,OBJ,TBL >FOO
?L5:	IGRTR? 'OBJ,LAST-OBJECT \?L1
	SET 'P-NAM,0
	SET 'P-ADJ,0
	GETB TBL,P-MATCHLEN >LEN
	EQUAL? LEN,1 \?L11
	GETB TBL,1 >P-MOBY-FOUND
?L11:	RETURN LEN

	.FUNCT FIND-NOT-HERE,TBL,PRSO?,M-F,OBJ,LEN,CNT,LOCAL=0
	CALL MOBY-FIND,TBL >M-F
	GRTR? M-F,1 \?L14
	SET 'CNT,0
?L3:	IGRTR? 'CNT,M-F /?L4
	GETB TBL,CNT >OBJ
	CALL GEN-TEST,OBJ >STACK
	ZERO? STACK /?L3
	IGRTR? 'LOCAL,1 /?L4
	SET 'P-MOBY-FOUND,OBJ
	JUMP ?L3
?L4:	EQUAL? LOCAL,1 \?L14
	SET 'M-F,1
?L14:	EQUAL? 1,M-F \?L18
	CALL REMOTE-VERB? >STACK
	ZERO? STACK \?L20
	FSET? P-MOBY-FOUND,SECRETBIT \?L20
	CALL NOT-FOUND,P-MOBY-FOUND
	RTRUE
?L20:	CALL REMOTE-VERB? >STACK
	ZERO? STACK \?L22
	EQUAL? PRSA,V?$0024CALL /?L22
	CALL VISIBLE?,P-MOBY-FOUND >STACK
	ZERO? STACK \?L22
	CALL NOT-HERE,P-MOBY-FOUND
	RTRUE
?L22:	ZERO? PRSO? /?L23
	SET 'PRSO,P-MOBY-FOUND
	RFALSE
?L23:	SET 'PRSI,P-MOBY-FOUND
	RFALSE
?L18:	LESS? 1,M-F \?L37
	GETB TBL,1 >OBJ
	FSET? OBJ,PERSONBIT \?L25
	GETB TBL,P-MATCHLEN >STACK
	CALL PRUNE,TBL,STACK,GEN-TEST >LEN
	ZERO? LEN \?L26
	RETURN NOT-HERE-OBJECT
?L26:	EQUAL? LEN,1 /?L28
	CALL WHICH-PRINT,0,LEN,TBL
	EQUAL? TBL,P-PRSO \?L29
	SET 'P-ACLAUSE,P-NC1
	JUMP ?L31
?L29:	SET 'P-ACLAUSE,P-NC2
?L31:	SET 'P-AADJ,P-ADJ
	SET 'P-ANAM,P-NAM
	CALL ORPHAN,0,0
	SET 'P-OFLAG,1
	RTRUE
?L28:	FSET? OBJ,SECRETBIT \?L33
	CALL NOT-FOUND,OBJ
	RTRUE
?L33:	ZERO? PRSO? /?L35
	SET 'PRSO,OBJ
	RFALSE
?L35:	SET 'PRSI,OBJ
	RFALSE
?L25:	LESS? 1,M-F \?L37
	GETB TBL,1 >OBJ
	GETP OBJ,P?GENERIC >STACK
	CALL STACK,TBL,M-F >OBJ
	ZERO? OBJ /?L37
	EQUAL? OBJ,NOT-HERE-OBJECT /TRUE
	FSET? OBJ,SECRETBIT \?L40
	CALL NOT-FOUND,OBJ
	RTRUE
?L40:	ZERO? PRSO? /?L41
	SET 'PRSO,OBJ
	RFALSE
?L41:	SET 'PRSI,OBJ
	RFALSE
?L37:	ZERO? PRSO? \?L81
	IN? PRSO,HERE \?L45
	EQUAL? PRSA,V?TELL-ABOUT,V?ASK-FOR,V?ASK-ABOUT /?L44
?L45:	ZERO? PRSO? /?L46
?L81:	CALL QCONTEXT-GOOD? >STACK
	ZERO? STACK /?L46
	EQUAL? PRSA,V?ASK-CONTEXT-FOR,V?ASK-CONTEXT-ABOUT /?L44
?L46:	EQUAL? WINNER,PLAYER /?L43
	EQUAL? PRSA,V?SGIVE,V?GIVE,V?FIND \?L43
?L44:	SET 'LEN,0
	EQUAL? WINNER,PLAYER /?L47
	SET 'LEN,WINNER
	JUMP ?L50
?L47:	EQUAL? PRSA,V?TELL-ABOUT,V?ASK-FOR,V?ASK-ABOUT \?L49
	SET 'LEN,PRSO
	JUMP ?L50
?L49:	CALL QCONTEXT-GOOD? >STACK
	ZERO? STACK /?L50
	SET 'LEN,QCONTEXT
?L50:	EQUAL? LEN,0,PLAYER /?L52
	CALL START-SENTENCE,LEN
	PRINTI " looks confused. "
?L52:	PRINTI """I don't know wh"
	ZERO? M-F \?L59
	PRINTI "at you mean by"
	CALL NOT-HERE-PRINT
	JUMP ?L63
?L59:	PRINTI "ich"
	CALL NOT-HERE-PRINT
	PRINTI " you mean"
?L63:	PRINTR "!"""
?L43:	ZERO? PRSO? \?L70
	CALL HE-SHE-IT,WINNER,1
	PRINTI " wouldn't find"
	CALL CAPITAL-NOUN?,P-XNAM >STACK
	ZERO? STACK \?L73
	PRINTI " any"
?L73:	CALL NOT-HERE-PRINT
	PRINTR " there."
?L70:	RETURN NOT-HERE-OBJECT

	.FUNCT NOT-HERE-PRINT
	ZERO? P-OFLAG \?L3
	ZERO? P-MERGED /?L1
?L3:	ZERO? P-XADJ /?L4
	PRINTC 32
	PRINTB P-XADJN
?L4:	ZERO? P-XNAM /FALSE
	PRINTC 32
	PRINTB P-XNAM
	RTRUE
?L1:	EQUAL? PRSO,NOT-HERE-OBJECT \?L14
	CALL CLAUSE-PRINT,P-NC1,P-NC1L,0 >STACK
	RSTACK
?L14:	CALL CLAUSE-PRINT,P-NC2,P-NC2L,0 >STACK
	RSTACK

	.FUNCT SEE-VERB?
	EQUAL? PRSA,V?SSEARCH-FOR,V?SEARCH-FOR,V?SEARCH /TRUE
	EQUAL? PRSA,V?READ,V?LOOK-UP,V?LOOK-UNDER /TRUE
	EQUAL? PRSA,V?LOOK-THROUGH,V?LOOK-OUTSIDE,V?LOOK-ON /TRUE
	EQUAL? PRSA,V?LOOK-INSIDE,V?LOOK-DOWN,V?LOOK-BEHIND /TRUE
	EQUAL? PRSA,V?LOOK,V?FIND,V?EXAMINE /TRUE
	EQUAL? PRSA,V?CHASTISE,V?SANALYZE,V?ANALYZE /TRUE
	RFALSE

	.FUNCT FIX-HIM-HER-IT,PRON,OBJ
	ZERO? OBJ /?L4
	CALL ACCESSIBLE?,OBJ >STACK
	ZERO? STACK \?L1
	EQUAL? PRON,PRSI \?L5
	CALL PRSI-VERB? >STACK
	ZERO? STACK /?L4
?L5:	EQUAL? PRON,PRSO \?L1
	CALL PRSO-VERB? >STACK
	ZERO? STACK \?L1
?L4:	EQUAL? 0,OBJ,PRSI \?L6
	CALL FAKE-ORPHAN
	RFALSE
?L6:	CALL NOT-HERE,OBJ
	RFALSE
?L1:	EQUAL? PRSO,PRON \?L10
	EQUAL? PRON,IT \?L12
	GET P-IT-WORDS,0 >STACK
	PUT P-ADJW,0,STACK
	GET P-IT-WORDS,1 >STACK
	PUT P-NAMW,0,STACK
?L12:	SET 'PRSO,OBJ
	CALL TELL-I-ASSUME,OBJ
?L10:	EQUAL? PRSI,PRON \TRUE
	EQUAL? PRON,IT \?L18
	GET P-IT-WORDS,0 >STACK
	PUT P-ADJW,1,STACK
	GET P-IT-WORDS,1 >STACK
	PUT P-NAMW,1,STACK
?L18:	SET 'PRSI,OBJ
	CALL TELL-I-ASSUME,OBJ
	RTRUE

	.FUNCT FAKE-ORPHAN,TMP
	CALL ORPHAN,P-SYNTAX,0
	PRINTI "[Please be specific: wh"
	GETB P-SYNTAX,P-SFWIM1 >STACK
	EQUAL? STACK,PERSONBIT \?L3
	PRINTI "om"
	JUMP ?L7
?L3:	PRINTI "at"
?L7:	PRINTI " do you want to "
	CALL VERB-PRINT
	SET 'P-OFLAG,1
	SET 'P-WON,0
	PRINTR "?]"

	.FUNCT PERFORM,A,O=0,I=0,V,OA,OO,OI,X
	SET 'OA,PRSA
	SET 'OO,PRSO
	SET 'OI,PRSI
	SET 'PRSA,A
	SET 'PRSI,I
	SET 'PRSO,O
	ZERO? LIT \?L1
	CALL SEE-VERB? >STACK
	ZERO? STACK /?L1
	CALL TOO-DARK
	RETURN 2
?L1:	EQUAL? PRSA,V?WALK /?L24
	EQUAL? IT,PRSI,PRSO \?L8
	CALL FIX-HIM-HER-IT,IT,P-IT-OBJECT >STACK
	ZERO? STACK \?L8
	RETURN 2
?L8:	EQUAL? HER,PRSI,PRSO \?L16
	CALL FIX-HIM-HER-IT,HER,P-HER-OBJECT >STACK
	ZERO? STACK \?L16
	RETURN 2
?L16:	EQUAL? HIM,PRSI,PRSO \?L24
	CALL FIX-HIM-HER-IT,HIM,P-HIM-OBJECT >STACK
	ZERO? STACK \?L24
	RETURN 2
?L24:	SET 'V,0
	EQUAL? A,V?WALK /?L33
	EQUAL? NOT-HERE-OBJECT,PRSO,PRSI \?L33
	CALL D-APPLY,STR?52,NOT-HERE-OBJECT-F >V
	ZERO? V /?L33
	SET 'P-WON,0
?L33:	CALL THIS-IS-IT,PRSI
	CALL THIS-IS-IT,PRSO
	EQUAL? WINNER,PLAYER /?L37
	CALL THIS-IS-IT,WINNER
?L37:	SET 'O,PRSO
	SET 'I,PRSI
	ZERO? V \?L49
	GETP WINNER,P?ACTION >STACK
	CALL D-APPLY,STR?53,STACK,M-WINNER >V
	ZERO? V \?L49
	IN? WINNER,CAR \?L45
	PUSH CAR
	JUMP ?L47
?L45:	PUSH HERE
?L47:	GETP STACK,P?ACTION >STACK
	CALL D-APPLY,STR?54,STACK,M-BEG >V
	ZERO? V \?L49
	GET PREACTIONS,A >STACK
	CALL D-APPLY,STR?55,STACK >V
?L49:	SET 'NOW-PRSI,1
	ZERO? V \?L52
	ZERO? I /?L52
	GETP I,P?ACTION >STACK
	CALL D-APPLY,STR?56,STACK >V
?L52:	SET 'NOW-PRSI,0
	ZERO? V \?L58
	ZERO? O /?L55
	EQUAL? A,V?WALK /?L55
	GETP O,P?ACTION >STACK
	CALL D-APPLY,STR?57,STACK >V
?L55:	ZERO? V \?L58
	GET ACTIONS,A >STACK
	CALL D-APPLY,0,STACK >V
?L58:	SET 'PRSA,OA
	SET 'PRSO,OO
	SET 'PRSI,OI
	RETURN V

	.FUNCT D-APPLY,STR,FCN,FOO=0,RES
	ZERO? FCN /FALSE
	EQUAL? STR,STR?58 \?L3
	SET 'FOO,M-CONT
?L3:	ZERO? FOO /?L6
	CALL FCN,FOO >RES
	RETURN RES
?L6:	CALL FCN >RES
	RETURN RES

	.FUNCT I-PROMPT,GARG=0
	DEC 'P-PROMPT
	RFALSE

	.FUNCT BUZZER-WORD?,WRD,PTR
	CALL QUESTION-WORD?,WRD >STACK
	ZERO? STACK \?L3
	CALL NAUGHTY-WORD?,WRD >STACK
	ZERO? STACK \?L3
	CALL NUMBER-WORD?,WRD >STACK
	ZERO? STACK /FALSE
?L3:	PUT OOPS-TABLE,O-PTR,PTR
	RTRUE

	.FUNCT QUESTION-WORD?,WORD,DO-IT=0
	EQUAL? WORD,W?$0028SOME \?L1
	PRINTI "[Type a real word instead of"
	PRINT SOMETHING
	RTRUE
?L1:	EQUAL? WORD,W?WHERE \?L5
	CALL TO-DO-X-USE-Y,STR?60,STR?59
	RTRUE
?L5:	EQUAL? WORD,W?WHAT,W?WHO,W?WHEN /?L7
	EQUAL? WORD,W?WHY \?L6
?L7:	CALL TO-DO-X-USE-Y,STR?62,STR?61
	RTRUE
?L6:	ZERO? DO-IT \?L9
	CALL ZMEMQ,WORD,QUESTION-WORD-TABLE >STACK
	ZERO? STACK /FALSE
?L9:	PRINTI "[Please use commands"
	INC 'QUESTION-WORD-COUNT
	MOD QUESTION-WORD-COUNT,4 >STACK
	ZERO? STACK \?L12
	PRINTI " to tell the computer what you want to do in the story. Here are some commands:
   GO TO MY ROOM
   LOOK UNDER THE RUG
   MADAM, DESCRIBE THE GHOST
Now you can try again"
	JUMP ?L16
?L12:	PRINTI ", not statements or questions"
?L16:	PRINTR ".]"

	.FUNCT TO-DO-X-USE-Y,STR1,STR2
	PRINTI "[To "
	PRINT STR1
	PRINTI " something, use the command: "
	PRINT STR2
	PRINT SOMETHING
	RTRUE

	.FUNCT NUMBER-WORD?,WRD
	CALL ZMEMQ,WRD,NUMBER-WORD-TABLE >STACK
	ZERO? STACK /FALSE
	PRINTR "[Use numerals for numbers, for example ""10.""]"

	.FUNCT NAUGHTY-WORD?,WORD
	CALL ZMEMQ,WORD,NAUGHTY-WORD-TABLE >STACK
	ZERO? STACK /FALSE
	PRINTC 91
	CALL PICK-ONE-NEW,OFFENDED >STACK
	PRINT STACK
	PRINTC 93
	CRLF
	CALL PRINT-ID,STR?63 >STACK
	RSTACK

	.FUNCT NOT-THAT-WAY,STR
	PRINTI "[You can't use "
	PRINT STR
	PRINTR " that way.]"

	.FUNCT PARSER,PTR=P-LEXSTART,WRD,VAL=0,VERB=0,OF-FLAG=0,LEN,DIR=0,NW=0,LW=0,CNT=-1,OMERGED,OWINNER,TMP
?L1:	IGRTR? 'CNT,P-ITBLLEN /?L2
	ZERO? P-OFLAG \?L6
	GET P-ITBL,CNT >STACK
	PUT P-OTBL,CNT,STACK
?L6:	PUT P-ITBL,CNT,0
	JUMP ?L1
?L2:	SET 'P-NAM,0
	SET 'P-ADJ,0
	SET 'P-ADJN,0
	SET 'P-XNAM,0
	SET 'P-XADJ,0
	SET 'P-XADJN,0
	ZERO? P-OFLAG \?L9
	PUT P-NAMW,0,0
	PUT P-NAMW,1,0
	PUT P-ADJW,0,0
	PUT P-ADJW,1,0
	PUT P-OFW,0,0
	PUT P-OFW,1,0
?L9:	SET 'P-PRSA-WORD,0
	SET 'OMERGED,P-MERGED
	SET 'P-MERGED,0
	SET 'P-END-ON-PREP,0
	PUTB P-PRSO,P-MATCHLEN,0
	PUTB P-PRSI,P-MATCHLEN,0
	PUTB P-BUTS,P-MATCHLEN,0
	SET 'OWINNER,WINNER
	ZERO? QUOTE-FLAG \?L12
	EQUAL? WINNER,PLAYER /?L12
	SET 'WINNER,PLAYER
	LOC WINNER >STACK
	FSET? STACK,VEHBIT /?L14
	LOC WINNER >HERE
?L14:	CALL LIT? >LIT
?L12:	ZERO? RESERVE-PTR /?L18
	SET 'PTR,RESERVE-PTR
	CALL STUFF,P-LEXV,RESERVE-LEXV
	CALL INBUF-STUFF,P-INBUF,RESERVE-INBUF
	ZERO? VERBOSITY /?L20
	EQUAL? PLAYER,WINNER \?L20
	CRLF
?L20:	SET 'RESERVE-PTR,0
	JUMP ?L27
?L18:	ZERO? P-CONT /?L23
	SET 'PTR,P-CONT
	ZERO? VERBOSITY /?L27
	EQUAL? PLAYER,WINNER \?L27
	CRLF
	JUMP ?L27
?L23:	SET 'WINNER,PLAYER
	SET 'QUOTE-FLAG,0
	GET OOPS-TABLE,O-PTR >STACK
	ZERO? STACK \?L28
	PUT OOPS-TABLE,O-END,0
?L28:	LOC WINNER >STACK
	FSET? STACK,VEHBIT /?L31
	LOC WINNER >HERE
?L31:	CALL LIT? >LIT
	FCLEAR IT,TOUCHBIT
	FCLEAR HER,TOUCHBIT
	FCLEAR HIM,TOUCHBIT
	ZERO? VERBOSITY /?L34
	CRLF
?L34:	ZERO? P-PROMPT /?L37
	ZERO? P-OFLAG \?L37
	ZERO? AWAITING-REPLY \?L37
	EQUAL? P-PROMPT,P-PROMPT-START \?L39
	PRINTI "What would you like to do?"
	JUMP ?L46
?L39:	DLESS? 'P-PROMPT,1 \?L43
	PRINTI "[You won't see ""What next?"" any more.]
"
	JUMP ?L46
?L43:	PRINTI "What next?"
?L46:	CRLF
?L37:	PRINTC 62
	READ P-INBUF,P-LEXV
?L27:	GETB P-LEXV,P-LEXWORDS >P-LEN
	GET P-LEXV,PTR >STACK
	EQUAL? W?$QUOTE,STACK \?L52
	CALL QCONTEXT-GOOD? >STACK
	ZERO? STACK /?L52
	ADD PTR,P-LEXELEN >PTR
	DEC 'P-LEN
?L52:	GET P-LEXV,PTR >STACK
	EQUAL? W?THEN,STACK \?L55
	ADD PTR,P-LEXELEN >PTR
	DEC 'P-LEN
?L55:	LESS? 1,P-LEN \?L61
	GET P-LEXV,PTR >STACK
	EQUAL? STACK,W?YOU \?L58
	ADD PTR,P-LEXELEN >STACK
	GET P-LEXV,STACK >NW
	ZERO? NW /?L58
	CALL WT?,NW,PS?VERB >STACK
	ZERO? STACK /?L58
	ADD PTR,P-LEXELEN >PTR
	DEC 'P-LEN
?L58:	LESS? 1,P-LEN \?L61
	GET P-LEXV,PTR >STACK
	EQUAL? STACK,W?GO,W?TO \?L61
	ADD PTR,P-LEXELEN >STACK
	GET P-LEXV,STACK >NW
	ZERO? NW /?L61
	CALL WT?,NW,PS?VERB >STACK
	ZERO? STACK /?L61
	ADD PTR,P-LEXELEN >PTR
	DEC 'P-LEN
?L61:	ZERO? P-LEN \?L64
	PRINTC 91
	PRINT BEG-PARDON
	PRINTI "]"
	CRLF
	RFALSE
?L64:	GET P-LEXV,PTR >STACK
	EQUAL? STACK,W?OOPS \?L68
	ADD PTR,P-LEXELEN >STACK
	GET P-LEXV,STACK >STACK
	EQUAL? STACK,W?$PERIOD,W?$COMMA,W?$0021 \?L69
	ADD PTR,P-LEXELEN >PTR
	DEC 'P-LEN
?L69:	GRTR? P-LEN,1 /?L72
	CALL NOT-THAT-WAY,STR?64
	RFALSE
?L72:	GET OOPS-TABLE,O-PTR >VAL
	ZERO? VAL /?L74
	GRTR? P-LEN,2 \?L75
	PRINTI "[Warning: only the first word after OOPS is used.]"
	CRLF
?L75:	ADD PTR,P-LEXELEN >STACK
	GET P-LEXV,STACK >STACK
	PUT AGAIN-LEXV,VAL,STACK
	SET 'WINNER,OWINNER
	MUL PTR,P-LEXELEN >STACK
	ADD STACK,6 >PTR
	MUL VAL,P-LEXELEN >STACK
	ADD STACK,3 >STACK
	ADD PTR,1 >STACK
	GETB P-LEXV,STACK >STACK
	GETB P-LEXV,PTR >STACK
	CALL INBUF-ADD,STACK,STACK,STACK
	CALL STUFF,P-LEXV,AGAIN-LEXV
	GETB P-LEXV,P-LEXWORDS >P-LEN
	GET OOPS-TABLE,O-START >PTR
	CALL INBUF-STUFF,P-INBUF,OOPS-INBUF
	SET 'OOPS-PRINT,1
	CALL PRINT-LEXV,PTR
	SET 'OOPS-PRINT,0
	JUMP ?L83
?L74:	PUT OOPS-TABLE,O-END,0
	PRINTI "[There was no word to replace!]"
	CRLF
	RFALSE
?L68:	ZERO? P-CONT \?L83
	PUT OOPS-TABLE,O-END,0
?L83:	SET 'P-CONT,0
	GET P-LEXV,PTR >STACK
	EQUAL? STACK,W?AGAIN,W?G \?L85
	GETB OOPS-INBUF,1 >STACK
	ZERO? STACK \?L87
	PRINTI "[What do you want to do again?]"
	CRLF
	RFALSE
?L87:	ZERO? P-OFLAG /?L91
	CALL NOT-THAT-WAY,STR?65
	RFALSE
?L91:	ZERO? P-WON \?L92
	PRINTI "[That would just repeat a mistake!]"
	CRLF
	RFALSE
?L92:	GRTR? P-LEN,1 \?L95
	ADD PTR,P-LEXELEN >STACK
	GET P-LEXV,STACK >CNT
	EQUAL? CNT,W?$PERIOD,W?$COMMA,W?THEN /?L98
	EQUAL? CNT,W?AND,W?$0021,W?? \?L96
?L98:	ADD PTR,4 >PTR
	GETB P-LEXV,P-LEXWORDS >STACK
	SUB STACK,2 >STACK
	PUTB P-LEXV,P-LEXWORDS,STACK
	JUMP ?L100
?L96:	CALL DONT-UNDERSTAND
	RFALSE
?L95:	ADD PTR,P-LEXELEN >PTR
	GETB P-LEXV,P-LEXWORDS >STACK
	DEC 'STACK
	PUTB P-LEXV,P-LEXWORDS,STACK
?L100:	GETB P-LEXV,P-LEXWORDS >STACK
	GRTR? STACK,0 \?L101
	CALL STUFF,RESERVE-LEXV,P-LEXV
	CALL INBUF-STUFF,RESERVE-INBUF,P-INBUF
	SET 'RESERVE-PTR,PTR
	JUMP ?L103
?L101:	SET 'RESERVE-PTR,0
?L103:	SET 'WINNER,OWINNER
	SET 'P-MERGED,OMERGED
	CALL INBUF-STUFF,P-INBUF,OOPS-INBUF
	CALL STUFF,P-LEXV,AGAIN-LEXV
	SET 'CNT,-1
	SET 'DIR,AGAIN-DIR
?L104:	IGRTR? 'CNT,P-ITBLLEN /?L117
	GET P-OTBL,CNT >STACK
	PUT P-ITBL,CNT,STACK
	JUMP ?L104
?L85:	SET 'P-NUMBER,-1
	GETB P-LEXV,P-LEXWORDS >STACK
	MUL P-LEXELEN,STACK >STACK
	ADD PTR,STACK >LEN
	CALL FIX-POSSESSIVES,PTR,LEN >STACK
	EQUAL? 1,STACK /FALSE
	CALL STUFF,AGAIN-LEXV,P-LEXV
	CALL INBUF-STUFF,OOPS-INBUF,P-INBUF
	PUT OOPS-TABLE,O-START,PTR
	MUL 4,P-LEN >STACK
	PUT OOPS-TABLE,O-LENGTH,STACK
	GET OOPS-TABLE,O-END >STACK
	ZERO? STACK \?L113
	MUL 2,LEN >LEN
	SUB LEN,2 >STACK
	GETB P-LEXV,STACK >STACK
	SUB LEN,1 >STACK
	GETB P-LEXV,STACK >STACK
	ADD STACK,STACK >STACK
	PUT OOPS-TABLE,O-END,STACK
?L113:	SET 'RESERVE-PTR,0
	SET 'LEN,P-LEN
	SET 'P-DIRECTION,0
	SET 'P-NCN,0
	SET 'P-GETFLAGS,0
	PUT P-ITBL,P-VERBN,0
?L116:	DLESS? 'P-LEN,0 \?L118
	SET 'QUOTE-FLAG,0
	JUMP ?L117
?L118:	GET P-LEXV,PTR >WRD
	ZERO? WRD \?L121
	CALL NUMBER?,PTR >WRD
	ZERO? WRD \?L121
	CALL NAME?,PTR >WRD
	ZERO? WRD /?L120
?L121:	ZERO? P-LEN \?L122
	SET 'NW,0
	JUMP ?L124
?L122:	ADD PTR,P-LEXELEN >STACK
	GET P-LEXV,STACK >NW
?L124:	EQUAL? WRD,W?TO \?L125
	EQUAL? VERB,ACT?TELL,ACT?ASK \?L125
	PUT P-ITBL,P-VERB,ACT?TELL
	SET 'WRD,W?$QUOTE
	JUMP ?L127
?L125:	EQUAL? WRD,W?THEN \?L127
	GRTR? P-LEN,0 \?L127
	ZERO? VERB \?L127
	ZERO? QUOTE-FLAG \?L127
	PUT P-ITBL,P-VERB,ACT?TELL
	PUT P-ITBL,P-VERBN,0
	SET 'WRD,W?$QUOTE
?L127:	EQUAL? WRD,W?$PERIOD \?L129
	EQUAL? LW,W?MRS,W?MR,W?MS /?L131
	EQUAL? LW,W?DR \?L129
?L131:	SET 'LW,0
	JUMP ?L191
?L129:	EQUAL? WRD,W?THEN,W?$PERIOD,W?$QUOTE /?L133
	EQUAL? WRD,W?$0021,W?? \?L132
?L133:	EQUAL? WRD,W?$QUOTE \?L138
	ZERO? QUOTE-FLAG /?L136
	SET 'QUOTE-FLAG,0
	JUMP ?L138
?L136:	SET 'QUOTE-FLAG,1
?L138:	ZERO? P-LEN /?L140
	ADD PTR,P-LEXELEN >P-CONT
?L140:	PUTB P-LEXV,P-LEXWORDS,P-LEN
	JUMP ?L117
?L132:	CALL WT?,WRD,PS?DIRECTION,P1?DIRECTION >VAL
	ZERO? VAL /?L142
	EQUAL? VERB,0,ACT?HEAD \?L142
	EQUAL? LEN,1 /?L143
	EQUAL? LEN,2 \?L144
	EQUAL? VERB,ACT?HEAD /?L143
?L144:	EQUAL? NW,W?THEN,W?$PERIOD,W?$QUOTE \?L145
	GRTR? LEN,1 /?L143
?L145:	EQUAL? NW,W?$0021,W?? \?L146
	GRTR? LEN,1 /?L143
?L146:	ZERO? QUOTE-FLAG /?L147
	EQUAL? LEN,2 \?L147
	EQUAL? NW,W?$QUOTE /?L143
?L147:	GRTR? LEN,2 \?L142
	EQUAL? NW,W?$COMMA,W?AND \?L142
?L143:	SET 'DIR,VAL
	EQUAL? NW,W?$COMMA,W?AND \?L148
	ADD PTR,P-LEXELEN >STACK
	CALL CHANGE-LEXV,STACK,W?THEN
?L148:	GRTR? LEN,2 /?L191
	SET 'QUOTE-FLAG,0
	JUMP ?L117
?L142:	CALL WT?,WRD,PS?VERB,P1?VERB >VAL
	ZERO? VAL /?L154
	ZERO? VERB \?L154
	ZERO? P-OFLAG \?L155
	SET 'P-PRSA-WORD,WRD
?L155:	SET 'VERB,VAL
	PUT P-ITBL,P-VERB,VAL
	PUT P-ITBL,P-VERBN,P-VTBL
	PUT P-VTBL,0,WRD
	MUL PTR,2 >STACK
	ADD STACK,2 >TMP
	GETB P-LEXV,TMP >STACK
	PUTB P-VTBL,2,STACK
	ADD TMP,1 >STACK
	GETB P-LEXV,STACK >STACK
	PUTB P-VTBL,3,STACK
	JUMP ?L191
?L154:	CALL WT?,WRD,PS?PREPOSITION,0 >VAL
	ZERO? VAL \?L160
	EQUAL? WRD,W?ALL,W?ONE,W?A /?L160
	CALL WT?,WRD,PS?ADJECTIVE >STACK
	ZERO? STACK \?L160
	CALL WT?,WRD,PS?OBJECT >STACK
	ZERO? STACK /?L158
?L160:	GRTR? P-LEN,1 \?L161
	EQUAL? NW,W?OF \?L161
	ZERO? VAL \?L211
	EQUAL? WRD,W?ALL,W?ONE,W?A /?L161
	PUT P-OFW,P-NCN,WRD
	SET 'OF-FLAG,1
	JUMP ?L191
?L161:	ZERO? VAL /?L163
?L211:	ZERO? P-LEN /?L164
	EQUAL? NW,W?THEN,W?$PERIOD /?L164
	EQUAL? NW,W?$0021,W?? \?L163
?L164:	SET 'P-END-ON-PREP,1
	LESS? P-NCN,2 \?L191
	PUT P-ITBL,P-PREP1,VAL
	PUT P-ITBL,P-PREP1N,WRD
	JUMP ?L191
?L163:	EQUAL? P-NCN,2 \?L168
	PRINTI "[I found too many nouns in that sentence!]"
	CRLF
	RFALSE
?L168:	INC 'P-NCN
	CALL CLAUSE,PTR,VAL,WRD >PTR
	ZERO? PTR /FALSE
	LESS? PTR,0 \?L191
	SET 'QUOTE-FLAG,0
	JUMP ?L117
?L158:	EQUAL? WRD,W?OF \?L178
	ZERO? OF-FLAG /?L181
	EQUAL? NW,W?$PERIOD,W?THEN /?L181
	EQUAL? NW,W?$0021,W?? \?L179
?L181:	CALL CANT-USE,PTR
	RFALSE
?L179:	SET 'OF-FLAG,0
	JUMP ?L191
?L178:	CALL WT?,WRD,PS?BUZZ-WORD >STACK
	ZERO? STACK /?L183
	CALL BUZZER-WORD?,WRD,PTR >STACK
	ZERO? STACK /?L191
	RFALSE
?L183:	EQUAL? VERB,ACT?TELL \?L187
	CALL WT?,WRD,PS?VERB >STACK
	ZERO? STACK /?L187
	PRINTI "[Please consult your manual on how to talk to people.]"
	CRLF
	RFALSE
?L187:	CALL CANT-USE,PTR
	RFALSE
?L120:	CALL UNKNOWN-WORD,PTR
	RFALSE
?L191:	SET 'LW,WRD
	ADD PTR,P-LEXELEN >PTR
	JUMP ?L116
?L117:	PUT OOPS-TABLE,O-PTR,0
	ZERO? DIR /?L192
	SET 'PRSA,V?WALK
	SET 'P-WALK-DIR,DIR
	SET 'AGAIN-DIR,DIR
	SET 'PRSO,DIR
	SET 'P-OFLAG,0
	RTRUE
?L192:	SET 'P-WALK-DIR,0
	SET 'AGAIN-DIR,0
	ZERO? P-OFLAG /?L195
	CALL ORPHAN-MERGE >STACK
	ZERO? STACK /?L195
	SET 'WINNER,OWINNER
?L195:	GET P-ITBL,P-VERB >STACK
	ZERO? STACK \?L206
	SUB PTR,P-LEXELEN >PTR
	SET 'TMP,0
	GRTR? PTR,0 \?L200
	GET P-LEXV,PTR >TMP
?L200:	EQUAL? TMP,W?PLEASE \?L203
	PUT P-ITBL,P-VERB,ACT?YES
	JUMP ?L206
?L203:	EQUAL? TMP,W?$PERIOD \?L205
	CALL MISSING,STR?66
	RFALSE
?L205:	PUT P-ITBL,P-VERB,ACT?$0024CALL
?L206:	CALL SYNTAX-CHECK >STACK
	ZERO? STACK /FALSE
	CALL SNARF-OBJECTS >STACK
	ZERO? STACK /FALSE
	CALL MANY-CHECK >STACK
	ZERO? STACK /FALSE
	CALL TAKE-CHECK >STACK
	ZERO? STACK \TRUE
	RFALSE

	.FUNCT CHANGE-LEXV,PTR,WRD
	PUT P-LEXV,PTR,WRD
	PUT AGAIN-LEXV,PTR,WRD
	RTRUE

	.FUNCT PRINT-LEXV,PTR,X
	PRINT I-ASSUME
	MUL 2,PTR >STACK
	ADD P-LEXV,STACK >X
	MUL P-WORDLEN,P-LEN >STACK
	ADD X,STACK >STACK
	CALL BUFFER-PRINT,X,STACK,0
	PRINTR "]"

	.FUNCT STUFF,DEST,SRC,MAX=29,PTR=P-LEXSTART,CTR=1,BPTR
	GETB SRC,0 >STACK
	PUTB DEST,0,STACK
	GETB SRC,1 >STACK
	PUTB DEST,1,STACK
?L1:	GET SRC,PTR >STACK
	PUT DEST,PTR,STACK
	MUL PTR,2 >STACK
	ADD STACK,2 >BPTR
	GETB SRC,BPTR >STACK
	PUTB DEST,BPTR,STACK
	MUL PTR,2 >STACK
	ADD STACK,3 >BPTR
	GETB SRC,BPTR >STACK
	PUTB DEST,BPTR,STACK
	ADD PTR,P-LEXELEN >PTR
	IGRTR? 'CTR,MAX \?L1
	RTRUE

	.FUNCT INBUF-STUFF,DEST,SRC,CNT=80
?L1:	DLESS? 'CNT,0 /TRUE
	GETB SRC,CNT >STACK
	PUTB DEST,CNT,STACK
	JUMP ?L1

	.FUNCT INBUF-ADD,LEN,BEG,SLOT,DBEG,CTR=0,TMP
	GET OOPS-TABLE,O-END >TMP
	ZERO? TMP /?L1
	SET 'DBEG,TMP
	JUMP ?L3
?L1:	GET OOPS-TABLE,O-LENGTH >TMP
	ADD TMP,1 >STACK
	GETB AGAIN-LEXV,STACK >STACK
	GETB AGAIN-LEXV,TMP >STACK
	ADD STACK,STACK >DBEG
?L3:	ADD DBEG,LEN >STACK
	PUT OOPS-TABLE,O-END,STACK
?L4:	ADD BEG,CTR >STACK
	GETB P-INBUF,STACK >STACK
	ADD DBEG,CTR >STACK
	PUTB OOPS-INBUF,STACK,STACK
	INC 'CTR
	EQUAL? CTR,LEN \?L4
	PUTB AGAIN-LEXV,SLOT,DBEG
	SUB SLOT,1 >STACK
	PUTB AGAIN-LEXV,STACK,LEN
	RTRUE

	.FUNCT FIX-POSSESSIVES,START,END,WHERE=0,PTR,N,PNAM,PADJ,VAL=0,X
	SET 'PNAM,P-NAM
	SET 'PADJ,P-ADJ
	SET 'P-ADJ,0
	SET 'PTR,END
?L1:	SUB PTR,P-LEXELEN >PTR
	EQUAL? PTR,START /?L2
	GET P-LEXV,PTR >STACK
	EQUAL? STACK,W?$APOSTROPHE \?L1
	SUB PTR,P-LEXELEN >STACK
	GET P-LEXV,STACK >P-NAM
	SET 'N,RHINO-HEAD-C
?L6:	ZERO? P-NAM /?L8
	GET CHARACTER-TABLE,N >STACK
	CALL THIS-IT?,STACK >STACK
	ZERO? STACK /?L8
	GET CHARACTER-TABLE,N >STACK
	CALL THIS-IS-IT,STACK
	ADD 1,N >STACK
	GET CHAR-POSS-TABLE,STACK >VAL
	SUB PTR,WHERE >STACK
	CALL CHANGE-LEXV,STACK,VAL
	JUMP ?L7
?L8:	DLESS? 'N,0 \?L6
?L7:	LESS? N,0 \?L1
	SUB PTR,P-LEXELEN >STACK
	CALL NAME?,STACK >STACK
	ZERO? STACK /?L15
	SUB PTR,WHERE >STACK
	CALL CHANGE-LEXV,STACK,W?MY
	JUMP ?L1
?L15:	GET QWP1-TABLE,0 >N
	ADD PTR,P-LEXELEN >STACK
	GET P-LEXV,STACK >X
?L18:	GET QWP1-TABLE,N >STACK
	EQUAL? STACK,P-NAM \?L20
	GET QWP2-TABLE,N >STACK
	EQUAL? STACK,X \?L20
	CALL QUESTION-WORD?,P-NAM,1
	RTRUE
?L20:	DLESS? 'N,1 \?L18
	JUMP ?L1
?L2:	SET 'P-NAM,PNAM
	SET 'P-ADJ,PADJ
	RETURN VAL

	.FUNCT NAME?,PTR,?TMP
	CALL XNAME?,PTR,FIRST-NAME >?TMP
	ZERO? ?TMP /?L2
	RETURN ?TMP
?L2:	CALL XNAME?,PTR,LAST-NAME >?TMP
	ZERO? ?TMP /?L3
	RETURN ?TMP
?L3:	CALL XNAME?,PTR,FAVE-COLOR >STACK
	RSTACK

	.FUNCT XNAME?,PTR,TBL,MAX,CNT,BPTR,CHR,N?=1,NCNT=0
	MUL PTR,2 >STACK
	ADD P-LEXV,STACK >BPTR
	GETB BPTR,2 >CNT
	GRTR? CNT,6 \?L1
	SET 'CNT,6
?L1:	GETB BPTR,3 >BPTR
	GETB TBL,0 >MAX
	LESS? MAX,7 /?L4
	SET 'MAX,6
?L4:	IGRTR? 'NCNT,MAX \?L9
	ZERO? CNT /?L8
	SET 'N?,0
	JUMP ?L8
?L9:	DLESS? 'CNT,0 \?L14
	SET 'N?,0
	JUMP ?L8
?L14:	GETB P-INBUF,BPTR >CHR
	EQUAL? CHR,45,39,38 /?L16
	MOD CHR,32 >STACK
	ADD 96,STACK >CHR
?L16:	GETB TBL,NCNT >STACK
	EQUAL? CHR,STACK /?L19
	SET 'N?,0
?L19:	INC 'BPTR
	JUMP ?L4
?L8:	ZERO? N? /FALSE
	EQUAL? TBL,FIRST-NAME \?L24
	CALL CHANGE-LEXV,PTR,W?F$002eN
	RETURN W?F$002eN
?L24:	EQUAL? TBL,FAVE-COLOR \?L26
	CALL CHANGE-LEXV,PTR,W?F$002eC
	RETURN W?F$002eC
?L26:	CALL CHANGE-LEXV,PTR,W?L$002eN
	RETURN W?L$002eN

	.FUNCT WT?,PTR,BIT,B1=5,OFFS=P-P1OFF,TYP
	GETB PTR,P-PSOFF >TYP
	BTST TYP,BIT \FALSE
	GRTR? B1,4 /TRUE
	EQUAL? BIT,PS?OBJECT /TRUE
	BAND TYP,P-P1BITS >TYP
	EQUAL? TYP,B1 /?L7
	INC 'OFFS
?L7:	GETB PTR,OFFS >STACK
	RSTACK

	.FUNCT CLAUSE,PTR,VAL,WRD,OFF,NUM,ANDFLG=0,FIRST??=1,NW,LW=0
	SUB P-NCN,1 >STACK
	MUL STACK,2 >OFF
	ZERO? VAL /?L1
	ADD P-PREP1,OFF >NUM
	PUT P-ITBL,NUM,VAL
	ADD NUM,1 >STACK
	PUT P-ITBL,STACK,WRD
	ADD PTR,P-LEXELEN >PTR
	JUMP ?L3
?L1:	INC 'P-LEN
?L3:	ZERO? P-LEN \?L4
	DEC 'P-NCN
	RETURN -1
?L4:	ADD P-NC1,OFF >NUM
	MUL PTR,2 >STACK
	ADD P-LEXV,STACK >STACK
	PUT P-ITBL,NUM,STACK
	GET P-LEXV,PTR >STACK
	EQUAL? STACK,W?THE,W?A,W?AN \?L7
	GET P-ITBL,NUM >STACK
	ADD STACK,4 >STACK
	PUT P-ITBL,NUM,STACK
?L7:	DLESS? 'P-LEN,0 \?L12
	MUL PTR,2 >STACK
	ADD P-LEXV,STACK >STACK
	ADD NUM,1 >STACK
	PUT P-ITBL,STACK,STACK
	RETURN -1
?L12:	GET P-LEXV,PTR >WRD
	ZERO? WRD \?L17
	CALL NUMBER?,PTR >WRD
	ZERO? WRD \?L17
	CALL NAME?,PTR >WRD
	ZERO? WRD /?L15
?L17:	ZERO? P-LEN \?L18
	SET 'NW,0
	JUMP ?L21
?L18:	ADD PTR,P-LEXELEN >STACK
	GET P-LEXV,STACK >NW
	ZERO? NW \?L21
	ADD PTR,P-LEXELEN >STACK
	CALL NUMBER?,STACK >NW
?L21:	EQUAL? WRD,W?$PERIOD \?L24
	EQUAL? LW,W?MRS,W?MR,W?MS /?L26
	EQUAL? LW,W?DR \?L24
?L26:	SET 'LW,0
	JUMP ?L51
?L24:	EQUAL? WRD,W?AND,W?$COMMA \?L27
	SET 'ANDFLG,1
	JUMP ?L51
?L27:	EQUAL? WRD,W?ALL,W?ONE \?L28
	EQUAL? NW,W?OF \?L51
	DEC 'P-LEN
	ADD PTR,P-LEXELEN >PTR
	JUMP ?L51
?L28:	EQUAL? WRD,W?THEN,W?$PERIOD,W?$0021 /?L33
	EQUAL? WRD,W?? /?L33
	CALL WT?,WRD,PS?PREPOSITION >STACK
	ZERO? STACK /?L32
	GET P-ITBL,P-VERB >STACK
	ZERO? STACK /?L32
	ZERO? FIRST?? \?L32
?L33:	INC 'P-LEN
	MUL PTR,2 >STACK
	ADD P-LEXV,STACK >STACK
	ADD NUM,1 >STACK
	PUT P-ITBL,STACK,STACK
	SUB PTR,P-LEXELEN >STACK
	RSTACK
?L32:	ZERO? ANDFLG /?L34
	GET P-ITBL,P-VERBN >STACK
	ZERO? STACK /?L35
	CALL VERB-DIR-ONLY?,WRD >STACK
	ZERO? STACK /?L34
?L35:	SUB PTR,4 >PTR
	ADD PTR,2 >STACK
	CALL CHANGE-LEXV,STACK,W?THEN
	ADD P-LEN,2 >P-LEN
	JUMP ?L51
?L34:	CALL WT?,WRD,PS?OBJECT >STACK
	ZERO? STACK /?L36
	GRTR? P-LEN,0 \?L37
	EQUAL? NW,W?OF \?L37
	EQUAL? WRD,W?ALL,W?ONE /?L37
	SUB P-NCN,1 >STACK
	PUT P-OFW,STACK,WRD
	JUMP ?L51
?L37:	CALL WT?,WRD,PS?ADJECTIVE >STACK
	ZERO? STACK /?L39
	ZERO? NW /?L39
	CALL WT?,NW,PS?DIRECTION >STACK
	ZERO? STACK \?L39
	CALL WT?,NW,PS?OBJECT >STACK
	ZERO? STACK \?L51
	CALL WT?,NW,PS?ADJECTIVE >STACK
	ZERO? STACK \?L51
?L39:	ZERO? ANDFLG \?L41
	EQUAL? NW,W?BUT,W?EXCEPT,W?AND /?L41
	EQUAL? NW,W?$COMMA /?L41
	ADD PTR,2 >STACK
	MUL STACK,2 >STACK
	ADD P-LEXV,STACK >STACK
	ADD NUM,1 >STACK
	PUT P-ITBL,STACK,STACK
	RETURN PTR
?L41:	SET 'ANDFLG,0
	JUMP ?L51
?L36:	CALL WT?,WRD,PS?ADJECTIVE >STACK
	ZERO? STACK \?L51
	CALL WT?,WRD,PS?BUZZ-WORD >STACK
	ZERO? STACK /?L44
	CALL BUZZER-WORD?,WRD,PTR >STACK
	ZERO? STACK /?L51
	RFALSE
?L44:	ZERO? ANDFLG /?L48
	GET P-ITBL,P-VERB >STACK
	ZERO? STACK \?L48
	SUB PTR,4 >PTR
	ADD PTR,2 >STACK
	CALL CHANGE-LEXV,STACK,W?THEN
	ADD P-LEN,2 >P-LEN
	JUMP ?L51
?L48:	CALL WT?,WRD,PS?PREPOSITION >STACK
	ZERO? STACK \?L51
	CALL CANT-USE,PTR
	RFALSE
?L15:	CALL UNKNOWN-WORD,PTR
	RFALSE
?L51:	SET 'LW,WRD
	SET 'FIRST??,0
	ADD PTR,P-LEXELEN >PTR
	JUMP ?L7

	.FUNCT VERB-DIR-ONLY?,WRD,?TMP
	CALL WT?,WRD,PS?OBJECT >STACK
	ZERO? STACK \FALSE
	CALL WT?,WRD,PS?ADJECTIVE >STACK
	ZERO? STACK \FALSE
	CALL WT?,WRD,PS?DIRECTION >?TMP
	ZERO? ?TMP /?L5
	RETURN ?TMP
?L5:	CALL WT?,WRD,PS?VERB >STACK
	RSTACK

	.FUNCT NUMBER?,PTR,CNT,BPTR,CHR,SUM=0,TIM=0,TMP
	MUL PTR,2 >STACK
	ADD P-LEXV,STACK >TMP
	GETB TMP,2 >CNT
	GETB TMP,3 >BPTR
?L1:	DLESS? 'CNT,0 /?L2
	GETB P-INBUF,BPTR >CHR
	EQUAL? CHR,58 \?L6
	SET 'TIM,SUM
	SET 'SUM,0
	JUMP ?L11
?L6:	GRTR? SUM,29999 /FALSE
	GRTR? CHR,57 /FALSE
	LESS? CHR,48 /FALSE
	SUB CHR,48 >STACK
	MUL SUM,10 >STACK
	ADD STACK,STACK >SUM
?L11:	INC 'BPTR
	JUMP ?L1
?L2:	CALL CHANGE-LEXV,PTR,W?INT$002eNUM
	GRTR? SUM,9999 /FALSE
	ZERO? TIM /?L14
	GRTR? TIM,23 /FALSE
	MUL TIM,60 >STACK
	ADD SUM,STACK >SUM
?L14:	SET 'P-TIME,TIM
	SET 'P-NUMBER,SUM
	RETURN W?INT$002eNUM

	.FUNCT ORPHAN-MERGE,CNT=-1,TEMP,VERB,BEG,END,ADJ=0,ADJB=0,VRB=0,NOUN=0,ADJE,WRD,?TMP
	SET 'P-OFLAG,0
	GET P-ITBL,P-VERBN >WRD
	ZERO? WRD /?L9
	GET WRD,0 >WRD
	ZERO? WRD /?L9
	CALL WT?,WRD,PS?VERB,P1?VERB >?TMP
	GET P-OTBL,P-VERB >STACK
	EQUAL? ?TMP,STACK \?L3
	SET 'VRB,1
?L3:	CALL WT?,WRD,PS?ADJECTIVE >STACK
	ZERO? STACK /?L6
	SET 'ADJ,1
?L6:	CALL WT?,WRD,PS?OBJECT >STACK
	ZERO? STACK /?L9
	SET 'NOUN,1
?L9:	ZERO? VRB \?L13
	ZERO? ADJ \?L13
	CALL WT?,WRD,PS?OBJECT,P1?OBJECT >STACK
	ZERO? STACK /?L13
	ZERO? P-NCN \?L13
	PUT P-ITBL,P-VERB,0
	PUT P-ITBL,P-VERBN,0
	ADD P-LEXV,2 >STACK
	PUT P-ITBL,P-NC1,STACK
	ADD P-LEXV,6 >STACK
	PUT P-ITBL,P-NC1L,STACK
	SET 'P-NCN,1
?L13:	GET P-ITBL,P-VERB >VERB
	ZERO? VERB /?L16
	ZERO? ADJ \?L16
	ZERO? VRB \?L16
	GET P-OTBL,P-VERB >STACK
	EQUAL? VERB,STACK \FALSE
?L16:	EQUAL? P-NCN,2 /FALSE
	GET P-OTBL,P-NC1 >STACK
	EQUAL? STACK,1 \?L19
	GET P-OTBL,P-PREP1 >STACK
	GET P-ITBL,P-PREP1 >STACK
	EQUAL? STACK,0,STACK \FALSE
	ZERO? ADJ /?L27
	ADD P-LEXV,2 >STACK
	PUT P-ITBL,P-NC1,STACK
	GET P-ITBL,P-NC1L >STACK
	ZERO? STACK \?L24
	ADD P-LEXV,6 >STACK
	PUT P-ITBL,P-NC1L,STACK
?L24:	ZERO? P-NCN \?L27
	SET 'P-NCN,1
?L27:	GET P-ITBL,P-NC1 >STACK
	PUT P-OTBL,P-NC1,STACK
	GET P-ITBL,P-NC1L >STACK
	PUT P-OTBL,P-NC1L,STACK
	JUMP ?L51
?L19:	GET P-OTBL,P-NC2 >STACK
	EQUAL? STACK,1 \?L32
	GET P-OTBL,P-PREP2 >STACK
	GET P-ITBL,P-PREP1 >STACK
	EQUAL? STACK,0,STACK \FALSE
	ZERO? ADJ \?L37
	ZERO? P-NCN \?L38
	ZERO? NOUN /?L38
?L37:	ADD P-LEXV,2 >STACK
	PUT P-ITBL,P-NC1,STACK
	GET P-ITBL,P-NC1L >STACK
	ZERO? STACK \?L38
	ADD P-LEXV,6 >STACK
	PUT P-ITBL,P-NC1L,STACK
?L38:	GET P-ITBL,P-NC1 >STACK
	PUT P-OTBL,P-NC2,STACK
	GET P-ITBL,P-NC1L >STACK
	PUT P-OTBL,P-NC2L,STACK
	SET 'P-NCN,2
	JUMP ?L51
?L32:	ZERO? P-ACLAUSE /?L51
	EQUAL? P-NCN,1 /?L44
	ZERO? ADJ \?L44
	SET 'P-ACLAUSE,0
	RFALSE
?L44:	GET P-ITBL,P-NC1 >BEG
	ZERO? ADJ /?L47
	ADD P-LEXV,2 >BEG
	PUT P-ITBL,P-NC1,BEG
	SET 'ADJ,0
?L47:	GET P-ITBL,P-NC1L >END
?L50:	EQUAL? BEG,END \?L56
	ZERO? ADJB /?L54
	CALL CLAUSE-WIN,ADJB,ADJE
	JUMP ?L51
?L54:	SET 'P-ACLAUSE,0
	RFALSE
?L56:	GET BEG,0 >WRD
	EQUAL? WRD,W?ALL,W?ONE /?L60
	GETB WRD,P-PSOFF >STACK
	BTST STACK,PS?ADJECTIVE \?L58
	CALL ADJ-CHECK,WRD,ADJ,ADJ >STACK
	ZERO? STACK /?L58
?L60:	ZERO? ADJB \?L61
	SET 'ADJB,BEG
?L61:	SET 'ADJ,WRD
	ADD BEG,P-WORDLEN >ADJE
	JUMP ?L65
?L58:	GETB WRD,P-PSOFF >STACK
	BTST STACK,PS?OBJECT \?L65
	ADD BEG,P-WORDLEN >STACK
	EQUAL? STACK,END \?L65
	ZERO? P-ANAM /?L65
	EQUAL? WRD,P-ANAM /?L65
	SET 'P-ANAM,0
	GET P-ITBL,P-NC1 >ADJB
	SET 'ADJE,END
?L65:	ADD BEG,P-WORDLEN >BEG
	ZERO? END \?L50
	SET 'END,BEG
	SET 'P-NCN,1
	SUB BEG,P-WORDLEN >STACK
	PUT P-ITBL,P-NC1,STACK
	PUT P-ITBL,P-NC1L,BEG
	JUMP ?L50
?L51:	GET P-OVTBL,0 >STACK
	PUT P-VTBL,0,STACK
	GETB P-OVTBL,2 >STACK
	PUTB P-VTBL,2,STACK
	GETB P-OVTBL,3 >STACK
	PUTB P-VTBL,3,STACK
	PUT P-OTBL,P-VERBN,P-VTBL
	PUTB P-VTBL,2,0
?L73:	IGRTR? 'CNT,P-ITBLLEN \?L75
	SET 'P-MERGED,1
	RTRUE
?L75:	GET P-OTBL,CNT >STACK
	PUT P-ITBL,CNT,STACK
	JUMP ?L73

	.FUNCT CLAUSE-WIN,ADJB=0,ADJE=0
	ZERO? ADJB /?L1
	GET P-OTBL,P-VERB >STACK
	PUT P-ITBL,P-VERB,STACK
?L1:	PUT P-CCTBL,CC-BEG,P-ACLAUSE
	ADD P-ACLAUSE,1 >STACK
	PUT P-CCTBL,CC-END,STACK
	PUT P-CCTBL,CC-IBEG,ADJB
	PUT P-CCTBL,CC-IEND,ADJE
	EQUAL? P-ACLAUSE,P-NC1 \?L4
	PUT P-CCTBL,CC-CLAUSE,P-OCL1
	JUMP ?L6
?L4:	PUT P-CCTBL,CC-CLAUSE,P-OCL2
?L6:	CALL CLAUSE-COPY,P-OTBL,P-OTBL
	GET P-OTBL,P-NC2 >STACK
	ZERO? STACK /?L7
	SET 'P-NCN,2
?L7:	SET 'P-ACLAUSE,0
	RTRUE

	.FUNCT WORD-PRINT,CNT,BUF,TBL=0
	ZERO? TBL \?L1
	SET 'TBL,P-INBUF
?L1:	DLESS? 'CNT,0 /TRUE
	GETB TBL,BUF >STACK
	PRINTC STACK
	INC 'BUF
	JUMP ?L1

	.FUNCT UNKNOWN-WORD,PTR,BUF
	PUT OOPS-TABLE,O-PTR,PTR
	ZERO? P-OFLAG /?L1
	PUT OOPS-TABLE,O-END,0
?L1:	PRINTC 91
	PRINTI "I don't know the word "
	PRINTC 34
	MUL 2,PTR >BUF
	ADD P-LEXV,BUF >STACK
	GETB STACK,3 >STACK
	ADD P-LEXV,BUF >STACK
	GETB STACK,2 >STACK
	CALL WORD-PRINT,STACK,STACK
	SET 'QUOTE-FLAG,0
	SET 'P-OFLAG,0
	PRINTR ".""]"

	.FUNCT CANT-USE,PTR,BUF,?TMP
	SET 'QUOTE-FLAG,0
	SET 'P-OFLAG,0
	PRINTI "[Sorry, but I don't understand the word """
	MUL PTR,2 >BUF
	ADD P-LEXV,BUF >STACK
	GETB STACK,2 >?TMP
	ADD P-LEXV,BUF >STACK
	GETB STACK,3 >STACK
	CALL WORD-PRINT,?TMP,STACK
	PRINTR """ when you use it that way.]"

	.FUNCT SYNTAX-CHECK,SYN,LEN,NUM,OBJ,DRIVE1=0,DRIVE2=0,PREP,VERB
	GET P-ITBL,P-VERB >VERB
	ZERO? VERB \?L1
	CALL MISSING,STR?66
	RFALSE
?L1:	SUB 255,VERB >STACK
	GET VERBS,STACK >SYN
	GETB SYN,0 >LEN
	INC 'SYN
?L4:	GETB SYN,P-SBITS >STACK
	BAND STACK,P-SONUMS >NUM
	GRTR? P-NCN,NUM /?L13
	LESS? NUM,1 /?L8
	ZERO? P-NCN \?L8
	GET P-ITBL,P-PREP1 >PREP
	ZERO? PREP /?L9
	GETB SYN,P-SPREP1 >STACK
	EQUAL? PREP,STACK \?L8
?L9:	SET 'DRIVE1,SYN
	JUMP ?L13
?L8:	GET P-ITBL,P-PREP1 >STACK
	GETB SYN,P-SPREP1 >STACK
	EQUAL? STACK,STACK \?L13
	EQUAL? NUM,2 \?L11
	EQUAL? P-NCN,1 \?L11
	SET 'DRIVE2,SYN
	JUMP ?L13
?L11:	GET P-ITBL,P-PREP2 >STACK
	GETB SYN,P-SPREP2 >STACK
	EQUAL? STACK,STACK \?L13
	CALL SYNTAX-FOUND,SYN
	RTRUE
?L13:	DLESS? 'LEN,1 \?L16
	ZERO? DRIVE1 \?L66
	ZERO? DRIVE2 \?L5
	CALL DONT-UNDERSTAND
	RFALSE
?L16:	ADD SYN,P-SYNLEN >SYN
	JUMP ?L4
?L5:	ZERO? DRIVE1 /?L23
?L66:	GETB DRIVE1,P-SPREP1 >STACK
	GETB DRIVE1,P-SLOC1 >STACK
	GETB DRIVE1,P-SFWIM1 >STACK
	CALL GWIM,STACK,STACK,STACK >OBJ
	ZERO? OBJ /?L23
	PUTB P-PRSO,P-MATCHLEN,1
	PUTB P-PRSO,1,OBJ
	CALL SYNTAX-FOUND,DRIVE1 >STACK
	RSTACK
?L23:	ZERO? DRIVE2 /?L25
	GETB DRIVE2,P-SPREP2 >STACK
	GETB DRIVE2,P-SLOC2 >STACK
	GETB DRIVE2,P-SFWIM2 >STACK
	CALL GWIM,STACK,STACK,STACK >OBJ
	ZERO? OBJ /?L25
	PUTB P-PRSI,P-MATCHLEN,1
	PUTB P-PRSI,1,OBJ
	CALL SYNTAX-FOUND,DRIVE2 >STACK
	RSTACK
?L25:	SET 'OBJ,0
	EQUAL? WINNER,PLAYER \?L27
	EQUAL? P-PRSA-WORD,W?DRIVE,W?PROCEED,W?STEER /?L27
	CALL ORPHAN,DRIVE1,DRIVE2
	SET 'OBJ,1
	PRINTI "[Wh"
	JUMP ?L31
?L27:	PRINTI "[Your command was not complete. Next time, type wh"
?L31:	EQUAL? VERB,ACT?HEAD \?L34
	PRINTI "ere"
	JUMP ?L43
?L34:	ZERO? DRIVE1 /?L40
	GETB DRIVE1,P-SFWIM1 >STACK
	EQUAL? STACK,PERSONBIT /?L39
?L40:	ZERO? DRIVE2 /?L38
	GETB DRIVE2,P-SFWIM2 >STACK
	EQUAL? STACK,PERSONBIT \?L38
?L39:	PRINTI "om"
	JUMP ?L43
?L38:	PRINTI "at"
?L43:	ZERO? OBJ /?L46
	PRINTI " do you want to "
	JUMP ?L50
?L46:	PRINTI " you want"
	CALL HIM-HER-IT,WINNER
	PRINTI " to "
?L50:	CALL VERB-PRINT
	ZERO? DRIVE2 /?L53
	SET 'PREP,P-MERGED
	SET 'P-MERGED,0
	SET 'P-OFLAG,0
	CALL CLAUSE-PRINT,P-NC1,P-NC1L
	SET 'P-MERGED,PREP
?L53:	SET 'P-END-ON-PREP,0
	ZERO? DRIVE1 /?L56
	GETB DRIVE1,P-SPREP1 >STACK
	JUMP ?L58
?L56:	GETB DRIVE2,P-SPREP2 >STACK
?L58:	CALL PREP-PRINT,STACK
	ZERO? OBJ /?L59
	SET 'P-OFLAG,1
	PRINTI "?]"
	CRLF
	RFALSE
?L59:	PRINTI ".]"
	CRLF
	RFALSE

	.FUNCT DONT-UNDERSTAND
	SET 'CLOCK-WAIT,1
	PRINTR "[Sorry, but I don't understand. Please say that another way, or try something else.]"

	.FUNCT VERB-PRINT,GERUND=0,TMP
	GET P-ITBL,P-VERBN >TMP
	ZERO? TMP \?L1
	ZERO? GERUND \?L3
	PRINTI "tell"
	RTRUE
?L3:	PRINTI "walk"
	JUMP ?L23
?L1:	ZERO? GERUND \?L11
	GETB P-VTBL,2 >STACK
	ZERO? STACK \?L10
?L11:	GET TMP,0 >TMP
	EQUAL? TMP,W?L \?L12
	PRINTB W?LOOK
	JUMP ?L23
?L12:	EQUAL? TMP,W?X \?L14
	PRINTB W?EXAMINE
	JUMP ?L23
?L14:	EQUAL? TMP,W?Z \?L15
	PRINTB W?WAIT
	JUMP ?L23
?L15:	ZERO? GERUND /?L16
	EQUAL? TMP,W?BATHE \?L17
	PRINTB W?BATH
	JUMP ?L23
?L17:	EQUAL? TMP,W?DIG \?L19
	PRINTI "digg"
	JUMP ?L23
?L19:	EQUAL? TMP,W?GET \?L20
	PRINTI "gett"
	JUMP ?L23
?L20:	PRINTB TMP
	JUMP ?L23
?L16:	PRINTB TMP
	JUMP ?L23
?L10:	GETB TMP,3 >STACK
	GETB TMP,2 >STACK
	CALL WORD-PRINT,STACK,STACK
	PUTB P-VTBL,2,0
?L23:	ZERO? GERUND /FALSE
	PRINTI "ing?"
	RTRUE

	.FUNCT ORPHAN,D1,D2,CNT=-1
	ZERO? P-MERGED \?L1
	PUT P-OCL1,P-MATCHLEN,0
	PUT P-OCL2,P-MATCHLEN,0
?L1:	GET P-VTBL,0 >STACK
	PUT P-OVTBL,0,STACK
	GETB P-VTBL,2 >STACK
	PUTB P-OVTBL,2,STACK
	GETB P-VTBL,3 >STACK
	PUTB P-OVTBL,3,STACK
?L4:	IGRTR? 'CNT,P-ITBLLEN /?L5
	GET P-ITBL,CNT >STACK
	PUT P-OTBL,CNT,STACK
	JUMP ?L4
?L5:	EQUAL? P-NCN,2 \?L9
	PUT P-CCTBL,CC-BEG,P-NC2
	PUT P-CCTBL,CC-END,P-NC2L
	PUT P-CCTBL,CC-CLAUSE,P-OCL2
	PUT P-CCTBL,CC-IBEG,0
	PUT P-CCTBL,CC-IEND,0
	CALL CLAUSE-COPY,P-ITBL,P-OTBL
?L9:	LESS? P-NCN,1 /?L12
	PUT P-CCTBL,CC-BEG,P-NC1
	PUT P-CCTBL,CC-END,P-NC1L
	PUT P-CCTBL,CC-CLAUSE,P-OCL1
	PUT P-CCTBL,CC-IBEG,0
	PUT P-CCTBL,CC-IEND,0
	CALL CLAUSE-COPY,P-ITBL,P-OTBL
?L12:	ZERO? D1 /?L15
	GETB D1,P-SPREP1 >STACK
	PUT P-OTBL,P-PREP1,STACK
	PUT P-OTBL,P-NC1,1
	RTRUE
?L15:	ZERO? D2 /FALSE
	GETB D2,P-SPREP2 >STACK
	PUT P-OTBL,P-PREP2,STACK
	PUT P-OTBL,P-NC2,1
	RTRUE

	.FUNCT CLAUSE-PRINT,BPTR,EPTR,THE??1=1
	GET P-ITBL,EPTR >STACK
	GET P-ITBL,BPTR >STACK
	CALL BUFFER-PRINT,STACK,STACK,THE??1 >STACK
	RSTACK

	.FUNCT BUFFER-PRINT,BEG,END,CP,NOSP=0,WRD,NW,FIRST??=1,PN=0
?L1:	EQUAL? BEG,END /TRUE
	ZERO? NOSP \?L8
	EQUAL? WRD,W?$APOSTROPHE /?L8
	EQUAL? NW,W?$PERIOD,W?$COMMA,W?$APOSTROPHE \?L6
?L8:	SET 'NOSP,0
	JUMP ?L9
?L6:	PRINTC 32
?L9:	GET BEG,0 >WRD
	ADD BEG,P-WORDLEN >STACK
	EQUAL? END,STACK \?L12
	SET 'NW,0
	JUMP ?L14
?L12:	GET BEG,P-LEXELEN >NW
?L14:	EQUAL? WRD,W?MY /?L15
	CALL ZMEMQ,WRD,CHAR-POSS-TABLE >STACK
	ZERO? STACK /?L15
	SET 'NOSP,1
	JUMP ?L18
?L15:	EQUAL? NW,W?MY /?L17
	CALL ZMEMQ,NW,CHAR-POSS-TABLE >STACK
	ZERO? STACK /?L17
	SET 'NOSP,1
	JUMP ?L18
?L17:	ZERO? OOPS-PRINT /?L18
	EQUAL? WRD,W?HIM \?L20
	CALL VISIBLE?,P-HIM-OBJECT >STACK
	ZERO? STACK /?L19
?L20:	EQUAL? WRD,W?HER \?L18
	CALL VISIBLE?,P-HER-OBJECT >STACK
	ZERO? STACK \?L18
?L19:	SET 'PN,1
?L18:	EQUAL? WRD,W?MY \?L22
	ZERO? OOPS-PRINT \?L24
	PRINTB W?YOUR
	JUMP ?L34
?L24:	PRINTB W?MY
	JUMP ?L34
?L22:	CALL ZMEMQ,WRD,CHAR-POSS-TABLE >STACK
	ZERO? STACK /?L27
	PRINTC 39
	JUMP ?L34
?L27:	ZERO? OOPS-PRINT \?L30
	EQUAL? WRD,W?ALL,W?$PERIOD,W?$APOSTROPHE /?L30
	CALL WT?,WRD,PS?BUZZ-WORD >STACK
	ZERO? STACK \?L31
	CALL WT?,WRD,PS?PREPOSITION >STACK
	ZERO? STACK /?L30
?L31:	CALL WT?,WRD,PS?ADJECTIVE >STACK
	ZERO? STACK \?L30
	CALL WT?,WRD,PS?OBJECT >STACK
	ZERO? STACK \?L30
	SET 'NOSP,1
	JUMP ?L34
?L30:	EQUAL? WRD,W?ME \?L32
	ZERO? OOPS-PRINT \?L32
	PRINTD PLAYER
	SET 'PN,1
	JUMP ?L34
?L32:	CALL CAPITAL-NOUN?,WRD >STACK
	ZERO? STACK /?L33
	CALL CAPITALIZE,BEG
	SET 'PN,1
	JUMP ?L34
?L33:	ZERO? FIRST?? /?L37
	ZERO? PN \?L37
	ZERO? CP /?L37
	EQUAL? WRD,W?HER,W?HIM,W?YOUR /?L37
	PRINTI "the "
?L37:	ZERO? P-OFLAG \?L45
	ZERO? P-MERGED /?L43
?L45:	PRINTB WRD
	JUMP ?L49
?L43:	EQUAL? WRD,W?IT \?L46
	CALL VISIBLE?,P-IT-OBJECT >STACK
	ZERO? STACK /?L46
	PRINTD P-IT-OBJECT
	JUMP ?L49
?L46:	EQUAL? WRD,W?HER \?L47
	ZERO? PN \?L47
	PRINTD P-HER-OBJECT
	JUMP ?L49
?L47:	EQUAL? WRD,W?HIM \?L48
	ZERO? PN \?L48
	PRINTD P-HIM-OBJECT
	JUMP ?L49
?L48:	GETB BEG,3 >STACK
	GETB BEG,2 >STACK
	CALL WORD-PRINT,STACK,STACK
?L49:	SET 'FIRST??,0
?L34:	ADD BEG,P-WORDLEN >BEG
	JUMP ?L1

	.FUNCT TITLE-NOUN?,WRD
	EQUAL? WRD,W?MR,W?MRS,W?MS /TRUE
	EQUAL? WRD,W?MISTER,W?MISS,W?SIR /TRUE
	EQUAL? WRD,W?LADY,W?DAME,W?LORD /TRUE
	EQUAL? WRD,W?DR,W?DOCTOR,W?DETECT /TRUE
	EQUAL? WRD,W?MADAME,W?MADAM,W?MASTER /TRUE
	RFALSE

	.FUNCT CAPITAL-NOUN?,WRD,?TMP
	CALL TITLE-NOUN?,WRD >?TMP
	ZERO? ?TMP /?L2
	RETURN ?TMP
?L2:	EQUAL? WRD,W?BOLITHO,W?DEE,W?DEIRDRE /TRUE
	EQUAL? WRD,W?FORDYCE,W?HALLAM,W?HYDE /TRUE
	EQUAL? WRD,W?IAN,W?INDIAN,W?IRIS /TRUE
	EQUAL? WRD,W?JACK,W?LIONEL,W?LYND /TRUE
	EQUAL? WRD,W?MONTAGUE,W?MOONMIST,W?NICHOLAS /TRUE
	EQUAL? WRD,W?PENTREATH,W?TAMARA,W?TAMMY /TRUE
	EQUAL? WRD,W?TRESYLLIAN,W?VIV,W?VIVIEN /TRUE
	EQUAL? WRD,W?WENDISH /TRUE
	RFALSE

	.FUNCT CAPITALIZE,PTR
	ZERO? P-OFLAG \?L3
	ZERO? P-MERGED /?L1
?L3:	GET PTR,0 >STACK
	PRINTB STACK
	RTRUE
?L1:	GETB PTR,3 >STACK
	GETB P-INBUF,STACK >STACK
	SUB STACK,32 >STACK
	PRINTC STACK
	GETB PTR,3 >STACK
	INC 'STACK
	GETB PTR,2 >STACK
	DEC 'STACK
	CALL WORD-PRINT,STACK,STACK >STACK
	RSTACK

	.FUNCT PREP-PRINT,PREP,SP?=1,WRD,VRB
	ZERO? PREP /FALSE
	GET P-ITBL,P-VERBN >STACK
	GET STACK,0 >VRB
	ZERO? P-END-ON-PREP /?L4
	EQUAL? VRB,W?LIE,W?SIT \FALSE
	EQUAL? PREP,PR?DOWN \FALSE
?L4:	ZERO? SP? /?L8
	PRINTC 32
?L8:	CALL PREP-FIND,PREP >WRD
	EQUAL? WRD,W?AGAINST \?L13
	PRINTI "against"
	JUMP ?L20
?L13:	EQUAL? WRD,W?THROUGH \?L17
	PRINTI "through"
	JUMP ?L20
?L17:	PRINTB WRD
?L20:	EQUAL? VRB,W?SIT,W?LIE \?L21
	EQUAL? WRD,W?DOWN \?L21
	PRINTI " on"
?L21:	EQUAL? VRB,W?GET \TRUE
	EQUAL? WRD,W?OUT \TRUE
	PRINTI " of"
	RTRUE

	.FUNCT CLAUSE-COPY,SRC,DEST,IBEG=0,IEND,OCL,BEG,END,BB,EE,OBEG,CNT,B,E
	GET P-CCTBL,CC-BEG >BB
	GET P-CCTBL,CC-END >EE
	GET P-CCTBL,CC-CLAUSE >OCL
	GET P-CCTBL,CC-IBEG >IBEG
	GET P-CCTBL,CC-IEND >IEND
	GET SRC,BB >BEG
	GET SRC,EE >END
	GET OCL,P-MATCHLEN >OBEG
?L1:	EQUAL? BEG,END \?L3
	ZERO? IBEG /?L2
	ZERO? P-ANAM \?L2
	CALL CLAUSE-SUBSTRUC,IBEG,IEND
	JUMP ?L2
?L3:	ZERO? IBEG /?L9
	GET BEG,0 >STACK
	EQUAL? P-ANAM,STACK \?L9
	CALL CLAUSE-SUBSTRUC,IBEG,IEND
?L9:	GET BEG,0 >STACK
	CALL CLAUSE-ADD,STACK
	ADD BEG,P-WORDLEN >BEG
	JUMP ?L1
?L2:	GRTR? OBEG,0 \?L12
	GET OCL,P-MATCHLEN >STACK
	SUB STACK,OBEG >CNT
	GRTR? CNT,0 \?L12
	PUT OCL,P-MATCHLEN,0
	INC 'OBEG
?L14:	GET OCL,OBEG >STACK
	CALL CLAUSE-ADD,STACK,1
	SUB CNT,2 >CNT
	ZERO? CNT /?L15
	ADD OBEG,2 >OBEG
	JUMP ?L14
?L15:	SET 'OBEG,0
?L12:	MUL OBEG,P-LEXELEN >STACK
	ADD STACK,2 >STACK
	ADD OCL,STACK >STACK
	PUT DEST,BB,STACK
	GET OCL,P-MATCHLEN >STACK
	MUL STACK,P-LEXELEN >STACK
	ADD STACK,2 >STACK
	ADD OCL,STACK >STACK
	PUT DEST,EE,STACK
	RTRUE

	.FUNCT CLAUSE-SUBSTRUC,B,E
?L1:	EQUAL? B,E /TRUE
	GET B,0 >STACK
	CALL CLAUSE-ADD,STACK
	ADD B,P-WORDLEN >B
	JUMP ?L1

	.FUNCT CLAUSE-ADD,WRD,CHECK?=0,OCL,PTR
	GET P-CCTBL,CC-CLAUSE >OCL
	GET OCL,P-MATCHLEN >PTR
	ZERO? CHECK? /?L1
	ZERO? PTR /?L1
	CALL ZMEMQ,WRD,OCL >STACK
	ZERO? STACK \FALSE
?L1:	ADD PTR,2 >PTR
	SUB PTR,1 >STACK
	PUT OCL,STACK,WRD
	PUT OCL,PTR,0
	PUT OCL,P-MATCHLEN,PTR
	RTRUE

	.FUNCT PREP-FIND,PREP,CNT=0,SIZE
	GET PREPOSITIONS,0 >STACK
	MUL STACK,2 >SIZE
?L1:	IGRTR? 'CNT,SIZE /FALSE
	GET PREPOSITIONS,CNT >STACK
	EQUAL? STACK,PREP \?L1
	SUB CNT,1 >STACK
	GET PREPOSITIONS,STACK >STACK
	RSTACK

	.FUNCT SYNTAX-FOUND,SYN
	SET 'P-SYNTAX,SYN
	GETB SYN,P-SACTION >PRSA
	RETURN PRSA

	.FUNCT GWIM,GBIT,LBIT,PREP,OBJ
	EQUAL? GBIT,RMUNGBIT \?L1
	RETURN ROOMS
?L1:	SET 'P-GWIMBIT,GBIT
	SET 'P-SLOCBITS,LBIT
	PUTB P-MERGE,P-MATCHLEN,0
	CALL GET-OBJECT,P-MERGE,0 >STACK
	ZERO? STACK /?L4
	SET 'P-GWIMBIT,0
	GETB P-MERGE,P-MATCHLEN >STACK
	EQUAL? STACK,1 \FALSE
	GETB P-MERGE,1 >OBJ
	PRINTC 40
	CALL PREP-PRINT,PREP,0 >STACK
	ZERO? STACK /?L10
	CALL THE?,OBJ
	PRINTC 32
?L10:	PRINTD OBJ
	PRINTC 41
	CRLF
	RETURN OBJ
?L4:	SET 'P-GWIMBIT,0
	RFALSE

	.FUNCT SNARF-OBJECTS,PTR
	GET P-ITBL,P-NC1 >PTR
	ZERO? PTR /?L6
	SET 'P-PHR,0
	GETB P-SYNTAX,P-SLOC1 >P-SLOCBITS
	GET P-ITBL,P-NC1L >STACK
	CALL SNARFEM,PTR,STACK,P-PRSO >STACK
	ZERO? STACK /FALSE
	GETB P-BUTS,P-MATCHLEN >STACK
	ZERO? STACK /?L6
	CALL BUT-MERGE,P-PRSO >P-PRSO
?L6:	GET P-ITBL,P-NC2 >PTR
	ZERO? PTR /TRUE
	SET 'P-PHR,1
	GETB P-SYNTAX,P-SLOC2 >P-SLOCBITS
	GET P-ITBL,P-NC2L >STACK
	CALL SNARFEM,PTR,STACK,P-PRSI >STACK
	ZERO? STACK /FALSE
	GETB P-BUTS,P-MATCHLEN >STACK
	ZERO? STACK /TRUE
	GETB P-PRSI,P-MATCHLEN >STACK
	EQUAL? STACK,1 \?L17
	CALL BUT-MERGE,P-PRSO >P-PRSO
	RTRUE
?L17:	CALL BUT-MERGE,P-PRSI >P-PRSI
	RTRUE

	.FUNCT BUT-MERGE,TBL,LEN,BUTLEN,CNT=1,MATCHES=0,OBJ,NTBL
	GETB TBL,P-MATCHLEN >LEN
	PUTB P-MERGE,P-MATCHLEN,0
?L1:	DLESS? 'LEN,0 /?L2
	GETB TBL,CNT >OBJ
	CALL ZMEMQB,OBJ,P-BUTS >STACK
	ZERO? STACK \?L5
	INC 'MATCHES
	PUTB P-MERGE,MATCHES,OBJ
?L5:	INC 'CNT
	JUMP ?L1
?L2:	PUTB P-MERGE,P-MATCHLEN,MATCHES
	SET 'NTBL,P-MERGE
	SET 'P-MERGE,TBL
	RETURN NTBL

	.FUNCT ADJ-CHECK,WRD,ADJ,NW=0
	ZERO? ADJ /TRUE
	EQUAL? WRD,W?RHINO,W?BUFFALO,W?BLOND /TRUE
	EQUAL? WRD,W?BLONDE,W?FIRST,W?SECOND /TRUE
	EQUAL? NW,W?OUTFIT /TRUE
	CALL ZMEMQ,WRD,CHAR-POSS-TABLE >STACK
	ZERO? STACK \TRUE
	RFALSE

	.FUNCT SNARFEM,PTR,EPTR,TBL,BUT=0,LEN,WV,WRD,NW,WAS-ALL=0,ONEOBJ
	SET 'P-NAM,0
	SET 'P-ADJ,0
	SET 'P-ADJN,0
	SET 'P-AND,0
	EQUAL? P-GETFLAGS,P-ALL \?L1
	SET 'WAS-ALL,1
?L1:	SET 'P-GETFLAGS,0
	PUTB P-BUTS,P-MATCHLEN,0
	PUTB TBL,P-MATCHLEN,0
	GET PTR,0 >WRD
?L4:	EQUAL? PTR,EPTR \?L6
?L63:	ZERO? BUT /?L9
	PUSH BUT
	JUMP ?L8
?L9:	PUSH TBL
?L8:	CALL GET-OBJECT,STACK >WV
	ZERO? WAS-ALL /?L10
	SET 'P-GETFLAGS,P-ALL
?L10:	RETURN WV
?L6:	ADD PTR,P-WORDLEN >STACK
	EQUAL? EPTR,STACK \?L14
	SET 'NW,0
	JUMP ?L16
?L14:	GET PTR,P-LEXELEN >NW
?L16:	EQUAL? WRD,W?ALL \?L17
	SET 'P-GETFLAGS,P-ALL
	EQUAL? NW,W?OF \?L58
	ADD PTR,P-WORDLEN >PTR
	JUMP ?L58
?L17:	EQUAL? WRD,W?BUT,W?EXCEPT \?L22
	ZERO? BUT /?L26
	PUSH BUT
	JUMP ?L25
?L26:	PUSH TBL
?L25:	CALL GET-OBJECT,STACK >STACK
	ZERO? STACK /FALSE
	SET 'BUT,P-BUTS
	PUTB BUT,P-MATCHLEN,0
	JUMP ?L58
?L22:	EQUAL? WRD,W?A,W?ONE \?L28
	ZERO? P-ADJ \?L29
	SET 'P-GETFLAGS,P-ONE
	EQUAL? NW,W?OF \?L58
	ADD PTR,P-WORDLEN >PTR
	JUMP ?L58
?L29:	SET 'P-NAM,ONEOBJ
	ZERO? BUT /?L38
	PUSH BUT
	JUMP ?L37
?L38:	PUSH TBL
?L37:	CALL GET-OBJECT,STACK >STACK
	ZERO? STACK /FALSE
	ZERO? NW /TRUE
	JUMP ?L58
?L28:	EQUAL? WRD,W?AND,W?$COMMA \?L42
	EQUAL? NW,W?AND,W?$COMMA /?L42
	SET 'P-AND,1
	ZERO? BUT /?L46
	PUSH BUT
	JUMP ?L45
?L46:	PUSH TBL
?L45:	CALL GET-OBJECT,STACK >STACK
	ZERO? STACK \?L58
	RFALSE
?L42:	CALL WT?,WRD,PS?BUZZ-WORD >STACK
	ZERO? STACK /?L48
	CALL BUZZER-WORD?,WRD,PTR >STACK
	ZERO? STACK /?L58
	RFALSE
?L48:	EQUAL? WRD,W?AND,W?$COMMA /?L58
	EQUAL? WRD,W?OF \?L53
	ZERO? P-GETFLAGS \?L58
	SET 'P-GETFLAGS,P-INHIBIT
	JUMP ?L58
?L53:	CALL WT?,WRD,PS?ADJECTIVE,P1?ADJECTIVE >WV
	ZERO? WV /?L57
	CALL ADJ-CHECK,WRD,P-ADJ,NW >STACK
	ZERO? STACK /?L57
	EQUAL? NW,W?OF /?L57
	SET 'P-ADJ,WV
	SET 'P-ADJN,WRD
	JUMP ?L58
?L57:	CALL WT?,WRD,PS?OBJECT >STACK
	ZERO? STACK /?L58
	SET 'P-NAM,WRD
	SET 'ONEOBJ,WRD
?L58:	EQUAL? PTR,EPTR /?L63
	ADD PTR,P-WORDLEN >PTR
	SET 'WRD,NW
	JUMP ?L4

	.FUNCT RESOLVE-YOUR-HER-HIS,OBJ=0
	EQUAL? P-ADJN,W?YOUR \?L1
	EQUAL? WINNER,PLAYER /?L7
	SET 'OBJ,WINNER
	JUMP ?L7
?L1:	EQUAL? P-ADJN,W?HER \?L6
	SET 'OBJ,P-HER-OBJECT
	JUMP ?L7
?L6:	EQUAL? P-ADJN,W?HIS \?L7
	SET 'OBJ,P-HIM-OBJECT
?L7:	ZERO? OBJ /FALSE
	GETP OBJ,P?CHARACTER >STACK
	INC 'STACK
	GET CHAR-POSS-TABLE,STACK >P-ADJN
	CALL WT?,P-ADJN,PS?ADJECTIVE,P1?ADJECTIVE >P-ADJ
	RETURN P-ADJ

	.FUNCT GET-OBJECT,TBL,VRB=1,BTS,LEN,XBITS,TLEN,GCHECK=0,OLEN=0,OBJ=0,ADJ=0
	SET 'XBITS,P-SLOCBITS
	GETB TBL,P-MATCHLEN >TLEN
	BTST P-GETFLAGS,P-INHIBIT /TRUE
	EQUAL? P-ADJN,W?YOUR,W?HER,W?HIS \?L4
	ZERO? P-NAM /?L4
	CALL RESOLVE-YOUR-HER-HIS
?L4:	SET 'ADJ,P-ADJN
	ZERO? P-NAM \?L14
	ZERO? P-ADJ /?L11
	CALL WT?,P-ADJN,PS?OBJECT >STACK
	ZERO? STACK /?L9
	SET 'P-NAM,P-ADJN
	SET 'P-ADJ,0
	SET 'P-ADJN,0
	JUMP ?L11
?L9:	CALL WT?,P-ADJN,PS?DIRECTION,P1?DIRECTION >BTS
	ZERO? BTS /?L11
	SET 'P-ADJ,0
	SET 'P-ADJN,0
	PUTB TBL,P-MATCHLEN,1
	PUTB TBL,1,INTDIR
	SET 'P-DIRECTION,BTS
	RTRUE
?L11:	ZERO? P-NAM \?L14
	ZERO? P-ADJ \?L14
	EQUAL? P-GETFLAGS,P-ALL /?L79
	ZERO? P-GWIMBIT \?L14
	ZERO? VRB /FALSE
	CALL MISSING,STR?67,ADJ
	RFALSE
?L14:	EQUAL? P-GETFLAGS,P-ALL \?L22
?L79:	ZERO? P-SLOCBITS \?L20
?L22:	SET 'P-SLOCBITS,-1
?L20:	SET 'P-TABLE,TBL
?L24:	ZERO? GCHECK /?L26
	CALL GLOBAL-CHECK,TBL
	JUMP ?L28
?L26:	ZERO? LIT /?L29
	FCLEAR WINNER,OPENBIT
	CALL DO-SL,HERE,SOG,SIR
	FSET WINNER,OPENBIT
?L29:	CALL DO-SL,WINNER,SH,SC
?L28:	GETB TBL,P-MATCHLEN >STACK
	SUB STACK,TLEN >LEN
	BTST P-GETFLAGS,P-ALL /?L42
	BTST P-GETFLAGS,P-ONE \?L34
	ZERO? LEN /?L34
	EQUAL? LEN,1 /?L35
	RANDOM LEN >STACK
	GETB TBL,STACK >STACK
	PUTB TBL,1,STACK
	GETB TBL,1 >STACK
	CALL TELL-I-ASSUME,STACK
?L35:	PUTB TBL,P-MATCHLEN,1
	JUMP ?L42
?L34:	EQUAL? P-GETFLAGS,P-ALL /?L42
	GRTR? LEN,1 /?L39
	ZERO? LEN \?L74
	EQUAL? P-SLOCBITS,-1 /?L42
?L39:	EQUAL? P-SLOCBITS,-1 \?L40
	SET 'P-SLOCBITS,XBITS
	SET 'OLEN,LEN
	GETB TBL,P-MATCHLEN >STACK
	SUB STACK,LEN >STACK
	PUTB TBL,P-MATCHLEN,STACK
	JUMP ?L24
?L40:	CALL PUT-ADJ-NAM
	ZERO? LEN \?L43
	SET 'LEN,OLEN
?L43:	GRTR? LEN,1 \?L46
	GETB TBL,LEN >OBJ
	ZERO? OBJ /?L46
	GETP OBJ,P?GENERIC >STACK
	CALL STACK,TBL,LEN >OBJ
	ZERO? OBJ /?L46
	EQUAL? OBJ,NOT-HERE-OBJECT /FALSE
	EQUAL? OBJ,ROOMS \?L50
	GETB TBL,P-MATCHLEN >LEN
	JUMP ?L52
?L50:	ADD TLEN,1 >LEN
	PUTB TBL,P-MATCHLEN,LEN
	PUTB TBL,LEN,OBJ
	SET 'P-NAM,0
	SET 'P-ADJ,0
	SET 'P-ADJN,0
	RTRUE
?L46:	ZERO? VRB /?L62
	EQUAL? WINNER,PLAYER /?L52
	CALL MORE-SPECIFIC
	RFALSE
?L52:	ZERO? VRB /?L62
	ZERO? P-NAM /?L54
	CALL WHICH-PRINT,TLEN,LEN,TBL >STACK
	ZERO? STACK /?L62
	EQUAL? TBL,P-PRSO \?L58
	SET 'P-ACLAUSE,P-NC1
	JUMP ?L60
?L58:	SET 'P-ACLAUSE,P-NC2
?L60:	SET 'P-AADJ,P-ADJ
	SET 'P-ANAM,P-NAM
	CALL ORPHAN,0,0
	SET 'P-OFLAG,1
	JUMP ?L62
?L54:	ZERO? VRB /?L62
	CALL MISSING,STR?67,ADJ
?L62:	SET 'P-NAM,0
	SET 'P-ADJ,0
	SET 'P-ADJN,0
	RFALSE
?L42:	ZERO? LEN \?L74
	ZERO? GCHECK /?L65
	CALL PUT-ADJ-NAM
	ZERO? VRB /?L72
	SET 'P-SLOCBITS,XBITS
	ZERO? LIT \?L71
	CALL SEE-VERB? >STACK
	ZERO? STACK \?L69
?L71:	CALL OBJ-FOUND,NOT-HERE-OBJECT,TBL
	SET 'P-XNAM,P-NAM
	SET 'P-NAM,0
	SET 'P-XADJ,P-ADJ
	SET 'P-XADJN,P-ADJN
	RTRUE
?L69:	CALL TOO-DARK
?L72:	SET 'P-NAM,0
	SET 'P-ADJ,0
	SET 'P-ADJN,0
	RFALSE
?L65:	ZERO? LEN \?L74
	SET 'GCHECK,1
	JUMP ?L24
?L74:	ZERO? P-ADJ /?L76
	ZERO? P-NAM \?L76
	ADD TLEN,1 >STACK
	GETB TBL,STACK >OBJ
	CALL TELL-I-ASSUME,OBJ
	CALL THIS-IS-IT,OBJ
?L76:	SET 'P-SLOCBITS,XBITS
	CALL PUT-ADJ-NAM
	SET 'P-NAM,0
	SET 'P-ADJ,0
	SET 'P-ADJN,0
	RTRUE

	.FUNCT GENERIC-CLUE-FCN,TBL,LEN=0
	EQUAL? PRSA,V?SEARCH-FOR,V?FIND \?L1
	RETURN GENERIC-CLUE
?L1:	ZERO? LEN \?L4
	GETB TBL,0 >LEN
?L4:	CALL PRUNE,TBL,LEN,CLUE-TEST >LEN
	EQUAL? LEN,1 \?L7
	GETB TBL,1 >STACK
	RSTACK
?L7:	RETURN ROOMS

	.FUNCT CLUE-TEST,OBJ
	IN? OBJ,WINNER /TRUE
	ZERO? PRSI /?L3
	IN? OBJ,PRSI /TRUE
?L3:	EQUAL? OBJ,P-IT-OBJECT /TRUE
	RFALSE

	.FUNCT GENERIC-STAIRS,X,Y
	EQUAL? PRSA,V?CLIMB-UP,V?CLIMB-DOWN,V?BOARD \?L1
	RETURN STAIRS
?L1:	RETURN BACKSTAIRS

	.FUNCT GENERIC-CLOTHES,X,Y
	EQUAL? PRSA,V?TAKE-OFF,V?REMOVE,V?CHANGE \FALSE
	RETURN NOW-WEARING

	.FUNCT GENERIC-CLOSET,TBL,LEN=0,N
	CALL ZMEMQ,HERE,CHAR-ROOM-TABLE,CHARACTER-MAX >N
	ZERO? N /?L1
	GET CHAR-CLOSET-TABLE,N >STACK
	RSTACK
?L1:	ZERO? TBL /FALSE
	CALL ZMEMQB,HERE,TBL >STACK
	ZERO? STACK /?L5
	RETURN HERE
?L5:	ZERO? LEN \?L8
	GETB TBL,0 >LEN
?L8:	CALL PRUNE,TBL,LEN,NOT-SECRET-TEST >LEN
	ZERO? LEN \?L11
	PRINTI "(You haven't found a secret entrance yet!)"
	CRLF
	RETURN NOT-HERE-OBJECT
?L11:	EQUAL? LEN,1 \?L15
	GETB TBL,1 >STACK
	RSTACK
?L15:	RETURN ROOMS

	.FUNCT GENERIC-DINNER,X,Y
	CALL REMOTE-VERB? >STACK
	ZERO? STACK \?L3
	EQUAL? PRSA,V?EXAMINE \?L1
?L3:	RETURN DINNER
?L1:	EQUAL? P-ADJ,0,A?MY \?L4
	EQUAL? P-XADJ,0,A?MY \?L4
	RETURN DINNER
?L4:	SET 'CLOCK-WAIT,1
	PRINTI "(That wouldn't be polite!)"
	CRLF
	RETURN NOT-HERE-OBJECT

	.FUNCT GENERIC-BEDROOM,TBL,N=0,RM
	ZERO? N \?L1
	GETB TBL,P-MATCHLEN >N
?L1:	CALL ZMEMQ,HERE,CHAR-CLOSET-TABLE >RM
	ZERO? RM /?L4
	EQUAL? W?DOOR,P-NAM,P-XNAM \?L6
	CALL FIND-FLAG-LG,HERE,DOORBIT >STACK
	RSTACK
?L6:	GET CHAR-ROOM-TABLE,RM >STACK
	RSTACK
?L4:	EQUAL? A?JACK$0027S,P-ADJ,P-XADJ \?L9
	EQUAL? W?DOOR,P-NAM,P-XNAM \?L9
	RETURN JACK-ROOM
?L9:	CALL ZMEMQB,P-IT-OBJECT,TBL >STACK
	ZERO? STACK /?L10
	RETURN P-IT-OBJECT
?L10:	CALL ZMEMQB,HERE,TBL >STACK
	ZERO? STACK /?L11
	RETURN HERE
?L11:	CALL REMOTE-VERB? >STACK
	ZERO? STACK /?L12
	EQUAL? A?BATH,P-ADJ,P-XADJ \?L13
	RETURN YOUR-BATHROOM
?L13:	EQUAL? W?ROOM,P-NAM,P-XNAM \?L15
	RETURN YOUR-ROOM
?L15:	SET 'RM,0
	JUMP ?L22
?L12:	EQUAL? HERE,GALLERY,YOUR-BATHROOM \?L17
	RETURN YOUR-ROOM
?L17:	CALL ZMEMQ,HERE,CHAR-ROOM-TABLE >STACK
	ZERO? STACK /?L18
	RETURN HERE
?L18:	EQUAL? PRSA,V?WALK-TO,V?CLIMB-UP,V?CLIMB-DOWN \?L19
	RETURN YOUR-ROOM
?L19:	GETB TBL,N >RM
	GETP RM,P?STATION >STACK
	EQUAL? HERE,STACK /?L22
	DLESS? 'N,1 \?L19
	SET 'RM,0
?L22:	ZERO? RM /?L27
	RETURN RM
?L27:	EQUAL? WINNER,FRIEND,LORD \FALSE
	RETURN YOUR-ROOM

	.FUNCT GENERIC-GREAT-HALL,X,Y
	EQUAL? W?ROOM,P-NAM,P-XNAM \?L1
	RETURN HERE
?L1:	FSET? HERE,WEARBIT \?L3
	RETURN GREAT-HALL
?L3:	RETURN OLD-GREAT-HALL

	.FUNCT GENERIC-LENS,X,Y
	CALL REMOTE-VERB? >STACK
	ZERO? STACK /?L1
	RETURN LENS
?L1:	FSET? LENS-2,SEENBIT /FALSE
	RETURN LENS-1

	.FUNCT GENERIC-RECORDER,X,Y
	FSET? JACK-TAPE,SEENBIT /FALSE
	RETURN RECORDER

	.FUNCT GENERIC-BOX,X,Y
	FSET? LENS-BOX,SECRETBIT \FALSE
	RETURN VIVIEN-BOX

	.FUNCT GENERIC-BOOK,X,Y
	EQUAL? HERE,LIBRARY \FALSE
	RETURN BOOKS-GLOBAL

	.FUNCT GENERIC-WELL,X,Y
	EQUAL? HERE,BASEMENT /FALSE
	RETURN WELL

	.FUNCT GENERIC-SKELETON,X,Y
	FSET? SKELETON,SEENBIT \FALSE
	RETURN SKELETON

	.FUNCT GENERIC-ROOM,X,Y
	RETURN GLOBAL-HERE

	.FUNCT GENERIC-EYE,X,Y
	EQUAL? W?EYE,P-NAM,P-XNAM \FALSE
	RETURN GLASS-EYE

	.FUNCT GENERIC-BELL,X,Y
	CALL REMOTE-VERB? >STACK
	ZERO? STACK /FALSE
	RETURN BELL

	.FUNCT GENERIC-WINE,X,Y
	EQUAL? PRSA,V?TAKE \FALSE
	RETURN BOTTLE

	.FUNCT SPEAKING-VERB?,PER=0
	EQUAL? PRSA,V?$0024CALL,V?YES,V?TELL-ABOUT /?L3
	EQUAL? PRSA,V?TELL,V?SORRY,V?REPLY /?L3
	EQUAL? PRSA,V?NO,V?HELLO,V?FORGIVE /?L3
	EQUAL? PRSA,V?ASK-FOR /?L3
	EQUAL? PRSA,V?ASK-ABOUT,V?ASK,V?ANSWER \?L1
?L3:	EQUAL? PER,0,PRSO /TRUE
	RFALSE
?L1:	EQUAL? PRSA,V?TALK-ABOUT,V?ASK-CONTEXT-FOR,V?ASK-CONTEXT-ABOUT \FALSE
	ZERO? PER /TRUE
	RFALSE

	.FUNCT MISSING,NV,ADJ
	PRINTI "[I think there's a "
	PRINT NV
	PRINTR " missing in that sentence!]"

	.FUNCT WHICH-PRINT,TLEN,LEN,TBL,OBJ,RLEN
	ZERO? LEN \?L1
	CALL MORE-SPECIFIC
	RFALSE
?L1:	SET 'RLEN,LEN
	EQUAL? WINNER,PLAYER /?L4
	PRINTI """I don't understand "
	EQUAL? P-NAM,W?DOOR \?L8
	PRINTI "which door"
	JUMP ?L12
?L8:	PRINTI "if"
?L12:	PRINTI " you mean"
	JUMP ?L32
?L4:	PRINTI "[Which"
	ZERO? P-OFLAG \?L22
	ZERO? P-MERGED \?L22
	ZERO? P-AND /?L20
?L22:	ZERO? P-NAM /?L29
	PRINTC 32
	PRINTB P-NAM
	JUMP ?L29
?L20:	EQUAL? TBL,P-PRSO \?L28
	CALL CLAUSE-PRINT,P-NC1,P-NC1L,0
	JUMP ?L29
?L28:	CALL CLAUSE-PRINT,P-NC2,P-NC2L,0
?L29:	PRINTI " do you mean"
	EQUAL? P-NAM,W?DOOR /?L40
	PRINTI ","
?L32:	EQUAL? P-NAM,W?DOOR /?L40
?L39:	INC 'TLEN
	GETB TBL,TLEN >OBJ
	CALL PRINTT,OBJ
	EQUAL? LEN,2 \?L43
	EQUAL? RLEN,2 /?L45
	PRINTC 44
?L45:	PRINTI " or"
	JUMP ?L52
?L43:	GRTR? LEN,2 \?L52
	PRINTC 44
?L52:	DLESS? 'LEN,1 \?L39
?L40:	EQUAL? WINNER,PLAYER /?L60
	PRINTR "."""
?L60:	PRINTR "?]"

	.FUNCT GLOBAL-SEARCH,TBL,RMG,CNT,OBJ
	PTSIZE RMG >STACK
	SUB STACK,1 >CNT
?L1:	GETB RMG,CNT >OBJ
	CALL THIS-IT?,OBJ >STACK
	ZERO? STACK /?L3
	CALL OBJ-FOUND,OBJ,TBL
?L3:	DLESS? 'CNT,0 \?L1
	RTRUE

	.FUNCT GLOBAL-CHECK,TBL,LEN,RMG,RMGL,CNT=0,OBITS,FOO
	GETB TBL,P-MATCHLEN >LEN
	SET 'OBITS,P-SLOCBITS
	GETPT HERE,P?GLOBAL >RMG
	ZERO? RMG /?L1
	CALL GLOBAL-SEARCH,TBL,RMG
?L1:	EQUAL? P-NAM,W?DOOR /?L9
	CALL THIS-IT?,HERE >STACK
	ZERO? STACK /?L6
	CALL ZMEMQB,HERE,TBL >STACK
	ZERO? STACK \?L6
	CALL OBJ-FOUND,HERE,TBL
?L6:	EQUAL? PRSA,V?THROUGH,V?LOOK-INSIDE,V?EXAMINE /?L11
	EQUAL? PRSA,V?CLIMB-UP,V?CLIMB-DOWN,V?BOARD \?L9
?L11:	CALL ROOM-SEARCH,TBL
?L9:	GETP HERE,P?THINGS >RMG
	ZERO? RMG /?L17
	GET RMG,0 >RMGL
	SET 'CNT,0
?L16:	ADD CNT,1 >STACK
	GET RMG,STACK >STACK
	EQUAL? P-NAM,STACK \?L18
	ZERO? P-ADJ /?L20
	ADD CNT,2 >STACK
	GET RMG,STACK >STACK
	EQUAL? P-ADJN,STACK \?L18
?L20:	SET 'LAST-PSEUDO-LOC,HERE
	ADD CNT,3 >STACK
	GET RMG,STACK >STACK
	PUTP PSEUDO-OBJECT,P?ACTION,STACK
	GETPT PSEUDO-OBJECT,P?ACTION >STACK
	SUB STACK,5 >FOO
	GET P-NAM,0 >STACK
	PUT FOO,0,STACK
	GET P-NAM,1 >STACK
	PUT FOO,1,STACK
	CALL OBJ-FOUND,PSEUDO-OBJECT,TBL
	JUMP ?L17
?L18:	ADD CNT,3 >CNT
	LESS? CNT,RMGL /?L16
?L17:	GETB TBL,P-MATCHLEN >STACK
	EQUAL? STACK,LEN \FALSE
	SET 'P-SLOCBITS,-1
	SET 'P-TABLE,TBL
	CALL DO-SL,GLOBAL-OBJECTS,1,1
	SET 'P-SLOCBITS,OBITS
	GETB TBL,P-MATCHLEN >STACK
	ZERO? STACK \FALSE
	EQUAL? PRSA,V?WALK-TO,V?THROUGH,V?TAKE-TO /?L32
	EQUAL? PRSA,V?SSHOW,V?SHOW /?L32
	EQUAL? PRSA,V?FIND,V?CLIMB-UP,V?CLIMB-DOWN \FALSE
?L32:	CALL SEARCH-LIST,ROOMS,P-TABLE,P-SRCTOP >STACK
	RSTACK

	.FUNCT DO-SL,OBJ,BIT1,BIT2,BITS
	ADD BIT1,BIT2 >STACK
	BTST P-SLOCBITS,STACK \?L1
	CALL SEARCH-LIST,OBJ,P-TABLE,P-SRCALL >STACK
	RSTACK
?L1:	BTST P-SLOCBITS,BIT1 \?L4
	CALL SEARCH-LIST,OBJ,P-TABLE,P-SRCTOP >STACK
	RSTACK
?L4:	BTST P-SLOCBITS,BIT2 \TRUE
	CALL SEARCH-LIST,OBJ,P-TABLE,P-SRCBOT >STACK
	RSTACK

	.FUNCT SEARCH-LIST,OBJ,TBL,LVL
	FIRST? OBJ >OBJ \FALSE
?L3:	EQUAL? LVL,P-SRCBOT /?L5
	CALL THIS-IT?,OBJ >STACK
	ZERO? STACK /?L5
	CALL OBJ-FOUND,OBJ,TBL
?L5:	EQUAL? LVL,P-SRCTOP \?L10
	FSET? OBJ,SEARCHBIT /?L10
	FSET? OBJ,SURFACEBIT \?L8
?L10:	FIRST? OBJ >STACK \?L8
	FSET? OBJ,OPENBIT /?L11
	FSET? OBJ,TRANSBIT /?L11
	ZERO? P-MOBY-FLAG \?L11
	FSET? OBJ,PERSONBIT \?L8
	EQUAL? OBJ,WINNER /?L8
?L11:	FSET? OBJ,SURFACEBIT \?L12
	PUSH P-SRCALL
	JUMP ?L15
?L12:	FSET? OBJ,SEARCHBIT \?L14
	PUSH P-SRCALL
	JUMP ?L15
?L14:	PUSH P-SRCTOP
?L15:	CALL SEARCH-LIST,OBJ,TBL,STACK
?L8:	NEXT? OBJ >OBJ /?L3
	RTRUE

	.FUNCT ROOM-SEARCH,TTBL,P=0,L,TBL,O
	CALL CORRIDOR-LOOK,ROOMS >O
	ZERO? O /?L1
	CALL OBJ-FOUND,O,TTBL
?L1:	NEXTP HERE,P >P
	ZERO? P /FALSE
	LESS? P,P?OUT /FALSE
	GETPT HERE,P >TBL
	PTSIZE TBL >L
	GETB TBL,REXIT >O
	CALL ZMEMQB,O,TTBL >STACK
	ZERO? STACK \?L1
	EQUAL? L,UEXIT \?L12
	CALL THIS-IT?,O >STACK
	ZERO? STACK /?L1
	CALL OBJ-FOUND,O,TTBL
	JUMP ?L1
?L12:	EQUAL? L,DEXIT \?L16
	GETB TBL,DEXITOBJ >STACK
	FSET? STACK,OPENBIT \?L1
	CALL THIS-IT?,O >STACK
	ZERO? STACK /?L1
	CALL OBJ-FOUND,O,TTBL
	JUMP ?L1
?L16:	EQUAL? L,CEXIT \?L1
	GETB TBL,CEXITFLAG >STACK
	VALUE STACK >STACK
	ZERO? STACK /?L1
	CALL THIS-IT?,O >STACK
	ZERO? STACK /?L1
	CALL OBJ-FOUND,O,TTBL
	JUMP ?L1

	.FUNCT THIS-IT?,OBJ,SYNS
	FSET? OBJ,INVISIBLE /FALSE
	ZERO? P-NAM /?L3
	GETPT OBJ,P?SYNONYM >SYNS
	ZERO? SYNS /FALSE
	PTSIZE SYNS >STACK
	DIV STACK,2 >STACK
	DEC 'STACK
	CALL ZMEMQ,P-NAM,SYNS,STACK >STACK
	ZERO? STACK /FALSE
?L3:	ZERO? P-ADJ /?L5
	GETPT OBJ,P?ADJECTIVE >SYNS
	ZERO? SYNS /FALSE
	PTSIZE SYNS >STACK
	DEC 'STACK
	CALL ZMEMQB,P-ADJ,SYNS,STACK >STACK
	ZERO? STACK /FALSE
?L5:	ZERO? P-GWIMBIT /TRUE
	FSET? OBJ,P-GWIMBIT /TRUE
	RFALSE

	.FUNCT OBJ-FOUND,OBJ,TBL,PTR
	EQUAL? OBJ,NOT-HERE-OBJECT /?L1
	CALL ZMEMQB,OBJ,TBL >STACK
	ZERO? STACK \FALSE
?L1:	GETB TBL,P-MATCHLEN >PTR
	INC 'PTR
	PUTB TBL,PTR,OBJ
	PUTB TBL,P-MATCHLEN,PTR
	RTRUE

	.FUNCT TAKE-CHECK
	GETB P-SYNTAX,P-SLOC1 >STACK
	CALL ITAKE-CHECK,P-PRSO,STACK >STACK
	ZERO? STACK /FALSE
	GETB P-SYNTAX,P-SLOC2 >STACK
	CALL ITAKE-CHECK,P-PRSI,STACK >STACK
	RSTACK

	.FUNCT ITAKE-CHECK,TBL,BITS,PTR,OBJ,TAKEN
	GETB TBL,P-MATCHLEN >PTR
	ZERO? PTR /TRUE
	BTST BITS,SHAVE /?L3
	BTST BITS,STAKE \TRUE
?L3:	DLESS? 'PTR,0 /TRUE
	ADD PTR,1 >STACK
	GETB TBL,STACK >OBJ
	EQUAL? OBJ,IT \?L9
	CALL ACCESSIBLE?,P-IT-OBJECT >STACK
	ZERO? STACK \?L11
	CALL MORE-SPECIFIC
	RFALSE
?L11:	SET 'OBJ,P-IT-OBJECT
	JUMP ?L21
?L9:	EQUAL? OBJ,HER \?L14
	CALL ACCESSIBLE?,P-HER-OBJECT >STACK
	ZERO? STACK \?L15
	CALL MORE-SPECIFIC
	RFALSE
?L15:	SET 'OBJ,P-HER-OBJECT
	JUMP ?L21
?L14:	EQUAL? OBJ,HIM \?L21
	CALL ACCESSIBLE?,P-HIM-OBJECT >STACK
	ZERO? STACK \?L19
	CALL MORE-SPECIFIC
	RFALSE
?L19:	SET 'OBJ,P-HIM-OBJECT
?L21:	CALL HELD?,OBJ,WINNER >STACK
	ZERO? STACK \?L3
	EQUAL? OBJ,HANDS,ROOMS /?L3
	SET 'PRSO,OBJ
	FSET? OBJ,TRYTAKEBIT \?L25
	SET 'TAKEN,1
	JUMP ?L29
?L25:	EQUAL? WINNER,PLAYER /?L27
	SET 'TAKEN,0
	JUMP ?L29
?L27:	BTST BITS,STAKE \?L28
	CALL ITAKE,0 >STACK
	EQUAL? STACK,1 \?L28
	SET 'TAKEN,0
	JUMP ?L29
?L28:	SET 'TAKEN,1
?L29:	ZERO? TAKEN /?L3
	BTST BITS,SHAVE \?L3
	PRINTC 40
	CALL HE-SHE-IT,WINNER,1,STR?44
	PRINTI "n't holding"
	GETB TBL,P-MATCHLEN >STACK
	LESS? 1,STACK \?L36
	PRINTI " those things"
	JUMP ?L43
?L36:	EQUAL? OBJ,NOT-HERE-OBJECT \?L40
	PRINTI " that"
	JUMP ?L43
?L40:	CALL PRINTT,OBJ
	CALL THIS-IS-IT,OBJ
?L43:	PRINTI "!)"
	CRLF
	RFALSE

	.FUNCT MANY-CHECK,LOSS=0,TMP
	GETB P-PRSO,P-MATCHLEN >STACK
	GRTR? STACK,1 \?L1
	GETB P-SYNTAX,P-SLOC1 >STACK
	BTST STACK,SMANY /?L1
	SET 'LOSS,1
	JUMP ?L3
?L1:	GETB P-PRSI,P-MATCHLEN >STACK
	GRTR? STACK,1 \?L3
	GETB P-SYNTAX,P-SLOC2 >STACK
	BTST STACK,SMANY /?L3
	SET 'LOSS,2
?L3:	ZERO? LOSS /TRUE
	PRINTI "[You can't use more than one "
	EQUAL? LOSS,2 \?L11
	PRINTI "in"
?L11:	PRINTI "direct object with """
	GET P-ITBL,P-VERBN >TMP
	ZERO? TMP \?L18
	PRINTI "tell"
	JUMP ?L24
?L18:	ZERO? P-OFLAG \?L23
	ZERO? P-MERGED /?L22
?L23:	GET TMP,0 >STACK
	PRINTB STACK
	JUMP ?L24
?L22:	GETB TMP,3 >STACK
	GETB TMP,2 >STACK
	CALL WORD-PRINT,STACK,STACK
?L24:	PRINTI """!]"
	CRLF
	RFALSE

	.FUNCT ZMEMQ,ITM,TBL,SIZE=-1,CNT=1
	ZERO? TBL /FALSE
	LESS? SIZE,0 /?L4
	SET 'CNT,0
	JUMP ?L7
?L4:	GET TBL,0 >SIZE
	GRTR? SIZE,0 \FALSE
?L7:	GET TBL,CNT >STACK
	EQUAL? ITM,STACK \?L12
	ZERO? CNT /TRUE
	RETURN CNT
?L12:	IGRTR? 'CNT,SIZE \?L7
	RFALSE

	.FUNCT ZMEMQB,ITM,TBL,SIZE=-1,CNT=1
	ZERO? TBL /FALSE
	LESS? SIZE,0 /?L4
	SET 'CNT,0
	JUMP ?L7
?L4:	GETB TBL,0 >SIZE
	GRTR? SIZE,0 \FALSE
?L7:	GETB TBL,CNT >STACK
	EQUAL? ITM,STACK \?L12
	ZERO? CNT /TRUE
	RETURN CNT
?L12:	IGRTR? 'CNT,SIZE \?L7
	RFALSE

	.FUNCT LIT?,RM=0,RMBIT=0,OHERE?1,LIT?1=0,P=0,TBL,L
	ZERO? RM \?L1
	SET 'RM,HERE
?L1:	ZERO? RMBIT /?L8
	FSET? RM,ONBIT \FALSE
	RETURN RM
?L8:	FSET? RM,ONBIT \?L10
	SET 'LIT?1,RM
	JUMP ?L12
?L10:	SET 'P-GWIMBIT,ONBIT
	SET 'OHERE?1,HERE
	SET 'HERE,RM
	PUTB P-MERGE,P-MATCHLEN,0
	SET 'P-TABLE,P-MERGE
	SET 'P-SLOCBITS,-1
	CALL SEARCH-LIST,RM,P-TABLE,P-SRCALL
	GETB P-MERGE,P-MATCHLEN >STACK
	ZERO? STACK /?L13
	GETB P-MERGE,1 >LIT?1
?L13:	SET 'HERE,OHERE?1
	SET 'P-GWIMBIT,0
?L12:	ZERO? LIT?1 /?L16
	RETURN LIT?1
?L16:	EQUAL? RM,GALLERY-CORNER \?L18
	FSET? GALLERY,ONBIT \?L18
	RETURN GALLERY
?L18:	NEXTP RM,P >P
	ZERO? P /FALSE
	EQUAL? P,P?UP,P?DOWN /?L18
	LESS? P,P?OUT /?L18
	GETPT RM,P >TBL
	PTSIZE TBL >L
	GETB TBL,REXIT >OHERE?1
	EQUAL? L,UEXIT \?L26
	CALL LIT?,OHERE?1,1 >STACK
	ZERO? STACK /?L26
	RETURN OHERE?1
?L26:	EQUAL? L,DEXIT \?L28
	GETB TBL,DEXITOBJ >STACK
	FSET? STACK,OPENBIT \?L28
	CALL LIT?,OHERE?1,1 >STACK
	ZERO? STACK /?L28
	RETURN OHERE?1
?L28:	EQUAL? L,CEXIT \?L18
	GETB TBL,CEXITFLAG >STACK
	VALUE STACK >STACK
	ZERO? STACK /?L18
	CALL LIT?,OHERE?1,1 >STACK
	ZERO? STACK /?L18
	RETURN OHERE?1

	.FUNCT NOT-HERE,OBJ,CLOCK=0
	ZERO? CLOCK \?L1
	SET 'CLOCK-WAIT,1
	PRINTC 40
?L1:	CALL START-SENTENCE,OBJ
	PRINTI " isn't "
	CALL VISIBLE?,OBJ >STACK
	ZERO? STACK /?L8
	PRINTI "close enough"
	CALL SPEAKING-VERB? >STACK
	ZERO? STACK /?L12
	PRINTI " to hear you"
?L12:	PRINTC 46
	JUMP ?L19
?L8:	PRINTI "here!"
?L19:	CALL THIS-IS-IT,OBJ
	ZERO? CLOCK \?L22
	PRINTC 41
?L22:	CRLF
	RTRUE

	.FUNCT PUT-ADJ-NAM
	EQUAL? P-NAM,W?IT,W?HIM,W?HER /FALSE
	PUT P-NAMW,P-PHR,P-NAM
	PUT P-ADJW,P-PHR,P-ADJN
	RTRUE

	.FUNCT NOUN-USED?,WORD1,WORD2=1,WORD3=1
	ZERO? NOW-PRSI \?L1
	GET P-NAMW,0 >STACK
	EQUAL? STACK,WORD1,WORD2,WORD3 /TRUE
	GET P-OFW,0 >STACK
	EQUAL? STACK,WORD1,WORD2,WORD3 /TRUE
	RFALSE
?L1:	GET P-NAMW,1 >STACK
	EQUAL? STACK,WORD1,WORD2,WORD3 /TRUE
	GET P-OFW,1 >STACK
	EQUAL? STACK,WORD1,WORD2,WORD3 /TRUE
	RFALSE

	.FUNCT ADJ-USED?,WORD1=1,WORD2=1,WORD3=1
	ZERO? NOW-PRSI \?L1
	EQUAL? WORD1,1 \?L3
	GET P-ADJW,0 >STACK
	RSTACK
?L3:	GET P-ADJW,0 >STACK
	EQUAL? STACK,WORD1,WORD2,WORD3 \FALSE
	RTRUE
?L1:	EQUAL? WORD1,1 \?L8
	GET P-ADJW,1 >STACK
	RSTACK
?L8:	GET P-ADJW,1 >STACK
	EQUAL? STACK,WORD1,WORD2,WORD3 \FALSE
	RTRUE

	.FUNCT TRANSCRIPT,STR
	PRINTI "Here "
	PRINT STR
	PRINTR "s a transcript of interaction with"

	.FUNCT V-SCRIPT
	GET 0,8 >STACK
	BOR STACK,1 >STACK
	PUT 0,8,STACK
	CALL TRANSCRIPT,STR?68
	CALL V-VERSION
	RTRUE

	.FUNCT V-UNSCRIPT
	CALL TRANSCRIPT,STR?69
	CALL V-VERSION
	GET 0,8 >STACK
	BAND STACK,-2 >STACK
	PUT 0,8,STACK
	RTRUE

	.FUNCT V-$0024VERIFY
	ZERO? PRSO /?L1
	EQUAL? PRSO,INTNUM \?L3
	EQUAL? P-NUMBER,105 \?L3
	PRINTN SERIAL
	CRLF
	RTRUE
?L3:	CALL DONT-UNDERSTAND >STACK
	RSTACK
?L1:	PRINTI "Verifying disk..."
	CRLF
	VERIFY \?L11
	PRINTR "The disk is correct."
?L11:	PRINTR "Oh, oh! The disk seems to have a defect. Try verifying again. (If you've already done that, the disk surely has a defect.)"

	.FUNCT YOU-WILL-GET,STR
	PRINTI "[Okay, you will get "
	PRINT STR
	PRINTR " descriptions.]"

	.FUNCT V-SUPER-BRIEF
	SET 'VERBOSITY,0
	CALL YOU-WILL-GET,STR?70 >STACK
	RSTACK

	.FUNCT V-BRIEF
	SET 'VERBOSITY,1
	CALL YOU-WILL-GET,STR?71 >STACK
	RSTACK

	.FUNCT V-VERBOSE
	SET 'VERBOSITY,2
	CALL YOU-WILL-GET,STR?72
	CALL V-LOOK >STACK
	RSTACK

	.FUNCT V-INVENTORY
	CALL HE-SHE-IT,WINNER,1,STR?44
	PRINTI " holding"
	CALL PRINT-CONTENTS,WINNER >STACK
	ZERO? STACK \?L3
	PRINTI " nothing"
?L3:	PRINTC 46
	CRLF
	RTRUE

	.FUNCT V-QUIT,ASK?=1
	CALL V-SCORE
	ZERO? ASK? \?L1
	QUIT
?L1:	PRINTI "[If you want to continue from this point at another time, you must ""SAVE"" first. Do you want to stop the story now?]"
	CALL YES? >STACK
	ZERO? STACK /?L6
	QUIT
?L6:	PRINTR "Okay."

	.FUNCT V-RESTART
	CALL V-SCORE
	PRINTI "[Do you want to start over from the beginning?]"
	CALL YES? >STACK
	ZERO? STACK /?L3
	RESTART
?L3:	PRINTR "Okay."

	.FUNCT TELL-FAILED
	PRINTR "[Sorry, but it didn't work. Maybe your instruction manual or Reference Card can tell you why.]"

	.FUNCT V-SAVE,X
	PUTB OOPS-INBUF,1,0
	SET 'CLOCK-WAIT,1
	SAVE /?L3
	SET 'X,0
	JUMP ?L1
?L3:	SET 'X,1
	PRINTI "[Okay.]"
	CRLF
	CALL V-FIRST-LOOK
	RTRUE
?L1:	CALL TELL-FAILED
	RTRUE

	.FUNCT V-RESTORE
	RESTORE /FALSE
	CALL TELL-FAILED
	RFALSE

	.FUNCT V-FIRST-LOOK
	CALL DESCRIBE-ROOM >STACK
	ZERO? STACK /FALSE
	ZERO? VERBOSITY /FALSE
	CALL DESCRIBE-OBJECTS >STACK
	RSTACK

	.FUNCT V-VERSION,CNT=17,V,?TMP
	GET 0,1 >STACK
	BAND STACK,2047 >V
	PRINTD MOONMIST
	PRINTI "
Infocom interactive fiction - a mystery story
Copyright (c) 1986 by Infocom, Inc. All rights reserved."
	CRLF
	PRINTD MOONMIST
	PRINTI " is a trademark of Infocom, Inc.
Release number "
	PRINTN V
	PRINTI " / Serial number "
	SET '?TMP,18
?L3:	GETB 0,?TMP >STACK
	PRINTC STACK
	IGRTR? '?TMP,23 \?L3
	ZERO? VARIATION /?L4
	PRINTI " / "
	GET COLOR-WORDS,VARIATION >STACK
	PRINTB STACK
	PRINTI " variation"
?L4:	CRLF
	RTRUE

	.FUNCT V-SCORE,N=0,I,FC
	GET FOUND-COSTUME,PLAYER-C >FC
	ZERO? CONFESSED /?L1
	ZERO? TREASURE-FOUND /?L1
	ZERO? FC /?L1
	PRINTI "[Congratulations, "
	CALL TITLE-NAME
	PRINTR "! You've won the game!][RWD_ID: verbs:347, VAL: 5]"
?L1:	PRINTI "[Well, so far you've "
	GETB LAST-NAME,0 >STACK
	ZERO? STACK \?L8
	PRINTR "just gotten started.]"
?L8:	PRINTI "met "
	FSET? LORD,TOUCHBIT \?L15
	PRINTD LORD
	PRINTI " and "
?L15:	GET GUEST-TABLE,0 >I
?L20:	GET GUEST-TABLE,I >STACK
	FSET? STACK,TOUCHBIT \?L22
	INC 'N
?L22:	DLESS? 'I,1 \?L20
	GET GUEST-TABLE,0 >STACK
	EQUAL? N,STACK \?L28
	PRINTI "all"
	JUMP ?L38
?L28:	ZERO? N \?L32
	PRINTI "none"
	JUMP ?L38
?L32:	EQUAL? N,1 \?L35
	PRINTI "one"
	JUMP ?L38
?L35:	PRINTI "some"
?L38:	PRINTI " of the guests"
	ZERO? WASHED /?L43
	PRINTI ", washed up from your trip"
?L43:	ZERO? WRONG-OUTFIT /?L48
	PRINTI ", worn the "
	EQUAL? WRONG-OUTFIT,1 \?L52
	PRINTI "proper"
	JUMP ?L56
?L52:	PRINTI "wrong"
?L56:	PRINTI " outfit to dinner"
?L48:	GET FOUND-PASSAGES,PLAYER-C >STACK
	ZERO? STACK /?L62
	PRINTI ", discovered "
	PRINTD PASSAGE
	PRINTI "s"
?L62:	FSET? GHOST-NEW,TOUCHBIT \?L67
	PRINTI ", seen the ghost"
?L67:	ZERO? FC /?L72
	PRINTI ", "
	PRINT IDENTIFIED-THE-GHOST
?L72:	ZERO? EVIDENCE-FOUND /?L77
	PRINTI ", discovered evidence"
?L77:	ZERO? CONFESSED /?L82
	PRINTI ", "
	PRINT ARRESTED-THE-VILLAIN
?L82:	ZERO? TREASURE-FOUND /?L87
	PRINTI ", discovered the "
	PRINTD ARTIFACT
?L87:	PRINTI "... "
	ZERO? N \?L94
	PRINTI "and"
	JUMP ?L98
?L94:	PRINTI "but"
?L98:	PRINTI " you haven't "
	ZERO? TREASURE-FOUND \?L103
	PRINTI "found the "
	PRINTD ARTIFACT
?L103:	ZERO? EVIDENCE-FOUND \?L108
	ZERO? TREASURE-FOUND \?L110
	PRINTI " nor "
?L110:	PRINTI "enough evidence"
	ZERO? VILLAIN-KNOWN? \?L119
	ZERO? FC /?L152
?L119:	PRINTI " of why "
	EQUAL? VILLAIN-PER,LOVER \?L122
	ZERO? LOVER-SAID /?L122
	PRINTD LORD
	PRINTI " killed "
	PRINTD COUSIN
	JUMP ?L130
?L122:	PRINTD VILLAIN-PER
	PRINTI " haunted "
	PRINTD CASTLE
	JUMP ?L130
?L108:	ZERO? CONFESSED \?L130
	ZERO? TREASURE-FOUND \?L131
	PRINTI " nor "
?L131:	PRINT ARRESTED-THE-VILLAIN
?L130:	ZERO? FC \?L139
?L152:	ZERO? TREASURE-FOUND /?L143
	ZERO? EVIDENCE-FOUND /?L143
	ZERO? CONFESSED \?L141
?L143:	PRINTI " nor "
?L141:	PRINT IDENTIFIED-THE-GHOST
?L139:	PRINTR "!]"

	.FUNCT YES?,WORD,VAL
?L1:	PRINTI "
>"
	READ YES-INBUF,YES-LEXV
	GETB YES-LEXV,P-LEXWORDS >STACK
	ZERO? STACK /?L11
	GET YES-LEXV,P-LEXSTART >WORD
	ZERO? WORD /?L11
	CALL WT?,WORD,PS?VERB,P1?VERB >VAL
	EQUAL? VAL,ACT?YES \?L5
	SET 'VAL,1
	RETURN VAL
?L5:	EQUAL? VAL,ACT?NO /?L8
	EQUAL? WORD,W?N \?L7
?L8:	SET 'VAL,0
	RETURN VAL
?L7:	EQUAL? VAL,ACT?RESTART \?L9
	CALL V-RESTART
	JUMP ?L11
?L9:	EQUAL? VAL,ACT?RESTORE \?L10
	CALL V-RESTORE
	JUMP ?L11
?L10:	EQUAL? VAL,ACT?QUIT \?L11
	CALL V-QUIT
?L11:	PRINTI "[Please type YES or NO.]"
	JUMP ?L1

	.FUNCT NO-NEED,STR=0,OBJ=0
	SET 'CLOCK-WAIT,1
	PRINTC 40
	CALL HE-SHE-IT,WINNER,1,STR?50
	PRINTI "n't need to "
	ZERO? STR /?L3
	PRINT STR
	JUMP ?L7
?L3:	CALL VERB-PRINT
?L7:	EQUAL? STR,STR?74,STR?73 \?L8
	PRINTI " in that "
	PRINTD INTDIR
	JUMP ?L15
?L8:	ZERO? OBJ /?L12
	CALL PRINTT,OBJ
	JUMP ?L15
?L12:	CALL PRINTT,PRSO
?L15:	PRINTR ".)"

	.FUNCT YOU-CANT,STR=0,WHILE=0,STR1=0
	SET 'CLOCK-WAIT,1
	PRINTC 40
	CALL HE-SHE-IT,WINNER,1
	PRINTI " can't "
	ZERO? STR \?L3
	CALL VERB-PRINT
	JUMP ?L5
?L3:	PRINT STR
?L5:	EQUAL? STR,STR?74,STR?73 \?L8
	PRINTI " in that "
	PRINTD INTDIR
	JUMP ?L27
?L8:	EQUAL? PRSO,PSEUDO-OBJECT \?L13
	PRINTI " it"
	JUMP ?L24
?L13:	EQUAL? PRSO,BUST \?L17
	CALL NOUN-USED?,W?TAPE >STACK
	ZERO? STACK /?L17
	EQUAL? STR,STR?75 /?L18
	EQUAL? STR,STR?78,STR?77,STR?76 \?L17
?L18:	PRINTI " the tape"
	JUMP ?L24
?L17:	EQUAL? PRSO,FLOOR \?L21
	CALL OUTSIDE?,HERE >STACK
	ZERO? STACK /?L21
	LOC WINNER >STACK
	EQUAL? STACK,CAR /?L21
	PRINTI " the ground"
	JUMP ?L24
?L21:	CALL PRINTT,PRSO
?L24:	ZERO? STR1 /?L27
	PRINTI " while"
	ZERO? WHILE /?L31
	CALL HE-SHE-IT,WHILE,0,STR?44
	JUMP ?L35
?L31:	CALL HE-SHE-IT,PRSO,0,STR?44
?L35:	PRINTC 32
	PRINT STR1
?L27:	PRINTR ".)"

	.FUNCT YOU-SHOULDNT,PREP=0
	SET 'CLOCK-WAIT,1
	PRINTC 40
	CALL HE-SHE-IT,WINNER,1
	PRINTI " shouldn't "
	CALL VERB-PRINT
	CALL PRINTT,PRSO
	ZERO? PREP /?L5
	PRINT PREP
	CALL PRINTT,PRSI
?L5:	PRINTR ".)"

	.FUNCT TELL-BEING-WORN,OBJ
	FSET? OBJ,WORNBIT \FALSE
	PRINTI " (actually, wearing it)"
	RTRUE

	.FUNCT PRINT-CONTENTS,THING,OBJ,NXT,1ST?=1,VAL=0
	FIRST? THING >OBJ /?L39
	JUMP ?L3
?L1:	ZERO? OBJ /?L3
?L39:	NEXT? OBJ >NXT /?L6
?L6:	FSET? OBJ,INVISIBLE /?L9
	FSET? OBJ,NDESCBIT /?L9
	EQUAL? OBJ,WINNER \?L7
?L9:	MOVE OBJ,INTDIR
?L7:	SET 'OBJ,NXT
	JUMP ?L1
?L3:	FIRST? THING >OBJ /?L41
	EQUAL? THING,PLAYER /?L22
	PRINTI " nothing "
	CALL PICK-ONE-NEW,YAWNS >STACK
	PRINT STACK
	JUMP ?L22
?L13:	ZERO? OBJ /?L22
?L41:	NEXT? OBJ >NXT /?L25
?L25:	ZERO? 1ST? /?L26
	SET 'VAL,1
	SET '1ST?,0
	JUMP ?L33
?L26:	ZERO? NXT /?L29
	PRINTC 44
	JUMP ?L33
?L29:	PRINTI " and"
?L33:	CALL PRINTT,OBJ
	CALL TELL-BEING-WORN,OBJ
	CALL THIS-IS-IT,OBJ
	FCLEAR OBJ,SECRETBIT
	FSET OBJ,SEENBIT
	SET 'OBJ,NXT
	JUMP ?L13
?L22:	CALL ROB,INTDIR,THING
	RETURN VAL

	.FUNCT DESCRIBE-OBJECTS,THING=0,OBJ,NXT,STR,VAL=0,HE=0,SHE=0,FIRST=1,TWO?=0,IT?=0,ANY?=0
	ZERO? THING \?L1
	SET 'THING,HERE
?L1:	ZERO? LIT \?L4
	CALL TOO-DARK
	RTRUE
?L4:	FIRST? THING >OBJ /?L186
	RFALSE
?L8:	ZERO? OBJ /?L12
?L186:	NEXT? OBJ >NXT /?L15
?L15:	FSET? OBJ,INVISIBLE /?L18
	FSET? OBJ,NDESCBIT /?L18
	EQUAL? OBJ,WINNER /?L18
	FSET? OBJ,PERSONBIT \?L19
	FSET? OBJ,RMUNGBIT /?L18
?L19:	LOC PLAYER >STACK
	EQUAL? OBJ,STACK \?L16
?L18:	FCLEAR OBJ,RMUNGBIT
	MOVE OBJ,PSEUDO-OBJECT
?L16:	SET 'OBJ,NXT
	JUMP ?L8
?L12:	EQUAL? THING,HERE \?L97
	SET 'NXT,GHOST-NEW-C
?L24:	PUT TOUCHED-LDESCS,NXT,0
	DLESS? 'NXT,1 \?L24
	SET 'NXT,0
?L29:	IGRTR? 'NXT,GHOST-NEW-C /?L30
	GET CHARACTER-TABLE,NXT >OBJ
	IN? OBJ,HERE \?L29
	PUT FOLLOW-LOC,NXT,HERE
	GETP OBJ,P?DESCFCN >STACK
	CALL STACK,M-OBJDESC >VAL
	FSET OBJ,SEENBIT
	EQUAL? VAL,M-FATAL /?L36
	ZERO? ANY? \?L34
?L36:	SET 'ANY?,VAL
?L34:	FSET? OBJ,FEMALE \?L38
	ZERO? SHE \?L40
	SET 'SHE,OBJ
	JUMP ?L46
?L40:	SET 'SHE,1
	JUMP ?L46
?L38:	ZERO? HE \?L44
	SET 'HE,OBJ
	JUMP ?L46
?L44:	SET 'HE,1
?L46:	MOVE OBJ,PSEUDO-OBJECT
	JUMP ?L29
?L30:	SET 'NXT,0
?L48:	IGRTR? 'NXT,GHOST-NEW-C /?L49
	GET TOUCHED-LDESCS,NXT >OBJ
	ZERO? OBJ /?L48
	SET 'FIRST,1
	GET CHARACTER-TABLE,NXT >STR
	CALL START-SENTENCE,STR
	SET 'STR,NXT
?L55:	IGRTR? 'STR,GHOST-NEW-C \?L57
	ZERO? FIRST /?L59
	PRINTI " is "
	JUMP ?L63
?L59:	PRINTI " are "
?L63:	GET LDESC-STRINGS,OBJ >STACK
	PRINT STACK
	PRINTC 46
	CRLF
	JUMP ?L48
?L57:	GET TOUCHED-LDESCS,STR >STACK
	EQUAL? OBJ,STACK \?L55
	PUT TOUCHED-LDESCS,STR,0
	SET 'FIRST,0
	PRINTI " and"
	GET CHARACTER-TABLE,STR >STACK
	CALL PRINTT,STACK
	JUMP ?L55
?L49:	EQUAL? SHE,0,1 /?L73
	CALL THIS-IS-IT,SHE
	JUMP ?L75
?L73:	EQUAL? SHE,1 \?L75
	SET 'P-HER-OBJECT,0
?L75:	EQUAL? HE,0,1 /?L77
	CALL THIS-IS-IT,HE
	JUMP ?L79
?L77:	EQUAL? HE,1 \?L79
	SET 'P-HIM-OBJECT,0
?L79:	SET 'FIRST,1
	FIRST? THING >OBJ /?L187
	JUMP ?L83
?L81:	ZERO? OBJ /?L83
?L187:	NEXT? OBJ >NXT /?L86
?L86:	GETP OBJ,P?DESCFCN >STR
	ZERO? STR /?L87
	CALL STR,M-OBJDESC >VAL
	EQUAL? VAL,M-FATAL /?L91
	ZERO? ANY? \?L89
?L91:	SET 'ANY?,VAL
?L89:	CALL THIS-IS-IT,OBJ
	FSET OBJ,SEENBIT
	MOVE OBJ,PSEUDO-OBJECT
?L87:	SET 'OBJ,NXT
	JUMP ?L81
?L83:	FIRST? THING >OBJ /?L188
	JUMP ?L97
?L95:	ZERO? OBJ /?L97
?L188:	NEXT? OBJ >NXT /?L100
?L100:	GETP OBJ,P?LDESC >STR
	ZERO? STR /?L101
	ZERO? ANY? \?L103
	SET 'ANY?,1
?L103:	PRINT STR
	CRLF
	FCLEAR OBJ,SECRETBIT
	FSET OBJ,SEENBIT
	CALL THIS-IS-IT,OBJ
	MOVE OBJ,PSEUDO-OBJECT
?L101:	SET 'OBJ,NXT
	JUMP ?L95
?L97:	FIRST? HERE >OBJ /?L111
?L111:	SET 'VAL,0
	ZERO? OBJ /?L115
?L114:	ZERO? OBJ /?L116
	NEXT? OBJ >NXT /?L118
?L118:	SET 'VAL,1
	ZERO? FIRST /?L119
	SET 'FIRST,0
	EQUAL? THING,HERE \?L136
	CRLF
	FSET? HERE,ONBIT \?L123
	PRINTI "You see"
	JUMP ?L136
?L123:	PRINTI "The light reveals"
	JUMP ?L136
?L119:	ZERO? NXT /?L132
	PRINTC 44
	JUMP ?L136
?L132:	PRINTI " and"
?L136:	CALL PRINTT,OBJ
	FCLEAR OBJ,SECRETBIT
	FSET OBJ,SEENBIT
	CALL THIS-IS-IT,OBJ
	CALL TELL-BEING-WORN,OBJ
	CALL SEE-INSIDE?,OBJ >STACK
	ZERO? STACK /?L141
	CALL SEE-ANYTHING-IN?,OBJ >STACK
	ZERO? STACK /?L141
	MOVE OBJ,INTNUM
?L141:	ZERO? IT? \?L144
	ZERO? TWO? \?L144
	SET 'IT?,OBJ
	JUMP ?L146
?L144:	SET 'TWO?,1
	SET 'IT?,0
?L146:	SET 'OBJ,NXT
	JUMP ?L114
?L116:	ZERO? IT? /?L148
	ZERO? TWO? \?L148
	SET 'P-IT-OBJECT,IT?
?L148:	EQUAL? THING,HERE \?L151
	PRINTI " here"
?L151:	PRINTC 46
	ZERO? ANY? \?L115
	SET 'ANY?,1
?L115:	FIRST? INTNUM >OBJ \?L164
?L165:	FSET? OBJ,SURFACEBIT \?L168
	CRLF
	PRINTI "On"
	JUMP ?L172
?L168:	CRLF
	PRINTI "Inside"
?L172:	SET 'VAL,1
	CALL PRINTT,OBJ
	PRINTI " you see"
	CALL PRINT-CONTENTS,OBJ
	PRINTC 46
	NEXT? OBJ >OBJ /?L165
?L164:	ZERO? VAL /?L182
	CRLF
?L182:	CALL ROB,INTNUM,THING
	CALL ROB,PSEUDO-OBJECT,THING
	RETURN ANY?

	.FUNCT SEE-ANYTHING-IN?,THING,OBJ,NXT,ANY?=0
	FIRST? THING >OBJ /?L11
	RETURN ANY?
?L11:	FSET? OBJ,INVISIBLE /?L6
	FSET? OBJ,NDESCBIT /?L6
	EQUAL? OBJ,WINNER /?L6
	SET 'ANY?,1
	RETURN ANY?
?L6:	NEXT? OBJ >OBJ /?L11
	RETURN ANY?

	.FUNCT DESCRIBE-ROOM,LOOK?=0,V?,STR,L
	ZERO? LOOK? /?L1
	SET 'V?,1
	JUMP ?L5
?L1:	EQUAL? 2,VERBOSITY \?L3
	SET 'V?,1
	JUMP ?L5
?L3:	ZERO? VERBOSITY \?L4
	SET 'V?,0
	JUMP ?L5
?L4:	FSET? HERE,TOUCHBIT /?L5
	SET 'V?,1
?L5:	PRINTC 40
	ZERO? VERBOSITY \?L11
	PRINTD HERE
	JUMP ?L15
?L11:	PRINTI "You are"
	FSET? HERE,TOUCHBIT /?L18
	PRINTI " now"
?L18:	FSET? HERE,SURFACEBIT \?L23
	PRINTI " on"
	JUMP ?L27
?L23:	EQUAL? HERE,BACKSTAIRS /?L27
	PRINTI " in"
?L27:	CALL PRINTT,HERE
	PRINTC 46
?L15:	PRINTI ")
"
	ZERO? LIT \?L35
	CALL TOO-DARK
	RFALSE
?L35:	EQUAL? LIT,HERE /?L37
	PRINTI "Light comes from"
	CALL PRINTT,LIT
	PRINTI "."
	CRLF
?L37:	ZERO? V? /?L71
	LOC WINNER >L
	FSET? L,VEHBIT \?L43
	PRINTI "(You're "
	EQUAL? L,COFFIN \?L47
	PRINTI "ly"
	JUMP ?L51
?L47:	PRINTI "sitt"
?L51:	PRINTI "ing "
	EQUAL? L,CAR,COFFIN \?L56
	PRINTI "in"
	JUMP ?L60
?L56:	PRINTI "on"
?L60:	CALL THIS-IS-IT,L
	CALL PRINTT,L
	PRINTI ".)"
	CRLF
?L43:	ZERO? V? /?L68
	GETP HERE,P?ACTION >STACK
	CALL STACK,M-LOOK >STACK
	ZERO? STACK \?L71
	ZERO? V? /?L68
	GETP HERE,P?LDESC >STR
	ZERO? STR /?L68
	PRINT STR
	CRLF
	JUMP ?L71
?L68:	GETP HERE,P?ACTION >STACK
	CALL STACK,M-FLASH >STACK
?L71:	GETP HERE,P?CORRIDOR >STACK
	ZERO? STACK /?L73
	CALL CORRIDOR-LOOK
?L73:	FSET HERE,SEENBIT
	FSET HERE,TOUCHBIT
	RTRUE

	.FUNCT HAR-HAR
	SET 'CLOCK-WAIT,1
	PRINTC 40
	CALL PICK-ONE-NEW,YUKS >STACK
	PRINT STACK
	PRINTC 41
	CRLF
	RTRUE

	.FUNCT PICK-ONE-NEW,FROB,L,CNT,RND,MSG,RFROB
	GET FROB,0 >STACK
	SUB STACK,1 >L
	GET FROB,1 >CNT
	ADD FROB,2 >FROB
	MUL CNT,2 >STACK
	ADD FROB,STACK >RFROB
	SUB L,CNT >RND
	RANDOM RND >RND
	GET RFROB,RND >MSG
	GET RFROB,1 >STACK
	PUT RFROB,RND,STACK
	PUT RFROB,1,MSG
	INC 'CNT
	EQUAL? CNT,L \?L1
	SET 'CNT,0
?L1:	PUT FROB,0,CNT
	RETURN MSG

	.FUNCT PICK-ONE,FROB
	GET FROB,0 >STACK
	RANDOM STACK >STACK
	GET FROB,STACK >STACK
	RSTACK

	.FUNCT NOT-HOLDING?,OBJ
	IN? OBJ,WINNER /FALSE
	LOC OBJ >STACK
	IN? STACK,WINNER /FALSE
	SET 'CLOCK-WAIT,1
	PRINTC 40
	CALL HE-SHE-IT,WINNER,1,STR?44
	PRINTI " not holding"
	CALL HIM-HER-IT,OBJ
	PRINTR ".)"

	.FUNCT NEW-FOLLOWER,PER
	EQUAL? FOLLOWER,0,PER /?L1
	PUTP FOLLOWER,P?LDESC,0
	PRINTI """I'll leave you two alone, then,"" says "
	PRINTD FOLLOWER
	PRINTI ".
"
?L1:	SET 'FOLLOWER,PER
	GETP PER,P?CHARACTER >STACK
	GET GOAL-TABLES,STACK >STACK
	PUT STACK,GOAL-ENABLE,0
	RTRUE

	.FUNCT FRIEND-FOLLOWS-YOU,RM,C
	EQUAL? RM,CAR,YOUR-BATHROOM /FALSE
	FSET? RM,SECRETBIT /?L4
	EQUAL? RM,CRYPT \?L3
?L4:	CALL NOT-INTO-PASSAGE,FOLLOWER,1
	PUTP FOLLOWER,P?LDESC,9
	SET 'FOLLOWER,0
	RFALSE
?L3:	GETP RM,P?LINE >STACK
	ZERO? STACK /FALSE
	IN? FOLLOWER,RM /FALSE
	MOVE FOLLOWER,RM
	PUTP FOLLOWER,P?LDESC,23
	EQUAL? FOLLOWER,LORD \?L8
	PRINTD FRIEND
	JUMP ?L12
?L8:	PRINTD FOLLOWER
?L12:	CALL PICK-ONE,TRAILS-ALONG >STACK
	PRINT STACK
	EQUAL? FOLLOWER,LORD \?L17
	EQUAL? RM,YOUR-ROOM,YOUR-BATHROOM /?L17
	MOVE LORD,RM
	PUTP LORD,P?LDESC,23
	PRINTI " So does "
	PRINTD LORD
	PRINTC 46
?L17:	CRLF
	RTRUE

	.FUNCT NOT-INTO-PASSAGE,PER,FOLLOW=0,PASS=1
	ZERO? PASS /?L1
	GETP PER,P?CHARACTER >STACK
	PUT FOUND-PASSAGES,STACK,1
?L1:	CALL THIS-IS-IT,PER
	PRINTI """I'm not "
	ZERO? FOLLOW /?L6
	GET LDESC-STRINGS,23 >STACK
	PRINT STACK
	JUMP ?L10
?L6:	PRINTI "going"
?L10:	PRINTI " into that "
	ZERO? PASS /?L15
	EQUAL? PER,OFFICER,BUTLER \?L17
	PRINTI "dirty"
	JUMP ?L21
?L17:	PRINTI "spooky"
?L21:	PRINTC 32
?L15:	PRINTI "place!"" says "
	PRINTD PER
	ZERO? FOLLOW /?L29
	PRINTI " as"
	CALL HE-SHE-IT,PER
	PRINTI " stays behind"
?L29:	PRINTR "."

	.FUNCT TOUR?,RM,?TMP,?TMP?1
	CALL QUEUED?,I-TOUR >STACK
	ZERO? STACK /FALSE
	CALL QUEUE,I-TOUR,1
	SET 'TOUR-FORCED,1
	CALL QUEUED?,I-REPLY >STACK
	ZERO? STACK /?L3
	CALL QUEUE,I-REPLY,1
?L3:	EQUAL? HERE,GREAT-HALL \?L8
	FSET? DOCTOR,TOUCHBIT \?L19
?L8:	GET TOUR-PATH,TOUR-INDEX >RM
	EQUAL? PRSA,V?FOLLOW \?L9
	EQUAL? PRSO,FRIEND \?L19
	RTRUE
?L9:	EQUAL? PRSA,V?WALK \?L14
	SET '?TMP,HERE
	SET '?TMP?1,PRSO
	CALL DIR-FROM,HERE,RM >STACK
	CALL DIR-EQV?,?TMP,?TMP?1,STACK >STACK
	ZERO? STACK /?L19
	RTRUE
?L14:	EQUAL? PRSA,V?THROUGH,V?WALK-TO \?L19
	CALL META-LOC,PRSO >STACK
	EQUAL? STACK,RM /TRUE
?L19:	PRINTD FRIEND
	PRINTI " says, ""Please don't wander off yet. I want you to "
	FSET? DOCTOR,TOUCHBIT \?L26
	PRINTI "see "
	PRINTD YOUR-ROOM
	PRINTR "."""
?L26:	PRINTR "meet the other guests."""

	.FUNCT CREEPY?,RM
	FSET? RM,SECRETBIT /TRUE
	EQUAL? RM,TOMB,DUNGEON,CRYPT /TRUE
	RFALSE

	.FUNCT GOTO,RM,TEST=1,FOLLOW?=1,X
	IN? WINNER,RM \?L1
	CALL WALK-WITHIN-ROOM
	RFALSE
?L1:	GETP HERE,P?ACTION >STACK
	CALL STACK,M-EXIT >STACK
	ZERO? STACK \FALSE
	EQUAL? WINNER,PLAYER \?L6
	CALL TOUR? >STACK
	ZERO? STACK \FALSE
	ZERO? FOLLOW? /?L10
	ZERO? FOLLOWER /?L10
	CALL FRIEND-FOLLOWS-YOU,RM
?L10:	RANDOM 2 >STACK
	EQUAL? STACK,1 \?L19
	ZERO? FOLLOWER \?L19
	CALL CREEPY?,HERE >STACK
	ZERO? STACK /?L19
	CALL CREEPY?,RM >STACK
	ZERO? STACK /?L19
	PRINTI "You "
	CALL PICK-ONE-NEW,CREEPIES >STACK
	PRINT STACK
	CRLF
	JUMP ?L19
?L6:	FSET? RM,SECRETBIT \?L18
	CALL NOT-INTO-PASSAGE,WINNER
	RFALSE
?L18:	EQUAL? RM,YOUR-BATHROOM \?L19
	CALL NOT-INTO-PASSAGE,WINNER,0,0
	RFALSE
?L19:	ZERO? TEST /?L25
	EQUAL? WINNER,PLAYER \?L25
	CALL DIR-FROM,HERE,RM >X
	ZERO? X /?L25
	GETP HERE,P?ACTION >STACK
	CALL STACK,X >STACK
	EQUAL? M-FATAL,STACK /FALSE
?L25:	GETP WINNER,P?CHARACTER >STACK
	PUT FOLLOW-LOC,STACK,RM
	IN? WINNER,CAR \?L30
	EQUAL? RM,COURTYARD \?L30
	MOVE CAR,RM
?L30:	MOVE WINNER,RM
	EQUAL? WINNER,PLAYER \TRUE
	SET 'OHERE,HERE
	SET 'HERE,RM
	CALL MAKE-ALL-PEOPLE,-12
	CALL ENTER-ROOM
	RTRUE

	.FUNCT HACK-HACK,STR
	PRINT STR
	CALL HIM-HER-IT,PRSO
	CALL PICK-ONE,HO-HUM >STACK
	PRINT STACK
	CRLF
	RTRUE

	.FUNCT HELD?,OBJ,CONT=0,L
	ZERO? CONT \?L1
	SET 'CONT,PLAYER
?L1:	EQUAL? OBJ,ARTIFACT \?L4
	ZERO? TREASURE-FOUND /?L4
	SET 'OBJ,TREASURE
?L4:	LOC OBJ >L
	ZERO? L /FALSE
	EQUAL? L,CONT /TRUE
	EQUAL? CONT,PLAYER,WINNER \?L12
	EQUAL? OBJ,HANDS,HEAD,EYE /TRUE
	EQUAL? OBJ,NOW-WEARING /TRUE
	EQUAL? OBJ,CAR \?L16
	EQUAL? PRSA,V?MUNG /TRUE
?L16:	SET 'OBJ,L
	JUMP ?L4
?L12:	EQUAL? L,ROOMS,GLOBAL-OBJECTS /FALSE
	SET 'OBJ,L
	JUMP ?L4

	.FUNCT IDROP
	CALL NOT-HOLDING?,PRSO >STACK
	ZERO? STACK \FALSE
	IN? PRSO,WINNER /?L3
	LOC PRSO >STACK
	FSET? STACK,OPENBIT /?L3
	LOC PRSO >STACK
	CALL TOO-BAD-BUT,STACK,STR?79
	RFALSE
?L3:	MOVE PRSO,HERE
	FCLEAR PRSO,WORNBIT
	FCLEAR PRSO,NDESCBIT
	FCLEAR PRSO,INVISIBLE
	RTRUE

	.FUNCT ITAKE,VB=1,CNT,OBJ,L,?TMP
	LOC PRSO >L
	ZERO? L /?L8
	FSET? L,PERSONBIT \?L8
	FSET? PRSO,TAKEBIT /?L3
	FSET? L,MUNGBIT /?L3
	ZERO? VB /FALSE
	CALL YOU-CANT,STR?80
	RFALSE
?L3:	FSET PRSO,TAKEBIT
?L8:	FSET? PRSO,TAKEBIT /?L10
	ZERO? VB /FALSE
	CALL YOU-CANT,STR?80
	RFALSE
?L10:	CALL CCOUNT,WINNER >CNT
	GRTR? CNT,FUMBLE-NUMBER \?L15
	MUL CNT,FUMBLE-PROB >?TMP
	RANDOM 100 >STACK
	LESS? ?TMP,STACK /?L15
	CALL FIND-FLAG-NOT,WINNER,WORNBIT >OBJ
	ZERO? OBJ /?L15
	CALL TOO-BAD-BUT
	CALL PRINTT,OBJ
	PRINTI " slips from"
	CALL HIM-HER-IT,WINNER,0,1
	PRINTI " arms while"
	CALL HE-SHE-IT,WINNER,0,STR?44
	PRINTI " taking"
	CALL HIM-HER-IT,PRSO
	PRINTI ", and both tumble "
	CALL GROUND-DESC >STACK
	PRINT STACK
	PRINTI ". "
	CALL HE-SHE-IT,WINNER,1,STR?44
	PRINTI " carrying too many things.
"
	MOVE OBJ,HERE
	MOVE PRSO,HERE
	RETURN 2
?L15:	MOVE PRSO,WINNER
	FSET PRSO,SEENBIT
	FSET PRSO,TOUCHBIT
	FCLEAR PRSO,NDESCBIT
	FCLEAR PRSO,INVISIBLE
	FCLEAR PRSO,SECRETBIT
	EQUAL? PRSA,V?TAKE /TRUE
	EQUAL? L,WINNER /TRUE
	FSET? L,PERSONBIT /?L23
	EQUAL? L,SIDEBOARD \TRUE
?L23:	CALL FIRST-YOU,STR?80,PRSO,L
	RTRUE

	.FUNCT CCOUNT,OBJ,CNT=0,X
	FIRST? OBJ >X \?L4
?L3:	FSET? X,WORNBIT /?L5
	INC 'CNT
?L5:	NEXT? X >X /?L3
?L4:	RETURN CNT

	.FUNCT CHECK-DOOR,DR
	CALL START-SENTENCE,DR
	PRINTI " is "
	CALL THIS-IS-IT,DR
	FSET? DR,OPENBIT \?L3
	PRINTI "open"
	JUMP ?L7
?L3:	PRINTI "closed and "
	FSET? DR,LOCKED /?L10
	PRINTI "un"
?L10:	PRINTI "locked"
?L7:	PRINTR "."

	.FUNCT ROOM-CHECK,P,PA
	SET 'P,PRSO
	EQUAL? P,ROOMS /FALSE
	IN? P,ROOMS \?L3
	EQUAL? HERE,P /FALSE
	GETP P,P?STATION >STACK
	EQUAL? HERE,STACK /?L7
	CALL GLOBAL-IN?,P,HERE >STACK
	ZERO? STACK /?L6
?L7:	EQUAL? PRSA,V?SEARCH-FOR /?L10
	EQUAL? PRSA,V?SEARCH,V?SIT,V?LIE \FALSE
?L10:	CALL META-LOC,P >P
	EQUAL? P,HERE /FALSE
	CALL FIRST-YOU,STR?81,P
	SET 'PA,PRSA
	CALL PERFORM,V?THROUGH,P >P
	SET 'PRSA,PA
	EQUAL? M-FATAL,P \FALSE
	RTRUE
?L6:	CALL SEE-INTO?,P >STACK
	ZERO? STACK \FALSE
	RTRUE
?L3:	CALL META-LOC,P >STACK
	EQUAL? STACK,HERE,GLOBAL-OBJECTS,LOCAL-GLOBALS /FALSE
	CALL VISIBLE?,P >STACK
	ZERO? STACK \FALSE
	CALL NOT-HERE,P >STACK
	RSTACK

	.FUNCT SEE-INSIDE?,OBJ,ONLY-IN=0
	FSET? OBJ,TRANSBIT /TRUE
	FSET? OBJ,OPENBIT /TRUE
	ZERO? ONLY-IN \FALSE
	FSET? OBJ,SURFACEBIT /TRUE
	RFALSE

	.FUNCT ARENT-TALKING
	SET 'CLOCK-WAIT,1
	PRINTR "(You aren't talking to anyone!)"

	.FUNCT ALREADY,OBJ,STR=0
	SET 'CLOCK-WAIT,1
	PRINTC 40
	CALL START-SENTENCE,OBJ
	EQUAL? OBJ,PLAYER \?L7
	PRINTI " are"
	JUMP ?L11
?L7:	PRINTI " is"
?L11:	PRINTI " already "
	ZERO? STR /TRUE
	PRINT STR
	PRINTR "!)"

	.FUNCT NOT-CLEAR-WHOM
	SET 'QUOTE-FLAG,0
	SET 'P-CONT,0
	PRINTR "[It's not clear whom you're talking to.]"

	.FUNCT OKAY,OBJ=0,STR=0
	EQUAL? WINNER,PLAYER,BUTLER \?L1
	EQUAL? PRSA,V?WALK-TO,V?WALK,V?THROUGH \?L6
	RTRUE
?L1:	PRINTI """"
?L6:	PRINTI "Okay"
	ZERO? OBJ /?L26
	PRINTC 44
	CALL HE-SHE-IT,OBJ
	ZERO? STR /?L15
	PRINTI " is now "
	PRINT STR
?L15:	EQUAL? STR,STR?82 \?L20
	FSET OBJ,ONBIT
	JUMP ?L26
?L20:	EQUAL? STR,STR?83 \?L22
	FCLEAR OBJ,ONBIT
	JUMP ?L26
?L22:	EQUAL? STR,STR?84 \?L23
	FSET OBJ,OPENBIT
	JUMP ?L26
?L23:	EQUAL? STR,STR?79 \?L24
	FCLEAR OBJ,OPENBIT
	JUMP ?L26
?L24:	EQUAL? STR,STR?85 \?L25
	FSET OBJ,LOCKED
	JUMP ?L26
?L25:	EQUAL? STR,STR?86 \?L26
	FCLEAR OBJ,LOCKED
?L26:	ZERO? STR \?L31
	ZERO? OBJ \?L29
?L31:	EQUAL? WINNER,PLAYER /?L32
	PRINTI ","" says "
	PRINTD WINNER
	PRINTI ". "
	CALL HE-SHE-IT,WINNER,1
	PRINTR " does so."
?L32:	PRINTI "."
	CRLF
?L29:	ZERO? LIT \TRUE
	CALL LIT? >LIT
	ZERO? LIT /TRUE
	CRLF
	CALL V-LOOK
	RTRUE

	.FUNCT TOO-BAD-BUT,OBJ=0,STR=0
	PRINTI "Too bad, but"
	CALL PRINT-ID,STR?87
	ZERO? OBJ /?L3
	CALL HE-SHE-IT,OBJ
?L3:	ZERO? STR /TRUE
	PRINTI " is "
	PRINT STR
	EQUAL? STR,STR?89,STR?88 \?L12
	PRINTI " with you"
?L12:	PRINTR "."

	.FUNCT TOO-DARK
	PRINTR "(It's too dark to see!)"

	.FUNCT VISIBLE?,OBJ,H,L,X=0
	ZERO? OBJ /FALSE
	CALL ACCESSIBLE?,OBJ >STACK
	ZERO? STACK \TRUE
	CALL CORRIDOR-LOOK,OBJ >X
	ZERO? X \TRUE
	LOC OBJ >L
	CALL SEE-INSIDE?,L >STACK
	ZERO? STACK /FALSE
	CALL VISIBLE?,L >STACK
	RSTACK

	.FUNCT ACCESSIBLE?,OBJ,L
	ZERO? OBJ /FALSE
	LOC OBJ >L
	FSET? OBJ,INVISIBLE /FALSE
	EQUAL? OBJ,PSEUDO-OBJECT \?L6
	EQUAL? LAST-PSEUDO-LOC,HERE \FALSE
	RTRUE
?L6:	ZERO? L /FALSE
	EQUAL? L,GLOBAL-OBJECTS /TRUE
	EQUAL? L,LOCAL-GLOBALS \?L12
	CALL GLOBAL-IN?,OBJ,HERE >STACK
	RSTACK
?L12:	CALL META-LOC,OBJ >STACK
	EQUAL? STACK,HERE \FALSE
	EQUAL? L,WINNER,HERE /TRUE
	FSET? L,OPENBIT /?L16
	FSET? L,SURFACEBIT /?L16
	FSET? L,PERSONBIT \FALSE
?L16:	CALL ACCESSIBLE?,L >STACK
	RSTACK

	.FUNCT META-LOC,OBJ,INV=0,L
	LOC OBJ >L
?L1:	ZERO? L /FALSE
	EQUAL? L,NOW-WEARING \?L5
	RETURN HERE
?L5:	EQUAL? L,LOCAL-GLOBALS,GLOBAL-OBJECTS \?L6
	RETURN L
?L6:	IN? OBJ,ROOMS \?L7
	RETURN OBJ
?L7:	ZERO? INV /?L9
	FSET? OBJ,INVISIBLE /FALSE
?L9:	SET 'OBJ,L
	LOC OBJ >L
	JUMP ?L1

	.FUNCT WHO-CARES,N
	RANDOM WHO-CARES-LENGTH >N
	GET WHO-CARES-VERB,N >STACK
	CALL HE-SHE-IT,PRSO,1,STACK
	GET WHO-CARES-TBL,N >STACK
	PRINT STACK
	PRINTR "."

	.FUNCT PRE-SAIM
	CALL PERFORM,V?AIM,PRSI,PRSO
	RTRUE

	.FUNCT V-SAIM
	CALL V-FOO >STACK
	RSTACK

	.FUNCT V-AIM
	CALL YOU-CANT >STACK
	RSTACK

	.FUNCT PRE-SANALYZE
	CALL PERFORM,V?ANALYZE,PRSI,PRSO
	RTRUE

	.FUNCT V-SANALYZE
	CALL V-FOO >STACK
	RSTACK

	.FUNCT PRE-ANALYZE
	CALL ROOM-CHECK >STACK
	ZERO? STACK \TRUE
	FSET? PRSO,PERSONBIT \FALSE
	SET 'CLOCK-WAIT,1
	PRINTR "(Leave that to the police.)"

	.FUNCT V-ANALYZE
	FSET? PRSO,PERSONBIT \?L1
	PRINTR "How?"
?L1:	FSET? PRSO,DOORBIT \?L5
	CALL CHECK-DOOR,PRSO >STACK
	RSTACK
?L5:	CALL HE-SHE-IT,PRSO,1,STR?90
	PRINTR " normal."

	.FUNCT V-ANSWER
	ZERO? AWAITING-REPLY /?L1
	GET P-LEXV,P-CONT >STACK
	EQUAL? STACK,W?YES \?L3
	CALL PERFORM,V?YES
	JUMP ?L6
?L3:	CALL PERFORM,V?NO
	JUMP ?L6
?L1:	CALL NOT-CLEAR-WHOM
?L6:	SET 'P-CONT,0
	SET 'QUOTE-FLAG,0
	RTRUE

	.FUNCT V-REPLY
	SET 'P-CONT,0
	SET 'QUOTE-FLAG,0
	FSET? PRSO,PERSONBIT \?L1
	FSET? PRSO,MUNGBIT /?L1
	CALL WAITING-FOR-YOU-TO-SPEAK >STACK
	RSTACK
?L1:	CALL YOU-CANT >STACK
	RSTACK

	.FUNCT WAITING-FOR-YOU-TO-SPEAK
	CALL HE-SHE-IT,PRSO,1,STR?91
	PRINTR " to be waiting for you to speak."

	.FUNCT PRE-ARREST
	EQUAL? PRSI,ROOMS \?L1
	SET 'PRSI,0
?L1:	FSET? PRSO,PERSONBIT /?L4
	SET 'CLOCK-WAIT,1
	PRINTI "(Are you sure you're a"
	PRINT FAMOUS-YOUNG-DETECTIVE
	PRINTI "? Arresting "
	CALL PRINTA,PRSO
	PRINTR "?!)"
?L4:	ZERO? CONFESSED /?L8
	CALL ALREADY,CONFESSED,STR?92 >STACK
	RSTACK
?L8:	ZERO? LIONEL-SPEAKS-COUNTER /?L9
	CALL TELL-BAD-FORM
	RTRUE
?L9:	EQUAL? PRSO,GHOST-NEW /FALSE
	CALL UNSNOOZE,PRSO
	RFALSE

	.FUNCT TELL-BAD-FORM
	SET 'CLOCK-WAIT,1
	PRINTI "(Bad form"
	CALL IAN-CALLS-YOU
	PRINTR ". Wait until after dinner.)"

	.FUNCT V-ARREST
	CALL QUEUED?,I-SHOT >STACK
	EQUAL? STACK,1 /TRUE
	GETP PRSO,P?CHARACTER >STACK
	EQUAL? VARIATION,STACK \?L3
	ZERO? EVIDENCE-FOUND /?L3
	CALL CONFESSION,PRSO >STACK
	RSTACK
?L3:	SET 'CLOCK-WAIT,1
	PRINTI "(It would be difficult to convict"
	CALL HIM-HER-IT,PRSO
	PRINTR " with the evidence you've found. If you hope to put the culprit behind bars, you'll need more convincing proof.)"

	.FUNCT CONFESSION,PER,P,DEAD=0
	SET 'CONFESSED,PER
	PUTP PER,P?LINE,2
	ZERO? TREASURE-FOUND /?L1
	GET FOUND-COSTUME,PLAYER-C >STACK
	ZERO? STACK /?L1
	SET 'P,BUTLER
	JUMP ?L4
?L1:	EQUAL? VARIATION,LORD-C \?L3
	SET 'P,DOCTOR
	JUMP ?L4
?L3:	SET 'P,LORD
?L4:	SET 'CAPTOR,P
	CALL UNSNOOZE,P,1
	PUTP P,P?LDESC,9
	FSET? PER,MUNGBIT \?L5
	CALL UNSNOOZE,PER >STACK
	ZERO? STACK \?L5
	SET 'DEAD,1
	JUMP ?L7
?L5:	GETP PER,P?CHARACTER >STACK
	GET TOLD-ABOUT-EVID,STACK >STACK
	ZERO? STACK /?L10
	CALL FIND-FLAG-HERE,PERSONBIT,PLAYER,PER >STACK
	ZERO? STACK /?L8
?L10:	PRINTI "At first"
	CALL HE-SHE-IT,PER
	PRINTI " denies everything, but when you tell about"
	CALL PRINTT,EVIDENCE-FOUND
	PRINTI ","
	CALL HE-SHE-IT,PER
	JUMP ?L13
?L8:	CALL HE-SHE-IT,PER,1
?L13:	PRINTI " rushes at you! "
	GETP PER,P?CHARACTER >STACK
	GET GOAL-TABLES,STACK >STACK
	PUT STACK,GOAL-FUNCTION,NULL-F
?L7:	PRINTI "Suddenly "
	PRINTD P
	IN? P,HERE /?L22
	MOVE P,HERE
	GETP P,P?CHARACTER >STACK
	GET GOAL-TABLES,STACK >STACK
	PUT STACK,GOAL-ENABLE,0
	PRINTI " appears and"
?L22:	ZERO? DEAD \?L27
	PRINTI " grabs"
	CALL HIM-HER-IT,PER
	PRINTI " from behind, saying, ""I'll guard this villain for you."" Then "
	PRINTD PER
	PRINTI " glares at you and confesses to "
	JUMP ?L31
?L27:	PRINTI " agrees that"
	CALL PRINTT,EVIDENCE-FOUND
	PRINTI " proves "
	PRINTD PER
	PRINTI " guilty of "
	CALL PRINT-ID,STR?93
?L31:	EQUAL? PER,FRIEND \?L34
	PRINTI "fraud.
"
	JUMP ?L38
?L34:	EQUAL? PER,PAINTER \?L39
	PRINTI "attempted "
	CALL PRINT-ID,STR?94
?L39:	PRINTI "murder.
"
?L38:	ZERO? DEAD \?L46
	PUTP PER,P?LDESC,20
?L46:	ZERO? TREASURE-FOUND /TRUE
	GET FOUND-COSTUME,PLAYER-C >STACK
	ZERO? STACK /TRUE
	CALL WRAP-UP
	CALL FINISH
	RTRUE

	.FUNCT WRAP-UP
	PRINTI "
(Congratulations, "
	CALL TITLE-NAME
	PRINTI "! Would you like to read the authors' version of the crime?)"
	CALL YES? >STACK
	ZERO? STACK \?L3
	PRINTR "Okay."
?L3:	EQUAL? VARIATION,LORD-C \?L7
	PRINTD LORD
	PRINTI " murdered Lionel in order to inherit the title and castle.
"
	PRINTD LOVER
	PRINTI " was blackmailing "
	PRINTD LORD
	PRINTI " to marry her, because she knew he was plotting to kill Lionel. So Jack tried to do away with her, too, by dumping her down the well.
But Jack was wrong in thinking he killed "
	PRINTD LOVER
	PRINTI ". She survived and came back to the castle at night -- to play on "
	PRINTD FRIEND
	PRINTI "'s nerves, since her arrival seemed to be part of Jack's plot; to hunt for proof that Jack murdered Lionel; and to try to frame him for her own ""murder"" by planting"
	CALL PRINTT,JEWEL
	PRINTI " in his trouser cuff, until she lost it in the "
	PRINTD DRAWING-ROOM
	PRINTR "."
?L7:	EQUAL? VARIATION,FRIEND-C \?L10
	PRINTD FRIEND
	PRINTI " doubted that she could hold "
	PRINTD LORD
	PRINTI "'s love. She was both jealous and fearful of "
	PRINTD DEB
	PRINTI " as a rival who might someday take Jack away from her. So she tried to defame "
	PRINTD DEB
	PRINTI " by making it appear "
	PRINTD DEB
	PRINTI " was a vengeful ghost bent on killing Jack's new love, "
	PRINTD FRIEND
	PRINTI ". "
	PRINTD LOVER
	PRINTR "'s death was purely an accident."
?L10:	EQUAL? VARIATION,DOCTOR-C \?L13
	PRINTD LOVER
	PRINTI " strongly suspected that her grandfather died because of "
	PRINTD DOCTOR
	PRINTI "'s fiendish experiments on his patients. So she wrote a letter to Lionel, begging him to use his influence to investigate "
	PRINTD DOCTOR
	PRINTI ", which he did. However, "
	PRINTD DOCTOR
	PRINTI " found out what they were up to, and silenced both of them.
He has masqueraded as a ghost to cover his midnight searches for the "
	PRINTD ARTIFACT
	PRINTI ". He intended the attacks on "
	PRINTD FRIEND
	PRINTI " to create the belief that "
	PRINTD LOVER
	PRINTR " might still be alive."
?L13:	PRINTD PAINTER
	PRINTI " was intensely attached to "
	PRINTD LOVER
	PRINTI ", and she jealously hated "
	PRINTD LORD
	PRINTI " for coming between them. When "
	PRINTD LOVER
	PRINTI " accidentally fell down the well, "
	PRINTD PAINTER
	PRINTI " was convinced that she had committed suicide because she felt abandoned by Jack.
So "
	PRINTD PAINTER
	PRINTI " began her vengeful ghostly masquerade -- to find proof that Jack was responsible for "
	PRINTD LOVER
	PRINTI "'s death, to prick his guilty conscience and make him confess, and to terrorize "
	PRINTD FRIEND
	PRINTI ", who replaced "
	PRINTD LOVER
	PRINTR " in Jack's affections."

	.FUNCT V-ASK
	ZERO? P-CONT /?L1
	FSET? PRSO,PERSONBIT \?L1
	FSET? PRSO,MUNGBIT /?L1
	SET 'WINNER,PRSO
	SET 'QCONTEXT,PRSO
	RETURN QCONTEXT
?L1:	CALL V-ASK-ABOUT >STACK
	RSTACK

	.FUNCT PRE-ASK-ABOUT
	EQUAL? PRSO,VOICE,RECORDER,PLAYER-NAME /FALSE
	EQUAL? PRSO,PIANO,OCEAN,MUSIC /FALSE
	EQUAL? PRSO,JACK-TAPE,CREW-GLOBAL,BUST /FALSE
	EQUAL? PRSO,COUSIN \?L4
	IN? BUST,HERE \?L4
	CALL DO-INSTEAD-OF,BUST,COUSIN >STACK
	RSTACK
?L4:	CALL META-LOC,PRSO >STACK
	EQUAL? STACK,HERE /?L5
	CALL GLOBAL-IN?,PRSO,HERE >STACK
	ZERO? STACK \?L5
	CALL NOT-HERE,PRSO
	RETURN 2
?L5:	EQUAL? PRSO,PLAYER /?L9
	FSET? PRSO,PERSONBIT /?L8
?L9:	EQUAL? PRSA,V?$0024CALL \?L10
	ZERO? P-CONT \?L10
	CALL MISSING,STR?66
	RETURN 2
?L10:	EQUAL? PRSA,V?LISTEN /FALSE
	CALL WONT-HELP-TO-TALK-TO,PRSO
	RETURN 2
?L8:	CALL GRAB-ATTENTION,PRSO,PRSI >STACK
	ZERO? STACK \FALSE
	RETURN 2

	.FUNCT V-ASK-ABOUT
	FSET? PRSO,PERSONBIT \?L3
	FSET? PRSO,MUNGBIT \?L1
?L3:	CALL WONT-HELP-TO-TALK-TO,PRSO
	RETURN 2
?L1:	EQUAL? PRSA,V?ASK \?L6
	EQUAL? PRSO,PLAYER /?L6
	PRINTR """Ask me about something in particular."""
?L6:	CALL HE-SHE-IT,PRSO,1,STR?50
	PRINTI "n't know anything interesting about"
	ZERO? PRSI \?L12
	PRINTI " that"
	JUMP ?L16
?L12:	CALL PRINTT,PRSI
?L16:	PRINTR "."

	.FUNCT WONT-HELP-TO-TALK-TO,OBJ
	PRINTI "You talk to"
	CALL PRINTT,OBJ
	PRINTI " for a minute before you realize that"
	CALL HE-SHE-IT,OBJ
	PRINTR " won't respond."

	.FUNCT PRE-ASK-CONTEXT-ABOUT,V=0,P
	ZERO? V \?L1
	SET 'V,V?ASK-ABOUT
?L1:	CALL QCONTEXT-GOOD? >STACK
	ZERO? STACK /?L4
	CALL PERFORM,V,QCONTEXT,PRSO
	RTRUE
?L4:	CALL FIND-FLAG-HERE-NOT,PERSONBIT,MUNGBIT,WINNER >P
	ZERO? P /FALSE
	CALL TELL-I-ASSUME,P,STR?95
	CALL PERFORM,V,P,PRSO
	RTRUE

	.FUNCT V-ASK-CONTEXT-ABOUT
	CALL ARENT-TALKING >STACK
	RSTACK

	.FUNCT V-ASK-FOR
	FSET? PRSO,PERSONBIT \?L1
	FSET? PRSO,MUNGBIT /?L1
	EQUAL? PRSO,PLAYER /?L1
	CALL START-SENTENCE,PRSO
	IN? PRSI,PRSO \?L5
	MOVE PRSI,WINNER
	FSET PRSI,TAKEBIT
	FSET PRSI,TOUCHBIT
	FCLEAR PRSI,NDESCBIT
	FCLEAR PRSI,SECRETBIT
	PRINTI " hands you"
	CALL PRINTT,PRSI
	FSET PRSI,SEENBIT
	PRINTR "."
?L5:	PRINTI " doesn't have"
	CALL PRINTT,PRSI
	PRINTR "."
?L1:	CALL HAR-HAR >STACK
	RSTACK

	.FUNCT PRE-ASK-CONTEXT-FOR,P
	LOC PRSO >P
	FSET? P,PERSONBIT \?L1
	CALL PERFORM,V?ASK-FOR,P,PRSO
	RTRUE
?L1:	CALL PRE-ASK-CONTEXT-ABOUT,V?ASK-FOR >STACK
	RSTACK

	.FUNCT V-ASK-CONTEXT-FOR
	CALL ARENT-TALKING >STACK
	RSTACK

	.FUNCT V-ATTACK,?TMP
	CALL IS-PERSON? >?TMP
	ZERO? ?TMP /?L2
	PUSH ?TMP
	JUMP ?L1
?L2:	CALL IS-OBJECT-OR-PROPERTY? >STACK
?L1:	CALL PRINT-ID,STR?96,STACK
	CALL IS-SELF? >STACK
	CALL PRINT-ID,STR?97,STACK
	CALL IKILL,STR?98 >STACK
	RSTACK

	.FUNCT V-BOW,P
	SET 'P,PRSO
	ZERO? P \?L3
	CALL FIND-FLAG-HERE-NOT,PERSONBIT,MUNGBIT,WINNER >P
	ZERO? P \?L3
	PRINTR "No one notices."
?L3:	FSET? P,PERSONBIT \?L11
	EQUAL? P,PLAYER \?L9
?L11:	CALL HAR-HAR >STACK
	RSTACK
?L9:	CALL GRAB-ATTENTION,P >STACK
	ZERO? STACK /TRUE
	CALL HE-SHE-IT,P,1
	PRINTC 32
	FSET? P,FEMALE \?L16
	PRINTI "curtsey"
	JUMP ?L20
?L16:	PRINTI "bow"
?L20:	PRINTR "s back to you."

	.FUNCT PRE-BRUSH
	EQUAL? PRSO,ROOMS \FALSE
	EQUAL? P-PRSA-WORD,W?SCRAPE,W?SCRATCH /FALSE
	SET 'PRSO,WINNER
	RFALSE

	.FUNCT V-BRUSH
	EQUAL? P-PRSA-WORD,W?SCRAPE,W?SCRATCH \?L3
	FSET? PRSO,PERSONBIT \?L1
?L3:	EQUAL? HERE,YOUR-BATHROOM,KITCHEN \?L4
	EQUAL? PRSO,PLAYER,HEAD,HANDS \?L6
	SET 'WASHED,1
	PRINT AHHH
	RTRUE
?L6:	FSET? PRSO,PERSONBIT \?L10
	CALL FACE-RED >STACK
	RSTACK
?L10:	CALL UNCLEAN >STACK
	RSTACK
?L4:	CALL TELL-FIND-NONE,STR?99 >STACK
	RSTACK
?L1:	CALL UNCLEAN >STACK
	RSTACK

	.FUNCT UNCLEAN
	PRINTR "You try for a minute and then decide it's an endless task."

	.FUNCT REMOVE-CAREFULLY,OBJ=0,OLIT
	SET 'OLIT,LIT
	ZERO? OBJ /?L1
	CALL NOT-IT,OBJ
	MOVE OBJ,LOCAL-GLOBALS
?L1:	CALL LIT? >LIT
	ZERO? OLIT /TRUE
	ZERO? LIT \TRUE
	PRINTR "You are left in the dark..."

	.FUNCT V-$0024CALL
	CALL UNSNOOZE,PRSO
	FSET? PRSO,PERSONBIT \?L1
	CALL META-LOC,PRSO >STACK
	EQUAL? STACK,HERE \?L3
	CALL GRAB-ATTENTION,PRSO >STACK
	ZERO? STACK /?L5
	PUTP PRSO,P?LDESC,12
	CALL START-SENTENCE,PRSO
	PRINTI " is "
	GET LDESC-STRINGS,12 >STACK
	PRINT STACK
	PRINTR "."
?L5:	RETURN 2
?L3:	CALL CORRIDOR-LOOK,PRSO >STACK
	ZERO? STACK /?L16
	CALL START-SENTENCE,PRSO
	PRINTR " ignores you."
?L16:	CALL NOT-HERE,PRSO >STACK
	RSTACK
?L1:	SET 'CLOCK-WAIT,1
	CALL MISSING,STR?66 >STACK
	RSTACK

	.FUNCT V-CHASTISE
	EQUAL? PRSO,INTDIR /?L1
	PRINT I-ASSUME
	PRINTI " Look at"
	CALL HIM-HER-IT,PRSO
	PRINTI ", not look in"
	CALL HIM-HER-IT,PRSO
	PRINTI " nor look for"
	CALL HIM-HER-IT,PRSO
	PRINTI " nor any other preposition.]"
	CRLF
?L1:	CALL PERFORM,V?EXAMINE,PRSO
	RTRUE

	.FUNCT V-BOARD
	IN? PRSO,ROOMS /?L3
	FSET? PRSO,DOORBIT \?L1
?L3:	CALL V-THROUGH >STACK
	RSTACK
?L1:	FSET? PRSO,VEHBIT \?L4
	IN? WINNER,PRSO \?L5
	CALL ALREADY,PLAYER
	PRINTI "in"
	CALL PRINTT,PRSO
	PRINTR ".)"
?L5:	MOVE WINNER,PRSO
	PRINTI "You are now "
	FSET? PRSO,SURFACEBIT \?L12
	PRINTI "on"
	JUMP ?L16
?L12:	PRINTI "in"
?L16:	CALL PRINTT,PRSO
	PRINTR "."
?L4:	CALL YOU-CANT,STR?100 >STACK
	RSTACK

	.FUNCT V-CLIMB-ON
	CALL PERFORM,V?SIT,PRSO
	RTRUE

	.FUNCT V-CLIMB-UP,DIR=P?UP,OBJ=0,X
	IN? PRSO,ROOMS \?L1
	CALL PERFORM,V?WALK-TO,PRSO
	RTRUE
?L1:	GETPT HERE,DIR >STACK
	ZERO? STACK /?L3
	CALL DO-WALK,DIR
	RTRUE
?L3:	ZERO? OBJ \?L4
	CALL YOU-CANT,STR?74 >STACK
	RSTACK
?L4:	CALL HAR-HAR >STACK
	RSTACK

	.FUNCT V-CLIMB-DOWN
	CALL V-CLIMB-UP,P?DOWN >STACK
	RSTACK

	.FUNCT V-CLOSE
	FSET? PRSO,CONTBIT /?L1
	FSET? PRSO,DOORBIT /?L4
	EQUAL? PRSO,WINDOW /?L1
	CALL YOU-CANT >STACK
	RSTACK
?L1:	FSET? PRSO,DOORBIT /?L4
	EQUAL? PRSO,WINDOW \?L3
?L4:	FSET? PRSO,OPENBIT \?L5
	CALL OKAY,PRSO,STR?79 >STACK
	RSTACK
?L5:	CALL ALREADY,PRSO,STR?79 >STACK
	RSTACK
?L3:	FSET? PRSO,SURFACEBIT /?L10
	GETP PRSO,P?CAPACITY >STACK
	ZERO? STACK /?L10
	FSET? PRSO,OPENBIT \?L11
	CALL OKAY,PRSO,STR?79 >STACK
	RSTACK
?L11:	CALL ALREADY,PRSO,STR?79 >STACK
	RSTACK
?L10:	CALL YOU-CANT >STACK
	RSTACK

	.FUNCT PRE-COMPARE
	ZERO? PRSI \?L1
	GETB P-PRSO,P-MATCHLEN >STACK
	EQUAL? 1,STACK \?L1
	SET 'CLOCK-WAIT,1
	PRINTI "[Oops! Try: COMPARE IT TO"
	PRINT SOMETHING
	RTRUE
?L1:	GETB P-PRSO,P-MATCHLEN >STACK
	EQUAL? 2,STACK \FALSE
	PUTB P-PRSO,P-MATCHLEN,1
	GETB P-PRSO,2 >STACK
	GETB P-PRSO,1 >STACK
	CALL PERFORM,PRSA,STACK,STACK
	RTRUE

	.FUNCT V-COMPARE
	EQUAL? PRSO,PRSI \?L1
	PRINTR "They're the same thing!"
?L1:	EQUAL? PLAYER,PRSO,PRSI \?L6
	PRINTI "You"
	JUMP ?L10
?L6:	PRINTI "They"
?L10:	PRINTR "'re not a bit alike."

	.FUNCT V-CONFRONT
	EQUAL? PRSO,PLAYER \?L1
	CALL ARENT-TALKING >STACK
	RSTACK
?L1:	FSET? PRSO,PERSONBIT /?L3
	PRINTI "Wow! That ought to put a scare into"
	CALL HIM-HER-IT,PRSO
	PRINTR "!"
?L3:	CALL WHO-CARES >STACK
	RSTACK

	.FUNCT V-MUNG
	CALL PRINT-ID,STR?101
	FSET? PRSO,DOORBIT \?L1
	ZERO? PRSI \?L1
	FSET? PRSO,OPENBIT \?L3
	PRINTR "You'd fly through the open door if you tried."
?L3:	CALL UNLOCK-DOOR?,PRSO >STACK
	ZERO? STACK /?L7
	PRINTR "Why don't you just open it instead?"
?L7:	CALL IF-SPY >STACK
	RSTACK
?L1:	FSET? PRSO,PERSONBIT /?L11
	CALL IS-OBJECT-OR-PROPERTY? >STACK
	CALL PRINT-ID,STR?102,STACK
	CALL IF-SPY >STACK
	RSTACK
?L11:	CALL PRINT-ID,STR?103
	CALL IKILL,STR?104 >STACK
	RSTACK

	.FUNCT V-DANCE,OW
	EQUAL? WINNER,PLAYER /?L1
	EQUAL? PRSO,PLAYER \?L1
	SET 'OW,WINNER
	SET 'WINNER,PLAYER
	CALL PERFORM,V?DANCE,OW
	SET 'WINNER,OW
	RTRUE
?L1:	FSET? PRSO,PERSONBIT /?L3
	CALL HAR-HAR >STACK
	RSTACK
?L3:	CALL IN-MOTION?,PRSO >STACK
	ZERO? STACK /?L4
	CALL TOO-BAD-BUT,PRSO,STR?105 >STACK
	RSTACK
?L4:	ZERO? GENDER-KNOWN \?L7
	EQUAL? WINNER,PLAYER /?L6
?L7:	FSET? WINNER,FEMALE /?L14
	FSET? PRSO,FEMALE /?L6
	FSET? WINNER,FEMALE \?L5
?L14:	FSET? PRSO,FEMALE /?L5
?L6:	CALL HE-SHE-IT,WINNER,1,STR?106
	PRINTI " with"
	CALL HIM-HER-IT,PRSO
	PRINTR " for a minute."
?L5:	CALL HE-SHE-IT,PRSO,1
	PRINTR " doesn't fancy a dance with you."

	.FUNCT PRE-DESCRIBE
	EQUAL? WINNER,PLAYER \FALSE
	EQUAL? PRSI,0,ROOMS \?L3
	CALL QCONTEXT-GOOD? >STACK
	ZERO? STACK /?L5
	SET 'WINNER,QCONTEXT
	CALL PERFORM,PRSA,PRSO
	RTRUE
?L5:	CALL ARENT-TALKING >STACK
	RSTACK
?L3:	CALL PERFORM,V?TELL-ABOUT,PRSI,PRSO
	RTRUE

	.FUNCT V-DESCRIBE
	CALL V-FOO >STACK
	RSTACK

	.FUNCT V-UNDRESS
	EQUAL? PRSO,ROOMS,PLAYER \?L1
	ZERO? NOW-WEARING \?L3
	CALL ALREADY,PLAYER,STR?107 >STACK
	RSTACK
?L3:	SET 'PRSO,0
	CALL V-WEAR >STACK
	RSTACK
?L1:	FSET? PRSO,PERSONBIT \?L6
	FSET? PRSO,MUNGBIT \?L7
	SET 'CLOCK-WAIT,1
	PRINTI "(Not in a family story!)"
	CRLF
	CALL PRINT-ID,STR?108 >STACK
	RSTACK
?L7:	CALL FACE-RED >STACK
	RSTACK
?L6:	CALL HAR-HAR >STACK
	RSTACK

	.FUNCT V-DRESS,X
	EQUAL? PRSO,PLAYER,ROOMS \?L1
	ZERO? NOW-WEARING \?L3
	EQUAL? PLAYER,WINNER,PRSO \?L3
	CALL FIND-FLAG,WINNER,WEARBIT >X
	ZERO? X \?L7
	CALL FIND-FLAG,HERE,WEARBIT >X
	ZERO? X /?L5
?L7:	CALL TELL-I-ASSUME,X,STR?109
	CALL PERFORM,V?WEAR,X
	RTRUE
?L5:	SET 'CLOCK-WAIT,1
	PRINTR "(You didn't say what to wear!)"
?L3:	CALL ALREADY,WINNER,STR?110 >STACK
	RSTACK
?L1:	FSET? PRSO,PERSONBIT \?L12
	CALL ALREADY,WINNER,STR?110 >STACK
	RSTACK
?L12:	FSET? PRSO,WEARBIT \?L13
	CALL V-WEAR
	RTRUE
?L13:	CALL FIND-OUTFIT >X
	ZERO? X /?L14
	CALL TELL-I-ASSUME,X
	SET 'PRSO,X
	CALL V-WEAR
	RTRUE
?L14:	CALL HAR-HAR >STACK
	RSTACK

	.FUNCT FIND-OUTFIT,X,?TMP
	CALL FIND-FLAG,WINNER,WEARBIT,NOW-WEARING >?TMP
	ZERO? ?TMP /?L2
	RETURN ?TMP
?L2:	CALL FIND-FLAG-HERE,WEARBIT >?TMP
	ZERO? ?TMP /?L3
	RETURN ?TMP
?L3:	CALL FIND-OUTFIT-IN,LUGGAGE >?TMP
	ZERO? ?TMP /?L4
	RETURN ?TMP
?L4:	CALL FIND-OUTFIT-IN,BED >?TMP
	ZERO? ?TMP /?L5
	RETURN ?TMP
?L5:	CALL FIND-OUTFIT-IN,CHEST-OF-DRAWERS >?TMP
	ZERO? ?TMP /?L6
	RETURN ?TMP
?L6:	CALL FIND-OUTFIT-IN,WARDROBE >STACK
	RSTACK

	.FUNCT FIND-OUTFIT-IN,OBJ,X
	CALL META-LOC,OBJ >STACK
	EQUAL? STACK,HERE \FALSE
	CALL FIND-FLAG,OBJ,WEARBIT >X
	ZERO? X /FALSE
	FSET? OBJ,OPENBIT /?L3
	FSET OBJ,OPENBIT
	CALL FIRST-YOU,STR?84,OBJ
?L3:	RETURN X

	.FUNCT V-CHANGE,X
	EQUAL? PRSO,ROOMS,TWEED-OUTFIT /?L3
	EQUAL? PRSO,EXERCISE-OUTFIT,DINNER-OUTFIT,SLEEP-OUTFIT \?L1
?L3:	CALL FIND-OUTFIT >X
	ZERO? X /?L4
	CALL PERFORM,V?WEAR,X
	RTRUE
?L4:	CALL META-LOC,LUGGAGE >STACK
	EQUAL? STACK,HERE /?L6
	PRINTI "You look around for "
	PRINTD LUGGAGE
	PRINTR " but don't find it."
?L6:	CALL FIND-FLAG,LUGGAGE,WEARBIT >X
	ZERO? X /?L9
	FSET LUGGAGE,OPENBIT
	CALL PERFORM,V?WEAR,X
	RTRUE
?L9:	PRINTR "You can't find anything to change into."
?L1:	CALL YOU-CANT >STACK
	RSTACK

	.FUNCT PRE-DRIVE-TO
	EQUAL? PRSO,CAR /?L1
	CALL DONT-UNDERSTAND >STACK
	RSTACK
?L1:	LOC WINNER >STACK
	EQUAL? STACK,CAR /?L3
	CALL TELL-NOT-IN,CAR
	RTRUE
?L3:	EQUAL? PRSI,INTDIR \?L4
	CALL DO-WALK,P-DIRECTION
	RTRUE
?L4:	CALL PERFORM,V?WALK-TO,PRSI
	RTRUE

	.FUNCT TELL-NOT-IN,OBJ
	SET 'CLOCK-WAIT,1
	PRINTC 40
	CALL HE-SHE-IT,WINNER,1,STR?44
	PRINTI " not in"
	CALL HIM-HER-IT,OBJ
	PRINTR "!)"

	.FUNCT V-DRIVE-TO
	CALL V-FOO >STACK
	RSTACK

	.FUNCT V-DRINK
	CALL YOU-CANT >STACK
	RSTACK

	.FUNCT V-DROP,L,?TMP
	CALL IDROP >STACK
	ZERO? STACK /FALSE
	SET 'L,TABLE-DINING
	IN? L,HERE /?L5
	CALL FIND-FLAG-HERE,VEHBIT,PRSO >L
	ZERO? L /?L3
?L5:	MOVE PRSO,L
	CALL OKAY,PRSO
	PRINTI " is now on"
	CALL PRINTT,L
	PRINTR "."
?L3:	SET '?TMP,PRSO
	CALL GROUND-DESC >STACK
	CALL OKAY,?TMP,STACK >STACK
	RSTACK

	.FUNCT GROUND-DESC
	CALL OUTSIDE?,HERE >STACK
	ZERO? STACK /?L3
	LOC WINNER >STACK
	EQUAL? STACK,CAR \?L1
?L3:	RETURN STR?111
?L1:	RETURN STR?112

	.FUNCT PRE-EAT
	EQUAL? PRSO,0,ROOMS \FALSE
	CALL META-LOC,DINNER >STACK
	EQUAL? STACK,HERE \?L3
	CALL PERFORM,PRSA,DINNER
	RTRUE
?L3:	CALL NOT-HERE,DINNER
	RTRUE

	.FUNCT V-EAT
	PRINTI "It's hard to believe you're that hungry."
	CRLF
	CALL DANGEROUS-FOOD? >STACK
	CALL PRINT-ID,STR?113,STACK
	EQUAL? PRSO,DINNER-2 /?L3
	PUSH 0
	JUMP ?L4
?L3:	PUSH 1
?L4:	CALL PRINT-ID,STR?114,STACK >STACK
	RSTACK

	.FUNCT PRE-EMPTY,?TMP
	EQUAL? PRSO,ROOMS \?L5
	SET '?TMP,HERE
	CALL META-LOC,LUGGAGE >STACK
	EQUAL? ?TMP,STACK \?L3
	SET 'PRSO,LUGGAGE
	JUMP ?L5
?L3:	CALL NOT-HERE,LUGGAGE
	RTRUE
?L5:	EQUAL? PRSO,POND \?L7
	CALL WONT-HELP >STACK
	RSTACK
?L7:	EQUAL? PRSO,WENDISH-KIT,VIVIEN-BOX \?L9
	CALL PRINT-ID,STR?115
	CALL YOU-SHOULDNT >STACK
	RSTACK
?L9:	EQUAL? PRSO,BOTTLE /?L10
	FIRST? PRSO >STACK /?L10
	CALL ALREADY,PRSO,STR?116 >STACK
	RSTACK
?L10:	ZERO? PRSI /?L11
	IN? PRSI,ROOMS /?L11
	FSET? PRSI,CONTBIT /?L11
	CALL TELL-FIND-NONE,STR?117,PRSI
	RETURN 2
?L11:	EQUAL? PRSO,CAR \FALSE
	ZERO? PRSI \FALSE
	LOC CAR >STACK
	CALL PERFORM,PRSA,PRSO,STACK
	RTRUE

	.FUNCT V-EMPTY,?TMP
	FSET? PRSO,CONTBIT \?L1
	CALL HE-SHE-IT,WINNER,1,STR?47
	CALL PRINTT,PRSO
	ZERO? PRSI \?L11
	EQUAL? PRSO,COFFIN /?L7
	CALL FIND-FLAG-HERE,CONTBIT,PRSO >PRSI
	ZERO? PRSI /?L7
	FSET PRSI,OPENBIT
	PRINTI " into"
	CALL PRINTT,PRSI
	JUMP ?L11
?L7:	SET 'PRSI,HERE
	PRINTC 32
	CALL GROUND-DESC >STACK
	PRINT STACK
?L11:	PRINTI "."
	CRLF
	EQUAL? PRSI,HERE /?L17
	CALL WEIGHT,PRSI >?TMP
	CALL WEIGHT,PRSO >STACK
	ADD ?TMP,STACK >?TMP
	GETP PRSI,P?CAPACITY >STACK
	GRTR? ?TMP,STACK \?L17
	PRINT NOT-ENOUGH-ROOM
	RTRUE
?L17:	CALL ROB,PRSO,PRSI
	RTRUE
?L1:	CALL YOU-CANT >STACK
	RSTACK

	.FUNCT PRE-THROUGH
	EQUAL? PRSO,GLOBAL-HERE,ROOMS \?L1
	CALL DO-WALK,P?IN
	RTRUE
?L1:	ZERO? PRSI /FALSE
	EQUAL? PRSO,CAR \?L4
	LOC WINNER >STACK
	EQUAL? STACK,CAR \?L6
	SET 'PRSO,PRSI
	RFALSE
?L6:	CALL TELL-NOT-IN,CAR
	RTRUE
?L4:	CALL DONT-UNDERSTAND >STACK
	RSTACK

	.FUNCT V-THROUGH,RM,DIR
	CALL NOUN-USED?,W?DOOR,W?GATE,W?HOLE >STACK
	ZERO? STACK \?L3
	CALL NOUN-USED?,W?PANEL >STACK
	ZERO? STACK /?L1
?L3:	FSET? PRSO,OPENBIT /?L4
	CALL WALK-THRU-DOOR?,0,PRSO,0 >STACK
	ZERO? STACK /?L1
?L4:	CALL DOOR-ROOM,HERE,PRSO >RM
	ZERO? RM /?L5
	CALL GOTO,RM >STACK
	ZERO? STACK \TRUE
?L5:	CALL V-FOO >STACK
	RSTACK
?L1:	IN? PRSO,ROOMS \?L8
	EQUAL? PRSO,HERE \?L9
	CALL WALK-WITHIN-ROOM
	RTRUE
?L9:	CALL SEE-INTO?,PRSO,0 >STACK
	ZERO? STACK /?L11
	CALL GOTO,PRSO
	RTRUE
?L11:	CALL PERFORM,V?WALK-TO,PRSO
	RTRUE
?L8:	FSET? PRSO,VEHBIT \?L13
	CALL PERFORM,V?BOARD,PRSO >STACK
	RSTACK
?L13:	FSET? PRSO,PERSONBIT \?L14
	CALL HAR-HAR >STACK
	RSTACK
?L14:	FSET? PRSO,TAKEBIT /?L15
	CALL HE-SHE-IT,WINNER,1,STR?118
	PRINTI " into"
	CALL PRINTT,PRSO
	CALL THIS-IS-IT,PRSO
	PRINTI " trying to go through"
	CALL HIM-HER-IT,PRSO
	PRINTR "."
?L15:	CALL HAR-HAR >STACK
	RSTACK

	.FUNCT PRE-EXAMINE
	CALL ROOM-CHECK >STACK
	RSTACK

	.FUNCT V-EXAMINE,TXT=0
	EQUAL? PRSO,PSEUDO-OBJECT /?L3
	CALL NOUN-USED?,W?DOOR,W?PANEL >STACK
	ZERO? STACK /?L1
	CALL GLOBAL-IN?,PRSO,HERE >STACK
	ZERO? STACK /?L1
?L3:	SET 'TXT,1
?L1:	EQUAL? PRSO,INTDIR \?L5
	SET 'CLOCK-WAIT,1
	PRINTR "(If you want to see what's there, go there!)"
?L5:	EQUAL? PRSO,LIGHT-GLOBAL,WALL,TOWER /?L10
	EQUAL? PRSO,OTHER-OUTFIT /?L10
	EQUAL? PRSO,HEAD,HANDS,CASTLE \?L9
?L10:	CALL NOTHING-SPECIAL >STACK
	RSTACK
?L9:	IN? PRSO,GLOBAL-OBJECTS \?L11
	CALL NOT-HERE,PRSO
	RTRUE
?L11:	IN? PRSO,ROOMS \?L12
	ZERO? TXT \?L12
	CALL ROOM-PEEK,PRSO >STACK
	RSTACK
?L12:	CALL META-LOC,PRSO >STACK
	EQUAL? STACK,HERE /?L13
	CALL GLOBAL-IN?,PRSO,HERE >STACK
	ZERO? STACK \?L13
	ZERO? TXT \?L13
	CALL TOO-BAD-BUT,PRSO,STR?119 >STACK
	RSTACK
?L13:	GETP PRSO,P?TEXT >TXT
	ZERO? TXT /?L14
	PRINT TXT
	CRLF
	RTRUE
?L14:	FSET? PRSO,DOORBIT \?L17
	CALL CHECK-DOOR,PRSO >STACK
	RSTACK
?L17:	FSET? PRSO,CONTBIT /?L19
	FSET? PRSO,SURFACEBIT \?L18
?L19:	CALL V-LOOK-INSIDE >STACK
	RSTACK
?L18:	CALL NOTHING-SPECIAL >STACK
	RSTACK

	.FUNCT NOTHING-SPECIAL
	PRINTI "You look over"
	CALL PRINTT,PRSO
	PRINTR " for a minute and find nothing suspicious -- for now."

	.FUNCT GLOBAL-IN?,OBJ1,OBJ2,TBL,VAL=0
	GETPT OBJ2,P?GLOBAL >TBL
	ZERO? TBL /?L1
	PTSIZE TBL >STACK
	DEC 'STACK
	CALL ZMEMQB,OBJ1,TBL,STACK >VAL
?L1:	ZERO? VAL \?L4
	EQUAL? OBJ1,OBJ2 \?L4
	SET 'VAL,1
?L4:	RETURN VAL

	.FUNCT V-FAINT
	CALL HE-SHE-IT,WINNER,1,STR?46
	CALL HIM-HER-IT,WINNER,0,1
	PRINTI " best, but"
	CALL HE-SHE-IT,WINNER,0,STR?44
	PRINTR " too excited."

	.FUNCT V-FILL
	CALL YOU-CANT >STACK
	RSTACK

	.FUNCT PRE-FIND,?TMP
	EQUAL? PRSO,PLAYER-NAME,PLAYER /FALSE
	FSET? PRSO,SECRETBIT \?L3
	FSET? PRSO,SEENBIT /?L3
	CALL NO-FUN >STACK
	RSTACK
?L3:	IN? PRSO,ROOMS \?L4
	EQUAL? PRSO,HERE \?L5
	CALL ALREADY,WINNER,STR?120 >STACK
	RSTACK
?L5:	CALL PERFORM,V?WALK-TO,PRSO
	RTRUE
?L4:	FSET? PRSO,PERSONBIT \FALSE
	CALL META-LOC,WINNER >?TMP
	CALL META-LOC,PRSO >STACK
	EQUAL? ?TMP,STACK \?L9
	FSET? PRSO,NDESCBIT /?L9
	CALL BITE-YOU
	RTRUE
?L9:	CALL FOLLOW-LOC? >STACK
	ZERO? STACK \TRUE
	CALL WHO-KNOWS?,PRSO
	RETURN 2

	.FUNCT BITE-YOU
	PRINTI "If"
	CALL HE-SHE-IT,PRSO
	PRINTI " were any closer,"
	CALL HE-SHE-IT,PRSO
	PRINTR "'d bite you!"

	.FUNCT FAR-AWAY?,L
	GETP HERE,P?LINE >STACK
	ZERO? STACK /TRUE
	EQUAL? L,GLOBAL-OBJECTS /TRUE
	FSET? L,SECRETBIT \?L4
	FSET? L,SEENBIT \TRUE
?L4:	EQUAL? L,YOUR-ROOM \?L5
	EQUAL? HERE,YOUR-BATHROOM /FALSE
?L5:	EQUAL? L,YOUR-BATHROOM \?L6
	EQUAL? HERE,YOUR-ROOM /FALSE
?L6:	GETP L,P?LINE >STACK
	ZERO? STACK /TRUE
	FSET? FRIEND,TOUCHBIT /?L8
	EQUAL? L,CAR,DRIVEWAY,COURTYARD \TRUE
?L8:	EQUAL? HERE,DRIVEWAY \?L12
	EQUAL? L,CAR,DRIVEWAY /FALSE
	GETB LAST-NAME,0 >STACK
	ZERO? STACK /TRUE
?L12:	FSET? HERE,SECRETBIT \?L22
	FSET? L,SECRETBIT \?L17
	FSET? HERE,SECRETBIT /FALSE
?L22:	FSET? L,SECRETBIT \FALSE
?L17:	CALL SEE-INTO?,L,0 >STACK
	ZERO? STACK /TRUE
	RFALSE

	.FUNCT V-FIND,L
	LOC PRSO >L
	EQUAL? PRSO,PLAYER \?L1
	PRINTI "You're right here, "
	CALL TELL-LOCATION
	CRLF
	RTRUE
?L1:	EQUAL? PRSO,HANDS,HEAD \?L5
	CALL BITE-YOU >STACK
	RSTACK
?L5:	CALL HELD?,PRSO >STACK
	ZERO? STACK /?L6
	PRINTR "You have it."
?L6:	FSET? PRSO,SECRETBIT /?L10
	EQUAL? PRSO,ARTIFACT \?L9
?L10:	CALL NO-FUN >STACK
	RSTACK
?L9:	CALL VISIBLE?,PRSO >STACK
	ZERO? STACK /?L11
	FSET? PRSO,SECRETBIT \?L12
	CALL DISCOVER,PRSO >STACK
	RSTACK
?L12:	PRINTR "It's right here."
?L11:	FSET? PRSO,SEENBIT /?L17
	CALL NOT-HERE,PRSO,1 >STACK
	RSTACK
?L17:	EQUAL? L,GLOBAL-OBJECTS,LOCAL-GLOBALS \?L18
	PRINTR "It's around somewhere."
?L18:	CALL META-LOC,PRSO >STACK
	CALL FAR-AWAY?,STACK >STACK
	ZERO? STACK /?L21
	PRINTR "It's far away from here."
?L21:	FSET? L,PERSONBIT \?L24
	CALL THIS-IS-IT,L
	CALL START-SENTENCE,L
	PRINTR " probably has it."
?L24:	FSET? L,SURFACEBIT /?L28
	FSET? L,CONTBIT /?L28
	IN? L,ROOMS \?L27
?L28:	CALL THIS-IS-IT,L
	PRINTI "It's probably "
	FSET? L,SURFACEBIT \?L31
	PRINTI "on"
	JUMP ?L35
?L31:	PRINTI "in"
?L35:	CALL PRINTT,L
	PRINTR "."
?L27:	PRINTR "It's nowhere in particular."

	.FUNCT NO-FUN
	SET 'CLOCK-WAIT,1
	PRINTR "(If it's that easy, it spoils the fun!)"

	.FUNCT TELL-LOCATION,DIR
	IN? PLAYER,HERE /?L1
	PRINTI "sitting "
?L1:	FSET? HERE,SURFACEBIT \?L6
	PRINTI "on"
	JUMP ?L10
?L6:	PRINTI "in"
?L10:	CALL PRINTT,HERE
	PRINTI "."
	RTRUE

	.FUNCT V-FIX
	CALL MORE-SPECIFIC >STACK
	RSTACK

	.FUNCT FOLLOW-LOC?,L
	GETP PRSO,P?CHARACTER >L
	GET FOLLOW-LOC,L >L
	ZERO? L /FALSE
	PRINTI "The last you knew,"
	CALL HE-SHE-IT,PRSO
	PRINTI " was "
	FSET? L,SURFACEBIT \?L5
	PRINTI "on"
	JUMP ?L9
?L5:	PRINTI "in"
?L9:	GETP PRSO,P?CHARACTER >STACK
	CALL TELL-HIS-HER-BEDROOM,STACK,L
	PRINTI ".
"
	RETURN L

	.FUNCT V-FOLLOW,L,?TMP
	EQUAL? PRSO,WINNER \?L1
	CALL YOU-CANT >STACK
	RSTACK
?L1:	EQUAL? PRSO,GHOST-NEW /?L3
	FSET? PRSO,PERSONBIT /?L3
	PRINTI "How tragic to see you, a"
	PRINT FAMOUS-YOUNG-DETECTIVE
	PRINTI ", stalking "
	CALL PRINTA,PRSO
	PRINTR "!"
?L3:	SET '?TMP,HERE
	CALL META-LOC,PRSO >L
	EQUAL? ?TMP,L \?L6
	PRINTI "You're in the same place as"
	CALL HE-SHE-IT,PRSO
	PRINTR "!"
?L6:	GETP PRSO,P?CHARACTER >STACK
	GET FOLLOW-LOC,STACK >L
	ZERO? L /?L9
	CALL PERFORM,V?WALK-TO,L >STACK
	RSTACK
?L9:	CALL WHO-KNOWS?,PRSO
	RETURN 2

	.FUNCT V-FOO
	PRINTR "[Foo!! This is a bug!!]"

	.FUNCT V-FORGIVE
	CALL YOU-CANT >STACK
	RSTACK

	.FUNCT PRE-GIVE
	EQUAL? PRSI,PLAYER,PLAYER-NAME /FALSE
	CALL NOT-HOLDING?,PRSO >STACK
	ZERO? STACK \TRUE
	RFALSE

	.FUNCT V-GIVE
	ZERO? PRSI \?L1
	CALL YOU-CANT >STACK
	RSTACK
?L1:	FSET? PRSI,PERSONBIT /?L3
	CALL HE-SHE-IT,WINNER,1
	PRINTI " can't give "
	CALL PRINTA,PRSO
	PRINTI " to "
	CALL PRINTA,PRSI
	PRINTR "!"
?L3:	EQUAL? PRSI,PLAYER \?L6
	CALL PERFORM,V?TAKE,PRSO
	RTRUE
?L6:	EQUAL? PRSO,LUGGAGE \?L7
	FIRST? PRSO >STACK \?L7
	FSET? YOUR-ROOM,TOUCHBIT \?L7
	CALL HE-SHE-IT,PRSI,1,STR?121
	PRINTR " your gift."
?L7:	MOVE PRSO,PRSI
	CALL HE-SHE-IT,PRSI,1,STR?122
	PRINTI " your gift."
	CRLF
	CALL TREASURE-FOUND?,PRSO,PRSI
	GETP PRSI,P?CHARACTER >STACK
	EQUAL? VARIATION,STACK \TRUE
	FSET? PRSO,RMUNGBIT /?L15
	EQUAL? PRSO,BLOWGUN,COSTUME \TRUE
?L15:	SET 'WINNER,PLAYER
	CALL PERFORM,V?ASK-ABOUT,PRSI,PRSO
	RTRUE

	.FUNCT PRE-SGIVE,X
	GET P-NAMW,0 >X
	GET P-NAMW,1 >STACK
	PUT P-NAMW,0,STACK
	PUT P-NAMW,1,X
	CALL PERFORM,V?GIVE,PRSI,PRSO
	RTRUE

	.FUNCT V-SGIVE
	CALL V-FOO >STACK
	RSTACK

	.FUNCT PRE-HELLO,P,WORD=0
	EQUAL? P-PRSA-WORD,W?HELLO,W?HI \?L1
	SET 'WORD,STR?123
	JUMP ?L3
?L1:	EQUAL? P-PRSA-WORD,W?SORRY \?L3
	SET 'WORD,STR?124
?L3:	EQUAL? PRSO,ROOMS /?L5
	FSET? PRSO,PERSONBIT /?L7
	EQUAL? PRSO,CREW-GLOBAL /?L7
	CALL WONT-HELP-TO-TALK-TO,PRSO
	RTRUE
?L7:	FSET? PRSO,MUNGBIT \?L9
	CALL PERFORM,V?ALARM,PRSO
	RTRUE
?L9:	ZERO? WORD /FALSE
	PRINT I-ASSUME
	PRINT WORD
	CALL HIM-HER-IT,PRSO
	PRINTI ".]"
	CRLF
	RFALSE
?L5:	CALL QCONTEXT-GOOD? >STACK
	ZERO? STACK /?L16
	PRINT I-ASSUME
	PRINTC 32
	PRINTD QCONTEXT
	PRINTI ".]"
	CRLF
	CALL PERFORM,PRSA,QCONTEXT
	RTRUE
?L16:	EQUAL? WINNER,PLAYER \?L21
	CALL FIND-FLAG-HERE-NOT,PERSONBIT,MUNGBIT,WINNER >P
	ZERO? P /?L21
	PRINT I-ASSUME
	PRINTC 32
	PRINTD P
	PRINTI ".]"
	CRLF
	CALL PERFORM,PRSA,P
	RTRUE
?L21:	CALL NOT-CLEAR-WHOM >STACK
	RSTACK

	.FUNCT V-HELLO
	FSET? PRSO,PERSONBIT \?L1
	FSET? PRSO,MUNGBIT /?L3
	ZERO? LIT \?L5
	PRINTR """Hello."""
?L5:	CALL HE-SHE-IT,PRSO,1,STR?125
	PRINTR " at you."
?L3:	CALL WONT-HELP-TO-TALK-TO,PRSO >STACK
	RSTACK
?L1:	CALL NOT-CLEAR-WHOM >STACK
	RSTACK

	.FUNCT V-HELP
	EQUAL? PRSO,0,PLAYER \?L1
	CALL HELP-TEXT >STACK
	RSTACK
?L1:	CALL MORE-SPECIFIC >STACK
	RSTACK

	.FUNCT HELP-TEXT
	SET 'CLOCK-WAIT,1
	PRINTI "[You'll find plenty of help in your "
	PRINTD MOONMIST
	PRINTR " package.
If you're really stuck, you can order an InvisiClues (TM) hint booklet and map from your dealer or via mail with the form in your package.]"

	.FUNCT V-KILL
	CALL IS-PERSON? >STACK
	CALL PRINT-ID,STR?126,STACK
	CALL IS-OBJECT-OR-PROPERTY? >STACK
	CALL PRINT-ID,STR?127,STACK
	CALL IS-SELF? >STACK
	CALL PRINT-ID,STR?128,STACK
	CALL IKILL,STR?129 >STACK
	RSTACK

	.FUNCT IKILL,STR=0
	ZERO? PRSO \?L1
	SET 'CLOCK-WAIT,1
	PRINTI "(There's nothing here to "
	PRINT STR
	PRINTI ".)"
	CRLF
	CALL PRINT-ID,STR?130 >STACK
	RSTACK
?L1:	ZERO? PRSI \?L5
	SET 'CLOCK-WAIT,1
	PRINT YOU-DIDNT-SAY-W
	PRINTI "hat to "
	PRINT STR
	CALL PRINTT,PRSO
	CALL PRINT-ID,STR?131
	FSET? PRSO,WEAPONBIT \?L8
	PRINTI " at"
	JUMP ?L12
?L8:	PRINTI " with"
?L12:	PRINTR ".]"
?L5:	FSET? PRSO,PERSONBIT /?L17
	CALL HAR-HAR >STACK
	RSTACK
?L17:	PRINT NO-VIOLENCE
	RTRUE

	.FUNCT V-KISS,X
	EQUAL? PRSO,PLAYER \?L1
	PRINTI "You kiss "
	PRINTD PLAYER
	PRINTR " for a minute. Yuk!"
?L1:	FSET? PRSO,PERSONBIT \?L5
	FSET? PRSO,MUNGBIT /?L5
	CALL FACE-RED >STACK
	RSTACK
?L5:	PRINTR "What a (ahem!) strange idea!"

	.FUNCT V-KNOCK,P
	FSET? PRSO,DOORBIT \?L1
	FSET? PRSO,OPENBIT \?L3
	PRINTR "It's open!"
?L3:	CALL DOOR-ROOM,HERE,PRSO >P
	ZERO? P /?L7
	CALL FIND-FLAG,P,PERSONBIT,PLAYER >P
	ZERO? P /?L7
	FCLEAR PRSO,LOCKED
	FSET PRSO,OPENBIT
	FSET PRSO,ONBIT
	CALL UNSNOOZE,P
	CALL THIS-IS-IT,P
	CALL HE-SHE-IT,P,1
	PRINTR " opens the door, then retreats into the room."
?L7:	PRINTR "There's no answer."
?L1:	SET 'CLOCK-WAIT,1
	PRINTI "(Why knock on "
	CALL PRINTA,PRSO
	PRINTR "?)"

	.FUNCT V-STAND,P
	EQUAL? WINNER,PLAYER \?L1
	IN? PLAYER,HERE /?L1
	CALL OWN-FEET >STACK
	RSTACK
?L1:	CALL ALREADY,WINNER,STR?132 >STACK
	RSTACK

	.FUNCT V-LEAP
	EQUAL? PRSO,0,INTDIR /?L1
	CALL YOU-CANT
	RTRUE
?L1:	EQUAL? HERE,DECK,LOVER-PATH \?L3
	PRINTI "This was not a very safe place to try jumping.[RWD_ID: verbs:2532, VAL: -5]"
	CALL PRINT-ID,STR?133
	CALL FINISH >STACK
	RSTACK
?L3:	CALL V-SKIP >STACK
	RSTACK

	.FUNCT V-SKIP
	CALL WHEE >STACK
	RSTACK

	.FUNCT WHEE,X
	RANDOM 5 >X
	EQUAL? 1,X \?L1
	PRINTR "Very good. Now you can go to the second grade."
?L1:	EQUAL? 2,X \?L5
	PRINTR "I hope you enjoyed that more than I did."
?L5:	EQUAL? 3,X \?L8
	PRINTI "Are you enjoying "
	PRINTD PLAYER
	PRINTR "?"
?L8:	EQUAL? 4,X \?L11
	PRINTR "Wheeeeeeeeee!!!!!"
?L11:	PRINTR "Do you expect someone to applaud?"

	.FUNCT V-LEAVE,GT
	EQUAL? WINNER,FOLLOWER \?L1
	SET 'FOLLOWER,0
?L1:	EQUAL? PRSO,ROOMS,HERE,GLOBAL-HERE \?L4
	CALL DO-WALK,P?OUT
	PUTP WINNER,P?LDESC,9
	EQUAL? WINNER,FRIEND \TRUE
	EQUAL? VARIATION,FRIEND-C /TRUE
	GET GOAL-TABLES,FRIEND-C >GT
	LESS? BED-TIME,PRESENT-TIME \?L8
	EQUAL? HERE,TAMARA-ROOM /TRUE
	PUT GT,GOAL-FUNCTION,X-RETIRES
	CALL ESTABLISH-GOAL,FRIEND,TAMARA-ROOM
	RTRUE
?L8:	PUT GT,GOAL-FUNCTION,NULL-F
	IN? LORD,HERE /TRUE
	LOC LORD >STACK
	CALL ESTABLISH-GOAL,FRIEND,STACK
	RTRUE
?L4:	LOC PRSO >STACK
	EQUAL? STACK,PLAYER \?L18
	CALL PERFORM,V?DROP,PRSO
	RTRUE
?L18:	LOC WINNER >STACK
	EQUAL? STACK,PRSO /?L19
	CALL TELL-NOT-IN,PRSO
	RETURN 2
?L19:	CALL DO-WALK,P?OUT
	RTRUE

	.FUNCT PRE-LIE
	CALL ROOM-CHECK >STACK
	RSTACK

	.FUNCT V-LIE
	CALL V-SIT,1 >STACK
	RSTACK

	.FUNCT PRE-LISTEN
	FSET? PRSO,PERSONBIT \?L1
	GETP PRSO,P?LDESC >STACK
	EQUAL? STACK,22 \?L1
	CALL PERFORM,V?LISTEN,PIANO
	RTRUE
?L1:	CALL PRE-ASK-ABOUT >STACK
	RSTACK

	.FUNCT V-LISTEN
	FSET? PRSO,PERSONBIT \?L1
	FSET? PRSO,MUNGBIT /?L1
	CALL WAITING-FOR-YOU-TO-SPEAK
	RTRUE
?L1:	CALL TOO-BAD-BUT,PRSO
	PRINTR " makes no sound."

	.FUNCT V-LOCK
	FSET? PRSO,DOORBIT \?L1
	EQUAL? PRSO,HERE \?L3
	CALL OKAY,PRSO,STR?85 >STACK
	RSTACK
?L3:	CALL TELL-FIND-NONE,STR?134,PRSO >STACK
	RSTACK
?L1:	CALL YOU-CANT >STACK
	RSTACK

	.FUNCT V-LOOK
	CALL DESCRIBE-ROOM,1 >STACK
	ZERO? STACK /FALSE
	CALL DESCRIBE-OBJECTS >STACK
	RSTACK

	.FUNCT V-LOOK-BEHIND
	FSET? PRSO,DOORBIT \?L1
	FSET? PRSO,OPENBIT /?L1
	CALL TOO-BAD-BUT,PRSO,STR?79 >STACK
	RSTACK
?L1:	PRINTI "There's nothing behind"
	CALL HIM-HER-IT,PRSO
	PRINTR "."

	.FUNCT V-LOOK-DOWN
	EQUAL? PRSO,ROOMS \?L1
	PRINTI "You see nothing suspicious "
	CALL GROUND-DESC >STACK
	PRINT STACK
	PRINTR "."
?L1:	CALL HAR-HAR >STACK
	RSTACK

	.FUNCT PRE-LOOK-INSIDE
	CALL ROOM-CHECK >STACK
	RSTACK

	.FUNCT V-LOOK-INSIDE,DIR=P?IN,RM
	EQUAL? PRSO,ROOMS \?L9
	EQUAL? DIR,P?OUT \?L3
	CALL GLOBAL-IN?,WINDOW,HERE >STACK
	ZERO? STACK /?L9
	CALL PERFORM,PRSA,WINDOW,PRSI
	RTRUE
?L3:	SET 'RM,P-IT-OBJECT
	FSET? RM,CONTBIT /?L11
	CALL FIND-FLAG-LG,HERE,CONTBIT >RM
	ZERO? RM \?L11
	SET 'RM,WINDOW
	CALL GLOBAL-IN?,RM,HERE >STACK
	ZERO? STACK \?L11
	CALL FIND-FLAG-LG,HERE,DOORBIT >RM
	ZERO? RM /?L9
?L11:	CALL TELL-I-ASSUME,RM
	CALL PERFORM,PRSA,RM,PRSI
	RTRUE
?L9:	EQUAL? PRSO,GLOBAL-HERE \?L14
	CALL PERFORM,V?LOOK
	RTRUE
?L14:	IN? PRSO,ROOMS \?L16
	CALL NOUN-USED?,W?DOOR >STACK
	ZERO? STACK \?L16
	CALL GLOBAL-IN?,PRSO,HERE >STACK
	ZERO? STACK \?L17
	CALL SEE-INTO?,PRSO,0 >STACK
	ZERO? STACK /?L16
?L17:	CALL ROOM-PEEK,PRSO >STACK
	RSTACK
?L16:	CALL V-LOOK-THROUGH,1 >STACK
	ZERO? STACK \TRUE
	FSET? PRSO,CONTBIT /?L20
	FSET? PRSO,SURFACEBIT \?L19
?L20:	CALL SEE-INSIDE?,PRSO,1 >STACK
	ZERO? STACK \?L21
	CALL FIRST-YOU,STR?84,PRSO
?L21:	FIRST? PRSO >STACK \?L24
	PRINTI "You can see"
	CALL PRINT-CONTENTS,PRSO
	FSET? PRSO,SURFACEBIT \?L28
	PRINTI " on"
	JUMP ?L32
?L28:	PRINTI " inside"
?L32:	CALL HIM-HER-IT,PRSO
	PRINTR "."
?L24:	EQUAL? PRSO,SIDEBOARD,CHAIR-DINING,TABLE-DINING /?L38
	EQUAL? PRSO,PIANO,WYVERN /?L38
	EQUAL? PRSO,COAT-RACK,WRITING-DESK,VICTORIA-CHAIR \?L37
?L38:	CALL TELL-LIKE-BROCHURE >STACK
	RSTACK
?L37:	FSET? PRSO,SURFACEBIT \?L39
	PRINTI "There's nothing on"
	CALL HIM-HER-IT,PRSO
	IN? PLAYER,PRSO \?L42
	PRINTI " except you"
?L42:	PRINTR "."
?L39:	CALL TOO-BAD-BUT,PRSO,STR?116 >STACK
	RSTACK
?L19:	EQUAL? DIR,P?IN \?L50
	CALL YOU-CANT,STR?135 >STACK
	RSTACK
?L50:	CALL YOU-CANT,STR?136 >STACK
	RSTACK

	.FUNCT FIRST-YOU,STR,OBJ=0,OBJ2=0
	PRINTC 40
	CALL HE-SHE-IT,WINNER,1,STR
	ZERO? OBJ /?L10
	CALL PRINTT,OBJ
	EQUAL? STR,STR?84 \?L7
	FSET OBJ,OPENBIT
?L7:	ZERO? OBJ2 /?L10
	PRINTI " from"
	CALL PRINTT,OBJ2
?L10:	PRINTR " first.)"

	.FUNCT V-LOOK-THROUGH,INSIDE=0,RM
	FSET? PRSO,DOORBIT \?L1
	FSET? PRSO,OPENBIT /?L5
	FSET? PRSO,TRANSBIT \?L3
?L5:	CALL DOOR-ROOM,HERE,PRSO >RM
	ZERO? RM /?L6
	CALL ROOM-PEEK,RM,1 >STACK
	RSTACK
?L6:	CALL NO-BEYOND >STACK
	RSTACK
?L3:	CALL ZMEMQ,PRSO,CHAR-ROOM-TABLE >STACK
	ZERO? STACK /?L9
	CALL PERFORM,PRSA,KEYHOLE
	RTRUE
?L9:	CALL TOO-BAD-BUT,PRSO,STR?79 >STACK
	RSTACK
?L1:	EQUAL? PRSO,WINDOW \?L11
	CALL NO-BEYOND >STACK
	RSTACK
?L11:	FSET? PRSO,PERSONBIT \?L14
	PRINTR "You forgot to bring your X-ray glasses."
?L14:	ZERO? INSIDE \FALSE
	FSET? PRSO,TRANSBIT \?L18
	PRINTR "Everything looks bigger."
?L18:	CALL YOU-CANT,STR?137 >STACK
	RSTACK

	.FUNCT NO-BEYOND
	PRINTI "You can't tell what's beyond"
	CALL HIM-HER-IT,PRSO
	PRINTR "."

	.FUNCT ROOM-PEEK,RM,SAFE=0,X=0,OHERE?1,OLIT,TXT
	EQUAL? RM,HERE \?L1
	CALL V-LOOK
	RTRUE
?L1:	ZERO? SAFE \?L4
	CALL SEE-INTO?,RM >STACK
	ZERO? STACK /FALSE
?L4:	SET 'OHERE?1,HERE
	SET 'OLIT,LIT
	SET 'HERE,RM
	CALL MAKE-ALL-PEOPLE,-12
	CALL LIT? >LIT
	PRINTI "You peer "
	FSET? RM,SURFACEBIT \?L7
	PRINTI "at"
	JUMP ?L11
?L7:	PRINTI "into"
?L11:	CALL HIM-HER-IT,RM
	PRINTC 58
	CRLF
	CALL DESCRIBE-OBJECTS >STACK
	ZERO? STACK /?L16
	SET 'X,1
	JUMP ?L18
?L16:	GETP RM,P?LDESC >TXT
	ZERO? TXT /?L18
	SET 'X,1
	PRINT TXT
	CRLF
?L18:	ZERO? X \?L22
	PRINTI "You can't see anything suspicious."
	CRLF
?L22:	SET 'HERE,OHERE?1
	SET 'LIT,OLIT
	RTRUE

	.FUNCT SEE-INTO?,THERE,TELL?=1,IGNORE-DOOR=0,P,L,TBL,O
	CALL CORRIDOR-LOOK,THERE >STACK
	ZERO? STACK \TRUE
	SET 'P,0
?L4:	NEXTP HERE,P >P
	ZERO? P /?L8
	LESS? P,P?OUT \?L6
?L8:	ZERO? TELL? /FALSE
	CALL TELL-CANT-FIND
	RFALSE
?L6:	GETPT HERE,P >TBL
	PTSIZE TBL >L
	EQUAL? L,UEXIT \?L13
	GETB TBL,REXIT >STACK
	EQUAL? STACK,THERE \?L4
	RTRUE
?L13:	EQUAL? L,DEXIT \?L18
	GETB TBL,REXIT >STACK
	EQUAL? STACK,THERE \?L4
	GETB TBL,DEXITOBJ >STACK
	FSET? STACK,OPENBIT /TRUE
	GETB TBL,DEXITOBJ >STACK
	CALL WALK-THRU-DOOR?,TBL,STACK,0 >STACK
	ZERO? STACK \TRUE
	ZERO? IGNORE-DOOR \TRUE
	ZERO? TELL? /FALSE
	SET 'CLOCK-WAIT,1
	PRINTI "(The door to that room is closed.)"
	CRLF
	RFALSE
?L18:	EQUAL? L,CEXIT \?L4
	GETB TBL,REXIT >STACK
	EQUAL? STACK,THERE \?L4
	GETB TBL,CEXITFLAG >STACK
	VALUE STACK >STACK
	ZERO? STACK \TRUE
	ZERO? TELL? /FALSE
	CALL TELL-CANT-FIND
	RFALSE

	.FUNCT TELL-CANT-FIND
	SET 'CLOCK-WAIT,1
	PRINTR "(That place isn't close enough.)"

	.FUNCT V-LOOK-ON
	FSET? PRSO,SURFACEBIT \?L1
	CALL V-LOOK-INSIDE >STACK
	RSTACK
?L1:	PRINTI "There's no good surface on"
	CALL HIM-HER-IT,PRSO
	PRINTR "."

	.FUNCT V-LOOK-OUTSIDE
	CALL V-LOOK-INSIDE,P?OUT >STACK
	RSTACK

	.FUNCT PRE-LOOK-UNDER
	CALL ROOM-CHECK >STACK
	RSTACK

	.FUNCT V-LOOK-UNDER
	EQUAL? PRSO,HEAD,HANDS,EYE \?L1
	CALL WONT-HELP >STACK
	RSTACK
?L1:	CALL HELD?,PRSO >STACK
	ZERO? STACK /?L3
	PRINTI "You're "
	FSET? PRSO,WORNBIT \?L6
	PRINTI "wear"
	JUMP ?L10
?L6:	PRINTI "hold"
?L10:	PRINTI "ing"
	CALL PRINTT,PRSO
	PRINTR "!"
?L3:	FSET? PRSO,PERSONBIT \?L15
	PRINTI "Nope. Nothing hiding under"
	CALL HIM-HER-IT,PRSO
	PRINTR "."
?L15:	LOC PRSO >STACK
	EQUAL? STACK,VIVIEN-BOX,WENDISH-KIT \?L18
	PRINTR "There's more stuff there."
?L18:	LOC PRSO >STACK
	EQUAL? STACK,HERE,LOCAL-GLOBALS \?L21
	PRINTR "There's nothing there but dust."
?L21:	PRINTR "That's not a bit useful."

	.FUNCT V-LOOK-UP,HR
	ZERO? PRSI /?L1
	PRINTI "There's no information in"
	CALL PRINTT,PRSI
	PRINTI " about"
	CALL PRINTT,PRSO
	PRINTR "."
?L1:	EQUAL? PRSO,ROOMS \?L5
	CALL OUTSIDE?,HERE >STACK
	ZERO? STACK /?L6
	CALL PERFORM,V?EXAMINE,MOON
	RTRUE
?L6:	CALL CREEPY?,HERE >STACK
	ZERO? STACK /?L8
	PRINTI "Shadows play on the stone ceiling"
	EQUAL? HERE,SITTING-PASSAGE \?L11
	PRINTI " and"
	CALL PRINTT,SECRET-SITTING-DOOR
?L11:	PRINTR "."
?L8:	PRINTI "The ceiling is decorated with swirly lines and patterns."
	EQUAL? HERE,TAMARA-ROOM \?L21
	GETP LUMBER-ROOM,P?CORRIDOR >STACK
	ZERO? STACK /?L21
	PRINTI " There's a hole directly over the bed."
?L21:	CRLF
	RTRUE
?L5:	CALL YOU-CANT,STR?138 >STACK
	RSTACK

	.FUNCT PRE-MEET
	IN? PRSO,HERE \?L1
	CALL PERFORM,V?HELLO,PRSO
	RTRUE
?L1:	CALL PERFORM,V?WALK-TO,PRSO
	RTRUE

	.FUNCT V-MEET
	CALL V-FOO >STACK
	RSTACK

	.FUNCT PRE-MOVE
	CALL HELD?,PRSO >STACK
	ZERO? STACK /FALSE
	PRINTR "Juggling isn't one of your talents."

	.FUNCT V-MOVE
	FSET? PRSO,TAKEBIT \?L1
	PRINTI "Moving"
	CALL HIM-HER-IT,PRSO
	PRINTR " reveals nothing."
?L1:	CALL YOU-CANT >STACK
	RSTACK

	.FUNCT PRE-MOVE-DIR
	EQUAL? PRSI,INTDIR /FALSE
	CALL DONT-UNDERSTAND
	RTRUE

	.FUNCT V-MOVE-DIR
	PRINTI "You can't move"
	CALL HIM-HER-IT,PRSO
	PRINTI " in any particular "
	PRINTD INTDIR
	PRINTR "."

	.FUNCT V-NOD
	EQUAL? PRSO,ROOMS /?L1
	CALL YOU-CANT >STACK
	RSTACK
?L1:	ZERO? AWAITING-REPLY /?L3
	CALL PERFORM,V?YES
	RTRUE
?L3:	CALL PERFORM,V?HELLO,ROOMS
	RTRUE

	.FUNCT V-OPEN,F,STR
	FSET? PRSO,CONTBIT /?L1
	FSET? PRSO,DOORBIT /?L4
	EQUAL? PRSO,WINDOW /?L1
	CALL YOU-CANT >STACK
	RSTACK
?L1:	FSET? PRSO,DOORBIT /?L4
	EQUAL? PRSO,WINDOW /?L4
	GETP PRSO,P?CAPACITY >STACK
	ZERO? STACK /?L3
?L4:	FSET? PRSO,LOCKED \?L9
	CALL UNLOCK-DOOR?,PRSO >STACK
	ZERO? STACK /?L7
	FCLEAR PRSO,LOCKED
	CALL FIRST-YOU,STR?139,PRSO
	JUMP ?L9
?L7:	CALL TOO-BAD-BUT,PRSO,STR?85
	RTRUE
?L9:	FSET? PRSO,OPENBIT \?L11
	CALL ALREADY,PRSO,STR?84 >STACK
	RSTACK
?L11:	FSET PRSO,OPENBIT
	FSET? PRSO,DOORBIT /?L16
	EQUAL? PRSO,WINDOW /?L16
	FIRST? PRSO >STACK \?L16
	FSET? PRSO,TRANSBIT \?L14
?L16:	CALL OKAY,PRSO,STR?84 >STACK
	RSTACK
?L14:	PRINTI "You open"
	CALL HIM-HER-IT,PRSO
	PRINTI " and see"
	CALL PRINT-CONTENTS,PRSO
	PRINTR "."
?L3:	CALL YOU-CANT >STACK
	RSTACK

	.FUNCT PRE-OPEN-WITH
	CALL NOT-HOLDING?,PRSI >STACK
	ZERO? STACK \TRUE
	RFALSE

	.FUNCT V-OPEN-WITH
	CALL PERFORM,V?OPEN,PRSO
	RTRUE

	.FUNCT V-PLAY
	SET 'CLOCK-WAIT,1
	PRINTR "[Speaking of playing, you'd enjoy Infocom's other fictions, too!]"

	.FUNCT V-POUR
	CALL YOU-CANT >STACK
	RSTACK

	.FUNCT V-PRAY
	PRINTR """From ghoulies and ghosties and long-leggety beasties
And things that go bump in the night, Good Lord, deliver us!"""

	.FUNCT V-PUSH
	CALL HACK-HACK,STR?140 >STACK
	RSTACK

	.FUNCT WEAR-CHECK,X
	EQUAL? NOW-WEARING,PRSO \FALSE
	CALL NOUN-USED?,W?CLOTHES >STACK
	ZERO? STACK /?L3
	CALL FIND-OUTFIT >X
	ZERO? X /?L3
	CALL TELL-I-ASSUME,X
	SET 'PRSO,X
	RFALSE
?L3:	CALL YOU-CANT,0,0,STR?141
	RTRUE

	.FUNCT PRE-PUT
	CALL WEAR-CHECK >STACK
	ZERO? STACK \TRUE
	FCLEAR PRSO,WORNBIT
	EQUAL? PRSO,OTHER-OUTFIT,HANDS,HEAD \?L4
	CALL WONT-HELP
	RTRUE
?L4:	IN? PRSO,GLOBAL-OBJECTS \?L6
	CALL NOT-HERE,PRSO
	RTRUE
?L6:	EQUAL? PRSI,GLOBAL-HERE,FLOOR /FALSE
	IN? PRSI,GLOBAL-OBJECTS \FALSE
	CALL NOT-HERE,PRSI
	RTRUE

	.FUNCT V-PUT
	FSET? PRSI,PERSONBIT \?L1
	SET 'WINNER,PRSI
	CALL PERFORM,V?WEAR,PRSO
	RTRUE
?L1:	FSET? PRSI,SURFACEBIT /?L3
	EQUAL? PRSI,BOOKCASE /?L3
	FSET? PRSI,VEHBIT /?L3
	PRINTI "There's no good surface on"
	CALL HIM-HER-IT,PRSI
	PRINTR "."
?L3:	CALL PUT-ON-OR-IN >STACK
	RSTACK

	.FUNCT TELL-FIND-NONE,STR,OBJ=0
	PRINTI "You search for "
	PRINT STR
	ZERO? OBJ /?L3
	CALL PRINTT,OBJ
?L3:	PRINTR " but find none."

	.FUNCT PRE-PUT-IN
	GET P-OFW,1 >STACK
	EQUAL? STACK,W?FRONT \?L1
	CALL PERFORM,V?DROP,PRSO
	RTRUE
?L1:	EQUAL? PRSI,PSEUDO-OBJECT /?L4
	EQUAL? PRSI,FIREPLACE,EARRING,CHAIR \?L3
?L4:	CALL PRE-PUT >STACK
	RSTACK
?L3:	EQUAL? PRSI,MOONMIST,INKWELL \?L5
	CALL PRINT-ID,STR?142
	CALL YOU-SHOULDNT,STR?143
	RETURN 2
?L5:	EQUAL? PRSI,PEEPHOLE-2,PEEPHOLE,OCEAN /?L9
	EQUAL? PRSI,HOLE-IN-WALL,HANDS,EYE \?L8
?L9:	CALL WONT-HELP
	RETURN 2
?L8:	FSET? PRSI,READBIT \?L12
	CALL WONT-HELP
	RETURN 2
?L12:	FSET? PRSI,CONTBIT /?L15
	CALL TELL-FIND-NONE,STR?117,PRSI
	RETURN 2
?L15:	FSET? PRSI,OPENBIT /?L19
	CALL FIRST-YOU,STR?84,PRSI
?L19:	CALL PRE-PUT >STACK
	RSTACK

	.FUNCT V-PUT-IN
	FSET? PRSI,OPENBIT /?L1
	FSET? PRSI,VEHBIT /?L1
	FSET? PRSI,DOORBIT /?L5
	FSET? PRSI,CONTBIT \?L3
?L5:	CALL TOO-BAD-BUT,PRSI,STR?79
	RTRUE
?L3:	PRINTI "You can't open"
	CALL HIM-HER-IT,PRSI
	PRINTR "."
?L1:	CALL PUT-ON-OR-IN >STACK
	RSTACK

	.FUNCT PUT-ON-OR-IN,?TMP
	ZERO? PRSI \?L1
	CALL YOU-CANT >STACK
	RSTACK
?L1:	EQUAL? PRSI,PRSO \?L3
	CALL HAR-HAR >STACK
	RSTACK
?L3:	IN? PRSO,PRSI \?L4
	CALL TOO-BAD-BUT,PRSO
	PRINTI " is already "
	FSET? PRSI,SURFACEBIT \?L7
	PUSH STR?82
	JUMP ?L9
?L7:	PUSH STR?144
?L9:	PRINT STACK
	CALL HIM-HER-IT,PRSI
	PRINTR "!"
?L4:	CALL WEIGHT,PRSI >?TMP
	GETP PRSO,P?SIZE >STACK
	ADD ?TMP,STACK >?TMP
	GETP PRSI,P?CAPACITY >STACK
	GRTR? ?TMP,STACK \?L10
	PRINT NOT-ENOUGH-ROOM
	RTRUE
?L10:	CALL HELD?,PRSO >STACK
	ZERO? STACK \?L13
	CALL ITAKE >STACK
	ZERO? STACK /TRUE
?L13:	MOVE PRSO,PRSI
	FSET PRSO,TOUCHBIT
	FSET? PRSI,PERSONBIT \?L15
	FSET? PRSO,WEARBIT \?L15
	FSET PRSO,WORNBIT
?L15:	PRINTR "Okay."

	.FUNCT WEIGHT,OBJ,CONT,WT=0
	FIRST? OBJ >CONT \?L4
?L3:	GETP CONT,P?SIZE >STACK
	ADD WT,STACK >WT
	NEXT? CONT >CONT /?L3
?L4:	RETURN WT

	.FUNCT V-PUT-UNDER
	PRINT NOT-ENOUGH-ROOM
	RTRUE

	.FUNCT PRE-SREAD
	CALL PERFORM,V?READ,PRSI,PRSO
	RTRUE

	.FUNCT V-SREAD
	CALL V-FOO >STACK
	RSTACK

	.FUNCT PRE-READ,VAL
	IN? PRSO,GLOBAL-OBJECTS \FALSE
	CALL NOT-HERE,PRSO >STACK
	RSTACK

	.FUNCT V-READ
	FSET? PRSO,READBIT /?L1
	CALL YOU-CANT >STACK
	RSTACK
?L1:	GETP PRSO,P?TEXT >STACK
	PRINT STACK
	CRLF
	RTRUE

	.FUNCT V-REMOVE
	FSET? PRSO,WORNBIT \?L1
	IN? PRSO,ROOMS /?L1
	CALL PERFORM,V?TAKE-OFF,PRSO
	RTRUE
?L1:	CALL PERFORM,V?TAKE,PRSO
	RTRUE

	.FUNCT V-RING
	CALL YOU-CANT >STACK
	RSTACK

	.FUNCT V-RUB
	FSET? PRSO,PERSONBIT \?L1
	FSET? PRSO,MUNGBIT /?L1
	EQUAL? PRSO,PLAYER /?L1
	CALL FACE-RED >STACK
	RSTACK
?L1:	CALL HACK-HACK,STR?145 >STACK
	RSTACK

	.FUNCT V-SAY,P
	CALL QCONTEXT-GOOD? >STACK
	ZERO? STACK /?L1
	CALL PERFORM,V?TELL,QCONTEXT
	RTRUE
?L1:	CALL FIND-FLAG-HERE-NOT,PERSONBIT,MUNGBIT,WINNER >P
	ZERO? P /?L3
	CALL TELL-I-ASSUME,P,STR?146
	CALL PERFORM,V?TELL,P
	RTRUE
?L3:	CALL NOT-CLEAR-WHOM >STACK
	RSTACK

	.FUNCT PRE-SEARCH
	CALL ROOM-CHECK >STACK
	RSTACK

	.FUNCT V-SEARCH,OBJ
	IN? PRSO,ROOMS \?L1
	CALL PERFORM,PRSA,GLOBAL-HERE
	RTRUE
?L1:	FSET? PRSO,PERSONBIT \?L3
	FIRST? PRSO >OBJ \?L3
	FSET OBJ,TAKEBIT
	FCLEAR OBJ,NDESCBIT
	FCLEAR OBJ,WORNBIT
	FCLEAR OBJ,SECRETBIT
	CALL THIS-IS-IT,OBJ
	MOVE OBJ,PLAYER
	PRINTI "You find "
	CALL PRINTA,OBJ
	PRINTI " and take it. "
	PRINTC 89
	PRINT OU-STOP-SEARCHING
	PRINTR "."
?L3:	CALL FIND-FLAG,PRSO,SECRETBIT >OBJ
	ZERO? OBJ /?L6
	CALL DISCOVER,OBJ,PRSO >STACK
	RSTACK
?L6:	FSET? PRSO,DOORBIT \?L7
	CALL NOTHING-SPECIAL >STACK
	RSTACK
?L7:	FSET? PRSO,CONTBIT /?L9
	FSET? PRSO,SURFACEBIT \?L8
?L9:	CALL PERFORM,V?LOOK-INSIDE,PRSO
	RTRUE
?L8:	CALL NOTHING-SPECIAL >STACK
	RSTACK

	.FUNCT DISCOVER,OBJ,WHERE=0
	EQUAL? OBJ,YOUR-SWITCH /?L1
	FCLEAR OBJ,NDESCBIT
?L1:	FCLEAR OBJ,SECRETBIT
	FCLEAR OBJ,WORNBIT
	ZERO? WHERE \?L4
	LOC OBJ >WHERE
?L4:	EQUAL? OBJ,MOONMIST,YOUR-SWITCH /?L7
	FSET OBJ,TAKEBIT
?L7:	EQUAL? WHERE,COFFIN,INKWELL,JEWELRY-CASE \?L10
	PRINTI "Inside the "
	PRINTD WHERE
	JUMP ?L54
?L10:	EQUAL? WHERE,PAINT \?L14
	PRINTI "Under the "
	PRINTD WHERE
	JUMP ?L54
?L14:	EQUAL? HERE,GARDEN \?L17
	PRINTI "Buried in the dirt"
	JUMP ?L54
?L17:	EQUAL? HERE,CRYPT \?L22
	PRINTI "Hanging on the neck of the "
	PRINTD WHERE
	JUMP ?L54
?L22:	EQUAL? HERE,YOUR-ROOM \?L25
	PRINTI "Behind the "
	PRINTD YOUR-MIRROR
	JUMP ?L54
?L25:	EQUAL? HERE,GREAT-HALL \?L28
	PRINTI "Inside the helmet of the "
	PRINTD ARMOR
	JUMP ?L54
?L28:	EQUAL? HERE,CHAPEL \?L31
	PRINTI "Stuck on the apple of the "
	PRINTD STAINED-WINDOW
	JUMP ?L54
?L31:	EQUAL? HERE,GAME-ROOM \?L34
	PRINTI "Hidden behind the "
	PRINTD GLASS-EYE
	PRINTI " of the "
	PRINTD RHINO-HEAD
	JUMP ?L54
?L34:	EQUAL? HERE,WENDISH-ROOM \?L37
	PRINTI "Underneath some items in the "
	PRINTD WENDISH-KIT
	JUMP ?L54
?L37:	EQUAL? HERE,TAMARA-ROOM \?L40
	PRINTI "Neatly hidden under the bed"
	JUMP ?L54
?L40:	EQUAL? HERE,JACK-ROOM \?L43
	PRINTI "Inside a drawer of the tallboy"
	JUMP ?L54
?L43:	EQUAL? HERE,STUDY,LUMBER-ROOM \?L46
	PRINTI "Among some papers"
	JUMP ?L54
?L46:	EQUAL? HERE,VIVIEN-ROOM \?L49
	PRINTI "Inside"
	CALL PRINTT,VIVIEN-BOX
	JUMP ?L54
?L49:	FSET? WHERE,SURFACEBIT /?L57
	FSET? WHERE,PERSONBIT \?L55
?L57:	PRINTI "On"
	JUMP ?L60
?L55:	PRINTI "In"
?L60:	CALL PRINTT,WHERE
?L54:	EQUAL? OBJ,COSTUME \?L65
	PRINTI " are a shimmering white gown and blonde wig[RWD_ID: verbs:3207, VAL: 1]"
	JUMP ?L69
?L65:	PRINTI " is "
	CALL PRINTA,OBJ
?L69:	CALL THIS-IS-IT,OBJ
	FSET OBJ,SEENBIT
	EQUAL? PRSA,V?SEARCH-FOR,V?SEARCH \?L72
	PRINTI ", so y"
	PRINT OU-STOP-SEARCHING
?L72:	EQUAL? HERE,TAMARA-ROOM \?L77
	MOVE OBJ,PLAYER
	EQUAL? PRSA,V?SEARCH-FOR,V?SEARCH \?L79
	PRINTI " and "
	JUMP ?L83
?L79:	PRINTI ", so you "
?L83:	PRINTI "take it"
?L77:	PRINTI ".
"
	EQUAL? OBJ,COSTUME \?L91
	GET FOUND-COSTUME,PLAYER-C >STACK
	ZERO? STACK \?L91
	CALL CONGRATS,COSTUME
	JUMP ?L93
?L91:	CALL FIND-FLAG-HERE-NOT,PERSONBIT,MUNGBIT,PLAYER >WHERE
	ZERO? WHERE /?L93
	CALL EVIDENCE?,OBJ,WHERE >STACK
	ZERO? STACK \?L93
	CALL GOOD-SHOW,WHERE,OBJ
?L93:	EQUAL? OBJ,TREASURE \TRUE
	CALL CONGRATS,ARTIFACT
	RTRUE

	.FUNCT CONGRATS,FOUND=0
	PRINTI "
(Congratulations, "
	CALL TITLE-NAME
	PRINTI "! You've "
	CALL PRINT-ID,STR?147
	EQUAL? FOUND,COSTUME \?L3
	PRINT IDENTIFIED-THE-GHOST
	JUMP ?L14
?L3:	PRINTI "found"
	ZERO? FOUND \?L10
	PRINTI " evidence of the crime"
	JUMP ?L14
?L10:	CALL PRINTT,FOUND
?L14:	PRINTI "!)"
	CRLF
	EQUAL? FOUND,ARTIFACT \?L19
	SET 'TREASURE-FOUND,TREASURE
	GET FOUND-COSTUME,PLAYER-C >STACK
	ZERO? STACK /TRUE
	ZERO? CONFESSED /TRUE
	CALL WRAP-UP
	CALL FINISH
	RTRUE
?L19:	EQUAL? FOUND,COSTUME \TRUE
	PUT FOUND-COSTUME,PLAYER-C,1
	ZERO? TREASURE-FOUND /TRUE
	ZERO? CONFESSED /TRUE
	CALL WRAP-UP
	CALL FINISH
	RTRUE

	.FUNCT PRE-SSEARCH-FOR
	CALL PERFORM,V?SEARCH-FOR,PRSI,PRSO
	RTRUE

	.FUNCT V-SSEARCH-FOR
	CALL V-FOO >STACK
	RSTACK

	.FUNCT PRE-SEARCH-FOR,OBJ
	CALL ROOM-CHECK >STACK
	ZERO? STACK /FALSE
	RTRUE

	.FUNCT V-SEARCH-FOR
	IN? PRSO,ROOMS \?L1
	CALL PERFORM,PRSA,GLOBAL-HERE,PRSI
	RTRUE
?L1:	FSET? PRSO,PERSONBIT \?L3
	IN? PRSI,PRSO \?L4
	PRINTI "Indeed,"
	CALL HE-SHE-IT,PRSO,0,STR?45
	CALL HIM-HER-IT,PRSI
	PRINTR "."
?L4:	CALL START-SENTENCE,PRSO
	PRINTI " doesn't have"
	IN? PRSI,GLOBAL-OBJECTS \?L11
	CALL PRINTT,PRSI
	PRINTR "."
?L11:	ZERO? PRSI \?L15
	PRINTR " that."
?L15:	CALL PRINTT,PRSI
	PRINTI " hidden on"
	CALL HIM-HER-IT,PRSO,0,1
	PRINTR " person."
?L3:	FSET? PRSO,CONTBIT \?L21
	FSET? PRSO,OPENBIT /?L21
	PRINTI "You'll have to open"
	CALL HIM-HER-IT,PRSO
	PRINTR " first."
?L21:	IN? PRSI,PRSO \?L24
	FSET? PRSI,SECRETBIT \?L25
	CALL DISCOVER,PRSI >STACK
	RSTACK
?L25:	PRINTI "How observant you are! There"
	CALL HE-SHE-IT,PRSI,0,STR?44
	PRINTR "!"
?L24:	ZERO? PRSI \?L30
	CALL YOU-CANT >STACK
	RSTACK
?L30:	PRINTI "You don't find"
	FSET? PRSI,SECRETBIT \?L34
	PRINTI " it"
	JUMP ?L38
?L34:	CALL HIM-HER-IT,PRSI
?L38:	PRINTR " there."

	.FUNCT V-SHAKE,X
	FSET? PRSO,TAKEBIT /?L1
	SET 'CLOCK-WAIT,1
	PRINTR "(You can't shake it if you can't take it!)"
?L1:	FSET? PRSO,OPENBIT /?L22
	FIRST? PRSO >STACK \?L5
	PRINTI "It sounds as if there is something inside"
	CALL HIM-HER-IT,PRSO
	PRINTR "."
?L5:	FSET? PRSO,OPENBIT \?L8
?L22:	FIRST? PRSO >X \?L8
	PRINTI "Right "
	CALL GROUND-DESC >STACK
	PRINT STACK
	PRINTI " spill"
	NEXT? X >STACK /?L15
?L15:	ZERO? STACK \?L13
	PRINTC 115
?L13:	CALL ROB,PRSO,HERE,1
	CRLF
	RTRUE
?L8:	PRINTI "You hear nothing inside"
	CALL HIM-HER-IT,PRSO
	PRINTR "."

	.FUNCT V-SHOOT
	ZERO? PRSI /?L3
	LOC PRSI >STACK
	EQUAL? STACK,WINNER /?L1
?L3:	CALL FIND-FLAG,WINNER,WEAPONBIT >STACK
	ZERO? STACK \?L1
	PRINTI "You're not holding anything to shoot with."
	CRLF
	CALL IS-PERSON? >STACK
	CALL PRINT-ID,STR?148,STACK
	CALL IS-OBJECT-OR-PROPERTY? >STACK
	CALL PRINT-ID,STR?149,STACK
	CALL IS-SELF? >STACK
	CALL PRINT-ID,STR?150,STACK >STACK
	RSTACK
?L1:	CALL IS-PERSON? >STACK
	CALL PRINT-ID,STR?151,STACK
	CALL IS-OBJECT-OR-PROPERTY? >STACK
	CALL PRINT-ID,STR?152,STACK
	CALL IS-SELF? >STACK
	CALL PRINT-ID,STR?153,STACK
	CALL IKILL,STR?154 >STACK
	RSTACK

	.FUNCT PRE-SSHOOT
	CALL PERFORM,V?SHOOT,PRSI,PRSO
	RTRUE

	.FUNCT V-SSHOOT
	CALL V-FOO >STACK
	RSTACK

	.FUNCT V-SHOW
	EQUAL? PRSO,PLAYER \?L1
	SET 'WINNER,PLAYER
	CALL VISIBLE?,PRSO >STACK
	ZERO? STACK /?L3
	CALL PERFORM,V?EXAMINE,PRSI
	RTRUE
?L3:	CALL PERFORM,V?FIND,PRSI
	RTRUE
?L1:	FSET? PRSO,PERSONBIT \?L7
	FSET? PRSO,MUNGBIT \?L6
?L7:	PRINTI "Don't wait for"
	CALL HIM-HER-IT,PRSO
	PRINTR " to applaud."
?L6:	CALL WHO-CARES >STACK
	RSTACK

	.FUNCT PRE-SSHOW,P
	ZERO? PRSI /?L1
	SET 'P-MERGED,1
	IN? PRSI,ROOMS \?L3
	CALL PERFORM,V?TAKE-TO,PRSO,PRSI
	RTRUE
?L3:	CALL PERFORM,V?SHOW,PRSI,PRSO
	RTRUE
?L1:	CALL HELD?,PRSO >STACK
	ZERO? STACK \?L6
	LOC PRSO >STACK
	FSET? STACK,PERSONBIT \?L7
	CALL PERFORM,V?TAKE,PRSO
	RTRUE
?L7:	CALL TELL-I-ASSUME,PRSO,STR?155
	CALL PERFORM,V?ASK-CONTEXT-ABOUT,PRSO
	RTRUE
?L6:	CALL QCONTEXT-GOOD? >STACK
	ZERO? STACK /?L10
	CALL PERFORM,V?SHOW,QCONTEXT,PRSO
	RTRUE
?L10:	CALL FIND-FLAG-HERE-NOT,PERSONBIT,MUNGBIT,WINNER >P
	ZERO? P /?L11
	CALL TELL-I-ASSUME,P,STR?156
	CALL PERFORM,V?SHOW,P,PRSO
	RTRUE
?L11:	CALL TELL-I-ASSUME,PLAYER,STR?156
	CALL PERFORM,V?SHOW,PLAYER,PRSO
	RTRUE

	.FUNCT V-SSHOW
	CALL V-FOO >STACK
	RSTACK

	.FUNCT V-SIGN
	PRINTR "You would use your usual hand."

	.FUNCT PRE-SIT
	CALL ROOM-CHECK >STACK
	RSTACK

	.FUNCT V-SIT,LIE?=0
	EQUAL? WINNER,PLAYER \?L1
	FSET? PRSO,VEHBIT /?L3
	EQUAL? PRSO,FLOOR,HERE,GLOBAL-HERE \?L1
?L3:	PRINTI "You're now "
	ZERO? LIE? \?L6
	PRINTI "sitt"
	JUMP ?L10
?L6:	PRINTI "ly"
?L10:	FSET? PRSO,VEHBIT \?L13
	MOVE PLAYER,PRSO
?L13:	PRINTI "ing "
	FSET? PRSO,SURFACEBIT \?L18
	PRINTI "on"
	JUMP ?L22
?L18:	PRINTI "in"
?L22:	CALL PRINTT,PRSO
	PRINTR "."
?L1:	CALL WONT-HELP >STACK
	RSTACK

	.FUNCT WONT-HELP
	SET 'CLOCK-WAIT,1
	PRINTR "(That won't help solve this case!)"

	.FUNCT V-SIT-AT
	CALL V-SIT >STACK
	RSTACK

	.FUNCT V-SLAP
	EQUAL? PRSI,ROOMS \?L1
	SET 'PRSI,0
?L1:	EQUAL? PRSO,PLAYER \?L4
	PRINTR "That sounds like a sign you could wear on your back."
?L4:	FSET? PRSO,PERSONBIT /?L8
	CALL IF-SPY >STACK
	RSTACK
?L8:	FSET? PRSO,MUNGBIT \?L9
	PRINTI "If"
	CALL HE-SHE-IT,PRSO
	PRINTI " could,"
	CALL HE-SHE-IT,PRSO
	PRINTR " would slap you right back."
?L9:	CALL FACE-RED >STACK
	RSTACK

	.FUNCT IF-SPY
	ZERO? PRSI \?L1
	PRINTI "You give"
	CALL HIM-HER-IT,PRSO
	PRINTI " a swift "
	EQUAL? P-PRSA-WORD,W?KICK \?L5
	PRINTI "kick"
	JUMP ?L12
?L5:	PRINTI "hand chop"
	JUMP ?L12
?L1:	PRINTI "You swing"
	CALL HIM-HER-IT,PRSI
	PRINTI " at"
	CALL HIM-HER-IT,PRSO
?L12:	PRINTI ", but"
	CALL HE-SHE-IT,PRSO
	PRINTR " seems indestructible."

	.FUNCT FACE-RED,P=0,X
	ZERO? P \?L1
	SET 'P,PRSO
?L1:	CALL UNSNOOZE,P
	GETP P,P?LINE >X
	ADD 1,X >STACK
	PUTP P,P?LINE,STACK
	EQUAL? FOLLOWER,P \?L4
	SET 'FOLLOWER,0
?L4:	GETP P,P?LDESC >STACK
	EQUAL? STACK,4 /?L7
	PUTP P,P?LDESC,20
?L7:	CALL HE-SHE-IT,P,1
	ZERO? X \?L12
	PRINTI " looks at you as if you were insane."
	CRLF
	CALL PRINT-ID,STR?157 >STACK
	RSTACK
?L12:	PRINTI " gives you a good slap. It hurts, too!"
	CRLF
	CALL PRINT-ID,STR?158 >STACK
	RSTACK

	.FUNCT V-SMELL
	CALL HE-SHE-IT,PRSO,1,STR?159
	PRINTI " just like "
	CALL PRINTA,PRSO
	PRINTR "!"

	.FUNCT V-SMILE
	CALL HAR-HAR >STACK
	RSTACK

	.FUNCT V-SORRY
	EQUAL? PRSO,CONFESSED \?L1
	CALL WONT-HELP-TO-TALK-TO,PRSO >STACK
	RSTACK
?L1:	CALL GRAB-ATTENTION,PRSO >STACK
	ZERO? STACK \?L3
	RETURN 2
?L3:	GETP PRSO,P?LINE >STACK
	LESS? 0,STACK /?L6
	PRINTI """I'm not angry with"
	CALL HIM-HER-IT,WINNER
	PRINTR " now."""
?L6:	PUTP PRSO,P?LINE,0
	PUTP PRSO,P?LDESC,3
	PRINTR """Apology accepted."""

	.FUNCT V-SOUND
	CALL YOU-CANT >STACK
	RSTACK

	.FUNCT V-STOP
	EQUAL? PRSO,0,GLOBAL-HERE \?L1
	PRINTR "Hey, no problem."
?L1:	FSET? PRSO,PERSONBIT \?L5
	CALL PERFORM,V?$0024CALL,PRSO
	RTRUE
?L5:	CALL PERFORM,V?LAMP-OFF,PRSO
	RTRUE

	.FUNCT V-SWIM
	SET 'CLOCK-WAIT,1
	PRINTI "("
	CALL HE-SHE-IT,WINNER,1
	PRINTI " can't swim "
	ZERO? PRSO /?L3
	PRINTI "in"
	CALL HIM-HER-IT,PRSO
	JUMP ?L7
?L3:	CALL GROUND-DESC >STACK
	PRINT STACK
?L7:	PRINTR ".)"

	.FUNCT PRE-TAKE,L
	LOC PRSO >L
	EQUAL? PRSO,MOONMIST \?L1
	EQUAL? VARIATION,DOCTOR-C \?L1
	IN? MOONMIST,INKWELL \?L1
	ZERO? TREASURE-FOUND /?L1
	LOC INKWELL >L
?L1:	EQUAL? PRSO,KEYHOLE,WALL,FLOOR /?L6
	EQUAL? PRSO,TOWER,OTHER-OUTFIT,NOW-WEARING /?L6
	EQUAL? PRSO,OCEAN,MOON,CASTLE \?L4
?L6:	CALL HAR-HAR >STACK
	RSTACK
?L4:	EQUAL? PRSO,YOU,TREASURE,PASSAGE /FALSE
	EQUAL? PRSO,HANDS,ARTIFACT /FALSE
	EQUAL? PRSO,NIGHTLAMP,LIGHT-GLOBAL \?L9
	CALL CREEPY?,HERE >STACK
	ZERO? STACK /?L10
	CALL NOT-HERE,PRSO >STACK
	RSTACK
?L10:	PRINTR "The cord isn't long enough."
?L9:	EQUAL? PRSO,MIRROR-GLOBAL \?L15
	CALL YOU-CANT >STACK
	RSTACK
?L15:	EQUAL? PRSO,UNDRESSED \?L16
	CALL NOUN-USED?,W?DRESSE >STACK
	ZERO? STACK /?L17
	ZERO? PRSI /?L19
	CALL PERFORM,V?WEAR,PRSI
	RTRUE
?L19:	CALL PERFORM,V?DRESS,WINNER
	RTRUE
?L17:	CALL PERFORM,V?UNDRESS,WINNER
	RTRUE
?L16:	IN? PRSO,GLOBAL-OBJECTS \?L23
	CALL NOT-HERE,PRSO >STACK
	RSTACK
?L23:	ZERO? L /?L24
	FSET? L,CONTBIT \?L24
	FSET? L,OPENBIT /?L24
	CALL TOO-BAD-BUT,L,STR?79
	RTRUE
?L24:	ZERO? PRSI /?L25
	EQUAL? PRSI,WALL,L \?L26
	SET 'PRSI,0
	RFALSE
?L26:	FSET? PRSI,SURFACEBIT /?L28
	FSET? PRSI,OPENBIT /?L28
	FSET? PRSI,PERSONBIT /?L28
	CALL TOO-BAD-BUT,PRSI,STR?79
	RTRUE
?L28:	EQUAL? PRSI,L /FALSE
	FSET? PRSI,PERSONBIT /?L30
	CALL HE-SHE-IT,PRSO,1,STR?44
	PRINTI "n't in"
	CALL PRINTT,PRSI
	PRINTR "!"
?L30:	CALL HE-SHE-IT,PRSI,1,STR?50
	PRINTI "n't have"
	CALL PRINTT,PRSO
	PRINTR "!"
?L25:	CALL PRE-TAKE-WITH >STACK
	RSTACK

	.FUNCT PRE-TAKE-WITH,X
	EQUAL? PRSO,YOU /FALSE
	FSET? PRSO,PERSONBIT \?L3
	EQUAL? PRSO,GHOST-NEW /?L3
	EQUAL? P-PRSA-WORD,W?SEIZE,W?GRAB \?L3
	CALL PERFORM,V?ARREST,PRSO
	RTRUE
?L3:	CALL META-LOC,PRSO >STACK
	EQUAL? STACK,GLOBAL-OBJECTS \?L4
	CALL HELD?,PRSO >STACK
	ZERO? STACK \FALSE
	FSET? PRSO,PERSONBIT /FALSE
	CALL NOT-HERE,PRSO >STACK
	RSTACK
?L4:	IN? PRSO,WINNER \?L8
	CALL ALREADY,PLAYER
	PRINTI "holding"
	CALL PRINTT,PRSO
	PRINTR "!)"
?L8:	LOC PRSO >STACK
	FSET? STACK,CONTBIT \?L11
	LOC PRSO >STACK
	FSET? STACK,OPENBIT /?L11
	CALL YOU-CANT,STR?160 >STACK
	RSTACK
?L11:	IN? WINNER,PRSO \FALSE
	CALL NOUN-USED?,W?DOOR,W?KEYHOLE >STACK
	ZERO? STACK \FALSE
	SET 'CLOCK-WAIT,1
	PRINTC 40
	CALL HE-SHE-IT,WINNER,1,STR?44
	PRINTI " in"
	CALL HIM-HER-IT,PRSO
	PRINTR ", nitwit!)"

	.FUNCT V-TAKE
	CALL ITAKE >STACK
	EQUAL? STACK,1 \FALSE
	CALL HE-SHE-IT,WINNER,1,STR?44
	PRINTI " now holding"
	CALL PRINTT,PRSO
	PRINTI "."
	CRLF
	CALL IS-THEFT? >STACK
	ZERO? STACK \?L6
	PUSH 0
	JUMP ?L8
?L6:	EQUAL? WINNER,PLAYER /?L7
	PUSH 0
	JUMP ?L8
?L7:	PUSH 1
?L8:	CALL PRINT-ID,STR?161,STACK >STACK
	RSTACK

	.FUNCT V-TAKE-OFF
	EQUAL? PRSO,NOW-WEARING \?L1
	SET 'PRSO,0
	CALL V-WEAR
	RTRUE
?L1:	FSET? PRSO,WORNBIT \?L3
	FCLEAR PRSO,WORNBIT
	PRINTI "Okay,"
	LOC PRSO >STACK
	CALL HE-SHE-IT,STACK,0,STR?44
	PRINTI " no longer wearing"
	MOVE PRSO,WINNER
	CALL HIM-HER-IT,PRSO
	PRINTR "."
?L3:	LOC PRSO >STACK
	CALL HE-SHE-IT,STACK,1,STR?44
	PRINTI "n't wearing"
	CALL HIM-HER-IT,PRSO
	PRINTR "!"

	.FUNCT V-TAKE-TO
	CALL PERFORM,V?WALK-TO,PRSI
	RTRUE

	.FUNCT V-DISEMBARK
	CALL ROOM-CHECK >STACK
	ZERO? STACK \TRUE
	EQUAL? PRSO,GLOBAL-HERE,HERE,ROOMS \?L3
	EQUAL? WINNER,PLAYER \?L4
	IN? PLAYER,HERE /?L4
	CALL OWN-FEET >STACK
	RSTACK
?L4:	CALL DO-WALK,P?OUT
	RTRUE
?L3:	EQUAL? PRSO,NOW-WEARING \?L7
	CALL V-TAKE-OFF
	RTRUE
?L7:	LOC PRSO >STACK
	EQUAL? STACK,WINNER \?L8
	PRINTI "You don't need to take"
	CALL HIM-HER-IT,PRSO
	PRINTI " out to use"
	CALL HIM-HER-IT,PRSO
	PRINTR "."
?L8:	LOC WINNER >STACK
	EQUAL? STACK,PRSO /?L11
	IN? PLAYER,PRSO /?L11
	PRINTI "You're not "
	FSET? PRSO,SURFACEBIT \?L14
	PRINTI "on"
	JUMP ?L18
?L14:	PRINTI "in"
?L18:	CALL HIM-HER-IT,PRSO
	PRINTI "!
"
	RETURN 2
?L11:	CALL OWN-FEET >STACK
	RSTACK

	.FUNCT OWN-FEET
	MOVE WINNER,HERE
	CALL HE-SHE-IT,WINNER,1,STR?44
	PRINTI " on"
	CALL HIM-HER-IT,WINNER,0,1
	PRINTI " own feet again."
	CRLF
	EQUAL? DRIVEWAY,HERE \TRUE
	CALL ENTER-ROOM
	RTRUE

	.FUNCT V-HOLD-UP
	EQUAL? PRSO,ROOMS \?L1
	CALL PERFORM,V?STAND
	RTRUE
?L1:	CALL WONT-HELP >STACK
	RSTACK

	.FUNCT V-TELL,P
	EQUAL? PRSO,PLAYER \?L1
	EQUAL? WINNER,PLAYER /?L3
	SET 'P,WINNER
	SET 'WINNER,PLAYER
	CALL PERFORM,V?ASK,P
	RTRUE
?L3:	ZERO? QCONTEXT /?L5
	SET 'QCONTEXT,0
	ZERO? P-CONT /?L6
	SET 'WINNER,PLAYER
	RETURN WINNER
?L6:	PRINTR "Okay, you're not talking to anyone else."
?L5:	CALL WONT-HELP-TO-TALK-TO,PLAYER
	SET 'QUOTE-FLAG,0
	SET 'P-CONT,0
	RETURN 2
?L1:	FSET? PRSO,PERSONBIT \?L14
	FSET? PRSO,MUNGBIT /?L14
	CALL UNSNOOZE,PRSO
	SET 'QCONTEXT,PRSO
	ZERO? P-CONT /?L15
	SET 'CLOCK-WAIT,1
	SET 'WINNER,PRSO
	RETURN WINNER
?L15:	CALL HE-SHE-IT,PRSO,1,STR?44
	PRINTC 32
	GET LDESC-STRINGS,12 >STACK
	PRINT STACK
	PRINTR "."
?L14:	CALL WONT-HELP-TO-TALK-TO,PRSO
	SET 'QUOTE-FLAG,0
	SET 'P-CONT,0
	RETURN 2

	.FUNCT PRE-STELL-ABOUT
	CALL PERFORM,V?TELL-ABOUT,PRSI,PRSO
	RTRUE

	.FUNCT V-STELL-ABOUT
	CALL V-FOO >STACK
	RSTACK

	.FUNCT PRE-TELL-ABOUT,P
	EQUAL? PRSO,PLAYER-NAME,PLAYER \?L1
	CALL QCONTEXT-GOOD? >STACK
	ZERO? STACK /?L3
	CALL PERFORM,V?ASK-ABOUT,QCONTEXT,PRSI
	RTRUE
?L3:	CALL FIND-FLAG-HERE-NOT,PERSONBIT,MUNGBIT,WINNER >P
	ZERO? P /?L5
	CALL TELL-I-ASSUME,P,STR?95
	CALL PERFORM,V?ASK-ABOUT,P,PRSI
	RTRUE
?L5:	CALL ARENT-TALKING
	RTRUE
?L1:	FSET? PRSI,SEENBIT /?L7
	FSET? PRSI,TOUCHBIT /?L7
	CALL NOT-FOUND,PRSI
	RTRUE
?L7:	EQUAL? PRSI,BRICKS,COFFIN,CRYPT /?L9
	EQUAL? PRSI,DUNGEON,IRON-MAIDEN,TOMB /?L9
	EQUAL? PRSI,WELL \?L8
?L9:	PRINT ANCIENT-SECRETS
	CRLF
	RTRUE
?L8:	CALL PRE-ASK-ABOUT >STACK
	RSTACK

	.FUNCT V-TELL-ABOUT,P
	PRINTR """I'm afraid you'll have to show me instead of telling me."""

	.FUNCT PRE-TALK-ABOUT,P
	EQUAL? WINNER,PLAYER /?L1
	SET 'P,WINNER
	SET 'WINNER,PLAYER
	CALL PERFORM,V?ASK-ABOUT,P,PRSO
	RTRUE
?L1:	CALL QCONTEXT-GOOD? >STACK
	ZERO? STACK /?L3
	CALL PERFORM,V?ASK-ABOUT,QCONTEXT,PRSO
	RTRUE
?L3:	CALL FIND-FLAG-HERE-NOT,PERSONBIT,MUNGBIT,WINNER >P
	ZERO? P /FALSE
	CALL TELL-I-ASSUME,P,STR?162
	CALL PERFORM,V?ASK-ABOUT,P,PRSO
	RTRUE

	.FUNCT V-TALK-ABOUT
	CALL ARENT-TALKING >STACK
	RSTACK

	.FUNCT V-THANKS
	ZERO? PRSO /?L1
	FSET? PRSO,PERSONBIT \?L3
	FSET? PRSO,MUNGBIT /?L3
	PRINT QUITE-WELCOME
	RTRUE
?L3:	CALL YOU-CANT >STACK
	RSTACK
?L1:	CALL QCONTEXT-GOOD? >STACK
	ZERO? STACK \?L11
	CALL FIND-FLAG-HERE-NOT,PERSONBIT,MUNGBIT,WINNER >STACK
	ZERO? STACK /?L9
?L11:	PRINT QUITE-WELCOME
	RTRUE
?L9:	PRINTR "You're more than welcome."

	.FUNCT V-THROW
	CALL IDROP >STACK
	ZERO? STACK /FALSE
	PRINTR "Thrown."

	.FUNCT V-THROW-AT
	CALL IDROP >STACK
	ZERO? STACK /TRUE
	CALL HE-SHE-IT,PRSI,1,STR?50
	PRINTI "n't duck"
	PRINTI " as"
	CALL HE-SHE-IT,PRSO
	PRINTR " flies by."

	.FUNCT PRE-THROW-THROUGH
	FCLEAR PRSO,WORNBIT
	RFALSE

	.FUNCT V-THROW-THROUGH
	FSET? PRSO,PERSONBIT /?L1
	PRINTR "Let's not resort to vandalism, please."
?L1:	CALL V-THROW >STACK
	RSTACK

	.FUNCT V-TIME
	PRINTI "The time is now "
	CALL TIME-PRINT,PRESENT-TIME
	PRINTR "."

	.FUNCT TIME-PRINT,NUM,HR
	DIV NUM,60 >HR
	GRTR? HR,12 \?L1
	SUB HR,12 >HR
?L1:	PRINTN HR
	PRINTC 58
	MOD NUM,60 >HR
	LESS? HR,10 \?L6
	PRINTC 48
?L6:	PRINTN HR
	RTRUE

	.FUNCT V-TURN
	FSET? PRSO,DOORBIT \?L1
	FSET? PRSO,OPENBIT \?L1
	CALL PERFORM,V?CLOSE,PRSO
	RTRUE
?L1:	PRINTR "What do you want that to do?"

	.FUNCT V-LAMP-OFF
	FSET? PRSO,LIGHTBIT /?L1
	CALL YOU-CANT,STR?77 >STACK
	RSTACK
?L1:	FSET? PRSO,ONBIT /?L3
	CALL ALREADY,PRSO,STR?83 >STACK
	RSTACK
?L3:	CALL OKAY,PRSO,STR?83 >STACK
	RSTACK

	.FUNCT V-LAMP-ON
	FSET? PRSO,ONBIT \?L1
	CALL ALREADY,PRSO,STR?82 >STACK
	RSTACK
?L1:	FSET? PRSO,LIGHTBIT \?L3
	CALL OKAY,PRSO,STR?82 >STACK
	RSTACK
?L3:	FSET? PRSO,PERSONBIT \?L4
	CALL HAR-HAR >STACK
	RSTACK
?L4:	CALL YOU-CANT,STR?76 >STACK
	RSTACK

	.FUNCT V-UNLOCK
	FSET? PRSO,DOORBIT /?L3
	FSET? PRSO,CONTBIT \?L1
	GETP PRSO,P?CAPACITY >STACK
	ZERO? STACK /?L1
?L3:	FSET? PRSO,LOCKED /?L4
	CALL ALREADY,PRSO,STR?86 >STACK
	RSTACK
?L4:	CALL UNLOCK-DOOR?,PRSO >STACK
	ZERO? STACK \?L6
	CALL YOU-CANT >STACK
	RSTACK
?L6:	FCLEAR PRSO,LOCKED
	CALL OKAY,PRSO,STR?86 >STACK
	RSTACK
?L1:	SET 'CLOCK-WAIT,1
	PRINTC 40
	CALL HE-SHE-IT,PRSO,1,STR?44
	PRINTR "n't locked!)"

	.FUNCT MORE-SPECIFIC
	SET 'CLOCK-WAIT,1
	PRINTR "[Please be more specific.]"

	.FUNCT V-USE
	CALL MORE-SPECIFIC >STACK
	RSTACK

	.FUNCT V-WAIT,NUM=-1,WHO=0,INT?1=0,WHO-WAIT=0,VAL,HR,RESULT=1
	EQUAL? -1,NUM \?L1
	SET 'NUM,10
?L1:	ZERO? INT?1 \?L4
	FSET? PRSO,PERSONBIT /?L4
	EQUAL? PRSO,GHOST-NEW,TURN,INTNUM /?L4
	PRINT I-ASSUME
	PRINTI " Wait "
	PRINTN NUM
	PRINTI " minute"
	EQUAL? NUM,1 /?L8
	PRINTC 115
?L8:	PRINTI ".]"
	CRLF
?L4:	SET 'HR,HERE
	ZERO? INT?1 \?L16
	PRINTI "Time passes..."
	CRLF
?L16:	DEC 'NUM
?L21:	DLESS? 'NUM,0 \?L23
	SET 'KEEP-WAITING,0
	RETURN RESULT
?L23:	CALL CLOCKER >VAL
	ZERO? VAL /?L25
	EQUAL? VAL,M-FATAL /?L28
	EQUAL? HR,HERE /?L26
?L28:	SET 'CLOCK-WAIT,1
	SET 'RESULT,M-FATAL
	RETURN RESULT
?L26:	ZERO? WHO /?L29
	IN? WHO,HERE \?L29
	SET 'CLOCK-WAIT,1
	CALL NOT-IT,WHO
	CALL START-SENTENCE,WHO
	PRINTI ", for wh"
	FSET? WHO,PERSONBIT \?L32
	PRINTI "om"
	JUMP ?L36
?L32:	PRINTI "ich"
?L36:	PRINTI " you're waiting, has arrived."
	CRLF
	RETURN RESULT
?L29:	INC 'WHO-WAIT
	GET 0,0 >STACK
	BTST STACK,16 \?L42
	PRINTC 40
	CALL TIME-PRINT,PRESENT-TIME >VAL
	PRINTI ") "
?L42:	ZERO? KEEP-WAITING /?L49
	USL
	CRLF
	JUMP ?L21
?L49:	PRINTI "Do you want to keep "
	CALL VERB-PRINT,1 >VAL
	CALL YES? >STACK
	ZERO? STACK /?L56
	USL
	CRLF
	JUMP ?L21
?L56:	SET 'CLOCK-WAIT,1
	SET 'RESULT,M-FATAL
	RETURN RESULT
?L25:	ZERO? WHO /?L61
	IGRTR? 'WHO-WAIT,30 \?L61
	CALL START-SENTENCE,WHO >VAL
	PRINTI " still hasn't arrived. Do you want to keep waiting?"
	CALL YES? >STACK
	ZERO? STACK /?L22
	SET 'WHO-WAIT,0
	USL
	CRLF
	JUMP ?L21
?L61:	USL
	CRLF
	JUMP ?L21
?L22:	RETURN RESULT

	.FUNCT V-WAIT-FOR,WHO
	EQUAL? -1,P-NUMBER /?L1
	EQUAL? PRSO,INTNUM,TURN,ROOMS \?L1
	ZERO? P-TIME /?L3
	CALL V-WAIT-UNTIL >STACK
	RSTACK
?L3:	CALL V-WAIT,P-NUMBER >STACK
	RSTACK
?L1:	EQUAL? PRSO,GLOBAL-HERE,TURN,ROOMS \?L6
	CALL V-WAIT >STACK
	RSTACK
?L6:	EQUAL? PRSO,PLAYER \?L7
	CALL ALREADY,PLAYER,STR?120 >STACK
	RSTACK
?L7:	FSET? PRSO,PERSONBIT /?L9
	EQUAL? PRSO,GHOST-NEW \?L8
?L9:	CALL META-LOC,PRSO >STACK
	EQUAL? STACK,HERE \?L10
	CALL ALREADY,PRSO,STR?120 >STACK
	RSTACK
?L10:	CALL V-WAIT,10000,PRSO >STACK
	RSTACK
?L8:	PRINTR "Not a good idea. You might wait forever."

	.FUNCT V-WAIT-UNTIL,N
	EQUAL? -1,P-NUMBER /?L1
	EQUAL? PRSO,INTNUM,TURN,ROOMS \?L1
	SET 'N,P-NUMBER
	ZERO? P-TIME /?L3
	LESS? N,420 \?L8
	ADD N,720 >N
	JUMP ?L8
?L3:	LESS? N,8 \?L9
	MUL N,60 >STACK
	ADD STACK,720 >N
	JUMP ?L13
?L9:	LESS? N,13 \?L11
	MUL N,60 >N
	JUMP ?L13
?L11:	LESS? N,24 \?L12
	MUL N,60 >STACK
	SUB STACK,720 >N
	JUMP ?L13
?L12:	GRTR? N,99 \?L13
	DIV N,100 >STACK
	MUL STACK,60 >STACK
	MOD N,100 >STACK
	ADD STACK,STACK >N
?L13:	LESS? N,420 \?L15
	ADD N,720 >N
?L15:	PRINT I-ASSUME
	PRINTC 32
	CALL TIME-PRINT,N
	PRINTI "]"
	CRLF
?L8:	GRTR? N,PRESENT-TIME \?L22
	SUB N,PRESENT-TIME >STACK
	CALL V-WAIT,STACK >STACK
	RSTACK
?L22:	SET 'CLOCK-WAIT,1
	PRINTR "(It's already past that time!)"
?L1:	CALL YOU-CANT,STR?75 >STACK
	RSTACK

	.FUNCT V-ALARM
	EQUAL? PRSO,ROOMS \?L1
	SET 'PRSO,WINNER
?L1:	CALL TOO-BAD-BUT,PRSO,STR?163 >STACK
	RSTACK

	.FUNCT DO-WALK,DIR,P
	SET 'P-WALK-DIR,DIR
	CALL PERFORM,V?WALK,DIR >STACK
	RSTACK

	.FUNCT V-WALK,PT,PTS,STR,RM
	ZERO? P-WALK-DIR \?L6
	EQUAL? PRSO,P?IN \?L3
	IN? P-IT-OBJECT,ROOMS /?L5
	FSET? P-IT-OBJECT,VEHBIT /?L5
	FSET? P-IT-OBJECT,CONTBIT \?L3
?L5:	CALL TELL-I-ASSUME,P-IT-OBJECT
	CALL PERFORM,V?THROUGH,P-IT-OBJECT
	RTRUE
?L3:	CALL V-WALK-AROUND
	RETURN 2
?L6:	LOC WINNER >STACK
	GETPT STACK,PRSO >PT
	ZERO? PT /?L10
	PTSIZE PT >PTS
	EQUAL? PTS,UEXIT \?L12
	GETB PT,REXIT >RM
	CALL GOTO,RM >STACK
	ZERO? STACK /TRUE
	CALL OKAY
	RTRUE
?L12:	EQUAL? PTS,NEXIT \?L17
	SET 'CLOCK-WAIT,1
	PRINTC 40
	GET PT,NEXITSTR >STACK
	PRINT STACK
	PRINTC 41
	CRLF
	RETURN 2
?L17:	EQUAL? PTS,FEXIT \?L22
	GET PT,FEXITFCN >STACK
	CALL STACK >RM
	ZERO? RM /?L23
	CALL GOTO,RM >STACK
	ZERO? STACK /TRUE
	CALL OKAY
	RTRUE
?L23:	RETURN 2
?L22:	EQUAL? PTS,CEXIT \?L31
	GETB PT,CEXITFLAG >STACK
	VALUE STACK >STACK
	ZERO? STACK /?L32
	GETB PT,REXIT >STACK
	CALL GOTO,STACK >STACK
	ZERO? STACK /TRUE
	CALL OKAY
	RTRUE
?L32:	GET PT,CEXITSTR >STR
	ZERO? STR /?L37
	PRINT STR
	CRLF
	RETURN 2
?L37:	CALL YOU-CANT,STR?74
	RETURN 2
?L31:	EQUAL? PTS,DEXIT \FALSE
	CALL WALK-THRU-DOOR?,PT >STACK
	ZERO? STACK /?L46
	GETB PT,REXIT >STACK
	CALL GOTO,STACK >STACK
	ZERO? STACK /TRUE
	CALL OKAY
	RTRUE
?L46:	RETURN 2
?L10:	EQUAL? PRSO,P?IN,P?OUT \?L55
	CALL V-WALK-AROUND >STACK
	RSTACK
?L55:	EQUAL? PRSO,P?UP \?L56
	CALL PERFORM,V?CLIMB-UP,STAIRS
	RTRUE
?L56:	EQUAL? PRSO,P?DOWN \?L57
	CALL PERFORM,V?CLIMB-DOWN,STAIRS
	RTRUE
?L57:	EQUAL? HERE,DRIVEWAY \?L58
	PRINT CASTLE-IS-SOUTH
	RETURN 2
?L58:	CALL YOU-CANT,STR?74
	RETURN 2

	.FUNCT UNLOCK-DOOR?,DR
	EQUAL? HERE,DR /TRUE
	GETP HERE,P?STATION >STACK
	EQUAL? HERE,DRIVEWAY,STACK /FALSE
	EQUAL? DR,SECRET-SITTING-DOOR,FRONT-GATE \TRUE
	RFALSE

	.FUNCT WALK-THRU-DOOR?,PT,OBJ=0,TELL?=1,RM
	ZERO? OBJ \?L1
	GETB PT,DEXITOBJ >OBJ
?L1:	FSET? OBJ,OPENBIT /TRUE
	FSET? OBJ,SECRETBIT \?L6
	FSET? OBJ,TOUCHBIT /?L6
	EQUAL? 0,TELL?,VERBOSITY /FALSE
	FSET? HERE,SECRETBIT /?L9
	CALL YOU-CANT,STR?74
	RFALSE
?L9:	ZERO? LIT \?L10
	CALL NOT-FOUND,OBJ
	RFALSE
?L10:	EQUAL? PRSA,V?WALK-TO /TRUE
	CALL OPEN-DOOR-AND-CLOSE-IT-AGAIN,OBJ
	RTRUE
?L6:	FSET? OBJ,LOCKED /?L15
	EQUAL? PRSA,V?WALK-TO /TRUE
	FCLEAR OBJ,SECRETBIT
	FSET OBJ,SEENBIT
	EQUAL? 0,TELL?,VERBOSITY /TRUE
	CALL OPEN-DOOR-AND-CLOSE-IT-AGAIN,OBJ
	RTRUE
?L15:	ZERO? PT /?L22
	GET PT,DEXITSTR >RM
	ZERO? RM /?L22
	ZERO? TELL? /FALSE
	PRINT RM
	CRLF
	RFALSE
?L22:	ZERO? TELL? /FALSE
	CALL UNLOCK-DOOR?,OBJ >STACK
	ZERO? STACK /?L31
	EQUAL? PRSA,V?WALK-TO /TRUE
	ZERO? VERBOSITY /TRUE
	CALL OPEN-DOOR-AND-CLOSE-IT-AGAIN,OBJ
	RTRUE
?L31:	CALL TOO-BAD-BUT,OBJ,STR?85
	CALL THIS-IS-IT,OBJ
	RFALSE

	.FUNCT OPEN-DOOR-AND-CLOSE-IT-AGAIN,OBJ
	FSET OBJ,SEENBIT
	EQUAL? WINNER,PLAYER \TRUE
	PRINTI "(You "
	FSET? OBJ,LOCKED \?L6
	FCLEAR OBJ,LOCKED
	PRINTI "unlock and "
?L6:	PRINTI "open the "
	EQUAL? OBJ,FRONT-GATE \?L13
	PRINTI "gate"
	JUMP ?L17
?L13:	PRINTI "door"
?L17:	FSET? OBJ,SECRETBIT \?L20
	FSET OBJ,OPENBIT
	JUMP ?L22
?L20:	PRINTI " and close it again"
?L22:	PRINTR ".)"

	.FUNCT V-WALK-AROUND
	SET 'CLOCK-WAIT,1
	PRINTC 91
	PRINT WHICH-DIR
	PRINTI "]
"
	RETURN 2

	.FUNCT WHO-KNOWS?,OBJ
	SET 'CLOCK-WAIT,1
	PRINTI "(Who knows where"
	CALL HE-SHE-IT,OBJ,0,STR?44
	PRINTR "?)"

	.FUNCT WALK-WITHIN-ROOM
	CALL NO-NEED,STR?164,HERE >STACK
	RSTACK

	.FUNCT V-WALK-TO,L,VAL
	CALL META-LOC,PRSO >L
	FSET? PRSO,PERSONBIT \?L5
	CALL META-LOC,WINNER >STACK
	EQUAL? STACK,L \?L3
	FSET? PRSO,NDESCBIT /?L3
	CALL BITE-YOU
	RTRUE
?L3:	CALL FOLLOW-LOC? >L
	ZERO? L \?L5
	CALL WHO-KNOWS?,PRSO
	RETURN 2
?L5:	FSET? PRSO,SECRETBIT \?L10
	EQUAL? L,PRSO /?L10
	CALL NO-FUN >STACK
	RSTACK
?L10:	LOC WINNER >STACK
	EQUAL? HERE,STACK \?L12
	EQUAL? L,HERE /?L13
	EQUAL? PRSO,PSEUDO-OBJECT,WALL /?L13
	IN? L,ROOMS /?L12
	CALL GLOBAL-IN?,PRSO,HERE >STACK
	ZERO? STACK /?L12
?L13:	CALL WALK-WITHIN-ROOM >STACK
	RSTACK
?L12:	EQUAL? L,LOCAL-GLOBALS \?L14
	CALL MORE-SPECIFIC >STACK
	RSTACK
?L14:	CALL TOUR? >STACK
	ZERO? STACK \TRUE
	GETP HERE,P?ACTION >STACK
	CALL STACK,M-EXIT >STACK
	ZERO? STACK \TRUE
	EQUAL? PRSO,INTDIR \?L17
	CALL V-WALK-AROUND >STACK
	RSTACK
?L17:	IN? PRSO,ROOMS /?L18
	FSET? PRSO,TOUCHBIT /?L18
	CALL WHO-KNOWS?,PRSO
	RETURN 2
?L18:	CALL FAR-AWAY?,L >STACK
	ZERO? STACK /?L21
	SET 'CLOCK-WAIT,1
	PRINTC 40
	CALL HE-SHE-IT,WINNER,1
	PRINTI " can't go there from here"
	EQUAL? L,GLOBAL-OBJECTS /?L24
	PRINTI ", at least not directly"
?L24:	PRINTR ".)"
?L21:	EQUAL? WINNER,PLAYER /?L31
	CALL GOTO,L >STACK
	ZERO? STACK /TRUE
	EQUAL? WINNER,FOLLOWER \?L34
	SET 'FOLLOWER,0
?L34:	GETP WINNER,P?CHARACTER >STACK
	GET GOAL-TABLES,STACK >L
	GET L,GOAL-S >STACK
	ZERO? STACK /?L37
	GET L,GOAL-ENABLE >STACK
	GET L,GOAL-F >STACK
	CALL ESTABLISH-GOAL,WINNER,STACK,STACK
?L37:	CALL OKAY
	RTRUE
?L31:	CALL SEE-INTO?,PRSO,0 >STACK
	ZERO? STACK /?L42
	CALL DIR-FROM,HERE,L >VAL
	ZERO? VAL /?L46
	GETP HERE,P?ACTION >STACK
	CALL STACK,VAL >STACK
	EQUAL? M-FATAL,STACK \?L46
	RETURN 2
?L46:	CALL GOTO,PRSO,0
	RTRUE
?L42:	ZERO? NOW-WEARING \?L52
	CALL YOUR-ROOM-F,P?OUT
	RETURN 2
?L52:	PRINTI "You go quickly toward"
	CALL PRINTT,L
	PRINTI ".
"
	CALL ESTABLISH-GOAL,PLAYER,L
	SET 'OHERE,HERE
	FSET PLAYER,INVISIBLE
?L58:	CALL FOLLOW-GOAL,PLAYER >VAL
	ZERO? VAL /?L58
	FCLEAR PLAYER,INVISIBLE
	ZERO? FOLLOWER /?L63
	CALL FRIEND-FOLLOWS-YOU,HERE
?L63:	EQUAL? OHERE,HERE /?L66
	CALL ENTER-ROOM
?L66:	RETURN VAL

	.FUNCT ENTER-ROOM,VAL,?TMP
	CALL LIT? >LIT
	FSET? HERE,SECRETBIT \?L1
	SET 'WASHED,0
	JUMP ?L3
?L1:	EQUAL? HERE,JACK-ROOM,TAMARA-ROOM,IRIS-ROOM /?L4
	EQUAL? HERE,WENDISH-ROOM,VIVIEN-ROOM,IAN-ROOM /?L4
	EQUAL? HERE,HYDE-ROOM \?L3
?L4:	PRINTI "You enter the room cautiously after a preliminary peek."
	SET '?TMP,CHARACTER-TABLE
	CALL ZMEMQ,HERE,CHAR-ROOM-TABLE >STACK
	DEC 'STACK
	GET ?TMP,STACK >STACK
	LOC STACK >STACK
	EQUAL? STACK,HERE,LOCAL-GLOBALS /?L7
	SET 'DISCOVERED-HERE,HERE
	CALL QUEUE,I-DISCOVERED,6
?L7:	ZERO? LIT /?L10
	CALL FIND-FLAG-HERE,PERSONBIT,PLAYER >STACK
	ZERO? STACK \?L10
	PRINTI " No one is there."
?L10:	CRLF
?L3:	GETP HERE,P?ACTION >STACK
	CALL STACK,M-ENTER >STACK
	CALL V-FIRST-LOOK >VAL
	GETP HERE,P?ACTION >STACK
	CALL STACK,M-FLASH >STACK
	RETURN VAL

	.FUNCT V-RUN-OVER
	PRINTR "That doesn't make much sense."

	.FUNCT NO-CHANGING?,X
	CALL FIND-FLAG-HERE-NOT,PERSONBIT,MUNGBIT,WINNER >X
	ZERO? X /?L1
	EQUAL? X,GHOST-NEW \?L3
	PRINT NO-CHANGING
	RTRUE
?L3:	CALL HE-SHE-IT,X,1
	PRINTR " says, ""I wish you wouldn't change clothes while I'm here!"""
?L1:	EQUAL? HERE,YOUR-BATHROOM,YOUR-ROOM /FALSE
	PRINT NO-CHANGING
	RTRUE

	.FUNCT V-WEAR,X
	ZERO? PRSO /?L14
	FSET? PRSO,WEARBIT /?L3
	CALL HE-SHE-IT,WINNER,1
	PRINTI " can't wear"
	CALL HIM-HER-IT,PRSO
	EQUAL? PRSO,NECKLACE-OF-D \?L7
	PRINTI ", because"
	PRINT CLASP-MUNGED
?L7:	PRINTR "."
?L3:	FSET? PRSO,WORNBIT \?L14
	CALL ALREADY,PRSO,STR?141
	RTRUE
?L14:	EQUAL? PRSO,LENS-2,LENS-1,LENS /?L17
	EQUAL? PRSO,EARRING,NECKLACE /?L17
	CALL NO-CHANGING? >STACK
	ZERO? STACK \TRUE
	ZERO? NOW-WEARING /?L21
	ZERO? PRSO /?L22
	CALL FIRST-YOU,STR?165,NOW-WEARING
?L22:	FCLEAR NOW-WEARING,WORNBIT
?L21:	SET 'NOW-WEARING,PRSO
?L17:	ZERO? PRSO /?L27
	MOVE PRSO,PLAYER
	FSET PRSO,WORNBIT
	EQUAL? PRSO,LENS-2,LENS-1,LENS /?L31
	EQUAL? PRSO,EARRING,NECKLACE /?L31
	FSET? PRSO,MUNGBIT \?L29
?L31:	PRINTR "Okay."
?L29:	FSET PRSO,MUNGBIT
	PRINTR "Ahhh! Nothing like a new outfit to change your whole outlook!"
?L27:	PRINTI "Okay... "
	ZERO? GENDER-KNOWN \?L40
	PRINTR "You immediately wish for central heating!"
?L40:	PRINTI "My, what a fine figure of a "
	FSET? PLAYER,FEMALE \?L47
	PRINTI "wo"
?L47:	PRINTR "man!"

	.FUNCT V-YELL,N=0,RM,P
	CALL QCONTEXT-GOOD? >P
	ZERO? P \?L3
	CALL FIND-FLAG-HERE-NOT,PERSONBIT,MUNGBIT,WINNER >P
	ZERO? P /?L1
?L3:	CALL START-SENTENCE,P
	PRINTR " says, ""I'm right here. You needn't yell."""
?L1:	GETP HERE,P?CHARACTER >STACK
	EQUAL? 3,STACK \?L11
	FSET? HERE,WEARBIT /?L9
	FSET? HERE,WEARBIT /?L11
	FSET? HERE,SECRETBIT /?L11
?L9:	IGRTR? 'N,DEB-C /?L11
	GET CHARACTER-TABLE,N >P
	EQUAL? P,GHOST-NEW,CONFESSED,CAPTOR /?L9
	CALL META-LOC,P >RM
	GETP RM,P?CHARACTER >STACK
	EQUAL? 3,STACK \?L9
	FSET? HERE,WEARBIT \?L26
	FSET? RM,WEARBIT /?L19
	FSET? HERE,WEARBIT /?L9
?L26:	FSET? RM,WEARBIT /?L9
?L19:	CALL GO-TO-SOUND,HERE,P
	JUMP ?L9
?L11:	PRINTR """Aaaarrrrgggghhhh!"""

	.FUNCT V-YES,NO?=0,PER
	SET 'PER,WINNER
	EQUAL? PER,PLAYER \?L3
	ZERO? AWAITING-REPLY /?L4
	GETB QUESTIONERS,AWAITING-REPLY >PER
	ZERO? PER \?L3
?L4:	CALL QCONTEXT-GOOD? >PER
	ZERO? PER /?L1
?L3:	GETP PER,P?ACTION >STACK
	CALL D-APPLY,STR?53,STACK,M-WINNER >STACK
	ZERO? STACK \TRUE
	PRINTR """I see..."""
?L1:	EQUAL? HERE,DRIVEWAY \?L10
	PRINTR "The echoes fade and silence is soon restored."
?L10:	CALL ARENT-TALKING >STACK
	RSTACK

	.FUNCT V-NO
	CALL V-YES,1 >STACK
	RSTACK

	.FUNCT FINISH,REPEATING=0,VAL
	CRLF
	CRLF
	ZERO? REPEATING \?L1
	CALL V-SCORE
	CRLF
?L1:	PRINTI "[EVENT: GAME OVER]Would you like to:
   RESTORE your place from where you saved it,
   RESTART the story from the beginning, or
   QUIT for now?"
	CRLF
?L6:	PRINTC 62
	READ P-INBUF,P-LEXV
	GET P-LEXV,P-LEXSTART >VAL
	ZERO? VAL /?L18
	CALL WT?,VAL,PS?VERB,P1?VERB >VAL
	EQUAL? VAL,ACT?RESTART \?L12
	RESTART
?L12:	EQUAL? VAL,ACT?RESTORE \?L14
	CALL V-RESTORE >STACK
	ZERO? STACK \TRUE
	CALL FINISH,1
	JUMP ?L18
?L14:	EQUAL? VAL,ACT?QUIT \?L18
	QUIT
?L18:	PRINTI "[Type RESTORE, RESTART, or QUIT.] "
	JUMP ?L6

	.FUNCT DIVESTMENT?,OBJ
	EQUAL? PRSO,OBJ \FALSE
	EQUAL? PRSA,V?THROW-THROUGH,V?THROW-AT,V?REMOVE /TRUE
	EQUAL? PRSA,V?PUT-UNDER,V?PUT-IN,V?PUT /TRUE
	EQUAL? PRSA,V?POUR,V?GIVE,V?DROP /TRUE
	EQUAL? PRSA,V?DISEMBARK /TRUE
	RFALSE

	.FUNCT REMOTE-VERB?
	EQUAL? PRSA,V?WALK-TO,V?WAIT-UNTIL,V?WAIT-FOR /TRUE
	EQUAL? PRSA,V?TELL-ABOUT,V?TALK-ABOUT,V?TAKE-TO /TRUE
	EQUAL? PRSA,V?SSHOW,V?SHOW,V?SEARCH-FOR /TRUE
	EQUAL? PRSA,V?SEARCH,V?LOOK-UP,V?LEAVE /TRUE
	EQUAL? PRSA,V?FOLLOW,V?FIND,V?DRESS /TRUE
	EQUAL? PRSA,V?DISEMBARK,V?DESCRIBE,V?ASK-FOR /TRUE
	EQUAL? PRSA,V?ASK-CONTEXT-FOR,V?ASK-CONTEXT-ABOUT,V?ASK-ABOUT \FALSE
	RTRUE

	.FUNCT FOLLOW-GOAL,PERSON,HEER,GT,GOAL,FLG,IGOAL=0,X
	LOC PERSON >HEER
	IN? HEER,ROOMS /?L1
	CALL META-LOC,HEER >HEER
	MOVE PERSON,HEER
?L1:	GETP PERSON,P?CHARACTER >STACK
	GET GOAL-TABLES,STACK >GT
	GET GT,GOAL-F >STACK
	EQUAL? HEER,STACK \?L4
	CALL GOAL-REACHED,PERSON >STACK
	RSTACK
?L4:	GET GT,GOAL-ENABLE >STACK
	ZERO? STACK /FALSE
	GET GT,GOAL-I >IGOAL
	GET TRANSFER-TABLE,IGOAL >GOAL
	ZERO? GOAL \?L8
	SET 'IGOAL,0
	GET GT,GOAL-S >GOAL
?L8:	GETP HEER,P?STATION >X
	EQUAL? HEER,GOAL,X /?L11
	CALL MOVE-PERSON,PERSON,X >STACK
	RSTACK
?L11:	ZERO? GOAL /FALSE
	EQUAL? HEER,GOAL \?L14
	ZERO? IGOAL /?L15
	ADD IGOAL,1 >STACK
	GET TRANSFER-TABLE,STACK >FLG
	CALL MOVE-PERSON,PERSON,FLG >FLG
	GET GT,GOAL-F >STACK
	CALL ESTABLISH-GOAL,PERSON,STACK
	RETURN FLG
?L15:	GET GT,GOAL-F >FLG
	EQUAL? HEER,FLG /?L17
	CALL MOVE-PERSON,PERSON,FLG >STACK
	RSTACK
?L17:	CALL GOAL-REACHED,PERSON >STACK
	RSTACK
?L14:	GETP GOAL,P?STATION >STACK
	EQUAL? HEER,STACK \?L19
	CALL MOVE-PERSON,PERSON,GOAL >STACK
	RSTACK
?L19:	CALL FOLLOW-GOAL-NEXT,HEER,GOAL >FLG
	CALL MOVE-PERSON,PERSON,FLG >STACK
	RSTACK

	.FUNCT FOLLOW-GOAL-NEXT,HEER,GOAL,LINE,CNT=1,RM,GOAL-FLAG=0,LOC,G
	GETP GOAL,P?LINE >STACK
	CALL GET-LINE,STACK >LINE
	GETP GOAL,P?STATION >G
?L1:	GET LINE,CNT >RM
	EQUAL? RM,HEER \?L3
	ZERO? GOAL-FLAG /?L5
	SUB CNT,3 >STACK
	GET LINE,STACK >LOC
	RETURN LOC
?L5:	ADD CNT,3 >STACK
	GET LINE,STACK >LOC
	RETURN LOC
?L3:	EQUAL? RM,G \?L8
	SET 'GOAL-FLAG,1
?L8:	ADD CNT,3 >CNT
	JUMP ?L1

	.FUNCT GET-LINE,LN
	EQUAL? LN,MAIN-LINE-C \?L1
	RETURN MAIN-LINE
?L1:	EQUAL? LN,BED-LINE-C \?L3
	RETURN BED-LINE
?L3:	EQUAL? LN,TOWER-LINE-C \?L4
	RETURN TOWER-LINE
?L4:	EQUAL? LN,PASS-LINE-C \FALSE
	RETURN PASS-LINE

	.FUNCT IN-MOTION?,PERSON,DISABLED-OK=0,GT,L,F,C
	GETP PERSON,P?CHARACTER >C
	GET GOAL-TABLES,C >GT
	EQUAL? PERSON,BUTLER \?L1
	BTST PRESENT-TIME,1 \?L1
	ZERO? DISABLED-OK /FALSE
?L1:	GET GT,GOAL-S >STACK
	ZERO? STACK /FALSE
	LOC PERSON >L
	GET GT,GOAL-F >F
	EQUAL? L,F /FALSE
	ZERO? DISABLED-OK \TRUE
	GET GT,GOAL-ENABLE >STACK
	ZERO? STACK \TRUE
	RFALSE

	.FUNCT ESTABLISH-GOAL,PERSON,GOAL,SPEED=1,LOCN,GT
	LOC PERSON >LOCN
	EQUAL? LOCN,GOAL \?L1
	CALL GOAL-REACHED,PERSON >STACK
	RSTACK
?L1:	EQUAL? PERSON,CONFESSED,CAPTOR \?L4
	RETURN LOCN
?L4:	GETP PERSON,P?CHARACTER >STACK
	GET GOAL-TABLES,STACK >GT
	GETP GOAL,P?LINE >STACK
	DEC 'STACK
	MUL STACK,2 >STACK
	GETP LOCN,P?LINE >STACK
	DEC 'STACK
	MUL STACK,GOAL-I-MULTIPLIER >STACK
	ADD STACK,STACK >STACK
	PUT GT,GOAL-I,STACK
	GETP GOAL,P?STATION >STACK
	PUT GT,GOAL-S,STACK
	PUT GT,GOAL-F,GOAL
	PUT GT,GOAL-ENABLE,SPEED
	RETURN LOCN

	.FUNCT GOAL-REACHED,PERSON,GT,VAL=0
	GETP PERSON,P?CHARACTER >STACK
	GET GOAL-TABLES,STACK >GT
	PUT GT,GOAL-S,0
	PUTP PERSON,P?LDESC,0
	CALL META-LOC,PERSON >VAL
	CALL CREEPY?,VAL >STACK
	ZERO? STACK \?L1
	FSET VAL,ONBIT
?L1:	SET 'GOAL-PERSON,PERSON
	GET GT,GOAL-FUNCTION >STACK
	CALL D-APPLY,STR?166,STACK,G-REACHED >VAL
	ZERO? VAL /?L4
	RETURN VAL
?L4:	IN? PERSON,HERE \FALSE
	FSET? PERSON,TOUCHBIT /FALSE
	GETP PERSON,P?DESCFCN >STACK
	CALL STACK,M-OBJDESC >STACK
	RSTACK

	.FUNCT ENTERS?,DIR,WHERE
	EQUAL? DIR,P?IN /TRUE
	FSET? WHERE,TOUCHBIT /TRUE
	RFALSE

	.FUNCT TELL-OPEN-DOOR
	PRINTI " opens the door for a moment and"
	RTRUE

	.FUNCT TELL-HIS-HER-BEDROOM,CHR,WHERE
	EQUAL? CHR,BUTLER-C \?L1
	CALL PRINTT,WHERE
	RTRUE
?L1:	INC 'CHR
	GET CHAR-CLOSET-TABLE,CHR >STACK
	GET CHAR-ROOM-TABLE,CHR >STACK
	EQUAL? WHERE,STACK,STACK /?L6
	CALL PRINTT,WHERE
	RTRUE
?L6:	PRINTI " h"
	SUB CHR,1 >STACK
	GET CHARACTER-TABLE,STACK >STACK
	FSET? STACK,FEMALE \?L13
	PRINTI "er "
	JUMP ?L17
?L13:	PRINTI "is "
?L17:	FSET? WHERE,SECRETBIT \?L20
	PRINTI "entrance"
	RTRUE
?L20:	PRINTI "bedroom"
	RTRUE

	.FUNCT TELL-LOCKING-THE-DOOR,DOOR
	ZERO? DOOR /FALSE
	FSET? DOOR,LOCKED \FALSE
	PRINTI ", locking the door"
	RTRUE

	.FUNCT MOVE-PERSON,PERSON,WHERE,DIR,EDIR,GT=0,OL,COR,PCOR,CHR,DOOR=0,VAL=0,X,?TMP
	FSET? PERSON,MUNGBIT /FALSE
	EQUAL? PERSON,CONFESSED,CAPTOR,FOLLOWER /FALSE
	EQUAL? PERSON,BUTLER \?L4
	EQUAL? AWAITING-REPLY,BUTLER-1-R,BUTLER-2-R,BUTLER-3-R /FALSE
	EQUAL? AWAITING-REPLY,BUTLER-4-R /FALSE
?L4:	PUTP PERSON,P?LDESC,6
	EQUAL? PERSON,BUTLER \?L7
	BTST PRESENT-TIME,1 /FALSE
?L7:	GETP PERSON,P?CHARACTER >CHR
	GET GOAL-TABLES,CHR >GT
	LOC PERSON >OL
	CALL DIR-FROM,OL,WHERE >DIR
	CALL COMPASS-EQV,OL,DIR >EDIR
	SET 'GOAL-PERSON,PERSON
	ZERO? DIR /?L10
	GETPT OL,DIR >X
	ZERO? X /?L10
	PTSIZE X >STACK
	EQUAL? STACK,DEXIT \?L10
	GETB X,DEXITOBJ >DOOR
?L10:	CALL CORRIDOR-LOOK,PERSON >PCOR
	GET GT,GOAL-FUNCTION >STACK
	CALL D-APPLY,STR?167,STACK,G-ENROUTE >STACK
	EQUAL? M-FATAL,STACK \?L13
	CALL THIS-IS-IT,PERSON
	RETURN 2
?L13:	EQUAL? PERSON,PLAYER \?L17
	ZERO? DOOR /?L133
	FSET DOOR,SEENBIT
	CALL WALK-THRU-DOOR?,X >STACK
	ZERO? STACK \?L133
	RETURN 2
?L17:	ZERO? NOW-WEARING /?L26
	ZERO? LIT /?L133
	FSET? PERSON,NDESCBIT /?L133
?L26:	EQUAL? OL,HERE \?L28
	SET 'VAL,1
	CALL HE-SHE-IT,PERSON,1
	ZERO? DOOR /?L31
	FSET? DOOR,OPENBIT /?L31
	FSET DOOR,TOUCHBIT
	CALL TELL-OPEN-DOOR
?L31:	EQUAL? DIR,P?OUT \?L34
	PRINTI " leaves.
"
	JUMP ?L133
?L34:	CALL ENTERS?,DIR,WHERE >STACK
	ZERO? STACK /?L38
	PRINTI " enters"
	CALL TELL-HIS-HER-BEDROOM,CHR,WHERE
	CALL TELL-LOCKING-THE-DOOR,DOOR
	PRINTI ".
"
	JUMP ?L133
?L38:	PRINTI " walks "
	EQUAL? DIR,P?UP,P?DOWN \?L46
	CALL DIR-PRINT,DIR
	JUMP ?L51
?L46:	FSET? WHERE,TOUCHBIT \?L48
	PRINTI "to"
	CALL TELL-HIS-HER-BEDROOM,CHR,WHERE
	JUMP ?L51
?L48:	CALL DIR-PRINT,EDIR
?L51:	CALL TELL-LOCKING-THE-DOOR,DOOR
	PRINTI ".
"
	JUMP ?L133
?L28:	EQUAL? WHERE,HERE \?L54
	ZERO? NOW-WEARING \?L55
	PRINTI "When you hear the door begin to open, you"
	PRINT REMEMBER-NOT-DRESSED
	PRINTI " and hop into "
	PRINTD YOUR-BATHROOM
	PRINTI ".
"
	CALL GOTO,YOUR-BATHROOM
	SET 'VAL,M-FATAL
	JUMP ?L133
?L55:	ZERO? GT /?L60
	GET GT,GOAL-F >STACK
	EQUAL? HERE,STACK /?L133
?L60:	SET 'VAL,1
	CALL START-SENTENCE,PERSON
	ZERO? DOOR /?L61
	FSET? DOOR,OPENBIT /?L61
	FSET DOOR,TOUCHBIT
	CALL TELL-OPEN-DOOR
?L61:	EQUAL? PRSA,V?WALK \?L64
	EQUAL? OL,OHERE \?L64
	PRINTI " follows you"
	JUMP ?L75
?L64:	PRINTI " walks past you from"
	EQUAL? DIR,P?UP,P?DOWN \?L71
	PRINTC 32
	CALL OPP-DIR,DIR >STACK
	CALL DIR-PRINT,STACK
	JUMP ?L75
?L71:	CALL TELL-HIS-HER-BEDROOM,CHR,OL
?L75:	PRINTI ".
"
	JUMP ?L133
?L54:	GETP HERE,P?CORRIDOR >COR
	ZERO? COR /?L133
	ZERO? PCOR /?L80
	CALL CORRIDOR-LOOK,WHERE >STACK
	ZERO? STACK \?L82
	SET 'VAL,1
	EQUAL? PERSON,P-HER-OBJECT \?L84
	FSET? HER,TOUCHBIT \?L84
	PRINTI "She"
	JUMP ?L91
?L84:	EQUAL? PERSON,P-HIM-OBJECT \?L88
	FSET? HIM,TOUCHBIT \?L88
	PRINTI "He"
	JUMP ?L91
?L88:	CALL START-SENTENCE,PERSON
	PRINTC 44
	CALL WHERE?,PERSON,PCOR
	PRINTC 44
?L91:	ZERO? DOOR /?L96
	FSET? DOOR,OPENBIT /?L96
	FSET DOOR,TOUCHBIT
	CALL TELL-OPEN-DOOR
?L96:	CALL ENTERS?,DIR,WHERE >STACK
	ZERO? STACK /?L99
	PRINTI " enters"
	CALL TELL-HIS-HER-BEDROOM,CHR,WHERE
	JUMP ?L103
?L99:	PRINTI " disappears "
	EQUAL? DIR,P?UP,P?DOWN /?L106
	PRINTI "to the "
?L106:	CALL DIR-PRINT,EDIR
?L103:	CALL TELL-LOCKING-THE-DOOR,DOOR
	PRINTI ".
"
	JUMP ?L133
?L82:	SET 'VAL,1
	CALL START-SENTENCE,PERSON
	PRINTI " is"
	CALL WHERE?,PERSON,PCOR
	PRINTI ", heading "
	EQUAL? PCOR,DIR \?L118
	PRINTI "away from you"
	JUMP ?L125
?L118:	CALL OPP-DIR,DIR >STACK
	EQUAL? PCOR,STACK \?L122
	PRINTI "toward you"
	JUMP ?L125
?L122:	EQUAL? DIR,P?UP,P?DOWN /?L126
	PRINTI "toward the "
?L126:	CALL DIR-PRINT,EDIR
?L125:	PRINTI ".
"
	JUMP ?L133
?L80:	CALL CORRIDOR-LOOK,WHERE >PCOR
	ZERO? PCOR /?L133
	SET 'VAL,1
	CALL WHERE?,PERSON,PCOR,1
	CALL HE-SHE-IT,PERSON,0,STR?168
	SET '?TMP,HERE
	CALL DIR-FROM,WHERE,OL >STACK
	CALL COMPASS-EQV,?TMP,STACK >DIR
	EQUAL? DIR,P?IN /?L136
	PRINTI " from"
	CALL TELL-HIS-HER-BEDROOM,CHR,OL
?L136:	PRINTI ".
"
?L133:	ZERO? VAL /?L145
	IN? LUGGAGE,PERSON \?L145
	ZERO? NOW-WEARING /?L145
	CALL HE-SHE-IT,PERSON,1,STR?44
	PRINTI " carrying "
	PRINTD LUGGAGE
	PRINTI ".
"
?L145:	ZERO? PERSON /?L150
	MOVE PERSON,WHERE
?L150:	ZERO? GT /?L169
	GET GT,GOAL-F >STACK
	EQUAL? STACK,WHERE \?L155
	CALL GOAL-REACHED,PERSON >X
	ZERO? X \?L178
	EQUAL? HERE,WHERE \?L157
	FSET? PERSON,NDESCBIT /?L157
	SET 'VAL,1
	CALL HE-SHE-IT,PERSON,1
	PRINTI " enters and nods to you."
	CRLF
	JUMP ?L169
?L157:	ZERO? X /?L169
?L178:	EQUAL? VAL,M-FATAL /?L169
	SET 'VAL,X
	JUMP ?L169
?L155:	GET GT,GOAL-FUNCTION >STACK
	CALL D-APPLY,STR?167,STACK,G-ENROUTE >X
	ZERO? X \?L179
	IN? PERSON,HERE \?L164
	FSET? PERSON,TOUCHBIT /?L164
	GETP PERSON,P?DESCFCN >STACK
	CALL STACK,M-OBJDESC >X
	ZERO? X /?L169
	SET 'VAL,1
	JUMP ?L169
?L164:	ZERO? X /?L169
?L179:	EQUAL? VAL,M-FATAL /?L169
	SET 'VAL,X
?L169:	ZERO? VAL /FALSE
	CALL THIS-IS-IT,PERSON
	EQUAL? VAL,M-FATAL /?L174
	FSET WHERE,SEENBIT
	PUT FOLLOW-LOC,CHR,WHERE
?L174:	RETURN VAL

	.FUNCT COMPASS-EQV,RM,DIR,DIRTBL,DIRL,P,L,TBL,VAL=0
	EQUAL? DIR,P?UP,P?DOWN,P?IN /?L1
	EQUAL? DIR,P?OUT /?L1
	RETURN DIR
?L1:	GETPT RM,DIR >DIRTBL
	PTSIZE DIRTBL >DIRL
	SET 'P,0
?L4:	ZERO? VAL /?L6
	RETURN VAL
?L6:	NEXTP RM,P >P
	ZERO? P /FALSE
	LESS? P,P?OUT /?L4
	GETPT RM,P >TBL
	PTSIZE TBL >L
	EQUAL? L,DIRL \?L4
	DEC 'L
?L13:	GETB DIRTBL,L >STACK
	GETB TBL,L >STACK
	EQUAL? STACK,STACK \?L4
	DLESS? 'L,0 \?L13
	SET 'VAL,P
	JUMP ?L4

	.FUNCT DIR-EQV?,RM,DIR1,DIR2,DIR1TBL,DIR2TBL,L
	EQUAL? DIR1,DIR2 /TRUE
	GETPT RM,DIR1 >DIR1TBL
	ZERO? DIR1TBL /FALSE
	GETPT RM,DIR2 >DIR2TBL
	ZERO? DIR2TBL /FALSE
	PTSIZE DIR1TBL >L
	PTSIZE DIR2TBL >STACK
	EQUAL? L,STACK \FALSE
	DEC 'L
?L9:	GETB DIR2TBL,L >STACK
	GETB DIR1TBL,L >STACK
	EQUAL? STACK,STACK \FALSE
	DLESS? 'L,0 \?L9
	RTRUE

	.FUNCT DIR-FROM,HERE?1,THERE,V=0,P,D
	CALL DIR-FROM-TEST,HERE?1,THERE,P?UP >STACK
	ZERO? STACK /?L1
	RETURN P?UP
?L1:	CALL DIR-FROM-TEST,HERE?1,THERE,P?DOWN >STACK
	ZERO? STACK /?L3
	RETURN P?DOWN
?L3:	CALL DIR-FROM-TEST,HERE?1,THERE,P?IN >STACK
	ZERO? STACK /?L4
	RETURN P?IN
?L4:	CALL DIR-FROM-TEST,HERE?1,THERE,P?OUT >STACK
	ZERO? STACK /?L5
	RETURN P?OUT
?L5:	SET 'P,0
?L7:	NEXTP HERE?1,P >P
	LESS? P,P?OUT \?L9
	RETURN V
?L9:	CALL DIR-FROM-TEST,HERE?1,THERE,P >D
	ZERO? D /?L7
	LESS? D,P?OUT \?L12
	ZERO? V \?L12
	SET 'V,P
	JUMP ?L7
?L12:	RETURN P

	.FUNCT DIR-FROM-TEST,HERE?1,THERE,P,L,TBL
	GETPT HERE?1,P >TBL
	ZERO? TBL /FALSE
	PTSIZE TBL >L
	EQUAL? L,DEXIT,UEXIT,CEXIT \FALSE
	GETB TBL,REXIT >STACK
	EQUAL? STACK,THERE \FALSE
	RETURN P

	.FUNCT I-PLAYER,ARG,VAL=0
	LOC PLAYER >HERE
	EQUAL? ARG,G-REACHED \?L1
	CALL MAKE-ALL-PEOPLE,-12
	RTRUE
?L1:	EQUAL? ARG,G-ENROUTE \FALSE
	EQUAL? OHERE,HERE /FALSE
	CALL LIT? >STACK
	ZERO? STACK /?L7
	EQUAL? HERE,MAZE /?L7
	SET 'VAL,HERE
	FSET? VAL,SECRETBIT \?L8
	FSET? HERE,SEENBIT \?L7
?L8:	RANDOM 100 >STACK
	LESS? 50,STACK /FALSE
	CALL FIND-FLAG-HERE-NOT,PERSONBIT,MUNGBIT,PLAYER >VAL
	ZERO? VAL /FALSE
?L7:	PRINTI "But "
	FSET? HERE,SURFACEBIT \?L13
	PRINTI "on"
	JUMP ?L17
?L13:	PRINTI "in"
?L17:	CALL PRINTT,HERE
	ZERO? VAL \?L22
	PRINTI " you get lost in the dark"
	JUMP ?L32
?L22:	FSET? VAL,SECRETBIT \?L26
	PRINTI " you realize that you don't know the way"
	JUMP ?L32
?L26:	EQUAL? VAL,GHOST-NEW \?L29
	PRINTI " the ghost blocks your way"
	JUMP ?L32
?L29:	CALL HE-SHE-IT,VAL
	CALL PICK-ONE-NEW,PLAYER-OBSTACLES >STACK
	PRINT STACK
?L32:	PRINTI ".
"
	CALL MAKE-ALL-PEOPLE,-12
	RETURN 2

	.FUNCT GOODNIGHT,RM,PER,CLOSET=0,DR,VAL=0
	EQUAL? RM,HERE \?L1
	PRINTD PER
	CALL THIS-IS-IT,PER
	PRINTI " shows you firmly to the door, saying"
	CALL HE-SHE-IT,PER,0,STR?44
	PRINTI " going to bed."
	CRLF
	SET 'VAL,WINNER
	SET 'WINNER,PLAYER
	PUTP PER,P?LINE,0
	GETPT HERE,P?OUT >STACK
	GETB STACK,REXIT >STACK
	CALL GOTO,STACK
	SET 'WINNER,VAL
	JUMP ?L7
?L1:	EQUAL? CLOSET,HERE \?L7
	CALL FIND-FLAG-LG,CLOSET,DOORBIT,SECRETBIT >DR
	EQUAL? DR,0,SECRET-HYDE-DOOR,SECRET-IRIS-DOOR /?L7
	FSET? DR,OPENBIT \?L7
	FCLEAR DR,OPENBIT
	GETP PER,P?CHARACTER >STACK
	PUT FOUND-PASSAGES,STACK,1
	CALL LIT? >LIT
	PRINTD PER
	PRINTI " closes the "
	PRINTD DR
	PRINTI " without noticing you."
	CRLF
	SET 'VAL,1
?L7:	FCLEAR RM,ONBIT
	FSET PER,MUNGBIT
	FCLEAR RM,OPENBIT
	FSET RM,LOCKED
	EQUAL? PER,FOLLOWER \?L11
	SET 'FOLLOWER,0
?L11:	PUTP PER,P?LDESC,14
	RETURN VAL

	.FUNCT GRAB-ATTENTION,PERSON,OBJ=0,N,GT,ATT
	FSET? PERSON,MUNGBIT \?L1
	GETP PERSON,P?LDESC >STACK
	EQUAL? STACK,14 \?L3
	CALL TOO-BAD-BUT,PERSON,STR?169
	RFALSE
?L3:	CALL TOO-BAD-BUT,PERSON,STR?170
	RFALSE
?L1:	GETP PERSON,P?CHARACTER >STACK
	GET GOAL-TABLES,STACK >GT
	GET GT,GOAL-FUNCTION >STACK
	EQUAL? STACK,X-RETIRES \?L6
	EQUAL? PERSON,GHOST-NEW,CONFESSED,CAPTOR /?L6
	GETP PERSON,P?CHARACTER >STACK
	EQUAL? VARIATION,STACK /?L6
	ZERO? OBJ /?L7
	FSET? OBJ,PERSONBIT /?L7
	FSET? OBJ,RMUNGBIT /?L6
?L7:	CALL TOO-BAD-BUT,PERSON,STR?171
	RFALSE
?L6:	EQUAL? PERSON,BUTLER \?L8
	EQUAL? PRSA,V?ASK-FOR /?L9
	GET GT,GOAL-S >STACK
	ZERO? STACK /?L8
?L9:	EQUAL? PRSA,V?THANKS,V?TAKE,V?SORRY /?L8
	EQUAL? PRSA,V?NO,V?YES /?L8
	EQUAL? PRSO,DINNER,LUGGAGE /?L8
	CALL BUTLER-SORRY
	RFALSE
?L8:	CALL ANGRY-REJECT?,PERSON,OBJ >N
	ZERO? N /?L10
	EQUAL? N,1 \?L11
	PUSH STR?88
	JUMP ?L13
?L11:	PUSH STR?89
?L13:	CALL TOO-BAD-BUT,PERSON,STACK
	RFALSE
?L10:	GET GT,GOAL-S >STACK
	ZERO? STACK /?L19
	GET GT,ATTENTION-SPAN >ATT
	PUT GT,ATTENTION,ATT
	ZERO? ATT \?L17
	PUT GT,GOAL-ENABLE,1
	GET LDESC-STRINGS,17 >STACK
	CALL TOO-BAD-BUT,PERSON,STACK
	RFALSE
?L17:	PUT GT,GOAL-ENABLE,0
?L19:	SET 'QCONTEXT,PERSON
	GETP PERSON,P?LDESC >STACK
	EQUAL? STACK,21 /TRUE
	PUTP PERSON,P?LDESC,12
	RTRUE

	.FUNCT ANGRY-REJECT?,PERSON,OBJ,N
	EQUAL? PERSON,GHOST-NEW /FALSE
	GETP PERSON,P?LINE >N
	ZERO? N /FALSE
	EQUAL? PRSA,V?TELL,V?SORRY,V?FORGIVE /FALSE
	EQUAL? PRSA,V?GIVE \?L5
	EQUAL? PRSI,PERSON /FALSE
?L5:	CALL EVIDENCE?,OBJ,PERSON >STACK
	ZERO? STACK \FALSE
	RETURN N

	.FUNCT WHERE?,PER,X=0,CAP=0
	IN? PER,HERE /FALSE
	ZERO? X \?L3
	PRINTC 44
	CALL CORRIDOR-LOOK,PER >X
?L3:	ZERO? CAP \?L8
	PRINTC 32
?L8:	EQUAL? X,P?DOWN \?L11
	ZERO? CAP \?L13
	PRINTC 100
	JUMP ?L17
?L13:	PRINTC 68
?L17:	PRINTI "ownstairs"
	RTRUE
?L11:	EQUAL? X,P?IN \?L22
	ZERO? CAP \?L23
	PRINTI "in"
	JUMP ?L27
?L23:	PRINTI "In"
?L27:	LOC PER >STACK
	GETP PER,P?CHARACTER >STACK
	CALL TELL-HIS-HER-BEDROOM,STACK,STACK
	RTRUE
?L22:	EQUAL? X,P?OUT \?L30
	ZERO? CAP \?L31
	PRINTC 106
	JUMP ?L35
?L31:	PRINTC 74
?L35:	PRINTI "ust outside"
	RTRUE
?L30:	ZERO? CAP \?L41
	PRINTC 116
	JUMP ?L45
?L41:	PRINTC 84
?L45:	PRINTI "o the "
	CALL DIR-PRINT,X
	RTRUE

	.FUNCT DIR-PRINT,DIR,CNT=0,TBL,X
	ZERO? DIR \?L1
	PRINTI "out of view"
	RTRUE
?L1:	SET 'TBL,DIR-STRINGS
?L6:	GET TBL,CNT >X
	ZERO? X \?L8
	PRINTI "out of view"
	RTRUE
?L8:	EQUAL? X,DIR \?L12
	ADD CNT,1 >STACK
	GET TBL,STACK >STACK
	PRINT STACK
	RTRUE
?L12:	ADD CNT,2 >CNT
	JUMP ?L6

	.FUNCT OPP-DIR,DIR,CNT=0,X
?L1:	GET DIR-STRINGS,CNT >X
	ZERO? X /FALSE
	EQUAL? X,DIR \?L8
	MOD CNT,4 >STACK
	ZERO? STACK \?L6
	ADD CNT,2 >STACK
	GET DIR-STRINGS,STACK >STACK
	RSTACK
?L6:	SUB CNT,2 >STACK
	GET DIR-STRINGS,STACK >STACK
	RSTACK
?L8:	ADD CNT,2 >CNT
	JUMP ?L1

	.FUNCT I-TOUR,GARG=0,L
	GET TOUR-PATH,TOUR-INDEX >L
	ZERO? L \?L1
	EQUAL? FOLLOWER,FRIEND,LORD \FALSE
	SET 'FOLLOWER,0
	RFALSE
?L1:	EQUAL? HERE,GREAT-HALL \?L7
	FSET? DOCTOR,TOUCHBIT /?L7
	CALL QUEUE,I-TOUR,3
	MOVE DOCTOR,HERE
	CALL DOCTOR-D >L
	SET 'TOUR-FORCED,0
	RETURN L
?L7:	INC 'TOUR-INDEX
	SET 'AWAITING-REPLY,0
	CALL MAKE-ALL-PEOPLE,0
	CALL QUEUED?,I-FOUND-IT >STACK
	ZERO? STACK \?L10
	ZERO? TOUR-FORCED \?L10
	CRLF
?L10:	SET 'FOUND-IT,0
	CALL QUEUE,I-FOUND-IT,0
	EQUAL? L,GALLERY \?L13
	PRINTI """You two will have time to chat later,"" says "
	PRINTD FRIEND
	PRINTI ", ""but you must excuse us now, "
	EQUAL? QCONTEXT,0,FRIEND,BUTLER /?L17
	PRINTD QCONTEXT
	JUMP ?L19
?L17:	PRINTD DOCTOR
?L19:	PRINTI ", while I show "
	CALL PRINT-NAME,FIRST-NAME
	PRINTI " up to "
	ZERO? GENDER-KNOWN \?L22
	PRINTI "the "
	CALL PRINT-COLOR
	JUMP ?L29
?L22:	FSET? PLAYER,FEMALE \?L26
	PRINTI "her"
	JUMP ?L29
?L26:	PRINTI "his"
?L29:	PRINTI " bedroom. I'm sure "
	ZERO? GENDER-KNOWN \?L34
	PRINTI "our guest"
	JUMP ?L41
?L34:	FSET? PLAYER,FEMALE \?L38
	PRINTI "she"
	JUMP ?L41
?L38:	PRINTI "he"
?L41:	PRINTI " wants to freshen up for dinner!"""
	CRLF
?L13:	PRINTD FRIEND
	PRINTI " guides you "
	EQUAL? L,GALLERY \?L49
	PUTP LORD,P?LDESC,13
	PUTP DEB,P?LDESC,13
	PUTP OFFICER,P?LDESC,13
	PRINTI "up to"
	JUMP ?L53
?L49:	PRINTI "into"
?L53:	CALL PRINTT,L
	PRINTI ".

"
	FSET FRIEND,RMUNGBIT
	CALL THIS-IS-IT,FRIEND
	MOVE FRIEND,L
	EQUAL? L,GALLERY,YOUR-ROOM \?L87
	PUTP FRIEND,P?LINE,0
	PRINTI "She says, """
	EQUAL? L,GALLERY \?L62
	PRINTI "I know it's confusing, but the British call this the 'first' floor. We just left the 'ground' floor."""
	CRLF
	JUMP ?L66
?L62:	PRINTI "You'll be sleeping in the same room that Queen Victoria slept in!"""
	CRLF
?L66:	EQUAL? L,GALLERY,YOUR-ROOM /?L70
?L87:	FSET? LORD,TOUCHBIT \?L72
	FSET LORD,RMUNGBIT
?L72:	MOVE LORD,L
	PUT FOLLOW-LOC,LORD-C,L
?L70:	SET 'WINNER,PLAYER
	CALL GOTO,L,1,0
	EQUAL? L,YOUR-ROOM /?L76
	CALL QUEUE,I-TOUR,3
	JUMP ?L82
?L76:	EQUAL? FOLLOWER,FRIEND,LORD \?L79
	SET 'FOLLOWER,0
?L79:	IN? BUTLER,L \?L82
	LOC OFFICER >STACK
	CALL ESTABLISH-GOAL,FRIEND,STACK
	CALL TAMARA-LEAVES-YOU
?L82:	SET 'TOUR-FORCED,0
	RETURN 2

	.FUNCT I-FRIEND-GREETS,GARG=0
	PRINTI "When a door opens in the castle"
	FSET? FRONT-GATE,OPENBIT /?L3
	FSET FRONT-GATE,OPENBIT
	PRINTI " and the "
	PRINTD FRONT-GATE
	PRINTI " creaks open"
?L3:	PRINTI ", you decide to "
	EQUAL? HERE,COURTYARD /?L10
	MOVE CAR,COURTYARD
	PRINTI "drive through the gate and "
?L10:	PRINTI "get out of the car."
	CRLF
	CALL GOTO,COURTYARD
	RTRUE

	.FUNCT BUTLER-APPEARS,GARG=0,LL,L
	EQUAL? GARG,G-REACHED \FALSE
	GETP BUTLER,P?CHARACTER >STACK
	GET GOAL-TABLES,STACK >STACK
	PUT STACK,GOAL-FUNCTION,BUTLER-FETCHES
	PUTP BUTLER,P?LDESC,6
	FSET? COURTYARD,TOUCHBIT /?L3
	CALL ESTABLISH-GOAL,BUTLER,COURTYARD
	RFALSE
?L3:	LOC BUTLER >L
	CALL META-LOC,LUGGAGE >LL
	EQUAL? LL,YOUR-ROOM,YOUR-BATHROOM \?L6
	EQUAL? FOLLOWER,FRIEND,LORD \?L8
	SET 'FOLLOWER,0
?L8:	LOC BUTLER >STACK
	CALL ESTABLISH-GOAL,BUTLER,STACK
	RFALSE
?L6:	EQUAL? LL,L \?L11
	CALL BUTLER-FETCHES,G-REACHED
	RFALSE
?L11:	CALL ESTABLISH-GOAL,BUTLER,LL
	RFALSE

	.FUNCT BUTLER-FETCHES,GARG=0,L,LL,GT
	LOC BUTLER >L
	CALL META-LOC,LUGGAGE >LL
	GETP BUTLER,P?CHARACTER >STACK
	GET GOAL-TABLES,STACK >GT
	PUTP BUTLER,P?LDESC,6
	EQUAL? LL,YOUR-ROOM,YOUR-BATHROOM \?L1
	EQUAL? FOLLOWER,FRIEND,LORD \?L3
	SET 'FOLLOWER,0
?L3:	PUT GT,GOAL-FUNCTION,BUTLER-CARRIES
	LOC BUTLER >STACK
	CALL ESTABLISH-GOAL,BUTLER,STACK
	RFALSE
?L1:	EQUAL? L,LL \?L6
	IN? LUGGAGE,BUTLER /?L6
	PUT GT,GOAL-FUNCTION,BUTLER-CARRIES
	CALL ESTABLISH-GOAL,BUTLER,YOUR-ROOM
	FCLEAR LUGGAGE,OPENBIT
	MOVE LUGGAGE,BUTLER
	MOVE CAR,COURTYARD
	EQUAL? L,HERE \FALSE
	FSET? BUTLER,NDESCBIT /FALSE
	CALL HE-SHE-IT,BUTLER,1
	PRINTI " takes "
	PRINTD LUGGAGE
	PRINTI ".
"
	RFALSE
?L6:	EQUAL? GARG,G-REACHED \FALSE
	FSET? COURTYARD,TOUCHBIT \?L13
	CALL META-LOC,LUGGAGE >STACK
	CALL ESTABLISH-GOAL,BUTLER,STACK
	RFALSE
?L13:	CALL ESTABLISH-GOAL,BUTLER,COURTYARD
	RFALSE

	.FUNCT TAMARA-LEAVES-YOU
	CALL HE-SHE-IT,FRIEND,1
	PRINTI " turns to leave, saying, ""Here's "
	PRINTD BUTLER
	IN? LUGGAGE,BUTLER \?L3
	PRINTI " with "
	PRINTD LUGGAGE
?L3:	PRINTI ", so I'll leave you to rest or freshen up, "
	CALL PRINT-NAME,FIRST-NAME >STACK
	ZERO? STACK /?L10
	PRINTC 46
?L10:	PRINTR " Dinner's at eight, by the way -- or whenever you hear the gong."""

	.FUNCT BUTLER-CARRIES,GARG=0,L,LL=0
	LOC BUTLER >L
	EQUAL? GARG,G-ENROUTE \?L1
	EQUAL? L,FOYER \FALSE
	FCLEAR FRONT-DOOR,OPENBIT
	RFALSE
?L1:	EQUAL? GARG,G-REACHED \FALSE
	GETP BUTLER,P?CHARACTER >STACK
	GET GOAL-TABLES,STACK >STACK
	PUT STACK,GOAL-ENABLE,0
	CALL QUEUE,I-BUTLER-HINTS,7
	CALL QUEUE,I-BUTLER-COOKS,9
	PUTP BUTLER,P?LDESC,9
	FCLEAR BUTLER,NDESCBIT
	IN? LUGGAGE,BUTLER \?L7
	SET 'LL,1
	MOVE LUGGAGE,BED
?L7:	CALL QUEUED?,I-TOUR >STACK
	ZERO? STACK \?L10
	EQUAL? FRIEND,FOLLOWER /?L10
	LOC OFFICER >STACK
	CALL ESTABLISH-GOAL,FRIEND,STACK
?L10:	EQUAL? L,HERE \FALSE
	IN? FRIEND,HERE \?L15
	EQUAL? FRIEND,FOLLOWER /?L15
	CALL TAMARA-LEAVES-YOU
?L15:	PRINTI "The butler enters"
	ZERO? LL /?L20
	PRINTI " with "
	PRINTD LUGGAGE
	PRINTI " and lays it on the bed"
?L20:	SET 'QCONTEXT,BUTLER
	CALL THIS-IS-IT,BUTLER
	FSET BUTLER,TOUCHBIT
	PUTP BUTLER,P?LDESC,12
	SET 'AWAITING-REPLY,BUTLER-1-R
	CALL QUEUE,I-REPLY,CLOCKER-RUNNING
	PRINTI ".
""I regret to say, "
	CALL TITLE-NAME
	PRINTI ", that the maid will be unable to unpack for you, due to the arrangements for the late Lord Lionel's memorial birthday dinner,"" he apologizes. """
	GET QUESTIONS,AWAITING-REPLY >STACK
	PRINT STACK
	PRINTI """
"
	RETURN 2

	.FUNCT I-BUTLER-HINTS,GARG=0,SAID=0
	EQUAL? AWAITING-REPLY,BUTLER-1-R,BUTLER-2-R /?L3
	EQUAL? AWAITING-REPLY,BUTLER-3-R,BUTLER-4-R \?L1
?L3:	CALL QUEUE,I-BUTLER-HINTS,1
	RETURN SAID
?L1:	LESS? 2,BUTLER-HINTS-COUNTER \?L4
	CALL QUEUE,I-BUTLER-HINTS,0
	RFALSE
?L4:	LOC BUTLER >STACK
	EQUAL? HERE,STACK \?L5
	GETP BUTLER,P?LINE >STACK
	ZERO? STACK \?L5
	SET 'SAID,1
	GETP BUTLER,P?CHARACTER >STACK
	GET GOAL-TABLES,STACK >STACK
	PUT STACK,ATTENTION,5
	INC 'BUTLER-HINTS-COUNTER
	CALL QUEUE,I-BUTLER-HINTS,2
	SET 'QCONTEXT,BUTLER
	CALL THIS-IS-IT,BUTLER
	PUTP BUTLER,P?LDESC,12
	EQUAL? 1,BUTLER-HINTS-COUNTER \?L6
	SET 'AWAITING-REPLY,BUTLER-2-R
	CALL QUEUE,I-REPLY,CLOCKER-RUNNING
	PRINTD BUTLER
	PRINTI " coughs diffidently and asks, """
	CALL TITLE-NAME
	PRINTI "? "
	GET QUESTIONS,AWAITING-REPLY >STACK
	PRINT STACK
	PRINTI """
"
	SET 'SAID,M-FATAL
	RETURN SAID
?L6:	EQUAL? 2,BUTLER-HINTS-COUNTER \?L10
	IN? MACE,BUTLER \FALSE
	SET 'AWAITING-REPLY,BUTLER-3-R
	CALL QUEUE,I-REPLY,CLOCKER-RUNNING
	PRINTI "
"""
	GET QUESTIONS,AWAITING-REPLY >STACK
	PRINT STACK
	PRINTI """ adds "
	PRINTD BUTLER
	PRINTI ".
"
	SET 'SAID,M-FATAL
	RETURN SAID
?L10:	EQUAL? 3,BUTLER-HINTS-COUNTER \?L41
	CALL I-BUTLER-COOKS
	FSET? SECRET-YOUR-DOOR,OPENBIT /?L17
	PRINTI """Ah, by the way, "
	CALL TITLE-NAME
	PRINTI " -- s"
	CALL BUTLER-MIRROR-STORY
	PRINTI "Without explaining further, "
	PRINTD BUTLER
	EQUAL? HERE,YOUR-ROOM \?L23
	PUT FOLLOW-LOC,BUTLER-C,GALLERY
	MOVE BUTLER,GALLERY
	PUTP BUTLER,P?LDESC,6
	PRINTI " abruptly leaves the room."
	CRLF
	RETURN SAID
?L23:	PUTP BUTLER,P?LDESC,20
	PRINTI " turns to his work."
	CRLF
	RETURN SAID
?L17:	PRINTI """I hope you have a pleasant stay with us, "
	CALL TITLE-NAME >STACK
	ZERO? STACK /?L33
	PRINTC 46
?L33:	PRINTI " Dinner is at eight."""
	CRLF
	RETURN SAID
?L5:	IN? BUTLER,LOCAL-GLOBALS /?L41
	CALL QUEUE,I-BUTLER-HINTS,1
?L41:	RETURN SAID

	.FUNCT I-BUTLER-COOKS,GARG=0,VAL=0
	EQUAL? AWAITING-REPLY,BUTLER-1-R,BUTLER-2-R,BUTLER-3-R /?L3
	EQUAL? AWAITING-REPLY,BUTLER-4-R /?L3
	EQUAL? 3,BUTLER-HINTS-COUNTER /?L1
	CALL I-BUTLER-HINTS >VAL
	ZERO? VAL /?L1
?L3:	CALL QUEUE,I-BUTLER-COOKS,2
	RETURN VAL
?L1:	IN? DINNER,KITCHEN \?L4
	PUTP BUTLER,P?LDESC,17
	GETP BUTLER,P?CHARACTER >STACK
	GET GOAL-TABLES,STACK >STACK
	PUT STACK,GOAL-FUNCTION,BUTLER-COOKS
	CALL ESTABLISH-GOAL,BUTLER,KITCHEN
	RETURN VAL
?L4:	CALL BUTLER-COOKS,G-REACHED
	RETURN VAL

	.FUNCT BUTLER-COOKS,GARG=0,N
	EQUAL? GARG,G-REACHED \FALSE
	PUTP BUTLER,P?LDESC,11
	SUB 472,PRESENT-TIME >N
	GRTR? N,0 /?L3
	SET 'N,1
?L3:	IN? DINNER,KITCHEN \?L6
	CALL QUEUE,I-BUTLER-SERVES,N
	RFALSE
?L6:	GETP BUTLER,P?CHARACTER >STACK
	GET GOAL-TABLES,STACK >STACK
	PUT STACK,GOAL-FUNCTION,BUTLER-LEAVES
	PUTP BUTLER,P?LDESC,17
	CALL ESTABLISH-GOAL,BUTLER,KITCHEN
	RFALSE

	.FUNCT I-BUTLER-SERVES,GARG=0
	MOVE DINNER,BUTLER
	PUTP BUTLER,P?LDESC,17
	GETP BUTLER,P?CHARACTER >STACK
	GET GOAL-TABLES,STACK >STACK
	PUT STACK,GOAL-FUNCTION,BUTLER-SERVES
	CALL ESTABLISH-GOAL,BUTLER,DINING-ROOM
	IN? BUTLER,HERE \FALSE
	PRINTD BUTLER
	PRINTR " takes dinner."

	.FUNCT BUTLER-SERVES,GARG=0
	EQUAL? GARG,G-REACHED \FALSE
	EQUAL? HERE,DINING-ROOM \?L3
	CALL HE-SHE-IT,BUTLER,1
	PRINTI " appears"
?L3:	IN? DINNER,BUTLER \?L8
	EQUAL? HERE,DINING-ROOM \?L10
	PRINTI ", puts dinner on the "
	PRINTD SIDEBOARD
?L10:	MOVE DINNER,SIDEBOARD
?L8:	IN? LETTER,BUTLER \?L16
	EQUAL? HERE,DINING-ROOM \?L18
	FCLEAR LETTER,NDESCBIT
	PRINTI ", leaves a note on Jack's napkin"
?L18:	MOVE LETTER,TABLE-DINING
	FSET LETTER,TAKEBIT
?L16:	FSET CLUE-1,TAKEBIT
	PUTP BUTLER,P?LDESC,17
	GETP BUTLER,P?CHARACTER >STACK
	GET GOAL-TABLES,STACK >STACK
	PUT STACK,GOAL-FUNCTION,BUTLER-LEAVES
	CALL ESTABLISH-GOAL,BUTLER,KITCHEN
	EQUAL? HERE,DINING-ROOM \FALSE
	PRINTR ", and looks around the room."

	.FUNCT X-WAITS,GARG=0
	EQUAL? GARG,G-REACHED \FALSE
	PUTP GOAL-PERSON,P?LDESC,9
	RFALSE

	.FUNCT I-DINNER,GARG=0,N,CH,SAID=0
	SET 'N,MASS-COUNTER
?L1:	IGRTR? 'N,DEB-C \?L3
	SET 'MASS-SAID,0
	SET 'MASS-COUNTER,0
	CALL QUEUED?,I-DINNER-SIT >STACK
	ZERO? STACK \FALSE
	CALL QUEUE,I-DINNER-SIT,5
	RFALSE
?L3:	EQUAL? N,FRIEND-C \?L8
	CALL QUEUED?,I-TOUR >STACK
	ZERO? STACK /?L8
	CALL QUEUE,I-TOUR,1
	RFALSE
?L8:	GET CHARACTER-TABLE,N >CH
	EQUAL? CH,FOLLOWER \?L10
	SET 'FOLLOWER,0
?L10:	EQUAL? CH,SHOOTER /?L1
	FSET? CH,MUNGBIT /?L1
	IN? CH,DINING-ROOM /?L1
	CALL QUEUE,I-DINNER,1
	SET 'MASS-COUNTER,N
	GET GOAL-TABLES,N >STACK
	PUT STACK,GOAL-FUNCTION,X-WAITS
	CALL ESTABLISH-GOAL,CH,DINING-ROOM
	CALL META-LOC,CH >STACK
	EQUAL? STACK,HERE \?L16
	EQUAL? HERE,DINING-ROOM /?L16
	ZERO? MASS-SAID /?L18
	EQUAL? CH,FOLLOWER \?L16
?L18:	SET 'SAID,1
	SET 'MASS-SAID,1
	EQUAL? CH,FOLLOWER \?L19
	SET 'FOLLOWER,0
?L19:	CALL HE-SHE-IT,CH,1
	PRINTI " says, ""It's time for dinner now. "
	EQUAL? NOW-WEARING,DINNER-OUTFIT \?L26
	ZERO? WASHED \?L24
?L26:	PRINTI "I'll see you in"
	JUMP ?L29
?L24:	PRINTI "Let's go to"
?L29:	PRINTI " the "
	PRINTD DINING-ROOM
	PRINTI "."""
	CRLF
?L16:	RETURN SAID

	.FUNCT BUTLER-RINGS-BELL?,FAKE=0,P
	ZERO? FAKE \?L3
	ZERO? BUTLER-RANG-BELL? \FALSE
?L3:	SET 'BUTLER-RANG-BELL?,1
	CALL QUEUE,I-DINNER,1
	FSET CLUE-1,TAKEBIT
	ZERO? FAKE \?L4
	EQUAL? HERE,KITCHEN \?L4
	PRINTD BUTLER
	GET FOLLOW-LOC,BUTLER-C >STACK
	EQUAL? HERE,STACK /?L8
	PRINTI " appears and"
?L8:	PRINTI " pushes a hidden button. "
?L4:	PRINTI "Suddenly, the dinner bell sounds"
	PRINTR "."

	.FUNCT BUTLER-LEAVES,GARG=0,L,VAL=0
	EQUAL? GARG,G-REACHED \FALSE
	CALL BUTLER-RINGS-BELL? >VAL
	MOVE BUTLER,LOCAL-GLOBALS
	PUT FOLLOW-LOC,BUTLER-C,0
	EQUAL? HERE,DINING-ROOM \?L3
	CALL QUEUE,I-DINNER-SIT,1
	JUMP ?L5
?L3:	EQUAL? HERE,KITCHEN \?L5
	PRINTI "Then he "
	IN? MACE,BUTLER \?L8
	PRINTI "drops "
	CALL PRINTA,MACE
	PRINTI ", "
?L8:	PRINTI "bids you good night, ducks into the areaway, locks the door behind him, and leaves the castle."
	CRLF
	SET 'VAL,M-FATAL
?L5:	IN? MACE,BUTLER \?L16
	FCLEAR MACE,NDESCBIT
	MOVE MACE,KITCHEN
?L16:	RETURN VAL

	.FUNCT I-DINNER-SIT,GARG=0,SAID=0
	ZERO? DINNER-SAT \FALSE
	FSET? DINNER,TAKEBIT /?L4
	CALL POPULATION,DINING-ROOM,PLAYER >STACK
	SUB DINNER-FOR,STACK >STACK
	LESS? 1,STACK \?L3
?L4:	LESS? DINNER-SIT-COUNTER,20 \?L7
	INC 'DINNER-SIT-COUNTER
	MOD DINNER-SIT-COUNTER,8 >STACK
	ZERO? STACK \?L7
	EQUAL? HERE,KITCHEN /?L7
	CALL BUTLER-RINGS-BELL?,1
	RTRUE
?L7:	CALL QUEUE,I-DINNER-SIT,1
	RFALSE
?L3:	SET 'DINNER-SAT,1
	SUB LIONEL-TIME,PRESENT-TIME >STACK
	CALL QUEUE,I-LIONEL-SPEAKS,STACK
	CALL MAKE-ALL-PEOPLE,10,DINING-ROOM
	FSET DINNER,TAKEBIT
	FCLEAR DINNER,TRYTAKEBIT
	MOVE DINNER-2,TABLE-DINING
	CALL BUTLER-RINGS-BELL?
	EQUAL? DINING-ROOM,HERE \?L12
	SET 'SAID,M-FATAL
	MOVE DINNER,TABLE-DINING
	PRINTD DEB
	PRINTI " playfully suggests"
	EQUAL? VARIATION,FRIEND-C \?L16
	CALL THIS-IS-IT,LORD
	PRINTI " to "
	PRINTD LORD
?L16:	PRINTI " that everyone form a self-serve food line at the buffet. "
	CALL HE-SHE-IT,LORD,1
	PRINTI " and the others good-naturedly accept her suggestion."
	CRLF
	IN? LETTER,TABLE-DINING \?L23
	PRINTI "As "
	PRINTD LORD
	PRINTI " takes his place as host, he notices a note lying on his napkin. He picks it up and reads it with a troubled expression."
	CRLF
?L23:	CALL DINNER-TALK,28
	JUMP ?L28
?L12:	SET 'MISSED-DINNER,1
?L28:	IN? LETTER,TABLE-DINING \?L29
	MOVE LETTER,LORD
	FCLEAR LETTER,NDESCBIT
?L29:	RETURN SAID

	.FUNCT I-LIONEL-SPEAKS,GARG=0,SAID=0,P
	DEC 'LIONEL-SPEAKS-COUNTER
	ZERO? LIONEL-SPEAKS-COUNTER /?L1
	CALL QUEUE,I-LIONEL-SPEAKS,2
	JUMP ?L3
?L1:	CALL QUEUE,I-WITHDRAW,9
?L3:	SET 'P,SEARCHER
	ZERO? P /?L4
	IN? P,DINING-ROOM \?L6
	IN? CLUE-1,SIDEBOARD \?L6
	FSET? CLUE-1,TOUCHBIT \?L4
?L6:	SET 'P,0
?L4:	EQUAL? 5,LIONEL-SPEAKS-COUNTER \?L8
	MOVE VOICE,DINING-ROOM
	CALL MAKE-ALL-PEOPLE,16,DINING-ROOM
	JUMP ?L11
?L8:	EQUAL? 1,LIONEL-SPEAKS-COUNTER \?L10
	FCLEAR CLUE-2,NDESCBIT
	FCLEAR CLUE-2,SECRETBIT
	FCLEAR CLUE-1,SECRETBIT
	JUMP ?L11
?L10:	ZERO? LIONEL-SPEAKS-COUNTER \?L11
	ZERO? P /?L12
	FSET CLUE-1,TAKEBIT
	FCLEAR CLUE-1,NDESCBIT
	MOVE CLUE-1,P
?L12:	MOVE VOICE,LOCAL-GLOBALS
	CALL MAKE-ALL-PEOPLE,18,DINING-ROOM
?L11:	EQUAL? DINING-ROOM,HERE \?L65
	SET 'SAID,M-FATAL
	ZERO? LIONEL-FORCED /?L18
	SET 'LIONEL-FORCED,0
	JUMP ?L20
?L18:	CRLF
?L20:	EQUAL? 5,LIONEL-SPEAKS-COUNTER \?L21
	CALL THIS-IS-IT,BUST
	FSET BUST,OPENBIT
	PRINTD LORD
	PRINTI " and his guests are startled as an unexpected voice suddenly speaks!
""Good evening, all,"" it says, then breaks into a low chuckle.
""Good Lord!"" Jack gasps. ""That's Uncle "
	PRINT LIONELS-VOICE
	PRINTI "!""
"
	PRINTD DOCTOR
	PRINTI " points to"
	CALL PRINTT,BUST
	PRINTI ". ""There's where it's coming from!"""
	CRLF
	RETURN SAID
?L21:	EQUAL? 4,LIONEL-SPEAKS-COUNTER \?L25
	PRINT LIONELS-VOICE
	PRINTI " continues, ""You are all here, I trust, to honor the wish expressed in my will -- that the seven of you should dine together at "
	PRINTD CASTLE
	PRINTI " on the evening of my birthday."""
	CRLF
	RETURN SAID
?L25:	EQUAL? 3,LIONEL-SPEAKS-COUNTER \?L28
	CALL THIS-IS-IT,ARTIFACT
	CALL THIS-IS-IT,LORD
	PRINT LIONELS-VOICE
	PRINTI " continues, ""As you know, I enjoyed adventuring to remote corners of the world. And doubtless you've all heard of the loss of that valuable artifact, which I brought back from one of my expeditions, have you not?""
The guests nod or mumble vaguely. They all glance toward Jack, as if looking for an official response."
	CRLF
	RETURN SAID
?L28:	EQUAL? 2,LIONEL-SPEAKS-COUNTER \?L31
	PRINT LIONELS-VOICE
	PRINTI " goes on, "
	EQUAL? LORD-C,VARIATION \?L34
	CALL THIS-IS-IT,LORD
	PRINTI """Jack, I'm sure, is only too eager for me to shuffle off this mortal coil so he can inherit the family title and estate. Thus he should be particularly interested in what I'm about to say..."" Once again "
	PRINT LIONELS-VOICE
	PRINTI " chuckles slyly, then continues."
	CRLF
?L34:	CALL THIS-IS-IT,PUNCHBOWL
	PRINTI """The truth is that the artifact is not lost, but hidden. Although I am not yet ready to reveal what it is, I suggest you look under the "
	PRINTD PUNCHBOWL
	PRINTI "."""
	CRLF
	RETURN SAID
?L31:	EQUAL? 1,LIONEL-SPEAKS-COUNTER \?L41
	CALL THIS-IS-IT,CLUE-2
	PRINTI """This "
	PRINTD CLUE-1
	PRINTI " is merely to sharpen your wits,[RWD_ID: goal:1278, VAL: 1]"" "
	PRINT LIONELS-VOICE
	PRINTI " goes on.
"""
	PRINTD LOVER
	PRINTI ", my dear: your one goal in life, I believe, is to become Jack's wife, heaven knows why! Not being Cupid, there is little I can do to help. Knowing the others, I suspect each one has private reasons for wanting my "
	PRINTD ARTIFACT
	PRINTI ". So, for your amusement, I have given a "
	PRINTD CLUE-2
	PRINTI " to my "
	EQUAL? VARIATION,LORD-C \?L44
	PRINTI "dear friend"
	JUMP ?L48
?L44:	PRINTI "heir"
?L48:	PRINTI ", which may start you down the path to finding it.""
With another sardonic chuckle, "
	PRINT LIONELS-VOICE
	PRINTI " adds, ""Perhaps, "
	EQUAL? VARIATION,LORD-C \?L53
	CALL THIS-IS-IT,PAINTER
	PRINTD PAINTER
	JUMP ?L57
?L53:	CALL THIS-IS-IT,LORD
	PRINTD LORD
?L57:	PRINTI ", you would care to SHARE your clue with all the others -- eh, what?"""
	CRLF
	RETURN SAID
?L41:	ZERO? LIONEL-SPEAKS-COUNTER \?L65
	PRINT LIONELS-VOICE
	PRINTI " finishes, ""So now, my friends, let the game begin!"""
	CRLF
	ZERO? P /?L65
	PRINTD P
	PRINTI " says, ""Well, I for one want to see that "
	PRINTD CLUE-1
	PRINTI "."" "
	CALL THIS-IS-IT,P
	CALL HE-SHE-IT,P,1
	PRINTI " lifts the "
	PRINTD PUNCHBOWL
	PRINTI " and takes it."
	CRLF
?L65:	RETURN SAID

	.FUNCT MAKE-ALL-PEOPLE,NUM,RM=0,P,NNUM
	ZERO? RM \?L1
	SET 'RM,HERE
?L1:	LESS? NUM,0 \?L4
	SUB 0,NUM >NNUM
?L4:	FIRST? RM >P \TRUE
?L10:	FSET? P,PERSONBIT \?L15
	GRTR? NUM,0 \?L13
	PUTP P,P?LDESC,NUM
	JUMP ?L15
?L13:	GETP P,P?LDESC >STACK
	EQUAL? NNUM,STACK \?L15
	PUTP P,P?LDESC,0
?L15:	NEXT? P >P /?L10
	RTRUE

	.FUNCT I-WITHDRAW,GARG=0,OBJ,NXT,SAID=0,?TMP
	ZERO? TREASURE-FOUND \?L1
	CALL QUEUE,I-SEARCH,9
	GETP SEARCHER,P?CHARACTER >STACK
	GET GOAL-TABLES,STACK >STACK
	PUT STACK,GOAL-FUNCTION,X-SEARCHES
?L1:	SUB BED-TIME,PRESENT-TIME >STACK
	CALL QUEUE,I-BEDTIME,STACK
	EQUAL? HERE,DINING-ROOM,CORR-1,SITTING-ROOM \?L4
	SET 'P-HIM-OBJECT,0
	SET 'P-HER-OBJECT,0
	SET 'SAID,1
	PRINTI "
Normally the gentlemen would remain at the table to enjoy cigars and port, while the ladies repair to the "
	PRINTD DRAWING-ROOM
	PRINTI ". But because of tonight's mysterious developments, everyone "
	EQUAL? HERE,DINING-ROOM \?L8
	PRINTI "leaves the "
	PRINTD DINING-ROOM
	JUMP ?L12
?L8:	PRINTI "goes to the "
	PRINTD SITTING-ROOM
?L12:	PRINTI " by unspoken agreement."
	CRLF
	JUMP ?L19
?L4:	EQUAL? HERE,JACK-ROOM,TAMARA-ROOM,IRIS-ROOM /?L18
	EQUAL? HERE,WENDISH-ROOM,VIVIEN-ROOM,IAN-ROOM /?L18
	EQUAL? HERE,HYDE-ROOM \?L19
?L18:	SET '?TMP,CHARACTER-TABLE
	CALL ZMEMQ,HERE,CHAR-ROOM-TABLE >STACK
	DEC 'STACK
	GET ?TMP,STACK >STACK
	LOC STACK >STACK
	EQUAL? STACK,HERE,LOCAL-GLOBALS /?L19
	SET 'DISCOVERED-HERE,HERE
	CALL QUEUE,I-DISCOVERED,1
?L19:	LOC DINNER >STACK
	FSET? STACK,PERSONBIT \?L23
	MOVE DINNER,TABLE-DINING
?L23:	LOC DINNER-2 >STACK
	FSET? STACK,PERSONBIT \?L26
	MOVE DINNER-2,TABLE-DINING
?L26:	FIRST? DINING-ROOM >OBJ /?L29
?L29:	NEXT? OBJ >NXT \?L32
?L33:	FSET? OBJ,PERSONBIT \?L36
	EQUAL? OBJ,PLAYER,CONFESSED,CAPTOR /?L36
	PUTP OBJ,P?LDESC,18
	GETP OBJ,P?CHARACTER >STACK
	PUT FOLLOW-LOC,STACK,SITTING-ROOM
	MOVE OBJ,SITTING-ROOM
?L36:	SET 'OBJ,NXT
	NEXT? OBJ >NXT /?L33
?L32:	EQUAL? HERE,DINING-ROOM \?L41
	SET 'WINNER,PLAYER
	CALL GOTO,SITTING-ROOM
?L41:	RETURN SAID

	.FUNCT I-SEARCH,GARG=0,SAID=0,GT,L,X=0
	LOC SEARCHER >L
	EQUAL? L,DISCOVERED-HERE /?L3
	CALL QUEUED?,I-LIONEL-SPEAKS >STACK
	ZERO? STACK /?L1
?L3:	CALL QUEUE,I-SEARCH,3
	RFALSE
?L1:	CALL QUEUE,I-SEARCH,19
	RANDOM 6 >STACK
	INC 'STACK
	GET CHARACTER-TABLE,STACK >X
	IN? X,SITTING-ROOM \?L21
	EQUAL? X,FOLLOWER,CONFESSED,CAPTOR /?L21
	GETP X,P?LDESC >STACK
	EQUAL? STACK,22 /?L21
	PUTP X,P?LDESC,22
	EQUAL? HERE,SITTING-ROOM \?L7
	SET 'SAID,1
	CALL THIS-IS-IT,X
	PRINTD X
	PRINTI " begins "
	GET LDESC-STRINGS,22 >STACK
	PRINT STACK
	PRINTI "."
?L7:	NEXT? X >X \?L13
	FSET? X,PERSONBIT \?L13
	EQUAL? X,PLAYER /?L13
	ZERO? SAID /?L15
	GETP X,P?LDESC >STACK
	EQUAL? STACK,22 \?L15
	CALL THIS-IS-IT,X
	PRINTI " And "
	PRINTD X
	PRINTI " stops."
?L15:	PUTP X,P?LDESC,13
?L13:	ZERO? SAID /?L21
	CRLF
?L21:	SET 'X,DEB-C
?L25:	GET CHARACTER-TABLE,X >GT
	EQUAL? GT,FOLLOWER /?L27
	CALL META-LOC,GT >STACK
	EQUAL? STACK,HERE,SITTING-ROOM /?L27
	CALL IN-MOTION?,GT >STACK
	ZERO? STACK \?L27
	GETP GT,P?LDESC >STACK
	EQUAL? STACK,7 /?L27
	GET GOAL-TABLES,X >STACK
	GET STACK,GOAL-FUNCTION >STACK
	EQUAL? STACK,X-RETIRES,X-SEARCHES /?L27
	GET GOAL-TABLES,X >STACK
	PUT STACK,GOAL-FUNCTION,NULL-F
	CALL ESTABLISH-GOAL,GT,SITTING-ROOM
?L27:	DLESS? 'X,1 \?L25
	ZERO? CONFESSED \FALSE
	GETP SEARCHER,P?CHARACTER >STACK
	GET GOAL-TABLES,STACK >GT
	GET GT,GOAL-FUNCTION >STACK
	EQUAL? STACK,X-SEARCHES \?L46
?L38:	SET 'X,CLUE-LOC
	ZERO? X /?L40
	CALL ZMEMQ,X,SEARCH-ROOMS >STACK
	ZERO? STACK /?L40
	SET 'CLUE-LOC,0
	JUMP ?L42
?L40:	CALL PICK-ONE,SEARCH-ROOMS >X
?L42:	EQUAL? X,L /?L38
	CALL ESTABLISH-GOAL,SEARCHER,X
	EQUAL? HERE,L \?L46
	SET 'SAID,1
	PRINTI "
Suddenly"
	CALL HE-SHE-IT,SEARCHER
	PRINTI " heads for the "
	EQUAL? HERE,MAZE,GARDEN \?L50
	PRINTI "exit"
	JUMP ?L54
?L50:	PRINTI "door"
?L54:	PRINTI ", mumbling, ""Please excuse me."""
	CRLF
?L46:	RETURN SAID

	.FUNCT X-SEARCHES,GARG=0,VAL=0
	EQUAL? GARG,G-REACHED \?L1
	PUTP GOAL-PERSON,P?LDESC,21
?L1:	RETURN VAL

	.FUNCT I-DISCOVERED,GARG=0,VAL=0,L,GT
	EQUAL? DISCOVERED-HERE,HERE \?L1
	ZERO? LIONEL-SPEAKS-COUNTER \?L1
	CALL ZMEMQ,HERE,CHAR-ROOM-TABLE >STACK
	SUB STACK,1 >L
	GET CHARACTER-TABLE,L >VAL
	ZERO? GARG \?L9
	IN? VAL,HERE /FALSE
	FSET? VAL,MUNGBIT /FALSE
	EQUAL? VAL,CONFESSED /FALSE
	GETP VAL,P?CHARACTER >STACK
	GET GOAL-TABLES,STACK >STACK
	GET STACK,GOAL-FUNCTION >STACK
	EQUAL? STACK,X-RETIRES /FALSE
?L9:	PUT FOLLOW-LOC,L,HERE
	CALL QUEUE,I-FOUND-IT,0
	EQUAL? VAL,GHOST-NEW \?L12
	MOVE GHOST-NEW,HERE
	CALL GHOST-LURKS
	RETURN 2
?L12:	PRINTI "You freeze as"
	FSET? HERE,LOCKED \?L21
	FCLEAR HERE,LOCKED
	PRINTI " a key turns in the lock,"
?L21:	PRINTI " the door bursts open and"
	FCLEAR HERE,OPENBIT
	GETP VAL,P?LINE >STACK
	INC 'STACK
	PUTP VAL,P?LINE,STACK
	PUTP VAL,P?LDESC,4
	CALL HE-SHE-IT,VAL
	PRINTI " appears. "
	CALL HE-SHE-IT,VAL,1
	PRINTI " stares at you with a shocked look. "
	PRINTI """Well! I didn't expect MY room to be searched!"""
	CALL HE-SHE-IT,VAL
	PRINTI " says angrily. "
	LOC VAL >L
	MOVE VAL,HERE
	GETP VAL,P?CHARACTER >STACK
	GET GOAL-TABLES,STACK >GT
	GET GT,GOAL-S >STACK
	ZERO? STACK \?L36
	CALL ESTABLISH-GOAL,VAL,L
	JUMP ?L38
?L36:	GET GT,GOAL-F >STACK
	CALL ESTABLISH-GOAL,VAL,STACK
?L38:	PUT GT,GOAL-ENABLE,0
	CALL HE-SHE-IT,VAL,1
	PRINTI " enters the room and closes the door behind"
	CALL HIM-HER-IT,VAL
	PRINTI ".
"
	IN? BLOWGUN,VAL \?L41
	EQUAL? VAL,PAINTER,DOCTOR \?L41
	CALL FIND-FLAG-HERE,PERSONBIT,PLAYER,VAL >STACK
	ZERO? STACK \?L41
	CALL SETUP-SHOT,VAL
	PRINTI "Then"
	CALL HE-SHE-IT,VAL
	PRINTI " pulls out"
	CALL PRINTT,BLOWGUN
	PRINTI "!"
	CRLF
?L41:	SET 'VAL,M-FATAL
?L1:	RETURN VAL

	.FUNCT I-FOUND-PASSAGES,GARG=0,SAID=0,X
	FIRST? HERE >X \?L2
	CALL FOUND-PASSAGES-REPEAT,X,PASSAGE,FOUND-PASSAGES >SAID
?L2:	FSET? HERE,SECRETBIT \?L8
	CALL FIND-FLAG-LG,HERE,DOORBIT >X
	ZERO? X /?L8
	CALL DOOR-ROOM,HERE,X >X
	ZERO? X /?L8
	FIRST? X >X /?L13
	RETURN SAID
?L13:	CALL FOUND-PASSAGES-REPEAT,X,PASSAGE,FOUND-PASSAGES >STACK
	ZERO? STACK /?L8
	SET 'SAID,1
?L8:	RETURN SAID

	.FUNCT FOUND-PASSAGES-REPEAT,PER,OBJ,GL,C,SAID=0
	ZERO? PER /?L2
?L3:	FSET? PER,PERSONBIT \?L14
	FSET? PER,MUNGBIT /?L14
	PUTP PER,P?LDESC,3
	GETP PER,P?CHARACTER >C
	GET GL,C >STACK
	ZERO? STACK \?L14
	PUT GL,C,1
	EQUAL? C,VARIATION /?L14
	PUTP PER,P?LINE,0
	ZERO? SAID \?L14
	SET 'SAID,PER
	EQUAL? OBJ,PASSAGE \?L14
	CALL GOOD-SHOW,PER,OBJ
?L14:	NEXT? PER >PER /?L3
?L2:	RETURN SAID

	.FUNCT I-BEDTIME,GARG=0,N,CH,VAL=0,L
	SET 'N,MASS-COUNTER
	IGRTR? 'N,DEB-C \?L1
	SET 'MASS-SAID,0
	SET 'MASS-COUNTER,0
	RFALSE
?L1:	CALL QUEUE,I-BEDTIME,5
	SET 'MASS-COUNTER,N
	GET CHARACTER-TABLE,N >CH
	EQUAL? CH,SEARCHER \?L4
	CALL QUEUE,I-SEARCH,0
?L4:	EQUAL? CH,CONFESSED,CAPTOR /FALSE
	FSET? CH,MUNGBIT /FALSE
	GET GOAL-TABLES,N >STACK
	PUT STACK,GOAL-FUNCTION,X-RETIRES
	ADD 1,N >STACK
	GET CHAR-ROOM-TABLE,STACK >STACK
	CALL ESTABLISH-GOAL,CH,STACK
	CALL META-LOC,CH >L
	CALL OUTSIDE?,L >STACK
	ZERO? STACK \?L11
	CALL FIND-FLAG,L,PERSONBIT,CH >STACK
	ZERO? STACK \?L11
	FCLEAR L,ONBIT
?L11:	EQUAL? L,HERE \?L14
	ZERO? MASS-SAID /?L16
	EQUAL? CH,FOLLOWER \?L20
?L16:	SET 'MASS-SAID,1
	SET 'VAL,1
	PUTP CH,P?LDESC,17
	PRINTD CH
	PRINTI " says, ""It's time for bed now. I'll see you in the morning."""
	CRLF
?L14:	EQUAL? CH,FOLLOWER \?L20
	SET 'FOLLOWER,0
?L20:	RETURN VAL

	.FUNCT FRIEND-PASSAGE-STORY
	PRINTI """Guess what? I just discovered a "
	PRINTD PASSAGE
	PRINTR " in my room! But it's so late that I'm going to bed now. We'll explore in the morning."""

	.FUNCT X-RETIRES,GARG=0,L,RM,C,VAL=0,OBJ,GT
	LOC GOAL-PERSON >L
	EQUAL? GOAL-PERSON,CONFESSED,CAPTOR /FALSE
	EQUAL? GARG,G-IMPATIENT \?L3
	EQUAL? L,HERE \?L9
	SET 'VAL,1
	CALL HE-SHE-IT,GOAL-PERSON,1
	PRINTI " says, ""I'm dead tired. Good night."""
	CRLF
	RETURN VAL
?L3:	EQUAL? GARG,G-REACHED \?L9
	GETP GOAL-PERSON,P?CHARACTER >C
	ADD 1,C >STACK
	GET CHAR-ROOM-TABLE,STACK >RM
	GET GOAL-TABLES,C >GT
	EQUAL? L,RM /?L18
	FSET? L,SECRETBIT /?L12
	CALL ESTABLISH-GOAL,GOAL-PERSON,RM
	RFALSE
?L12:	CALL FIND-FLAG-LG,L,DOORBIT >OBJ
	ZERO? OBJ /?L15
	FSET OBJ,OPENBIT
?L15:	CALL MOVE-PERSON,GOAL-PERSON,RM >VAL
	ZERO? OBJ /?L18
	FCLEAR OBJ,OPENBIT
?L18:	CALL FIND-FLAG,RM,SURFACEBIT >OBJ
	ZERO? OBJ /?L22
	CALL ROB,GOAL-PERSON,OBJ
	JUMP ?L24
?L22:	CALL ROB,GOAL-PERSON,RM
?L24:	FCLEAR RM,OPENBIT
	FSET RM,LOCKED
	EQUAL? VARIATION,LORD-C \?L25
	SET 'RM,LIMBO
?L25:	EQUAL? GOAL-PERSON,FRIEND \?L28
	EQUAL? VARIATION,FRIEND-C /?L28
	GET FOUND-PASSAGES,PLAYER-C >STACK
	ZERO? STACK \?L28
	ZERO? FRIEND-FOUND-PASSAGES \?L28
	GETP HERE,P?LINE >STACK
	ZERO? STACK /?L28
	ZERO? NOW-WEARING /?L28
	FSET? HERE,SECRETBIT /?L28
	GETP HERE,P?CHARACTER >STACK
	EQUAL? STACK,1 /?L28
	EQUAL? HERE,BACKSTAIRS /?L28
	FCLEAR SECRET-TAMARA-DOOR,SECRETBIT
	SET 'VAL,1
	EQUAL? PRSA,V?SEARCH-FOR,V?SEARCH /?L30
	CRLF
?L30:	EQUAL? HERE,TAMARA-ROOM \?L33
	GET GT,ATTENTION-SPAN >STACK
	PUT GT,ATTENTION,STACK
	SET 'WINNER,FRIEND
	GET FOLLOW-LOC,FRIEND-C >STACK
	EQUAL? HERE,STACK \?L35
	PRINTI "Preparing for bed,"
	PRINTD FRIEND
	JUMP ?L39
?L35:	PRINTD FRIEND
	PRINTI " enters and"
?L39:	PRINTI " accidentally touches the bedpost. "
	CALL THIS-IS-IT,FRIEND
	CALL OPEN-SECRET,STR?173,STR?172,SECRET-TAMARA-DOOR
	SET 'WINNER,PLAYER
	JUMP ?L52
?L33:	CALL QUEUED?,I-SHOT >STACK
	ZERO? STACK \?L52
	FSET PASSAGE,SEENBIT
	FSET SECRET-TAMARA-DOOR,OPENBIT
	MOVE FRIEND,HERE
	PUT FOLLOW-LOC,FRIEND-C,HERE
	PUT GT,GOAL-FUNCTION,X-RETIRES
	CALL ESTABLISH-GOAL,FRIEND,TAMARA-ROOM
	PRINTI "Suddenly "
	PRINTD FRIEND
	PRINTI " appears and says, "
	CALL FRIEND-PASSAGE-STORY
	JUMP ?L52
?L28:	CALL TIME-FOR-GHOST?,RM >STACK
	ZERO? STACK /?L48
	CALL QUEUE,I-SEARCH,0
	EQUAL? VILLAIN-PER,LOVER \?L49
	PUTP DEB,P?LDESC,24
	GET GT,ATTENTION-SPAN >STACK
	PUT GT,ATTENTION,STACK
	LOC LOVER >STACK
	CALL DRESS-GHOST,STACK,LOVER-C
	GET GOAL-TABLES,GHOST-NEW-C >STACK
	PUT STACK,GOAL-FUNCTION,LOVER-XFER
	CALL ESTABLISH-GOAL,GHOST-NEW,BASEMENT
	CALL MOVE-PERSON,GHOST-NEW,LOVER-PATH >VAL
	JUMP ?L52
?L49:	CALL DRESS-GHOST,RM,C
	CALL GHOST-INTO-PASSAGE,C >VAL
	CALL ESTABLISH-GOAL,GHOST-NEW,YOUR-CLOSET
	JUMP ?L52
?L48:	FSET? GOAL-PERSON,FEMALE \?L53
	PUTP GOAL-PERSON,P?LDESC,24
	JUMP ?L55
?L53:	PUTP GOAL-PERSON,P?LDESC,25
?L55:	PUT GT,ATTENTION-SPAN,5
	PUT GT,ATTENTION,5
?L52:	SET 'FRIEND-FOUND-PASSAGES,1
?L9:	RETURN VAL

	.FUNCT GHOST-INTO-PASSAGE,C,RM
	ADD 1,C >STACK
	GET CHAR-CLOSET-TABLE,STACK >RM
	MOVE GHOST-NEW,RM
	EQUAL? RM,HERE \FALSE
	CALL FIND-FLAG-LG,RM,DOORBIT,SECRETBIT >RM
	FSET RM,OPENBIT
	CRLF
	CALL START-SENTENCE,RM
	PRINTI " bursts open!
"
	RETURN M-FATAL

	.FUNCT TIME-FOR-GHOST?,RM,X
	EQUAL? VILLAIN-PER,LOVER \?L1
	EQUAL? GOAL-PERSON,DEB /?L7
	RFALSE
?L1:	EQUAL? GOAL-PERSON,VILLAIN-PER \FALSE
?L7:	IN? VILLAIN-PER,LOCAL-GLOBALS /FALSE
	EQUAL? GOAL-PERSON,FRIEND /FALSE
	GET FOUND-COSTUME,PLAYER-C >STACK
	ZERO? STACK \FALSE
	FSET? BLOWGUN,TOUCHBIT /FALSE
	CALL FIND-FLAG-LG,RM,DOORBIT,SECRETBIT >X
	ZERO? X /?L15
	FSET? X,OPENBIT /FALSE
?L15:	CALL FIND-FLAG,RM,PERSONBIT,VILLAIN-PER >STACK
	ZERO? STACK /TRUE
	RFALSE

	.FUNCT DRESS-GHOST,L,C,ADJ,PT
	MOVE GHOST-NEW,L
	MOVE VILLAIN-PER,LOCAL-GLOBALS
	ADD 1,C >STACK
	GET CHAR-CLOSET-TABLE,STACK >STACK
	PUT CHAR-CLOSET-TABLE,11,STACK
	GETP VILLAIN-PER,P?STATION >ADJ
	ZERO? ADJ /?L3
	GETPT HEAD,P?ADJECTIVE >PT
	PTSIZE PT >STACK
	DEC 'STACK
	CALL ZMEMQB,ADJ,PT,STACK >OTHER-POSS-POS
	ZERO? OTHER-POSS-POS /?L3
	PUTB PT,OTHER-POSS-POS,A?G$0027S
	GETPT HANDS,P?ADJECTIVE >STACK
	PUTB STACK,OTHER-POSS-POS,A?G$0027S
	GETPT EYE,P?ADJECTIVE >STACK
	PUTB STACK,OTHER-POSS-POS,A?G$0027S
	GETPT OTHER-OUTFIT,P?ADJECTIVE >STACK
	PUTB STACK,OTHER-POSS-POS,A?G$0027S
?L3:	FSET COSTUME,NDESCBIT
	FCLEAR COSTUME,TAKEBIT
	FSET COSTUME,WORNBIT
	MOVE COSTUME,GHOST-NEW
	EQUAL? C,DOCTOR-C \?L7
	MOVE MUSTACHE,WENDISH-KIT
	FCLEAR MUSTACHE,NDESCBIT
	FSET MUSTACHE,TAKEBIT
?L7:	EQUAL? VARIATION,LORD-C /?L10
	FSET BLOWGUN,NDESCBIT
	FCLEAR BLOWGUN,TAKEBIT
	MOVE BLOWGUN,GHOST-NEW
?L10:	GET GOAL-TABLES,C >STACK
	PUT STACK,GOAL-FUNCTION,GHOST-LURKS
	GET GOAL-TABLES,C >STACK
	PUT STACK,ATTENTION-SPAN,0
	RTRUE

	.FUNCT LOVER-XFER,GARG=0,VAL=0,L
	LOC GOAL-PERSON >L
	EQUAL? GARG,G-ENROUTE \?L1
	CALL GHOST-LURKS,GARG >VAL
	RETURN VAL
?L1:	EQUAL? GARG,G-REACHED \?L7
	EQUAL? L,HERE \?L4
	CALL GHOST-LURKS,GARG >VAL
	RETURN VAL
?L4:	EQUAL? L,BASEMENT \?L6
	MOVE GOAL-PERSON,KITCHEN
	CALL ESTABLISH-GOAL,GOAL-PERSON,BACKSTAIRS
	CALL GHOST-LURKS,G-ENROUTE >VAL
	RETURN VAL
?L6:	EQUAL? L,BACKSTAIRS \?L7
	MOVE GOAL-PERSON,DINING-PASSAGE
	CALL ESTABLISH-GOAL,GOAL-PERSON,YOUR-CLOSET
	GETP GOAL-PERSON,P?CHARACTER >STACK
	GET GOAL-TABLES,STACK >STACK
	PUT STACK,GOAL-FUNCTION,GHOST-LURKS
	CALL GHOST-LURKS,G-ENROUTE >VAL
?L7:	RETURN VAL

	.FUNCT I-COME-TO,GARG=0,P,L=0,V
	IN? GHOST-NEW,LOCAL-GLOBALS \?L1
	SET 'P,VILLAIN-PER
	PUTP P,P?LDESC,4
	EQUAL? P,LOVER /?L10
	GETP P,P?CHARACTER >STACK
	GET GOAL-TABLES,STACK >STACK
	PUT STACK,GOAL-FUNCTION,X-RETIRES
	GETP P,P?CHARACTER >STACK
	ADD 1,STACK >L
	CALL META-LOC,P >STACK
	FSET? STACK,SECRETBIT \?L5
	GET CHAR-CLOSET-TABLE,L >L
	JUMP ?L10
?L5:	GET CHAR-ROOM-TABLE,L >L
	JUMP ?L10
?L1:	SET 'P,GHOST-NEW
	PUTP P,P?LDESC,0
	FSET P,NDESCBIT
	GETP P,P?CHARACTER >STACK
	GET GOAL-TABLES,STACK >STACK
	PUT STACK,GOAL-FUNCTION,GHOST-LURKS
	SET 'L,YOUR-CLOSET
	LOC P >STACK
	FSET? STACK,SECRETBIT /?L10
	GETP VILLAIN-PER,P?CHARACTER >STACK
	CALL GHOST-INTO-PASSAGE,STACK
?L10:	FCLEAR P,MUNGBIT
	CALL VISIBLE?,P >V
	ZERO? V /?L26
	CALL START-SENTENCE,P
	CALL WHERE?,P >STACK
	ZERO? STACK /?L17
	PRINTC 44
?L17:	PRINTI " shakes"
	CALL HIM-HER-IT,P,0,1
	PRINTI " head and comes to."
	CRLF
	EQUAL? VILLAIN-PER,LOVER \?L24
	CALL LOVER-SPEECH >STACK
	ZERO? STACK /?L24
	SET 'V,M-FATAL
	JUMP ?L26
?L24:	EQUAL? P,GHOST-NEW /?L26
	SET 'V,M-FATAL
	CALL HE-SHE-IT,P,1
	PRINTI " says, ""I feel... sleepy. I think..."""
	CRLF
?L26:	ZERO? L /?L31
	GETP P,P?CHARACTER >STACK
	GET GOAL-TABLES,STACK >STACK
	PUT STACK,GOAL-S,1
	CALL ESTABLISH-GOAL,P,L
?L31:	RETURN V

	.FUNCT LOVER-SPEECH
	IN? GHOST-NEW,HERE \?L1
	SET 'LOVER-SAID,1
	CALL HE-SHE-IT,GHOST-NEW,1
	PRINTI " says, ""Please don't speak, just listen! I'm really "
	PRINTD LOVER
	PRINTI ", and I'm alive. Jack tried to murder me, and I think he murdered Lionel! He pushed me down the well, but an underground stream carried me quickly to sea, where I was rescued by a yacht.
I have come back to "
	PRINTD CASTLE
	PRINTI " in disguise -- both to frighten him and to find some proof of Lionel's murder. And to incriminate "
	PRINTD LORD
	PRINTI " for my own 'murder' by planting the "
	PRINTD JEWEL
	PRINTI " from my necklace in the clothes he wore that night -- but then I lost it in the "
	PRINTD DRAWING-ROOM
	PRINTI ".""
She goes on, ""But now that you're on the case, I can leave the country with the yacht captain. Find proof of Lionel's murder, and we both can rest easily!""
She races off "
	CALL GHOST-FLEES,1
	CALL CONGRATS,COSTUME
	FSET LOVER,SEENBIT
?L1:	MOVE GHOST-NEW,LIMBO
	FSET GHOST-NEW,MUNGBIT
	PUT FOLLOW-LOC,GHOST-NEW-C,0
	RETURN LOVER-SAID

	.FUNCT GHOST-FLEES,PART=0
	ZERO? PART \?L1
	MOVE GHOST-NEW,LIMBO
	FSET GHOST-NEW,MUNGBIT
	PUT FOLLOW-LOC,GHOST-NEW-C,0
	CALL HE-SHE-IT,GHOST-NEW,1
	PRINTI " dodges your attack and flees "
?L1:	EQUAL? HERE,LOVER-PATH \?L6
	PRINTI "down the path"
	JUMP ?L10
?L6:	PRINTI "toward the "
	PRINTD PRIEST-DOOR
?L10:	PRINTR "."

	.FUNCT GHOST-LURKS,GARG=0,L,OBJ,VAL=0,GT,C
	LOC GHOST-NEW >L
	SET 'C,GHOST-NEW-C
	GET GOAL-TABLES,C >GT
	EQUAL? L,HERE \?L1
	FSET? GHOST-NEW,TOUCHBIT /?L3
	CALL GHOST-NEW-D
?L3:	SET 'VAL,M-FATAL
	SET 'AIMED-HERE,HERE
	PRINTI "The ghost "
	CALL QUEUED?,I-SHOT >STACK
	ZERO? STACK /?L8
	PRINTI "follows"
	JUMP ?L12
?L8:	PRINTI "approaches"
?L12:	CALL THIS-IS-IT,GHOST-NEW
	PRINTI " you,"
	CALL HIM-HER-IT,GHOST-NEW,0,1
	PRINTI " cold eyes shining. In a moment,"
	CALL HE-SHE-IT,GHOST-NEW
	PUT GT,GOAL-ENABLE,0
	FSET PLAYER,SEENBIT
	SET 'SHOOTER,GHOST-NEW
	CALL QUEUE,I-SHOT,CLOCKER-RUNNING
	EQUAL? VILLAIN-PER,LOVER \?L19
	PUTP GHOST-NEW,P?LDESC,17
	PRINTI " sees you and freezes."
	CRLF
	RETURN VAL
?L19:	PUTP GHOST-NEW,P?LDESC,8
	PRINTI " poi"
	IN? BLOWGUN,GHOST-NEW \?L26
	SET 'AIMED-HERE,HERE
	FCLEAR BLOWGUN,NDESCBIT
	PRINTI "nts"
	CALL PRINTT,BLOWGUN
	PRINTI " at"
	JUMP ?L30
?L26:	PRINTI "ses to attack"
?L30:	PRINTI " you."
	CRLF
	RETURN VAL
?L1:	EQUAL? GARG,G-REACHED \?L38
	EQUAL? L,YOUR-CLOSET /?L36
	CALL ESTABLISH-GOAL,GHOST-NEW,YOUR-CLOSET
	RETURN VAL
?L36:	ADD 1,C >STACK
	GET CHAR-CLOSET-TABLE,STACK >STACK
	CALL ESTABLISH-GOAL,GHOST-NEW,STACK
?L38:	RETURN VAL

	.FUNCT I-SHOT,GARG=0,VAL=0,L,GT
	GETP SHOOTER,P?CHARACTER >STACK
	GET GOAL-TABLES,STACK >GT
	EQUAL? VILLAIN-PER,LOVER \?L1
	IN? GHOST-NEW,HERE \?L3
	SET 'VAL,1
	CALL HE-SHE-IT,GHOST-NEW,1
	PRINTI " flees into the dark."
	CRLF
?L3:	MOVE GHOST-NEW,LIMBO
	FSET GHOST-NEW,MUNGBIT
	PUT FOLLOW-LOC,GHOST-NEW-C,0
	RETURN VAL
?L1:	EQUAL? AIMED-HERE,HERE \?L8
	IN? BLOWGUN,SHOOTER /?L9
	PRINTI "You struggle to get free, but"
	CALL PRINTT,SHOOTER
	PRINTI "'s hands clench tighter around your throat! Soon the pain grows until the room begins to black out"
	CALL PRINT-ID,STR?174
	EQUAL? SHOOTER,GHOST-NEW \?L13
	PRINTI ". Your only consolation is that the ghost's wig falls off, and just as you take your last breath, you see that it's really "
	PRINTD VILLAIN-PER
	CALL PRINT-ID,STR?175
?L13:	PRINTI "! But"
	JUMP ?L20
?L9:	FSET? HERE,ONBIT \?L21
	CALL HE-SHE-IT,SHOOTER,1
	PRINTI " puts"
	CALL PRINTT,BLOWGUN
	PRINTI " to"
	CALL HIM-HER-IT,SHOOTER,0,1
	PRINTI " lips and puffs"
	CALL HIM-HER-IT,SHOOTER,0,1
	PRINTI " cheeks out and in. "
?L21:	PRINTI "You feel a sharp pain in the chest. Your vision mists over, the room blacks out, and your legs give way beneath you.
The sad fact is, "
	CALL PRINT-NAME,FIRST-NAME
	PRINTI ", that you've been shot with a"
	PRINT POISON-DART
	PRINTI ", and"
	CALL PRINT-ID,STR?176
?L20:	PRINTI " for you, the game is over!
[RWD_ID: goal:2003, VAL: -5]"
	CALL FINISH
	RETURN VAL
?L8:	ZERO? SHOOTER /?L30
	FSET? SHOOTER,MUNGBIT /?L30
	PUT GT,GOAL-ENABLE,2
	FSET? HERE,SECRETBIT \?L31
	SET 'L,HERE
	JUMP ?L34
?L31:	EQUAL? SHOOTER,GHOST-NEW \?L33
	GET GT,GOAL-F >L
	JUMP ?L34
?L33:	CALL GENERIC-CLOSET,0 >L
	ZERO? L \?L34
	GETP VILLAIN-PER,P?CHARACTER >STACK
	INC 'STACK
	GET CHAR-CLOSET-TABLE,STACK >L
?L34:	PUT GT,GOAL-S,L
	CALL ESTABLISH-GOAL,SHOOTER,L
	SET 'SHOOTER,0
	FSET BLOWGUN,NDESCBIT
?L30:	RETURN VAL

	.FUNCT PLAYER-NAME-F
	CALL DO-INSTEAD-OF,PLAYER,PLAYER-NAME
	RTRUE

	.FUNCT PLAYER-F,ARG=0,L=0
	EQUAL? ARG,M-WINNER /?L1
	EQUAL? PRSO,PLAYER \FALSE
	EQUAL? PRSA,V?THANKS,V?SORRY /?L7
	EQUAL? PRSA,V?HELLO,V?DANCE,V?ARREST \?L5
?L7:	CALL HAR-HAR
	RTRUE
?L5:	EQUAL? PRSA,V?EXAMINE \?L8
	PRINTI "You are wearing"
	ZERO? NOW-WEARING \?L11
	PRINTI " nothing"
	JUMP ?L15
?L11:	CALL PRINTT,NOW-WEARING
?L15:	FIRST? PLAYER >L \?L20
?L21:	FSET? L,WORNBIT \?L23
	EQUAL? L,NOW-WEARING /?L23
	PRINTI " and"
	CALL PRINTT,L
?L23:	NEXT? L >L /?L21
?L20:	PRINTR "."
?L8:	EQUAL? PRSA,V?SEARCH \?L30
	CALL PERFORM,V?INVENTORY
	RTRUE
?L30:	EQUAL? PRSA,V?SMELL \FALSE
	PRINTI "You smell "
	ZERO? WASHED /?L34
	PRINTR "clean and fresh."
?L34:	PRINTR "as if you need washing."
?L1:	CALL DIVESTMENT?,NOW-WEARING >STACK
	ZERO? STACK /?L43
	CALL NO-CHANGING? >STACK
	ZERO? STACK \TRUE
	ZERO? NOW-WEARING /FALSE
	EQUAL? PRSA,V?REMOVE,V?DISEMBARK /FALSE
	CALL FIRST-YOU,STR?165,NOW-WEARING
	FCLEAR NOW-WEARING,WORNBIT
	SET 'NOW-WEARING,0
	RFALSE
?L43:	ZERO? PRSI /?L50
	EQUAL? PRSA,V?SEARCH-FOR /?L50
	FSET? PRSI,SECRETBIT \?L50
	FSET? PRSI,SEENBIT /?L50
	CALL NOT-FOUND,PRSI
	RTRUE
?L50:	ZERO? PRSO /?L51
	EQUAL? PRSA,V?WALK,V?FIND /?L51
	FSET? PRSO,SECRETBIT \?L51
	FSET? PRSO,SEENBIT /?L51
	CALL NOT-FOUND,PRSO
	RTRUE
?L51:	ZERO? AWAITING-REPLY /?L52
	EQUAL? PRSA,V?WALK-TO /?L53
	EQUAL? PRSA,V?WALK,V?THROUGH,V?FOLLOW \?L52
?L53:	SET 'CLOCK-WAIT,1
	CALL PLEASE-ANSWER
	RTRUE
?L52:	LOC PLAYER >L
	EQUAL? L,HERE,CAR /FALSE
	ZERO? P-WALK-DIR /?L55
	CALL TOO-BAD-SIT-HIDE >STACK
	RSTACK
?L55:	EQUAL? PRSO,0,ROOMS,L /FALSE
	EQUAL? PRSA,V?FIND /?L58
	EQUAL? PRSA,V?SEARCH-FOR,V?SEARCH,V?WALK-TO \?L57
?L58:	EQUAL? PRSO,SLEEP-GLOBAL /FALSE
	CALL TOO-BAD-SIT-HIDE >STACK
	RSTACK
?L57:	CALL SPEAKING-VERB? >STACK
	ZERO? STACK \FALSE
	CALL GAME-VERB? >STACK
	ZERO? STACK \FALSE
	CALL REMOTE-VERB? >STACK
	ZERO? STACK \FALSE
	EQUAL? PRSA,V?SMILE,V?SHOOT,V?NOD /FALSE
	EQUAL? PRSA,V?LOOK-ON,V?LISTEN,V?FAINT /FALSE
	EQUAL? PRSA,V?AIM /FALSE
	CALL HELD?,PRSO >STACK
	ZERO? STACK \FALSE
	CALL HELD?,PRSO,GLOBAL-OBJECTS >STACK
	ZERO? STACK \FALSE
	EQUAL? L,CHAIR-DINING \?L69
	IN? PRSO,TABLE-DINING /FALSE
?L69:	EQUAL? PRSA,V?EXAMINE /FALSE
	CALL HELD?,PRSO,L >STACK
	ZERO? STACK \?L71
	CALL TOO-BAD-SIT-HIDE >STACK
	RSTACK
?L71:	ZERO? PRSI /FALSE
	CALL HELD?,PRSI >STACK
	ZERO? STACK \FALSE
	CALL HELD?,PRSI,GLOBAL-OBJECTS >STACK
	ZERO? STACK \FALSE
	CALL HELD?,PRSI,L >STACK
	ZERO? STACK \FALSE
	CALL TOO-BAD-SIT-HIDE >STACK
	RSTACK

	.FUNCT PLEASE-ANSWER,P
	GETB QUESTIONERS,AWAITING-REPLY >P
	PRINTD P
	PRINTI " says, """
	EQUAL? P,BUTLER,DOCTOR \?L3
	PRINTI "Pardon me, "
	CALL TITLE-NAME
	PRINTI ", but"
	JUMP ?L7
?L3:	PRINTI "Wait a mo'."
?L7:	PRINTR " I asked you a question."""

	.FUNCT TOO-BAD-SIT-HIDE
	MOVE WINNER,HERE
	CALL FIRST-YOU,STR?177
	RFALSE

	.FUNCT FRIEND-D,ARG=0
	CALL DESCRIBE-PERSON,FRIEND
	RTRUE

	.FUNCT I-REPLY,GARG=0,P,X
	ZERO? AWAITING-REPLY /FALSE
	EQUAL? AWAITING-REPLY,BUTLER-1-R,BUTLER-2-R,BUTLER-3-R /?L4
	EQUAL? AWAITING-REPLY,BUTLER-4-R \?L3
?L4:	CALL QUEUED?,I-BUTLER-HINTS >STACK
	ZERO? STACK /?L5
	CALL QUEUE,I-BUTLER-HINTS,CLOCKER-RUNNING
?L5:	SET 'P,BUTLER
	JUMP ?L11
?L3:	EQUAL? AWAITING-REPLY,FRIEND-C \?L8
	EQUAL? VARIATION,FRIEND-C \?L8
	SET 'P,FRIEND
	JUMP ?L11
?L8:	EQUAL? AWAITING-REPLY,DEB-C \?L9
	SET 'P,DEB
	JUMP ?L11
?L9:	EQUAL? AWAITING-REPLY,OFFICER-1-R,OFFICER-2-R \?L10
	SET 'P,OFFICER
	JUMP ?L11
?L10:	EQUAL? AWAITING-REPLY,DOCTOR-C \?L11
	SET 'P,DOCTOR
?L11:	ZERO? P \?L13
	SET 'AWAITING-REPLY,0
	RFALSE
?L13:	GETP P,P?LINE >X
	ADD 1,X >STACK
	PUTP P,P?LINE,STACK
	ZERO? X \?L16
	CALL QUEUE,I-REPLY,CLOCKER-RUNNING
	PRINTD P
	PRINTI " repeats, ""I said: "
	GET QUESTIONS,AWAITING-REPLY >STACK
	PRINT STACK
	PRINTI """
"
	RETURN 2
?L16:	SET 'AWAITING-REPLY,0
	PUTP P,P?LDESC,20
	CALL VISIBLE?,P >STACK
	ZERO? STACK /?L21
	CALL HE-SHE-IT,P,1
	PRINTI " mutters, ""I'd "
	EQUAL? P,FRIEND \?L25
	PRINTI "wondered if you"
	JUMP ?L29
?L25:	PRINTI "heard that Americans"
?L29:	PRINTI " were rude, but really...!"""
	CRLF
?L21:	RETURN 2

	.FUNCT FRIEND-F,ARG=0,OBJ,X
	EQUAL? ARG,M-WINNER \?L1
	EQUAL? AWAITING-REPLY,FRIEND-C \?L3
	EQUAL? PRSA,V?NO,V?YES \?L3
	PUTP FRIEND,P?LDESC,0
	PUTP FRIEND,P?LINE,0
	SET 'AWAITING-REPLY,0
	PRINTI """Then you "
	EQUAL? PRSA,V?YES /?L7
	PRINTI "don't "
?L7:	SET 'P-IT-OBJECT,GHOST-NEW
	PRINTI "know about my engagement, and the "
	PRINTD GHOST-OLD
	PRINTR ", and the fact that... that someone is trying to kill me!"""
?L3:	CALL GRAB-ATTENTION,FRIEND >STACK
	ZERO? STACK \?L14
	RETURN 2
?L14:	EQUAL? PRSA,V?DESCRIBE \?L17
	EQUAL? PRSO,GHOST-NEW \?L17
	PRINTI "Tammy shakes her head. ""I just don't know if the ghost was "
	PRINTD LOVER
	PRINTR ". I never saw her, just that portrait by Vivien. The night I saw that ghastly face peering down at me... Well, I was too shaken to remember anything, except that horrible spider dropping down on me!"" She shudders at the memory."
?L17:	EQUAL? PRSA,V?FOLLOW \?L20
	EQUAL? PRSO,PLAYER \?L20
	CALL WILLING?,FRIEND >STACK
	ZERO? STACK /?L21
	PRINTI """I'll try my best, "
	CALL PRINT-NAME,FIRST-NAME
	PRINTI "!"""
	CRLF
	CALL NEW-FOLLOWER,FRIEND
	RTRUE
?L21:	PRINTR """Not just now."""
?L20:	EQUAL? PRSA,V?YES \?L28
	SET 'WINNER,PLAYER
	CALL PERFORM,V?KISS,FRIEND
	RTRUE
?L28:	CALL COM-CHECK,FRIEND >X
	ZERO? X /?L29
	EQUAL? X,M-FATAL /FALSE
	EQUAL? X,M-OTHER \TRUE
	RETURN 2
?L29:	CALL WHY-ME
	RETURN 2
?L1:	EQUAL? PRSA,V?TELL-ABOUT,V?SHOW,V?ASK-ABOUT \?L39
	EQUAL? PRSI,SLEEP-OUTFIT,DINNER-OUTFIT /?L40
	EQUAL? PRSI,EXERCISE-OUTFIT,TWEED-OUTFIT,CAR \?L39
?L40:	CALL GRAB-ATTENTION,FRIEND >STACK
	ZERO? STACK \?L41
	RETURN 2
?L41:	PRINTI """It's super!"
	EQUAL? PRSI,TWEED-OUTFIT /?L48
	PRINTI " And it's "
	PRINTD YOUR-COLOR
	PRINTI "!"
?L48:	PRINTR """"
?L39:	CALL ASKING-ABOUT?,FRIEND >OBJ
	ZERO? OBJ /?L55
	CALL GRAB-ATTENTION,FRIEND,OBJ >STACK
	ZERO? STACK \?L56
	RETURN 2
?L56:	EQUAL? OBJ,CASTLE \?L60
	PRINTR """Oh, it's such a lovely place. If only I felt safe here!"""
?L60:	EQUAL? OBJ,SEARCHER /?L64
	CALL EVIDENCE?,OBJ >STACK
	ZERO? STACK /?L63
?L64:	ZERO? CONFESSED \?L65
	GET TOLD-ABOUT-EVID,FRIEND-C >STACK
	ZERO? STACK /?L63
?L65:	EQUAL? FRIEND,SEARCHER /?L63
	PRINT IM-SHOCKED
	RTRUE
?L63:	EQUAL? OBJ,COUSIN,BUST \?L68
	PRINTR """Sorry, but I never met the man."""
?L68:	EQUAL? OBJ,DEB \?L71
	EQUAL? VARIATION,FRIEND-C \?L71
	PRINT RHYMES-WITH-RICH
	CRLF
	RTRUE
?L71:	EQUAL? OBJ,LENS,LENS-1,LENS-2 \?L74
	PRINTI """You know I've never worn glasses, "
	CALL PRINT-NAME,FIRST-NAME
	PRINTI ", or "
	PRINTD LENS
	PRINTI "es, either."
	EQUAL? VARIATION,DOCTOR-C,PAINTER-C \?L77
	ZERO? FOUND-IT-PERM /?L77
	PRINTI " I can't imagine who dropped it."
?L77:	PRINTR """"
?L74:	EQUAL? OBJ,PASSAGE \?L84
	ZERO? FRIEND-FOUND-PASSAGES /?L84
	CALL FRIEND-PASSAGE-STORY >STACK
	RSTACK
?L84:	EQUAL? OBJ,PRIEST-DOOR /?L86
	EQUAL? OBJ,PASSAGE \?L85
	GET FOUND-PASSAGES,FRIEND-C >STACK
	ZERO? STACK \?L85
?L86:	PRINTC 34
	EQUAL? OBJ,PASSAGE \?L89
	PRINTI "You mean "
	PRINTD PASSAGE
	PRINTI "s like in horror movies? "
?L89:	PRINTI "Golly, I don't know that much about the castle, "
	CALL PRINT-NAME,FIRST-NAME >STACK
	ZERO? STACK /?L96
	PRINTC 46
?L96:	PRINTI " Maybe Jack could tell you."
	EQUAL? VARIATION,FRIEND-C \?L103
	PRINTI " Or Iris, who's spent far too much time here."
?L103:	PRINTR """"
?L85:	EQUAL? OBJ,LORD,ROMANCE,FRIEND \?L110
	EQUAL? OBJ,SEARCHER \?L111
	GETP OBJ,P?LDESC >STACK
	EQUAL? STACK,21 /?L110
?L111:	EQUAL? OBJ,FRIEND /?L114
	FSET? LORD,TOUCHBIT \?L112
?L114:	PRINTI """Oh, "
	CALL PRINT-NAME,FIRST-NAME
	PRINTI ", I"
	EQUAL? VARIATION,LORD-C \?L117
	PRINTI " was"
	JUMP ?L121
?L117:	PRINTI "'m"
?L121:	PRINTI " so happy!"" "
	PRINTD FRIEND
	PRINTI " gushes. ""The whole thing seem"
	EQUAL? VARIATION,LORD-C \?L126
	PRINTI "ed "
	JUMP ?L130
?L126:	PRINTI "s "
?L130:	PRINTI "just like a fairy tale, or a paperback romance! But "
	EQUAL? VARIATION,LORD-C \?L135
	PRINTI "lately,"
	LOC LORD >STACK
	EQUAL? STACK,HERE,PSEUDO-OBJECT \?L139
	PRINTI """ she whispers, """
	JUMP ?L143
?L139:	PRINTC 32
?L143:	PRINTI "Jack seems cool toward me"
	JUMP ?L148
?L135:	PRINTI "I told you all about it in my letter"
?L148:	PRINTR "."""
?L112:	MOVE LORD,HERE
	CALL LORD-INTRO
	RTRUE
?L110:	EQUAL? OBJ,LOVER \?L154
	PRINTI """She lived just down the beach, and from all [RWD_ID: people:398, VAL: 1]accounts she spent most of her time hanging about the castle. If she'd stayed home a bit more, "
	PRINTD ACCIDENT
	PRINTR " never would've happened -- I mean, her falling in the well and drowning."""
?L154:	EQUAL? OBJ,ACCIDENT \?L157
	PRINTI """I can't tell you much,"" says "
	PRINTD FRIEND
	PRINTI ", ""because I wasn't here when it happened. But all the guests here tonight were also here that night. At dinner, they decided to have a wine tasting later in the evening. "
	PRINTD LOVER
	PRINTI " was to choose and pour the wine. But when the time came, she didn't show up, so they sent the butler down to the "
	PRINTD BASEMENT
	PRINTR ", to find her and help carry up the bottles. He came back saying that she'd fallen down the well!"""
?L157:	EQUAL? OBJ,GHOST-OLD \?L160
	PRINTI """I've told you all I know in my letter, "
	CALL PRINT-NAME,FIRST-NAME >STACK
	ZERO? STACK /?L163
	PRINTC 46
?L163:	PRINTI " But come to think of it, there's an old "
	PRINTD HISTORY-BOOK
	PRINTI " in the "
	PRINTD LIBRARY
	PRINTI " that tells about "
	PRINTD CASTLE
	PRINTR ". You might learn more from that."""
?L160:	EQUAL? OBJ,GHOST-NEW,DANGER,HAUNTING \?L170
	PRINTI """Since I wrote you, I've seen the ghost again, and this third time was the worst. After working late one night, I was "
	GET LDESC-STRINGS,17 >STACK
	PRINT STACK
	PRINTI " the office to go to my room. As I opened the door to the "
	PRINTD CORR-2
	PRINTI ", I saw this ghostly figure with "
	PRINT LONG-BLOND-HAIR
	PRINTI " and a dead white face. It was holding a sword and about to attack me!""
"
	PRINTD FRIEND
	PRINTI " gulps and her voice quavers as she concludes, ""I s-s-screamed and shrank back inside the office and slammed the door! That's about all I can tell you, "
	CALL PRINT-NAME,FIRST-NAME
	PRINTI "..."""
	CRLF
	LOC LORD >STACK
	EQUAL? STACK,HERE,PSEUDO-OBJECT \?L181
	GETP LORD,P?LINE >STACK
	ZERO? STACK \?L181
	PRINTI """I was just dozing off when Tammy's scream woke me,"" adds "
	PRINTD LORD
	PRINTI ". ""By the time I ran into the "
	PRINTD CORR-2
	PRINTI ", the ghost "
	EQUAL? VARIATION,FRIEND-C \?L177
	PRINTI "had disappeared."""
	CRLF
	JUMP ?L181
?L177:	PRINTI "was almost gone. I did catch"
	PRINT WHITISH-GLIMPSE
	PRINTI " as it disappeared down the tower stairs -- but frankly I was more concerned about "
	PRINTD FRIEND
	PRINTI "."""
	CRLF
?L181:	PRINTD FRIEND
	PRINTR " fidgets nervously. ""I don't know whether this ghost is real, or someone just play-acting. It can sneak around anywhere it pleases in the whole castle. I just don't understand how a person dressed up like a spook can do that without being caught!"""
?L170:	EQUAL? OBJ,COSTUME,BLOWGUN,TAMARA-EVIDENCE \?L187
	EQUAL? VARIATION,FRIEND-C \?L187
	PRINTR """I've, uh, never seen it before."""
?L187:	CALL COMMON-ASK-ABOUT,FRIEND,OBJ >X
	ZERO? X /?L190
	EQUAL? X,M-FATAL \TRUE
	RFALSE
?L190:	FSET? OBJ,PERSONBIT \?L194
	EQUAL? OBJ,MAID /?L194
	SET 'CLOCK-WAIT,1
	PRINTI """I already told you about"
	CALL HIM-HER-IT,OBJ
	PRINTR " in my letter."""
?L194:	EQUAL? PRSA,V?SHOW \?L198
	PRINTI """It looks like "
	CALL PRINTA,OBJ
	PRINTR " to me."""
?L198:	PRINTI """I just don't know, "
	CALL PRINT-NAME,FIRST-NAME >STACK
	ZERO? STACK /?L205
	PRINTC 46
?L205:	PRINTR """"
?L55:	EQUAL? PRSA,V?FOLLOW \?L212
	CALL TOUR? >STACK
	ZERO? STACK \TRUE
?L212:	EQUAL? PRSA,V?HELLO,V?KISS \?L213
	CALL UNSNOOZE,FRIEND
	PUTP FRIEND,P?LINE,0
	PUTP FRIEND,P?LDESC,0
	CALL HE-SHE-IT,FRIEND,1,STR?178
	PRINTI " you with affection. ""I'm so glad you're here!"""
	CRLF
	CALL PRINT-ID,STR?179 >STACK
	RSTACK
?L213:	CALL PERSON-F,FRIEND,ARG >STACK
	RSTACK

	.FUNCT TAMARA-EVIDENCE-F
	EQUAL? PRSA,V?READ,V?LOOK-INSIDE,V?EXAMINE \FALSE
	CALL NOT-HOLDING?,PRSO >STACK
	ZERO? STACK \TRUE
	PRINTI "It's a receipt for the purchase of an adder from a pet shop in Frobzance. Someone has written the word ""Iris"" on it and then viciously crossed it out."
	CRLF
	ZERO? EVIDENCE-FOUND \?L8
	CALL CONGRATS
?L8:	SET 'EVIDENCE-FOUND,TAMARA-EVIDENCE
	RTRUE

	.FUNCT ASKING-ABOUT?,WHO,DR
	EQUAL? PRSA,V?SHOW,V?CONFRONT,V?ASK-ABOUT \FALSE
	EQUAL? PRSI,PASSAGE \?L3
	CALL FIND-FLAG-LG,HERE,DOORBIT,SECRETBIT >DR
	ZERO? DR /?L3
	FSET? DR,OPENBIT /FALSE
?L3:	EQUAL? WHO,PRSO \FALSE
	RETURN PRSI

	.FUNCT LORD-INTRO
	SET 'FOLLOWER,LORD
	FSET LORD,TOUCHBIT
	FSET LORD,SEENBIT
	FCLEAR LORD,NDESCBIT
	SET 'QCONTEXT,LORD
	CALL THIS-IS-IT,LORD
	PRINTI """Here comes Jack now!"" exclaims "
	PRINTD FRIEND
	PRINTI ", as he comes striding toward you. "
	CALL COMMON-DESC,LORD
	PRINTI "
""My fiance, "
	PRINTD LORD
	PRINTC 32
	PRINT TRESYLLIAN
	PRINTI ","" "
	PRINTD FRIEND
	PRINT INTRODUCES
	PRINTI "him. ""Jack, this is my friend from the States, "
	CALL TELL-FULL-NAME
	PRINTI ".""
""So you're that famous young sleuth whom the Yanks call "
	ZERO? GENDER-KNOWN \?L7
	PRINTI "Young "
	JUMP ?L11
?L7:	CALL TITLE
?L11:	PRINTI "Sherlock!"" says "
	PRINTD LORD
	ZERO? GENDER-KNOWN /?L16
	FSET? PLAYER,FEMALE /?L14
?L16:	PRINTI ", shaking hands"
?L14:	PRINTI ". ""Tammy's told me about the mysteries you've solved"
	ZERO? GENDER-KNOWN \?L22
	PRINTI ". She seems to think you can unravel the mystery of "
	PRINTD CASTLE
	PRINTR "."""
?L22:	FSET? PLAYER,FEMALE \?L26
	PRINTI " -- but she never let on you looked so smashing! Welcome to Cornwall, "
	CALL PRINT-NAME,FIRST-NAME
	PRINTI " luv!""
Before you know it, he sweeps you into his arms and kisses you warmly! Let's hope "
	PRINTD FRIEND
	PRINTI " doesn't mind -- but for the moment all you can see are "
	PRINTD LORD
	PRINTR "'s dazzling sapphire-blue eyes."
?L26:	PRINTR "!""
His keen blue eyes size you up with a friendly twinkle. Yet his friendliness seems to be all on the surface -- it may take time to figure out where His Lordship's really coming from."

	.FUNCT TELL-FULL-NAME
	CALL TITLE
	CALL PRINT-NAME,FIRST-NAME
	ZERO? MIDDLE-WORD /?L3
	EQUAL? MIDDLE-WORD,W?$COMMA /?L5
	PRINTC 32
?L5:	PRINTB MIDDLE-WORD
?L3:	PRINTC 32
	CALL PRINT-NAME,LAST-NAME
	CALL TELL-SUFFIX >STACK
	RSTACK

	.FUNCT LORD-D,ARG=0
	CALL DESCRIBE-PERSON,LORD
	RTRUE

	.FUNCT LORD-GHOST-STORY
	PRINTI """No use asking ME, "
	CALL PRINT-NAME,FIRST-NAME >STACK
	ZERO? STACK /?L3
	PRINTC 46
?L3:	PRINTI " All I caught was"
	PRINT WHITISH-GLIMPSE
	PRINTI ". "
	EQUAL? VARIATION,DOCTOR-C,PAINTER-C \?L10
	PRINTR "I couldn't even swear it was a woman; it might've been some bloke in drag."""
?L10:	FSET GHOST-NEW,PERSONBIT
	PRINTI "She was blonde, definitely female, and about Dee's height...""
"
	PRINTD LORD
	PRINTR "'s own face is pale as he adds, ""So, yes, it COULD have been her ghost... or Dee herself."""

	.FUNCT LORD-F,ARG=0,OBJ,X
	EQUAL? ARG,M-WINNER \?L1
	CALL GRAB-ATTENTION,LORD >STACK
	ZERO? STACK \?L3
	RETURN 2
?L3:	EQUAL? PRSA,V?DESCRIBE \?L7
	EQUAL? PRSO,GHOST-NEW \?L7
	EQUAL? VARIATION,FRIEND-C /?L7
	CALL LORD-GHOST-STORY
	RTRUE
?L7:	EQUAL? PRSA,V?REPLY,V?ANSWER \?L8
	EQUAL? 3,LIONEL-SPEAKS-COUNTER \?L8
	SET 'WINNER,PLAYER
	CALL PERFORM,V?ASK-ABOUT,LORD,ARTIFACT
	RTRUE
?L8:	CALL COM-CHECK,LORD >X
	ZERO? X /?L9
	EQUAL? X,M-FATAL /FALSE
	EQUAL? X,M-OTHER \TRUE
	RETURN 2
?L9:	CALL WHY-ME
	RETURN 2
?L1:	CALL ASKING-ABOUT?,LORD >OBJ
	ZERO? OBJ /?L19
	CALL GRAB-ATTENTION,LORD,OBJ >STACK
	ZERO? STACK \?L20
	RETURN 2
?L20:	EQUAL? OBJ,ACCIDENT \?L24
	PRINTI "Jack takes a deep breath. ""You've heard the bare facts, I assume -- she was in the "
	PRINTD BASEMENT
	PRINTI ", slipped and fell down the well. The evidence proves what happened: a tent pole she'd stumbled over; her one shoe that came off, with the slippery sole and the loose heel; and of course "
	PRINTD NECKLACE-OF-D
	PRINTI ". I even"
	PRINT FOUND-FABRIC
	PRINTI """
He adds, ""The police never found "
	PRINTD CORPSE
	PRINTR ". But the well is drawing tide water. No doubt she was swept out to sea."""
?L24:	EQUAL? OBJ,ARTIFACT \?L27
	PRINTI "Jack fidgets and replies, ""Well, ah, we've all HEARD of it, certainly. Uncle Lionel liked to drop teasing hints about how valuable it was. But he was frightfully secretive. He never identified it."
	EQUAL? LIONEL-SPEAKS-COUNTER,INIT-LIONEL-SPEAKS-COUNTER /?L34
	PRINTI " He's probably playing the same silly game right now."
	ZERO? LIONEL-SPEAKS-COUNTER /?L34
	PRINTI " Let's hear the old boy out."
?L34:	PRINTR """"
?L27:	EQUAL? OBJ,CASTLE \?L42
	PRINTI """Well, as I daresay you've heard, the castle's been infested lately with a spook. And it seems bent on harming "
	PRINTD FRIEND
	PRINTR ". All in all, a very rum go."""
?L42:	EQUAL? OBJ,SEARCHER \?L45
	ZERO? CONFESSED \?L46
	GET TOLD-ABOUT-EVID,LORD-C >STACK
	ZERO? STACK /?L45
?L46:	EQUAL? LORD,SEARCHER /?L45
	PRINT IM-SHOCKED
	RTRUE
?L45:	EQUAL? OBJ,FRIEND,ROMANCE \?L49
	PRINTI """She's a darling girl, really first-rate."
	EQUAL? VARIATION,FRIEND-C \?L52
	LOC LORD >STACK
	EQUAL? STACK,HERE,PSEUDO-OBJECT \?L54
	PRINTI """ He whispers, """
	JUMP ?L58
?L54:	PRINTC 32
?L58:	PRINTI "Although lately she's seemed cool toward me."
?L52:	PRINTR """"
?L49:	EQUAL? OBJ,GHOST-NEW,DANGER,HAUNTING \?L66
	EQUAL? VARIATION,FRIEND-C /?L66
	CALL LORD-GHOST-STORY
	RTRUE
?L66:	EQUAL? OBJ,CLUE-2 \?L67
	EQUAL? VARIATION,LORD-C /?L67
	IN? OBJ,LORD /?L67
	CALL CLUE-2-STORY,LORD
	RTRUE
?L67:	EQUAL? OBJ,LENS,LENS-1,LENS-2 \?L68
	CALL HE-SHE-IT,LORD,1
	PRINTI " gives a puzzled shrug, saying, """
	PRINTR "There's nothing wrong with my eyesight."""
?L68:	EQUAL? OBJ,MAID \?L75
	FSET? LETTER,TOUCHBIT \?L75
	PRINT JACK-THINKS-GLADYS
	PRINTR """"
?L75:	EQUAL? OBJ,PASSAGE \?L78
	GET FOUND-PASSAGES,LORD-C >STACK
	ZERO? STACK \?L78
	PRINTI """Hmm... good question. I know there are old tales about "
	PRINTD CASTLE
	PRINTI " being honeycombed with "
	PRINTD PASSAGE
	PRINTR "s, but I've never actually stumbled on any. Uncle Lionel would have known, but I never asked him before he died, worse luck."""
?L78:	EQUAL? OBJ,PRIEST-DOOR \?L81
	PRINTI """It's in the "
	PRINTD DUNGEON
	PRINTI ", close to the curtain wall. Dee used it because her cottage is just down the shore.""
He adds, ""By the way, the name '"
	PRINTD PRIEST-DOOR
	PRINTI "' dates back to when the Catholic Church was outlawed in England, and priests had to hide for fear of execution. Many British great houses have "
	PRINTD PASSAGE
	PRINTR "s, hiding places, and entrances."""
?L81:	CALL COMMON-ASK-ABOUT,LORD,OBJ >X
	ZERO? X /?L84
	EQUAL? X,M-FATAL \TRUE
	RFALSE
?L84:	CALL TELL-DUNNO,LORD,OBJ >STACK
	RSTACK
?L19:	EQUAL? PRSA,V?RUB,V?KISS \?L89
	IN? FRIEND,HERE \?L90
	GETP FRIEND,P?LINE >STACK
	INC 'STACK
	PUTP FRIEND,P?LINE,STACK
	CALL HE-SHE-IT,FRIEND,1
	PRINTI " flashes you an angry look."
	CRLF
	CALL PRINT-ID,STR?180
?L90:	FSET? PLAYER,FEMALE \FALSE
	CALL UNSNOOZE,LORD
	PUTP LORD,P?LINE,0
	PUTP LORD,P?LDESC,0
	PRINTI """I say! You Americans are frightfully friendly!"" says "
	PRINTD LORD
	PRINTR "."
?L89:	CALL PERSON-F,LORD,ARG >STACK
	RSTACK

	.FUNCT CLUE-2-STORY,PER
	PRINTC 34
	PRINTR "I thought it was just one more of Lionel's weird jokes, or the effect of jungle rot on his brain -- that sort of thing."""

	.FUNCT TELL-DUNNO,PER,OBJ
	FSET? OBJ,PERSONBIT \?L1
	PRINTR """I don't indulge much in idle gossip, you know."""
?L1:	PRINTI """You know as much as I do"
	EQUAL? PER,OFFICER \?L8
	CALL IAN-CALLS-YOU
	PRINTR "."""
?L8:	PRINTI ", "
	CALL PRINT-NAME,FIRST-NAME >STACK
	ZERO? STACK /?L15
	PRINTC 46
?L15:	PRINTR """"

	.FUNCT JACK-TAPE-F,P
	EQUAL? PRSA,V?PLAY,V?LISTEN,V?LAMP-ON \FALSE
	PRINTI "First you hear Lionel: ""This "
	PRINTD JACK-TAPE
	PRINTI " should capture any sound in the "
	PRINTD JACK-ROOM
	PRINTI " when I run it. Testing, testing,...""
Then you hear Lionel tell "
	PRINTD LOVER
	PRINTI " that he suspects Jack of coveting the inheritance and wanting to kill him.
After a pause, Jack tells Lionel, with a cold-blooded chuckle, that his time has come. Then "
	PRINT LIONELS-VOICE
	PRINTI " is urgent and muffled, as if he's being smothered! He calls out, ""Jack! Stop!"" and then... silence."
	CRLF
	FIRST? HERE >P \?L6
	CALL FOUND-PASSAGES-REPEAT,P,JACK-TAPE,TOLD-ABOUT-EVID
?L6:	IN? FRIEND,HERE \?L9
	EQUAL? CAPTOR,FRIEND /?L9
	CALL THIS-IS-IT,FRIEND
	MOVE FRIEND,TAMARA-ROOM
	PUT FOLLOW-LOC,FRIEND-C,TAMARA-ROOM
	EQUAL? FOLLOWER,FRIEND,LORD \?L11
	SET 'FOLLOWER,0
?L11:	GETP FRIEND,P?CHARACTER >STACK
	GET GOAL-TABLES,STACK >STACK
	PUT STACK,GOAL-ENABLE,0
	PUTP FRIEND,P?LDESC,7
	PRINTD FRIEND
	PRINTI "'s eyes fill with tears, and she runs to her room."
	CRLF
?L9:	ZERO? EVIDENCE-FOUND \?L17
	CALL CONGRATS
?L17:	SET 'EVIDENCE-FOUND,JACK-TAPE
	ZERO? CONFESSED \TRUE
	IN? LORD,HERE \?L22
	CALL CONFESSION,LORD
	RTRUE
?L22:	CALL FIND-FLAG-HERE-NOT,PERSONBIT,MUNGBIT,WINNER >P
	ZERO? P /TRUE
	SET 'WINNER,PLAYER
	CALL PERFORM,V?ASK-ABOUT,P,JACK-TAPE
	RTRUE

	.FUNCT LOVER-D,ARG=0
	CALL DESCRIBE-PERSON,LOVER
	RTRUE

	.FUNCT LOVER-F,ARG=0
	IN? LOVER-PIC,HERE \?L1
	CALL REMOTE-VERB? >STACK
	ZERO? STACK \?L1
	CALL DO-INSTEAD-OF,LOVER-PIC,LOVER
	RTRUE
?L1:	CALL PERSON-F,LOVER,ARG >STACK
	RSTACK

	.FUNCT DEB-D,ARG=0
	CALL DESCRIBE-PERSON,DEB
	RTRUE

	.FUNCT DEB-F,ARG=0,OBJ,X
	EQUAL? ARG,M-WINNER \?L1
	SET 'FAWNING,0
	EQUAL? AWAITING-REPLY,DEB-C \?L3
	EQUAL? PRSA,V?NO,V?YES \?L3
	CALL ESTABLISH-GOAL,DOCTOR,HERE
	PUTP DEB,P?LDESC,0
	PUTP DEB,P?LINE,0
	SET 'AWAITING-REPLY,0
	EQUAL? PRSA,V?YES \?L5
	PRINTR """Splendid!"""
?L5:	PRINTR """What a pity!"""
?L3:	CALL GRAB-ATTENTION,DEB >STACK
	ZERO? STACK \?L12
	RETURN 2
?L12:	EQUAL? PRSA,V?DESCRIBE \?L15
	EQUAL? PRSO,GHOST-NEW \?L15
	FSET GHOST-NEW,PERSONBIT
	PRINTI """Well, it appeared to be a woman with "
	PRINT LONG-BLOND-HAIR
	PRINTI " in a "
	EQUAL? VARIATION,DOCTOR-C /?L18
	PRINTI "sleeveless, "
?L18:	PRINTI "silvery white gown. But if you're asking me, 'Was it really poor Dee?' I'm just not sure. "
	EQUAL? VARIATION,FRIEND-C,LORD-C \?L25
	PRINTR "I didn't see the face that well. But I'd say the figure was average height, and moved in a very feminine way, just as she did -- so it COULD have been her ghost."""
?L25:	EQUAL? VARIATION,PAINTER-C \?L29
	PRINTR "It seemed different from Dee in some way...""
She snaps her fingers, and her eyes brighten maliciously. ""Now I know! The ghost was too tall! Definitely taller than she!"""
?L29:	PRINTI "It was "
	PRINTI "about the right height, I suppose, but"
	PRINTR " its gown, with long sleeves and a high neck, seemed different from hers. It lacked her femininity. She was a very feminine woman, you know -- almost seductive, as I'm sure Jack can testify. The ghost was just a sexless spook, one might say."""
?L15:	EQUAL? PRSA,V?FOLLOW \?L41
	EQUAL? PRSO,PLAYER \?L41
	CALL WILLING?,DEB >STACK
	ZERO? STACK /?L41
	PRINTI """Ooo! I love an adventure, "
	CALL PRINT-NAME,FIRST-NAME
	PRINTI "!"""
	CRLF
	CALL NEW-FOLLOWER,DEB
	RTRUE
?L41:	CALL COM-CHECK,DEB >X
	ZERO? X /?L44
	EQUAL? X,M-FATAL /FALSE
	EQUAL? X,M-OTHER \TRUE
	RETURN 2
?L44:	CALL WINNER-DEFAULT,DEB >STACK
	RSTACK
?L1:	CALL ASKING-ABOUT?,DEB >OBJ
	ZERO? OBJ /?L52
	CALL GRAB-ATTENTION,DEB,OBJ >STACK
	ZERO? STACK \?L53
	RETURN 2
?L53:	EQUAL? OBJ,SEARCHER \?L57
	ZERO? CONFESSED \?L58
	GET TOLD-ABOUT-EVID,DEB-C >STACK
	ZERO? STACK /?L57
?L58:	PRINT IM-SHOCKED
	RTRUE
?L57:	EQUAL? OBJ,GHOST-NEW,DANGER,HAUNTING \?L61
	PRINTI """It was quite dramatic, really. One night I couldn't sleep, so I got a poetic urge to go up on the "
	PRINTD DECK
	PRINTI " in the moonlight and commune with my soul.""
"
	PRINTD DEB
	PRINTR " goes on, ""As I started up the tower stairs, I saw this figure in white coming 'round the curve of the stairway. My dear, I absolutely FROZE! The ghost turned 'round and flitted back up the stairs, and by the time I recovered, it was gone!"""
?L61:	EQUAL? OBJ,TAMARA-EVIDENCE \?L64
	PRINTR """My word! It looks as if someone dislikes me!"""
?L64:	CALL COMMON-ASK-ABOUT,DEB,OBJ >X
	ZERO? X /?L67
	EQUAL? X,M-FATAL \TRUE
	RFALSE
?L67:	CALL TELL-DUNNO,DEB,OBJ >STACK
	RSTACK
?L52:	EQUAL? PRSA,V?DANCE,V?KISS,V?RUB \?L72
	CALL WILLING?,DEB,1 >STACK
	ZERO? STACK /FALSE
	CALL UNSNOOZE,DEB
	PUTP DEB,P?LINE,0
	PUTP DEB,P?LDESC,0
	PRINTI """Oooo"
	CALL PRINT-ID,STR?181
	CALL I-JUST-LOVE-IT
	RTRUE
?L72:	CALL PERSON-F,DEB,ARG >STACK
	RSTACK

	.FUNCT WILLING?,PER,KISS=0
	ZERO? KISS \?L1
	LESS? BED-TIME,PRESENT-TIME /FALSE
	CALL QUEUED?,I-TOUR >STACK
	ZERO? STACK \FALSE
	EQUAL? HERE,DINING-ROOM /FALSE
	CALL QUEUED?,I-DINNER-SIT >STACK
	ZERO? STACK \FALSE
	EQUAL? PER,CONFESSED,CAPTOR \TRUE
	RFALSE
?L1:	EQUAL? PER,FRIEND \?L10
	EQUAL? VARIATION,FRIEND-C /FALSE
	RTRUE
?L10:	EQUAL? PER,BUTLER \?L14
	EQUAL? PRSA,V?EMPTY \?L15
	EQUAL? HERE,YOUR-ROOM \FALSE
?L15:	EQUAL? PRSA,V?FOLLOW \TRUE
	RFALSE
?L14:	ZERO? GENDER-KNOWN /FALSE
	EQUAL? PER,DEB \?L20
	FSET? PLAYER,FEMALE /FALSE
	RTRUE
?L20:	EQUAL? PER,OFFICER \FALSE
	FSET? PLAYER,FEMALE \FALSE
	RTRUE

	.FUNCT OFFICER-D,ARG=0
	FSET? OFFICER,TOUCHBIT \?L1
	CALL DESCRIBE-PERSON,OFFICER
	RTRUE
?L1:	FSET OFFICER,TOUCHBIT
	FSET OFFICER,SEENBIT
	RTRUE

	.FUNCT I-JUST-LOVE-IT
	PRINTI "! I just love it when you do that, "
	CALL PRINT-NAME,FIRST-NAME
	PRINTR "!"""

	.FUNCT WINNER-DEFAULT,PER
	ZERO? GENDER-KNOWN /?L1
	PRINTC 34
	ZERO? FAWNING /?L5
	PRINTI "But "
?L5:	PRINTI "I really can't help you with that"
	EQUAL? PER,OFFICER \?L12
	CALL IAN-CALLS-YOU
?L12:	PRINTR "."""
?L1:	CALL WHY-ME
	RETURN 2

	.FUNCT OFFICER-F,ARG=0,P,OBJ,X
	EQUAL? ARG,M-WINNER \?L1
	SET 'FAWNING,0
	EQUAL? AWAITING-REPLY,OFFICER-1-R,OFFICER-2-R \?L3
	EQUAL? PRSA,V?NO,V?YES \?L3
	CALL ESTABLISH-GOAL,DOCTOR,HERE
	PUTP OFFICER,P?LDESC,0
	PUTP OFFICER,P?LINE,0
	PRINTC 34
	EQUAL? PRSA,V?YES \?L7
	PRINTI "Jolly good"
	EQUAL? AWAITING-REPLY,OFFICER-1-R \?L19
	PRINTI "! You're certainly quick"
	JUMP ?L19
?L7:	EQUAL? AWAITING-REPLY,OFFICER-1-R \?L16
	PRINTI "I dare say you soon shall"
	JUMP ?L19
?L16:	PRINTI "Pity"
?L19:	SET 'AWAITING-REPLY,0
	PRINTR "!"""
?L3:	CALL GRAB-ATTENTION,OFFICER >STACK
	ZERO? STACK \?L24
	RETURN 2
?L24:	EQUAL? PRSA,V?DESCRIBE \?L27
	EQUAL? PRSO,GHOST-NEW \?L27
	EQUAL? VARIATION,PAINTER-C \?L27
	PRINTI """Ghosts don't turn off lights, to my way of thinking. That alone makes me think our "
	PRINTD GHOST-OLD
	PRINTI "'s a fake. Somebody's sick idea of a joke, perhaps. "
	FSET GHOST-NEW,PERSONBIT
	PRINTI "Otherwise, the masquerade was highly effective. A female figure with "
	PRINT LONG-BLOND-HAIR
	PRINTR ", wearing the same sort of gown Dee was wearing that awful night she died -- at first it left me breathless. The only flaw, I should say, was the spook's height: too tall for Dee."""
?L27:	EQUAL? PRSA,V?FOLLOW \?L34
	EQUAL? PRSO,PLAYER \?L34
	CALL WILLING?,OFFICER >STACK
	ZERO? STACK /?L34
	PRINTI """What ho! A bit of sleuthing, eh, "
	CALL PRINT-NAME,FIRST-NAME
	PRINTI "?"""
	CRLF
	CALL NEW-FOLLOWER,OFFICER
	RTRUE
?L34:	CALL COM-CHECK,OFFICER >X
	ZERO? X /?L37
	EQUAL? X,M-FATAL /FALSE
	EQUAL? X,M-OTHER \TRUE
	RETURN 2
?L37:	CALL WINNER-DEFAULT,OFFICER >STACK
	RSTACK
?L1:	CALL ASKING-ABOUT?,OFFICER >OBJ
	ZERO? OBJ /?L45
	CALL GRAB-ATTENTION,OFFICER,OBJ >STACK
	ZERO? STACK \?L46
	RETURN 2
?L46:	EQUAL? OBJ,SEARCHER \?L50
	ZERO? CONFESSED \?L51
	GET TOLD-ABOUT-EVID,OFFICER-C >STACK
	ZERO? STACK /?L50
?L51:	PRINT IM-SHOCKED
	RTRUE
?L50:	EQUAL? OBJ,LENS,LENS-1,LENS-2 \?L54
	CALL HE-SHE-IT,OFFICER,1
	PRINTR " grins, ""It's not mine. Her Majesty would hardly allow me to serve in her Coldstream Guards were my vision faulty!"""
?L54:	EQUAL? OBJ,GHOST-NEW,DANGER,HAUNTING \?L57
	EQUAL? VARIATION,PAINTER-C \?L57
	PRINTI """It was the last time I came down here to visit Jack. We had been up late, playing cards in the "
	PRINTD GAME-ROOM
	PRINTR ". Then Jack toddled off to bed, but I stayed up to read and finish my drink. I must have dozed off with my glass in my hand, for I woke with a start as it crashed to the floor. And the first thing I saw was this figure in white at the other end of the room.""
He goes on, ""Blimey, I thought I was seeing things! For a moment I just gaped at it. Then the spook went haring off out the door, flicking off the light on the way. By the time I found the door, it was gone."""
?L57:	CALL COMMON-ASK-ABOUT,OFFICER,OBJ >X
	ZERO? X /?L60
	EQUAL? X,M-FATAL \TRUE
	RFALSE
?L60:	CALL TELL-DUNNO,OFFICER,OBJ >STACK
	RSTACK
?L45:	EQUAL? PRSA,V?DANCE,V?KISS,V?RUB \?L65
	CALL WILLING?,OFFICER,1 >STACK
	ZERO? STACK /FALSE
	CALL UNSNOOZE,OFFICER
	PUTP OFFICER,P?LINE,0
	PUTP OFFICER,P?LDESC,0
	PRINTI """Hello"
	CALL PRINT-ID,STR?182
	CALL I-JUST-LOVE-IT
	RTRUE
?L65:	CALL PERSON-F,OFFICER,ARG >STACK
	RSTACK

	.FUNCT IAN-CALLS-YOU
	GETB LAST-NAME,0 >STACK
	ZERO? STACK /FALSE
	PRINTI ", "
	CALL PRINT-NAME,FIRST-NAME
	ZERO? GENDER-KNOWN /TRUE
	FSET? PLAYER,FEMALE \?L8
	PRINTI " luv"
	RTRUE
?L8:	PRINTI " old "
	BTST PRESENT-TIME,1 \?L15
	PRINTI "chap"
	RTRUE
?L15:	PRINTI "son"
	RTRUE

	.FUNCT DOCTOR-D,ARG=0
	FSET? DOCTOR,TOUCHBIT \?L1
	CALL DESCRIBE-PERSON,DOCTOR
	RTRUE
?L1:	FSET DOCTOR,TOUCHBIT
	CRLF
	PRINTC 34
	ZERO? TOUR-FORCED /?L10
	PRINTI "Oh,"
	JUMP ?L14
?L10:	PRINTI "Do excuse me for interrupting,"" "
	PRINTD FRIEND
	PRINTI " breaks in, ""but"
?L14:	PRINTI " here comes "
	PRINTD DOCTOR
	PRINTI "! I'm sure "
	CALL PRINT-NAME,FIRST-NAME
	PRINTI " wants to meet such a distinguished scientist!""
"
	PRINTI "A man is coming downstairs. "
	CALL COMMON-DESC,DOCTOR
	SET 'QCONTEXT,DOCTOR
	CALL THIS-IS-IT,DOCTOR
	PUTP DOCTOR,P?LDESC,12
	SET 'AWAITING-REPLY,DOCTOR-C
	CALL QUEUE,I-REPLY,CLOCKER-RUNNING
	PRINTD FRIEND
	PRINT INTRODUCES
	PRINTI "him as one of Lionel's oldest friends, Dr. Nicholas Wendish.
He's carelessly dressed in rumpled evening clothes, but his hawk eyes peering at you through gold-rimmed specs show ruthless intelligence.
""I read about one of your mystery cases when I was in New York last year, "
	CALL TITLE-NAME
	PRINTI ","" he probes. """
	GET QUESTIONS,AWAITING-REPLY >STACK
	PRINT STACK
	PRINTI """
"
	RETURN 2

	.FUNCT DOCTOR-F,ARG=0,OBJ,X
	EQUAL? ARG,M-WINNER \?L1
	EQUAL? AWAITING-REPLY,DOCTOR-C \?L3
	EQUAL? PRSA,V?NO,V?YES \?L3
	PUTP DOCTOR,P?LDESC,0
	PUTP DOCTOR,P?LINE,0
	SET 'AWAITING-REPLY,0
	PRINTR """I see..."""
?L3:	CALL GRAB-ATTENTION,DOCTOR >STACK
	ZERO? STACK \?L7
	RETURN 2
?L7:	EQUAL? PRSA,V?DESCRIBE \?L10
	EQUAL? PRSO,GHOST-NEW \?L10
	EQUAL? VARIATION,DOCTOR-C \?L10
	PRINTD DOCTOR
	PRINTI " shrugs, with a look of distaste, as if he'd like to forget the episode. """
	PRINTI "I'm afraid I can't tell you any more, "
	CALL TITLE-NAME >STACK
	ZERO? STACK /?L17
	PRINTC 46
?L17:	PRINTI " I assumed the ghost was "
	PRINTD LOVER
	PRINTI ". It certainly looked like her: a blonde, attractive young woman. If it WASN'T "
	PRINTD LOVER
	PRINTR ", it was a convincing imposture."""
?L10:	CALL DIVESTMENT?,MUSTACHE >STACK
	ZERO? STACK /?L24
	EQUAL? VARIATION,DOCTOR-C \?L25
	PRINT MUSTACHE-STORY
	RTRUE
?L25:	CALL HAR-HAR >STACK
	RSTACK
?L24:	CALL COM-CHECK,DOCTOR >X
	ZERO? X /?L30
	EQUAL? X,M-FATAL /FALSE
	EQUAL? X,M-OTHER \TRUE
	RETURN 2
?L30:	CALL WHY-ME
	RETURN 2
?L1:	CALL ASKING-ABOUT?,DOCTOR >OBJ
	ZERO? OBJ /?L40
	CALL GRAB-ATTENTION,DOCTOR,OBJ >STACK
	ZERO? STACK \?L41
	RETURN 2
?L41:	EQUAL? OBJ,SEARCHER \?L45
	ZERO? CONFESSED \?L46
	GET TOLD-ABOUT-EVID,DOCTOR-C >STACK
	ZERO? STACK /?L45
?L46:	EQUAL? DOCTOR,SEARCHER /?L45
	PRINT IM-SHOCKED
	RTRUE
?L45:	EQUAL? OBJ,COUSIN,BUST \?L49
	PRINTR """He loved me as a brother."""
?L49:	EQUAL? OBJ,GHOST-NEW,DANGER,HAUNTING \?L52
	EQUAL? VARIATION,DOCTOR-C \?L52
	PRINTI "The doctor pauses, looking troubled, as if reluctant to speak, or perhaps marshaling his thoughts.
""On the very night after "
	PRINTD ACCIDENT
	PRINTI ","" he says at last, ""I couldn't sleep. I suppose the tragedy was on my mind. That and the medical cases I have in my London clinic for rare diseases. Anyhow, I took a stroll out in the "
	PRINTD COURTYARD
	PRINTI ". The fresh sea breeze was very soothing. When I went back inside, I felt ready for sleep. I went in through the "
	PRINTD OLD-GREAT-HALL
	PRINTI ", you see.""
He goes on, ""Then I saw this ghostly figure in white -- Good Lord, what a shock it gave me! I couldn't move for a moment; I thought "
	PRINTD LOVER
	PRINTI " had come back from the dead. As I stood there, staring, the ghost flitted off toward the "
	PRINTD BASEMENT
	PRINTR "... I felt no impulse to go after it, I might add."""
?L52:	EQUAL? OBJ,LENS,LENS-1,LENS-2 \?L55
	PRINTC 34
	EQUAL? VARIATION,DOCTOR-C,PAINTER-C \?L58
	ZERO? FOUND-IT-PERM /?L58
	PRINTI "Not mine. "
?L58:	PRINTR "As you see, I wear glasses at all times,"" he says."
?L55:	EQUAL? OBJ,MUSTACHE \?L65
	EQUAL? VARIATION,DOCTOR-C \?L65
	PRINT MUSTACHE-STORY
	RTRUE
?L65:	EQUAL? OBJ,WENDISH-STUFF \?L68
	PRINTR """I always bring them along."""
?L68:	CALL COMMON-ASK-ABOUT,DOCTOR,OBJ >X
	ZERO? X /?L71
	EQUAL? X,M-FATAL \TRUE
	RFALSE
?L71:	CALL TELL-DUNNO,DOCTOR,OBJ >STACK
	RSTACK
?L40:	CALL PERSON-F,DOCTOR,ARG >STACK
	RSTACK

	.FUNCT MUSTACHE-F
	EQUAL? PRSA,V?TAKE,V?MOVE,V?ASK-FOR /?L3
	CALL DIVESTMENT?,MUSTACHE >STACK
	ZERO? STACK /?L1
?L3:	IN? MUSTACHE,DOCTOR \?L1
	FSET? DOCTOR,MUNGBIT \?L4
	EQUAL? VARIATION,DOCTOR-C \FALSE
	FSET MUSTACHE,TAKEBIT
	FCLEAR MUSTACHE,TRYTAKEBIT
	RFALSE
?L4:	EQUAL? VARIATION,DOCTOR-C \?L10
	FSET? MUSTACHE,TOUCHBIT \?L9
?L10:	CALL FACE-RED,DOCTOR
	RTRUE
?L9:	FSET MUSTACHE,TOUCHBIT
	PRINTI "It comes off, leaving "
	PRINTD DOCTOR
	PRINTI " blinking with embarrassment. He grabs it and puts it in place again. "
	PRINT MUSTACHE-STORY
	RTRUE
?L1:	EQUAL? PRSA,V?WEAR /?L15
	EQUAL? PRSA,V?PUT \FALSE
	FSET? PRSI,PERSONBIT \FALSE
?L15:	CALL WEAR-SCARE >STACK
	RSTACK

	.FUNCT WENDISH-BOOK-F
	EQUAL? PRSA,V?READ,V?LOOK-INSIDE,V?EXAMINE \FALSE
	CALL NOT-HOLDING?,PRSO >STACK
	ZERO? STACK \TRUE
	PRINTI "The "
	PRINTD WENDISH-BOOK
	PRINTI " contains an incriminating record of "
	PRINTD DOCTOR
	PRINTI "'s fiendish experiments on patients at his clinic. Near the end you read:
""Finally took care of Poldark's granddau. (comely wench), pity[RWD_ID: people:1368, VAL: 1] she disc'd facts of his end."""
	CRLF
	ZERO? EVIDENCE-FOUND \?L8
	CALL CONGRATS
?L8:	SET 'EVIDENCE-FOUND,WENDISH-BOOK
	RETURN EVIDENCE-FOUND

	.FUNCT DEALER-D,ARG=0,PER
	CALL DESCRIBE-PERSON,DEALER
	RTRUE

	.FUNCT DEALER-F,ARG=0,OBJ,X
	EQUAL? ARG,M-WINNER \?L1
	CALL GRAB-ATTENTION,DEALER >STACK
	ZERO? STACK \?L3
	RETURN 2
?L3:	EQUAL? PRSA,V?DESCRIBE \?L7
	EQUAL? PRSO,GHOST-NEW \?L7
	EQUAL? VARIATION,PAINTER-C /?L7
	PRINTI """You're wondering, I presume, if it really was "
	PRINTD LOVER
	PRINTI " Hallam's ghost? Frankly, I don't put stock in ghosts, but my answer is... "
	FSET GHOST-NEW,PERSONBIT
	EQUAL? VARIATION,FRIEND-C,PAINTER-C,LORD-C \?L10
	PRINTI "possibly. That's as far as I'd go. It was certainly a female figure, in a shimmering whitish gown, sleeveless and cut low. She had "
	PRINT LONG-BLOND-HAIR
	PRINTI " like "
	PRINTD LOVER
	PRINTR "'s and was about her size. But as for her face -- my view was too brief,"" Hyde shrugs."
?L10:	PRINTI "I'm not at all convinced. Somehow it didn't match my memories of "
	PRINTD LOVER
	PRINTR ". For one thing, the gown wasn't her style, at all. Her clothes were always quite revealing. The ghost seemed quite covered up at the throat and arms. You might say it totally lacked feminine sex appeal."""
?L7:	CALL COM-CHECK,DEALER >X
	ZERO? X /?L17
	EQUAL? X,M-FATAL /FALSE
	EQUAL? X,M-OTHER \TRUE
	RETURN 2
?L17:	CALL WHY-ME
	RETURN 2
?L1:	CALL ASKING-ABOUT?,DEALER >OBJ
	ZERO? OBJ /?L27
	CALL GRAB-ATTENTION,DEALER,OBJ >STACK
	ZERO? STACK \?L28
	RETURN 2
?L28:	EQUAL? OBJ,SEARCHER \?L32
	ZERO? CONFESSED \?L33
	GET TOLD-ABOUT-EVID,DEALER-C >STACK
	ZERO? STACK /?L32
?L33:	PRINT IM-SHOCKED
	RTRUE
?L32:	EQUAL? OBJ,GHOST-NEW,DANGER,HAUNTING \?L36
	EQUAL? VARIATION,PAINTER-C /?L36
	PRINTI """I came down late one night to get a book that I'd left in the "
	PRINTD SITTING-ROOM
	PRINTI ". I had just turned 'round to go back upstairs when I saw a ghostly figure in the doorway. It fled as soon as I noticed it, in the "
	PRINTD INTDIR
	PRINTR " of the tower.""
He goes on, ""I was stunned, I must admit, so I dare say it took me a moment to collect my wits and go after it. I ran into the tower, but the spectre had vanished. This happened, by the way, a couple of weeks ago, on my last visit to the castle."""
?L36:	EQUAL? OBJ,LENS,LENS-1,LENS-2 \?L39
	CALL HE-SHE-IT,DEALER,1
	PRINTR " displays his monocle, saying, ""This is the only vision aid I require."""
?L39:	EQUAL? OBJ,ARMOR,BUST,FIGURINE /?L43
	EQUAL? OBJ,LOVER-PIC,OIL-PAINTING /?L43
	EQUAL? OBJ,PAINTING-GALLERY,WRITING-DESK \?L42
?L43:	PRINTR """I haven't formed my professional opinion as yet."""
?L42:	CALL COMMON-ASK-ABOUT,DEALER,OBJ >X
	ZERO? X /?L46
	EQUAL? X,M-FATAL \TRUE
	RFALSE
?L46:	CALL TELL-DUNNO,DEALER,OBJ >STACK
	RSTACK
?L27:	CALL PERSON-F,DEALER,ARG >STACK
	RSTACK

	.FUNCT PAINTER-D,ARG=0
	FSET? PAINTER,TOUCHBIT \?L1
	CALL DESCRIBE-PERSON,PAINTER
	RTRUE
?L1:	FSET PAINTER,TOUCHBIT
	FCLEAR DEALER,NDESCBIT
	LOC DEALER >STACK
	EQUAL? STACK,HERE,PSEUDO-OBJECT \TRUE
	GETP DEALER,P?LDESC >STACK
	EQUAL? STACK,2 \TRUE
	RFALSE

	.FUNCT PAINTER-F,ARG=0,OBJ,X
	EQUAL? ARG,M-WINNER \?L1
	CALL GRAB-ATTENTION,PAINTER >STACK
	ZERO? STACK \?L3
	RETURN 2
?L3:	EQUAL? PRSA,V?DESCRIBE \?L7
	EQUAL? PRSO,GHOST-NEW \?L7
	EQUAL? VARIATION,PAINTER-C \?L7
	FSET GHOST-NEW,PERSONBIT
	PRINTI """It was "
	PRINTD LOVER
	PRINTI ", or her ghost. What more can I say? A female figure, her size, wearing the same sort of shimmering white gown she had on the night she died -- and unmistakably her face! The likeness was heart-stopping...""
Vivien chokes up for a moment, then dabs her eyes. ""I'm sorry. I shouldn't let my feelings take over this way, but "
	PRINTD LOVER
	PRINTR " was such a lovely person!"""
?L7:	CALL COM-CHECK,PAINTER >X
	ZERO? X /?L12
	EQUAL? X,M-FATAL /FALSE
	EQUAL? X,M-OTHER \TRUE
	RETURN 2
?L12:	CALL WHY-ME
	RETURN 2
?L1:	CALL ASKING-ABOUT?,PAINTER >OBJ
	ZERO? OBJ /?L22
	CALL GRAB-ATTENTION,PAINTER,OBJ >STACK
	ZERO? STACK \?L23
	RETURN 2
?L23:	EQUAL? OBJ,BUST,FIGURINE \?L27
	PRINTR """Yes, that's one of my works."""
?L27:	EQUAL? OBJ,SEARCHER \?L30
	ZERO? CONFESSED \?L31
	GET TOLD-ABOUT-EVID,PAINTER-C >STACK
	ZERO? STACK /?L30
?L31:	EQUAL? PAINTER,SEARCHER /?L30
	PRINT IM-SHOCKED
	RTRUE
?L30:	EQUAL? OBJ,FRIEND \?L34
	EQUAL? VARIATION,PAINTER-C \?L34
	PRINT RHYMES-WITH-RICH
	CRLF
	RTRUE
?L34:	EQUAL? OBJ,GHOST-NEW,DANGER,HAUNTING \?L37
	EQUAL? VARIATION,PAINTER-C \?L37
	CALL HE-SHE-IT,PAINTER,1
	PRINTI " is somber as she replies, ""I dare say it was morbid of me, but one night I went to the "
	PRINTD BASEMENT
	PRINTI ", just to try to imagine the horrible scene when poor "
	PRINTD LOVER
	PRINTI " suffered her... tragic accident. Suddenly I heard someone calling my name softly. I turned 'round, and there was "
	PRINTD LOVER
	PRINTI " herself standing by the stairs"
	PRINTI "! I went absolutely numb! She smiled faintly, then fled up the stairs. I started to follow, but then I knew it was no use. "
	PRINTD LOVER
	PRINTR " is dead and gone, and chasing her ghost won't bring her back to me!"""
?L37:	EQUAL? OBJ,CLUE-2 \?L44
	EQUAL? VARIATION,LORD-C \?L44
	IN? OBJ,PAINTER /?L44
	CALL CLUE-2-STORY,PAINTER
	RTRUE
?L44:	EQUAL? OBJ,LENS,LENS-1,LENS-2 \?L45
	CALL HE-SHE-IT,PAINTER,1
	EQUAL? VARIATION,PAINTER-C \?L48
	PRINTI " says she wears"
	PRINT GLASSES-FOR
	PRINTI ", as everyone knows; then she shudders, ""But "
	PRINTD LENS
	PRINTR "es -- ugh! -- I could never tolerate them!"""
?L48:	PRINTI " admits to wearing "
	PRINTD LENS
	PRINTI "es at all times, and"
	PRINT GLASSES-FOR
	EQUAL? VARIATION,DOCTOR-C,PAINTER-C \?L55
	ZERO? FOUND-IT-PERM /?L55
	PRINTR ", but she says the lens you found isn't hers. With a cynical smile, she pops out both lenses, one at a time, to show you."
?L55:	PRINTR "."
?L45:	EQUAL? OBJ,LOVER \?L62
	PUTP PAINTER,P?LDESC,7
	PRINTI "The artist shrugs with a sad, wistful smile. ""What can I say? "
	PRINTD LOVER
	PRINTR " was a most unusual girl... utterly unworldly... almost fey.[RWD_ID: people:1584, VAL: 1] She grew up in a cottage not far from here, you know. Her drowning was a terrible tragedy... and yet... sometimes I'm not sure she WANTED to go on living."" She turns her face away to hide a tear."
?L62:	EQUAL? OBJ,LOVER-PIC \?L65
	PRINTI """Oh, you mean my portrait of dear "
	PRINTD LOVER
	PRINTR ". I don't believe I ever saw such skin as hers... or such hair."" She stops speaking and bites her lip."
?L65:	EQUAL? OBJ,OIL-PAINTING \?L68
	PRINTR """I don't admire the heroic style at all."""
?L68:	EQUAL? OBJ,VIVIEN-STUFF \?L71
	PRINTI """That's private property. It's no business of yours."""
	CRLF
	CALL PRINT-ID,STR?183 >STACK
	RSTACK
?L71:	CALL COMMON-ASK-ABOUT,PAINTER,OBJ >X
	ZERO? X /?L74
	EQUAL? X,M-FATAL \TRUE
	RFALSE
?L74:	CALL TELL-DUNNO,PAINTER,OBJ >STACK
	RSTACK
?L22:	EQUAL? PRSA,V?KISS \?L79
	GETP PAINTER,P?LDESC >STACK
	EQUAL? STACK,7 \?L79
	PUTP PAINTER,P?LINE,0
	PRINTR """You're sweet."""
?L79:	CALL PERSON-F,PAINTER,ARG >STACK
	RSTACK

	.FUNCT VIVIEN-DIARY-F
	EQUAL? PRSA,V?READ /?L3
	EQUAL? PRSA,V?OPEN,V?LOOK-INSIDE,V?EXAMINE \FALSE
?L3:	CALL NOT-HOLDING?,PRSO >STACK
	ZERO? STACK \TRUE
	PRINTD VIVIEN-DIARY
	PRINTI " falls open to a tear-stained page, and you read:
""O "
	PRINTD LOVER
	PRINTI ", sweet "
	PRINTD LOVER
	PRINTI "! Jack will pay dearly for your cruel death by losing his new sweetheart..."""
	CRLF
	ZERO? EVIDENCE-FOUND \?L9
	CALL CONGRATS
?L9:	SET 'EVIDENCE-FOUND,VIVIEN-DIARY
	RETURN EVIDENCE-FOUND

	.FUNCT COUSIN-F
	EQUAL? HERE,DINING-ROOM \FALSE
	CALL REMOTE-VERB? >STACK
	ZERO? STACK \FALSE
	CALL DO-INSTEAD-OF,BUST,COUSIN
	RTRUE

	.FUNCT BOLITHO-WILL
	PRINTC 32
	PRINTD BUTLER
	PRINTI " will see to the car and bring "
	PRINTD LUGGAGE
	RTRUE

	.FUNCT BUTLER-D,ARG=0,GT,SAID=0,LL=0,L
	FSET? BUTLER,TOUCHBIT \?L1
	CALL DESCRIBE-PERSON,BUTLER
	RTRUE
?L1:	FCLEAR BUTLER,NDESCBIT
	FSET BUTLER,TOUCHBIT
	EQUAL? HERE,COURTYARD,FOYER \?L7
	LOC LORD >STACK
	EQUAL? STACK,HERE,PSEUDO-OBJECT \?L4
	GETP LORD,P?LINE >STACK
	ZERO? STACK \?L4
	SET 'LL,1
?L4:	EQUAL? HERE,COURTYARD,FOYER \?L7
	LOC FRIEND >STACK
	EQUAL? STACK,HERE,PSEUDO-OBJECT \?L7
	SET 'SAID,1
	PRINTI "
""We can talk more later, "
	CALL PRINT-NAME,FIRST-NAME
	PRINTI ","" says "
	PRINTD FRIEND
	PRINTI ", taking your arm, ""but let's go in now, so you can meet the other guests."
?L7:	ZERO? LL /?L12
	ZERO? SAID /?L14
	PRINTC 34
	CRLF
	PRINTI """Yes, d"
	JUMP ?L18
?L14:	SET 'SAID,1
	PRINTI """D"
?L18:	PRINTI "o come in."
	CALL BOLITHO-WILL
	PRINTI ","" says "
	PRINTD LORD
	PRINTI " as a"
	JUMP ?L28
?L12:	ZERO? SAID /?L25
	CALL BOLITHO-WILL
	PRINTI "."""
	CRLF
	PRINTC 65
	JUMP ?L28
?L25:	PRINTC 65
?L28:	CALL THIS-IS-IT,BUTLER
	PRINTI "n elderly butler appears."
	ZERO? SAID \?L33
	PRINTI " He bows slightly to you."
?L33:	GETP BUTLER,P?CHARACTER >STACK
	GET GOAL-TABLES,STACK >GT
	CALL META-LOC,LUGGAGE >L
	EQUAL? L,YOUR-ROOM,YOUR-BATHROOM /?L48
	GETP L,P?LINE >STACK
	ZERO? STACK /?L48
	IN? LUGGAGE,BUTLER \?L40
	PRINTI " He has "
	PRINTD LUGGAGE
	PRINTI "."
	JUMP ?L47
?L40:	LOC BUTLER >STACK
	EQUAL? STACK,L \?L44
	PUT GT,GOAL-FUNCTION,BUTLER-CARRIES
	CALL ESTABLISH-GOAL,BUTLER,YOUR-ROOM
	FCLEAR LUGGAGE,OPENBIT
	MOVE LUGGAGE,BUTLER
	PRINTI " He takes "
	PRINTD LUGGAGE
	PRINTI "."
	JUMP ?L47
?L44:	PUT GT,GOAL-FUNCTION,BUTLER-FETCHES
	CALL ESTABLISH-GOAL,BUTLER,L
?L47:	ZERO? SAID \?L48
	PRINTI " ""I'll carry "
	PRINTD LUGGAGE
	PRINTI " to "
	PRINTD YOUR-ROOM
	PRINTI "."""
?L48:	CRLF
	RETURN 2

	.FUNCT BUTLER-SORRY
	PRINTI """Sorry, but I have duties to perform, "
	CALL TITLE-NAME >STACK
	ZERO? STACK /?L3
	PRINTC 46
?L3:	PRINTR """"

	.FUNCT BUTLER-F,ARG=0,OBJ,X
	EQUAL? ARG,M-WINNER \?L1
	EQUAL? AWAITING-REPLY,BUTLER-1-R,BUTLER-2-R /?L5
	EQUAL? AWAITING-REPLY,BUTLER-3-R,BUTLER-4-R \?L3
?L5:	EQUAL? PRSA,V?NO,V?YES \?L3
	PUTP BUTLER,P?LDESC,0
	PUTP BUTLER,P?LINE,0
	EQUAL? AWAITING-REPLY,BUTLER-1-R \?L6
	SET 'AWAITING-REPLY,0
	EQUAL? PRSA,V?YES \?L8
	CALL ROB,LUGGAGE,CHEST-OF-DRAWERS
?L8:	PRINTD BUTLER
	PRINTR " responds politely, like the well-trained butler he is. But he seems to have something important on his mind."
?L6:	EQUAL? AWAITING-REPLY,BUTLER-2-R \?L13
	SET 'AWAITING-REPLY,0
	EQUAL? PRSA,V?YES /?L14
	PRINTR """Oh!... Please pardon me."""
?L14:	PRINTI """Then no doubt you are here to investigate the spectral figure which has recently been seen about the castle."
	ZERO? BUTLER-GHOST-STORY-TOLD \?L21
	PRINTC 32
	CALL BUTLER-GHOST-STORY
	RTRUE
?L21:	PRINTR """"
?L13:	EQUAL? AWAITING-REPLY,BUTLER-3-R \?L28
	SET 'AWAITING-REPLY,0
	EQUAL? PRSA,V?YES \?L29
	MOVE MACE,PLAYER
	FSET MACE,SEENBIT
	FCLEAR MACE,NDESCBIT
	CALL THIS-IS-IT,MACE
	PRINTI """Should you find "
	PRINTD PLAYER
	PRINTI " in any danger from our "
	PRINTD GHOST-NEW
	PRINTI ", perhaps you could use this.""
"
	PRINTD BUTLER
	PRINTI " gives you a small "
	PRINTD MACE
	PRINTI ".

"
	RTRUE
?L29:	PRINTR """As you wish,"" he sniffs."
?L28:	SET 'AWAITING-REPLY,0
	EQUAL? PRSA,V?YES /?L37
	PRINTI """No doubt you soon shall. "
	JUMP ?L41
?L37:	PRINTC 34
?L41:	EQUAL? VARIATION,LORD-C,FRIEND-C \?L44
	PRINTI "To be precise, the ghost was just beyond the archway. It was bending over, groping for something on the "
	PRINTD DRAWING-ROOM
	PRINTI " carpet."
	JUMP ?L51
?L44:	PRINTI "If I may express an opinion, our "
	PRINTD GHOST-NEW
	PRINTI " must need reading glasses. The hall was ablaze with lights, yet it was bending down, groping blindly for something on the marble floor."
	EQUAL? VARIATION,DOCTOR-C \?L51
	PRINTI " And, I might add, it must also be left-handed. You see, "
	CALL TITLE-NAME
	PRINTI ", while bending over, the figure was using its left hand to grope with. I tried it myself, as did other servants, and we agree that such behavior indicates left-handedness."
?L51:	PRINTI """
He continues, ""The ghost must have heard my footsteps, for"
	PRINTI " it stood up, flashed me a startled glance, and fled into the darkness of the "
	PRINTD DRAWING-ROOM
	PRINTI ". I pursued, turning on the lights, but the thing had disappeared. I went into the foyer, but it was not there either, and the "
	PRINTD FRONT-DOOR
	PRINTR " was still locked -- from the inside."""
?L3:	CALL GRAB-ATTENTION,BUTLER >STACK
	ZERO? STACK \?L62
	RETURN 2
?L62:	EQUAL? PRSA,V?DESCRIBE \?L65
	EQUAL? PRSO,GHOST-NEW \?L65
	FSET GHOST-NEW,PERSONBIT
	PRINTI """Frankly, I found it unconvincing. I don't see why a ghost would grope about on the floor to find something -- especially in a spot that wasn't even built when the "
	PRINTD GHOST-OLD
	PRINTI " was walled up in the tower. Besides, why should a ghost be scared away by a human being? It's usually the opposite, is it not?... No, "
	CALL TITLE-NAME
	PRINTI ", in my opinion that figure just didn't behave like a proper ghost. It had "
	PRINT LONG-BLOND-HAIR
	PRINTI " and was clad in a silvery-white "
	EQUAL? VARIATION,DOCTOR-C \?L68
	PRINTI "long-sleeved"
	JUMP ?L72
?L68:	PRINTI "sleeveless"
?L72:	PRINTI " gown. I caught only a brief glimpse of its face, deadly white. As to height, it was too bent over for me to make out. If someone was masquerading as a ghost, of course, the imposter might well have been a man. However, as for the figure I saw -- "
	EQUAL? VARIATION,DOCTOR-C \?L77
	PRINTR "I cannot be sure of its sex."""
?L77:	PRINTR "it seemed to me quite feminine."""
?L65:	EQUAL? PRSA,V?WALK-TO,V?WALK,V?THROUGH /?L85
	EQUAL? PRSA,V?STAND,V?SIT-AT,V?SIT /?L85
	EQUAL? PRSA,V?OPEN,V?LEAVE /?L85
	EQUAL? PRSA,V?EMPTY,V?DISEMBARK,V?CLOSE \?L84
?L85:	CALL WILLING?,BUTLER >STACK
	ZERO? STACK /?L84
	EQUAL? PRSA,V?LEAVE /FALSE
	EQUAL? PRSA,V?WALK-TO,V?THROUGH \?L88
	EQUAL? PRSO,PASSAGE,DINNER /FALSE
?L88:	PRINTI """As you wish, "
	CALL TITLE-NAME >STACK
	ZERO? STACK /?L91
	PRINTC 46
?L91:	PRINTI """
"
	RFALSE
?L84:	CALL COM-CHECK,BUTLER >X
	ZERO? X /?L99
	EQUAL? X,M-FATAL /FALSE
	EQUAL? X,M-OTHER \TRUE
	RETURN 2
?L99:	CALL BUTLER-SORRY
	RETURN 2
?L1:	CALL ASKING-ABOUT?,BUTLER >OBJ
	ZERO? OBJ /?L109
	CALL GRAB-ATTENTION,BUTLER,OBJ >STACK
	ZERO? STACK \?L110
	RETURN 2
?L110:	EQUAL? OBJ,ACCIDENT,LOVER \?L114
	PRINTI """Perhaps you've heard how I was sent to the "
	PRINTD BASEMENT
	PRINTI " to find her. I found a tent pole and a shoe in front of the well, near one end of the "
	PRINTD WINE-RACK
	PRINTI ". The pole belonged to Lord Lionel. The shoe's spike heel was wrenched loose. I knew at once there had been an accident. Apparently Miss "
	PRINTD LOVER
	PRINTI ", in her cups, had stumbled over the pole and grabbed at the well for support. But as she was nowhere in sight, and her red necklace was lying beside the well, I assumed she had toppled down the well. When "
	PRINTD LORD
	PRINTI " arrived, he shone an electric torch down the well and"
	PRINT FOUND-FABRIC
	PRINTI " Evidently it was ripped off as she fell. At any rate, the police concluded that she had drowned. They lowered a diver into the well, but "
	PRINTD CORPSE
	PRINTR " was never found."""
?L114:	EQUAL? OBJ,BUTLER \?L117
	PRINTR """There's not much to tell. I've served the family all my life. Should you require anything, feel free to ask."""
?L117:	EQUAL? OBJ,SEARCHER \?L120
	ZERO? CONFESSED \?L121
	GET TOLD-ABOUT-EVID,BUTLER-C >STACK
	ZERO? STACK /?L120
?L121:	PRINT IM-SHOCKED
	RTRUE
?L120:	EQUAL? OBJ,GHOST-NEW,DANGER,HAUNTING \?L124
	PRINTC 34
	CALL BUTLER-GHOST-STORY >STACK
	RSTACK
?L124:	EQUAL? OBJ,GHOST-OLD \?L127
	PRINTI """They do say "
	PRINTD CASTLE
	PRINTR " is haunted."""
?L127:	EQUAL? OBJ,LAMP \?L130
	PRINTI """Yes, we keep"
	CALL IN-CASE-OF-BLACKOUT
	RTRUE
?L130:	EQUAL? OBJ,YOUR-MIRROR,DRESSING-MIRROR \?L133
	PRINTI """S"
	CALL BUTLER-MIRROR-STORY >STACK
	RSTACK
?L133:	EQUAL? OBJ,PRIEST-DOOR /?L137
	EQUAL? OBJ,PASSAGE \?L136
	GET FOUND-PASSAGES,BUTLER-C >STACK
	ZERO? STACK \?L136
?L137:	PRINTI "The butler hesitates, looking thoughtful. ""I daresay that sort of thing would be better known to his lordship than to any of the staff, "
	CALL TITLE-NAME
	PRINTR "."""
?L136:	CALL COMMON-ASK-ABOUT,BUTLER,OBJ >X
	ZERO? X /?L140
	EQUAL? X,M-FATAL \TRUE
	RFALSE
?L140:	PRINTI """I'm afraid it's not my place to say, "
	CALL TITLE-NAME >STACK
	ZERO? STACK /?L147
	PRINTC 46
?L147:	PRINTR """"
?L109:	CALL PERSON-F,BUTLER,ARG >STACK
	RSTACK

	.FUNCT IN-CASE-OF-BLACKOUT
	PRINTR " that in case of a power outage."""

	.FUNCT BUTLER-GHOST-STORY
	SET 'BUTLER-GHOST-STORY-TOLD,1
	SET 'QCONTEXT,BUTLER
	CALL THIS-IS-IT,BUTLER
	PUTP BUTLER,P?LDESC,12
	SET 'AWAITING-REPLY,BUTLER-4-R
	SET 'CLOCK-WAIT,1
	EQUAL? HERE,GREAT-HALL \?L1
	PUT QUESTIONS,AWAITING-REPLY,STR?184
?L1:	PRINTI "I myself glimpsed the ghost just last night. "
	PRINTD LORD
	PRINTI " and some guests were sitting up late, "
	GET LDESC-STRINGS,13 >STACK
	PRINT STACK
	PRINTI " in the "
	PRINTD GREAT-HALL
	PRINTI ". After they retired, I came upstairs to clean up and turn off the lights. As I entered the "
	PRINTD GREAT-HALL
	PRINTI " from the west, I saw the ghost on the far side of the room. "
	GET QUESTIONS,AWAITING-REPLY >STACK
	PRINT STACK
	PRINTI """"
	CRLF
	RETURN 2

	.FUNCT BUTLER-MIRROR-STORY
	PRINTI "hould you wish to view "
	PRINTD PLAYER
	PRINTI " from all angles while dressing, you can do so by adjusting the "
	PRINTD YOUR-MIRROR
	PRINTI " and the hinged "
	PRINTD DRESSING-MIRROR
	PRINTI " of the "
	PRINTD DRESSING-TABLE
	PRINTR "."""

	.FUNCT GHOST-NEW-D,ARG=0
	FSET? GHOST-NEW,TOUCHBIT \?L1
	CALL DESCRIBE-PERSON,GHOST-NEW
	RTRUE
?L1:	FCLEAR GHOST-NEW,NDESCBIT
	FSET GHOST-NEW,PERSONBIT
	FSET GHOST-NEW,TOUCHBIT
	FSET GHOST-NEW,SEENBIT
	FSET COSTUME,SEENBIT
	CRLF
	FSET? GHOST-NEW,MUNGBIT \?L4
	PRINTI "Lying "
	CALL GROUND-DESC >STACK
	PRINT STACK
	PRINTI " i"
	JUMP ?L8
?L4:	PRINTI "Out of the dark come"
?L8:	PRINTI "s a figure with "
	PRINT LONG-BLOND-HAIR
	PRINTR ", dressed all in silvery white and glowing with an almost unearthly light."

	.FUNCT GHOST-NEW-F,ARG=0,OBJ
	EQUAL? ARG,M-WINNER \?L1
	CALL GRAB-ATTENTION,GHOST-NEW >STACK
	ZERO? STACK \?L3
	RETURN 2
?L3:	PRINT GHOST-CACKLES
	RETURN 2
?L1:	CALL ASKING-ABOUT?,GHOST-NEW >OBJ
	ZERO? OBJ /?L12
	CALL GRAB-ATTENTION,GHOST-NEW,OBJ >STACK
	ZERO? STACK /?L19
	EQUAL? VARIATION,LORD-C /?L15
	PRINT GHOST-CACKLES
	RETURN 2
?L15:	CALL LOVER-SPEECH >STACK
	ZERO? STACK \?L19
	CALL GHOST-FLEES
?L19:	RETURN 2
?L12:	EQUAL? PRSA,V?EXAMINE \?L24
	CALL HE-SHE-IT,GHOST-NEW,1
	PRINTI " is wearing heavy white makeup with black eyes and lips. "
	CALL DESCRIBE-GOWN
	CRLF
	CALL COMMON-OTHER,GHOST-NEW >STACK
	RSTACK
?L24:	EQUAL? PRSA,V?UNDRESS,V?SEARCH,V?BRUSH /?L28
	EQUAL? PRSA,V?SEARCH-FOR \?L27
	EQUAL? PRSI,COSTUME \?L27
?L28:	FSET? GHOST-NEW,MUNGBIT /?L29
	PRINT GHOST-CACKLES
	RTRUE
?L29:	IN? COSTUME,GHOST-NEW \FALSE
	CALL UNDRESS-GHOST
	RTRUE
?L27:	CALL GHOST-NEW-VERBS >OBJ
	ZERO? OBJ /?L35
	CALL GRAB-ATTENTION,GHOST-NEW >STACK
	ZERO? STACK /?L42
	EQUAL? VARIATION,LORD-C /?L38
	PRINT GHOST-CACKLES
	RETURN 2
?L38:	EQUAL? OBJ,2 /?L43
	CALL LOVER-SPEECH >STACK
	ZERO? STACK \?L42
?L43:	CALL GHOST-FLEES
?L42:	RETURN 2
?L35:	CALL PERSON-F,GHOST-NEW,ARG >STACK
	RSTACK

	.FUNCT GHOST-NEW-VERBS
	EQUAL? PRSA,V?SGIVE,V?GIVE,V?BOW /TRUE
	EQUAL? PRSA,V?RUB,V?LISTEN,V?KISS /TRUE
	EQUAL? PRSA,V?SMILE /TRUE
	CALL SPEAKING-VERB?,GHOST-NEW >STACK
	ZERO? STACK \TRUE
	EQUAL? PRSA,V?YELL,V?STOP,V?SLAP /?L7
	EQUAL? PRSA,V?PUSH,V?MUNG,V?ARREST \?L6
?L7:	RETURN 2
?L6:	EQUAL? PRSA,V?TAKE \FALSE
	FSET? GHOST-NEW,MUNGBIT /FALSE
	RETURN 2

	.FUNCT UNDRESS-GHOST,L,ADJ
	LOC GHOST-NEW >L
	MOVE COSTUME,WINNER
	FCLEAR COSTUME,NDESCBIT
	FCLEAR COSTUME,WORNBIT
	FSET COSTUME,TOUCHBIT
	FSET COSTUME,TAKEBIT
	MOVE GHOST-NEW,LOCAL-GLOBALS
	MOVE VILLAIN-PER,L
	GETP VILLAIN-PER,P?STATION >ADJ
	ZERO? ADJ /?L3
	ZERO? OTHER-POSS-POS /?L3
	GETPT HEAD,P?ADJECTIVE >STACK
	PUTB STACK,OTHER-POSS-POS,ADJ
	GETPT HANDS,P?ADJECTIVE >STACK
	PUTB STACK,OTHER-POSS-POS,ADJ
	GETPT EYE,P?ADJECTIVE >STACK
	PUTB STACK,OTHER-POSS-POS,ADJ
	GETPT OTHER-OUTFIT,P?ADJECTIVE >STACK
	PUTB STACK,OTHER-POSS-POS,ADJ
?L3:	CALL THIS-IS-IT,VILLAIN-PER
	FSET VILLAIN-PER,MUNGBIT
	PUTP VILLAIN-PER,P?LDESC,19
	SET 'VILLAIN-KNOWN?,1
	PRINTI "When you remove the "
	PRINTD COSTUME
	PRINTI ", you discover "
	PRINTD VILLAIN-PER
	PRINTI " underneath!"
	CRLF
	CALL CONGRATS,COSTUME >STACK
	RSTACK

	.FUNCT DESCRIBE-GOWN
	FSET GHOST-NEW,PERSONBIT
	PRINTI "The gown "
	EQUAL? LIT,HERE /?L3
	PRINTI "seems to fluoresce in the dark. It "
?L3:	PRINTI "has a "
	EQUAL? VARIATION,DOCTOR-C \?L10
	PRINTI "high"
	JUMP ?L14
?L10:	PRINTI "low"
?L14:	PRINTI " neckline and "
	EQUAL? VARIATION,DOCTOR-C \?L19
	PRINTI "long"
	JUMP ?L23
?L19:	PRINTI "no"
?L23:	PRINTI " sleeves."
	RTRUE

	.FUNCT COSTUME-F
	EQUAL? PRSA,V?TELL-ABOUT \?L1
	FSET? PRSO,PERSONBIT \FALSE
	GETP PRSO,P?CHARACTER >STACK
	EQUAL? VARIATION,STACK \?L5
	SET 'PRSA,V?ASK-ABOUT
	RFALSE
?L5:	CALL TELL-ABOUT-OBJECT,PRSO,COSTUME,FOUND-COSTUME >STACK
	RSTACK
?L1:	CALL REMOTE-VERB? >STACK
	ZERO? STACK \FALSE
	CALL NOUN-USED?,W?WIG >STACK
	ZERO? STACK /?L10
	EQUAL? VARIATION,LORD-C \?L10
	SET 'CLOCK-WAIT,1
	PRINTR "(There is no wig!)"
?L10:	EQUAL? PRSA,V?LOOK-INSIDE,V?EXAMINE \?L13
	CALL NOUN-USED?,W?WIG >STACK
	ZERO? STACK \?L14
	CALL DESCRIBE-GOWN
	LOC COSTUME >STACK
	EQUAL? STACK,GHOST-NEW,VILLAIN-PER \?L16
	PRINTI " It's on"
	JUMP ?L20
?L16:	PRINTI " When you hold it up, you can see it would fit"
?L20:	PRINTI " a "
	EQUAL? VARIATION,LORD-C,FRIEND-C,DOCTOR-C \?L25
	PRINTI "person of average height."
	JUMP ?L29
?L25:	PRINTI "tall person."
?L29:	CRLF
?L14:	CALL NOUN-USED?,W?GOWN >STACK
	ZERO? STACK \TRUE
	EQUAL? VARIATION,LORD-C /TRUE
	PRINTI "It's obvious that the wig was designed to resemble "
	PRINTD LOVER
	PRINTI "'s long, flowing hair."
	CRLF
	LOC COSTUME >STACK
	EQUAL? STACK,GHOST-NEW,VILLAIN-PER /TRUE
	PRINTI "Inside, you notice several individual "
	EQUAL? VARIATION,FRIEND-C \?L41
	PRINTI "red"
	JUMP ?L48
?L41:	EQUAL? VARIATION,DOCTOR-C \?L45
	PRINTI "grayish"
	JUMP ?L48
?L45:	PRINTI "tawny"
?L48:	PRINTI " hairs, the same color as "
	GET CHARACTER-TABLE,VARIATION >STACK
	PRINTD STACK
	PRINTI "'s hair."
	CRLF
	CALL CONGRATS,COSTUME
	RTRUE
?L13:	EQUAL? PRSA,V?TAKE-OFF,V?TAKE,V?LOOK-UNDER \?L61
	IN? COSTUME,GHOST-NEW \FALSE
	CALL PERFORM,V?UNDRESS,GHOST-NEW
	RTRUE
?L61:	EQUAL? PRSA,V?WEAR /?L66
	EQUAL? PRSA,V?PUT \FALSE
	ZERO? PRSI /FALSE
	FSET? PRSI,PERSONBIT \FALSE
?L66:	CALL WEAR-SCARE >STACK
	RSTACK

	.FUNCT WEAR-SCARE
	PRINTI "You start to put"
	CALL PRINTT,PRSO
	PRINTI " on"
	ZERO? PRSI /?L3
	PRINTC 32
	PRINTD PRSI
?L3:	PRINTI ", but"
	EQUAL? PRSO,NECKLACE-OF-D \?L10
	PRINT CLASP-MUNGED
	PRINTR "."
?L10:	PRINTR " then decide it might scare the other guests."

	.FUNCT WHY-ME
	BTST PRESENT-TIME,1 \?L1
	PRINTI """You could do that "
	PRINTD PLAYER
	PRINTR ", you know."""
?L1:	PRINTI """I think you can do that better "
	PRINTD PLAYER
	PRINTR "."""

	.FUNCT DESCRIBE-PERSON,PER,STR=0
	GETP PER,P?LDESC >STR
	EQUAL? PER,BUTLER,LOVER /?L1
	CALL ALL-TOGETHER-NOW? >STACK
	ZERO? STACK /?L1
	EQUAL? PER,LORD \TRUE
	SET 'P-HIM-OBJECT,0
	SET 'P-HER-OBJECT,0
	PRINTD PER
	PRINTI " and all his guests are here."
	ZERO? CONFESSED \?L7
	CALL QUEUED?,I-LIONEL-SPEAKS >STACK
	ZERO? STACK \?L7
	PRINTI " They smile pleasantly but, with typical British reserve, seem willing to leave you to your own devices."
?L7:	CRLF
	RTRUE
?L1:	ZERO? STR /?L14
	GETP PER,P?CHARACTER >STACK
	PUT TOUCHED-LDESCS,STACK,STR
	RFALSE
?L14:	CALL START-SENTENCE,PER
	PRINTI " is "
	GETPT PER,P?WEST >STR
	ZERO? STR /?L19
	GET STR,NEXITSTR >STR
	ZERO? STR /?L19
	PRINT STR
?L19:	PRINTI "."
	EQUAL? STR,6 \?L26
	PRINTC 32
	RTRUE
?L26:	CRLF
	RTRUE

	.FUNCT ALL-TOGETHER-NOW?
	LOC LORD >STACK
	EQUAL? STACK,HERE,PSEUDO-OBJECT \FALSE
	LOC FRIEND >STACK
	EQUAL? STACK,HERE,PSEUDO-OBJECT \FALSE
	LOC DEB >STACK
	EQUAL? STACK,HERE,PSEUDO-OBJECT \FALSE
	LOC OFFICER >STACK
	EQUAL? STACK,HERE,PSEUDO-OBJECT \FALSE
	LOC DOCTOR >STACK
	EQUAL? STACK,HERE,PSEUDO-OBJECT \FALSE
	LOC DEALER >STACK
	EQUAL? STACK,HERE,PSEUDO-OBJECT \FALSE
	LOC PAINTER >STACK
	EQUAL? STACK,HERE,PSEUDO-OBJECT \FALSE
	RTRUE

	.FUNCT TELL-ABOUT-OBJECT,PER,OBJ,GL,C
	GET GL,PLAYER-C >STACK
	ZERO? STACK /FALSE
	GETP PER,P?CHARACTER >C
	GET GL,C >STACK
	ZERO? STACK \?L3
	PUT GL,C,1
	EQUAL? C,VARIATION /?L5
	PUTP PER,P?LINE,0
?L5:	CALL GOOD-SHOW,PER,OBJ >STACK
	RSTACK
?L3:	PRINTI """I know that you found a "
	PRINTD OBJ
	PRINTR "."""

	.FUNCT PERSON-F,PER,ARG,OBJ,X,L,C,N
	LOC PER >L
	GETP PER,P?CHARACTER >C
	EQUAL? PRSA,V?SHAKE,V?ALARM \?L1
	EQUAL? PRSO,PER \FALSE
	CALL QUEUED?,I-COME-TO >STACK
	ZERO? STACK /?L5
	EQUAL? PER,VILLAIN-PER,GHOST-NEW \?L5
	CALL QUEUE,I-COME-TO,1
	RTRUE
?L5:	CALL UNSNOOZE,PER,1 >STACK
	ZERO? STACK /?L7
	CALL HE-SHE-IT,PER,1
	PRINTR " gasps to see you so close!"
?L7:	CALL HE-SHE-IT,PER,1,STR?44
	PRINTI " still "
	GETP PER,P?LDESC >X
	ZERO? X /?L13
	GET LDESC-STRINGS,X >STACK
	PRINT STACK
	JUMP ?L17
?L13:	GETPT PER,P?WEST >X
	ZERO? X /?L17
	GET X,NEXITSTR >STACK
	PRINT STACK
?L17:	PRINTR "."
?L1:	EQUAL? PRSA,V?FORGIVE \?L24
	CALL GRAB-ATTENTION,PER >STACK
	ZERO? STACK \?L25
	RETURN 2
?L25:	PRINTR """Thank you so much. I didn't realize I'd offended you."""
?L24:	EQUAL? PRSA,V?GIVE \?L32
	EQUAL? PRSI,PER \FALSE
	CALL HELD?,PRSO >STACK
	ZERO? STACK /FALSE
	CALL GRAB-ATTENTION,PER >STACK
	ZERO? STACK \FALSE
	RETURN 2
?L32:	EQUAL? PRSA,V?LAMP-OFF \?L41
	GETP PER,P?LINE >STACK
	ZERO? STACK /?L42
	PRINTR "Seems you've already done that."
?L42:	CALL WONT-HELP >STACK
	RSTACK
?L41:	EQUAL? PRSA,V?SEARCH-FOR,V?SEARCH,V?MUNG \?L47
	EQUAL? PER,PRSO \FALSE
	FSET? PER,PERSONBIT \FALSE
	FSET? PER,MUNGBIT /FALSE
	GETP PER,P?LINE >STACK
	INC 'STACK
	PUTP PER,P?LINE,STACK
	GETP PER,P?LDESC >STACK
	EQUAL? STACK,4 /?L50
	PUTP PER,P?LDESC,20
?L50:	CALL HE-SHE-IT,PER,1
	PRINTR " pushes you away and mutters, ""I don't think that's called for."""
?L47:	EQUAL? PRSA,V?SHOW \?L56
	EQUAL? PER,PRSO \FALSE
	CALL GRAB-ATTENTION,PER >STACK
	ZERO? STACK \?L59
	RETURN 2
?L59:	CALL PERFORM,V?TELL-ABOUT,PRSO,PRSI
	RTRUE
?L56:	EQUAL? PRSA,V?SMILE \?L65
	EQUAL? PER,PRSO \FALSE
	CALL GRAB-ATTENTION,PER >STACK
	ZERO? STACK \?L68
	RETURN 2
?L68:	CALL HE-SHE-IT,PRSO,1,STR?185
	PRINTR " back at you."
?L65:	EQUAL? PRSA,V?TELL-ABOUT \?L76
	EQUAL? PER,PRSO \FALSE
	CALL GRAB-ATTENTION,PER >STACK
	ZERO? STACK \?L79
	RETURN 2
?L79:	PUTP PER,P?LDESC,12
	FSET? PRSI,RMUNGBIT \?L84
	FSET? PRSI,SEENBIT \?L84
	FSET? PRSI,PERSONBIT /?L84
	GETP PER,P?CHARACTER >STACK
	PUT TOLD-ABOUT-EVID,STACK,1
	PRINT THATS-INTERESTING
	RTRUE
?L84:	EQUAL? PRSI,CLUE-1 \?L88
	PRINT THATS-INTERESTING
	RTRUE
?L88:	EQUAL? PRSI,CONFESSED \?L91
	EQUAL? PER,CONFESSED /?L103
	PRINT IM-SHOCKED
	RTRUE
?L91:	EQUAL? PRSI,GHOST-NEW \?L97
	FSET? GHOST-NEW,TOUCHBIT \?L103
	EQUAL? PER,GHOST-NEW /?L103
	GETP PER,P?CHARACTER >STACK
	PUT TOLD-ABOUT-GHOST,STACK,1
	PRINTR """You saw the ghost? Tell me, how can I help?"""
?L97:	CALL SECRET-PASSAGE-OR-DOOR?,PRSI >STACK
	ZERO? STACK /?L103
	CALL TELL-ABOUT-OBJECT,PRSO,PASSAGE,FOUND-PASSAGES
	RTRUE
?L103:	PRINTR """I don't know what you mean."""
?L76:	EQUAL? PRSA,V?THROW-AT \?L108
	EQUAL? PER,PRSI \FALSE
	FSET? PER,PERSONBIT \FALSE
	FSET? PER,MUNGBIT /FALSE
	MOVE PRSO,PRSI
	CALL HE-SHE-IT,PER,1
	PRINTI " catches"
	CALL PRINTT,PRSO
	PRINTI " with"
	CALL HIM-HER-IT,PER,0,1
	PRINTC 32
	EQUAL? PER,DEB,DOCTOR \?L113
	PRINTI "lef"
	JUMP ?L117
?L113:	PRINTI "righ"
?L117:	PRINTR "t hand."
?L108:	CALL COMMON-OTHER,PER >STACK
	RSTACK

	.FUNCT SECRET-PASSAGE-OR-DOOR?,OBJ
	EQUAL? OBJ,PASSAGE,SECRET-JACK-DOOR,SECRET-TAMARA-DOOR /TRUE
	EQUAL? OBJ,SECRET-LIBRARY-DOOR,SECRET-DRAWING-DOOR,SECRET-SITTING-DOOR /TRUE
	EQUAL? OBJ,SECRET-DINING-DOOR,SECRET-YOUR-DOOR,SECRET-IRIS-DOOR /TRUE
	EQUAL? OBJ,SECRET-WENDISH-DOOR,SECRET-VIVIEN-DOOR,SECRET-IAN-DOOR /TRUE
	EQUAL? OBJ,SECRET-HYDE-DOOR /TRUE
	RFALSE

	.FUNCT CARRY-CHECK,PER
	FIRST? PER >STACK \FALSE
	CALL HE-SHE-IT,PER,1,STR?44
	PRINTI " holding"
	CALL PRINT-CONTENTS,PER
	PRINTR "."

	.FUNCT WINNER-DESCRIBE,OBJ,RM
	PRINTI """You can see "
	PRINTD OBJ
	EQUAL? HERE,RM \?L3
	PRINTI " right over there"
	JUMP ?L7
?L3:	PRINTI " in the "
	PRINTD RM
?L7:	PRINTR "."""

	.FUNCT TRANSIT-TEST,PER
	EQUAL? PRSA,V?WALK-TO,V?WALK,V?THROUGH /?L3
	EQUAL? PRSA,V?TAKE-TO,V?LEAVE,V?DISEMBARK \FALSE
?L3:	CALL WILLING?,PER >STACK
	RSTACK

	.FUNCT COM-CHECK,PER,N,TAG
	GETP PER,P?LINE >N
	GETP PER,P?CHARACTER >STACK
	GET TOLD-ABOUT-GHOST,STACK >TAG
	EQUAL? PRSA,V?$0024CALL \?L1
	CALL DONT-UNDERSTAND
	RETURN M-OTHER
?L1:	CALL TRANSIT-TEST,PER >STACK
	ZERO? STACK /?L3
	RETURN 2
?L3:	EQUAL? PRSA,V?SORRY,V?HELLO,V?ALARM \?L6
	EQUAL? PRSO,ROOMS /?L9
	EQUAL? PRSO,PER \FALSE
?L9:	SET 'WINNER,PLAYER
	CALL PERFORM,PRSA,PER
	RTRUE
?L6:	EQUAL? PRSA,V?YES /?L12
	EQUAL? PRSA,V?THANKS,V?NO,V?ARREST \?L11
?L12:	RETURN 2
?L11:	EQUAL? PRSA,V?DESCRIBE \?L15
	EQUAL? PRSO,GHOST-NEW \?L16
	PRINTI """I'm sorry, but I didn't see"
	CALL HIM-HER-IT,GHOST-NEW
	PRINTR "."""
?L16:	EQUAL? PRSO,MAID \?L20
	PRINT NEVER-NOTICED-HER
	RTRUE
?L20:	EQUAL? PRSO,BUST,COUSIN \?L23
	CALL WINNER-DESCRIBE,BUST,DINING-ROOM
	RTRUE
?L23:	EQUAL? PRSO,LOVER \?L24
	CALL WINNER-DESCRIBE,LOVER-PIC,DRAWING-ROOM
	RTRUE
?L24:	PRINTI """You could "
	CALL META-LOC,PRSO >STACK
	EQUAL? STACK,HERE /?L28
	PRINTI "go "
?L28:	PRINTI "have a look for "
	PRINTD PLAYER
	PRINTR ", you know."""
?L15:	EQUAL? PRSA,V?WALK-TO,V?FOLLOW \?L35
	EQUAL? PER,BUTLER /FALSE
	EQUAL? PRSA,V?WALK-TO \?L38
	ZERO? TAG \?L39
	EQUAL? PRSO,TAMARA-BED,BED,SLEEP-GLOBAL \?L38
?L39:	RETURN 2
?L38:	PRINTI """I will go where I please, thank you very much."""
	CRLF
	CALL PRINT-ID,STR?186
	RTRUE
?L35:	EQUAL? PRSA,V?INVENTORY \?L45
	CALL CARRY-CHECK,PER >STACK
	ZERO? STACK \TRUE
	CALL HE-SHE-IT,PER,1,STR?44
	PRINTR "n't holding anything."
?L45:	EQUAL? PRSA,V?LISTEN \?L51
	EQUAL? PRSO,PLAYER-NAME,PLAYER /?L54
	IN? PRSO,GLOBAL-OBJECTS /FALSE
?L54:	PRINTI """I'm trying to, "
	CALL PRINT-NAME,FIRST-NAME
	PRINTR "!"""
?L51:	EQUAL? PRSA,V?RUB \?L58
	CALL FACE-RED
	RTRUE
?L58:	RANDOM 3 >STACK
	EQUAL? STACK,1 \?L66
	CALL WILLING?,PER,1 >STACK
	ZERO? STACK /?L66
	EQUAL? PER,DEB \?L62
	SET 'FAWNING,1
	PRINTI """My dear "
	CALL PRINT-NAME,FIRST-NAME
	PRINTI ", how could I refuse someone as handsome as you?"" Iris murmurs, batting her eyelashes. "
	JUMP ?L66
?L62:	EQUAL? PER,OFFICER \?L66
	SET 'FAWNING,1
	PRINTI """Delighted to help you if I can, "
	CALL PRINT-NAME,FIRST-NAME
	PRINTI " luv! One feels those great luminous eyes of yours can see right through a chap!"" says the handsome young guardsman. "
?L66:	EQUAL? PRSA,V?DANCE \?L163
	EQUAL? PRSO,PLAYER \?L71
	SET 'WINNER,PLAYER
	CALL PERFORM,PRSA,PER
	RTRUE
?L71:	EQUAL? PRSA,V?DANCE /?L75
?L163:	EQUAL? PRSA,V?WALK \?L73
	EQUAL? PRSO,P?OUT /?L75
	ZERO? TAG /?L73
?L75:	RETURN 2
?L73:	EQUAL? PRSA,V?SIGN \?L80
	PRINTI "You notice that"
	CALL HE-SHE-IT,PER
	PRINTI " is "
	EQUAL? PER,DEB,DOCTOR \?L83
	PRINTI "lef"
	JUMP ?L87
?L83:	PRINTI "righ"
?L87:	PRINTR "t-handed."
?L80:	EQUAL? PRSA,V?KISS \?L92
	CALL UNSNOOZE,PER
	PRINTR """I really don't think this is the proper time or place."""
?L92:	EQUAL? PRSA,V?TAKE \?L95
	IN? PRSO,PLAYER \FALSE
	SET 'WINNER,PLAYER
	CALL PERFORM,V?GIVE,PRSO,PER
	RTRUE
?L95:	EQUAL? PRSA,V?READ,V?LOOK-INSIDE,V?EXAMINE \?L99
	IN? PRSO,PLAYER \FALSE
	SET 'WINNER,PLAYER
	CALL PERFORM,V?SHOW,PER,PRSO
	RTRUE
?L99:	EQUAL? PRSA,V?FORGIVE \?L103
	SET 'WINNER,PRSO
	CALL PERFORM,V?SORRY,PER
	RTRUE
?L103:	EQUAL? PRSA,V?THROW-AT,V?GIVE \?L104
	FSET? PRSI,PERSONBIT \?L104
	SET 'WINNER,PRSI
	CALL PERFORM,V?ASK-FOR,PER,PRSO
	RTRUE
?L104:	EQUAL? PRSA,V?SGIVE \?L105
	FSET? PRSO,PERSONBIT \?L105
	SET 'WINNER,PRSO
	CALL PERFORM,V?ASK-FOR,PER,PRSI
	RTRUE
?L105:	EQUAL? PRSA,V?HELP \?L106
	EQUAL? PRSO,0,PLAYER,PLAYER-NAME \?L107
	SET 'WINNER,PLAYER
	CALL PERFORM,V?ASK,PER
	RTRUE
?L107:	RETURN 2
?L106:	EQUAL? PRSA,V?SSHOW,V?SHOW,V?FIND \?L112
	EQUAL? PRSA,V?SHOW \?L113
	SET 'PRSA,V?SSHOW
	SET 'N,PRSI
	SET 'PRSI,PRSO
	SET 'PRSO,N
?L113:	IN? PRSO,ROOMS \?L116
	SET 'WINNER,PLAYER
	CALL PERFORM,V?WALK-TO,PRSO
	RTRUE
?L116:	IN? PRSO,PER \?L118
	CALL ITAKE >STACK
	EQUAL? STACK,1 \TRUE
	CALL HE-SHE-IT,PER,1
	PRINTI " fumbles in"
	CALL HIM-HER-IT,PER,0,1
	PRINTI " pocket and produces"
	CALL HIM-HER-IT,PRSO
	PRINTR "."
?L118:	EQUAL? PRSA,V?FIND \FALSE
	RETURN 2
?L112:	EQUAL? PRSA,V?PLAY \?L128
	EQUAL? PRSO,PIANO \FALSE
	PRINTI """I'm not very good at this sort of thing, but...""
"
	RETURN 2
?L128:	EQUAL? PRSA,V?TELL \?L136
	EQUAL? PRSO,PLAYER-NAME,PLAYER \FALSE
	SET 'WINNER,PLAYER
	CALL PERFORM,V?ASK,PER
	RTRUE
?L136:	EQUAL? PRSA,V?TELL-ABOUT \?L140
	FSET? PRSO,PERSONBIT \FALSE
	SET 'WINNER,PLAYER
	CALL PERFORM,V?ASK-ABOUT,PER,PRSI
	RTRUE
?L140:	EQUAL? PRSA,V?WAIT-FOR,V?STOP \?L144
	EQUAL? PRSO,ROOMS,PLAYER-NAME /?L147
	EQUAL? PRSO,PLAYER,GLOBAL-HERE,HERE \FALSE
?L147:	EQUAL? PER,FOLLOWER \?L148
	SET 'FOLLOWER,0
	PRINTI """As you wish, "
	CALL PRINT-NAME,FIRST-NAME >STACK
	ZERO? STACK /?L152
	PRINTC 46
?L152:	PRINTR """"
?L148:	SET 'WINNER,PLAYER
	CALL PERFORM,V?$0024CALL,PER
	RTRUE
?L144:	EQUAL? PRSA,V?TALK-ABOUT \FALSE
	SET 'WINNER,PLAYER
	CALL PERFORM,V?ASK-ABOUT,PER,PRSO
	RTRUE

	.FUNCT EVIDENCE?,OBJ,PER=0
	ZERO? PER /?L1
	GETP PER,P?CHARACTER >STACK
	EQUAL? VARIATION,STACK \FALSE
?L1:	EQUAL? OBJ,LETTER-MAID,PASSAGE,JEWEL /TRUE
	EQUAL? OBJ,LENS,LENS-1,LENS-2 /TRUE
	EQUAL? OBJ,COSTUME,LENS-BOX,EARRING /TRUE
	EQUAL? OBJ,BLOWGUN /TRUE
	ZERO? OBJ /FALSE
	FSET? OBJ,PERSONBIT /FALSE
	FSET? OBJ,RMUNGBIT /TRUE
	RFALSE

	.FUNCT SETUP-SHOT,PER
	SET 'VILLAIN-KNOWN?,1
	MOVE BLOWGUN,PER
	FCLEAR BLOWGUN,NDESCBIT
	FCLEAR BLOWGUN,TAKEBIT
	PUTP PER,P?LINE,2
	PUTP PER,P?LDESC,8
	SET 'AIMED-HERE,HERE
	SET 'SHOOTER,PER
	CALL QUEUE,I-SHOT,CLOCKER-RUNNING >STACK
	RSTACK

	.FUNCT COMMON-ASK-ABOUT,PER,OBJ,?TMP
	CALL EVIDENCE?,OBJ,PER >STACK
	ZERO? STACK /?L1
	CALL HE-SHE-IT,PER,1
	PRINTI " flinches a little before answering.
"
	JUMP ?L10
?L1:	CALL EVIDENCE?,OBJ >STACK
	ZERO? STACK /?L10
	ZERO? CONFESSED /?L6
	PRINT IM-SHOCKED
	RTRUE
?L6:	CALL HE-SHE-IT,PER,1
	PRINTI " says, """
	RANDOM 2 >STACK
	EQUAL? STACK,1 \?L13
	PRINTI "Good Lord"
	JUMP ?L17
?L13:	PRINTI "I say"
?L17:	PRINTR "! I think you're onto something here."""
?L10:	FSET? OBJ,RMUNGBIT \?L23
	EQUAL? PRSA,V?SHOW,V?CONFRONT \?L23
	FSET? OBJ,PERSONBIT /?L23
	GETP PER,P?CHARACTER >STACK
	PUT TOLD-ABOUT-EVID,STACK,1
?L23:	EQUAL? OBJ,SEARCHER \?L26
	GETP OBJ,P?LDESC >STACK
	EQUAL? STACK,21 \?L26
	EQUAL? PER,SEARCHER \?L28
	PRINTR """You mean, why am I searching? I'm sure you can guess."""
?L28:	PRINTI """I imagine that "
	PRINTD OBJ
	PRINTI " is searching because"
	CALL THIS-IS-IT,OBJ
	CALL HE-SHE-IT,OBJ
	PRINTI " got a bright idea. I prefer to let our"
	PRINT FAMOUS-YOUNG-DETECTIVE
	PRINTR " do the work."""
?L26:	EQUAL? OBJ,PER \?L37
	PRINTR """I have no secrets. Anyone can see what I am."""
?L37:	EQUAL? OBJ,PLAYER,PLAYER-NAME \?L40
	PRINTI """You're "
	CALL TELL-FULL-NAME
	PRINTI ", the"
	PRINT FAMOUS-YOUNG-DETECTIVE
	PRINTR "."""
?L40:	EQUAL? OBJ,BUTLER \?L45
	PRINTR """He's served the family all his life."""
?L45:	EQUAL? OBJ,LOVER \?L48
	PRINTI """Poor thing, her life came to a sad ending."
	EQUAL? PER,DOCTOR \?L51
	PRINTI " As did her grandfather, whom I treated at my clinic."
?L51:	PRINTR """"
?L48:	EQUAL? OBJ,COUSIN,BUST \?L58
	PRINTR """He was a bit of a strange bird, was Lionel."""
?L58:	EQUAL? OBJ,GHOST-NEW,DANGER,HAUNTING \?L63
	PRINTI """I myself haven't seen"
	CALL HIM-HER-IT,GHOST-NEW
	PRINTR "."""
?L63:	EQUAL? OBJ,GHOST-OLD \?L66
	PRINTI """Oh, she has haunted "
	PRINTD CASTLE
	PRINTI " for centuries -- a lovely phantom in a white gown, with long pale hair. She was said to be the unfaithful wife of an early Lord "
	PRINT TRESYLLIAN
	PRINTR ", who had her walled up alive in the tower."""
?L66:	EQUAL? OBJ,MAID \?L69
	PRINT NEVER-NOTICED-HER
	RTRUE
?L69:	FSET? OBJ,PERSONBIT /FALSE
	GETP PER,P?CHARACTER >STACK
	EQUAL? VARIATION,STACK \?L73
	FSET? OBJ,RMUNGBIT /?L74
	EQUAL? OBJ,BLOWGUN \?L73
?L74:	PUTP PER,P?LINE,2
	PRINTI """What can I say?"""
	CALL HE-SHE-IT,PER
	PRINTI " shrugs. ""It's a fair cop. You've caught me with damning evidence."
	EQUAL? VARIATION,FRIEND-C,LORD-C /?L79
	GETP PER,P?CHARACTER >STACK
	INC 'STACK
	GET CHAR-ROOM-TABLE,STACK >STACK
	EQUAL? HERE,STACK \?L79
	CALL FIND-FLAG-HERE,PERSONBIT,PLAYER,PER >STACK
	ZERO? STACK /?L77
?L79:	PRINTR """"
?L77:	IN? BLOWGUN,PER \?L83
	PRINTI """ "
	CALL HE-SHE-IT,PER,1
	JUMP ?L87
?L83:	PRINTI " But there's something you don't know yet"
	CALL IAN-CALLS-YOU
	PRINTI ", which may put the matter in a different light.""
Still smiling,"
	CALL HE-SHE-IT,PER
	PRINTI " puts"
	CALL HIM-HER-IT,PER,0,1
	PRINTI " hand into"
	CALL PRINTT,HIDING-PLACE
	PRINTI ", and"
?L87:	LOC BLOWGUN >STACK
	EQUAL? STACK,PER,HIDING-PLACE \?L92
	SET 'DISCOVERED-HERE,HERE
	CALL SETUP-SHOT,PER
	FSET? BLOWGUN,NDESCBIT /?L94
	PRINTI " takes"
	JUMP ?L98
?L94:	FCLEAR BLOWGUN,NDESCBIT
	PRINTI " suddenly extracts"
?L98:	CALL PRINTT,BLOWGUN
	PRINTI " and aims it at you!"
	CRLF
	CALL PRINT-ID,STR?187
	RTRUE
?L92:	CALL HIM-HER-IT,PER,0,1
	PRINTI " jaw drops as"
	CALL HIM-HER-IT,PER,0,1
	PRINTR " hand comes out, empty."
?L73:	EQUAL? OBJ,ACCIDENT \?L106
	PRINTI """You'd best ask Jack about that, or "
	PRINTD BUTLER
	PRINTR "."""
?L106:	EQUAL? OBJ,BELL \?L109
	PRINTR """It's actually a ship's bell off an old British man-o'-war."""
?L109:	EQUAL? PER,SEARCHER \?L112
	ZERO? LIONEL-SPEAKS-COUNTER \?L112
	CALL SHOWING-CLUE?,OBJ >STACK
	ZERO? STACK /?L112
	EQUAL? PRSA,V?ASK-ABOUT /?L112
	CALL QUEUE,I-SEARCH,1
	PRINT THATS-INTERESTING
	RTRUE
?L112:	EQUAL? OBJ,CORPSE \?L115
	PRINTC 34
	PRINTD CORPSE
	PRINTR " was never recovered from the well. They think it was carried out to sea by an underground tidal stream."""
?L115:	EQUAL? OBJ,COSTUME,BLOWGUN,LENS-BOX \?L118
	EQUAL? PER,PAINTER,DOCTOR \?L120
	GETP PER,P?CHARACTER >STACK
	EQUAL? VARIATION,STACK /?L119
?L120:	EQUAL? PER,DEB \?L118
	EQUAL? VARIATION,FRIEND-C \?L118
?L119:	GETP PER,P?CHARACTER >STACK
	INC 'STACK
	GET CHAR-ROOM-TABLE,STACK >OBJ
	PRINTD PER
	PRINTI "'s look changes to a puzzled and angry frown. "
	EQUAL? PER,LORD,FRIEND /?L123
	PRINTI """You mean you found that "
	EQUAL? HERE,OBJ \?L127
	PRINTI "here "
?L127:	PRINTI "in my room?"""
	CALL HE-SHE-IT,PER
	PRINTI " gasps. "
?L123:	PRINTI """How can I explain it when it doesn't belong to me? If you didn't bring it "
	EQUAL? HERE,OBJ /?L137
	PRINTC 116
?L137:	PRINTI "here "
	PRINTD PLAYER
	PRINTI ", then someone else planted it, trying to frame me as the maniac who's been posing as "
	PRINTD LOVER
	PRINTR "'s ghost!"""
?L118:	EQUAL? OBJ,COSTUME \?L144
	GET FOUND-COSTUME,PLAYER-C >STACK
	ZERO? STACK /FALSE
	PRINTI """So that's how "
	ZERO? CONFESSED \?L149
	PRINTI "somebody"
	JUMP ?L153
?L149:	PRINTD VILLAIN-PER
?L153:	PRINTR " posed as a ghost!"""
?L144:	EQUAL? OBJ,DINNER,DINNER-2 \?L159
	LESS? PRESENT-TIME,DINNER-TIME \?L160
	PRINTI """Tonight's a dinner in honor of "
	EQUAL? PER,BUTLER \?L164
	PRINTI "the late Lord "
?L164:	PRINTI "Lionel's birthday. In his will, he asked for these particular guests -- except "
	EQUAL? PER,FRIEND \?L171
	PRINTI "me"
	JUMP ?L175
?L171:	PRINTD FRIEND
?L175:	PRINTI ", of course. It's at eight o'clock"
	EQUAL? PER,BUTLER /?L178
	PRINTI " -- or whenever "
	PRINTD BUTLER
	PRINTI " gets 'round to it"
?L178:	PRINTR "."""
?L160:	CALL META-LOC,DINNER >STACK
	EQUAL? STACK,HERE \?L185
	PRINTR """It looks delicious!"""
?L185:	GETP PER,P?LDESC >STACK
	EQUAL? STACK,10 \?L189
	PRINTI """I'm enjoying"
	JUMP ?L193
?L189:	PRINTI """I enjoyed"
?L193:	PRINTI " it immensely."
	ZERO? MISSED-DINNER /?L198
	PRINTI " We started without you, as we assumed you were sleuthing."
?L198:	PRINTR """"
?L159:	EQUAL? OBJ,BRICKS,COFFIN,CRYPT /?L206
	EQUAL? OBJ,DUNGEON,IRON-MAIDEN,TOMB /?L206
	EQUAL? OBJ,WELL \?L205
?L206:	PRINT ANCIENT-SECRETS
	CRLF
	RTRUE
?L205:	EQUAL? OBJ,JEWEL \?L209
	CALL HE-SHE-IT,PER,1
	EQUAL? PER,FRIEND \?L212
	FSET? EARRING,LOCKED \?L212
	PRINTR " says, ""Oh, thank you for finding it! I've looked everywhere!"""
?L212:	SET '?TMP,HERE
	CALL META-LOC,JEWEL >STACK
	EQUAL? ?TMP,STACK \?L216
	PRINTI " looks at it with interest"
	EQUAL? PER,DEALER \?L224
	PRINTI ", putting a monocle in one eye to see better"
	JUMP ?L224
?L216:	PRINTI " listens to your description of it"
?L224:	PRINTI ". But"
	CALL HE-SHE-IT,PER
	PRINTI " says"
	CALL HE-SHE-IT,PER
	PRINTR " can't identify it."
?L209:	EQUAL? OBJ,LAMP \?L229
	PRINTI """I think "
	PRINTD BUTLER
	PRINTI " keeps"
	CALL IN-CASE-OF-BLACKOUT
	RTRUE
?L229:	EQUAL? OBJ,LUGGAGE \?L232
	IN? LUGGAGE,BUTLER \?L232
	PRINTI """Don't panic."
	CALL BOLITHO-WILL
	PRINTR "."""
?L232:	EQUAL? OBJ,MACE \?L237
	PRINTI """That is a long story, "
	CALL TITLE-NAME >STACK
	ZERO? STACK /?L240
	PRINTC 46
?L240:	PRINTI " When Lord Lionel was alive, he had a pit bulldog to protect the castle. A right vicious brute it was, too! Several times it attacked the servants, so the master gave out these "
	PRINTD MACE
	PRINTR "s. Just press the button on the side, and it sprays something foul. It always worked a treat on that wretched dog, and I daresay it could stop a ghost just as well."""
?L237:	EQUAL? OBJ,NECKLACE-OF-D \?L247
	PRINTI """The police returned it to "
	EQUAL? PER,LORD \?L250
	PRINTI "me"
	JUMP ?L254
?L250:	PRINTD LORD
?L254:	PRINTR " after the inquest."""
?L247:	CALL SECRET-PASSAGE-OR-DOOR?,OBJ >STACK
	ZERO? STACK /?L259
	CALL TELL-ABOUT-OBJECT,PER,PASSAGE,FOUND-PASSAGES >STACK
	RSTACK
?L259:	EQUAL? OBJ,SKELETON \?L260
	PRINTI """Ugh! Those must be the bones of the "
	PRINTD GHOST-OLD
	PRINTR "!"""
?L260:	CALL TREASURE-FOUND?,OBJ,PER >STACK
	ZERO? STACK \TRUE
	EQUAL? OBJ,YOUR-ROOM \?L264
	PRINTR """It's fortunate that one bedroom was available for you."""
?L264:	EQUAL? OBJ,CASTLE /?L268
	IN? OBJ,ROOMS \?L267
?L268:	PRINTI """Oh, it is a lovely piece of real estate, "
	EQUAL? PER,FRIEND \?L271
	PRINTI "isn't it"
	JUMP ?L275
?L271:	PRINTI "what"
?L275:	PRINTC 63
	EQUAL? PER,DOCTOR,PAINTER,DEALER \?L280
	PRINTI " Almost a shame to admit riffraff on weekends."
?L280:	PRINTR """"
?L267:	IN? OBJ,PER \FALSE
	PRINTI """I have it right here, "
	CALL TITLE-NAME >STACK
	ZERO? STACK /?L290
	PRINTC 46
?L290:	PRINTR """"

	.FUNCT SHOWING-CLUE?,OBJ
	EQUAL? OBJ,CLUE-1,CLUE-2,CLUE-3 /TRUE
	EQUAL? OBJ,CLUE-4 /TRUE
	EQUAL? OBJ,MAGAZINE \FALSE
	EQUAL? VARIATION,PAINTER-C /TRUE
	RFALSE

	.FUNCT TREASURE-FOUND?,OBJ,PER,X
	EQUAL? OBJ,TREASURE /?L3
	EQUAL? OBJ,INKWELL \FALSE
	IN? MOONMIST,INKWELL \FALSE
?L3:	FCLEAR OBJ,SECRETBIT
	PRINTI """That must be the "
	PRINTD ARTIFACT
	PRINTI "!"
	CALL TELL-STOP-SEARCHING?,PER >X
	PRINTI """
"
	SET 'PER,FRIEND
	IN? PER,HERE /?L10
	SET 'PER,LORD
	IN? PER,HERE \?L11
?L10:	EQUAL? PER,CONFESSED /?L11
	PUTP PER,P?LINE,0
	CALL THIS-IS-IT,PER
	PRINTI """That's super!"" adds "
	PRINTD PER
	PRINTI ". ""We can't thank you enough!"
	ZERO? X \?L15
	CALL TELL-STOP-SEARCHING?,PER >X
?L15:	PRINTI """
"
?L11:	IN? SEARCHER,HERE \?L22
	ZERO? X \?L22
	CALL TELL-STOP-SEARCHING?,SEARCHER,1,1 >STACK
	ZERO? STACK /?L22
	PRINTI """ says "
	PRINTD SEARCHER
	PRINTI ".
"
?L22:	ZERO? TREASURE-FOUND \TRUE
	CALL CONGRATS,ARTIFACT
	RTRUE

	.FUNCT TELL-STOP-SEARCHING?,PER,COMMA=0,NOSP=0,OBJ
	EQUAL? PER,SEARCHER \FALSE
	GETP PER,P?CHARACTER >STACK
	GET GOAL-TABLES,STACK >OBJ
	GET OBJ,GOAL-FUNCTION >STACK
	EQUAL? STACK,X-SEARCHES \FALSE
	PUT OBJ,GOAL-FUNCTION,NULL-F
	ZERO? NOSP \?L3
	PRINTC 32
	JUMP ?L7
?L3:	PRINTC 34
?L7:	PRINTI "Then that's the end of my searching"
	ZERO? COMMA /?L12
	PRINTC 44
	JUMP ?L16
?L12:	PRINTC 46
?L16:	CALL ZMEMQ,HERE,CHAR-ROOM-TABLE >OBJ
	ZERO? OBJ /?L21
	SUB OBJ,1 >STACK
	GET CHARACTER-TABLE,STACK >STACK
	EQUAL? PER,STACK /TRUE
?L21:	CALL ESTABLISH-GOAL,PER,SITTING-ROOM
	RTRUE

	.FUNCT GOOD-SHOW,PER,OBJ
	EQUAL? PER,GHOST-NEW,CONFESSED /FALSE
	PRINTC 34
	GETP PER,P?CHARACTER >STACK
	EQUAL? VARIATION,STACK \?L6
	PRINTI "How nice"
	JUMP ?L16
?L6:	EQUAL? PER,FRIEND \?L10
	PRINTI "That's keen"
	JUMP ?L16
?L10:	RANDOM 2 >STACK
	EQUAL? STACK,1 \?L13
	PRINTI "Well done"
	JUMP ?L16
?L13:	PRINTI "Good show"
?L16:	PRINTI "! You found "
	CALL PRINTA,OBJ
	PRINTC 33
	EQUAL? OBJ,TREASURE \?L21
	CALL TELL-STOP-SEARCHING?,PER,1
?L21:	PRINTI """ says "
	PRINTD PER
	PRINTR "."

	.FUNCT COMMON-DESC,PER
	PRINTI "He's a "
	EQUAL? PER,DOCTOR \?L3
	PRINTI "middle-sized man in his fifties"
	IN? MUSTACHE,DOCTOR \?L7
	PRINTI ", with spectacles and a grizzled mustache"
?L7:	PRINTR "."
?L3:	PRINTI "tall"
	EQUAL? PER,LORD \?L17
	PRINTI ", handsome, dark-browed young man"
	GRTR? BED-TIME,PRESENT-TIME \?L37
	PRINTI " in dinner jacket and black tie"
	JUMP ?L37
?L17:	EQUAL? PER,OFFICER \?L26
	PRINTI " blond"
	GRTR? BED-TIME,PRESENT-TIME \?L37
	PRINTI ", sporting a white dinner jacket and scarlet cummerbund. He moves with the elegant swagger of a Guards officer and young-man-about-Mayfair, both of which he is"
	JUMP ?L37
?L26:	EQUAL? PER,DEALER \?L37
	PRINTI ", foppish art and antiques dealer"
	FSET? PER,MUNGBIT /?L37
	PRINTI ". Despite his languid manner, you're aware of his penetrating glance. If you were buying a used car from this man, you'd want to check it out carefully"
?L37:	PRINTR "."

	.FUNCT COMMON-OTHER,PER,X=0,N
	EQUAL? PRSA,V?ASK /FALSE
	EQUAL? PRSA,V?EXAMINE \?L3
	EQUAL? PER,DOCTOR /?L6
	EQUAL? PER,LORD,OFFICER,DEALER \?L4
?L6:	CALL COMMON-DESC,PER
	JUMP ?L7
?L4:	EQUAL? PER,GHOST-NEW /?L7
	GETP PER,P?TEXT >STACK
	PRINT STACK
	CRLF
?L7:	IN? PER,HERE \?L13
	FIRST? PER >N \?L13
	FSET? N,NDESCBIT /?L13
	CALL CARRY-CHECK,PER >STACK
	ZERO? STACK /?L13
	SET 'X,1
?L13:	FSET? PER,MUNGBIT \?L17
	ZERO? X /?L48
	PRINTI "And"
	ZERO? X \?L24
?L48:	PUSH 1
	JUMP ?L25
?L24:	PUSH 0
?L25:	CALL HE-SHE-IT,PER,STACK,STR?44
	PRINTC 32
	GETP PER,P?LDESC >STACK
	GET LDESC-STRINGS,STACK >STACK
	PRINT STACK
	PRINTI "."
	CRLF
?L17:	EQUAL? PER,DEALER \?L29
	LOC LORD >STACK
	EQUAL? STACK,HERE,PSEUDO-OBJECT \TRUE
	GETP DEALER,P?LDESC >STACK
	EQUAL? STACK,2 \TRUE
	GETP LORD,P?LINE >STACK
	ZERO? STACK \TRUE
	PRINTI """Montague began appraising the art works in the castle for Uncle Lionel before he died,"" explains "
	PRINTD LORD
	PRINTR ". ""I've asked him to continue and make up a catalog."""
?L29:	EQUAL? PER,PAINTER \TRUE
	LOC FRIEND >STACK
	EQUAL? STACK,HERE,PSEUDO-OBJECT \?L37
	SET 'X,FRIEND
	JUMP ?L39
?L37:	CALL FIND-FLAG-HERE,PERSONBIT,PLAYER,PAINTER >X
?L39:	ZERO? X /TRUE
	LOC PAINTER >STACK
	EQUAL? STACK,DRAWING-ROOM \TRUE
	PRINTI """Vivien painted that portrait of "
	PRINTD LOVER
	PRINTI " Hallam, the girl who drowned in the castle well,"" says "
	PRINTD X
	PRINTI ". She gestures to a framed picture hanging by the "
	PRINTD FIREPLACE
	PRINTR "."
?L3:	EQUAL? PRSO,PER \FALSE
	EQUAL? PRSA,V?SHOW \FALSE
	CALL PERFORM,V?ASK-ABOUT,PRSO,PRSI
	RTRUE

	.FUNCT UNSNOOZE,PER,NO-TELL?=0,RM,GT,C
	GETP PER,P?LDESC >C
	EQUAL? C,14 \?L1
	CALL FIX-MUSTACHE,PER
	GETP PER,P?CHARACTER >C
	GET GOAL-TABLES,C >GT
	GET GT,ATTENTION-SPAN >STACK
	PUT GT,ATTENTION,STACK
	PUT GT,GOAL-ENABLE,0
	PUT GT,GOAL-FUNCTION,X-RETIRES
	PUT GT,GOAL-S,1
	ADD 1,C >STACK
	GET CHAR-ROOM-TABLE,STACK >RM
	IN? PER,RM /?L3
	CALL ESTABLISH-GOAL,PER,RM
?L3:	EQUAL? VARIATION,C \?L6
	PUTP PER,P?LDESC,4
	JUMP ?L8
?L6:	PUTP PER,P?LDESC,25
?L8:	FCLEAR PER,MUNGBIT
	CALL META-LOC,PER >RM
	IN? PER,HERE \?L13
	ZERO? NO-TELL? \?L13
	CALL HE-SHE-IT,PER,1
	PRINTI " wakes up first. "
	FSET? RM,ONBIT /?L13
	CALL HE-SHE-IT,PER,1
	PRINTI " turns on the light. "
?L13:	FSET RM,ONBIT
	RTRUE
?L1:	EQUAL? C,19 \FALSE
	GETP PER,P?CHARACTER >STACK
	GET SHOT,STACK >STACK
	ZERO? STACK \FALSE
	CALL FIX-MUSTACHE,PER
	CALL QUEUE,I-COME-TO,0
	CALL I-COME-TO
	RTRUE

	.FUNCT FIX-MUSTACHE,PER
	EQUAL? PER,DOCTOR \FALSE
	EQUAL? VARIATION,DOCTOR-C \FALSE
	FCLEAR MUSTACHE,TAKEBIT
	FSET MUSTACHE,TRYTAKEBIT
	RTRUE

	.FUNCT OBJECT-PAIR-F,P1,P2
	GETB P-PRSO,P-MATCHLEN >STACK
	LESS? 2,STACK \?L1
	SET 'CLOCK-WAIT,1
	PRINTR "(That's too many things to compare all at once!)"
?L1:	GETB P-PRSO,2 >STACK
	GETB P-PRSO,1 >STACK
	CALL PERFORM,PRSA,STACK,STACK
	RTRUE

	.FUNCT CREW-GLOBAL-F,L
	CALL QUEUED?,I-TOUR >STACK
	ZERO? STACK /?L1
	EQUAL? PRSA,V?WALK-TO \?L1
	GET TOUR-PATH,TOUR-INDEX >STACK
	CALL PERFORM,PRSA,STACK
	RTRUE
?L1:	CALL ALL-TOGETHER-NOW? >STACK
	ZERO? STACK \?L3
	SET 'CLOCK-WAIT,1
	PRINTI "(The guests aren't all together!)"
	CRLF
	RETURN 2
?L3:	EQUAL? PRSA,V?EXAMINE \?L8
	PRINTR "There are seven people, not counting you."
?L8:	EQUAL? PRSA,V?HELLO \?L11
	CALL START-SENTENCE,PRSO
	PRINTR " nods at you."
?L11:	PRINTI "You'd better stick to one guest at a time."
	CRLF
	RETURN 2

	.FUNCT CASTLE-F
	EQUAL? PRSA,V?FIND,V?EXAMINE \?L1
	CALL OUTSIDE?,HERE >STACK
	ZERO? STACK /?L3
	EQUAL? PRSA,V?FIND \?L5
	PRINTR "It's right here!"
?L5:	PRINT DARK-TURRETS
	RTRUE
?L3:	EQUAL? PRSO,CASTLE /?L13
	FSET? HERE,WEARBIT /?L12
?L13:	PRINTR "It's all around you!"
?L12:	CALL NOT-HERE,TOWER >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?WALK-TO,V?THROUGH,V?BOARD \?L17
	EQUAL? PRSO,CASTLE \?L18
	CALL OUTSIDE?,HERE >STACK
	ZERO? STACK /?L20
	FSET? FRIEND,TOUCHBIT /?L22
	CALL PERFORM,PRSA,COURTYARD
	RTRUE
?L22:	CALL PERFORM,PRSA,FOYER
	RTRUE
?L20:	CALL HAR-HAR >STACK
	RSTACK
?L18:	CALL OUTSIDE?,HERE >STACK
	ZERO? STACK \?L29
	FSET? HERE,WEARBIT \?L27
?L29:	CALL PERFORM,PRSA,OLD-GREAT-HALL
	RTRUE
?L27:	CALL HAR-HAR >STACK
	RSTACK
?L17:	EQUAL? PRSA,V?LEAVE \FALSE
	CALL OUTSIDE?,HERE >STACK
	ZERO? STACK \?L32
	CALL PERFORM,V?WALK-TO,COURTYARD
	RTRUE
?L32:	CALL HAR-HAR >STACK
	RSTACK

	.FUNCT TOWER-F
	EQUAL? PRSA,V?LEAVE,V?WALK-TO,V?THROUGH /?L3
	EQUAL? PRSA,V?FIND,V?EXAMINE,V?BOARD \?L1
?L3:	CALL CASTLE-F >STACK
	RSTACK
?L1:	CALL REMOTE-VERB? >STACK
	ZERO? STACK \FALSE
	FSET? HERE,WEARBIT \FALSE
	CALL NOT-HERE,TOWER
	RTRUE

	.FUNCT MOON-F
	EQUAL? PRSA,V?EXAMINE \?L1
	PRINTI "Strange shapes of mist dance in front of the "
	PRINTD MOON
	PRINTR "."
?L1:	EQUAL? PRSA,V?SMELL,V?EAT \FALSE
	CALL PERFORM,V?SMELL,OCEAN
	RTRUE

	.FUNCT OCEAN-F
	EQUAL? PRSA,V?LISTEN \?L1
	PRINTR "The breakers seem to be warning you."
?L1:	EQUAL? PRSA,V?WALK-TO,V?THROUGH \FALSE
	PRINTR "The cliffs are too dangerous in the dark."

	.FUNCT CAR-DOOR-PSEUDO
	EQUAL? PRSA,V?UNLOCK /?L3
	EQUAL? PRSA,V?LOCK,V?CLOSE,V?OPEN \FALSE
?L3:	CALL NO-NEED >STACK
	RSTACK

	.FUNCT DRIVING?,?TMP
	EQUAL? P-PRSA-WORD,0,W?DRIVE,W?ENTER /?L1
	EQUAL? P-PRSA-WORD,W?STEER \FALSE
?L1:	EQUAL? PRSA,V?WALK-TO,V?THROUGH,V?CLIMB-UP \?L3
	EQUAL? PRSA,V?THROUGH \?L4
	EQUAL? PRSO,CAR \?L4
	ZERO? PRSI /?L6
	SET '?TMP,HERE
	CALL META-LOC,PRSI >STACK
	EQUAL? ?TMP,STACK /FALSE
	SET 'PRSO,PRSI
	RTRUE
?L6:	SET 'PRSO,FRONT-GATE
	RTRUE
?L4:	SET '?TMP,HERE
	CALL META-LOC,PRSO >STACK
	EQUAL? ?TMP,STACK /FALSE
	RTRUE
?L3:	EQUAL? PRSA,V?LEAVE \?L14
	EQUAL? PRSO,ROOMS,CAR \TRUE
	RFALSE
?L14:	EQUAL? PRSA,V?WALK \FALSE
	ZERO? P-PRSA-WORD \TRUE
	EQUAL? PRSO,P?OUT \TRUE
	RFALSE

	.FUNCT CAR-F,ARG=0,S
	SET 'S,HERE
	EQUAL? ARG,M-BEG \?L1
	CALL DRIVING? >STACK
	ZERO? STACK /?L3
	EQUAL? PRSO,FRONT-GATE \?L5
	EQUAL? PRSA,V?THROUGH \?L7
	FSET? FRONT-GATE,OPENBIT /?L9
	CALL TOO-BAD-BUT,FRONT-GATE,STR?79 >STACK
	RSTACK
?L9:	EQUAL? S,DRIVEWAY \?L11
	CALL PERFORM,V?WALK-TO,COURTYARD
	RTRUE
?L11:	CALL PERFORM,V?WALK-TO,DRIVEWAY
	RTRUE
?L7:	CALL WALK-WITHIN-ROOM >STACK
	RSTACK
?L5:	EQUAL? S,DRIVEWAY \?L14
	EQUAL? PRSA,V?WALK-TO,V?THROUGH,V?CLIMB-UP \?L15
	CALL META-LOC,PRSO >STACK
	EQUAL? DRIVEWAY,STACK \?L17
	CALL WALK-WITHIN-ROOM >STACK
	RSTACK
?L17:	FSET? FRONT-GATE,OPENBIT /?L19
	CALL TOO-BAD-BUT,FRONT-GATE,STR?79 >STACK
	RSTACK
?L19:	CALL CAR-TO-COURTYARD >STACK
	RSTACK
?L15:	EQUAL? PRSA,V?LEAVE \?L21
	EQUAL? PRSO,COURTYARD \?L22
	CALL HAR-HAR >STACK
	RSTACK
?L22:	FSET? FRONT-GATE,OPENBIT /?L24
	CALL TOO-BAD-BUT,FRONT-GATE,STR?79 >STACK
	RSTACK
?L24:	CALL CAR-TO-COURTYARD >STACK
	RSTACK
?L21:	EQUAL? PRSO,P?IN,P?SOUTH /?L27
	EQUAL? PRSO,INTDIR \?L26
	CALL ADJ-USED?,W?SOUTH >STACK
	ZERO? STACK /?L26
?L27:	FSET? FRONT-GATE,OPENBIT /?L28
	CALL TOO-BAD-BUT,FRONT-GATE,STR?79 >STACK
	RSTACK
?L28:	CALL CAR-TO-COURTYARD >STACK
	RSTACK
?L26:	SET 'CLOCK-WAIT,1
	PRINT CASTLE-IS-SOUTH
	RTRUE
?L14:	EQUAL? PRSA,V?WALK-TO,V?THROUGH,V?CLIMB-UP \?L35
	CALL META-LOC,PRSO >STACK
	EQUAL? COURTYARD,STACK \?L37
	CALL WALK-WITHIN-ROOM >STACK
	RSTACK
?L37:	FSET? FRONT-GATE,OPENBIT /?L39
	CALL TOO-BAD-BUT,FRONT-GATE,STR?79 >STACK
	RSTACK
?L39:	CALL CAR-TO-DRIVEWAY >STACK
	RSTACK
?L35:	EQUAL? PRSA,V?LEAVE \?L41
	EQUAL? PRSO,DRIVEWAY \?L42
	CALL HAR-HAR >STACK
	RSTACK
?L42:	FSET? FRONT-GATE,OPENBIT /?L44
	CALL TOO-BAD-BUT,FRONT-GATE,STR?79 >STACK
	RSTACK
?L44:	CALL CAR-TO-DRIVEWAY >STACK
	RSTACK
?L41:	EQUAL? PRSO,P?NORTH /?L47
	EQUAL? PRSO,INTDIR \?L46
	CALL ADJ-USED?,W?NORTH >STACK
	ZERO? STACK /?L46
?L47:	FSET? FRONT-GATE,OPENBIT /?L48
	CALL TOO-BAD-BUT,FRONT-GATE,STR?79 >STACK
	RSTACK
?L48:	CALL CAR-TO-DRIVEWAY >STACK
	RSTACK
?L46:	EQUAL? PRSO,P?OUT \?L51
	EQUAL? P-PRSA-WORD,0,W?GO /FALSE
	FSET? FRONT-GATE,OPENBIT /?L54
	CALL TOO-BAD-BUT,FRONT-GATE,STR?79 >STACK
	RSTACK
?L54:	CALL CAR-TO-DRIVEWAY >STACK
	RSTACK
?L51:	CALL YOU-CANT,STR?73 >STACK
	RSTACK
?L3:	EQUAL? PRSA,V?WALK \?L57
	EQUAL? PRSO,P?OUT \?L57
	MOVE WINNER,HERE
	CALL OWN-FEET >STACK
	RSTACK
?L57:	EQUAL? PRSA,V?WALK,V?STAND,V?FOLLOW /?L59
	EQUAL? PRSA,V?WALK-TO,V?THROUGH,V?LEAVE \?L58
	EQUAL? PRSO,0,LUGGAGE,ROOMS /?L58
	EQUAL? PRSO,CAR /?L58
?L59:	CALL FIRST-YOU,STR?188,CAR
	MOVE WINNER,HERE
	EQUAL? PRSA,V?STAND \FALSE
	RTRUE
?L58:	EQUAL? PRSO,ROOMS \FALSE
	EQUAL? PRSA,V?STOP \FALSE
	CALL PERFORM,PRSA,CAR
	RTRUE
?L1:	EQUAL? ARG,M-LOOK \?L68
	LOC WINNER >STACK
	EQUAL? STACK,CAR \TRUE
	PRINTI "You are sitting in your new little "
	PRINTD CAR
	PRINTR "."
?L68:	ZERO? ARG \FALSE
	EQUAL? PRSA,V?EXAMINE \?L75
	CALL TELL-ABOUT-CAR
	RTRUE
?L75:	EQUAL? PRSA,V?UNLOCK,V?LOCK,V?LAMP-ON /?L77
	EQUAL? PRSA,V?LAMP-OFF /?L77
	EQUAL? PRSA,V?OPEN,V?CLOSE,V?CLIMB-ON \FALSE
?L77:	CALL NO-NEED,STR?189 >STACK
	RSTACK

	.FUNCT CAR-TO-COURTYARD
	MOVE CAR,COURTYARD
	PRINTI "Your headlights bravely pierce the gloom as you enter the "
	PRINTD COURTYARD
	PRINTI ". You get out of your car.
"
	CALL GOTO,COURTYARD >STACK
	RSTACK

	.FUNCT CAR-TO-DRIVEWAY
	SET 'CLOCK-WAIT,1
	PRINTR "(You can't leave yet. There's a mystery to be solved!)"

	.FUNCT TELL-ABOUT-CAR,X
	PRINTI "Your new little "
	CALL PRINT-COLOR >STACK
	ZERO? STACK /?L3
	PRINTC 32
?L3:	PRINTD CAR
	PRINTR " is parked here."

	.FUNCT VOICE-F
	EQUAL? HERE,DRIVEWAY \?L1
	ZERO? DRAGON-EYE-COLOR /FALSE
	EQUAL? PRSA,V?LISTEN /?L5
	CALL SPEAKING-VERB? >STACK
	ZERO? STACK /FALSE
?L5:	CALL VOICE-SAYS >STACK
	RSTACK
?L1:	EQUAL? HERE,DINING-ROOM \FALSE
	EQUAL? PRSA,V?LISTEN \FALSE
	CALL BUST-F >STACK
	RSTACK

	.FUNCT HORN-F
	EQUAL? PRSA,V?SOUND,V?SLAP /?L3
	EQUAL? PRSA,V?RUB,V?PUSH,V?RING \FALSE
?L3:	GETB LAST-NAME,0 >STACK
	ZERO? STACK /?L4
	CALL GATE-OPENS >STACK
	ZERO? STACK \TRUE
	PRINTR """H-O-O-O-N-K!"""
?L4:	CALL THIS-IS-IT,VOICE
	MOVE VOICE,DRIVEWAY
	CALL PERFORM,V?PUSH,DRAGON-EYE
	RTRUE

	.FUNCT DRIVEWAY-F,RARG=0
	EQUAL? RARG,M-BEG \?L1
	EQUAL? PRSA,V?YELL \?L3
	CALL PERFORM,V?KNOCK,FRONT-GATE
	RTRUE
?L3:	ZERO? DRAGON-EYE-COLOR /FALSE
	CALL SPEAKING-VERB? >STACK
	ZERO? STACK \?L6
	EQUAL? PRSA,V?LISTEN \FALSE
	EQUAL? PRSO,DRAGON-EYE,DRAGON,FRONT-GATE \FALSE
?L6:	CALL VOICE-SAYS
	RTRUE
?L1:	EQUAL? RARG,M-LOOK \FALSE
	PRINTI "You are by the "
	FSET? FRONT-GATE,OPENBIT \?L11
	PRINTI "open "
?L11:	PRINTD FRONT-GATE
	PRINTI " of "
	PRINTD CASTLE
	PRINTI ". You can hear the ocean beating urgently against the rocks far below.
"
	CALL TELL-ABOUT-DRAGON
	RTRUE

	.FUNCT DRAGON-F
	EQUAL? PRSA,V?LOOK-INSIDE,V?EXAMINE \?L1
	CALL TELL-ABOUT-DRAGON
	RTRUE
?L1:	CALL DRAGON-EYE-F >STACK
	RSTACK

	.FUNCT TELL-ABOUT-DRAGON
	PRINTI "In the moonlit gloom, you can make out an ornament on the gate. It's a winged, two-legged dragon called a wyvern, which crests the "
	PRINT TRESYLLIAN
	PRINTI " family's coat of arms.
The dragon appears in profile. "
	CALL THIS-IS-IT,DRAGON-EYE
	CALL TELL-ABOUT-EYE
	RTRUE

	.FUNCT I-DRAGON-EYE,GARG=0
	GETB LAST-NAME,0 >STACK
	ZERO? STACK \FALSE
	CALL PERFORM,V?PUSH,DRAGON-EYE
	RETURN 2

	.FUNCT DRAGON-EYE-F
	EQUAL? PRSA,V?LOOK-INSIDE,V?EXAMINE \?L1
	CALL TELL-ABOUT-EYE
	RTRUE
?L1:	EQUAL? PRSA,V?LEAP,V?CLIMB-ON,V?BOARD \?L3
	PRINT TOO-SLIPPERY
	RTRUE
?L3:	EQUAL? PRSA,V?TURN,V?SLAP,V?RUB /?L7
	EQUAL? PRSA,V?RING,V?PUSH /?L7
	EQUAL? PRSA,V?MUNG,V?MOVE,V?KNOCK \?L6
?L7:	LESS? DRAGON-EYE-COLOR,0 /?L8
	SET 'DRAGON-EYE-COLOR,-1
	PRINTI "The "
	PRINTD DRAGON-EYE
	PRINTI " glows red. "
?L8:	EQUAL? PRSA,V?PUSH /?L13
	PRINTI "Evidently you just pushed a button. "
?L13:	PRINTI "A voice comes from a hidden speaker. It says:
"
	CALL VOICE-SAYS
	RTRUE
?L6:	EQUAL? PRSA,V?TAKE \FALSE
	PRINTI "It's part of the "
	PRINTD FRONT-GATE
	PRINTI "."
	CRLF
	CALL PRINT-ID,STR?190 >STACK
	RSTACK

	.FUNCT TELL-ABOUT-EYE
	ZERO? DRAGON-EYE-COLOR \?L1
	PRINTR "The moonlight glints on its lone visible eye."
?L1:	PRINTI "The "
	PRINTD DRAGON-EYE
	PRINTI " is glowing "
	GRTR? DRAGON-EYE-COLOR,0 \?L8
	PRINTR "green."
?L8:	PRINTR "red."

	.FUNCT VOICE-SAYS
	CALL QUEUE,I-DRAGON-EYE,0
	GETB LAST-NAME,0 >STACK
	ZERO? STACK /?L1
	PRINTI """Please enter, "
	CALL TITLE-NAME >STACK
	ZERO? STACK /?L5
	PRINTC 46
?L5:	PRINTI """
"
	CALL GATE-OPENS
	RTRUE
?L1:	CALL QUEUE,I-FRIEND-GREETS,6
	PRINTI """Please announce "
	PRINTD PLAYER
	PRINTI ". State your title -- such as Lord or Lady, Sir or Dame, Mr. or Ms. -- and your first and last name.""
"
	CALL GET-NAME
	PRINTI """And what is "
	PRINTD YOUR-COLOR
	PRINTI ", "
	CALL TITLE-NAME
	PRINTI "?""
"
	CALL GET-COLOR
	PRINTI """Jolly good! The spare bedroom is decorated in "
	CALL PRINT-COLOR
	PRINTI "! "
	PRINTI "Please enter."""
	CRLF
	CALL GATE-OPENS
	RTRUE

	.FUNCT GATE-OPENS
	EQUAL? HERE,DRIVEWAY \FALSE
	FSET? FRONT-GATE,OPENBIT /FALSE
	REMOVE VOICE
	FSET FRONT-GATE,OPENBIT
	FCLEAR FRONT-GATE,LOCKED
	CALL THIS-IS-IT,FRONT-GATE
	PRINTI "The "
	EQUAL? DRAGON-EYE-COLOR,1 /?L5
	LESS? DRAGON-EYE-COLOR,0 \?L7
	PRINTI "red "
?L7:	SET 'DRAGON-EYE-COLOR,1
	PRINTI "eye turns green, and the "
?L5:	PRINTD FRONT-GATE
	PRINTR " creaks open."

	.FUNCT FRONT-GATE-F
	EQUAL? PRSA,V?KNOCK \?L1
	PRINTR "Apparently no one hears you."
?L1:	EQUAL? PRSA,V?UNLOCK,V?SHAKE,V?MUNG \?L7
	PRINTI "Except for your rattling the gate, the silence remains unbroken."
	CRLF
	CALL PRINT-ID,STR?191 >STACK
	RSTACK
?L7:	EQUAL? PRSA,V?LEAP,V?CLIMB-ON,V?BOARD \?L10
	PRINT TOO-SLIPPERY
	CALL PRINT-ID,STR?192
	RTRUE
?L10:	EQUAL? PRSA,V?WALK-TO \?L13
	EQUAL? HERE,DRIVEWAY,COURTYARD /?L13
	CALL PERFORM,PRSA,COURTYARD
	RTRUE
?L13:	EQUAL? PRSA,V?OPEN \?L14
	FSET? FRONT-GATE,LOCKED \FALSE
	PRINTR "It seems to be locked."
?L14:	EQUAL? PRSA,V?SEARCH-FOR /?L21
	EQUAL? PRSA,V?SEARCH,V?LOOK-ON,V?EXAMINE \?L20
?L21:	EQUAL? HERE,DRIVEWAY \FALSE
	CALL TELL-ABOUT-DRAGON
	RTRUE
?L20:	IN? VOICE,HERE \FALSE
	CALL VOICE-F >STACK
	RSTACK

	.FUNCT COURTYARD-F,RARG=0
	EQUAL? RARG,M-ENTER \?L1
	IN? FRIEND,LIMBO \?L3
	MOVE FRIEND,COURTYARD
?L3:	ZERO? DRAGON-EYE-COLOR /?L6
	SET 'DRAGON-EYE-COLOR,0
?L6:	FSET? FRONT-GATE,LOCKED /FALSE
	FCLEAR FRONT-GATE,OPENBIT
	FSET FRONT-GATE,LOCKED
	PRINTI "The "
	PRINTD FRONT-GATE
	PRINTR " closes and locks behind you."
?L1:	EQUAL? RARG,M-LOOK \?L14
	FSET? HERE,TOUCHBIT /?L15
	FSET HERE,TOUCHBIT
	PRINTI "As flood lights blaze on, you look around. "
?L15:	CALL TELL-LIKE-BROCHURE
	PRINT DARK-TURRETS
	RTRUE
?L14:	EQUAL? RARG,M-FLASH \FALSE
	IN? FRIEND,COURTYARD \FALSE
	FSET? FRIEND,TOUCHBIT /FALSE
	ZERO? CLOCK-WAIT \FALSE
	FSET FRIEND,TOUCHBIT
	FCLEAR FRIEND,NDESCBIT
	SET 'FOLLOWER,FRIEND
	SET 'QCONTEXT,FRIEND
	CALL QUEUE,I-FRIEND-GREETS,0
	CALL QUEUE,I-TOUR,7
	CALL ESTABLISH-GOAL,BUTLER,COURTYARD
	FCLEAR FRONT-DOOR,LOCKED
	SET 'QCONTEXT,FRIEND
	CALL THIS-IS-IT,FRIEND
	PUTP FRIEND,P?LDESC,12
	SET 'AWAITING-REPLY,FRIEND-C
	CALL QUEUE,I-REPLY,CLOCKER-RUNNING
	CALL PRINT-ID,STR?193
	PRINTI "
Someone comes running out of the wing to greet you. "
	GETP FRIEND,P?TEXT >STACK
	PRINT STACK
	PRINTI " You recognize her as your friend, "
	PRINTD FRIEND
	PRINTI " Lynd.
"""
	CALL PRINT-NAME,FIRST-NAME
	PRINTI "!"" she cries with outflung arms. ""You sweet thing, to answer[RWD_ID: castle:586, VAL: 1] my letter in person this way! And all the people I wrote about are here tonight for Lionel's memorial birthday dinner!""
After a warm hug, she asks anxiously, """
	GET QUESTIONS,AWAITING-REPLY >STACK
	PRINT STACK
	PRINTI """
"
	RETURN 2

	.FUNCT TELL-LIKE-BROCHURE,DR=0
	PRINTI "It looks even lovelier than it sounds in the "
	PRINTD BROCHURE
	PRINTI "."
	ZERO? DR /?L3
	CALL OPEN-DOOR?,DR
?L3:	CRLF
	RTRUE

	.FUNCT MAZE-EXIT,RM
	EQUAL? OHERE,GARDEN \?L1
	SET 'RM,COURTYARD
	JUMP ?L3
?L1:	SET 'RM,GARDEN
?L3:	EQUAL? WINNER,PLAYER \?L4
	PRINTI "You stumble blindly through the maze and suddenly emerge in the "
	PRINTD RM
	PRINTI ".
"
?L4:	RETURN RM

	.FUNCT MAZE-F,RARG=0
	ZERO? RARG \FALSE
	EQUAL? PRSA,V?THROUGH \FALSE
	EQUAL? HERE,MAZE \FALSE
	CALL MAZE-EXIT >STACK
	CALL GOTO,STACK >STACK
	RSTACK

	.FUNCT GARDEN-F,RARG=0,OBJ
	EQUAL? RARG,M-LOOK \?L1
	PRINTI "Here in the central garden the plants quake nervously in the mist. In the very middle is a "
	PRINTD POND
	PRINTR "."
?L1:	ZERO? RARG \FALSE
	EQUAL? PRSA,V?SEARCH-FOR,V?SEARCH,V?EXAMINE \FALSE
	CALL FIND-FLAG-HERE,SECRETBIT >OBJ
	ZERO? OBJ /FALSE
	CALL DISCOVER,OBJ,HERE
	RTRUE

	.FUNCT POND-F
	EQUAL? PRSA,V?THROUGH /?L3
	EQUAL? PRSA,V?SWIM,V?LEAP,V?BOARD \?L1
?L3:	PRINTR "On second thought, it looks too dark and slippery."
?L1:	EQUAL? PRSA,V?LOOK-UNDER,V?LOOK-INSIDE,V?EXAMINE \FALSE
	CALL TELL-AS-WELL-AS,POND,STR?194
	RTRUE

	.FUNCT FRONT-DOOR-F
	EQUAL? PRSA,V?WALK-TO \FALSE
	CALL OUTSIDE?,HERE >STACK
	ZERO? STACK /?L3
	CALL PERFORM,V?WALK-TO,COURTYARD
	RTRUE
?L3:	CALL PERFORM,V?WALK-TO,FOYER
	RTRUE

	.FUNCT FOYER-F,RARG=0
	EQUAL? RARG,M-ENTER \?L1
	FSET? FOYER,TOUCHBIT /FALSE
	FSET FOYER,TOUCHBIT
	PRINTI "As you enter the foyer, you're overwhelmed by the English past. Those barbarous times when Jack's ancestors had to shut themselves up in a fortified castle have softened into gracious country living. Yet "
	PRINTD FRIEND
	PRINTR " is clearly anxious."
?L1:	EQUAL? RARG,M-LOOK \?L8
	CALL TELL-LIKE-BROCHURE
	CALL DESCRIBE-CONTENTS,COAT-RACK
	RTRUE
?L8:	EQUAL? RARG,M-FLASH \FALSE
	FSET? LORD,TOUCHBIT /TRUE
	IN? LORD,FOYER \TRUE
	CALL LORD-INTRO
	RTRUE

	.FUNCT DESCRIBE-CONTENTS,OBJ
	CALL FIND-FLAG-NOT,OBJ,NDESCBIT >STACK
	ZERO? STACK /FALSE
	PRINTI "On"
	CALL PRINTT,OBJ
	PRINTI " you see"
	CALL PRINT-CONTENTS,OBJ
	PRINTI ".
"
	RTRUE

	.FUNCT UMBRELLA-STAND-F
	FCLEAR UMBRELLA-STAND,NDESCBIT
	EQUAL? PRSA,V?CLOSE,V?OPEN \?L1
	CALL YOU-CANT >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?TAKE \?L3
	CALL NOUN-USED?,W?UMBRELLA >STACK
	ZERO? STACK /FALSE
	PRINTR "But it's not raining!"
?L3:	EQUAL? PRSA,V?SEARCH-FOR /?L10
	EQUAL? PRSA,V?SEARCH,V?LOOK-INSIDE,V?EXAMINE \FALSE
?L10:	IN? CANE,UMBRELLA-STAND \?L11
	FSET? CANE,NDESCBIT \?L11
	FCLEAR CANE,NDESCBIT
	FCLEAR CANE,SECRETBIT
	FSET CANE,SEENBIT
	FSET CANE,TAKEBIT
	FSET CANE,TOUCHBIT
	CALL THIS-IS-IT,CANE
	PRINTR "Among the umbrellas there's a cane that looks odd."
?L11:	EQUAL? PRSA,V?EXAMINE \?L15
	CALL TELL-LIKE-BROCHURE >STACK
	RSTACK
?L15:	CALL TELL-AS-WELL-AS,UMBRELLA-STAND,STR?195
	RTRUE

	.FUNCT DRAWING-ROOM-F,RARG=0,PER
	EQUAL? RARG,M-BEG \?L1
	EQUAL? PRSA,V?CLOSE,V?OPEN \?L3
	EQUAL? PRSO,SECRET-DRAWING-DOOR \?L3
	CALL YOU-CANT,0,PLAYER,STR?196
	RTRUE
?L3:	CALL SECRET-CHECK,RARG >STACK
	RSTACK
?L1:	EQUAL? RARG,M-LOOK \?L6
	CALL TELL-LIKE-BROCHURE,SECRET-DRAWING-DOOR >STACK
	RSTACK
?L6:	EQUAL? RARG,M-FLASH \FALSE
	IN? DEALER,DRAWING-ROOM \FALSE
	FSET? DEALER,TOUCHBIT /FALSE
	FSET DEALER,TOUCHBIT
	LOC PAINTER >STACK
	EQUAL? STACK,HERE,PSEUDO-OBJECT \FALSE
	GETP DEALER,P?LDESC >STACK
	EQUAL? STACK,2 \FALSE
	PRINTI "A tall graceful older couple in evening clothes are chatting and "
	GET LDESC-STRINGS,2 >STACK
	PRINT STACK
	PRINTI ".
"
	SET 'QCONTEXT,PAINTER
	LOC LORD >STACK
	EQUAL? STACK,HERE,PSEUDO-OBJECT \?L14
	SET 'PER,LORD
	JUMP ?L16
?L14:	LOC FRIEND >STACK
	EQUAL? STACK,HERE,PSEUDO-OBJECT \?L16
	CALL THIS-IS-IT,FRIEND
	SET 'PER,FRIEND
?L16:	ZERO? PER /FALSE
	PRINTD PER
	PRINT INTRODUCES
	PRINTI "them as Montague Hyde and Vivien Pentreath.
Hyde smiles and bows stiffly. And Vivien murmurs in an attractively low voice, ""How do you do, "
	CALL TITLE-NAME >STACK
	ZERO? STACK /?L22
	PRINTC 46
?L22:	PRINTI """
""Believe it or not, this young "
	ZERO? GENDER-KNOWN \?L29
	PRINTI "person"
	JUMP ?L36
?L29:	FSET? PLAYER,FEMALE \?L33
	PRINTI "lady"
	JUMP ?L36
?L33:	PRINTI "man"
?L36:	PRINTI " is a famous American detective,"" "
	PRINTD PER
	PRINTI " tells them.
"
	LOC FRIEND >STACK
	EQUAL? STACK,HERE,PSEUDO-OBJECT \FALSE
	PRINTI """Not a police detective, of course,"" "
	PRINTD FRIEND
	PRINTI " adds as they both stiffen, ""but a solver of all sorts of mysteries in the States. We're hoping to find out who or what is haunting "
	PRINTD CASTLE
	PRINTR "."""

	.FUNCT LOVER-PIC-F
	EQUAL? PRSA,V?EXAMINE \FALSE
	PRINTI "It's a portrait by "
	PRINTD PAINTER
	PRINTI " of "
	PRINTD LOVER
	PRINTI ", a lovely young woman with flowing blonde hair, standing on a grassy slope, gazing out to sea. It's painted in pastel tones, which emphasize "
	PRINTD LOVER
	PRINTR "'s violet eyes. There's something ethereal and fairylike about her. Ironically, her silvery white, sleeveless gown is the very one she was wearing at the time of her accident."

	.FUNCT TAPESTRY-F
	EQUAL? PRSA,V?SEARCH,V?EXAMINE \?L1
	CALL TELL-LIKE-BROCHURE
	EQUAL? VARIATION,PAINTER-C \TRUE
	PRINTR "Someone has added a star in red thread on the maiden's ARM."
?L1:	EQUAL? PRSA,V?LOOK-UNDER,V?LOOK-BEHIND \FALSE
	FSET SECRET-DRAWING-DOOR,TOUCHBIT
	CALL THIS-IS-IT,SECRET-DRAWING-DOOR
	PRINTI "Hidden behind the "
	PRINTD TAPESTRY
	PRINTI " is"
	CALL PRINTT,SECRET-DRAWING-DOOR
	PRINTR "!"

	.FUNCT GREAT-HALL-F,RARG=0
	EQUAL? RARG,M-LOOK \?L1
	CALL TELL-LIKE-BROCHURE
	CALL GREAT-HALL-IS-FLOORED
	RTRUE
?L1:	EQUAL? RARG,M-FLASH \FALSE
	IN? DEB,GREAT-HALL \FALSE
	FSET? DEB,TOUCHBIT /FALSE
	ZERO? CLOCK-WAIT \FALSE
	FSET DEB,TOUCHBIT
	FCLEAR DEB,NDESCBIT
	LOC OFFICER >STACK
	EQUAL? STACK,HERE,PSEUDO-OBJECT \?L6
	GETP DEB,P?LDESC >STACK
	EQUAL? STACK,1 \?L6
	PRINTI "A young couple are dancing to the faint sound of rock music from a portable radio on a table nearby.
"
?L6:	GETP DEB,P?TEXT >STACK
	PRINT STACK
	CRLF
	CALL COMMON-DESC,OFFICER
	PRINTI "
They stop dancing, turn off the radio, and greet you."
	LOC FRIEND >STACK
	EQUAL? STACK,HERE,PSEUDO-OBJECT \?L15
	PRINTC 32
	PRINTD FRIEND
	PRINT INTRODUCES
	PRINTI "them as the Honourable Iris Vane and Lt. Ian Fordyce of Her Majesty's Coldstream Guards.
"
?L15:	PUTP DEB,P?LDESC,0
	CALL THIS-IS-IT,DEB
	PUTP OFFICER,P?LDESC,0
	CALL THIS-IS-IT,OFFICER
	CALL QUEUE,I-TOUR,0
	CALL QUEUE,I-REPLY,CLOCKER-RUNNING
	ZERO? GENDER-KNOWN /?L25
	FSET? PLAYER,FEMALE /?L20
	ZERO? GENDER-KNOWN \?L23
?L25:	PRINTI """What a lark, having a Yank sleuth in our midst"
	JUMP ?L27
?L23:	PRINTI """My dear! What a handsome addition to your guest list"
?L27:	PRINTI "!"" chirps Iris. Her green eyes sparkle "
	ZERO? GENDER-KNOWN \?L32
	PRINTI "a trifle malic"
	JUMP ?L36
?L32:	PRINTI "flirtat"
?L36:	PRINTI "iously as she offers you her delicate hand. "
	ZERO? GENDER-KNOWN \?L41
	SET 'QCONTEXT,OFFICER
	PUTP OFFICER,P?LDESC,12
	SET 'AWAITING-REPLY,OFFICER-1-R
	PRINTI """I always find Americans so innocently fascinating! I'm sure you'll have loads to tell us about the baffling mysteries you've solved...""
""Belt up, Iris, there's a good girl,"" says Ian. Flashing you an apologetic smile, he comments, ""Spoiled rotten, I'm afraid. Personally I should like nothing better than to hear all about your mystery cases. But first tell us: "
	GET QUESTIONS,AWAITING-REPLY >STACK
	PRINT STACK
	PRINTI """
"
	RETURN 2
?L41:	SET 'QCONTEXT,DEB
	PUTP DEB,P?LDESC,12
	SET 'AWAITING-REPLY,DEB-C
	PRINTI """Tell me, "
	CALL TITLE-NAME
	PRINTI " -- "
	GET QUESTIONS,AWAITING-REPLY >STACK
	PRINT STACK
	PRINTI """
"
	RETURN 2
?L20:	EQUAL? VARIATION,FRIEND-C \?L53
	PRINTD DEB
	PRINTI " pulls Jack aside, whispers something to him, and giggles."
	CRLF
?L53:	SET 'QCONTEXT,OFFICER
	CALL THIS-IS-IT,OFFICER
	PUTP OFFICER,P?LDESC,12
	SET 'AWAITING-REPLY,OFFICER-2-R
	PRINTI """I say!"" exclaims Ian, bringing your hand to his lips. His glance runs swiftly over your face and figure with an air of expert appraisal. """
	GET QUESTIONS,AWAITING-REPLY >STACK
	PRINT STACK
	PRINTI """
"
	RETURN 2

	.FUNCT GREAT-HALL-IS-FLOORED
	PRINTI "The hall is floored with black and white marble tiles. They've been worn smooth by footsteps over the centuries, especially near the archway to the "
	PRINTD DRAWING-ROOM
	PRINTR "."

	.FUNCT ARMOR-F
	FCLEAR ARMOR,NDESCBIT
	EQUAL? PRSA,V?EXAMINE \?L1
	PRINTR "This is a full suit of steel body armour. It creaks as you walk past."
?L1:	EQUAL? PRSA,V?SEARCH-FOR /?L6
	EQUAL? PRSA,V?SEARCH,V?OPEN,V?LOOK-INSIDE \FALSE
?L6:	IN? CLUE-3,ARMOR \FALSE
	FSET? CLUE-3,SECRETBIT \FALSE
	FSET ARMOR,OPENBIT
	CALL DISCOVER,CLUE-3 >STACK
	RSTACK

	.FUNCT SECRET-SITTING-DOOR-F
	EQUAL? PRSA,V?OPEN,V?LOOK-INSIDE \FALSE
	PRINTR "It seems to be stuck closed."

	.FUNCT SITTING-ROOM-F,RARG=0
	EQUAL? RARG,M-BEG \?L1
	CALL SECRET-CHECK,RARG >STACK
	RSTACK
?L1:	EQUAL? RARG,M-LOOK \FALSE
	CALL TELL-LIKE-BROCHURE
	PRINTI "It's a comfy place to read a book, play the piano, or just relax."
	CRLF
	CALL DESCRIBE-CONTENTS,PIANO
	CALL DESCRIBE-CONTENTS,WRITING-DESK
	RTRUE

	.FUNCT WYVERN-F
	EQUAL? PRSA,V?OPEN,V?LOOK-INSIDE \?L1
	CALL SECRET-SITTING-DOOR-F >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?SIT-AT /?L4
	EQUAL? PRSA,V?SIT,V?CLIMB-ON,V?BOARD \?L3
?L4:	MOVE PLAYER,WYVERN
	PRINTR "Okay, but it's not that comfortable."
?L3:	EQUAL? PRSA,V?TURN,V?SLAP,V?RUB /?L8
	EQUAL? PRSA,V?PUSH /?L8
	EQUAL? PRSA,V?MUNG,V?MOVE-DIR,V?MOVE \FALSE
?L8:	CALL OPEN-SECRET,STR?197,WYVERN,SECRET-SITTING-DOOR
	FCLEAR SECRET-SITTING-DOOR,OPENBIT
	PRINTI "Before you know it, "
	IN? PLAYER,WYVERN \?L11
	PRINTI "you're dumped into it.
"
	CALL GOTO,SITTING-PASSAGE
	RTRUE
?L11:	PRINTR "it creaks upward to close again."

	.FUNCT WRITING-DESK-F
	CALL REMOTE-VERB? >STACK
	ZERO? STACK \FALSE
	IN? LETTER-MAID,WRITING-DESK \FALSE
	FCLEAR LETTER-MAID,NDESCBIT
	RFALSE

	.FUNCT PIANO-F,O,N=0
	EQUAL? PRSA,V?LISTEN \?L1
	LOC PIANO >STACK
	FIRST? STACK >O /?L3
?L3:	ZERO? O /FALSE
?L6:	FSET? O,PERSONBIT \?L8
	GETP O,P?LDESC >STACK
	EQUAL? STACK,22 \?L8
	PRINTR "The music sounds lovely."
?L8:	NEXT? O >O /?L6
	RFALSE
?L1:	EQUAL? PRSA,V?PLAY \?L13
	PUTP WINNER,P?LDESC,22
	ZERO? PRSI /?L14
	FSET? PRSI,PERSONBIT \?L14
	PUTP PRSI,P?LDESC,22
?L14:	CALL HE-SHE-IT,WINNER,1,STR?198
	PRINTI " down"
	FIRST? SITTING-ROOM >O /?L22
?L72:	ZERO? N \?L39
	PRINTI " and"
	JUMP ?L21
?L22:	GETP O,P?LDESC >STACK
	EQUAL? STACK,22 \?L29
	EQUAL? O,WINNER /?L29
	ZERO? N \?L30
	PRINTI " with"
?L30:	INC 'N
	PRINTC 32
	PRINTD O
	PRINTI " and"
?L29:	NEXT? O >O /?L22
	JUMP ?L72
?L21:	ZERO? N \?L39
	CALL HE-SHE-IT,WINNER,-1,STR?199
	JUMP ?L43
?L39:	GETP PLAYER,P?LDESC >STACK
	EQUAL? STACK,22 \?L44
	PRINTI " you "
	EQUAL? N,1 \?L48
	PRINTI "both"
	JUMP ?L55
?L48:	PRINTI "all"
	JUMP ?L55
?L44:	PRINTI " they"
?L55:	PRINTI " play"
?L43:	PRINTI " a lovely "
	GET PIANO-PIECES,N >STACK
	PRINT STACK
	GRTR? N,2 \?L62
	PRINTI "tet"
?L62:	PRINTR "."
?L13:	CALL REMOTE-VERB? >STACK
	ZERO? STACK \FALSE
	IN? MUSIC,PIANO \FALSE
	FCLEAR MUSIC,NDESCBIT
	RFALSE

	.FUNCT MUSIC-F
	EQUAL? PRSA,V?PLAY,V?LISTEN \?L1
	IN? PIANO,HERE \?L3
	CALL PIANO-F
	RTRUE
?L3:	CALL NOT-HERE,PIANO
	RTRUE
?L1:	CALL REMOTE-VERB? >STACK
	ZERO? STACK \FALSE
	FCLEAR MUSIC,NDESCBIT
	EQUAL? PRSA,V?READ /?L10
	EQUAL? PRSA,V?OPEN,V?LOOK-INSIDE,V?EXAMINE \FALSE
?L10:	CALL NOT-HOLDING?,PRSO >STACK
	ZERO? STACK \TRUE
	PRINTI "It's "
	EQUAL? VARIATION,PAINTER-C \?L16
	PRINTR "Beethoven's ""Suite No. 9."" Someone has drawn a star in red ink over the first four letters of the word ""SUITe."""
?L16:	EQUAL? VARIATION,DOCTOR-C \?L20
	PRINTR """Funeral March of a Marionette."""
?L20:	PRINTR "theme music from the American radio show, ""A Prairie Home Companion."""

	.FUNCT CORR-1-F,ARG=0
	EQUAL? ARG,M-LOOK \FALSE
	PRINTI "The "
	PRINTD CORR-1
	PRINTI " goes between the two great halls to east and west. Behind sliding doors, the "
	PRINTD DINING-ROOM
	PRINTI " is north and the "
	PRINTD SITTING-ROOM
	PRINTR " is south."

	.FUNCT DINING-ROOM-F,RARG=0,N
	EQUAL? RARG,M-LOOK \?L1
	PRINT DINING-DESC
	RTRUE
?L1:	EQUAL? RARG,M-ENTER \?L5
	CALL QUEUED?,I-DINNER-SIT >STACK
	ZERO? STACK /?L6
	IN? LORD,DINING-ROOM \?L8
	CALL QUEUE,I-DINNER-SIT,1
	RFALSE
?L8:	CALL FIND-FLAG-HERE,PERSONBIT,PLAYER,BUTLER >N
	ZERO? N /FALSE
	CALL HE-SHE-IT,N,1
	PRINTR " says, ""Let's wait for his lordship."""
?L6:	ZERO? MISSED-DINNER /FALSE
	IN? FRIEND,HERE \FALSE
	SET 'MISSED-DINNER,0
	FSET? DINING-ROOM,TOUCHBIT /?L17
	FSET DINING-ROOM,TOUCHBIT
	PRINT DINING-DESC
?L17:	CALL THIS-IS-IT,FRIEND
	SET 'QCONTEXT,FRIEND
	PRINTD FRIEND
	PRINTI " says, ""We didn't know when you would come to dinner, so we started without you."
	EQUAL? LIONEL-SPEAKS-COUNTER,INIT-LIONEL-SPEAKS-COUNTER \?L24
	PRINTR """"
?L24:	CALL QUEUE,I-DINNER-TALK,1
	PRINTI " And "
	ZERO? LIONEL-SPEAKS-COUNTER \?L31
	PRINTI "then Lionel spoke"
	JUMP ?L35
?L31:	PRINTI "now Lionel is speaking"
?L35:	PRINTR " on tape!"""
?L5:	EQUAL? RARG,M-EXIT \FALSE
	CALL QUEUED?,I-LIONEL-SPEAKS >STACK
	ZERO? STACK /FALSE
	PRINTD LORD
	PRINTI " politely but firmly vetoes any such move. """
	EQUAL? LIONEL-SPEAKS-COUNTER,INIT-LIONEL-SPEAKS-COUNTER \?L46
	PRINTI "It's annoying enough to have the servants abscond at dinner time,"" he points out drily. "
	PRINT JACK-THINKS-GLADYS
	PRINTR " Cigars and port will be time enough for that sort of aggro!"""
?L46:	PRINTR "Let's hear what old Lionel has to say."""

	.FUNCT I-DINNER-TALK,GARG=0
	FSET DINNER,TAKEBIT
	FCLEAR DINNER,TRYTAKEBIT
	MOVE DINNER-2,TABLE-DINING
	CALL QUEUED?,I-LIONEL-SPEAKS >STACK
	CALL DINNER-TALK,STACK
	RETURN 2

	.FUNCT DINNER-TALK,N,X
	MOVE PLAYER,CHAIR-DINING
	PRINTI "Several people glance at your outfit with "
	EQUAL? NOW-WEARING,DINNER-OUTFIT /?L3
	SET 'WRONG-OUTFIT,2
	PRINTI "dis"
	CALL PRINT-ID,STR?200
	JUMP ?L7
?L3:	SET 'WRONG-OUTFIT,1
?L7:	PRINTI "approval."
	ZERO? WASHED \?L10
	PRINTI " They whisper about how dirty you still look."
	CALL PRINT-ID,STR?201
?L10:	CRLF
	EQUAL? LIONEL-SPEAKS-COUNTER,INIT-LIONEL-SPEAKS-COUNTER \?L15
	PRINTD LORD
	PRINTI " announces his engagement to "
	PRINTD FRIEND
	PRINTI ", prompting various reactions from the guests.
[RWD_ID: castle:1440, VAL: 1]The dinner is excellent, with a flow of subdued conversation...
"
?L15:	PUTP LORD,P?LDESC,0
	SET 'KEEP-WAITING,1
	CALL V-WAIT,N,0,1 >STACK
	RSTACK

	.FUNCT POPULATION,RM,NOT1=0,NOT2=0,CNT=0,OBJ
	FIRST? RM >OBJ \FALSE
?L2:	FSET? OBJ,PERSONBIT \?L7
	FSET? OBJ,INVISIBLE /?L7
	ZERO? NOT1 /?L9
	EQUAL? OBJ,NOT1 /?L7
?L9:	ZERO? NOT2 /?L10
	EQUAL? OBJ,NOT2 /?L7
?L10:	INC 'CNT
	JUMP ?L11
?L7:	FSET? OBJ,CONTBIT \?L11
	CALL POPULATION,OBJ,NOT1,NOT2 >STACK
	ADD CNT,STACK >CNT
?L11:	NEXT? OBJ >OBJ /?L2
	RETURN CNT

	.FUNCT BUST-D,ARG
	CALL THIS-IS-IT,COUSIN
	PRINTI "A brooding bust of "
	PRINTD COUSIN
	PRINTI " (sculpted by "
	PRINTD PAINTER
	PRINTR ") is displayed in a corner."

	.FUNCT BUST-F
	EQUAL? PRSA,V?PUSH,V?OPEN,V?MOVE-DIR /?L3
	EQUAL? PRSA,V?MOVE,V?LOOK-UNDER,V?EXAMINE /?L3
	EQUAL? PRSA,V?TAKE \?L1
	EQUAL? P-PRSA-WORD,W?RAISE,W?LIFT \?L1
?L3:	EQUAL? PRSA,V?EXAMINE \?L4
	EQUAL? LIONEL-SPEAKS-COUNTER,INIT-LIONEL-SPEAKS-COUNTER \?L4
	CALL TELL-LIKE-BROCHURE
	RTRUE
?L4:	PRINTI "The "
	PRINTD BUST
	PRINTI " is hollow. When you lift it from its shelf, you discover"
	CALL PRINTT,RECORDER
	PRINTI " underneath, with an elaborate clockwork timer."
	FSET BUST,OPENBIT
	FSET RECORDER,SEENBIT
	EQUAL? LIONEL-SPEAKS-COUNTER,INIT-LIONEL-SPEAKS-COUNTER /?L9
	PRINTI " Evidently the timer was set to play the tape during the usual dinner hour on this date."
?L9:	CRLF
	RTRUE
?L1:	EQUAL? PRSA,V?PLAY,V?LISTEN \FALSE
	CALL QUEUED?,I-LIONEL-SPEAKS >STACK
	ZERO? STACK /?L15
	SET 'LIONEL-FORCED,1
	CALL QUEUE,I-LIONEL-SPEAKS,1
	RTRUE
?L15:	PRINT TIMER-PREVENTS-IT
	RTRUE

	.FUNCT RECORDER-F
	EQUAL? PRSA,V?PLAY,V?LISTEN,V?EXAMINE \?L1
	CALL BUST-F >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?LAMP-OFF,V?LAMP-ON \?L3
	PRINT TIMER-PREVENTS-IT
	RTRUE
?L3:	EQUAL? PRSA,V?TAKE \?L6
	PRINTR "It's fastened tightly to the shelf."
?L6:	CALL SPEAKING-VERB?,RECORDER >STACK
	ZERO? STACK /FALSE
	CALL WONT-HELP-TO-TALK-TO,RECORDER >STACK
	RSTACK

	.FUNCT TABLE-DINING-F
	EQUAL? PRSA,V?LOOK-ON,V?LOOK-INSIDE,V?EXAMINE \?L1
	FSET? DINNER,TAKEBIT \FALSE
	CALL TELL-AS-WELL-AS,TABLE-DINING,STR?202
	RTRUE
?L1:	EQUAL? PRSA,V?SIT-AT \?L6
	CALL PERFORM,V?SIT,CHAIR-DINING
	RTRUE
?L6:	EQUAL? PRSA,V?SIT \FALSE
	CALL PRINT-ID,STR?203
	CALL HAR-HAR
	RTRUE

	.FUNCT PUNCHBOWL-F,OBJ
	EQUAL? PRSA,V?CLOSE,V?OPEN \?L1
	CALL HAR-HAR >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?PUT-UNDER \?L3
	EQUAL? PRSI,PUNCHBOWL \FALSE
	FSET PRSO,NDESCBIT
	MOVE PRSO,SIDEBOARD
	PRINTR "Okay."
?L3:	EQUAL? PRSA,V?TAKE,V?MOVE,V?LOOK-UNDER \FALSE
	EQUAL? PRSO,PUNCHBOWL \FALSE
	CALL FIND-FLAG,SIDEBOARD,NDESCBIT >OBJ
	ZERO? OBJ /?L10
	FSET OBJ,TAKEBIT
	FSET OBJ,TOUCHBIT
	FCLEAR OBJ,NDESCBIT
	MOVE OBJ,PLAYER
	CALL THIS-IS-IT,OBJ
	PRINTI "You find"
	CALL PRINTT,OBJ
	PRINTR " underneath, so you take it."
?L10:	PRINTR "There's nothing under it."

	.FUNCT DINNER-D,ARG,L
	LOC DINNER >L
	EQUAL? L,KITCHEN,SIDEBOARD \FALSE
	PRINTI "An appetizing aroma wafts from an array of covered dishes"
	EQUAL? L,KITCHEN \?L5
	PRINTI " sitting about"
	JUMP ?L9
?L5:	EQUAL? L,SIDEBOARD \?L9
	PRINTI " on the "
	PRINTD SIDEBOARD
?L9:	PRINTR "."

	.FUNCT DINNER-F,I,L,?TMP
	LOC DINNER >L
	EQUAL? PRSA,V?DRESS \?L1
	SET '?TMP,HERE
	CALL META-LOC,DINNER-OUTFIT >STACK
	EQUAL? ?TMP,STACK \?L3
	CALL PERFORM,V?WEAR,DINNER-OUTFIT
	RTRUE
?L3:	CALL NOT-HERE,DINNER-OUTFIT
	RTRUE
?L1:	EQUAL? PRSA,V?EAT \?L6
	PRINTR "You take a bite and find it delicious."
?L6:	EQUAL? PRSA,V?EXAMINE \?L11
	PRINTI "A lovely assortment of fish, fowl, greens, and sweets fills the "
	EQUAL? L,KITCHEN,SIDEBOARD \?L14
	PRINTR "dishes."
?L14:	PRINTR "plate."
?L11:	EQUAL? PRSA,V?LAMP-ON,V?TAKE \?L21
	FSET? DINNER,TRYTAKEBIT \FALSE
	EQUAL? L,KITCHEN \?L24
	PRINTR "It's not ready yet."
?L24:	EQUAL? L,SIDEBOARD \FALSE
	CALL I-DINNER-SIT >L
	ZERO? L \?L29
	PRINTR "You look around and notice that no one else is eating yet."
?L29:	RETURN L
?L21:	EQUAL? PRSA,V?WAIT-FOR \?L36
	CALL QUEUED?,I-DINNER >I
	ZERO? I /FALSE
	SUB DINNER-TIME,PRESENT-TIME >STACK
	CALL V-WAIT,STACK,0,1
	RTRUE
?L36:	EQUAL? PRSA,V?WALK-TO \FALSE
	EQUAL? HERE,DINING-ROOM \?L41
	SET '?TMP,PRSA
	CALL META-LOC,DINNER >STACK
	CALL PERFORM,?TMP,STACK
	RTRUE
?L41:	CALL PERFORM,PRSA,DINING-ROOM
	RTRUE

	.FUNCT BACKSTAIRS-F,RARG=0
	EQUAL? RARG,M-BEG \?L1
	CALL SECRET-CHECK,RARG >STACK
	RSTACK
?L1:	EQUAL? RARG,M-LOOK \FALSE
	PRINTI "You can go east to the "
	PRINTD DINING-ROOM
	PRINTI " or down narrow stairs to the "
	PRINTD KITCHEN
	PRINTI "."
	CALL OPEN-DOOR?,SECRET-DINING-DOOR
	CRLF
	RTRUE

	.FUNCT KITCHEN-F,RARG=0
	EQUAL? RARG,M-LOOK \FALSE
	PRINTI "The "
	PRINTD KITCHEN
	PRINTI " is large yet cramped. From here, you can go west to the tower "
	PRINTD BASEMENT
	PRINTR ", east to the servants' quarters, or up the stairs."

	.FUNCT LANTERN
	EQUAL? PRSA,V?AIM \?L1
	CALL START-SENTENCE,LAMP
	PRINTI " shines in all "
	PRINTD INTDIR
	PRINTR "s, so you can't point it."
?L1:	EQUAL? PRSA,V?USE \?L5
	CALL PERFORM,V?LAMP-ON,PRSO
	RTRUE
?L5:	EQUAL? PRSA,V?EXAMINE \FALSE
	PRINTI "The lamp "
	FSET? LAMP,ONBIT \?L9
	PRINTR "is on."
?L9:	PRINTR "is turned off."

	.FUNCT GALLERY-F,RARG=0
	EQUAL? RARG,M-BEG \?L1
	EQUAL? PRSA,V?SEARCH-FOR,V?SEARCH /?L5
	EQUAL? PRSA,V?LOOK-UNDER,V?LOOK-BEHIND,V?EXAMINE \FALSE
?L5:	EQUAL? PRSO,WALL,PAINTING-GALLERY \FALSE
	FCLEAR PEEPHOLE,SECRETBIT
	PRINTI "You discover"
	CALL HIM-HER-IT,PEEPHOLE
	PRINTR " in the eye of one ancestor."
?L1:	EQUAL? RARG,M-LOOK \FALSE
	PRINTI "The "
	PRINTD GALLERY
	PRINTI " spans the top of the double stairways. You can go east to "
	PRINTD YOUR-ROOM
	PRINTI " or west to "
	PRINTD VIVIEN-ROOM
	PRINTI ". Hallways lead to the northeast and northwest. On the wall is a "
	PRINTD PAINTING-GALLERY
	PRINTI " of "
	PRINTD LORD
	PRINTR "'s ancestors."

	.FUNCT PICTURE-F,RARG=0
	EQUAL? PRSA,V?EXAMINE \FALSE
	CALL TELL-LIKE-BROCHURE >STACK
	RSTACK

	.FUNCT BATHROOM-F
	EQUAL? PRSA,V?WALK-TO,V?THROUGH /?L3
	EQUAL? PRSA,V?LOOK-INSIDE,V?EXAMINE,V?BOARD \FALSE
?L3:	EQUAL? HERE,YOUR-ROOM \?L4
	CALL PERFORM,PRSA,YOUR-BATHROOM
	RTRUE
?L4:	CALL RANDOM-PSEUDO >STACK
	RSTACK

	.FUNCT FIREPLACE-F
	EQUAL? PRSA,V?LOOK-UP,V?LOOK-INSIDE,V?EXAMINE \?L1
	EQUAL? HERE,IAN-ROOM \?L3
	CALL TELL-IAN-FIREPLACE
	CRLF
	RTRUE
?L3:	PRINTR "It's empty, except for soot on the walls."
?L1:	EQUAL? PRSA,V?LAMP-ON \?L8
	CALL WONT-HELP >STACK
	RSTACK
?L8:	EQUAL? PRSA,V?PUT-IN \FALSE
	PRINTI "When you think how sooty"
	CALL PRINTT,PRSO
	PRINTI " would get, you change your mind."
	CRLF
	CALL PRINT-ID,STR?204 >STACK
	RSTACK

	.FUNCT BED-PSEUDO
	EQUAL? PRSA,V?THROUGH,V?SIT /?L3
	EQUAL? PRSA,V?LIE,V?CLIMB-ON,V?BOARD \FALSE
?L3:	CALL WONT-HELP >STACK
	RSTACK

	.FUNCT NIGHTSTAND-LG-F
	EQUAL? HERE,JACK-ROOM \?L9
	EQUAL? PRSA,V?SEARCH-FOR,V?SEARCH /?L3
	EQUAL? PRSA,V?OPEN,V?LOOK-INSIDE,V?EXAMINE \?L1
?L3:	IN? NECKLACE-OF-D,JACK-ROOM \?L4
	CALL DISCOVER,NECKLACE-OF-D >STACK
	RSTACK
?L4:	PRINT NOTHING-NEW
	RTRUE
?L1:	EQUAL? HERE,JACK-ROOM \?L9
	EQUAL? PRSA,V?PUT-IN \?L9
	EQUAL? PRSO,NECKLACE-OF-D \?L9
	MOVE NECKLACE-OF-D,JACK-ROOM
	FSET NECKLACE-OF-D,NDESCBIT
	CALL OKAY >STACK
	RSTACK
?L9:	CALL RANDOM-PSEUDO >STACK
	RSTACK

	.FUNCT DRESSING-TABLE-LG-F
	EQUAL? PRSA,V?SEARCH-FOR /?L3
	EQUAL? PRSA,V?SEARCH,V?CLOSE,V?OPEN \?L1
?L3:	CALL NOTHING-SPECIAL >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?LOOK-ON,V?LOOK-INSIDE,V?EXAMINE \FALSE
	EQUAL? HERE,WENDISH-ROOM \?L5
	CALL WENDISH-STUFF-D
	RTRUE
?L5:	EQUAL? HERE,TAMARA-ROOM \?L7
	CALL DRESSING-TABLE-TAM
	CRLF
	RTRUE
?L7:	CALL NOTHING-SPECIAL >STACK
	RSTACK

	.FUNCT MIRROR-GLOBAL-F
	CALL REMOTE-VERB? >STACK
	ZERO? STACK \FALSE
	FSET? HERE,WORNBIT /?L3
	CALL NOT-HERE,MIRROR-GLOBAL >STACK
	RSTACK
?L3:	EQUAL? PRSA,V?MOVE /?L5
	EQUAL? PRSA,V?LOOK-INSIDE,V?FIX,V?EXAMINE \?L4
?L5:	CALL DRESSING-MIRROR-F >STACK
	RSTACK
?L4:	CALL RANDOM-PSEUDO >STACK
	RSTACK

	.FUNCT OPEN-DOOR?,DR,NOSP=0
	FSET? DR,OPENBIT \FALSE
	ZERO? NOSP \?L3
	PRINTC 32
?L3:	CALL THIS-IS-IT,DR
	CALL DOOR-ROOM,HERE,DR >NOSP
	ZERO? NOSP /?L8
	FSET NOSP,SEENBIT
?L8:	PRINTI "And there's a wide-open "
	PRINTD DR
	PRINTI "!"
	RTRUE

	.FUNCT YOUR-ROOM-F,RARG=0
	EQUAL? RARG,M-BEG \?L1
	EQUAL? PRSA,V?WALK-TO \?L3
	EQUAL? PRSO,BED \?L3
	CALL PERFORM,V?LIE,BED
	RTRUE
?L3:	CALL SECRET-CHECK,RARG >STACK
	RSTACK
?L1:	EQUAL? RARG,P?WEST,P?OUT /?L7
	EQUAL? RARG,P?EAST,P?IN \?L6
?L7:	ZERO? NOW-WEARING \?L8
	PRINTI "Before you even take a step, you"
	PRINT REMEMBER-NOT-DRESSED
	PRINTI "."
	CRLF
	CALL PRINT-ID,STR?205
	RETURN 2
?L8:	EQUAL? RARG,P?EAST,P?IN \FALSE
	CALL ENTER-PASSAGE
	RTRUE
?L6:	EQUAL? RARG,M-ENTER \?L16
	CALL QUEUE,I-TOUR,0 >STACK
	RSTACK
?L16:	EQUAL? RARG,M-LOOK \FALSE
	CALL START-SENTENCE,YOUR-ROOM
	PRINTI " is decorated in shades of "
	CALL PRINT-COLOR
	PRINTI ". You see "
	PRINTD YOUR-BATHROOM
	PRINTI " to the north and a cozy "
	PRINTD FIREPLACE
	PRINTI " in one corner. The room is furnished with a bed, a "
	PRINTD NIGHTSTAND
	PRINTI " with a lamp on it, a "
	PRINTD CHEST-OF-DRAWERS
	PRINTI ", a "
	PRINTD WARDROBE
	PRINTI ", a "
	PRINTD YOUR-CHAIR
	PRINTI ", and a "
	PRINTD DRESSING-TABLE
	PRINTI " with mirror and bench. There's also a full-length "
	PRINTD YOUR-MIRROR
	PRINTI "."
	CALL OPEN-DOOR?,SECRET-YOUR-DOOR
	CRLF
	CALL DESCRIBE-CONTENTS,BED
	CALL DESCRIBE-CONTENTS,YOUR-CHAIR
	FSET? HERE,TOUCHBIT /TRUE
	LOC BUTLER >STACK
	EQUAL? STACK,GALLERY,YOUR-ROOM /TRUE
	CALL QUEUED?,I-DINNER >STACK
	GRTR? 2,STACK /TRUE
	CALL IN-MOTION?,FRIEND >STACK
	ZERO? STACK \TRUE
	PUTP FRIEND,P?LINE,0
	SET 'QCONTEXT,FRIEND
	CALL HE-SHE-IT,FRIEND,1
	IN? FRIEND,HERE /?L26
	MOVE FRIEND,HERE
	PRINTI " enters and"
?L26:	PRINTI " says, ""Let's chat a bit"
	CALL FIND-FLAG-HERE,PERSONBIT,PLAYER,FRIEND >STACK
	ZERO? STACK \?L33
	PRINTI ", now that we're alone"
?L33:	PRINTR "."""

	.FUNCT ENTER-PASSAGE
	PRINTI "You step down into a narrow "
	PRINTD PASSAGE
	PRINTR "."

	.FUNCT BED-F
	EQUAL? PRSA,V?THROUGH,V?BOARD \?L1
	CALL PERFORM,V?LIE,PRSO
	RTRUE
?L1:	EQUAL? PRSA,V?CLIMB-ON \FALSE
	CALL PERFORM,V?SIT,PRSO
	RTRUE

	.FUNCT NIGHTSTAND-F
	EQUAL? PRSA,V?LOOK-ON,V?EXAMINE \FALSE
	CALL TELL-AS-WELL-AS,NIGHTSTAND,0,NIGHTLAMP
	RTRUE

	.FUNCT TELL-AS-WELL-AS,CONT,STR,OBJ=0,X=0
	FSET? CONT,SURFACEBIT \?L1
	PRINTC 79
	JUMP ?L5
?L1:	FSET CONT,OPENBIT
	PRINTC 73
?L5:	PRINTC 110
	CALL PRINTT,CONT
	PRINTI " you see"
	CALL FIND-FLAG-NOT,CONT,NDESCBIT >STACK
	ZERO? STACK /?L10
	SET 'X,1
	JUMP ?L12
?L10:	PRINTI " only"
?L12:	ZERO? OBJ /?L15
	CALL PRINTT,OBJ
	JUMP ?L19
?L15:	PRINT STR
?L19:	ZERO? X /?L22
	PRINTI ", as well as"
	CALL PRINT-CONTENTS,CONT
?L22:	PRINTR "."

	.FUNCT DRESSING-MIRROR-F
	EQUAL? PRSA,V?TURN,V?RUB,V?PUSH /?L3
	EQUAL? PRSA,V?MOVE-DIR,V?MOVE,V?FIX \?L1
?L3:	PRINTI "Now you can see "
	PRINTD PLAYER
	PRINTR " perfectly."
?L1:	EQUAL? PRSA,V?LOOK-INSIDE,V?EXAMINE \FALSE
	PRINTI "You look "
	ZERO? WASHED /?L9
	PRINTI "smashing"
	JUMP ?L13
?L9:	PRINTI "a trifle dirty"
?L13:	PRINTI " in your "
	ZERO? NOW-WEARING \?L18
	PRINTI "birthday suit"
	JUMP ?L22
?L18:	PRINTD NOW-WEARING
?L22:	PRINTR "."

	.FUNCT YOUR-MIRROR-F
	EQUAL? PRSA,V?SEARCH,V?RUB,V?LOOK-BEHIND /?L3
	EQUAL? PRSA,V?EXAMINE /?L3
	EQUAL? PRSA,V?SEARCH-FOR \?L1
	EQUAL? PRSO,YOUR-MIRROR \?L1
?L3:	IN? PLAYER,HERE /?L4
	CALL TOO-BAD-SIT-HIDE
?L4:	PRINTI "By running your fingers around the frame, you discover"
	CALL PRINTT,YOUR-SWITCH
	CALL THIS-IS-IT,YOUR-SWITCH
	PRINTR "."
?L1:	EQUAL? PRSA,V?CLOSE,V?OPEN \?L11
	FSET? SECRET-YOUR-DOOR,TOUCHBIT \?L11
	CALL PERFORM,PRSA,SECRET-YOUR-DOOR
	RTRUE
?L11:	EQUAL? PRSA,V?TURN,V?TAKE,V?RUB /?L13
	EQUAL? PRSA,V?PUSH /?L13
	EQUAL? PRSA,V?MOVE-DIR,V?MOVE,V?FIX \?L12
?L13:	PRINTR "It seems to be fastened to the wall."
?L12:	CALL DRESSING-MIRROR-F >STACK
	RSTACK

	.FUNCT YOUR-SWITCH-F
	EQUAL? PRSA,V?EXAMINE \?L1
	PRINTR "You can't tell by looking what it might do."
?L1:	EQUAL? PRSA,V?OPEN \?L5
	FCLEAR YOUR-SWITCH,SECRETBIT
	CALL OKAY,SECRET-YOUR-DOOR,STR?84
	RTRUE
?L5:	EQUAL? PRSA,V?CLOSE \?L6
	FCLEAR YOUR-SWITCH,SECRETBIT
	CALL OKAY,SECRET-YOUR-DOOR,STR?79
	RTRUE
?L6:	EQUAL? PRSA,V?TURN,V?SLAP,V?RUB /?L8
	EQUAL? PRSA,V?PUSH,V?MOVE-DIR /?L8
	EQUAL? PRSA,V?MOVE,V?LAMP-ON,V?LAMP-OFF \FALSE
?L8:	CALL OPEN-SECRET,0,YOUR-SWITCH,SECRET-YOUR-DOOR
	RTRUE

	.FUNCT YOUR-BATHROOM-F,RARG=0
	EQUAL? RARG,M-BEG \?L1
	EQUAL? PRSA,V?WALK-TO \FALSE
	EQUAL? PRSO,YOUR-BATHROOM \FALSE
	PRINT AHHH
	RTRUE
?L1:	EQUAL? RARG,M-LOOK \?L8
	PRINTI "From the look of it, "
	PRINTD YOUR-BATHROOM
	PRINTR " was added in recently. It is comfortable and inviting, especially for Cornwall."
?L8:	EQUAL? RARG,M-EXIT \?L11
	ZERO? NOW-WEARING \FALSE
	CALL FIND-FLAG,YOUR-ROOM,PERSONBIT >RARG
	ZERO? RARG /FALSE
	PRINTI "You peek in and see "
	PRINTD RARG
	PRINTI ", then"
	PRINT REMEMBER-NOT-DRESSED
	PRINTI "."
	CRLF
	RETURN 2
?L11:	ZERO? RARG \FALSE
	EQUAL? PRSA,V?UNLOCK /?L21
	EQUAL? PRSA,V?LOCK,V?CLOSE,V?OPEN \FALSE
?L21:	CALL PERFORM,PRSA,YOUR-BATHROOM-DOOR
	RTRUE

	.FUNCT TOILET-PSEUDO
	EQUAL? PRSA,V?LOOK-INSIDE \?L1
	CALL NOTHING-SPECIAL
	RTRUE
?L1:	EQUAL? PRSA,V?USE,V?SIT \FALSE
	PRINT AHHH
	RTRUE

	.FUNCT BATH-PSEUDO
	EQUAL? PRSA,V?LAMP-ON,V?FILL,V?CLOSE \?L1
	EQUAL? WINNER,PLAYER \TRUE
	PRINTR "Okay, then what?"
?L1:	EQUAL? PRSA,V?THROUGH /?L9
	EQUAL? PRSA,V?TAKE,V?SWIM,V?BOARD \?L8
?L9:	ZERO? NOW-WEARING \?L10
	FIRST? PLAYER >STACK \?L12
	PRINTI "First you drop everything...
"
	CALL ROB,PLAYER,HERE
?L12:	GET P-ITBL,P-VERBN >STACK
	PUT STACK,0,W?BATHE
	CALL V-WAIT,9,0,1
	SET 'WASHED,1
	PRINTI "You're now squeaky clean. After toweling off, you feel nicely relaxed and ready to tackle the mystery of "
	PRINTD CASTLE
	PRINTR "."
?L10:	PRINTI "You almost step into the tub before you realize that your "
	PRINTD NOW-WEARING
	PRINTR " would get wet."
?L8:	CALL RANDOM-PSEUDO >STACK
	RSTACK

	.FUNCT IRIS-ROOM-F,RARG=0
	EQUAL? RARG,M-BEG,M-EXIT \?L1
	EQUAL? PRSA,V?CLOSE,V?OPEN \?L3
	EQUAL? PRSO,SECRET-IRIS-DOOR \?L3
	CALL YOU-CANT,0,PLAYER,STR?196
	RTRUE
?L3:	CALL SECRET-CHECK,RARG >STACK
	RSTACK
?L1:	EQUAL? RARG,P?EAST,P?IN \?L6
	CALL ENTER-PASSAGE
	RTRUE
?L6:	EQUAL? RARG,M-LOOK \FALSE
	PRINTD IRIS-ROOM
	PRINTI " is furnished much like yours, but with a canopied bed and "
	PRINTD IRIS-CHAIR
	PRINTI "."
	CALL OPEN-DOOR?,SECRET-IRIS-DOOR
	CRLF
	RTRUE

	.FUNCT WENDISH-ROOM-F,RARG=0
	EQUAL? RARG,M-BEG,M-EXIT \?L1
	CALL SECRET-CHECK,RARG >STACK
	RSTACK
?L1:	EQUAL? RARG,P?NORTH,P?IN \?L5
	CALL ENTER-PASSAGE
	RTRUE
?L5:	EQUAL? RARG,M-LOOK \FALSE
	PRINTI "The room shows the doctor's precise, scientific personality.[RWD_ID: castle:2445, VAL: 1] Everything is in its place. "
	CALL WENDISH-STUFF-D
	PRINTI "His "
	PRINTD WENDISH-KIT
	PRINTI " is on a marble-topped console attached to the wall. On the north wall is"
	CALL PRINTT,CANDLE
	PRINTC 46
	CALL OPEN-DOOR?,SECRET-WENDISH-DOOR
	CRLF
	RTRUE

	.FUNCT CANDLE-F
	EQUAL? PRSA,V?EXAMINE \?L1
	PRINTR "It seems to be fastened loosely to the wall."
?L1:	EQUAL? PRSA,V?TURN,V?PUSH,V?MOVE-DIR /?L6
	EQUAL? PRSA,V?MOVE,V?LOOK-UNDER,V?LOOK-BEHIND /?L6
	EQUAL? PRSA,V?TAKE \FALSE
	EQUAL? P-PRSA-WORD,W?RAISE,W?LIFT \FALSE
?L6:	CALL OPEN-SECRET,STR?206,CANDLE,SECRET-WENDISH-DOOR >STACK
	RSTACK

	.FUNCT WENDISH-STUFF-D,X
	PRINTI "Several "
	PRINTD WENDISH-STUFF
	PRINTI "s are lying on the "
	PRINTD DRESSING-TABLE-LG
	PRINTR "."

	.FUNCT WENDISH-STUFF-F
	EQUAL? PRSA,V?READ /?L3
	EQUAL? PRSA,V?OPEN,V?LOOK-INSIDE,V?EXAMINE \?L1
?L3:	PRINTR "They are too technical to understand."
?L1:	CALL RANDOM-PSEUDO >STACK
	RSTACK

	.FUNCT WENDISH-KIT-F,X
	EQUAL? PRSA,V?SEARCH-FOR,V?SEARCH /?L3
	EQUAL? PRSA,V?OPEN,V?LOOK-INSIDE,V?EXAMINE \?L1
?L3:	CALL SEARCH-KIT-BOX,WENDISH-KIT,STR?207
	RTRUE
?L1:	EQUAL? PRSA,V?TAKE \FALSE
	EQUAL? PRSO,WENDISH-KIT \FALSE
	CALL PRINT-ID,STR?208
	CALL YOU-SHOULDNT >STACK
	RSTACK

	.FUNCT SEARCH-KIT-BOX,OBJ,STR,X=0
	FSET OBJ,OPENBIT
	IN? LENS-BOX,OBJ \?L1
	SET 'X,LENS-BOX
	JUMP ?L5
?L1:	IN? VIVIEN-DIARY,OBJ \?L3
	SET 'X,VIVIEN-DIARY
	JUMP ?L5
?L3:	IN? COSTUME,OBJ \?L4
	SET 'X,COSTUME
	JUMP ?L5
?L4:	IN? BLOWGUN,OBJ \?L5
	SET 'X,BLOWGUN
?L5:	ZERO? X /?L7
	CALL DISCOVER,X
	EQUAL? PRSA,V?SEARCH-FOR,V?SEARCH /TRUE
	PRINTC 89
	PRINT OU-STOP-SEARCHING
	PRINTR "."
?L7:	CALL TELL-AS-WELL-AS,OBJ,STR
	RTRUE

	.FUNCT VIVIEN-ROOM-F,RARG=0
	EQUAL? RARG,M-BEG,M-EXIT \?L1
	CALL SECRET-CHECK,RARG >STACK
	RSTACK
?L1:	EQUAL? RARG,P?SOUTH,P?IN \?L3
	CALL ENTER-PASSAGE
	RTRUE
?L3:	EQUAL? RARG,M-LOOK \FALSE
	PRINTI "The room is untidy, probably because Vivien is an artist. Sketches and garments are strewn on the canopied bed and "
	PRINTD VIVIEN-CHAIR
	PRINTI ". Leaning against the wall are stretched canvases, and a fold-up easel for her outdoor art work. On the tallboy are a sketch pad, and a paint-smeared "
	PRINTD VIVIEN-BOX
	PRINTI ". On the south wall is a cheval glass and"
	CALL PRINTT,FIGURINE
	PRINTI "."
	CALL OPEN-DOOR?,SECRET-VIVIEN-DOOR
	CRLF
	CALL DESCRIBE-CONTENTS,VIVIEN-CHAIR
	RTRUE

	.FUNCT VIVIEN-BOX-F,X
	EQUAL? PRSA,V?SEARCH-FOR,V?SEARCH /?L3
	EQUAL? PRSA,V?OPEN,V?LOOK-INSIDE,V?EXAMINE \?L1
?L3:	CALL PRINT-ID,STR?209
	CALL SEARCH-KIT-BOX,VIVIEN-BOX,STR?210
	RTRUE
?L1:	EQUAL? PRSA,V?TAKE \FALSE
	EQUAL? PRSO,VIVIEN-BOX \FALSE
	CALL PRINT-ID,STR?211
	CALL YOU-SHOULDNT >STACK
	RSTACK

	.FUNCT FIGURINE-F
	EQUAL? PRSA,V?EXAMINE \?L1
	PRINTR "It's turned toward the wall, so you can't see its face."
?L1:	EQUAL? PRSA,V?TURN /?L6
	EQUAL? PRSA,V?PUSH,V?MOVE-DIR,V?MOVE \FALSE
?L6:	CALL OPEN-SECRET,STR?173,FIGURINE,SECRET-VIVIEN-DOOR >STACK
	RSTACK

	.FUNCT IAN-ROOM-F,RARG=0
	EQUAL? RARG,M-BEG,M-EXIT \?L1
	CALL SECRET-CHECK,RARG >STACK
	RSTACK
?L1:	EQUAL? RARG,P?NORTH,P?IN \?L3
	CALL ENTER-PASSAGE
	RTRUE
?L3:	EQUAL? RARG,M-LOOK \FALSE
	PRINTD IAN-ROOM
	PRINTI " has rich wood panelling, a four-poster bed, Victorian washstand, and "
	PRINTD IAN-CHAIR
	PRINTI ". "
	CALL TELL-IAN-FIREPLACE
	CRLF
	CALL OPEN-DOOR?,SECRET-IAN-DOOR,1 >STACK
	ZERO? STACK /TRUE
	CRLF
	RTRUE

	.FUNCT TELL-IAN-FIREPLACE
	PRINTI "In the "
	PRINTD FIREPLACE
	PRINTI ", the fender has flashy grillwork, and the "
	PRINTD ANDIRON
	PRINTI "s have fancy carved heads."
	RTRUE

	.FUNCT ANDIRON-F
	EQUAL? PRSA,V?EXAMINE \?L1
	PRINTR "By looking closely, you find that the head can turn."
?L1:	EQUAL? PRSA,V?TURN,V?RUB /?L6
	EQUAL? PRSA,V?PUSH,V?MOVE-DIR,V?MOVE \FALSE
?L6:	CALL OPEN-SECRET,STR?173,ANDIRON,SECRET-IAN-DOOR >STACK
	RSTACK

	.FUNCT HYDE-ROOM-F,RARG=0
	EQUAL? RARG,M-BEG,M-EXIT \?L1
	EQUAL? PRSA,V?CLOSE,V?OPEN \?L3
	EQUAL? PRSO,SECRET-HYDE-DOOR \?L3
	CALL YOU-CANT,0,PLAYER,STR?196
	RTRUE
?L3:	CALL SECRET-CHECK,RARG >STACK
	RSTACK
?L1:	EQUAL? RARG,P?NORTH,P?IN \?L6
	CALL ENTER-PASSAGE
	RTRUE
?L6:	EQUAL? RARG,M-LOOK \FALSE
	PRINTD HYDE-ROOM
	PRINTI " has many tasteful antiques, such as "
	CALL PRINTA,HYDE-CHAIR
	PRINTI " in one corner."
	CALL OPEN-DOOR?,SECRET-HYDE-DOOR
	CRLF
	RTRUE

	.FUNCT TELL-IN-BROCHURE
	PRINTI "[This is described in the "
	PRINTD BROCHURE
	PRINTR ".]"

	.FUNCT BROCHURE-PSEUDO
	EQUAL? PRSA,V?EXAMINE \?L1
	CALL TELL-IN-BROCHURE >STACK
	RSTACK
?L1:	CALL RANDOM-PSEUDO >STACK
	RSTACK

	.FUNCT MEMENTO-F
	EQUAL? PRSA,V?TAKE \?L1
	PRINTR "But that would spoil the display!"
?L1:	CALL BROCHURE-PSEUDO >STACK
	RSTACK

	.FUNCT OLD-GREAT-HALL-F,RARG=0
	EQUAL? RARG,M-LOOK \?L1
	PRINTR "Your footfalls echo across the ancient stone floor."
?L1:	EQUAL? RARG,P?WEST,P?UP \?L5
	PRINT STAIRS-UP-RIGHT
	RTRUE
?L5:	ZERO? RARG \FALSE
	CALL NOUN-USED?,W?DOOR >STACK
	ZERO? STACK /FALSE
	EQUAL? PRSA,V?UNLOCK \?L10
	EQUAL? HERE,OLD-GREAT-HALL \?L10
	CALL OKAY,PRSO,STR?86 >STACK
	RSTACK
?L10:	EQUAL? PRSA,V?EXAMINE \FALSE
	CALL CHECK-DOOR,PRSO >STACK
	RSTACK

	.FUNCT JUNCTION-F,RARG=0
	EQUAL? RARG,M-LOOK \?L1
	PRINTI "The two halves of "
	PRINTD CASTLE
	PRINTR " meet here, as the past meets the present."
?L1:	EQUAL? RARG,P?NORTH,P?DOWN \FALSE
	PRINT STAIRS-DOWN-LEFT
	RTRUE

	.FUNCT BASEMENT-ENTER
	ZERO? BRICKS-DOWN /?L1
	RETURN CRYPT
?L1:	RETURN DUNGEON

	.FUNCT BASEMENT-F,RARG=0
	EQUAL? RARG,M-LOOK \?L1
	PRINTI "The "
	PRINTD BASEMENT
	PRINTI " of the tower keep still holds traces of the medieval past -- such as an "
	PRINTD WELL
	PRINTI ". The "
	PRINTD BASEMENT
	PRINTI " now stores both Lionel's expedition gear and the castle wine cellar"
	EQUAL? VARIATION,PAINTER-C \?L5
	PRINTI " (a rack full of wine bottles)"
?L5:	PRINTI ".
The brick walls are damp and mossy"
	EQUAL? VARIATION,FRIEND-C \?L12
	FSET? CLUE-4,TOUCHBIT \?L12
	PRINTI ", and some bricks look loose"
?L12:	PRINTR ". A stairway lies north, and doors lead east and west."
?L1:	EQUAL? RARG,P?NORTH,P?UP \FALSE
	PRINT STAIRS-UP-RIGHT
	RTRUE

	.FUNCT WINE-RACK-F,X
	FCLEAR WINE-RACK,NDESCBIT
	EQUAL? PRSA,V?TAKE \?L1
	IN? BOTTLE,WINE-RACK \FALSE
	CALL NOUN-USED?,W?WINE >STACK
	ZERO? STACK /FALSE
	CALL PERFORM,PRSA,BOTTLE
	RTRUE
?L1:	EQUAL? PRSA,V?LOOK-INSIDE,V?EXAMINE \FALSE
	CALL TELL-AS-WELL-AS,WINE-RACK,STR?212
	RTRUE

	.FUNCT BOTTLE-F
	EQUAL? PRSA,V?SEARCH-FOR,V?SEARCH /?L3
	EQUAL? PRSA,V?READ,V?LOOK-INSIDE,V?EXAMINE \?L1
?L3:	CALL NOT-HOLDING?,BOTTLE >STACK
	ZERO? STACK \TRUE
	PRINTI "The label says it's wine from a Cornish winery called Our Own Vintage."
	EQUAL? VARIATION,PAINTER-C \?L9
	PRINTI " Someone has drawn a star in red ink over the word ""OUR."""
?L9:	CRLF
	RTRUE
?L1:	EQUAL? PRSA,V?SHAKE,V?OPEN,V?MUNG /?L15
	EQUAL? PRSA,V?EMPTY,V?EAT,V?DRINK \?L14
?L15:	EQUAL? PRSO,BOTTLE \FALSE
	PRINTR "You instantly realize that you don't need any wine -- or any more, as the case may be."
?L14:	EQUAL? PRSA,V?FILL /?L22
	EQUAL? PRSA,V?PUT-IN \?L21
	EQUAL? PRSI,BOTTLE \?L21
?L22:	CALL TOO-BAD-BUT,BOTTLE,STR?79 >STACK
	RSTACK
?L21:	CALL ATTACK-VERB? >STACK
	ZERO? STACK /FALSE
	CALL PRINT-ID,STR?213
	CALL NO-VIOLENCE?,BOTTLE
	RTRUE

	.FUNCT BRICKS-D,X
	PRINTI "There's a "
	PRINTD BRICKS
	ZERO? BRICKS-DOWN /?L3
	PRINTC 32
	CALL GROUND-DESC >STACK
	PRINT STACK
	PRINTI ", and a hole"
?L3:	PRINTR " in the wall."

	.FUNCT BRICKS-F
	EQUAL? PRSA,V?SEARCH /?L3
	EQUAL? PRSA,V?RUB,V?KNOCK,V?EXAMINE \?L1
?L3:	FCLEAR BRICKS,NDESCBIT
	FSET BRICKS,SEENBIT
	CALL BRICKS-D >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?TURN,V?TAKE,V?SLAP /?L7
	EQUAL? PRSA,V?PUSH,V?OPEN /?L7
	EQUAL? PRSA,V?MUNG,V?MOVE-DIR,V?MOVE \FALSE
?L7:	EQUAL? VARIATION,FRIEND-C \FALSE
	ZERO? BRICKS-DOWN \FALSE
	FCLEAR BRICKS,NDESCBIT
	SET 'BRICKS-DOWN,1
	FCLEAR HOLE-IN-WALL,INVISIBLE
	PRINTI "You manage to pull them down into a pile "
	CALL GROUND-DESC >STACK
	PRINT STACK
	PRINTI ", making a large hole in the wall."
	CRLF
	CALL PRINT-ID,STR?214 >STACK
	RSTACK

	.FUNCT HOLE-IN-WALL-F,RM
	EQUAL? PRSA,V?CLOSE \?L1
	CALL YOU-CANT >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?LOOK-THROUGH,V?LOOK-INSIDE,V?EXAMINE \?L3
	EQUAL? HERE,BASEMENT \?L4
	PRINTR "Through the dusty air, you can see only dark inside. But the hole looks big enough to climb through."
?L4:	CALL ROOM-PEEK,BASEMENT,1
	RTRUE
?L3:	EQUAL? PRSA,V?THROUGH,V?DISEMBARK,V?BOARD \FALSE
	EQUAL? HERE,BASEMENT \?L10
	SET 'RM,CRYPT
	JUMP ?L12
?L10:	SET 'RM,BASEMENT
?L12:	CALL GOTO,RM >STACK
	ZERO? STACK /TRUE
	CALL OKAY
	RTRUE

	.FUNCT WELL-F
	EQUAL? PRSA,V?SEARCH-FOR,V?SEARCH /?L3
	EQUAL? PRSA,V?LOOK-INSIDE,V?LOOK-DOWN,V?EXAMINE \?L1
?L3:	PRINTR "It's deep and dark."
?L1:	EQUAL? PRSA,V?CLOSE,V?OPEN \?L8
	CALL YOU-CANT >STACK
	RSTACK
?L8:	EQUAL? PRSA,V?THROUGH,V?CLIMB-DOWN,V?BOARD \?L9
	PRINTI "After a moment's thought, you remember "
	PRINTD LOVER
	PRINTI "'s fate and decide that's much too dangerous."
	CRLF
	CALL PRINT-ID,STR?215 >STACK
	RSTACK
?L9:	EQUAL? PRSA,V?PUT-IN,V?PUT \FALSE
	EQUAL? PRSI,WELL \FALSE
	PRINTI "As you watch,"
	CALL PRINTT,PRSO
	PRINTI " disappears into the dark well shaft. After a second or two, you hear a remote splash.
"
	CALL PRINT-ID,STR?216
	CALL REMOVE-CAREFULLY,PRSO
	RTRUE

	.FUNCT CRYPT-F,RARG=0
	EQUAL? RARG,M-LOOK \FALSE
	PRINTI "This space at the bottom of the tower is so gloomy and musty that you should be glad there's an exit to the "
	PRINTD BASEMENT
	PRINTR "."

	.FUNCT SKELETON-F
	EQUAL? PRSA,V?SEARCH-FOR /?L3
	EQUAL? PRSA,V?SEARCH,V?LOOK-UNDER,V?EXAMINE \FALSE
?L3:	IN? NECKLACE,SKELETON \?L4
	FSET? NECKLACE,SECRETBIT \?L4
	EQUAL? PRSA,V?SEARCH-FOR,V?SEARCH,V?EXAMINE \?L4
	CALL DISCOVER,NECKLACE,SKELETON
	RTRUE
?L4:	PRINTR "Just old bones moldering in the dark."

	.FUNCT DUNGEON-F,ARG=0
	EQUAL? ARG,M-LOOK \FALSE
	PRINTI "In the northwest corner is an ancient door called a """
	PRINTD PRIEST-DOOR
	PRINTI "."" Another exit is east to the "
	PRINTD BASEMENT
	PRINTR "."

	.FUNCT IRON-MAIDEN-F,X
	EQUAL? PRSA,V?OPEN,V?CLOSE \?L1
	PRINTR "It has no door!"
?L1:	EQUAL? PRSA,V?LOOK-INSIDE,V?EXAMINE \?L5
	PRINTR "The inner surface of this medieval torture device is covered with spikes. The space is just big enough to hold an unfortunate victim."
?L5:	EQUAL? PRSA,V?PUT-IN \?L8
	CALL WONT-HELP >STACK
	RSTACK
?L8:	EQUAL? PRSA,V?RUB,V?KISS \?L9
	PRINTI "Ouch!"
	CRLF
	CALL PRINT-ID,STR?217 >STACK
	RSTACK
?L9:	EQUAL? PRSA,V?THROUGH,V?CLIMB-ON,V?BOARD \FALSE
	EQUAL? WINNER,PLAYER /?L13
	PRINTI """No thank you!"""
	CRLF
	CALL PRINT-ID,STR?218
	RTRUE
?L13:	PRINTI "As you step on the bottom of the "
	PRINTD IRON-MAIDEN
	PRINTI ", it "
	EQUAL? HERE,DUNGEON \?L20
	SET 'X,TOMB
	PRINTI "sinks downward into"
	JUMP ?L24
?L20:	SET 'X,DUNGEON
	PRINTI "rises again to"
?L24:	CALL PRINTT,X
	PRINTI ". You step out again.
"
	MOVE IRON-MAIDEN,X
	CALL GOTO,X
	RTRUE

	.FUNCT COFFIN-F
	EQUAL? PRSA,V?SIT,V?LIE,V?BOARD \?L1
	FSET? COFFIN,OPENBIT /FALSE
	CALL FIRST-YOU,STR?84,COFFIN
	RFALSE
?L1:	EQUAL? PRSA,V?CLOSE \?L6
	IN? PLAYER,COFFIN \FALSE
	PRINTI "The air is stifling, so you open it again."
	CRLF
	CALL PRINT-ID,STR?219 >STACK
	RSTACK
?L6:	EQUAL? PRSA,V?SEARCH-FOR /?L13
	EQUAL? PRSA,V?SEARCH,V?LOOK-INSIDE,V?EXAMINE \FALSE
?L13:	IN? CLUE-4,COFFIN \?L14
	FSET? CLUE-4,SECRETBIT \?L14
	FSET? COFFIN,OPENBIT /?L16
	CALL FIRST-YOU,STR?84,COFFIN
?L16:	CALL DISCOVER,CLUE-4,COFFIN
	RTRUE
?L14:	IN? PLAYER,COFFIN \FALSE
	PRINTI "All you can see is "
	PRINTD PLAYER
	PRINTR "."

	.FUNCT LOVER-PATH-LOSE-N
	CALL LOVER-PATH-LOSE,P?NORTH
	RFALSE

	.FUNCT LOVER-PATH-LOSE,X
	CALL HE-SHE-IT,WINNER,1,STR?220
	PRINTI " to follow the path, but it's too tricky in the dim light"
	PRINTI ", so"
	CALL HE-SHE-IT,WINNER,0,STR?173
	PRINTR " back."

	.FUNCT LOVER-PATH-F,RARG=0
	EQUAL? RARG,M-LOOK \?L1
	PRINTI "This is an area behind shrubbery by a steep cliff overlooking the sea. In the dim light, you can barely see a path leading north along the cliff. "
	CALL LEVER-AND-DOOR,PRIEST-DOOR,P?OUT
	RTRUE
?L1:	ZERO? RARG \FALSE
	EQUAL? PRSA,V?FOLLOW \FALSE
	CALL DO-WALK,P?NORTH
	RTRUE

	.FUNCT CORR-2-F,RARG=0
	EQUAL? RARG,M-LOOK \?L1
	PRINTI "The "
	PRINTD CORR-2
	PRINTI " is lined with doors. To the west, a heavy oak door with ancient wrought-iron fittings b"
	FSET? CREST,NDESCBIT \?L5
	PRINTI "ears"
	JUMP ?L9
?L5:	PRINTI "ore"
?L9:	PRINTI " a bronze bas-relief of the "
	PRINT TRESYLLIAN
	PRINTC 32
	PRINTD CREST
	PRINTI ", marking this as the "
	PRINTD JACK-ROOM
	PRINTR " of the castle. Other doors lead to the northwest, east, northeast, and southeast. Stairways go up at the south end and down at the north end."
?L1:	EQUAL? RARG,P?NORTH,P?DOWN,P?OUT \?L14
	PRINT STAIRS-DOWN-LEFT
	RTRUE
?L14:	EQUAL? RARG,P?SOUTH,P?UP \FALSE
	PRINT STAIRS-UP-RIGHT
	RTRUE

	.FUNCT CREST-F
	EQUAL? PRSA,V?SEARCH,V?READ,V?EXAMINE \?L1
	PRINTI "The "
	PRINTD CREST
	PRINTI " features a wyvern with wings raised."
	EQUAL? VARIATION,LORD-C \?L5
	PRINTI " It seems to be loosely mounted on the door."
?L5:	CRLF
	RTRUE
?L1:	EQUAL? VARIATION,LORD-C \FALSE
	EQUAL? PRSA,V?TAKE-OFF,V?TAKE,V?REMOVE /?L13
	EQUAL? PRSA,V?MOVE-DIR /?L13
	EQUAL? PRSA,V?MOVE,V?LOOK-UNDER,V?LOOK-BEHIND \?L11
?L13:	IN? JACK-TAPE,HERE /?L11
	MOVE JACK-TAPE,HERE
	FSET CREST,TAKEBIT
	FCLEAR CREST,NDESCBIT
	PRINTI "By removing the "
	PRINTD CREST
	PRINTI " from its place, you can see that a small "
	PRINTD JACK-TAPE
	PRINTR " is built into the door."
?L11:	EQUAL? PRSA,V?PUT \FALSE
	EQUAL? PRSI,JACK-TAPE,JACK-ROOM \FALSE
	IN? JACK-TAPE,HERE \FALSE
	MOVE JACK-TAPE,LOCAL-GLOBALS
	FSET CREST,NDESCBIT
	PRINTI "The "
	PRINTD CREST
	PRINTI " fits neatly over the "
	PRINTD JACK-TAPE
	PRINTR "."

	.FUNCT TV-PSEUDO
	EQUAL? PRSA,V?LOOK-INSIDE,V?LAMP-ON,V?EXAMINE \?L1
	PRINTR "It's boring compared to this mystery."
?L1:	EQUAL? PRSA,V?LAMP-OFF \FALSE
	CALL ALREADY,PRSO,STR?83 >STACK
	RSTACK

	.FUNCT JACK-ROOM-F,RARG=0
	EQUAL? RARG,M-BEG,M-EXIT \?L1
	CALL SECRET-CHECK,RARG >STACK
	ZERO? STACK \TRUE
	RFALSE
?L1:	EQUAL? RARG,P?SW,P?IN,P?DOWN \?L6
	CALL ENTER-PASSAGE
	RTRUE
?L6:	EQUAL? RARG,M-LOOK \?L7
	PRINTI "The "
	PRINTD JACK-ROOM
	PRINTI " has a canopied four-poster bed on a circular dais, a marble-topped console and mirror, two oversized "
	PRINTD WARDROBE
	PRINTI "s, cheval glass, tallboy, commode, overstuffed chair and color TV."
	CALL OPEN-DOOR?,SECRET-JACK-DOOR
	CRLF
	RTRUE
?L7:	ZERO? RARG \FALSE
	EQUAL? PRSA,V?SEARCH,V?READ,V?EXAMINE \FALSE
	EQUAL? HERE,CORR-2 \FALSE
	FSET? CREST,NDESCBIT \FALSE
	CALL PERFORM,PRSA,CREST,PRSI
	RTRUE

	.FUNCT NOT-FOUND,OBJ,WT=0
	EQUAL? PRSA,V?WALK-TO \?L1
	SET 'WT,1
?L1:	ZERO? WT \?L4
	SET 'CLOCK-WAIT,1
	PRINTI "(Y"
	JUMP ?L8
?L4:	PRINTI "But y"
?L8:	PRINTI "ou haven't found"
	CALL HIM-HER-IT,OBJ
	PRINTI " yet!"
	ZERO? WT \?L13
	PRINTC 41
?L13:	CRLF
	RTRUE

	.FUNCT FREE-VERB?
	CALL GAME-VERB? >STACK
	ZERO? STACK \TRUE
	CALL DIVESTMENT?,PRSO >STACK
	ZERO? STACK \TRUE
	EQUAL? PRSA,V?YES,V?YELL,V?WAIT-UNTIL /TRUE
	EQUAL? PRSA,V?WAIT-FOR,V?SORRY,V?SLAP /TRUE
	EQUAL? PRSA,V?SIT,V?SSHOW,V?SHOW /TRUE
	EQUAL? PRSA,V?SHOOT,V?READ,V?PUSH /TRUE
	EQUAL? PRSA,V?NO,V?LOOK-UP,V?LOOK-THROUGH /TRUE
	EQUAL? PRSA,V?LOOK-OUTSIDE,V?LOOK-ON,V?LOOK-INSIDE /TRUE
	EQUAL? PRSA,V?LOOK-DOWN,V?LOOK,V?LIE /TRUE
	EQUAL? PRSA,V?KILL,V?INVENTORY,V?HELLO /TRUE
	EQUAL? PRSA,V?EXAMINE,V?CHASTISE,V?ATTACK /TRUE
	RFALSE

	.FUNCT SECRET-CHECK,RARG=0,OBJ=0,PER=0,RM,GT,?TMP
	EQUAL? DISCOVERED-HERE,HERE \?L3
	SET '?TMP,CHARACTER-TABLE
	CALL ZMEMQ,HERE,CHAR-ROOM-TABLE >STACK
	DEC 'STACK
	GET ?TMP,STACK >PER
	FSET? PER,MUNGBIT /?L5
	EQUAL? PER,CONFESSED /?L5
	CALL META-LOC,PER >STACK
	EQUAL? STACK,HERE /?L3
?L5:	SET 'PER,0
?L3:	EQUAL? RARG,M-BEG \?L8
	EQUAL? PRSA,V?WALK /FALSE
	EQUAL? PRSA,V?THROUGH,V?FOLLOW,V?WALK-TO \?L10
	SET '?TMP,HERE
	CALL META-LOC,PRSO >STACK
	EQUAL? ?TMP,STACK \FALSE
?L10:	ZERO? PER /FALSE
	GETP PER,P?LINE >STACK
	ZERO? STACK \?L14
	EQUAL? PRSA,V?SEARCH-FOR,V?SEARCH \FALSE
?L14:	EQUAL? PER,PRSO,PRSI /FALSE
	CALL FREE-VERB? >STACK
	ZERO? STACK \FALSE
	CALL START-SENTENCE,PER
	PRINTI " prevents"
	CALL HIM-HER-IT,WINNER,0,1
	PRINTR " action!"
?L8:	EQUAL? RARG,M-EXIT \FALSE
	ZERO? PER /FALSE
	CALL GENERIC-CLOSET,0 >RM
	GETP PER,P?CHARACTER >STACK
	GET GOAL-TABLES,STACK >GT
	EQUAL? PRSA,V?WALK \?L19
	SET 'OBJ,PRSO
	JUMP ?L29
?L19:	EQUAL? PRSA,V?THROUGH,V?FOLLOW,V?WALK-TO \?L29
	CALL META-LOC,PRSO >OBJ
	EQUAL? OBJ,HERE /FALSE
	EQUAL? OBJ,LOCAL-GLOBALS \?L22
	FSET? PRSO,DOORBIT \FALSE
?L22:	EQUAL? PRSA,V?THROUGH \?L25
	EQUAL? OBJ,RM,LOCAL-GLOBALS \?L26
	GET GT,GOAL-F >STACK
	CALL ESTABLISH-GOAL,PER,STACK
	SET 'DISCOVERED-HERE,0
	RFALSE
?L26:	SET 'OBJ,P?OUT
	JUMP ?L29
?L25:	CALL DIR-FROM,HERE,OBJ >OBJ
?L29:	CALL DIR-EQV?,HERE,OBJ,P?OUT >STACK
	ZERO? STACK /?L31
	GETP PER,P?LINE >STACK
	ZERO? STACK /?L31
	CALL HE-SHE-IT,PER,1
	PRINTI " blocks"
	CALL HIM-HER-IT,WINNER,0,1
	PRINTR " exit!"
?L31:	EQUAL? PER,GHOST-NEW \?L36
	MOVE PER,RM
?L36:	GET GT,GOAL-F >STACK
	CALL ESTABLISH-GOAL,PER,STACK
	SET 'DISCOVERED-HERE,0
	RFALSE

	.FUNCT OPEN-SECRET,ACT,OBJ,DR
	PRINTI "As"
	CALL HE-SHE-IT,WINNER,0,ACT
	ZERO? ACT \?L3
	PRINTC 32
	CALL VERB-PRINT
?L3:	GRTR? OBJ,0 \?L8
	LESS? OBJ,256 \?L8
	CALL PRINTT,OBJ
	FCLEAR OBJ,SECRETBIT
	JUMP ?L12
?L8:	PRINT OBJ
?L12:	PRINTC 44
	FSET? DR,TOUCHBIT /?L15
	FSET DR,TOUCHBIT
	CALL QUEUE,I-FOUND-PASSAGES,1
	CALL GENERIC-CLOSET,0 >ACT
	ZERO? ACT /?L19
	PUT FOUND-PASSAGES,PLAYER-C,ACT
	JUMP ?L21
?L19:	PUT FOUND-PASSAGES,PLAYER-C,1
?L21:	FSET PASSAGE,SEENBIT
	EQUAL? OBJ,HISTORY-BOOK \?L22
	FSET HISTORY-BOOK,TAKEBIT
	FCLEAR HISTORY-BOOK,TRYTAKEBIT
	CALL PRINTT,BOOKCASE
	JUMP ?L36
?L22:	PRINTI " a section of the "
	EQUAL? OBJ,WYVERN \?L29
	PRINTD WYVERN
	JUMP ?L36
?L29:	PRINTI "wall"
	JUMP ?L36
?L15:	CALL PRINTT,DR
?L36:	CALL OPEN-CLOSE,DR,0 >STACK
	RSTACK

	.FUNCT TELESCOPE-F
	EQUAL? PRSA,V?LOOK-THROUGH,V?LOOK-INSIDE \?L1
	PRINTR "All you can see is the wall."
?L1:	EQUAL? PRSA,V?TURN,V?TAKE,V?PUSH /?L6
	EQUAL? PRSA,V?MOVE-DIR,V?MOVE,V?AIM \FALSE
?L6:	CALL OPEN-SECRET,STR?221,TELESCOPE,SECRET-JACK-DOOR >STACK
	RSTACK

	.FUNCT LIBRARY-F,RARG=0
	EQUAL? RARG,M-BEG \?L1
	CALL SECRET-CHECK,RARG >STACK
	RSTACK
?L1:	EQUAL? RARG,P?NE,P?IN \?L3
	CALL ENTER-PASSAGE
	RTRUE
?L3:	EQUAL? RARG,M-LOOK \FALSE
	PRINTI "Dusty bookcases tower all around you. There is a table with reading lamp and chair, and an armchair near the "
	PRINTD FIREPLACE
	PRINTI "."
	CALL OPEN-DOOR?,SECRET-LIBRARY-DOOR
	CRLF
	RTRUE

	.FUNCT BOOKS-GLOBAL-F,X
	EQUAL? PRSA,V?TAKE /?L3
	EQUAL? PRSA,V?READ,V?OPEN,V?LOOK-INSIDE \?L1
?L3:	PRINTR "You pick one at random. It's frightfully obscure, so you put it back."
?L1:	EQUAL? PRSA,V?SEARCH-FOR,V?SEARCH,V?EXAMINE \FALSE
	PRINTI "Some of the books date as far back as the 16th century. Although some are fiction, most of the books are scientific, covered with vellum or leather. Some are in foreign languages, and many have pictures of skulls or spirits."
	CRLF
	CALL FIND-FLAG,BOOKCASE,SECRETBIT >X
	ZERO? X /?L9
	CALL DISCOVER,X
	RTRUE
?L9:	FIRST? BOOKCASE >X \?L11
	FSET X,TAKEBIT
	FCLEAR X,NDESCBIT
	CALL START-SENTENCE,X
	PRINTR " catches your eye."
?L11:	IN? JOURNAL,TABLE-LIBRARY \TRUE
	FCLEAR JOURNAL,SECRETBIT
	PRINTI "There are many books of adventure and exploration, as well as the bound volumes of "
	PRINTD COUSIN
	PRINTR "'s expedition journals."

	.FUNCT BOOKCASE-F,X
	EQUAL? PRSA,V?SEARCH,V?LOOK-INSIDE,V?EXAMINE \?L1
	CALL PERFORM,V?EXAMINE,BOOKS-GLOBAL
	RTRUE
?L1:	EQUAL? PRSA,V?TURN /?L4
	EQUAL? PRSA,V?PUSH,V?MOVE-DIR,V?MOVE \FALSE
?L4:	FSET? SECRET-LIBRARY-DOOR,OPENBIT \FALSE
	CALL OPEN-SECRET,STR?222,BOOKCASE,SECRET-LIBRARY-DOOR
	RTRUE

	.FUNCT HISTORY-BOOK-F
	EQUAL? PRSA,V?MOVE-DIR,V?MOVE /?L3
	EQUAL? PRSA,V?PUT-IN \?L1
	EQUAL? PRSI,BOOKCASE \?L1
	MOVE HISTORY-BOOK,BOOKCASE
?L3:	CALL OPEN-SECRET,STR?222,HISTORY-BOOK,SECRET-LIBRARY-DOOR
	RTRUE
?L1:	EQUAL? PRSA,V?TAKE,V?READ /?L5
	EQUAL? PRSA,V?LOOK-UP,V?OPEN,V?EXAMINE \FALSE
?L5:	IN? HISTORY-BOOK,BOOKCASE \?L6
	MOVE HISTORY-BOOK,WINNER
	CALL OPEN-SECRET,STR?222,HISTORY-BOOK,SECRET-LIBRARY-DOOR
	RTRUE
?L6:	EQUAL? PRSA,V?TAKE /FALSE
	CALL NOT-HOLDING?,HISTORY-BOOK >STACK
	ZERO? STACK \TRUE
	PRINTI "This book contains a detailed history of "
	PRINTD CASTLE
	PRINTI " and the "
	PRINT TRESYLLIAN
	PRINTI " family, including the bitter fate of Lady Arabella "
	PRINT TRESYLLIAN
	PRINTI ", who was accused of infidelity and, by her husband's command, was buried alive in the wall of the tower keep. The book also describes the layout of the tower and residential wing, including the various rooms and "
	PRINTD PASSAGE
	PRINTR "s."

	.FUNCT JOURNAL-F
	EQUAL? PRSA,V?READ /?L3
	EQUAL? PRSA,V?OPEN,V?LOOK-INSIDE,V?EXAMINE \FALSE
?L3:	CALL NOT-HOLDING?,PRSO >STACK
	ZERO? STACK \TRUE
	PRINTI "This is a journal of Lionel's "
	EQUAL? VARIATION,LORD-C \?L9
	PRINTI "African"
	JUMP ?L16
?L9:	EQUAL? VARIATION,DOCTOR-C \?L13
	PRINTI "Amazon"
	JUMP ?L16
?L13:	PRINTI "South Pacific"
?L16:	PRINTI " expedition. As you leaf through it, "
	EQUAL? VARIATION,PAINTER-C \?L21
	PRINTR "no clues appear."
?L21:	PRINTI "you find a description of a treasure: "
	EQUAL? VARIATION,LORD-C \?L28
	CALL DESCRIBE-WAR-CLUB
	PRINTR "It also served as his royal sceptre."
?L28:	EQUAL? VARIATION,FRIEND-C \?L32
	PRINTI "a "
	PRINTD NECKLACE
	PRINTR "."
?L32:	PRINTD MOONMIST
	PRINTI ", a drug taken from a rare Amazon plant called the Moonflower. The natives use it to tip their"
	PRINT POISON-DART
	PRINTI "s, but it could also be a valuable medicine.[RWD_ID: tower:1003, VAL: 1] They insist that the plant should be gathered only when the "
	PRINTD MOON
	PRINTI " is misted over."
	CRLF
	IN? MOONMIST,INKWELL \TRUE
	FSET? INKWELL,TOUCHBIT \TRUE
	FCLEAR MOONMIST,SECRETBIT
	RTRUE

	.FUNCT OFFICE-F,ARG=0
	EQUAL? ARG,M-LOOK \FALSE
	PRINTI "This small office gets little light and less air. In one corner is a computer. By the "
	PRINTD FIREPLACE
	PRINTI ", there is a tall "
	PRINTD DESK
	PRINTI " with"
	FIRST? DESK >STACK \?L5
	CALL PRINT-CONTENTS,DESK
	PRINTI ", and"
?L5:	PRINTR " a tall stool."

	.FUNCT INKWELL-F
	IN? MOONMIST,INKWELL \FALSE
	EQUAL? PRSA,V?EMPTY \?L3
	FCLEAR MOONMIST,SECRETBIT
	CALL PERFORM,V?POUR,MOONMIST,PRSI
	RTRUE
?L3:	EQUAL? PRSA,V?SEARCH-FOR,V?SEARCH /?L6
	EQUAL? PRSA,V?OPEN,V?LOOK-INSIDE,V?EXAMINE \FALSE
?L6:	FSET? MOONMIST,SECRETBIT \FALSE
	CALL DISCOVER,MOONMIST
	RTRUE

	.FUNCT COMPUTER-F
	EQUAL? PRSA,V?EXAMINE \?L1
	PRINTR "It looks just like the computer you're using now!"
?L1:	EQUAL? PRSA,V?LAMP-OFF \?L5
	CALL OKAY,COMPUTER,STR?83
	RTRUE
?L5:	EQUAL? PRSA,V?USE,V?PLAY,V?LAMP-ON \FALSE
	CALL HE-SHE-IT,COMPUTER,1
	PRINTI " starts running an interactive mystery from Infocom called """
	EQUAL? VARIATION,LORD-C \?L11
	PRINTI "DEADLINE (R"
	JUMP ?L21
?L11:	EQUAL? VARIATION,PAINTER-C \?L15
	PRINTI "THE WITNESS (R"
	JUMP ?L21
?L15:	EQUAL? VARIATION,FRIEND-C \?L18
	PRINTI "SUSPECT (TM"
	JUMP ?L21
?L18:	PRINTI "BALLYHOO (TM"
?L21:	PRINTI "),"" but you decide that "
	PRINTD MOONMIST
	PRINTR " (TM) is easier, so you turn it off."

	.FUNCT TAMARA-ROOM-F,RARG=0
	EQUAL? RARG,M-BEG,M-EXIT \?L1
	CALL SECRET-CHECK,RARG >STACK
	RSTACK
?L1:	EQUAL? RARG,P?SE,P?IN,P?DOWN \?L3
	CALL ENTER-PASSAGE
	RTRUE
?L3:	EQUAL? RARG,M-LOOK \FALSE
	PRINTI "The room is utterly feminine in its decoration, yet neater than you might expect for a young woman of "
	PRINTD FRIEND
	PRINTI "'s age. "
	CALL DRESSING-TABLE-TAM
	CALL OPEN-DOOR?,SECRET-TAMARA-DOOR
	CRLF
	RTRUE

	.FUNCT DRESSING-TABLE-TAM
	PRINTI "Even her "
	PRINTD DRESSING-TABLE-LG
	PRINTI " is in apple-pie order, with her hand mirror, comb, brush, makeup kit and "
	PRINTD JEWELRY-CASE
	PRINTI " all precisely placed on its gleaming surface."
	RTRUE

	.FUNCT TAMARA-BED-F,OBJ
	EQUAL? PRSA,V?EXAMINE \?L1
	PRINTD FRIEND
	PRINTR " has a curtained four-poster bed on a circular dais. You notice that the knob on one bedpost looks loose."
?L1:	EQUAL? PRSA,V?SEARCH,V?LOOK-UNDER \?L5
	CALL FIND-FLAG,TAMARA-BED,NDESCBIT,PLAYER >OBJ
	ZERO? OBJ /FALSE
	CALL DISCOVER,OBJ >STACK
	RSTACK
?L5:	EQUAL? PRSA,V?PUT-UNDER \?L9
	EQUAL? PRSI,TAMARA-BED \FALSE
	FSET PRSO,NDESCBIT
	MOVE PRSO,TAMARA-BED
	CALL OKAY >STACK
	RSTACK
?L9:	EQUAL? PRSA,V?TURN,V?RUB /?L14
	EQUAL? PRSA,V?PUSH,V?MOVE-DIR,V?MOVE \FALSE
?L14:	CALL OPEN-SECRET,STR?173,STR?172,SECRET-TAMARA-DOOR >STACK
	RSTACK

	.FUNCT JEWELRY-CASE-F
	EQUAL? PRSA,V?TAKE \?L1
	EQUAL? PRSO,JEWELRY-CASE \FALSE
	CALL PRINT-ID,STR?223
	CALL YOU-SHOULDNT
	RTRUE
?L1:	EQUAL? PRSA,V?OPEN,V?LOOK-INSIDE,V?EXAMINE \FALSE
	CALL TELL-AS-WELL-AS,JEWELRY-CASE,STR?224
	IN? EARRING,JEWELRY-CASE \TRUE
	FSET? EARRING,NDESCBIT \TRUE
	FCLEAR EARRING,NDESCBIT
	FCLEAR EARRING,SECRETBIT
	CALL THIS-IS-IT,EARRING
	PRINTI "Almost the first thing you notice is a delicate "
	PRINTD EARRING
	PRINTR "."

	.FUNCT EARRING-F
	EQUAL? PRSA,V?PUT-IN /?L3
	EQUAL? PRSA,V?PUT,V?HOLD-UP,V?COMPARE \FALSE
?L3:	EQUAL? JEWEL,PRSO,PRSI \FALSE
	FSET EARRING,LOCKED
	PRINTI "The jewel fits the empty "
	PRINTD EARRING
	PRINTI " perfectly."
	EQUAL? PRSA,V?PUT-IN,V?PUT \?L6
	PRINTI " You remove the jewel again."
?L6:	CRLF
	ZERO? EVIDENCE-FOUND \TRUE
	CALL CONGRATS
	RTRUE

	.FUNCT CORR-3-F,RARG=0
	EQUAL? RARG,M-LOOK \?L1
	PRINTI "The "
	PRINTD CORR-3
	PRINTR " has doors leading to the north, south, and southeast. Stairways go up at the east end and down at the west end."
?L1:	EQUAL? RARG,P?WEST,P?DOWN,P?OUT \?L5
	PRINT STAIRS-DOWN-LEFT
	RTRUE
?L5:	EQUAL? RARG,P?EAST,P?UP \FALSE
	PRINT STAIRS-UP-RIGHT
	RTRUE

	.FUNCT CAGE-PSEUDO
	EQUAL? PRSA,V?OPEN,V?LOOK-INSIDE \?L1
	PRINTR "It's empty."
?L1:	CALL RANDOM-PSEUDO >STACK
	RSTACK

	.FUNCT LUMBER-ROOM-F,RARG=0
	EQUAL? RARG,M-BEG \?L1
	CALL SECRET-CHECK,RARG >STACK
	ZERO? STACK \TRUE
	EQUAL? PRSA,V?LOOK-DOWN \FALSE
	FSET? LUMBER-RING,TOUCHBIT \?L6
	CALL PERFORM,V?LOOK-THROUGH,PEEPHOLE-2
	RTRUE
?L6:	FSET? LUMBER-CHEST,TOUCHBIT \FALSE
	CALL PERFORM,V?MOVE,LUMBER-RING
	RTRUE
?L1:	EQUAL? RARG,M-ENTER \?L11
	IN? PEEPHOLE-2,LUMBER-ROOM \FALSE
	PUTP LUMBER-ROOM,P?CORRIDOR,4
	RFALSE
?L11:	EQUAL? RARG,M-EXIT \?L15
	PUTP LUMBER-ROOM,P?CORRIDOR,0
	RFALSE
?L15:	EQUAL? RARG,M-LOOK \FALSE
	PRINTI "This is lumber in the British sense, meaning useless stuff like old "
	PRINTD MAGAZINE
	PRINTI "s, an ornate bird cage, an "
	PRINTD LUMBER-CHEST
	PRINTR " from the 1700's, and a broken Victorian hobby horse."

	.FUNCT LUMBER-CHEST-F
	EQUAL? PRSA,V?OPEN,V?LOOK-INSIDE \?L1
	CALL TOO-BAD-BUT,PRSO,STR?225 >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?TURN /?L4
	EQUAL? PRSA,V?PUSH,V?MOVE-DIR,V?MOVE \FALSE
?L4:	IN? LUMBER-RING,LUMBER-ROOM /FALSE
	MOVE LUMBER-RING,LUMBER-ROOM
	PRINTI "You reveal"
	CALL PRINTT,LUMBER-RING
	PRINTR " in the stone floor."

	.FUNCT LUMBER-RING-F,P
	EQUAL? PRSA,V?TAKE,V?PUSH /?L3
	EQUAL? PRSA,V?OPEN,V?MOVE-DIR,V?MOVE \?L1
?L3:	IN? PEEPHOLE-2,LUMBER-ROOM \?L4
	CALL ALREADY,LUMBER-RING,STR?84
	RTRUE
?L4:	MOVE PEEPHOLE-2,LUMBER-ROOM
	PUTP LUMBER-ROOM,P?CORRIDOR,4
	PRINTI "As you pull up on"
	CALL PRINTT,LUMBER-RING
	PRINTI ", you reveal"
	CALL PRINTT,PEEPHOLE-2
	PRINTI ", enabling you to peer directly downward at "
	PRINTD TAMARA-ROOM
	PRINTI " below.
"
	CALL FIND-FLAG-HERE-NOT,PERSONBIT,MUNGBIT,PLAYER >P
	ZERO? P /TRUE
	CALL HE-SHE-IT,P,1
	PRINTI " says, ""So that explains the ghostly face that "
	EQUAL? P,FRIEND \?L13
	PRINTC 73
	JUMP ?L17
?L13:	PRINTD FRIEND
?L17:	PRINTR " saw peering down that night."""
?L1:	EQUAL? PRSA,V?CLOSE \FALSE
	IN? PEEPHOLE-2,LUMBER-ROOM /?L24
	CALL ALREADY,LUMBER-RING,STR?79
	RTRUE
?L24:	MOVE PEEPHOLE-2,LOCAL-GLOBALS
	PUTP LUMBER-ROOM,P?CORRIDOR,0
	CALL OKAY,LUMBER-RING,STR?79
	RTRUE

	.FUNCT PEEPHOLE-2-F
	EQUAL? PRSA,V?LOOK-THROUGH /?L3
	EQUAL? PRSA,V?LOOK-OUTSIDE,V?LOOK-INSIDE,V?EXAMINE \?L1
?L3:	CALL PRINT-ID,STR?226
	CALL ROOM-PEEK,TAMARA-ROOM,1
	RTRUE
?L1:	EQUAL? PRSA,V?THROUGH \FALSE
	CALL TOO-BAD-BUT,PEEPHOLE-2,STR?227
	RTRUE

	.FUNCT MAGAZINE-F
	EQUAL? PRSA,V?READ /?L3
	EQUAL? PRSA,V?OPEN,V?LOOK-INSIDE,V?EXAMINE \FALSE
?L3:	CALL NOT-HOLDING?,PRSO >STACK
	ZERO? STACK \TRUE
	PRINTI "This is a"
	EQUAL? VARIATION,PAINTER-C \?L9
	PRINTR " copy of ""Reader's Digest"" for Sept. 1976. As you leaf through it, you find an article about the skull of Peking Man, which disappeared after the Pearl Harbor Attack, when it was shipped from China. Once it was mysteriously offered for sale for a million dollars, as reported in the New York Times."
?L9:	PRINTR "n old copy of ""Punch,"" good for a laugh or two."

	.FUNCT CHAPEL-F,RARG=0
	EQUAL? RARG,M-LOOK \FALSE
	PRINTI "A bare and austere yet poignantly atmospheric relic of the medieval past, the chapel contains an altar, pulpit, font, and family pews of elaborately carved oak. The most memorable feature is a splendid "
	PRINTD STAINED-WINDOW
	PRINTI ". "
	GETP STAINED-WINDOW,P?TEXT >STACK
	PRINT STACK
	CRLF
	RTRUE

	.FUNCT STAINED-WINDOW-F
	EQUAL? PRSA,V?SEARCH-FOR /?L3
	EQUAL? PRSA,V?SEARCH,V?TAKE,V?EXAMINE \?L1
?L3:	IN? CLUE-3,STAINED-WINDOW \?L1
	FSET? CLUE-3,SECRETBIT \?L1
	CALL DISCOVER,CLUE-3
	RTRUE
?L1:	EQUAL? PRSA,V?MUNG \FALSE
	CALL PRINT-ID,STR?228
	CALL YOU-SHOULDNT >STACK
	RSTACK

	.FUNCT BILLIARD-PSEUDO
	EQUAL? PRSA,V?LOOK-ON \?L1
	CALL WONT-HELP >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?PLAY \FALSE
	CALL HE-SHE-IT,WINNER,1,STR?229
	PRINTR " the balls around for a minute before getting bored."

	.FUNCT BUFFALO-HEAD-F
	CALL NOUN-USED?,W?EYE >STACK
	ZERO? STACK /FALSE
	CALL ADJ-USED?,0 >STACK
	ZERO? STACK /FALSE
	CALL VISIBLE?,GLASS-EYE >STACK
	ZERO? STACK /FALSE
	CALL DO-INSTEAD-OF,GLASS-EYE,BUFFALO-HEAD
	RTRUE

	.FUNCT RHINO-HEAD-F
	EQUAL? PRSA,V?FIX,V?LOOK-INSIDE,V?OPEN /?L3
	EQUAL? PRSA,V?SEARCH-FOR,V?SEARCH,V?EXAMINE \FALSE
?L3:	IN? CLUE-3,RHINO-HEAD \FALSE
	FSET? CLUE-3,SECRETBIT \FALSE
	FSET GLASS-EYE,TAKEBIT
	FCLEAR GLASS-EYE,TRYTAKEBIT
	FCLEAR GLASS-EYE,NDESCBIT
	FSET GLASS-EYE,SEENBIT
	PRINTI "There's something odd about this trophy. One of the "
	PRINTD GLASS-EYE
	PRINTR "s is backwards."

	.FUNCT GLASS-EYE-F
	EQUAL? PRSO,GLASS-EYE \FALSE
	IN? RHINO-HEAD,HERE \FALSE
	EQUAL? PRSA,V?TAKE,V?SEARCH-FOR,V?SEARCH /?L3
	EQUAL? PRSA,V?OPEN,V?MOVE-DIR,V?MOVE /?L3
	EQUAL? PRSA,V?LOOK-INSIDE /?L3
	EQUAL? PRSA,V?LOOK-BEHIND,V?FIX,V?EXAMINE \FALSE
?L3:	IN? CLUE-3,RHINO-HEAD \FALSE
	FSET RHINO-HEAD,OPENBIT
	FCLEAR GLASS-EYE,NDESCBIT
	FCLEAR GLASS-EYE,TRYTAKEBIT
	FSET GLASS-EYE,TAKEBIT
	EQUAL? PRSA,V?TAKE \?L6
	CALL V-TAKE
?L6:	CALL DISCOVER,CLUE-3
	RTRUE

	.FUNCT DECK-F,RARG=0
	EQUAL? RARG,M-LOOK \?L1
	PRINTR "The ""roof"" of the tower keep has a stone floor and battlements all around. Far below, the faint sound of the sea cries from the darkness. In the moonlight you see a huge bell mounted on a heavy frame."
?L1:	EQUAL? RARG,P?SOUTH,P?DOWN,P?IN \FALSE
	PRINT STAIRS-DOWN-LEFT
	RTRUE

	.FUNCT BELL-F,N=0,P,GT
	EQUAL? PRSA,V?TURN /?L3
	EQUAL? PRSA,V?PUSH,V?MOVE-DIR,V?MOVE \?L1
?L3:	CALL TOO-BAD-BUT,BELL,STR?230 >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?SEARCH-FOR,V?SEARCH /?L5
	EQUAL? PRSA,V?LOOK-UNDER,V?LOOK-INSIDE,V?EXAMINE \?L4
?L5:	EQUAL? VARIATION,PAINTER-C \?L6
	FSET? SKULL,SECRETBIT \?L6
	CALL DISCOVER,SKULL
	RTRUE
?L6:	IN? CLUE-3,BELL \?L8
	FSET? CLUE-3,SECRETBIT \?L8
	CALL DISCOVER,CLUE-3
	RTRUE
?L8:	CALL TELL-AS-WELL-AS,BELL,STR?231
	RTRUE
?L4:	EQUAL? PRSA,V?RING \FALSE
	ZERO? PLAYER-RANG-BELL? \?L19
	IN? BUTLER,LOCAL-GLOBALS /?L13
	IN? BUTLER,KITCHEN /?L19
	CALL GO-TO-SOUND,KITCHEN,BUTLER
	JUMP ?L19
?L13:	ZERO? LIONEL-SPEAKS-COUNTER \?L19
	SET 'MASS-SAID,0
?L18:	IGRTR? 'N,DEB-C /?L19
	GET CHARACTER-TABLE,N >P
	EQUAL? P,CONFESSED,CAPTOR,GHOST-NEW /?L18
	EQUAL? P,SEARCHER /?L18
	CALL GO-TO-SOUND,DECK,P
	JUMP ?L18
?L19:	SET 'PLAYER-RANG-BELL?,1
	PRINTI "Its deep booming ""gong"" can be felt in every room of the castle."
	CALL PRINT-ID,STR?232
	CRLF
	EQUAL? HERE,DECK \TRUE
	CALL FIND-FLAG-HERE-NOT,PERSONBIT,MUNGBIT,PLAYER >P
	ZERO? P /TRUE
	PRINTD P
	PRINTI " whispers, ""That's "
	FIRST? BELL >STACK \?L33
	PRINTI "not "
?L33:	PRINTR "too loud for comfort!"""

	.FUNCT GO-TO-SOUND,RM,P,GT,GF,L
	LOC P >L
	IN? P,RM /FALSE
	FSET? P,MUNGBIT /FALSE
	GETP P,P?CHARACTER >STACK
	GET GOAL-TABLES,STACK >GT
	GET GT,GOAL-FUNCTION >GF
	EQUAL? P,BUTLER \?L3
	EQUAL? GF,X-TO-BELL /?L3
	SET 'BUTLER-DUTY,GF
?L3:	PUT GT,GOAL-FUNCTION,X-TO-BELL
	CALL IN-MOTION?,P,1 >STACK
	ZERO? STACK /?L6
	GET GT,GOAL-F >STACK
	PUT GT,GOAL-QUEUED,STACK
	JUMP ?L8
?L6:	PUT GT,GOAL-QUEUED,L
?L8:	RANDOM 2 >STACK
	EQUAL? STACK,1 \?L9
	FSET? RM,WEARBIT \?L15
	FSET? L,WEARBIT \?L11
	FSET? RM,WEARBIT /?L9
?L15:	FSET? L,WEARBIT \?L9
?L11:	MOVE P,JUNCTION
?L9:	CALL ESTABLISH-GOAL,P,RM >STACK
	RSTACK

	.FUNCT X-TO-BELL,GARG=0,L,GT
	LOC GOAL-PERSON >L
	GETP GOAL-PERSON,P?CHARACTER >STACK
	GET GOAL-TABLES,STACK >GT
	EQUAL? GARG,G-REACHED /?L3
	EQUAL? L,HERE \FALSE
?L3:	LESS? BED-TIME,PRESENT-TIME \?L4
	CALL QUEUE,I-BEDTIME,15
?L4:	GET GT,ATTENTION-SPAN >STACK
	PUT GT,ATTENTION,STACK
	EQUAL? GOAL-PERSON,BUTLER \?L7
	PUT GT,GOAL-FUNCTION,BUTLER-DUTY
	JUMP ?L9
?L7:	PUT GT,GOAL-FUNCTION,NULL-F
?L9:	PUTP GOAL-PERSON,P?LDESC,4
	EQUAL? L,HERE \FALSE
	ZERO? MASS-SAID \FALSE
	SET 'MASS-SAID,1
	CALL HE-SHE-IT,GOAL-PERSON,1
	PRINTI " appears and says, ""What's all this, then?""
"
	RETURN 2

	.FUNCT LADDER-F,U=0,D=0
	EQUAL? PRSA,V?CLIMB-DOWN \?L1
	CALL DO-WALK,P?DOWN
	RTRUE
?L1:	EQUAL? PRSA,V?CLIMB-UP \?L3
	CALL DO-WALK,P?UP
	RTRUE
?L3:	EQUAL? PRSA,V?CLIMB-ON,V?BOARD \FALSE
	GETPT HERE,P?UP >U
	ZERO? U /?L7
	PTSIZE U >STACK
	EQUAL? STACK,UEXIT /?L7
	SET 'U,0
?L7:	GETPT HERE,P?DOWN >D
	ZERO? D /?L13
	PTSIZE D >STACK
	EQUAL? STACK,UEXIT /?L13
	SET 'D,0
?L13:	ZERO? U \?L17
	CALL DO-WALK,P?DOWN
	RTRUE
?L17:	ZERO? D \?L19
	CALL DO-WALK,P?UP
	RTRUE
?L19:	SET 'CLOCK-WAIT,1
	PRINTC 40
	PRINT WHICH-DIR
	PRINTR ")"

	.FUNCT LEVER-AND-DOOR,DR,DIR
	FSET DR,SEENBIT
	PRINTC 65
	FSET? DR,OPENBIT \?L3
	PRINTI "n open"
?L3:	PRINTI " "
	PRINTD DR
	PRINTI " and a lever are on the "
	CALL DIR-PRINT,DIR
	PRINTR " wall."

	.FUNCT SECRET-LANDING-JACK-F,RARG=0
	EQUAL? RARG,M-LOOK \FALSE
	CALL PASSAGE-DESC?,JACK-ROOM
	CALL LEVER-AND-DOOR,SECRET-JACK-DOOR,P?IN
	PRINTR "Stone steps curve down to the east."

	.FUNCT PASSAGE-1-F,RARG=0
	EQUAL? RARG,M-LOOK \?L1
	PRINTI "Stone steps lead west, a "
	PRINTD PASSAGE
	PRINTI " leads east, and a ladder leads straight up"
	PRINT INTO-DARKNESS
	RTRUE
?L1:	EQUAL? RARG,P?WEST,P?OUT,P?SW \FALSE
	PRINT STAIRS-UP-RIGHT
	RTRUE

	.FUNCT SECRET-LANDING-TAM-F,RARG=0
	EQUAL? RARG,M-LOOK \FALSE
	CALL PASSAGE-DESC?,TAMARA-ROOM
	CALL LEVER-AND-DOOR,SECRET-TAMARA-DOOR,P?IN
	PRINT SECRET-TAM-LIB
	PRINTI "north"
	PRINT INTO-DARKNESS
	RTRUE

	.FUNCT SECRET-VIVIEN-PASSAGE-F,RARG=0
	EQUAL? RARG,M-LOOK \?L1
	CALL PASSAGE-DESC?,VIVIEN-ROOM
	CALL LEVER-AND-DOOR,SECRET-VIVIEN-DOOR,P?NORTH
	PRINTI "A "
	PRINTD PASSAGE
	PRINTI " leads west and east"
	PRINT INTO-DARKNESS
	RTRUE
?L1:	EQUAL? RARG,P?EAST \FALSE
	PRINTI "The "
	PRINTD PASSAGE
	PRINTR " turns north at the corner of the building."

	.FUNCT DINING-PASSAGE-F,RARG=0
	EQUAL? RARG,M-LOOK \FALSE
	CALL LEVER-AND-DOOR,SECRET-DINING-DOOR,P?EAST
	PRINTI "A ladder leads up"
	PRINT INTO-DARKNESS
	RTRUE

	.FUNCT SECRET-LANDING-LIB-F,RARG=0
	EQUAL? RARG,M-LOOK \FALSE
	CALL PASSAGE-DESC?,LIBRARY
	CALL LEVER-AND-DOOR,SECRET-LIBRARY-DOOR,P?IN
	PRINT SECRET-TAM-LIB
	PRINTI "south"
	PRINT INTO-DARKNESS
	RTRUE

	.FUNCT SECRET-IAN-PASSAGE-F,RARG=0
	EQUAL? RARG,M-LOOK \FALSE
	CALL PASSAGE-DESC?,IAN-ROOM
	CALL LEVER-AND-DOOR,SECRET-IAN-DOOR,P?SOUTH
	PRINT PASSAGE-EAST-WEST
	RTRUE

	.FUNCT SITTING-PASSAGE-F,RARG=0
	EQUAL? RARG,M-LOOK \FALSE
	FSET SECRET-SITTING-DOOR,SEENBIT
	CALL PASSAGE-DESC?,SITTING-ROOM
	CALL SITTING-PASSAGE-LOSE
	PRINTI "A "
	PRINTD PASSAGE
	PRINTI " leads up to the west"
	PRINT INTO-DARKNESS
	RTRUE

	.FUNCT SITTING-PASSAGE-LOSE
	CALL START-SENTENCE,SECRET-SITTING-DOOR
	PRINTI " is overhead, too high to climb through.
"
	RFALSE

	.FUNCT YOUR-CLOSET-F,RARG=0
	EQUAL? RARG,M-LOOK \?L1
	CALL PASSAGE-DESC?,YOUR-ROOM
	PRINTI "The "
	PRINTD PASSAGE
	PRINTI " leads north and south. "
	CALL LEVER-AND-DOOR,SECRET-YOUR-DOOR,P?WEST
	PRINTI "A narrow stairway snakes down"
	PRINT INTO-DARKNESS
	RTRUE
?L1:	EQUAL? RARG,P?SOUTH \FALSE
	PRINTI "The "
	PRINTD PASSAGE
	PRINTR " turns west at the corner of the building."

	.FUNCT PASSAGE-DESC?,RM
	GET FOUND-PASSAGES,PLAYER-C >STACK
	EQUAL? HERE,STACK \FALSE
	PRINTI "This is a musty and cobwebby "
	PRINTD PASSAGE
	PRINTI " between the wall of"
	CALL PRINTT,RM
	PRINTR " and the outside wall of the castle."

	.FUNCT IRIS-CLOSET-F,RARG=0
	EQUAL? RARG,M-BEG \?L1
	IN? COSTUME,IRIS-CLOSET \FALSE
	FCLEAR COSTUME,SECRETBIT
	RFALSE
?L1:	EQUAL? RARG,M-LOOK \?L6
	CALL LEVER-AND-DOOR,SECRET-IRIS-DOOR,P?WEST
	PRINTI "The "
	PRINTD PASSAGE
	PRINTI " leads north and south"
	PRINT INTO-DARKNESS
	RTRUE
?L6:	EQUAL? RARG,P?NORTH \FALSE
	PRINTI "The "
	PRINTD PASSAGE
	PRINTR " turns west at the corner of the building."

	.FUNCT WENDISH-CORNER-F,RARG=0
	EQUAL? RARG,M-LOOK \?L1
	CALL PASSAGE-DESC?,WENDISH-ROOM
	CALL LEVER-AND-DOOR,SECRET-WENDISH-DOOR,P?SOUTH
	PRINT PASSAGE-EAST-WEST
	RTRUE
?L1:	EQUAL? RARG,P?EAST \FALSE
	PRINTI "The "
	PRINTD PASSAGE
	PRINTR " turns south at the corner of the building."

	.FUNCT MIDPOINT-F,RARG=0
	EQUAL? RARG,M-LOOK \FALSE
	PRINTI "At the "
	PRINTD MIDPOINT
	PRINTI " of the "
	PRINTD PASSAGE
	PRINTI ", another "
	PRINTD PASSAGE
	PRINTI " leads south. "
	PRINT PASSAGE-EAST-WEST
	RTRUE

	.FUNCT DRAWING-CLOSET-F,RARG=0
	EQUAL? RARG,M-LOOK \FALSE
	CALL PASSAGE-DESC?,DRAWING-ROOM
	CALL LEVER-AND-DOOR,SECRET-DRAWING-DOOR,P?NORTH
	PRINTI "A narrow stairway snakes up"
	PRINT INTO-DARKNESS
	RTRUE

	.FUNCT GALLERY-CORNER-F,RARG=0
	EQUAL? RARG,M-LOOK \FALSE
	FCLEAR PEEPHOLE,SECRETBIT
	CALL START-SENTENCE,PEEPHOLE
	PRINTI " is in the south wall. A "
	PRINTD PASSAGE
	PRINTR " leads north."

	.FUNCT PEEPHOLE-F
	EQUAL? PRSA,V?LOOK-THROUGH /?L3
	EQUAL? PRSA,V?LOOK-OUTSIDE,V?LOOK-INSIDE,V?EXAMINE \?L1
?L3:	EQUAL? HERE,GALLERY-CORNER \?L4
	FCLEAR PEEPHOLE,SECRETBIT
	CALL PRINT-ID,STR?233
	CALL ROOM-PEEK,GALLERY,1
	RTRUE
?L4:	EQUAL? HERE,GALLERY \FALSE
	CALL SECRET-CHECK,M-BEG >STACK
	ZERO? STACK \TRUE
	CALL PRINT-ID,STR?234
	CALL ROOM-PEEK,GALLERY-CORNER,1
	RTRUE
?L1:	EQUAL? PRSA,V?THROUGH \FALSE
	CALL TOO-BAD-BUT,PEEPHOLE,STR?227
	RTRUE

	.FUNCT HYDE-CLOSET-F,RARG=0
	EQUAL? RARG,M-LOOK \FALSE
	CALL LEVER-AND-DOOR,SECRET-HYDE-DOOR,P?SOUTH
	PRINT PASSAGE-EAST-WEST
	RTRUE

	.FUNCT RANDOM-PSEUDO
	EQUAL? PRSA,V?TELL-ABOUT,V?LOOK-UNDER,V?LOOK-BEHIND /FALSE
	EQUAL? PRSA,V?ASK-CONTEXT-ABOUT,V?ASK-ABOUT /FALSE
	EQUAL? PRSA,V?SEARCH,V?LOOK-INSIDE,V?EXAMINE \?L4
	CALL NOTHING-SPECIAL
	RTRUE
?L4:	CALL WONT-HELP >STACK
	RSTACK

	.FUNCT LUGGAGE-F,RARG=0
	CALL REMOTE-VERB? >STACK
	ZERO? STACK \FALSE
	EQUAL? PRSA,V?MOVE,V?TAKE \?L3
	EQUAL? PRSO,LUGGAGE \?L3
	LOC LUGGAGE >STACK
	FSET? STACK,PERSONBIT /FALSE
?L3:	LOC LUGGAGE >STACK
	FSET? STACK,PERSONBIT \FALSE
	CALL NOT-HOLDING?,LUGGAGE >STACK
	ZERO? STACK \TRUE
	RFALSE

	.FUNCT BROCHURE-F,X
	EQUAL? PRSA,V?TELL-ABOUT,V?READ,V?OPEN /?L3
	EQUAL? PRSA,V?LOOK-UP,V?LOOK-INSIDE,V?EXAMINE /?L3
	EQUAL? PRSA,V?DESCRIBE,V?ASK-FOR,V?ASK-CONTEXT-FOR /?L3
	EQUAL? PRSA,V?ASK-CONTEXT-ABOUT,V?ASK-ABOUT,V?ANALYZE \FALSE
?L3:	PRINTI "[You'll find the "
	PRINTD BROCHURE
	PRINTI " in your "
	PRINTD MOONMIST
	PRINTR " package.]"

	.FUNCT BLOWGUN-F
	EQUAL? PRSA,V?EXAMINE \?L1
	CALL QUEUED?,I-SHOT >STACK
	ZERO? STACK /?L3
	PRINTR "It's pointing right at you!"
?L3:	PRINTR "It's a bamboo tube, two feet long and as thin as a small snake."
?L1:	EQUAL? PRSA,V?LOOK-THROUGH,V?LOOK-INSIDE \?L10
	FSET? BLOWGUN,MUNGBIT \?L11
	PRINTR "It's empty."
?L11:	PRINTI "There's a"
	PRINT POISON-DART
	PRINTR " inside."
?L10:	EQUAL? PRSA,V?EMPTY \?L19
	SET 'PRSA,V?USE
?L19:	CALL SHOOTING,BLOWGUN >STACK
	RSTACK

	.FUNCT NO-VIOLENCE?,OBJ,P
	EQUAL? PRSA,V?SLAP /?L3
	EQUAL? PRSA,V?SHOOT,V?KILL,V?ATTACK \?L1
?L3:	SET 'P,PRSO
	JUMP ?L4
?L1:	SET 'P,PRSI
?L4:	ZERO? P \?L8
	CALL FIND-FLAG-HERE-NOT,PERSONBIT,MUNGBIT,WINNER >P
	ZERO? P \?L8
	SET 'CLOCK-WAIT,1
	PRINTI "(You didn't say whom to use it on!)"
	CRLF
	CALL PRINT-ID,STR?235
	RFALSE
?L8:	EQUAL? P,GHOST-NEW /?L13
	ZERO? VILLAIN-KNOWN? /?L15
	EQUAL? P,VILLAIN-PER /?L13
?L15:	PRINT NO-VIOLENCE
	CALL PRINT-ID,STR?236
	RFALSE
?L13:	FSET? P,MUNGBIT \?L18
	PRINT NO-VIOLENCE
	CALL PRINT-ID,STR?237
	RFALSE
?L18:	EQUAL? VILLAIN-PER,LOVER /?L21
	CALL QUEUED?,I-SHOT >STACK
	ZERO? STACK \?L21
	PRINT NO-VIOLENCE
	CALL PRINT-ID,STR?238
	RFALSE
?L21:	ZERO? LIONEL-SPEAKS-COUNTER /?L24
	CALL TELL-BAD-FORM
	CALL PRINT-ID,STR?239
	RFALSE
?L24:	SET 'SHOOTER,0
	CALL QUEUE,I-SHOT,0
	EQUAL? VILLAIN-PER,LOVER \?L26
	CALL PRINT-ID,STR?240
	CALL GHOST-FLEES
	RFALSE
?L26:	FSET P,MUNGBIT
	FCLEAR P,NDESCBIT
	PUTP P,P?LDESC,19
	GETP P,P?CHARACTER >STACK
	GET GOAL-TABLES,STACK >STACK
	PUT STACK,ATTENTION,0
	EQUAL? P,GHOST-NEW \?L29
	GETP VILLAIN-PER,P?CHARACTER >STACK
	GET GOAL-TABLES,STACK >STACK
	PUT STACK,ATTENTION,0
?L29:	EQUAL? OBJ,CANE,WAR-CLUB,MACE \?L32
	RANDOM 6 >STACK
	ADD 9,STACK >STACK
	CALL QUEUE,I-COME-TO,STACK
	JUMP ?L35
?L32:	GETP P,P?CHARACTER >STACK
	PUT SHOT,STACK,1
	EQUAL? P,GHOST-NEW \?L35
	GETP VILLAIN-PER,P?CHARACTER >STACK
	PUT SHOT,STACK,1
?L35:	GETP P,P?LINE >STACK
	ADD 3,STACK >STACK
	PUTP P,P?LINE,STACK
	CALL HE-SHE-IT,P,1
	IN? BLOWGUN,P \?L40
	FSET BLOWGUN,TAKEBIT
	FCLEAR BLOWGUN,NDESCBIT
	MOVE BLOWGUN,HERE
	PRINTI " drops"
	CALL PRINTT,BLOWGUN
	PRINTI " and"
?L40:	EQUAL? OBJ,MACE \?L45
	PRINTI " claps both hands over"
	CALL HIM-HER-IT,P,0,1
	PRINTI " mouth and nose. "
	CALL HIM-HER-IT,P,1,1
	PRINTI " face takes on a greenish pallor, and strangled noises issue from"
	CALL HIM-HER-IT,P,0,1
	PRINTI " throat"
	CALL PRINT-ID,STR?241
	JUMP ?L49
?L45:	PRINTI " looks surprised and stunned. Then"
	CALL HIM-HER-IT,P,0,1
	PRINTI " eyes flutter"
	CALL PRINT-ID,STR?242
?L49:	PRINTI ". Next moment"
	CALL HE-SHE-IT,P
	PRINTI " collapses "
	CALL GROUND-DESC >STACK
	PRINT STACK
	PRINTI "!
"
	RETURN P

	.FUNCT SHOOTING,OBJ,P=0
	CALL ATTACK-VERB?,1 >STACK
	ZERO? STACK /FALSE
	CALL NO-VIOLENCE?,OBJ >STACK
	ZERO? STACK /TRUE
	EQUAL? OBJ,BLOWGUN \TRUE
	FSET BLOWGUN,MUNGBIT
	RTRUE

	.FUNCT MACE-F,P=0
	EQUAL? PRSA,V?PUSH \?L1
	CALL FIND-FLAG-HERE-NOT,PERSONBIT,MUNGBIT,PLAYER >P
	CALL QUEUED?,I-SHOT >STACK
	ZERO? STACK /?L3
	ZERO? P /?L3
	CALL PERFORM,V?SHOOT,P,MACE
	RTRUE
?L3:	PRINTI "The "
	PRINTD MACE
	PRINTI " emits a foul-smelling spray."
	CALL PRINT-ID,STR?243
	ZERO? P /?L8
	PRINTC 32
	CALL HE-SHE-IT,P,1
	PRINTI " says, ""Have a care! You almost shot me!"""
	CALL PRINT-ID,STR?244
?L8:	CRLF
	RTRUE
?L1:	EQUAL? PRSA,V?SMELL \?L13
	PRINTI "It smells foul!"
	CRLF
	CALL PRINT-ID,STR?245 >STACK
	RSTACK
?L13:	CALL SHOOTING,MACE >STACK
	RSTACK

	.FUNCT NECKLACE-OF-D-F
	EQUAL? PRSA,V?CLOSE,V?OPEN \?L1
	CALL YOU-CANT >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?PUT-IN /?L4
	EQUAL? PRSA,V?PUT,V?HOLD-UP,V?COMPARE \?L3
?L4:	EQUAL? JEWEL,PRSO,PRSI \?L3
	EQUAL? PRSA,V?PUT-IN \?L5
	MOVE JEWEL,NECKLACE-OF-D
?L5:	PRINTI "The "
	PRINTD JEWEL
	PRINTR " fits the empty socket and matches the other red stones."
?L3:	EQUAL? PRSA,V?PUT-IN \?L10
	EQUAL? PRSI,NECKLACE-OF-D \FALSE
	CALL TOO-BAD-BUT,PRSO,STR?246 >STACK
	RSTACK
?L10:	EQUAL? PRSA,V?FIX \?L14
	CALL YOU-CANT >STACK
	RSTACK
?L14:	EQUAL? PRSA,V?EXAMINE \?L15
	PRINTI "It's a slender string of small, sparkling red, nonprecious stones. You notice that"
	PRINT CLASP-MUNGED
	PRINTI ", as if the clasp had been pulled open by force."
	IN? JEWEL,NECKLACE-OF-D /?L18
	PRINTI " You also notice an empty socket or setting, from which one of the red stones is missing."
?L18:	CRLF
	RTRUE
?L15:	EQUAL? PRSA,V?WEAR /?L24
	EQUAL? PRSA,V?PUT \FALSE
	FSET? PRSI,PERSONBIT \FALSE
?L24:	CALL PRINT-ID,STR?247
	CALL WEAR-SCARE >STACK
	RSTACK

	.FUNCT LENS-2-F
	EQUAL? PRSA,V?COMPARE \FALSE
	EQUAL? LENS-1,PRSO,PRSI \FALSE
	PRINTR "As near as you can tell, they're a matched set."

	.FUNCT LENS-BOX-F,X
	EQUAL? PRSA,V?OPEN,V?LOOK-INSIDE,V?EXAMINE \FALSE
	FSET? LENS,SEENBIT \?L3
	LOC LENS >X
	ZERO? X /?L3
	MOVE LENS-1,X
	REMOVE LENS
?L3:	FSET LENS-BOX,OPENBIT
	PRINTI "You lift the hinged cover. Inside is a bed of moist foam rubber"
	FIRST? LENS-BOX >X \?L9
	PRINTI ", holding"
	CALL PRINT-CONTENTS,LENS-BOX
?L9:	PRINTR ". It's obvious that the box will hold two lenses."

	.FUNCT LETTER-F
	EQUAL? PRSA,V?READ,V?LOOK-INSIDE,V?EXAMINE /?L3
	EQUAL? PRSA,V?SHOW \FALSE
	FSET? LETTER,TOUCHBIT /FALSE
?L3:	CALL NOT-HOLDING?,LETTER >STACK
	ZERO? STACK \TRUE
	FSET LETTER-MAID,SEENBIT
	PRINTI "It says,
""Your Lordship:
Following instructions in your late Uncle[RWD_ID: things:351, VAL: 1] Lionel's will, the other servants and I have left the castle after sounding the dinner gong. We shall remain away until tomorrow morning.
I regret to inform you that Gladys, the "
	PRINTD MAID
	PRINTI ", will not return with the rest of us. She wrote a note to Your Lordship explaining the reason. She told me that she put it on the "
	PRINTD WRITING-DESK
	PRINTI " in the "
	PRINTD SITTING-ROOM
	PRINTI ".
(signed) "
	PRINTD BUTLER
	PRINTR "."""

	.FUNCT LETTER-MAID-F
	CALL REMOTE-VERB? >STACK
	ZERO? STACK \FALSE
	FCLEAR LETTER-MAID,NDESCBIT
	EQUAL? PRSA,V?READ,V?LOOK-INSIDE,V?EXAMINE /?L6
	EQUAL? PRSA,V?SHOW \FALSE
	FSET? LETTER-MAID,TOUCHBIT /FALSE
?L6:	CALL NOT-HOLDING?,LETTER-MAID >STACK
	ZERO? STACK \TRUE
	PRINTI "It says, ""Today while cleaning the room of a certain person who shall[RWD_ID: things:378, VAL: 1] be nameless, I was SHOCKED to discover SUMMING DREDFUL!
I hope I knows me place, Your Lordship, but I was brought up to be a PERFECKLY RESPECTABLE young woman, and I cannot go on working under the same roof where such WICKEDNESS takes place.
I am not the type of girl given to idle gossip, so I will only say this. Maybe there is more reason than ANYONE SUSPECKS why that so-called ghost prowls about the castle at night, if you know what I mean.
"
	EQUAL? VARIATION,LORD-C \?L12
	PRINTI "I am not the type who peeks through "
	PRINTD KEYHOLE
	PRINTI "s, either, but maybe it is high time someone did"
	JUMP ?L19
?L12:	EQUAL? VARIATION,FRIEND-C \?L16
	PRINTI "Maybe you will also be surprised to learn that a certain pet shop in Frobzance sells more than just harmless puppies, kittens, and budgies"
	JUMP ?L19
?L16:	EQUAL? VARIATION,PAINTER-C,DOCTOR-C \?L19
	PRINTI "Me Dad always says that the first sign of a nut case is when a person starts talking to hisself. Well, if you was to ask me, there is more than one way to talk to "
	PRINTD PLAYER
	PRINTI ". Some does it on paper, and that is the type person to watch out for"
?L19:	PRINTR "!"""

	.FUNCT LETTER-DEE-F
	EQUAL? PRSA,V?READ,V?LOOK-INSIDE,V?EXAMINE /?L3
	EQUAL? PRSA,V?SHOW \FALSE
	FSET? LETTER-DEE,TOUCHBIT /FALSE
?L3:	CALL NOT-HOLDING?,LETTER-DEE >STACK
	ZERO? STACK \TRUE
	PRINTI "The writing is thick with loops and curls. It says,
""Dear Uncle Lionel,
I'm writing this on the train, coming up from London, where I saw[RWD_ID: things:426, VAL: 1] Grandpapa in the clinic. He's so frightfully ill! I know "
	PRINTD DOCTOR
	PRINTI " is your old friend, but I can't help thinking his 'special treatments' are making Grandpapa worse, not better. Would you be a dear and find out just what he's doing there? I'd be ever so grateful!
Love,
"
	PRINTD LOVER
	PRINTR "."""

	.FUNCT NULL-F,A1,A2
	RFALSE

	.FUNCT DOOR-ROOM,RM,DR,P=0,TBL
?L1:	NEXTP RM,P >P
	ZERO? P /FALSE
	LESS? P,P?OUT /FALSE
	GETPT RM,P >TBL
	PTSIZE TBL >STACK
	EQUAL? DEXIT,STACK \?L1
	GETB TBL,DEXITOBJ >STACK
	EQUAL? DR,STACK \?L1
	GETB TBL,REXIT >STACK
	RSTACK

	.FUNCT FIND-FLAG,RM,FLAG,EXCLUDED=0,O
	FIRST? RM >O \FALSE
?L4:	FSET? O,FLAG \?L6
	FSET? O,INVISIBLE /?L6
	EQUAL? O,EXCLUDED /?L6
	RETURN O
?L6:	NEXT? O >O /?L4
	RFALSE

	.FUNCT FIND-FLAG-NOT,RM,FLAG,O
	FIRST? RM >O \FALSE
?L4:	FSET? O,FLAG /?L6
	FSET? O,INVISIBLE /?L6
	RETURN O
?L6:	NEXT? O >O /?L4
	RFALSE

	.FUNCT FIND-FLAG-LG,RM,FLAG,FLAG2=0,TBL,O,CNT=0,SIZE
	GETPT RM,P?GLOBAL >TBL
	ZERO? TBL /FALSE
	PTSIZE TBL >STACK
	SUB STACK,1 >SIZE
?L3:	GETB TBL,CNT >O
	FSET? O,FLAG \?L5
	FSET? O,INVISIBLE /?L5
	ZERO? FLAG2 /?L7
	FSET? O,FLAG2 \?L5
?L7:	RETURN O
?L5:	IGRTR? 'CNT,SIZE \?L3
	RFALSE

	.FUNCT FIND-FLAG-HERE,FLAG,NOT1=0,NOT2=0,O
	FIRST? HERE >O \FALSE
?L4:	FSET? O,FLAG \?L6
	FSET? O,INVISIBLE /?L6
	EQUAL? O,NOT1,NOT2 /?L6
	RETURN O
?L6:	NEXT? O >O /?L4
	RFALSE

	.FUNCT FIND-FLAG-HERE-NOT,FLAG,NFLAG,NOT2=0,O
	FIRST? HERE >O \FALSE
?L4:	FSET? O,FLAG \?L6
	FSET? O,NFLAG /?L6
	FSET? O,INVISIBLE /?L6
	EQUAL? O,NOT2 /?L6
	RETURN O
?L6:	NEXT? O >O /?L4
	RFALSE

	.FUNCT LEVER-F,X=0
	FSET? HERE,SECRETBIT \?L1
	CALL FIND-FLAG-LG,HERE,DOORBIT >X
	JUMP ?L3
?L1:	EQUAL? HERE,DUNGEON,LOVER-PATH \?L3
	SET 'X,PRIEST-DOOR
?L3:	ZERO? X \?L5
	CALL NOT-HERE,LEVER
	RTRUE
?L5:	EQUAL? PRSA,V?TURN,V?TAKE,V?RUB /?L8
	EQUAL? PRSA,V?PUSH,V?MOVE-DIR,V?MOVE \?L7
?L8:	FSET X,TOUCHBIT
	CALL OPEN-CLOSE,X >STACK
	RSTACK
?L7:	EQUAL? PRSA,V?OPEN \?L9
	FSET X,TOUCHBIT
	CALL OKAY,X,STR?84
	RTRUE
?L9:	EQUAL? PRSA,V?CLOSE \FALSE
	FSET X,TOUCHBIT
	CALL OKAY,X,STR?79
	RTRUE

	.FUNCT OPEN-CLOSE,DR,SAY-NAME=1,X
	ZERO? SAY-NAME /?L1
	CALL START-SENTENCE,DR
?L1:	PRINTI " creaks "
	FSET? DR,OPENBIT \?L8
	FCLEAR DR,OPENBIT
	CALL THIS-IS-IT,DR
	PRINTI "closed.
"
	CALL REMOVE-CAREFULLY
	RTRUE
?L8:	CALL DOOR-ROOM,HERE,DR >X
	ZERO? X /FALSE
	FSET DR,OPENBIT
	CALL THIS-IS-IT,X
	PRINTI "open, revealing"
	FSET? HERE,SECRETBIT \?L15
	CALL PRINTT,X
	JUMP ?L22
?L15:	EQUAL? HERE,LOVER-PATH \?L19
	CALL PRINTT,DUNGEON
	JUMP ?L22
?L19:	PRINTI " a "
	PRINTD PASSAGE
?L22:	FSET DR,SEENBIT
	FSET X,SEENBIT
	PRINTR "!"

	.FUNCT OUTSIDE?,RM
	CALL GLOBAL-IN?,MOON,RM >STACK
	RSTACK

	.FUNCT WINDOW-F
	EQUAL? PRSA,V?UNLOCK /?L3
	EQUAL? PRSA,V?LOCK,V?CLOSE,V?OPEN \?L1
?L3:	EQUAL? HERE,DRIVEWAY /?L6
	LOC PLAYER >STACK
	EQUAL? STACK,CAR \?L4
?L6:	CALL NO-NEED
	RTRUE
?L4:	EQUAL? PRSA,V?OPEN \?L7
	PRINTR "The night air is too damp and chilly."
?L7:	CALL ALREADY,WINDOW,STR?79
	RTRUE
?L1:	EQUAL? PRSA,V?THROUGH,V?LEAVE,V?DISEMBARK \?L11
	PRINTR "It's closed tight against the mist."
?L11:	EQUAL? PRSA,V?LOOK-OUTSIDE,V?LOOK-THROUGH,V?LOOK-INSIDE \FALSE
	LOC WINNER >STACK
	EQUAL? STACK,CAR \?L15
	CALL V-LOOK >STACK
	RSTACK
?L15:	PRINTR "All you can see are grey shapes in the moonlight."

	.FUNCT CORRIDOR-LOOK,ITM=0,C,Z,COR,VAL,FOUND=0
	GETP HERE,P?CORRIDOR >C
	ZERO? C /FALSE
?L5:	SUB C,4 >Z
	LESS? Z,0 /?L7
	SET 'COR,COR-4
	JUMP ?L11
?L7:	SUB C,2 >Z
	LESS? Z,0 /?L9
	SET 'COR,COR-2
	JUMP ?L11
?L9:	SUB C,1 >Z
	LESS? Z,0 /?L6
	SET 'COR,COR-1
?L11:	CALL CORRIDOR-CHECK,COR,ITM >VAL
	ZERO? FOUND \?L12
	SET 'FOUND,VAL
?L12:	SET 'C,Z
	JUMP ?L5
?L6:	RETURN FOUND

	.FUNCT CORRIDOR-CHECK,COR,ITM,CNT=1,PAST=0,FOUND=0,RM,OBJ
?L1:	INC 'CNT
	GET COR,CNT >RM
	ZERO? RM /FALSE
	EQUAL? RM,ITM \?L5
	GET COR,PAST >STACK
	RSTACK
?L5:	EQUAL? ITM,ROOMS \?L6
	CALL THIS-IT?,RM >STACK
	ZERO? STACK /?L6
	RETURN RM
?L6:	CALL LIT?,RM >STACK
	ZERO? STACK \?L7
	EQUAL? ITM,ROOMS \?L1
?L7:	EQUAL? RM,HERE \?L8
	SET 'PAST,1
	JUMP ?L1
?L8:	FIRST? RM >OBJ \?L1
?L10:	ZERO? ITM /?L12
	EQUAL? OBJ,ITM \?L17
	GET COR,PAST >FOUND
	JUMP ?L11
?L12:	FSET? OBJ,PERSONBIT \?L17
	CALL IN-MOTION?,OBJ,1 >STACK
	ZERO? STACK \?L17
	PRINTD OBJ
	PRINTI " is in"
	CALL PRINTT,RM
	PRINTI "."
	CRLF
?L17:	NEXT? OBJ >OBJ /?L10
?L11:	ZERO? FOUND /?L1
	RETURN FOUND

	.FUNCT LOCAL-GLOBALS-F
	CALL REMOTE-VERB? >STACK
	ZERO? STACK \FALSE
	CALL CREEPY?,HERE >STACK
	ZERO? STACK \?L4
	CALL OUTSIDE?,HERE >STACK
	ZERO? STACK /?L3
?L4:	CALL RANDOM-PSEUDO >STACK
	RSTACK
?L3:	CALL NOT-HERE,LOCAL-GLOBALS >STACK
	RSTACK

	.FUNCT UPSTAIRS-DOWNSTAIRS,N,TBL,HR,?TMP
	LOC WINNER >HR
	EQUAL? PRSA,V?WALK-TO,V?WALK,V?THROUGH /?L3
	EQUAL? PRSA,V?CLIMB-UP,V?CLIMB-DOWN,V?BOARD \FALSE
?L3:	FSET? HR,SECRETBIT /FALSE
	FSET? HR,WEARBIT \?L6
	SET 'TBL,WING-STAIRS
	JUMP ?L7
?L6:	SET 'TBL,TOWER-STAIRS
?L7:	EQUAL? PRSA,V?CLIMB-UP,V?BOARD \?L8
	GETPT HR,P?UP >STACK
	ZERO? STACK /?L10
	CALL DO-WALK,P?UP
	RTRUE
?L10:	GETP HR,P?CHARACTER >N
	ZERO? N /FALSE
	GET TBL,0 >?TMP
	INC 'N
	LESS? ?TMP,N /FALSE
	GET TBL,N >N
	CALL PERFORM,V?WALK-TO,N
	RTRUE
?L8:	GETPT HR,P?DOWN >STACK
	ZERO? STACK /?L15
	CALL DO-WALK,P?DOWN
	RTRUE
?L15:	GETP HR,P?CHARACTER >N
	ZERO? N /FALSE
	DEC 'N
	LESS? 0,N \FALSE
	GET TBL,N >N
	CALL PERFORM,V?WALK-TO,N
	RTRUE

	.FUNCT DO-INSTEAD-OF,OBJ1,OBJ2
	EQUAL? PRSI,OBJ2 \?L1
	CALL PERFORM,PRSA,PRSO,OBJ1
	RTRUE
?L1:	EQUAL? PRSO,OBJ2 \?L3
	CALL PERFORM,PRSA,OBJ1,PRSI
	RTRUE
?L3:	CALL V-FOO >STACK
	RSTACK

	.FUNCT TURN-F
	EQUAL? PRSA,V?USE \FALSE
	CALL PERFORM,V?WAIT-FOR,PRSO
	RTRUE

	.FUNCT IT-F
	EQUAL? PRSI,IT \?L4
	EQUAL? PRSA,V?TELL-ABOUT,V?SEARCH-FOR,V?ASK-FOR /?L3
	EQUAL? PRSA,V?ASK-ABOUT /?L3
?L4:	EQUAL? PRSO,IT \FALSE
	EQUAL? PRSA,V?FIND,V?ASK-CONTEXT-FOR,V?ASK-CONTEXT-ABOUT \FALSE
?L3:	PRINTR """I'm not sure what you're talking about."""

	.FUNCT FLOOR-F,OBJ=0,N
	EQUAL? PRSA,V?CLIMB-ON \?L1
	CALL ALREADY,WINNER,STR?248 >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?THROW-AT,V?PUT \?L3
	EQUAL? PRSO,MOONMIST /?L3
	EQUAL? PRSI,FLOOR \?L3
	MOVE PRSO,HERE
	PRINTR "Okay."
?L3:	EQUAL? PRSA,V?SEARCH-FOR /?L7
	EQUAL? PRSA,V?SEARCH,V?LOOK-ON,V?EXAMINE \?L6
?L7:	EQUAL? HERE,DRAWING-ROOM \?L8
	PRINTI "The carpet ends flush with the archway to the "
	PRINTD GREAT-HALL
	PRINTI ", where the footsteps of visitors have begun to wear it thin. It's a magnificent red Brussels carpet with deep pile and a medieval design."
	CRLF
	JUMP ?L12
?L8:	EQUAL? HERE,GREAT-HALL \?L12
	CALL GREAT-HALL-IS-FLOORED
?L12:	EQUAL? HERE,GARDEN \?L14
	EQUAL? VARIATION,LORD-C \?L14
	FSET? CLUE-4,SECRETBIT \?L14
	SET 'OBJ,CLUE-4
	JUMP ?L17
?L14:	EQUAL? HERE,DRAWING-ROOM \?L16
	EQUAL? VARIATION,LORD-C,FRIEND-C \?L16
	FSET? JEWEL,TOUCHBIT /?L16
	SET 'OBJ,JEWEL
	JUMP ?L17
?L16:	EQUAL? HERE,GREAT-HALL \?L17
	EQUAL? VARIATION,DOCTOR-C,PAINTER-C \?L17
	EQUAL? FOUND-IT-PERM,LENS,LENS-2 /?L17
	SET 'OBJ,LENS
?L17:	CALL START-SEARCH,OBJ
	RTRUE
?L6:	CALL ADJ-USED?,W?DRAWING >STACK
	ZERO? STACK /?L19
	EQUAL? HERE,DRAWING-ROOM /FALSE
	CALL DO-INSTEAD-OF,DRAWING-ROOM,FLOOR
	RTRUE
?L19:	CALL ADJ-USED?,W?GREAT >STACK
	ZERO? STACK /FALSE
	EQUAL? HERE,GREAT-HALL /FALSE
	CALL DO-INSTEAD-OF,GREAT-HALL,FLOOR
	RTRUE

	.FUNCT START-SEARCH,OBJ=0
	PRINTI "Nothing suspicious meets your eye after a moment's scrutiny. Do you want to continue?"
	CALL YES? >STACK
	ZERO? STACK \?L3
	CALL OKAY
	RTRUE
?L3:	SET 'FOUND-IT,OBJ
	SET 'FOUND-LOC,HERE
	RANDOM 7 >STACK
	CALL QUEUE,I-FOUND-IT,STACK
	CALL V-WAIT,8,0,1
	RTRUE

	.FUNCT I-FOUND-IT,GARG=0,OBJ
	EQUAL? FOUND-LOC,HERE \FALSE
	EQUAL? FOUND-IT,JEWEL \?L3
	MOVE FOUND-IT,HERE
	PRINTI "Suddenly you notice a glittering speck. Probing for it with your fingers, you discover a "
	PRINTD JEWEL
	PRINTI "."
	CRLF
	JUMP ?L24
?L3:	EQUAL? FOUND-IT,LENS \?L6
	FSET? LENS,SEENBIT /?L7
	LOC LENS >STACK
	MOVE LENS-2,STACK
	JUMP ?L10
?L7:	FSET? LENS-2,SEENBIT /FALSE
	SET 'FOUND-IT,LENS-2
	LOC LENS >STACK
	MOVE LENS-1,STACK
	REMOVE LENS
?L10:	MOVE FOUND-IT,HERE
	PRINTI "Suddenly you find something small, smooth and slippery -- a [RWD_ID: global:195, VAL: 1]"
	PRINTD FOUND-IT
	PRINTI "! Its transparency, of course, made it practically invisible."
	ZERO? BUTLER-GHOST-STORY-TOLD /?L13
	PRINTI " No wonder you and the ghost had such a hard time finding it!"
?L13:	CRLF
	JUMP ?L24
?L6:	ZERO? FOUND-IT \?L18
	PRINT NOTHING-NEW
	RETURN 2
?L18:	FSET? FOUND-IT,SECRETBIT \?L23
	CALL DISCOVER,FOUND-IT
	JUMP ?L24
?L23:	PRINTC 89
	PRINT OU-STOP-SEARCHING
	PRINTI " when you find"
	CALL PRINTT,FOUND-IT
	PRINTI ".
"
?L24:	FSET FOUND-IT,TOUCHBIT
	FSET FOUND-IT,SEENBIT
	EQUAL? FOUND-IT,YOUR-SWITCH /?L29
	FCLEAR FOUND-IT,NDESCBIT
?L29:	EQUAL? FOUND-IT,LENS,LENS-2 \?L32
	SET 'FOUND-IT-PERM,FOUND-IT
?L32:	SET 'FOUND-IT,0
	RETURN 2

	.FUNCT YOU-F,X
	EQUAL? WINNER,PLAYER /?L1
	CALL DO-INSTEAD-OF,WINNER,YOU
	RTRUE
?L1:	EQUAL? PRSA,V?ASK-ABOUT \?L3
	EQUAL? PRSI,YOU \?L3
	CALL PERFORM,V?ASK-ABOUT,PRSO,PRSO
	RTRUE
?L3:	EQUAL? PRSA,V?THANKS \FALSE
	CALL QCONTEXT-GOOD? >X
	ZERO? X /FALSE
	CALL PERFORM,V?THANKS,X
	RTRUE

	.FUNCT WALL-F,OBJ
	EQUAL? VARIATION,FRIEND-C \?L1
	EQUAL? HERE,BASEMENT,CRYPT \?L1
	CALL BRICKS-F >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?CLOSE,V?OPEN \?L3
	CALL FIND-FLAG-LG,HERE,DOORBIT,SECRETBIT >OBJ
	ZERO? OBJ /?L3
	CALL DO-INSTEAD-OF,OBJ,WALL
	RTRUE
?L3:	EQUAL? PRSA,V?KNOCK \FALSE
	FSET? HERE,WEARBIT \?L7
	CALL FIND-FLAG-LG,HERE,DOORBIT,SECRETBIT >STACK
	ZERO? STACK /?L5
?L7:	PRINTR "You hear a hollow sound."
?L5:	PRINTR "Knocking on the walls reveals nothing unusual."

	.FUNCT GLOBAL-HERE-F,OBJ,X=0
	EQUAL? PRSA,V?WALK-TO,V?SMELL /?L3
	EQUAL? PRSA,V?SIT,V?LIE,V?EXAMINE \?L1
?L3:	CALL DO-INSTEAD-OF,HERE,GLOBAL-HERE
	RTRUE
?L1:	EQUAL? PRSA,V?PUT-IN,V?PUT \?L4
	CALL MORE-SPECIFIC >STACK
	RSTACK
?L4:	EQUAL? PRSA,V?SEARCH-FOR,V?SEARCH \FALSE
	IN? MAGAZINE,HERE \?L6
	FSET? MAGAZINE,NDESCBIT \?L6
	SET 'X,MAGAZINE
	JUMP ?L13
?L6:	IN? BRICKS,HERE \?L8
	FSET? BRICKS,NDESCBIT \?L8
	SET 'X,BRICKS
	JUMP ?L13
?L8:	ZERO? PRSI /?L9
	CALL META-LOC,PRSI >STACK
	EQUAL? STACK,HERE \?L9
	SET 'X,PRSI
	JUMP ?L13
?L9:	FIRST? HERE >OBJ \?L13
?L14:	FSET? OBJ,SECRETBIT \?L16
	SET 'X,OBJ
	JUMP ?L13
?L16:	FSET? OBJ,PERSONBIT /?L17
	FSET? OBJ,CONTBIT /?L18
	FSET? OBJ,SURFACEBIT \?L17
?L18:	CALL FIND-FLAG,OBJ,SECRETBIT >X
	ZERO? X \?L19
	CALL FIND-FLAG,OBJ,RMUNGBIT >X
	ZERO? X /?L17
?L19:	FSET OBJ,OPENBIT
	JUMP ?L13
?L17:	NEXT? OBJ >OBJ /?L14
?L13:	CALL START-SEARCH,X
	RTRUE

	.FUNCT CHAIR-F
	EQUAL? PRSA,V?BOARD,V?CLIMB-ON,V?SIT \?L1
	CALL WONT-HELP >STACK
	RSTACK
?L1:	CALL RANDOM-PSEUDO >STACK
	RSTACK

	.FUNCT CLOTHES-FCN
	EQUAL? PRSA,V?LOOK-INSIDE,V?EXAMINE \?L1
	EQUAL? PRSO,TWEED-OUTFIT \?L3
	PRINTI "These are sensible clothes for this clammy climate: your new tweed "
	ZERO? GENDER-KNOWN \?L7
	PRINTI "suit"
	JUMP ?L18
?L7:	PRINTI "blazer and "
	FSET? PLAYER,FEMALE \?L14
	PRINTI "skirt"
	JUMP ?L18
?L14:	PRINTI "pants"
?L18:	PRINTR ", with woolen sweater, should keep you warm enough."
?L3:	EQUAL? PRSO,EXERCISE-OUTFIT \?L23
	PRINTI "This is your favorite outfit for workouts: a cotton sweatsuit with a sporty "
	CALL PRINT-COLOR >STACK
	ZERO? STACK /?L26
	PRINTC 32
?L26:	PRINTR "stripe."
?L23:	EQUAL? PRSO,DINNER-OUTFIT \?L33
	ZERO? GENDER-KNOWN \?L34
	PRINTI "You have a decent formal ensemble, with frills in the right places"
	JUMP ?L38
?L34:	PRINTI "Your new "
	FSET? PLAYER,FEMALE \?L41
	PRINTI "floor-length dinner gown"
	JUMP ?L45
?L41:	PRINTI "tuxedo"
?L45:	PRINTI " is particularly good-looking"
?L38:	PRINTI " and a perfect fit"
	ZERO? VARIATION /?L52
	PRINTI ", "
	FSET? PLAYER,FEMALE \?L56
	PRINTI "not to mention that it's all"
	JUMP ?L60
?L56:	PRINTI "with shirt and accessories"
?L60:	PRINTI " in "
	CALL PRINT-COLOR
?L52:	PRINTR "."
?L33:	PRINTI "Your new "
	CALL PRINT-COLOR >STACK
	ZERO? STACK /?L71
	PRINTC 32
?L71:	PRINTD SLEEP-OUTFIT
	PRINTI " is "
	ZERO? GENDER-KNOWN \?L78
	PRINTR "nothing to write home about, but it is so-o-o comfy for sleeping."
?L78:	FSET? PLAYER,FEMALE \?L82
	PRINTR "made of fine Chinese silk."
?L82:	PRINTR "decorated with a Union Jack flag."
?L1:	EQUAL? PRSA,V?DISEMBARK \?L88
	CALL PERFORM,V?TAKE-OFF,PRSO
	RTRUE
?L88:	EQUAL? PRSA,V?EMPTY \FALSE
	CALL META-LOC,LUGGAGE >STACK
	EQUAL? STACK,HERE \?L90
	CALL PERFORM,V?EMPTY,LUGGAGE
	RTRUE
?L90:	CALL NOT-HERE,LUGGAGE >STACK
	RSTACK

	.FUNCT SLEEP-GLOBAL-F,?TMP
	EQUAL? PRSA,V?DRESS \?L1
	SET '?TMP,HERE
	CALL META-LOC,SLEEP-OUTFIT >STACK
	EQUAL? ?TMP,STACK \FALSE
	CALL PERFORM,V?WEAR,SLEEP-OUTFIT
	RTRUE
?L1:	EQUAL? PRSA,V?WALK-TO \FALSE
	CALL PERFORM,V?FAINT
	RTRUE

	.FUNCT ROB,WHAT,THIEF,TELL?=0,N,X,TOLD?=0
	FIRST? WHAT >X /?L4
	RTRUE
?L1:	ZERO? X /TRUE
?L4:	NEXT? X >N /?L8
	ZERO? TOLD? /?L8
	ZERO? TELL? /?L8
	PRINTI " and"
?L8:	SET 'TOLD?,1
	ZERO? TELL? /?L21
	CALL PRINTT,X
	ZERO? N /?L17
	PRINTC 44
	JUMP ?L21
?L17:	PRINTI ". "
?L21:	MOVE X,THIEF
	SET 'X,N
	JUMP ?L1

	.FUNCT LIGHT-GLOBAL-F,P
	CALL REMOTE-VERB? >STACK
	ZERO? STACK \FALSE
	EQUAL? PRSA,V?LAMP-OFF,V?LAMP-ON \FALSE
	CALL CREEPY?,HERE >STACK
	ZERO? STACK /?L4
	CALL ACCESSIBLE?,LAMP >STACK
	ZERO? STACK /?L6
	CALL PERFORM,PRSA,LAMP
	RTRUE
?L6:	CALL NOT-HERE,LIGHT-GLOBAL >STACK
	RSTACK
?L4:	CALL OUTSIDE?,HERE >STACK
	ZERO? STACK /?L9
	PRINTR "You can't reach it from here."
?L9:	EQUAL? PRSA,V?LAMP-ON \?L12
	FSET? HERE,ONBIT \?L13
	CALL ALREADY,LIGHT-GLOBAL,STR?82 >STACK
	RSTACK
?L13:	FSET HERE,ONBIT
	CALL OKAY,LIGHT-GLOBAL,STR?82 >STACK
	RSTACK
?L12:	EQUAL? PRSA,V?LAMP-OFF \FALSE
	FSET? HERE,ONBIT /?L17
	CALL ALREADY,LIGHT-GLOBAL,STR?83 >STACK
	RSTACK
?L17:	CALL FIND-FLAG-HERE-NOT,PERSONBIT,MUNGBIT,PLAYER >P
	ZERO? P /?L19
	PRINTD P
	PRINTR " says, ""Please don't leave us in the dark."""
?L19:	FCLEAR HERE,ONBIT
	CALL OKAY,LIGHT-GLOBAL,STR?83 >STACK
	RSTACK

	.FUNCT HAUNTING-F
	EQUAL? PRSA,V?PLAY,V?LAMP-ON \FALSE
	CALL PERFORM,PRSA,COMPUTER
	RTRUE

	.FUNCT KEYHOLE-F,P,RM
	CALL REMOTE-VERB? >STACK
	ZERO? STACK /?L1
	EQUAL? PRSA,V?SEARCH-FOR,V?SEARCH \FALSE
?L1:	CALL ADJ-USED?,0 >STACK
	ZERO? STACK /?L3
	CALL ZMEMQ,HERE,CHAR-ROOM-TABLE >STACK
	ZERO? STACK /?L4
	GETPT HERE,P?OUT >STACK
	GETB STACK,REXIT >RM
	JUMP ?L14
?L4:	EQUAL? HERE,CORR-2 /?L7
	EQUAL? HERE,WEST-HALL,GALLERY,EAST-HALL \?L6
?L7:	PRINT YOU-DIDNT-SAY-W
	PRINTI "hose "
	PRINTD KEYHOLE
	PRINTR "!]"
?L6:	CALL NOT-HERE,KEYHOLE
	RTRUE
?L3:	CALL ADJ-USED? >STACK
	CALL ZMEMQ,STACK,CHAR-POSS-TABLE >P
	ZERO? P /?L14
	GET CHAR-ROOM-TABLE,P >RM
	EQUAL? HERE,RM \?L12
	GETPT HERE,P?OUT >STACK
	GETB STACK,REXIT >RM
	JUMP ?L14
?L12:	GETPT RM,P?OUT >STACK
	GETB STACK,REXIT >STACK
	EQUAL? HERE,STACK /?L14
	CALL NOT-HERE,KEYHOLE
	RTRUE
?L14:	EQUAL? PRSA,V?SEARCH-FOR,V?SEARCH /?L19
	EQUAL? PRSA,V?LOOK-THROUGH,V?LOOK-INSIDE,V?EXAMINE \FALSE
?L19:	EQUAL? JACK-ROOM,HERE,RM \?L20
	EQUAL? VARIATION,LORD-C \?L20
	PRINTI "You see a microphone with its wires leading toward the "
	PRINTD CREST
	PRINTR "."
?L20:	CALL ROOM-PEEK,RM,1
	RTRUE

	.FUNCT HANDS-F,P,A
	CALL FIND-BODY,HANDS >P
	ZERO? P /TRUE
	CALL REMOTE-VERB? >STACK
	ZERO? STACK \FALSE
	EQUAL? PRSA,V?KISS \?L5
	FSET? P,FEMALE \?L7
	ZERO? GENDER-KNOWN /?L7
	FSET? PLAYER,FEMALE /?L7
	CALL PERFORM,V?HELLO,P
	RTRUE
?L7:	CALL PERFORM,V?KISS,P
	RTRUE
?L5:	EQUAL? PRSA,V?TAKE,V?SHAKE \FALSE
	EQUAL? PRSO,HANDS \FALSE
	ZERO? PRSI /?L11
	SET 'P,PRSI
?L11:	CALL PERFORM,V?HELLO,P
	RTRUE

	.FUNCT HEAD-F,P,P2
	CALL FIND-BODY,HEAD >P
	ZERO? P /TRUE
	CALL REMOTE-VERB? >STACK
	ZERO? STACK \FALSE
	EQUAL? PRSA,V?NOD \?L4
	CALL PERFORM,V?YES
	RTRUE
?L4:	EQUAL? PRSA,V?SHAKE \FALSE
	CALL PERFORM,V?NO
	RTRUE

	.FUNCT EYE-F,P,P2
	CALL FIND-BODY,EYE >P
	ZERO? P /TRUE
	CALL REMOTE-VERB? >STACK
	ZERO? STACK \FALSE
	EQUAL? PRSA,V?OPEN \?L4
	SET 'WINNER,PLAYER
	CALL PERFORM,V?ALARM,P
	RTRUE
?L4:	EQUAL? PRSA,V?CLOSE \?L5
	SET 'WINNER,P
	CALL PERFORM,V?FAINT
	RTRUE
?L5:	EQUAL? PRSA,V?LOOK-INSIDE,V?FIND,V?EXAMINE \FALSE
	EQUAL? P,PLAYER \?L7
	FSET? HERE,WORNBIT /?L7
	CALL NOT-HERE,MIRROR-GLOBAL >STACK
	RSTACK
?L7:	EQUAL? GHOST-NEW,P \?L9
	CALL PERFORM,PRSA,GHOST-NEW
	RTRUE
?L9:	FSET? LENS,SEENBIT /?L11
	FSET? P,MUNGBIT \?L13
	CALL HE-SHE-IT,P,1
	PRINTR " has closed eyes."
?L13:	GETP P,P?CHARACTER >STACK
	EQUAL? VARIATION,STACK \?L17
	CALL HE-SHE-IT,P,1
	PRINTR " turns away from you."
?L17:	LESS? BED-TIME,PRESENT-TIME \?L20
	CALL HE-SHE-IT,P,1,STR?90
	PRINTR " sleepy."
?L20:	CALL HE-SHE-IT,P,1,STR?185
	PRINTR " at you."
?L11:	CALL HE-SHE-IT,P,1,STR?44
	EQUAL? P,DEALER \?L31
	EQUAL? VARIATION,PAINTER-C \?L29
?L31:	PRINTI " not"
?L29:	PRINTI " wearing a "
	PRINTD LENS
	PRINTR "."

	.FUNCT OTHER-OUTFIT-F,P,P2
	CALL FIND-BODY,OTHER-OUTFIT >P
	ZERO? P /TRUE
	CALL REMOTE-VERB? >STACK
	ZERO? STACK \FALSE
	EQUAL? PRSA,V?LOOK-INSIDE,V?FIND,V?EXAMINE \?L4
	EQUAL? GHOST-NEW,P \FALSE
	CALL PERFORM,PRSA,GHOST-NEW
	RTRUE
?L4:	EQUAL? PRSA,V?TAKE-OFF,V?REMOVE,V?DISEMBARK \FALSE
	CALL PRINT-ID,STR?249
	CALL YOU-SHOULDNT
	RTRUE

	.FUNCT FIND-BODY,OBJ,A,P
	CALL ADJ-USED? >A
	ZERO? A \?L1
	PRINT I-ASSUME
	PRINTC 32
	EQUAL? PRSA,V?SEARCH-FOR,V?FIND,V?CLOSE /?L7
	EQUAL? PRSA,V?SLAP /?L8
	EQUAL? PRSA,V?MUNG,V?KILL,V?ATTACK \?L5
?L8:	ZERO? NOW-PRSI /?L5
?L7:	SET 'P,PLAYER
	PRINTI "your"
	JUMP ?L16
?L5:	EQUAL? PRSA,V?SHAKE \?L13
	ZERO? PRSI /?L13
	SET 'P,PRSI
	FSET? P,PERSONBIT /?L12
?L13:	CALL QCONTEXT-GOOD? >P
	ZERO? P \?L12
	CALL FIND-FLAG-HERE,PERSONBIT,PLAYER >P
	ZERO? P /?L11
?L12:	PRINTD P
	PRINTI "'s"
	JUMP ?L16
?L11:	SET 'P,PLAYER
	PRINTI "your"
?L16:	GETP P,P?CHARACTER >STACK
	INC 'STACK
	GET CHAR-POSS-TABLE,STACK >STACK
	PUT P-ADJW,NOW-PRSI,STACK
	PRINTC 32
	GET P-NAMW,NOW-PRSI >A
	ZERO? A /?L21
	PRINTB A
	JUMP ?L23
?L21:	PRINTD OBJ
?L23:	PRINTI ".]"
	CRLF
	JUMP ?L30
?L1:	CALL ZMEMQ,A,CHAR-POSS-TABLE >P
	ZERO? P /?L28
	SUB P,1 >STACK
	GET CHARACTER-TABLE,STACK >P
	JUMP ?L30
?L28:	EQUAL? A,W?HER \?L29
	SET 'P,P-HER-OBJECT
	JUMP ?L30
?L29:	EQUAL? A,W?HIS \?L30
	SET 'P,P-HIM-OBJECT
?L30:	ZERO? P \?L32
	CALL DONT-UNDERSTAND
	RFALSE
?L32:	CALL THIS-IS-IT,P
	CALL META-LOC,P >STACK
	EQUAL? STACK,HERE /?L35
	CALL NOT-HERE,P
	RFALSE
?L35:	CALL DIVESTMENT?,OBJ >STACK
	ZERO? STACK /?L37
	CALL HAR-HAR
	RFALSE
?L37:	RETURN P

	.FUNCT PASSAGE-F,RM
	CALL FIND-FLAG-LG,HERE,DOORBIT,SECRETBIT >RM
	EQUAL? PRSA,V?WALK-TO,V?TAKE \?L1
	CALL PERFORM,V?THROUGH,PRSO
	RTRUE
?L1:	EQUAL? PRSA,V?CLOSE,V?OPEN \?L3
	ZERO? RM /?L3
	CALL DO-INSTEAD-OF,RM,PASSAGE
	RTRUE
?L3:	FSET? HERE,SECRETBIT \?L4
	CALL DO-INSTEAD-OF,HERE,PASSAGE
	RTRUE
?L4:	CALL REMOTE-VERB? >STACK
	ZERO? STACK \FALSE
	ZERO? RM /?L7
	CALL DOOR-ROOM,HERE,RM >RM
	ZERO? RM /?L7
	FSET? RM,SEENBIT \?L7
	CALL DO-INSTEAD-OF,RM,PASSAGE
	RTRUE
?L7:	CALL GENERIC-CLOSET,0 >RM
	ZERO? RM /?L9
	CALL DO-INSTEAD-OF,RM,PASSAGE
	RTRUE
?L9:	CALL NOT-HERE,PASSAGE >STACK
	RSTACK

	.FUNCT CORPSE-F
	EQUAL? PRSA,V?FIND \FALSE
	CALL WHO-KNOWS?,CORPSE >STACK
	RSTACK

	.FUNCT UNDRESSED-F
	CALL REMOTE-VERB? >STACK
	ZERO? STACK \FALSE
	EQUAL? PRSA,V?TAKE /FALSE
	EQUAL? PRSA,V?LOOK-ON,V?LOOK-INSIDE,V?EXAMINE /?L5
	EQUAL? PRSA,V?SEARCH-FOR /?L5
	EQUAL? PRSA,V?SEARCH,V?CLOSE,V?OPEN \?L4
?L5:	CALL GLOBAL-IN?,DRESSING-TABLE-LG,HERE >STACK
	ZERO? STACK /?L6
	CALL DO-INSTEAD-OF,DRESSING-TABLE-LG,UNDRESSED
	RTRUE
?L6:	CALL NOT-HERE,DRESSING-TABLE-LG >STACK
	RSTACK
?L4:	CALL DONT-UNDERSTAND >STACK
	RSTACK

	.FUNCT ARTIFACT-F
	ZERO? TREASURE-FOUND /?L1
	CALL DO-INSTEAD-OF,TREASURE,ARTIFACT
	RTRUE
?L1:	EQUAL? PRSA,V?TAKE-TO,V?SSHOW,V?SHOW /?L4
	CALL REMOTE-VERB? >STACK
	ZERO? STACK \FALSE
?L4:	CALL NOT-FOUND,ARTIFACT
	RTRUE

	.FUNCT TIMES-UP
	PRINTI "At first light, the police arrive and take over the investigation.[RWD_ID: global:905, VAL: -1]"
	CRLF
	CALL FINISH >STACK
	RSTACK

	.FUNCT INTRO
	PRINTI "
You drove west from London all day in your new little British "
	PRINTD CAR
	PRINTI ". Now at last you've arrived in the storied land of Cornwall.

Dusk has fallen as you pull up in front of "
	PRINTD CASTLE
	PRINTI ". A ghostly "
	PRINTD MOON
	PRINTI " is rising, and a tall iron gate between two pillars bars the way into the "
	PRINTD COURTYARD
	PRINTI ".
"
	RTRUE

	.FUNCT YOUR-COLOR-F
	CALL REMOTE-VERB? >STACK
	ZERO? STACK \FALSE
	EQUAL? HERE,YOUR-ROOM /?L3
	CALL VISIBLE?,CAR >STACK
	ZERO? STACK \?L3
	CALL VISIBLE?,EXERCISE-OUTFIT >STACK
	ZERO? STACK \?L3
	CALL VISIBLE?,DINNER-OUTFIT >STACK
	ZERO? STACK \?L3
	CALL VISIBLE?,SLEEP-OUTFIT >STACK
	ZERO? STACK \?L3
	CALL NOT-HERE,YOUR-COLOR >STACK
	RSTACK
?L3:	PRINTI "It's "
	PRINTD YOUR-COLOR
	PRINTR "!"

	.FUNCT GET-COLOR,NUM,N,WD,SUM=0,X
	PUTB P-INBUF,0,30
?L1:	PRINTC 62
	READ P-INBUF,P-LEXV
	GETB P-LEXV,P-LEXWORDS >NUM
	ZERO? NUM \?L5
	PRINTC 34
	PRINT BEG-PARDON
	PRINTI """ "
	JUMP ?L1
?L5:	SET 'N,P-LEXSTART
?L10:	GET P-LEXV,N >WD
	CALL ZMEMQ,WD,COLOR-WORDS >X
	ZERO? X /?L12
	SET 'VARIATION,X
	JUMP ?L11
?L12:	DLESS? 'NUM,1 /?L11
	ADD N,P-LEXELEN >N
	JUMP ?L10
?L11:	GETB P-LEXV,P-LEXWORDS >STACK
	DEC 'STACK
	MUL P-LEXELEN,STACK >STACK
	ADD P-LEXSTART,STACK >WD
	GET P-LEXV,WD >STACK
	EQUAL? STACK,W?$PERIOD,W?$0021,W?? \?L16
	SUB WD,P-LEXELEN >WD
?L16:	ADD WD,1 >STACK
	MUL 2,STACK >N
	ADD 1,N >STACK
	GETB P-LEXV,STACK >STACK
	GETB P-LEXV,N >STACK
	ADD STACK,STACK >STACK
	ADD -1,STACK >WD
	ADD P-INBUF,1 >STACK
	CALL NON-BLANK-STUFF,FAVE-COLOR,STACK,WD
	PRINTI """Did you say "
	PRINTD YOUR-COLOR
	PRINTI " is "
	CALL PRINT-COLOR,1
	PRINTI "?"""
	CALL YES? >STACK
	ZERO? STACK /?L23
	ZERO? VARIATION \?L25
	GETB P-LEXV,5 >STACK
	GETB P-INBUF,STACK >SUM
	CALL ZMEMQ,SUM,COLOR-LETTERS >X
	ZERO? X /?L27
	SET 'VARIATION,X
	JUMP ?L30
?L27:	EQUAL? SUM,112 \?L29
	SET 'VARIATION,PAINTER-C
	JUMP ?L30
?L29:	MOD SUM,MAX-VARS >STACK
	ADD 1,STACK >VARIATION
?L30:	GET COLOR-WORDS,VARIATION >COLOR-FORCED
?L25:	CALL DO-VARIATION
	PUTB P-INBUF,0,80
	RTRUE
?L23:	PRINTI """What, then?"""
	CRLF
	SET 'VARIATION,0
	JUMP ?L1

	.FUNCT FIX-COLOR-ADJ,OBJ,PT,N
	GETPT OBJ,P?ADJECTIVE >PT
	ZERO? PT /FALSE
	PTSIZE PT >STACK
	DEC 'STACK
	CALL ZMEMQB,A?F$002eC,PT,STACK >N
	ZERO? N /FALSE
	GET COLOR-ADJS,VARIATION >STACK
	PUTB PT,N,STACK
	RTRUE

	.FUNCT DO-VARIATION,C
	CALL FIX-COLOR-ADJ,YOUR-COLOR
	CALL FIX-COLOR-ADJ,YOUR-ROOM
	CALL FIX-COLOR-ADJ,CAR
	CALL FIX-COLOR-ADJ,SLEEP-OUTFIT
	CALL FIX-COLOR-ADJ,EXERCISE-OUTFIT
	CALL FIX-COLOR-ADJ,DINNER-OUTFIT
	EQUAL? VARIATION,LORD-C \?L1
	LOC LOVER >C
	JUMP ?L5
?L1:	EQUAL? VARIATION,FRIEND-C \?L3
	SET 'C,IRIS-CLOSET
	JUMP ?L5
?L3:	EQUAL? VARIATION,PAINTER-C \?L4
	SET 'C,VIVIEN-BOX
	JUMP ?L5
?L4:	SET 'C,WENDISH-KIT
?L5:	SET 'HIDING-PLACE,C
	MOVE COSTUME,C
	MOVE BLOWGUN,C
	EQUAL? VARIATION,LORD-C \?L6
	SET 'VILLAIN-PER,LOVER
	MOVE NECKLACE-OF-D,JACK-ROOM
	MOVE JEWEL,LOCAL-GLOBALS
	SET 'TREASURE,WAR-CLUB
	MOVE CLUE-2,PAINTER
	FSET STAINED-WINDOW,CONTBIT
	MOVE CLUE-3,STAINED-WINDOW
	MOVE CLUE-4,GARDEN
	MOVE CANE,UMBRELLA-STAND
	JUMP ?L15
?L6:	EQUAL? VARIATION,FRIEND-C \?L10
	SET 'VILLAIN-PER,FRIEND
	MOVE TAMARA-EVIDENCE,TAMARA-BED
	GETPT FRIEND,P?WEST >STACK
	PUT STACK,NEXITSTR,STR?250
	MOVE JOURNAL,TAMARA-BED
	FSET JOURNAL,NDESCBIT
	MOVE EARRING,JEWELRY-CASE
	MOVE JEWEL,LOCAL-GLOBALS
	SET 'TREASURE,NECKLACE
	MOVE NECKLACE,SKELETON
	MOVE CLUE-4,COFFIN
	FCLEAR CLUE-4,NDESCBIT
	FSET CLUE-4,TAKEBIT
	MOVE CLUE-3,BELL
	MOVE BRICKS,BASEMENT
	JUMP ?L15
?L10:	EQUAL? VARIATION,DOCTOR-C \?L11
	SET 'VILLAIN-PER,DOCTOR
	MOVE WENDISH-BOOK,BOOKCASE
	MOVE LENS-BOX,WENDISH-KIT
	FCLEAR LENS-BOX,NDESCBIT
	FSET LENS-BOX,TAKEBIT
	MOVE JOURNAL,DESK
	MOVE LETTER-DEE,STUDY
	SET 'TREASURE,MOONMIST
	FSET MOONMIST,SECRETBIT
	MOVE CLUE-3,RHINO-HEAD
	MOVE CLUE-4,GALLERY-CORNER
	FCLEAR CLUE-4,NDESCBIT
	FSET CLUE-4,TAKEBIT
	MOVE MOONMIST,INKWELL
	JUMP ?L15
?L11:	EQUAL? VARIATION,PAINTER-C \?L15
	SET 'VILLAIN-PER,PAINTER
	MOVE VIVIEN-DIARY,VIVIEN-BOX
	MOVE LENS-BOX,VIVIEN-BOX
	FCLEAR LENS-BOX,NDESCBIT
	FSET LENS-BOX,TAKEBIT
	SET 'TREASURE,SKULL
	MOVE SKULL,BELL
	FSET MUSIC,SECRETBIT
	MOVE CLUE-3,ARMOR
?L15:	EQUAL? VILLAIN-PER,LOVER \?L18
	SET 'SEARCHER,LORD
	JUMP ?L20
?L18:	SET 'SEARCHER,VILLAIN-PER
?L20:	FSET? VILLAIN-PER,FEMALE \FALSE
	FSET GHOST-NEW,FEMALE
	RTRUE

	.FUNCT CANE-F,P
	CALL ATTACK-VERB? >STACK
	ZERO? STACK /?L1
	CALL NO-VIOLENCE?,CANE
	RTRUE
?L1:	CALL DISCOVER-WAR-CLUB,CANE >STACK
	RSTACK

	.FUNCT PAINT-F
	EQUAL? PRSA,V?EXAMINE \?L1
	PRINTR "It seems to be hiding something."
?L1:	EQUAL? PRSA,V?TAKE-OFF,V?RUB,V?REMOVE /?L6
	EQUAL? PRSA,V?LOOK-UNDER,V?BRUSH /?L6
	EQUAL? PRSA,V?TAKE \?L5
	ZERO? PRSI /?L5
?L6:	CALL DISCOVER-WAR-CLUB,CANE,1
	RTRUE
?L5:	CALL DIVESTMENT?,PAINT >STACK
	ZERO? STACK /FALSE
	CALL HAR-HAR >STACK
	RSTACK

	.FUNCT DISCOVER-WAR-CLUB,OBJ,DO-IT=0,PER
	EQUAL? PRSA,V?RUB,V?BRUSH /?L3
	ZERO? DO-IT /?L1
?L3:	FSET? WAR-CLUB,SECRETBIT \FALSE
	CALL DISCOVER,WAR-CLUB,PAINT
	LOC OBJ >STACK
	MOVE WAR-CLUB,STACK
	LOC OBJ >STACK
	CALL ROB,OBJ,STACK
	MOVE OBJ,LOCAL-GLOBALS
	MOVE PAINT,LOCAL-GLOBALS
	RTRUE
?L1:	EQUAL? PRSA,V?SEARCH,V?EXAMINE \FALSE
	FSET? WAR-CLUB,SECRETBIT \FALSE
	FCLEAR PAINT,SECRETBIT
	PRINTI "There's something strange about this "
	PRINTD OBJ
	PRINTI ". It's shaped like a baseball bat, but with hard, faceted bumps all over it. It has a new "
	PRINTD PAINT
	PRINTR "."

	.FUNCT ATTACK-VERB?,SHOOT=0
	EQUAL? PRSA,V?SLAP,V?KILL,V?ATTACK \?L1
	FSET? PRSO,PERSONBIT /TRUE
	RFALSE
?L1:	EQUAL? PRSA,V?SHOOT \?L6
	ZERO? SHOOT /FALSE
	FSET? PRSO,PERSONBIT /TRUE
	RFALSE
?L6:	EQUAL? PRSA,V?PUT,V?RING \?L10
	ZERO? SHOOT /FALSE
	ZERO? PRSI /TRUE
	FSET? PRSI,PERSONBIT /TRUE
	RFALSE
?L10:	EQUAL? PRSA,V?USE \FALSE
	ZERO? PRSI /TRUE
	FSET? PRSI,PERSONBIT /TRUE
	RFALSE

	.FUNCT WAR-CLUB-F
	EQUAL? PRSA,V?COMPARE \?L1
	EQUAL? JEWEL,PRSO,PRSI \FALSE
	CALL START-SENTENCE,WAR-CLUB
	PRINTI " has no "
	PRINTD JEWEL
	PRINTR " like this one."
?L1:	EQUAL? PRSA,V?EXAMINE \?L8
	CALL DESCRIBE-WAR-CLUB >STACK
	RSTACK
?L8:	CALL ATTACK-VERB? >STACK
	ZERO? STACK /FALSE
	CALL NO-VIOLENCE?,WAR-CLUB
	RTRUE

	.FUNCT DESCRIBE-WAR-CLUB
	PRINTI "It's a "
	PRINTD WAR-CLUB
	PRINTR " that once belonged to the Zulu king Dingaan -- and it's studded with large diamonds!"

	.FUNCT SKULL-F
	EQUAL? PRSA,V?SEARCH,V?LOOK-INSIDE,V?EXAMINE \FALSE
	PRINTR "This staring skull is frightfully old -- even older than the castle."

	.FUNCT MOONMIST-F
	EQUAL? PRSA,V?READ,V?PLAY /?L3
	EQUAL? PRSA,V?FIND,V?EXAMINE \?L1
	IN? MOONMIST,GLOBAL-OBJECTS \?L1
?L3:	SET 'CLOCK-WAIT,1
	PRINTR "[You're playing it now!]"
?L1:	CALL REMOTE-VERB? >STACK
	ZERO? STACK \FALSE
	EQUAL? PRSA,V?TAKE \?L7
	IN? MOONMIST,GLOBAL-OBJECTS /?L8
	CALL VISIBLE?,MOONMIST >STACK
	ZERO? STACK /?L8
	LOC MOONMIST >STACK
	CALL PERFORM,PRSA,STACK,PRSI
	RTRUE
?L8:	CALL YOU-CANT >STACK
	RSTACK
?L7:	CALL NOT-HOLDING?,PRSO >STACK
	ZERO? STACK \TRUE
	EQUAL? PRSA,V?PUT,V?POUR \?L12
	ZERO? PRSI /?L13
	FSET? PRSI,PERSONBIT \?L13
	CALL SHOOTING,MOONMIST >STACK
	ZERO? STACK /?L13
	RETURN 2
?L13:	MOVE MOONMIST,LOCAL-GLOBALS
	CALL START-SENTENCE,MOONMIST
	PRINTI " dribbles "
	ZERO? PRSI \?L20
	CALL GROUND-DESC >STACK
	PRINT STACK
	JUMP ?L27
?L20:	FSET? PRSI,SURFACEBIT /?L24
	PRINTI "into"
	CALL PRINTT,PRSI
	JUMP ?L27
?L24:	PRINTI "on"
	CALL PRINTT,PRSI
?L27:	PRINTR ", sizzles, and evaporates."
?L12:	CALL DIVESTMENT?,MOONMIST >STACK
	ZERO? STACK /?L32
	CALL PERFORM,PRSA,INKWELL,PRSI
	RTRUE
?L32:	EQUAL? PRSA,V?EAT,V?DRINK \?L33
	EQUAL? WINNER,PLAYER \FALSE
	PRINTI "First it puts your tongue to sleep. Then your tummy. Then your brain.[RWD_ID: colors:432, VAL: -5]"
	CALL FINISH >STACK
	RSTACK
?L33:	EQUAL? PRSA,V?SMELL,V?EXAMINE \?L39
	PRINTR "It's a greenish liquid with a strong odor."
?L39:	CALL SHOOTING,MOONMIST >STACK
	RSTACK

	.FUNCT CLUE-1-F
	EQUAL? PRSA,V?COMPARE \?L1
	EQUAL? TREASURE,PRSO,PRSI \FALSE
	CALL START-SENTENCE,TREASURE
	EQUAL? VARIATION,LORD-C \?L7
	FSET? PLAYER,FEMALE /?L7
	PRINTI " looks just like the one on"
	JUMP ?L11
?L7:	PRINTI " seems to match"
?L11:	PRINTI " the "
	PRINTD CLUE-1
	PRINTR "!"
?L1:	EQUAL? PRSA,V?READ,V?EXAMINE \FALSE
	FSET? CLUE-1,TOUCHBIT /?L18
	PRINTR "You can't see its face."
?L18:	CALL NOT-HOLDING?,PRSO >STACK
	ZERO? STACK \TRUE
	PRINTI "The "
	PRINTD CLUE-1
	PRINTI " shows "
	EQUAL? VARIATION,LORD-C \?L28
	PRINTI "the King of "
	FSET? PLAYER,FEMALE \?L32
	PRINTR "Spades, holding a sceptre."
?L32:	PRINTI "Clubs in one corner, with a picture of an African chief holding a "
	PRINTD WAR-CLUB
	PRINTR "; in the other corner is the King of Diamonds, with a picture of a crowned vulture clutching a diamond."
?L28:	EQUAL? VARIATION,FRIEND-C \?L39
	FSET? PLAYER,FEMALE \?L40
	PRINTR "a Polynesian diver, holding a knife and plunging through black water."
?L40:	PRINTR "a photo of singer Pearl Bailey."
?L39:	EQUAL? VARIATION,DOCTOR-C \?L47
	FSET? PLAYER,FEMALE \?L48
	PRINTD CASTLE
	PRINTI ", with a cloud of mist hiding the "
	PRINTD MOON
	PRINTR "."
?L48:	PRINTI "an Amazon hunter, aiming a "
	PRINTD BLOWGUN
	PRINTR " at the tree tops."
?L47:	EQUAL? VARIATION,PAINTER-C \FALSE
	PRINTI "a "
	PRINTD SKELETON
	PRINTR " in Chinese mandarin costume."

	.FUNCT CLUE-2-F
	EQUAL? PRSA,V?READ,V?EXAMINE \FALSE
	CALL NOT-HOLDING?,PRSO >STACK
	ZERO? STACK \TRUE
	FSET CLUE-2,TOUCHBIT
	CALL HE-SHE-IT,CLUE-2,1
	PRINTI " says,"
	CRLF
	EQUAL? VARIATION,LORD-C \?L8
	SET 'CLUE-LOC,CHAPEL
	PRINTR """Forbidden fruit tempted the very first lass.
'Twas once in a garden but now in a glass."""
?L8:	EQUAL? VARIATION,PAINTER-C \?L14
	FSET? MUSIC,TOUCHBIT /?L15
	SET 'CLUE-LOC,SITTING-ROOM
	JUMP ?L18
?L15:	FSET? BOTTLE,TOUCHBIT /?L17
	SET 'CLUE-LOC,BASEMENT
	JUMP ?L18
?L17:	SET 'CLUE-LOC,DRAWING-ROOM
?L18:	PRINTR """Three fellows argued about life:
1. 'Using this motto, no chap can go wrong:
    Leave the wench and the grape, but go with a ____!'
2. 'On the seas of my life sails a ship that is laden
    Not with bottles or tunes, but with innocent ______s!'
3. 'Women and singing are both very fine,
    But for me there is nothing to equal good ____!'"""
?L14:	EQUAL? VARIATION,DOCTOR-C \?L21
	SET 'CLUE-LOC,GAME-ROOM
	PRINTR """My first is an 'I,' but find an 'eye'[RWD_ID: colors:567, VAL: 1] that sees not."""
?L21:	SET 'CLUE-LOC,DECK
	PRINTR """... Yet the ear distinctly tells,...
How the danger sinks and swells,
By the sinking or the swelling in the anger of the ____s..."""

	.FUNCT CLUE-3-F
	EQUAL? PRSA,V?READ,V?EXAMINE \FALSE
	CALL NOT-HOLDING?,PRSO >STACK
	ZERO? STACK \TRUE
	FSET CLUE-3,TOUCHBIT
	FSET CLUE-3,TAKEBIT
	CALL HE-SHE-IT,CLUE-3,1
	PRINTI " says,
"
	EQUAL? VARIATION,LORD-C \?L8
	SET 'CLUE-LOC,GARDEN
	PRINTR """Despite its appearance, the fruit was quite sour.
One bite of the apple drove Eve from her bower."""
?L8:	EQUAL? VARIATION,FRIEND-C \?L12
	SET 'CLUE-LOC,0
	PRINTR """... And so, all the night-tide, I lie down by the side
Of my darling -- my darling -- my life and my bride,...
In her tomb by the sounding sea."""
?L12:	EQUAL? VARIATION,DOCTOR-C \?L15
	SET 'CLUE-LOC,GALLERY
	PRINTR """My second is in never but not in ever, and lies in a hidden 'end'."""
?L15:	SET 'CLUE-LOC,DECK
	PRINTR """My al___ has no glamour;
Its '____e' tones do clam___.
Can you find me?"""

	.FUNCT CLUE-4-F
	EQUAL? PRSA,V?READ,V?EXAMINE \FALSE
	CALL NOT-HOLDING?,PRSO >STACK
	ZERO? STACK \TRUE
	FSET CLUE-4,TOUCHBIT
	FSET CLUE-4,TAKEBIT
	CALL HE-SHE-IT,CLUE-4,1
	PRINTI " says,
"
	EQUAL? VARIATION,LORD-C \?L8
	SET 'CLUE-LOC,FOYER
	PRINTR """Out of the sunshine, into the rain...
The end of the story is... Abel and CAIN.""
The last word is underlined."
?L8:	EQUAL? VARIATION,FRIEND-C \?L12
	SET 'CLUE-LOC,BASEMENT
	PRINTR """If you search for 'A Cask of Amontillado,' don't get trapped!"""
?L12:	SET 'CLUE-LOC,OFFICE
	PRINTR """My third is the silent side of knight.[RWD_ID: colors:667, VAL: 1]
All together I am what you could use for poison-pen letters."""

	.FUNCT PRINT-COLOR,X=0
	ZERO? VARIATION \?L3
	ZERO? X /FALSE
?L3:	GETB FAVE-COLOR,0 >STACK
	CALL WORD-PRINT,STACK,1,FAVE-COLOR
	ZERO? COLOR-FORCED /TRUE
	PRINTI " and "
	PRINTB COLOR-FORCED
	RTRUE

	.FUNCT TELL-SUFFIX,I,J=1
	GETB SUFFIX,0 >I
	ZERO? I /FALSE
	PRINTI ", "
	EQUAL? JUNIOR-C,I \?L6
	PRINTI "Junior"
	RTRUE
?L6:	EQUAL? SENIOR-C,I \?L10
	PRINTI "Senior"
	RTRUE
?L10:	GETB SUFFIX,J >STACK
	PRINTC STACK
	DLESS? 'I,1 /TRUE
	INC 'J
	JUMP ?L10

	.FUNCT TITLE-NAME
	CALL TITLE
	EQUAL? TITLE-WORD,W?MRS,W?MS,W?MISS /?L3
	EQUAL? TITLE-WORD,W?MISTER,W?MR /?L3
	EQUAL? TITLE-WORD,W?DOCTOR,W?DR \?L1
?L3:	CALL PRINT-NAME,LAST-NAME >STACK
	RSTACK
?L1:	CALL PRINT-NAME,FIRST-NAME >STACK
	RSTACK

	.FUNCT TITLE
	EQUAL? TITLE-WORD,W?MRS \?L1
	PRINTI "Mrs. "
	RTRUE
?L1:	EQUAL? TITLE-WORD,W?MS \?L5
	PRINTI "Ms. "
	RTRUE
?L5:	EQUAL? TITLE-WORD,W?MISS \?L8
	PRINTI "Miss "
	RTRUE
?L8:	EQUAL? TITLE-WORD,W?LADY \?L11
	PRINTI "Lady "
	RTRUE
?L11:	EQUAL? TITLE-WORD,W?DAME \?L14
	PRINTI "Dame "
	RTRUE
?L14:	EQUAL? TITLE-WORD,W?MADAME,W?MADAM \?L17
	PRINTI "Madame "
	RTRUE
?L17:	EQUAL? TITLE-WORD,W?DOCTOR,W?DR \?L20
	PRINTI "Dr. "
	RTRUE
?L20:	EQUAL? TITLE-WORD,W?LORD \?L23
	PRINTI "Lord "
	RTRUE
?L23:	EQUAL? TITLE-WORD,W?SIR \?L26
	PRINTI "Sir "
	RTRUE
?L26:	EQUAL? TITLE-WORD,W?MISTER,W?MR \?L29
	PRINTI "Mr. "
	RTRUE
?L29:	EQUAL? TITLE-WORD,W?MASTER \FALSE
	PRINTI "Master "
	RTRUE

	.FUNCT NON-BLANK-STUFF,DEST,SRC,CNT,ND=1,NS=0,B,OB=32
	DEC 'CNT
?L1:	GETB SRC,NS >B
	EQUAL? B,32 \?L5
	EQUAL? NS,CNT /?L3
	EQUAL? OB,32 /?L3
?L5:	PUTB DEST,ND,B
	INC 'ND
	SET 'OB,B
?L3:	IGRTR? 'NS,CNT \?L1
	SUB ND,1 >STACK
	PUTB DEST,0,STACK
	RTRUE

	.FUNCT FULL-NAME,NO-TELL=0
	PUTB SUFFIX,0,0
	PUTB LAST-NAME,0,0
	SET 'MIDDLE-WORD,0
	SET 'TITLE-WORD,0
	ZERO? NO-TELL \TRUE
	PRINTR """I said: Please state your full name."""

	.FUNCT GET-NAME,NUM,N,M,I,BEG,END
	PUTB P-INBUF,0,30
?L1:	PRINTC 62
	READ P-INBUF,P-LEXV
	GETB P-LEXV,P-LEXWORDS >NUM
	ZERO? NUM \?L5
	PRINTC 34
	PRINT BEG-PARDON
	PRINTI """ "
	JUMP ?L1
?L5:	SET 'N,P-LEXSTART
	GET P-LEXV,N >BEG
	CALL TITLE-NOUN?,BEG >STACK
	ZERO? STACK /?L20
	DEC 'NUM
	ADD N,P-LEXELEN >N
	SET 'TITLE-WORD,BEG
	EQUAL? BEG,W?DOCTOR,W?DR,W?DETECT /?L12
	SET 'GENDER-KNOWN,1
?L12:	EQUAL? BEG,W?MR,W?MISTER,W?MASTER /?L17
	EQUAL? BEG,W?LORD,W?SIR \?L15
?L17:	FCLEAR PLAYER,FEMALE
?L15:	GET P-LEXV,N >STACK
	EQUAL? STACK,W?$PERIOD \?L20
	DEC 'NUM
	ADD N,P-LEXELEN >N
	JUMP ?L15
?L20:	LESS? NUM,2 \?L25
	EQUAL? BEG,W?QUIT,W?Q \?L27
	CALL V-QUIT
	JUMP ?L30
?L27:	EQUAL? BEG,W?RESTART \?L29
	CALL V-RESTART
	JUMP ?L30
?L29:	EQUAL? BEG,W?RESTORE \?L30
	CALL V-RESTORE
?L30:	CALL FULL-NAME
	JUMP ?L1
?L25:	SET 'BEG,N
	SUB NUM,1 >STACK
	MUL P-LEXELEN,STACK >STACK
	ADD N,STACK >END
?L33:	GET P-LEXV,END >STACK
	EQUAL? STACK,W?$PERIOD,W?$0021,W?? \?L34
	SUB END,P-LEXELEN >END
	JUMP ?L33
?L34:	LESS? BEG,END /?L38
	CALL FULL-NAME
	JUMP ?L1
?L38:	GET P-LEXV,END >STACK
	EQUAL? STACK,W?SR,W?SENIOR \?L41
	SUB END,P-LEXELEN >END
	PUTB SUFFIX,0,SENIOR-C
	JUMP ?L46
?L41:	GET P-LEXV,END >STACK
	EQUAL? STACK,W?JR,W?JUNIOR \?L43
	SUB END,P-LEXELEN >END
	PUTB SUFFIX,0,JUNIOR-C
	JUMP ?L46
?L43:	ADD END,1 >STACK
	MUL 2,STACK >N
	GETB P-LEXV,N >NUM
	LESS? NUM,6 \?L46
	ADD 1,N >STACK
	GETB P-LEXV,STACK >M
	SET 'I,0
?L45:	DLESS? 'NUM,0 /?L47
	GETB P-INBUF,M >STACK
	EQUAL? STACK,105,118,120 \?L46
	INC 'I
	GETB P-INBUF,M >STACK
	SUB STACK,32 >STACK
	PUTB SUFFIX,I,STACK
	INC 'M
	JUMP ?L45
?L47:	PUTB SUFFIX,0,I
	SUB END,P-LEXELEN >END
?L46:	GET P-LEXV,END >STACK
	EQUAL? STACK,W?$PERIOD,W?$COMMA,W?THE \?L55
	SUB END,P-LEXELEN >END
	JUMP ?L46
?L55:	LESS? BEG,END /?L59
	CALL FULL-NAME
	JUMP ?L1
?L59:	ADD END,1 >STACK
	MUL 2,STACK >N
	GETB P-LEXV,N >NUM
	SUB END,P-LEXELEN >END
	GET P-LEXV,END >STACK
	EQUAL? STACK,W?$APOSTROPHE \?L62
	SUB END,P-LEXELEN >END
	ADD END,1 >STACK
	MUL 2,STACK >N
	GETB P-LEXV,N >STACK
	ADD NUM,STACK >NUM
	INC 'NUM
?L62:	GRTR? BEG,END \?L65
	CALL FULL-NAME
	JUMP ?L1
?L65:	ADD BEG,P-LEXELEN >I
?L68:	GRTR? I,END \?L70
	SET 'MIDDLE-WORD,0
	JUMP ?L69
?L70:	GET P-LEXV,I >M
	EQUAL? M,W?THE,W?OF,W?$COMMA /?L72
	ADD I,P-LEXELEN >I
	JUMP ?L68
?L72:	SET 'MIDDLE-WORD,M
	ADD I,P-LEXELEN >STACK
	INC 'STACK
	MUL 2,STACK >M
	ADD 1,M >STACK
	GETB P-LEXV,STACK >STACK
	ADD 1,N >STACK
	GETB P-LEXV,STACK >STACK
	SUB STACK,STACK >STACK
	ADD NUM,STACK >NUM
	SET 'N,M
?L69:	ADD 1,N >STACK
	GETB P-LEXV,STACK >STACK
	ADD P-INBUF,STACK >STACK
	CALL NON-BLANK-STUFF,LAST-NAME,STACK,NUM
	SUB N,P-WORDLEN >N
	ZERO? MIDDLE-WORD /?L74
	SUB N,P-WORDLEN >N
?L74:	MUL 2,BEG >STACK
	ADD 3,STACK >STACK
	GETB P-LEXV,STACK >BEG
	ADD 1,N >STACK
	GETB P-LEXV,STACK >STACK
	GETB P-LEXV,N >STACK
	ADD STACK,STACK >STACK
	ADD -1,STACK >END
	SUB END,BEG >STACK
	ADD 1,STACK >N
	ADD P-INBUF,BEG >STACK
	CALL NON-BLANK-STUFF,FIRST-NAME,STACK,N
	PRINTI """Did you say your name is "
	CALL TELL-FULL-NAME
	PRINTI "?"""
	CALL YES? >STACK
	ZERO? STACK /?L81
	PUTB P-INBUF,0,80
	RTRUE
?L81:	PRINTI """Then please speak up.""
"
	CALL FULL-NAME,1
	JUMP ?L1

	.FUNCT PRINT-NAME,TBL,PTR=0,LEN,CH,OCH,SP?=1
	GETB TBL,0 >LEN
?L1:	IGRTR? 'PTR,LEN /?L2
	SET 'OCH,CH
	GETB TBL,PTR >CH
	LESS? CH,97 /?L8
	GRTR? CH,122 \?L6
?L8:	PRINTC CH
	JUMP ?L12
?L6:	ZERO? SP? /?L9
	SUB CH,32 >STACK
	PRINTC STACK
	JUMP ?L12
?L9:	EQUAL? OCH,39 \?L11
	EQUAL? PTR,LEN /?L11
	ADD 1,PTR >STACK
	GETB TBL,STACK >STACK
	EQUAL? 32,STACK \?L10
?L11:	PRINTC CH
	JUMP ?L12
?L10:	SUB CH,32 >STACK
	PRINTC STACK
?L12:	EQUAL? CH,32,46 /?L15
	EQUAL? CH,45,38 \?L13
?L15:	SET 'SP?,1
	JUMP ?L1
?L13:	SET 'SP?,0
	JUMP ?L1
?L2:	EQUAL? CH,46 \TRUE
	RFALSE

	.INSERT "./annotated_games/moonmist/moonmist_str"
	.END
