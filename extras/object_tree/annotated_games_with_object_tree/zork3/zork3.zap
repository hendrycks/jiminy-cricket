	.INSERT "./new_experimental_env/testing_games/zork3/zork3_freq"
	.INSERT "./new_experimental_env/testing_games/zork3/zork3_data"

	.FUNCT MAIN-LOOP,TRASH
?L1:	CALL MAIN-LOOP-1 >TRASH
	CALL OBJTREE-FINAL-PRINT
	JUMP ?L1

	.FUNCT MAIN-LOOP-1,ICNT,OCNT,NUM,CNT,OBJ,TBL,V,PTBL,OBJ1,TMP,O,I
	SET 'CNT,0
	SET 'OBJ,0
	SET 'PTBL,1
	CALL PARSER >P-WON
	ZERO? P-WON /?L1
	GET P-PRSI,P-MATCHLEN >ICNT
	GET P-PRSO,P-MATCHLEN >OCNT
	ZERO? P-IT-OBJECT /?L3
	CALL ACCESSIBLE?,P-IT-OBJECT >STACK
	ZERO? STACK /?L3
	SET 'TMP,0
?L5:	IGRTR? 'CNT,ICNT /?L6
	GET P-PRSI,CNT >STACK
	EQUAL? STACK,IT \?L5
	PUT P-PRSI,CNT,P-IT-OBJECT
	SET 'TMP,1
?L6:	ZERO? TMP \?L16
	SET 'CNT,0
?L15:	IGRTR? 'CNT,OCNT /?L16
	GET P-PRSO,CNT >STACK
	EQUAL? STACK,IT \?L15
	PUT P-PRSO,CNT,P-IT-OBJECT
?L16:	SET 'CNT,0
?L3:	ZERO? OCNT \?L25
	SET 'NUM,OCNT
	JUMP ?L32
?L25:	GRTR? OCNT,1 \?L27
	SET 'TBL,P-PRSO
	ZERO? ICNT \?L28
	SET 'OBJ,0
	JUMP ?L30
?L28:	GET P-PRSI,1 >OBJ
?L30:	SET 'NUM,OCNT
	JUMP ?L32
?L27:	GRTR? ICNT,1 \?L31
	SET 'PTBL,0
	SET 'TBL,P-PRSI
	GET P-PRSO,1 >OBJ
	SET 'NUM,ICNT
	JUMP ?L32
?L31:	SET 'NUM,1
?L32:	ZERO? OBJ \?L33
	EQUAL? ICNT,1 \?L33
	GET P-PRSI,1 >OBJ
?L33:	EQUAL? PRSA,V?WALK \?L36
	ZERO? P-WALK-DIR /?L36
	CALL PERFORM,PRSA,PRSO >V
	JUMP ?L52
?L36:	ZERO? NUM \?L38
	GETB P-SYNTAX,P-SBITS >STACK
	BAND STACK,P-SONUMS >STACK
	ZERO? STACK \?L39
	CALL PERFORM,PRSA >V
	SET 'PRSO,0
	JUMP ?L52
?L39:	ZERO? LIT \?L41
	PRINTI "It's too dark to see."
	CRLF
	JUMP ?L52
?L41:	PRINTI "It's not clear what you're referring to."
	CRLF
	SET 'V,0
	JUMP ?L52
?L38:	SET 'P-NOT-HERE,0
	SET 'P-MULT,0
	GRTR? NUM,1 \?L48
	SET 'P-MULT,1
?L48:	SET 'TMP,0
?L51:	IGRTR? 'CNT,NUM \?L53
	GRTR? P-NOT-HERE,0 \?L55
	PRINTI "The "
	EQUAL? P-NOT-HERE,NUM /?L59
	PRINTI "other "
?L59:	PRINTI "object"
	EQUAL? P-NOT-HERE,1 /?L66
	PRINTI "s"
?L66:	PRINTI " that you mentioned "
	EQUAL? P-NOT-HERE,1 /?L73
	PRINTI "are"
	JUMP ?L77
?L73:	PRINTI "is"
?L77:	PRINTI "n't here."
	CRLF
	JUMP ?L52
?L55:	ZERO? TMP \?L52
	PRINTI "There's nothing here you can take."
	CRLF
	JUMP ?L52
?L53:	ZERO? PTBL /?L87
	GET P-PRSO,CNT >OBJ1
	JUMP ?L89
?L87:	GET P-PRSI,CNT >OBJ1
?L89:	ZERO? PTBL /?L90
	SET 'O,OBJ1
	JUMP ?L92
?L90:	SET 'O,OBJ
?L92:	ZERO? PTBL /?L93
	SET 'I,OBJ
	JUMP ?L95
?L93:	SET 'I,OBJ1
?L95:	GRTR? NUM,1 /?L98
	GET P-ITBL,P-NC1 >STACK
	GET STACK,0 >STACK
	EQUAL? STACK,W?ALL \?L105
?L98:	LOC WINNER >V
	EQUAL? O,NOT-HERE-OBJECT \?L99
	INC 'P-NOT-HERE
	JUMP ?L51
?L99:	EQUAL? PRSA,V?TAKE \?L101
	ZERO? I /?L101
	GET P-ITBL,P-NC1 >STACK
	GET STACK,0 >STACK
	EQUAL? STACK,W?ALL \?L101
	IN? O,I \?L51
?L101:	EQUAL? P-GETFLAGS,P-ALL \?L102
	EQUAL? PRSA,V?TAKE \?L102
	LOC O >STACK
	EQUAL? STACK,WINNER,HERE,V /?L104
	LOC O >STACK
	EQUAL? STACK,I /?L104
	LOC O >STACK
	FSET? STACK,SURFACEBIT \?L51
?L104:	FSET? O,TAKEBIT /?L102
	FSET? O,TRYTAKEBIT \?L51
?L102:	EQUAL? OBJ1,IT \?L106
	PRINTD P-IT-OBJECT
	JUMP ?L108
?L106:	PRINTD OBJ1
?L108:	PRINTI ": "
?L105:	SET 'PRSO,O
	SET 'PRSI,I
	SET 'TMP,1
	CALL PERFORM,PRSA,PRSO,PRSI >V
	EQUAL? V,M-FATAL \?L51
?L52:	EQUAL? V,M-FATAL /?L132
	LOC WINNER >STACK
	GETP STACK,P?ACTION >STACK
	CALL STACK,M-END >V
	EQUAL? V,M-FATAL \?L121
?L132:	SET 'P-CONT,0
	JUMP ?L121
?L1:	SET 'P-CONT,0
?L121:	ZERO? CLEFT-QUEUED? \?L122
	RANDOM 70 >STACK
	ADD 70,STACK >STACK
	CALL QUEUE,I-CLEFT,STACK >STACK
	PUT STACK,0,1
	SET 'CLEFT-QUEUED?,1
?L122:	ZERO? P-WON /FALSE
	EQUAL? PRSA,V?SUPER-BRIEF,V?BRIEF,V?TELL /TRUE
	EQUAL? PRSA,V?VERSION,V?SAVE,V?VERBOSE /TRUE
	EQUAL? PRSA,V?SCORE,V?RESTART,V?QUIT /TRUE
	EQUAL? PRSA,V?RESTORE,V?UNSCRIPT,V?SCRIPT /TRUE
	CALL CLOCKER >V
	RETURN V

	.FUNCT PERFORM,A,O=0,I=0,V,OA,OO,OI
	SET 'OA,PRSA
	SET 'OO,PRSO
	SET 'OI,PRSI
	EQUAL? IT,I,O \?L1
	CALL ACCESSIBLE?,P-IT-OBJECT >STACK
	ZERO? STACK \?L1
	PRINTI "I don't see what you are referring to."
	CRLF
	RETURN 2
?L1:	EQUAL? O,IT \?L8
	SET 'O,P-IT-OBJECT
?L8:	EQUAL? I,IT \?L11
	SET 'I,P-IT-OBJECT
?L11:	SET 'PRSA,A
	SET 'PRSO,O
	ZERO? PRSO /?L14
	EQUAL? PRSI,IT /?L14
	EQUAL? PRSA,V?WALK /?L14
	SET 'P-IT-OBJECT,PRSO
?L14:	SET 'PRSI,I
	EQUAL? NOT-HERE-OBJECT,PRSO,PRSI \?L17
	CALL NOT-HERE-OBJECT-F >V
	ZERO? V \?L27
?L17:	SET 'O,PRSO
	SET 'I,PRSI
	GETP WINNER,P?ACTION >STACK
	CALL STACK >V
	ZERO? V \?L27
	LOC WINNER >STACK
	GETP STACK,P?ACTION >STACK
	CALL STACK,M-BEG >V
	ZERO? V \?L27
	GET PREACTIONS,A >STACK
	CALL STACK >V
	ZERO? V \?L27
	ZERO? I /?L24
	GETP I,P?ACTION >STACK
	CALL STACK >V
	ZERO? V \?L27
?L24:	ZERO? O /?L26
	EQUAL? A,V?WALK /?L25
	LOC O >STACK
	ZERO? STACK /?L25
	LOC O >STACK
	GETP STACK,P?CONTFCN >STACK
	CALL STACK >V
	ZERO? V \?L27
?L25:	ZERO? O /?L26
	EQUAL? A,V?WALK /?L26
	GETP O,P?ACTION >STACK
	CALL STACK >V
	ZERO? V \?L27
?L26:	GET ACTIONS,A >STACK
	CALL STACK >V
	ZERO? V /?L27
?L27:	SET 'PRSA,OA
	SET 'PRSO,OO
	SET 'PRSI,OI
	RETURN V

	.FUNCT QUEUE,RTN,TICK,CINT
	CALL INT,RTN >CINT
	PUT CINT,C-TICK,TICK
	RETURN CINT

	.FUNCT INT,RTN,DEMON=0,E,C,INT?1
	ADD C-TABLE,C-TABLELEN >E
	ADD C-TABLE,C-INTS >C
?L1:	EQUAL? C,E \?L3
	SUB C-INTS,C-INTLEN >C-INTS
	ZERO? DEMON /?L5
	SUB C-DEMONS,C-INTLEN >C-DEMONS
?L5:	ADD C-TABLE,C-INTS >INT?1
	PUT INT?1,C-RTN,RTN
	RETURN INT?1
?L3:	GET C,C-RTN >STACK
	EQUAL? STACK,RTN \?L7
	RETURN C
?L7:	ADD C,C-INTLEN >C
	JUMP ?L1

	.FUNCT CLOCKER,C,E,TICK,FLG=0
	ZERO? CLOCK-WAIT /?L1
	SET 'CLOCK-WAIT,0
	RFALSE
?L1:	ZERO? P-WON /?L4
	PUSH C-INTS
	JUMP ?L6
?L4:	PUSH C-DEMONS
?L6:	ADD C-TABLE,STACK >C
	ADD C-TABLE,C-TABLELEN >E
?L7:	EQUAL? C,E \?L9
	INC 'MOVES
	RETURN FLG
?L9:	GET C,C-ENABLED? >STACK
	ZERO? STACK /?L15
	GET C,C-TICK >TICK
	ZERO? TICK /?L15
	SUB TICK,1 >STACK
	PUT C,C-TICK,STACK
	GRTR? TICK,1 /?L15
	GET C,C-RTN >STACK
	CALL STACK >STACK
	ZERO? STACK /?L15
	SET 'FLG,1
?L15:	ADD C,C-INTLEN >C
	JUMP ?L7

	.FUNCT PARSER,PTR=P-LEXSTART,WRD,VAL=0,VERB=0,OF-FLAG=0,OWINNER,OMERGED,LEN,DIR=0,NW=0,LW=0,CNT=-1
?L1:	IGRTR? 'CNT,P-ITBLLEN /?L2
	ZERO? P-OFLAG \?L6
	GET P-ITBL,CNT >STACK
	PUT P-OTBL,CNT,STACK
?L6:	PUT P-ITBL,CNT,0
	JUMP ?L1
?L2:	SET 'OWINNER,WINNER
	SET 'OMERGED,P-MERGED
	SET 'P-ADVERB,0
	SET 'P-MERGED,0
	SET 'P-END-ON-PREP,0
	PUT P-PRSO,P-MATCHLEN,0
	PUT P-PRSI,P-MATCHLEN,0
	PUT P-BUTS,P-MATCHLEN,0
	ZERO? QUOTE-FLAG \?L9
	EQUAL? WINNER,PLAYER /?L9
	SET 'WINNER,PLAYER
	CALL META-LOC,PLAYER >HERE
	CALL LIT?,HERE >LIT
?L9:	ZERO? RESERVE-PTR /?L12
	SET 'PTR,RESERVE-PTR
	CALL STUFF,RESERVE-LEXV,P-LEXV
	ZERO? SUPER-BRIEF \?L14
	EQUAL? PLAYER,WINNER \?L14
	CRLF
?L14:	SET 'RESERVE-PTR,0
	SET 'P-CONT,0
	JUMP ?L21
?L12:	ZERO? P-CONT /?L17
	SET 'PTR,P-CONT
	ZERO? SUPER-BRIEF \?L18
	EQUAL? PLAYER,WINNER \?L18
	EQUAL? PRSA,V?SAY /?L18
	CRLF
?L18:	SET 'P-CONT,0
	JUMP ?L21
?L17:	SET 'WINNER,PLAYER
	SET 'QUOTE-FLAG,0
	LOC WINNER >STACK
	FSET? STACK,VEHBIT /?L22
	LOC WINNER >HERE
?L22:	CALL LIT?,HERE >LIT
	ZERO? SUPER-BRIEF \?L25
	CRLF
?L25:	PRINTI ">"
	READ P-INBUF,P-LEXV
?L21:	GETB P-LEXV,P-LEXWORDS >P-LEN
	ZERO? P-LEN \?L30
	PRINTI "I beg your pardon?"
	CRLF
	RFALSE
?L30:	GET P-LEXV,PTR >WRD
	EQUAL? WRD,W?OOPS \?L35
	ADD PTR,P-LEXELEN >STACK
	GET P-LEXV,STACK >STACK
	EQUAL? STACK,W?$PERIOD,W?$COMMA \?L37
	ADD PTR,P-LEXELEN >PTR
	DEC 'P-LEN
?L37:	GRTR? P-LEN,1 /?L40
	PRINTI "I can't help your clumsiness."
	CRLF
	RFALSE
?L40:	GET OOPS-TABLE,O-PTR >STACK
	ZERO? STACK /?L44
	GRTR? P-LEN,2 \?L49
	ADD PTR,P-LEXELEN >STACK
	GET P-LEXV,STACK >STACK
	EQUAL? STACK,W?$QUOTE \?L45
	PRINTI "Sorry, you can't correct mistakes in quoted text."
	CRLF
	RFALSE
?L45:	GRTR? P-LEN,2 \?L49
	PRINTI "Warning: only the first word after OOPS is used."
	CRLF
?L49:	ADD PTR,P-LEXELEN >STACK
	GET P-LEXV,STACK >STACK
	GET OOPS-TABLE,O-PTR >STACK
	PUT AGAIN-LEXV,STACK,STACK
	SET 'WINNER,OWINNER
	GET OOPS-TABLE,O-PTR >STACK
	MUL STACK,P-LEXELEN >STACK
	ADD STACK,3 >STACK
	MUL PTR,P-LEXELEN >STACK
	ADD STACK,7 >STACK
	GETB P-LEXV,STACK >STACK
	MUL PTR,P-LEXELEN >STACK
	ADD STACK,6 >STACK
	GETB P-LEXV,STACK >STACK
	CALL INBUF-ADD,STACK,STACK,STACK
	CALL STUFF,AGAIN-LEXV,P-LEXV
	GETB P-LEXV,P-LEXWORDS >P-LEN
	GET OOPS-TABLE,O-START >PTR
	CALL INBUF-STUFF,OOPS-INBUF,P-INBUF
	JUMP ?L56
?L44:	PUT OOPS-TABLE,O-END,0
	PRINTI "There was no word to replace!"
	CRLF
	RFALSE
?L35:	EQUAL? WRD,W?AGAIN,W?G /?L57
	SET 'P-NUMBER,0
?L57:	PUT OOPS-TABLE,O-END,0
?L56:	GET P-LEXV,PTR >STACK
	EQUAL? STACK,W?AGAIN,W?G \?L60
	GETB OOPS-INBUF,1 >STACK
	ZERO? STACK \?L62
	PRINTI "Beg pardon?"
	CRLF
	RFALSE
?L62:	ZERO? P-OFLAG /?L66
	PRINTI "It's difficult to repeat fragments."
	CRLF
	RFALSE
?L66:	ZERO? P-WON \?L69
	PRINTI "That would just repeat a mistake."
	CRLF
	RFALSE
?L69:	GRTR? P-LEN,1 \?L72
	ADD PTR,P-LEXELEN >STACK
	GET P-LEXV,STACK >STACK
	EQUAL? STACK,W?$PERIOD,W?$COMMA,W?THEN /?L75
	ADD PTR,P-LEXELEN >STACK
	GET P-LEXV,STACK >STACK
	EQUAL? STACK,W?AND \?L73
?L75:	ADD PTR,4 >PTR
	GETB P-LEXV,P-LEXWORDS >STACK
	SUB STACK,2 >STACK
	PUTB P-LEXV,P-LEXWORDS,STACK
	JUMP ?L79
?L73:	PRINTI "I couldn't understand that sentence."
	CRLF
	RFALSE
?L72:	ADD PTR,P-LEXELEN >PTR
	GETB P-LEXV,P-LEXWORDS >STACK
	DEC 'STACK
	PUTB P-LEXV,P-LEXWORDS,STACK
?L79:	GETB P-LEXV,P-LEXWORDS >STACK
	GRTR? STACK,0 \?L80
	CALL STUFF,P-LEXV,RESERVE-LEXV
	SET 'RESERVE-PTR,PTR
	JUMP ?L82
?L80:	SET 'RESERVE-PTR,0
?L82:	SET 'WINNER,OWINNER
	SET 'P-MERGED,OMERGED
	CALL INBUF-STUFF,OOPS-INBUF,P-INBUF
	CALL STUFF,AGAIN-LEXV,P-LEXV
	SET 'CNT,-1
	SET 'DIR,AGAIN-DIR
?L83:	IGRTR? 'CNT,P-ITBLLEN /?L90
	GET P-OTBL,CNT >STACK
	PUT P-ITBL,CNT,STACK
	JUMP ?L83
?L60:	CALL STUFF,P-LEXV,AGAIN-LEXV
	CALL INBUF-STUFF,P-INBUF,OOPS-INBUF
	PUT OOPS-TABLE,O-START,PTR
	MUL 4,P-LEN >STACK
	PUT OOPS-TABLE,O-LENGTH,STACK
	GETB P-LEXV,P-LEXWORDS >STACK
	MUL P-LEXELEN,STACK >STACK
	ADD PTR,STACK >STACK
	MUL 2,STACK >LEN
	SUB LEN,2 >STACK
	GETB P-LEXV,STACK >STACK
	SUB LEN,1 >STACK
	GETB P-LEXV,STACK >STACK
	ADD STACK,STACK >STACK
	PUT OOPS-TABLE,O-END,STACK
	SET 'RESERVE-PTR,0
	SET 'LEN,P-LEN
	SET 'P-DIR,0
	SET 'P-NCN,0
	SET 'P-GETFLAGS,0
?L89:	DLESS? 'P-LEN,0 \?L91
	SET 'QUOTE-FLAG,0
	JUMP ?L90
?L91:	GET P-LEXV,PTR >WRD
	ZERO? WRD \?L94
	CALL NUMBER?,PTR >WRD
	ZERO? WRD /?L93
?L94:	ZERO? P-LEN \?L95
	SET 'NW,0
	JUMP ?L97
?L95:	ADD PTR,P-LEXELEN >STACK
	GET P-LEXV,STACK >NW
?L97:	EQUAL? WRD,W?TO \?L98
	EQUAL? VERB,ACT?TELL \?L98
	SET 'WRD,W?$QUOTE
	JUMP ?L103
?L98:	EQUAL? WRD,W?THEN \?L103
	GRTR? P-LEN,0 \?L103
	ZERO? VERB \?L103
	ZERO? QUOTE-FLAG \?L103
	EQUAL? LW,0,W?$PERIOD \?L101
	SET 'WRD,W?THE
	JUMP ?L103
?L101:	PUT P-ITBL,P-VERB,ACT?TELL
	PUT P-ITBL,P-VERBN,0
	SET 'WRD,W?$QUOTE
?L103:	EQUAL? WRD,W?THEN,W?$PERIOD,W?$QUOTE \?L105
	EQUAL? WRD,W?$QUOTE \?L111
	ZERO? QUOTE-FLAG /?L109
	SET 'QUOTE-FLAG,0
	JUMP ?L111
?L109:	SET 'QUOTE-FLAG,1
?L111:	ZERO? P-LEN /?L113
	ADD PTR,P-LEXELEN >P-CONT
?L113:	PUTB P-LEXV,P-LEXWORDS,P-LEN
	JUMP ?L90
?L105:	CALL WT?,WRD,PS?DIRECTION,P1?DIRECTION >VAL
	ZERO? VAL /?L115
	EQUAL? VERB,0,ACT?WALK \?L115
	EQUAL? LEN,1 /?L116
	EQUAL? LEN,2 \?L117
	EQUAL? VERB,ACT?WALK /?L116
?L117:	EQUAL? NW,W?THEN,W?$PERIOD,W?$QUOTE \?L118
	LESS? LEN,2 \?L116
?L118:	ZERO? QUOTE-FLAG /?L119
	EQUAL? LEN,2 \?L119
	EQUAL? NW,W?$QUOTE /?L116
?L119:	GRTR? LEN,2 \?L115
	EQUAL? NW,W?$COMMA,W?AND \?L115
?L116:	SET 'DIR,VAL
	EQUAL? NW,W?$COMMA,W?AND \?L120
	ADD PTR,P-LEXELEN >STACK
	PUT P-LEXV,STACK,W?THEN
?L120:	GRTR? LEN,2 /?L155
	SET 'QUOTE-FLAG,0
	JUMP ?L90
?L115:	CALL WT?,WRD,PS?VERB,P1?VERB >VAL
	ZERO? VAL /?L126
	ZERO? VERB \?L126
	SET 'VERB,VAL
	PUT P-ITBL,P-VERB,VAL
	PUT P-ITBL,P-VERBN,P-VTBL
	PUT P-VTBL,0,WRD
	MUL PTR,2 >STACK
	ADD STACK,2 >CNT
	GETB P-LEXV,CNT >STACK
	PUTB P-VTBL,2,STACK
	ADD CNT,1 >STACK
	GETB P-LEXV,STACK >STACK
	PUTB P-VTBL,3,STACK
	JUMP ?L155
?L126:	CALL WT?,WRD,PS?PREPOSITION,0 >VAL
	ZERO? VAL \?L128
	EQUAL? WRD,W?ALL,W?ONE /?L128
	CALL WT?,WRD,PS?ADJECTIVE >STACK
	ZERO? STACK \?L128
	CALL WT?,WRD,PS?OBJECT >STACK
	ZERO? STACK /?L127
?L128:	GRTR? P-LEN,1 \?L129
	EQUAL? NW,W?OF \?L129
	ZERO? VAL \?L165
	EQUAL? WRD,W?ALL,W?ONE,W?A /?L129
	SET 'OF-FLAG,1
	JUMP ?L155
?L129:	ZERO? VAL /?L131
?L165:	ZERO? P-LEN /?L132
	EQUAL? NW,W?THEN,W?$PERIOD \?L131
?L132:	SET 'P-END-ON-PREP,1
	LESS? P-NCN,2 \?L155
	PUT P-ITBL,P-PREP1,VAL
	PUT P-ITBL,P-PREP1N,WRD
	JUMP ?L155
?L131:	EQUAL? P-NCN,2 \?L136
	PRINTI "There were too many nouns in that sentence."
	CRLF
	RFALSE
?L136:	INC 'P-NCN
	SET 'P-ACT,VERB
	CALL CLAUSE,PTR,VAL,WRD >PTR
	ZERO? PTR /FALSE
	LESS? PTR,0 \?L155
	SET 'QUOTE-FLAG,0
	JUMP ?L90
?L127:	EQUAL? WRD,W?OF \?L145
	ZERO? OF-FLAG /?L148
	EQUAL? NW,W?$PERIOD,W?THEN \?L146
?L148:	CALL CANT-USE,PTR
	RFALSE
?L146:	SET 'OF-FLAG,0
	JUMP ?L155
?L145:	CALL WT?,WRD,PS?BUZZ-WORD >STACK
	ZERO? STACK \?L155
	EQUAL? VERB,ACT?TELL \?L151
	CALL WT?,WRD,PS?VERB,P1?VERB >STACK
	ZERO? STACK /?L151
	EQUAL? WINNER,PLAYER \?L151
	PRINTI "Please consult your manual for the correct way to talk to other people or creatures."
	CRLF
	RFALSE
?L151:	CALL CANT-USE,PTR
	RFALSE
?L93:	CALL UNKNOWN-WORD,PTR
	RFALSE
?L155:	SET 'LW,WRD
	ADD PTR,P-LEXELEN >PTR
	JUMP ?L89
?L90:	PUT OOPS-TABLE,O-PTR,0
	ZERO? DIR /?L156
	SET 'PRSA,V?WALK
	SET 'PRSO,DIR
	SET 'P-OFLAG,0
	SET 'P-WALK-DIR,DIR
	SET 'AGAIN-DIR,DIR
	RETURN AGAIN-DIR
?L156:	ZERO? P-OFLAG /?L159
	CALL ORPHAN-MERGE
?L159:	SET 'P-WALK-DIR,0
	SET 'AGAIN-DIR,0
	CALL SYNTAX-CHECK >STACK
	ZERO? STACK /FALSE
	CALL SNARF-OBJECTS >STACK
	ZERO? STACK /FALSE
	CALL MANY-CHECK >STACK
	ZERO? STACK /FALSE
	CALL TAKE-CHECK >STACK
	ZERO? STACK \TRUE
	RFALSE

	.FUNCT STUFF,SRC,DEST,MAX=29,PTR=P-LEXSTART,CTR=1,BPTR
	GETB SRC,0 >STACK
	PUTB DEST,0,STACK
	GETB SRC,1 >STACK
	PUTB DEST,1,STACK
?L1:	GET SRC,PTR >STACK
	PUT DEST,PTR,STACK
	MUL PTR,2 >STACK
	ADD STACK,2 >BPTR
	GETB SRC,BPTR >STACK
	PUTB DEST,BPTR,STACK
	MUL PTR,2 >STACK
	ADD STACK,3 >BPTR
	GETB SRC,BPTR >STACK
	PUTB DEST,BPTR,STACK
	ADD PTR,P-LEXELEN >PTR
	IGRTR? 'CTR,MAX \?L1
	RTRUE

	.FUNCT INBUF-STUFF,SRC,DEST,CNT
	GETB SRC,0 >STACK
	SUB STACK,1 >CNT
?L1:	GETB SRC,CNT >STACK
	PUTB DEST,CNT,STACK
	DLESS? 'CNT,0 \?L1
	RTRUE

	.FUNCT INBUF-ADD,LEN,BEG,SLOT,DBEG,CTR=0,TMP,?TMP
	GET OOPS-TABLE,O-END >TMP
	ZERO? TMP /?L1
	SET 'DBEG,TMP
	JUMP ?L3
?L1:	GET OOPS-TABLE,O-LENGTH >TMP
	GETB AGAIN-LEXV,TMP >?TMP
	ADD TMP,1 >STACK
	GETB AGAIN-LEXV,STACK >STACK
	ADD ?TMP,STACK >DBEG
?L3:	ADD DBEG,LEN >STACK
	PUT OOPS-TABLE,O-END,STACK
?L4:	ADD BEG,CTR >STACK
	GETB P-INBUF,STACK >STACK
	ADD DBEG,CTR >STACK
	PUTB OOPS-INBUF,STACK,STACK
	INC 'CTR
	EQUAL? CTR,LEN \?L4
	PUTB AGAIN-LEXV,SLOT,DBEG
	SUB SLOT,1 >STACK
	PUTB AGAIN-LEXV,STACK,LEN
	RTRUE

	.FUNCT WT?,PTR,BIT,B1=5,OFFS=P-P1OFF,TYP
	GETB PTR,P-PSOFF >TYP
	BTST TYP,BIT \FALSE
	GRTR? B1,4 /TRUE
	BAND TYP,P-P1BITS >TYP
	EQUAL? TYP,B1 /?L6
	INC 'OFFS
?L6:	GETB PTR,OFFS >STACK
	RSTACK

	.FUNCT CLAUSE,PTR,VAL,WRD,OFF,NUM,ANDFLG=0,FIRST??=1,NW,LW=0
	SUB P-NCN,1 >STACK
	MUL STACK,2 >OFF
	ZERO? VAL /?L1
	ADD P-PREP1,OFF >NUM
	PUT P-ITBL,NUM,VAL
	ADD NUM,1 >STACK
	PUT P-ITBL,STACK,WRD
	ADD PTR,P-LEXELEN >PTR
	JUMP ?L3
?L1:	INC 'P-LEN
?L3:	ZERO? P-LEN \?L4
	DEC 'P-NCN
	RETURN -1
?L4:	ADD P-NC1,OFF >NUM
	MUL PTR,2 >STACK
	ADD P-LEXV,STACK >STACK
	PUT P-ITBL,NUM,STACK
	GET P-LEXV,PTR >STACK
	EQUAL? STACK,W?THE,W?A,W?AN \?L7
	GET P-ITBL,NUM >STACK
	ADD STACK,4 >STACK
	PUT P-ITBL,NUM,STACK
?L7:	DLESS? 'P-LEN,0 \?L12
	MUL PTR,2 >STACK
	ADD P-LEXV,STACK >STACK
	ADD NUM,1 >STACK
	PUT P-ITBL,STACK,STACK
	RETURN -1
?L12:	GET P-LEXV,PTR >WRD
	ZERO? WRD \?L17
	CALL NUMBER?,PTR >WRD
	ZERO? WRD /?L15
?L17:	ZERO? P-LEN \?L18
	SET 'NW,0
	JUMP ?L20
?L18:	ADD PTR,P-LEXELEN >STACK
	GET P-LEXV,STACK >NW
?L20:	EQUAL? WRD,W?AND,W?$COMMA \?L21
	SET 'ANDFLG,1
	JUMP ?L42
?L21:	EQUAL? WRD,W?ALL,W?ONE \?L23
	EQUAL? NW,W?OF \?L42
	DEC 'P-LEN
	ADD PTR,P-LEXELEN >PTR
	JUMP ?L42
?L23:	EQUAL? WRD,W?THEN,W?$PERIOD /?L28
	CALL WT?,WRD,PS?PREPOSITION >STACK
	ZERO? STACK /?L27
	GET P-ITBL,P-VERB >STACK
	ZERO? STACK /?L27
	ZERO? FIRST?? \?L27
?L28:	INC 'P-LEN
	MUL PTR,2 >STACK
	ADD P-LEXV,STACK >STACK
	ADD NUM,1 >STACK
	PUT P-ITBL,STACK,STACK
	SUB PTR,P-LEXELEN >STACK
	RSTACK
?L27:	CALL WT?,WRD,PS?OBJECT >STACK
	ZERO? STACK /?L29
	GRTR? P-LEN,0 \?L30
	EQUAL? NW,W?OF \?L30
	EQUAL? WRD,W?ALL,W?ONE \?L42
?L30:	CALL WT?,WRD,PS?ADJECTIVE,P1?ADJECTIVE >STACK
	ZERO? STACK /?L32
	ZERO? NW /?L32
	CALL WT?,NW,PS?OBJECT >STACK
	ZERO? STACK \?L42
?L32:	ZERO? ANDFLG \?L33
	EQUAL? NW,W?BUT,W?EXCEPT,W?AND /?L33
	EQUAL? NW,W?$COMMA /?L33
	ADD PTR,2 >STACK
	MUL STACK,2 >STACK
	ADD P-LEXV,STACK >STACK
	ADD NUM,1 >STACK
	PUT P-ITBL,STACK,STACK
	RETURN PTR
?L33:	SET 'ANDFLG,0
	JUMP ?L42
?L29:	ZERO? P-MERGED \?L36
	ZERO? P-OFLAG \?L36
	GET P-ITBL,P-VERB >STACK
	ZERO? STACK /?L35
?L36:	CALL WT?,WRD,PS?ADJECTIVE >STACK
	ZERO? STACK \?L42
	CALL WT?,WRD,PS?BUZZ-WORD >STACK
	ZERO? STACK \?L42
?L35:	ZERO? ANDFLG /?L38
	CALL WT?,WRD,PS?DIRECTION >STACK
	ZERO? STACK \?L39
	CALL WT?,WRD,PS?VERB >STACK
	ZERO? STACK /?L38
?L39:	SUB PTR,4 >PTR
	ADD PTR,2 >STACK
	PUT P-LEXV,STACK,W?THEN
	ADD P-LEN,2 >P-LEN
	JUMP ?L42
?L38:	CALL WT?,WRD,PS?PREPOSITION >STACK
	ZERO? STACK \?L42
	CALL CANT-USE,PTR
	RFALSE
?L15:	CALL UNKNOWN-WORD,PTR
	RFALSE
?L42:	SET 'LW,WRD
	SET 'FIRST??,0
	ADD PTR,P-LEXELEN >PTR
	JUMP ?L7

	.FUNCT NUMBER?,PTR,CNT,BPTR,CHR,SUM=0,TIM=0
	MUL PTR,2 >STACK
	ADD P-LEXV,STACK >STACK
	GETB STACK,2 >CNT
	MUL PTR,2 >STACK
	ADD P-LEXV,STACK >STACK
	GETB STACK,3 >BPTR
?L1:	DLESS? 'CNT,0 /?L2
	GETB P-INBUF,BPTR >CHR
	EQUAL? CHR,58 \?L6
	SET 'TIM,SUM
	SET 'SUM,0
	JUMP ?L10
?L6:	GRTR? SUM,10000 /FALSE
	LESS? CHR,58 \FALSE
	GRTR? CHR,47 \FALSE
	SUB CHR,48 >STACK
	MUL SUM,10 >STACK
	ADD STACK,STACK >SUM
?L10:	INC 'BPTR
	JUMP ?L1
?L2:	PUT P-LEXV,PTR,W?INTNUM
	GRTR? SUM,1000 /FALSE
	ZERO? TIM /?L13
	LESS? TIM,8 \?L14
	ADD TIM,12 >TIM
	JUMP ?L16
?L14:	GRTR? TIM,23 /FALSE
?L16:	MUL TIM,60 >STACK
	ADD SUM,STACK >SUM
?L13:	SET 'P-NUMBER,SUM
	RETURN W?INTNUM

	.FUNCT ORPHAN-MERGE,CNT=-1,TEMP,VERB,BEG,END,ADJ=0,WRD,?TMP
	SET 'P-OFLAG,0
	GET P-ITBL,P-VERBN >STACK
	GET STACK,0 >WRD
	CALL WT?,WRD,PS?VERB,P1?VERB >?TMP
	GET P-OTBL,P-VERB >STACK
	EQUAL? ?TMP,STACK /?L3
	CALL WT?,WRD,PS?ADJECTIVE >STACK
	ZERO? STACK /?L1
?L3:	SET 'ADJ,1
	JUMP ?L4
?L1:	CALL WT?,WRD,PS?OBJECT,P1?OBJECT >STACK
	ZERO? STACK /?L4
	ZERO? P-NCN \?L4
	PUT P-ITBL,P-VERB,0
	PUT P-ITBL,P-VERBN,0
	ADD P-LEXV,2 >STACK
	PUT P-ITBL,P-NC1,STACK
	ADD P-LEXV,6 >STACK
	PUT P-ITBL,P-NC1L,STACK
	SET 'P-NCN,1
?L4:	GET P-ITBL,P-VERB >VERB
	ZERO? VERB /?L6
	ZERO? ADJ \?L6
	GET P-OTBL,P-VERB >STACK
	EQUAL? VERB,STACK \FALSE
?L6:	EQUAL? P-NCN,2 /FALSE
	GET P-OTBL,P-NC1 >STACK
	EQUAL? STACK,1 \?L9
	GET P-ITBL,P-PREP1 >TEMP
	GET P-OTBL,P-PREP1 >STACK
	EQUAL? TEMP,STACK /?L12
	ZERO? TEMP \FALSE
?L12:	ZERO? ADJ /?L13
	ADD P-LEXV,2 >STACK
	PUT P-OTBL,P-NC1,STACK
	GET P-ITBL,P-NC1L >STACK
	ZERO? STACK \?L15
	ADD P-LEXV,6 >STACK
	PUT P-ITBL,P-NC1L,STACK
?L15:	ZERO? P-NCN \?L21
	SET 'P-NCN,1
	JUMP ?L21
?L13:	GET P-ITBL,P-NC1 >STACK
	PUT P-OTBL,P-NC1,STACK
?L21:	GET P-ITBL,P-NC1L >STACK
	PUT P-OTBL,P-NC1L,STACK
	JUMP ?L42
?L9:	GET P-OTBL,P-NC2 >STACK
	EQUAL? STACK,1 \?L23
	GET P-ITBL,P-PREP1 >TEMP
	GET P-OTBL,P-PREP2 >STACK
	EQUAL? TEMP,STACK /?L26
	ZERO? TEMP \FALSE
?L26:	ZERO? ADJ /?L29
	ADD P-LEXV,2 >STACK
	PUT P-ITBL,P-NC1,STACK
	GET P-ITBL,P-NC1L >STACK
	ZERO? STACK \?L29
	ADD P-LEXV,6 >STACK
	PUT P-ITBL,P-NC1L,STACK
?L29:	GET P-ITBL,P-NC1 >STACK
	PUT P-OTBL,P-NC2,STACK
	GET P-ITBL,P-NC1L >STACK
	PUT P-OTBL,P-NC2L,STACK
	SET 'P-NCN,2
	JUMP ?L42
?L23:	ZERO? P-ACLAUSE /?L42
	EQUAL? P-NCN,1 /?L35
	ZERO? ADJ \?L35
	SET 'P-ACLAUSE,0
	RFALSE
?L35:	GET P-ITBL,P-NC1 >BEG
	ZERO? ADJ /?L38
	ADD P-LEXV,2 >BEG
	SET 'ADJ,0
?L38:	GET P-ITBL,P-NC1L >END
?L41:	GET BEG,0 >WRD
	EQUAL? BEG,END \?L43
	ZERO? ADJ /?L45
	CALL ACLAUSE-WIN,ADJ
	JUMP ?L42
?L45:	SET 'P-ACLAUSE,0
	RFALSE
?L43:	ZERO? ADJ \?L48
	GETB WRD,P-PSOFF >STACK
	BTST STACK,PS?ADJECTIVE /?L49
	EQUAL? WRD,W?ALL,W?ONE \?L48
?L49:	SET 'ADJ,WRD
	JUMP ?L51
?L48:	EQUAL? WRD,W?ONE \?L50
	CALL ACLAUSE-WIN,ADJ
	JUMP ?L42
?L50:	GETB WRD,P-PSOFF >STACK
	BTST STACK,PS?OBJECT \?L51
	EQUAL? WRD,P-ANAM \?L52
	CALL ACLAUSE-WIN,ADJ
	JUMP ?L42
?L52:	CALL NCLAUSE-WIN
	JUMP ?L42
?L51:	ADD BEG,P-WORDLEN >BEG
	ZERO? END \?L41
	SET 'END,BEG
	SET 'P-NCN,1
	SUB BEG,4 >STACK
	PUT P-ITBL,P-NC1,STACK
	PUT P-ITBL,P-NC1L,BEG
	JUMP ?L41
?L42:	GET P-OVTBL,0 >STACK
	PUT P-VTBL,0,STACK
	GETB P-OVTBL,2 >STACK
	PUTB P-VTBL,2,STACK
	GETB P-OVTBL,3 >STACK
	PUTB P-VTBL,3,STACK
	PUT P-OTBL,P-VERBN,P-VTBL
	PUTB P-VTBL,2,0
?L60:	IGRTR? 'CNT,P-ITBLLEN \?L62
	SET 'P-MERGED,1
	RTRUE
?L62:	GET P-OTBL,CNT >STACK
	PUT P-ITBL,CNT,STACK
	JUMP ?L60

	.FUNCT ACLAUSE-WIN,ADJ
	GET P-OTBL,P-VERB >STACK
	PUT P-ITBL,P-VERB,STACK
	PUT P-CCTBL,CC-SBPTR,P-ACLAUSE
	ADD P-ACLAUSE,1 >STACK
	PUT P-CCTBL,CC-SEPTR,STACK
	PUT P-CCTBL,CC-DBPTR,P-ACLAUSE
	ADD P-ACLAUSE,1 >STACK
	PUT P-CCTBL,CC-DEPTR,STACK
	CALL CLAUSE-COPY,P-OTBL,P-OTBL,ADJ
	GET P-OTBL,P-NC2 >STACK
	ZERO? STACK /?L1
	SET 'P-NCN,2
?L1:	SET 'P-ACLAUSE,0
	RTRUE

	.FUNCT NCLAUSE-WIN
	PUT P-CCTBL,CC-SBPTR,P-NC1
	PUT P-CCTBL,CC-SEPTR,P-NC1L
	PUT P-CCTBL,CC-DBPTR,P-ACLAUSE
	ADD P-ACLAUSE,1 >STACK
	PUT P-CCTBL,CC-DEPTR,STACK
	CALL CLAUSE-COPY,P-ITBL,P-OTBL
	GET P-OTBL,P-NC2 >STACK
	ZERO? STACK /?L1
	SET 'P-NCN,2
?L1:	SET 'P-ACLAUSE,0
	RTRUE

	.FUNCT WORD-PRINT,CNT,BUF
?L1:	DLESS? 'CNT,0 /TRUE
	GETB P-INBUF,BUF >STACK
	PRINTC STACK
	INC 'BUF
	JUMP ?L1

	.FUNCT UNKNOWN-WORD,PTR,BUF,?TMP
	PUT OOPS-TABLE,O-PTR,PTR
	EQUAL? PRSA,V?SAY \?L1
	PRINTI "Nothing happens."
	CRLF
	RFALSE
?L1:	PRINTI "I don't know the word """
	MUL PTR,2 >BUF
	ADD P-LEXV,BUF >STACK
	GETB STACK,2 >?TMP
	ADD P-LEXV,BUF >STACK
	GETB STACK,3 >STACK
	CALL WORD-PRINT,?TMP,STACK
	PRINTI """."
	CRLF
	SET 'QUOTE-FLAG,0
	SET 'P-OFLAG,0
	RETURN P-OFLAG

	.FUNCT CANT-USE,PTR,BUF,?TMP
	EQUAL? PRSA,V?SAY \?L1
	PRINTI "Nothing happens."
	CRLF
	RFALSE
?L1:	PRINTI "You used the word """
	MUL PTR,2 >BUF
	ADD P-LEXV,BUF >STACK
	GETB STACK,2 >?TMP
	ADD P-LEXV,BUF >STACK
	GETB STACK,3 >STACK
	CALL WORD-PRINT,?TMP,STACK
	PRINTI """ in a way that I don't understand."
	CRLF
	SET 'QUOTE-FLAG,0
	SET 'P-OFLAG,0
	RETURN P-OFLAG

	.FUNCT SYNTAX-CHECK,SYN,LEN,NUM,OBJ,DRIVE1=0,DRIVE2=0,PREP,VERB,TMP
	GET P-ITBL,P-VERB >VERB
	ZERO? VERB \?L1
	PRINTI "There was no verb in that sentence!"
	CRLF
	RFALSE
?L1:	SUB 255,VERB >STACK
	GET VERBS,STACK >SYN
	GETB SYN,0 >LEN
	INC 'SYN
?L6:	GETB SYN,P-SBITS >STACK
	BAND STACK,P-SONUMS >NUM
	GRTR? P-NCN,NUM /?L15
	LESS? NUM,1 /?L10
	ZERO? P-NCN \?L10
	GET P-ITBL,P-PREP1 >PREP
	ZERO? PREP /?L11
	GETB SYN,P-SPREP1 >STACK
	EQUAL? PREP,STACK \?L10
?L11:	SET 'DRIVE1,SYN
	JUMP ?L15
?L10:	GET P-ITBL,P-PREP1 >STACK
	GETB SYN,P-SPREP1 >STACK
	EQUAL? STACK,STACK \?L15
	EQUAL? NUM,2 \?L13
	EQUAL? P-NCN,1 \?L13
	SET 'DRIVE2,SYN
	JUMP ?L15
?L13:	GET P-ITBL,P-PREP2 >STACK
	GETB SYN,P-SPREP2 >STACK
	EQUAL? STACK,STACK \?L15
	CALL SYNTAX-FOUND,SYN
	RTRUE
?L15:	DLESS? 'LEN,1 \?L18
	ZERO? DRIVE1 \?L53
	ZERO? DRIVE2 \?L7
	PRINTI "That sentence isn't one I recognize."
	CRLF
	RFALSE
?L18:	ADD SYN,P-SYNLEN >SYN
	JUMP ?L6
?L7:	ZERO? DRIVE1 /?L27
?L53:	GETB DRIVE1,P-SPREP1 >STACK
	GETB DRIVE1,P-SLOC1 >STACK
	GETB DRIVE1,P-SFWIM1 >STACK
	CALL GWIM,STACK,STACK,STACK >OBJ
	ZERO? OBJ /?L27
	PUT P-PRSO,P-MATCHLEN,1
	PUT P-PRSO,1,OBJ
	CALL SYNTAX-FOUND,DRIVE1 >STACK
	RSTACK
?L27:	ZERO? DRIVE2 /?L29
	GETB DRIVE2,P-SPREP2 >STACK
	GETB DRIVE2,P-SLOC2 >STACK
	GETB DRIVE2,P-SFWIM2 >STACK
	CALL GWIM,STACK,STACK,STACK >OBJ
	ZERO? OBJ /?L29
	PUT P-PRSI,P-MATCHLEN,1
	PUT P-PRSI,1,OBJ
	CALL SYNTAX-FOUND,DRIVE2 >STACK
	RSTACK
?L29:	EQUAL? VERB,ACT?FIND \?L30
	PRINTI "That question can't be answered."
	CRLF
	RFALSE
?L30:	EQUAL? WINNER,PLAYER /?L33
	CALL CANT-ORPHAN >STACK
	RSTACK
?L33:	CALL ORPHAN,DRIVE1,DRIVE2
	PRINTI "What do you want to "
	GET P-OTBL,P-VERBN >TMP
	ZERO? TMP \?L37
	PRINTI "tell"
	JUMP ?L42
?L37:	GETB P-VTBL,2 >STACK
	ZERO? STACK \?L41
	GET TMP,0 >STACK
	PRINTB STACK
	JUMP ?L42
?L41:	GETB TMP,3 >STACK
	GETB TMP,2 >STACK
	CALL WORD-PRINT,STACK,STACK
	PUTB P-VTBL,2,0
?L42:	ZERO? DRIVE2 /?L43
	PRINTI " "
	CALL THING-PRINT,1,1
?L43:	SET 'P-OFLAG,1
	ZERO? DRIVE1 /?L48
	GETB DRIVE1,P-SPREP1 >STACK
	JUMP ?L50
?L48:	GETB DRIVE2,P-SPREP2 >STACK
?L50:	CALL PREP-PRINT,STACK
	PRINTI "?"
	CRLF
	RFALSE

	.FUNCT CANT-ORPHAN
	PRINTI """I don't understand! What are you referring to?"""
	CRLF
	RFALSE

	.FUNCT ORPHAN,D1,D2,CNT=-1
	ZERO? P-MERGED \?L1
	PUT P-OCLAUSE,P-MATCHLEN,0
?L1:	GET P-VTBL,0 >STACK
	PUT P-OVTBL,0,STACK
	GETB P-VTBL,2 >STACK
	PUTB P-OVTBL,2,STACK
	GETB P-VTBL,3 >STACK
	PUTB P-OVTBL,3,STACK
?L4:	IGRTR? 'CNT,P-ITBLLEN /?L5
	GET P-ITBL,CNT >STACK
	PUT P-OTBL,CNT,STACK
	JUMP ?L4
?L5:	EQUAL? P-NCN,2 \?L9
	PUT P-CCTBL,CC-SBPTR,P-NC2
	PUT P-CCTBL,CC-SEPTR,P-NC2L
	PUT P-CCTBL,CC-DBPTR,P-NC2
	PUT P-CCTBL,CC-DEPTR,P-NC2L
	CALL CLAUSE-COPY,P-ITBL,P-OTBL
?L9:	LESS? P-NCN,1 /?L12
	PUT P-CCTBL,CC-SBPTR,P-NC1
	PUT P-CCTBL,CC-SEPTR,P-NC1L
	PUT P-CCTBL,CC-DBPTR,P-NC1
	PUT P-CCTBL,CC-DEPTR,P-NC1L
	CALL CLAUSE-COPY,P-ITBL,P-OTBL
?L12:	ZERO? D1 /?L15
	GETB D1,P-SPREP1 >STACK
	PUT P-OTBL,P-PREP1,STACK
	PUT P-OTBL,P-NC1,1
	RTRUE
?L15:	ZERO? D2 /FALSE
	GETB D2,P-SPREP2 >STACK
	PUT P-OTBL,P-PREP2,STACK
	PUT P-OTBL,P-NC2,1
	RTRUE

	.FUNCT THING-PRINT,PRSO?,THE?=0,BEG,END
	ZERO? PRSO? /?L1
	GET P-ITBL,P-NC1 >BEG
	GET P-ITBL,P-NC1L >END
	JUMP ?L3
?L1:	GET P-ITBL,P-NC2 >BEG
	GET P-ITBL,P-NC2L >END
?L3:	CALL BUFFER-PRINT,BEG,END,THE? >STACK
	RSTACK

	.FUNCT BUFFER-PRINT,BEG,END,CP?1,NOSP=1,WRD,FIRST??=1,PN=0,Q?=0
?L1:	EQUAL? BEG,END /TRUE
	GET BEG,0 >WRD
	EQUAL? WRD,W?$COMMA \?L6
	PRINTI ", "
	JUMP ?L11
?L6:	ZERO? NOSP /?L10
	SET 'NOSP,0
	JUMP ?L11
?L10:	PRINTI " "
?L11:	EQUAL? WRD,W?$PERIOD,W?$COMMA \?L14
	SET 'NOSP,1
	JUMP ?L18
?L14:	EQUAL? WRD,W?ME \?L16
	PRINTD ME
	SET 'PN,1
	JUMP ?L18
?L16:	EQUAL? WRD,W?INTNUM \?L17
	PRINTN P-NUMBER
	SET 'PN,1
	JUMP ?L18
?L17:	ZERO? FIRST?? /?L19
	ZERO? PN \?L19
	ZERO? CP?1 /?L19
	PRINTI "the "
?L19:	ZERO? P-OFLAG \?L26
	ZERO? P-MERGED /?L24
?L26:	PRINTB WRD
	JUMP ?L28
?L24:	EQUAL? WRD,W?IT \?L27
	CALL ACCESSIBLE?,P-IT-OBJECT >STACK
	ZERO? STACK /?L27
	PRINTD P-IT-OBJECT
	JUMP ?L28
?L27:	GETB BEG,3 >STACK
	GETB BEG,2 >STACK
	CALL WORD-PRINT,STACK,STACK
?L28:	SET 'FIRST??,0
?L18:	ADD BEG,P-WORDLEN >BEG
	JUMP ?L1

	.FUNCT PREP-PRINT,PREP,WRD
	ZERO? PREP /FALSE
	PRINTI " "
	CALL PREP-FIND,PREP >WRD
	PRINTB WRD
	RTRUE

	.FUNCT CLAUSE-COPY,SRC,DEST,INSRT=0,BEG,END
	GET P-CCTBL,CC-SBPTR >STACK
	GET SRC,STACK >BEG
	GET P-CCTBL,CC-SEPTR >STACK
	GET SRC,STACK >END
	GET P-OCLAUSE,P-MATCHLEN >STACK
	MUL STACK,P-LEXELEN >STACK
	ADD STACK,2 >STACK
	ADD P-OCLAUSE,STACK >STACK
	GET P-CCTBL,CC-DBPTR >STACK
	PUT DEST,STACK,STACK
?L1:	EQUAL? BEG,END \?L3
	GET P-OCLAUSE,P-MATCHLEN >STACK
	MUL STACK,P-LEXELEN >STACK
	ADD STACK,2 >STACK
	ADD P-OCLAUSE,STACK >STACK
	GET P-CCTBL,CC-DEPTR >STACK
	PUT DEST,STACK,STACK
	RTRUE
?L3:	ZERO? INSRT /?L6
	GET BEG,0 >STACK
	EQUAL? P-ANAM,STACK \?L6
	CALL CLAUSE-ADD,INSRT
?L6:	GET BEG,0 >STACK
	CALL CLAUSE-ADD,STACK
	ADD BEG,P-WORDLEN >BEG
	JUMP ?L1

	.FUNCT CLAUSE-ADD,WRD,PTR
	GET P-OCLAUSE,P-MATCHLEN >STACK
	ADD STACK,2 >PTR
	SUB PTR,1 >STACK
	PUT P-OCLAUSE,STACK,WRD
	PUT P-OCLAUSE,PTR,0
	PUT P-OCLAUSE,P-MATCHLEN,PTR
	RTRUE

	.FUNCT PREP-FIND,PREP,CNT=0,SIZE
	GET PREPOSITIONS,0 >STACK
	MUL STACK,2 >SIZE
?L1:	IGRTR? 'CNT,SIZE /FALSE
	GET PREPOSITIONS,CNT >STACK
	EQUAL? STACK,PREP \?L1
	SUB CNT,1 >STACK
	GET PREPOSITIONS,STACK >STACK
	RSTACK

	.FUNCT SYNTAX-FOUND,SYN
	SET 'P-SYNTAX,SYN
	GETB SYN,P-SACTION >PRSA
	RETURN PRSA

	.FUNCT GWIM,GBIT,LBIT,PREP,OBJ
	EQUAL? GBIT,RMUNGBIT \?L1
	RETURN ROOMS
?L1:	SET 'P-GWIMBIT,GBIT
	SET 'P-SLOCBITS,LBIT
	PUT P-MERGE,P-MATCHLEN,0
	CALL GET-OBJECT,P-MERGE,0 >STACK
	ZERO? STACK /?L4
	SET 'P-GWIMBIT,0
	GET P-MERGE,P-MATCHLEN >STACK
	EQUAL? STACK,1 \FALSE
	GET P-MERGE,1 >OBJ
	PRINTI "("
	ZERO? PREP /?L10
	ZERO? P-END-ON-PREP \?L10
	CALL PREP-FIND,PREP >PREP
	PRINTB PREP
	EQUAL? PREP,W?OUT \?L12
	PRINTI " of"
?L12:	PRINTI " "
	EQUAL? OBJ,HANDS \?L19
	PRINTI "your hands"
	JUMP ?L23
?L19:	PRINTI "the "
	PRINTD OBJ
?L23:	PRINTI ")"
	CRLF
	RETURN OBJ
?L10:	PRINTD OBJ
	PRINTI ")"
	CRLF
	RETURN OBJ
?L4:	SET 'P-GWIMBIT,0
	RFALSE

	.FUNCT SNARF-OBJECTS,OPTR,IPTR,L
	PUT P-BUTS,P-MATCHLEN,0
	GET P-ITBL,P-NC2 >IPTR
	ZERO? IPTR /?L3
	GETB P-SYNTAX,P-SLOC2 >P-SLOCBITS
	GET P-ITBL,P-NC2L >STACK
	CALL SNARFEM,IPTR,STACK,P-PRSI >STACK
	ZERO? STACK /FALSE
?L3:	GET P-ITBL,P-NC1 >OPTR
	ZERO? OPTR /?L8
	GETB P-SYNTAX,P-SLOC1 >P-SLOCBITS
	GET P-ITBL,P-NC1L >STACK
	CALL SNARFEM,OPTR,STACK,P-PRSO >STACK
	ZERO? STACK /FALSE
?L8:	GET P-BUTS,P-MATCHLEN >STACK
	ZERO? STACK /TRUE
	GET P-PRSO,P-MATCHLEN >L
	ZERO? OPTR /?L13
	CALL BUT-MERGE,P-PRSO >P-PRSO
?L13:	ZERO? IPTR /TRUE
	ZERO? OPTR /?L18
	GET P-PRSO,P-MATCHLEN >STACK
	EQUAL? L,STACK \TRUE
?L18:	CALL BUT-MERGE,P-PRSI >P-PRSI
	RTRUE

	.FUNCT BUT-MERGE,TBL,LEN,BUTLEN,CNT=1,MATCHES=0,OBJ,NTBL
	GET TBL,P-MATCHLEN >LEN
	PUT P-MERGE,P-MATCHLEN,0
?L1:	DLESS? 'LEN,0 /?L2
	GET TBL,CNT >OBJ
	CALL ZMEMQ,OBJ,P-BUTS >STACK
	ZERO? STACK \?L6
	ADD MATCHES,1 >STACK
	PUT P-MERGE,STACK,OBJ
	INC 'MATCHES
?L6:	INC 'CNT
	JUMP ?L1
?L2:	PUT P-MERGE,P-MATCHLEN,MATCHES
	SET 'NTBL,P-MERGE
	SET 'P-MERGE,TBL
	RETURN NTBL

	.FUNCT SNARFEM,PTR,EPTR,TBL,BUT=0,LEN,WV,WRD,NW,WAS-ALL=0
	SET 'P-AND,0
	EQUAL? P-GETFLAGS,P-ALL \?L1
	SET 'WAS-ALL,1
?L1:	SET 'P-GETFLAGS,0
	PUT TBL,P-MATCHLEN,0
	GET PTR,0 >WRD
?L4:	EQUAL? PTR,EPTR \?L6
?L57:	ZERO? BUT /?L9
	PUSH BUT
	JUMP ?L8
?L9:	PUSH TBL
?L8:	CALL GET-OBJECT,STACK >WV
	ZERO? WAS-ALL /?L10
	SET 'P-GETFLAGS,P-ALL
?L10:	RETURN WV
?L6:	ADD PTR,P-WORDLEN >STACK
	EQUAL? EPTR,STACK \?L14
	SET 'NW,0
	JUMP ?L16
?L14:	GET PTR,P-LEXELEN >NW
?L16:	EQUAL? WRD,W?ALL \?L17
	SET 'P-GETFLAGS,P-ALL
	EQUAL? NW,W?OF \?L52
	ADD PTR,P-WORDLEN >PTR
	JUMP ?L52
?L17:	EQUAL? WRD,W?BUT,W?EXCEPT \?L22
	ZERO? BUT /?L26
	PUSH BUT
	JUMP ?L25
?L26:	PUSH TBL
?L25:	CALL GET-OBJECT,STACK >STACK
	ZERO? STACK /FALSE
	SET 'BUT,P-BUTS
	PUT BUT,P-MATCHLEN,0
	JUMP ?L52
?L22:	EQUAL? WRD,W?A,W?ONE \?L27
	ZERO? P-ADJ \?L28
	SET 'P-GETFLAGS,P-ONE
	EQUAL? NW,W?OF \?L52
	ADD PTR,P-WORDLEN >PTR
	JUMP ?L52
?L28:	SET 'P-NAM,P-ONEOBJ
	ZERO? BUT /?L37
	PUSH BUT
	JUMP ?L36
?L37:	PUSH TBL
?L36:	CALL GET-OBJECT,STACK >STACK
	ZERO? STACK /FALSE
	ZERO? NW /TRUE
	JUMP ?L52
?L27:	EQUAL? WRD,W?AND,W?$COMMA \?L40
	EQUAL? NW,W?AND,W?$COMMA /?L40
	SET 'P-AND,1
	ZERO? BUT /?L44
	PUSH BUT
	JUMP ?L43
?L44:	PUSH TBL
?L43:	CALL GET-OBJECT,STACK >STACK
	ZERO? STACK /FALSE
	JUMP ?L52
?L40:	CALL WT?,WRD,PS?BUZZ-WORD >STACK
	ZERO? STACK \?L52
	EQUAL? WRD,W?AND,W?$COMMA /?L52
	EQUAL? WRD,W?OF \?L47
	ZERO? P-GETFLAGS \?L52
	SET 'P-GETFLAGS,P-INHIBIT
	JUMP ?L52
?L47:	CALL WT?,WRD,PS?ADJECTIVE,P1?ADJECTIVE >WV
	ZERO? WV /?L51
	ZERO? P-ADJ \?L51
	SET 'P-ADJ,WV
	SET 'P-ADJN,WRD
	JUMP ?L52
?L51:	CALL WT?,WRD,PS?OBJECT,P1?OBJECT >STACK
	ZERO? STACK /?L52
	SET 'P-NAM,WRD
	SET 'P-ONEOBJ,WRD
?L52:	EQUAL? PTR,EPTR /?L57
	ADD PTR,P-WORDLEN >PTR
	SET 'WRD,NW
	JUMP ?L4

	.FUNCT GET-OBJECT,TBL,VRB=1,BITS,LEN,XBITS,TLEN,GCHECK=0,OLEN=0,OBJ
	SET 'XBITS,P-SLOCBITS
	GET TBL,P-MATCHLEN >TLEN
	BTST P-GETFLAGS,P-INHIBIT /TRUE
	ZERO? P-NAM \?L11
	ZERO? P-ADJ /?L8
	CALL WT?,P-ADJN,PS?OBJECT,P1?OBJECT >STACK
	ZERO? STACK /?L6
	SET 'P-NAM,P-ADJN
	SET 'P-ADJ,0
	JUMP ?L8
?L6:	CALL WT?,P-ADJN,PS?DIRECTION,P1?DIRECTION >BITS
	ZERO? BITS /?L8
	SET 'P-ADJ,0
	PUT TBL,P-MATCHLEN,1
	PUT TBL,1,INTDIR
	SET 'P-DIRECTION,BITS
	RTRUE
?L8:	ZERO? P-NAM \?L11
	ZERO? P-ADJ \?L11
	EQUAL? P-GETFLAGS,P-ALL /?L73
	ZERO? P-GWIMBIT \?L11
	ZERO? VRB /FALSE
	PRINTI "There seems to be a noun missing in that sentence!"
	CRLF
	RFALSE
?L11:	EQUAL? P-GETFLAGS,P-ALL \?L21
?L73:	ZERO? P-SLOCBITS \?L19
?L21:	SET 'P-SLOCBITS,-1
?L19:	SET 'P-TABLE,TBL
?L23:	ZERO? GCHECK /?L25
	CALL GLOBAL-CHECK,TBL
	JUMP ?L27
?L25:	ZERO? LIT /?L28
	FCLEAR PLAYER,TRANSBIT
	CALL DO-SL,HERE,SOG,SIR
	FSET PLAYER,TRANSBIT
?L28:	CALL DO-SL,PLAYER,SH,SC
?L27:	GET TBL,P-MATCHLEN >STACK
	SUB STACK,TLEN >LEN
	BTST P-GETFLAGS,P-ALL /?L45
	BTST P-GETFLAGS,P-ONE \?L33
	ZERO? LEN /?L33
	EQUAL? LEN,1 /?L34
	RANDOM LEN >STACK
	GET TBL,STACK >STACK
	PUT TBL,1,STACK
	PRINTI "(How about the "
	GET TBL,1 >STACK
	PRINTD STACK
	PRINTI "?)"
	CRLF
?L34:	PUT TBL,P-MATCHLEN,1
	JUMP ?L45
?L33:	GRTR? LEN,1 /?L42
	ZERO? LEN \?L71
	EQUAL? P-SLOCBITS,-1 /?L45
?L42:	EQUAL? P-SLOCBITS,-1 \?L43
	SET 'P-SLOCBITS,XBITS
	SET 'OLEN,LEN
	GET TBL,P-MATCHLEN >STACK
	SUB STACK,LEN >STACK
	PUT TBL,P-MATCHLEN,STACK
	JUMP ?L23
?L43:	ZERO? LEN \?L46
	SET 'LEN,OLEN
?L46:	EQUAL? WINNER,PLAYER /?L49
	CALL CANT-ORPHAN
	RFALSE
?L49:	ZERO? VRB /?L55
	ZERO? P-NAM /?L51
	CALL WHICH-PRINT,TLEN,LEN,TBL
	EQUAL? TBL,P-PRSO \?L52
	SET 'P-ACLAUSE,P-NC1
	JUMP ?L54
?L52:	SET 'P-ACLAUSE,P-NC2
?L54:	SET 'P-AADJ,P-ADJ
	SET 'P-ANAM,P-NAM
	CALL ORPHAN,0,0
	SET 'P-OFLAG,1
	JUMP ?L55
?L51:	ZERO? VRB /?L55
	PRINTI "There seems to be a noun missing in that sentence!"
	CRLF
?L55:	SET 'P-NAM,0
	SET 'P-ADJ,0
	RFALSE
?L45:	ZERO? LEN \?L71
	ZERO? GCHECK /?L60
	ZERO? VRB /?L67
	SET 'P-SLOCBITS,XBITS
	ZERO? LIT \?L66
	EQUAL? PRSA,V?TELL \?L64
?L66:	CALL OBJ-FOUND,NOT-HERE-OBJECT,TBL
	SET 'P-XNAM,P-NAM
	SET 'P-XADJ,P-ADJ
	SET 'P-XADJN,P-ADJN
	SET 'P-NAM,0
	SET 'P-ADJ,0
	SET 'P-ADJN,0
	RTRUE
?L64:	PRINTI "It's too dark to see!"
	CRLF
?L67:	SET 'P-NAM,0
	SET 'P-ADJ,0
	RFALSE
?L60:	ZERO? LEN \?L71
	SET 'GCHECK,1
	JUMP ?L23
?L71:	SET 'P-SLOCBITS,XBITS
	SET 'P-NAM,0
	SET 'P-ADJ,0
	RTRUE

	.FUNCT WHICH-PRINT,TLEN,LEN,TBL,OBJ,RLEN
	SET 'RLEN,LEN
	PRINTI "Which "
	ZERO? P-OFLAG \?L5
	ZERO? P-MERGED \?L5
	ZERO? P-AND /?L3
?L5:	ZERO? P-NAM /?L6
	PUSH P-NAM
	JUMP ?L9
?L6:	ZERO? P-ADJ /?L8
	PUSH P-ADJN
	JUMP ?L9
?L8:	PUSH W?ONE
?L9:	PRINTB STACK
	JUMP ?L10
?L3:	EQUAL? TBL,P-PRSO /?L11
	PUSH 0
	JUMP ?L12
?L11:	PUSH 1
?L12:	CALL THING-PRINT,STACK
?L10:	PRINTI " do you mean, "
?L15:	INC 'TLEN
	GET TBL,TLEN >OBJ
	PRINTI "the "
	PRINTD OBJ
	EQUAL? LEN,2 \?L19
	EQUAL? RLEN,2 /?L21
	PRINTI ","
?L21:	PRINTI " or "
	JUMP ?L28
?L19:	GRTR? LEN,2 \?L28
	PRINTI ", "
?L28:	DLESS? 'LEN,1 \?L15
	PRINTR "?"

	.FUNCT GLOBAL-CHECK,TBL,LEN,RMG,RMGL,CNT=0,OBJ,OBITS,FOO
	GET TBL,P-MATCHLEN >LEN
	SET 'OBITS,P-SLOCBITS
	GETPT HERE,P?GLOBAL >RMG
	ZERO? RMG /?L4
	PTSIZE RMG >STACK
	SUB STACK,1 >RMGL
?L3:	GETB RMG,CNT >OBJ
	CALL THIS-IT?,OBJ,TBL >STACK
	ZERO? STACK /?L5
	CALL OBJ-FOUND,OBJ,TBL
?L5:	IGRTR? 'CNT,RMGL \?L3
?L4:	GETPT HERE,P?PSEUDO >RMG
	ZERO? RMG /?L15
	PTSIZE RMG >STACK
	DIV STACK,4 >STACK
	SUB STACK,1 >RMGL
	SET 'CNT,0
?L14:	MUL CNT,2 >STACK
	GET RMG,STACK >STACK
	EQUAL? P-NAM,STACK \?L16
	MUL CNT,2 >STACK
	INC 'STACK
	GET RMG,STACK >STACK
	PUTP PSEUDO-OBJECT,P?ACTION,STACK
	GETPT PSEUDO-OBJECT,P?ACTION >STACK
	SUB STACK,5 >FOO
	GET P-NAM,0 >STACK
	PUT FOO,0,STACK
	GET P-NAM,1 >STACK
	PUT FOO,1,STACK
	CALL OBJ-FOUND,PSEUDO-OBJECT,TBL
	JUMP ?L15
?L16:	IGRTR? 'CNT,RMGL \?L14
?L15:	GET TBL,P-MATCHLEN >STACK
	EQUAL? STACK,LEN \FALSE
	SET 'P-SLOCBITS,-1
	SET 'P-TABLE,TBL
	CALL DO-SL,GLOBAL-OBJECTS,1,1
	SET 'P-SLOCBITS,OBITS
	GET TBL,P-MATCHLEN >STACK
	ZERO? STACK \FALSE
	EQUAL? PRSA,V?LOOK-INSIDE,V?SEARCH,V?EXAMINE \FALSE
	CALL DO-SL,ROOMS,1,1 >STACK
	RSTACK

	.FUNCT DO-SL,OBJ,BIT1,BIT2,BTS
	ADD BIT1,BIT2 >STACK
	BTST P-SLOCBITS,STACK \?L1
	CALL SEARCH-LIST,OBJ,P-TABLE,P-SRCALL >STACK
	RSTACK
?L1:	BTST P-SLOCBITS,BIT1 \?L4
	CALL SEARCH-LIST,OBJ,P-TABLE,P-SRCTOP >STACK
	RSTACK
?L4:	BTST P-SLOCBITS,BIT2 \TRUE
	CALL SEARCH-LIST,OBJ,P-TABLE,P-SRCBOT >STACK
	RSTACK

	.FUNCT SEARCH-LIST,OBJ,TBL,LVL,FLS,NOBJ
	FIRST? OBJ >OBJ \FALSE
?L3:	EQUAL? LVL,P-SRCBOT /?L5
	GETPT OBJ,P?SYNONYM >STACK
	ZERO? STACK /?L5
	CALL THIS-IT?,OBJ,TBL >STACK
	ZERO? STACK /?L5
	CALL OBJ-FOUND,OBJ,TBL
?L5:	EQUAL? LVL,P-SRCTOP \?L10
	FSET? OBJ,SEARCHBIT /?L10
	FSET? OBJ,SURFACEBIT \?L8
?L10:	FIRST? OBJ >NOBJ \?L8
	FSET? OBJ,OPENBIT /?L11
	FSET? OBJ,TRANSBIT \?L8
?L11:	FSET? OBJ,SURFACEBIT \?L12
	PUSH P-SRCALL
	JUMP ?L15
?L12:	FSET? OBJ,SEARCHBIT \?L14
	PUSH P-SRCALL
	JUMP ?L15
?L14:	PUSH P-SRCTOP
?L15:	CALL SEARCH-LIST,OBJ,TBL,STACK >FLS
?L8:	NEXT? OBJ >OBJ /?L3
	RTRUE

	.FUNCT OBJ-FOUND,OBJ,TBL,PTR
	GET TBL,P-MATCHLEN >PTR
	ADD PTR,1 >STACK
	PUT TBL,STACK,OBJ
	ADD PTR,1 >STACK
	PUT TBL,P-MATCHLEN,STACK
	RTRUE

	.FUNCT TAKE-CHECK
	GETB P-SYNTAX,P-SLOC1 >STACK
	CALL ITAKE-CHECK,P-PRSO,STACK >STACK
	ZERO? STACK /FALSE
	GETB P-SYNTAX,P-SLOC2 >STACK
	CALL ITAKE-CHECK,P-PRSI,STACK >STACK
	RSTACK

	.FUNCT ITAKE-CHECK,TBL,IBITS,PTR,OBJ,TAKEN
	GET TBL,P-MATCHLEN >PTR
	ZERO? PTR /TRUE
	BTST IBITS,SHAVE /?L3
	BTST IBITS,STAKE \TRUE
?L3:	DLESS? 'PTR,0 /TRUE
	ADD PTR,1 >STACK
	GET TBL,STACK >OBJ
	EQUAL? OBJ,IT \?L15
	CALL ACCESSIBLE?,P-IT-OBJECT >STACK
	ZERO? STACK \?L11
	PRINTI "I don't see what you're referring to."
	CRLF
	RFALSE
?L11:	SET 'OBJ,P-IT-OBJECT
?L15:	CALL HELD?,OBJ >STACK
	ZERO? STACK \?L3
	EQUAL? OBJ,HANDS,ME /?L3
	SET 'PRSO,OBJ
	FSET? OBJ,TRYTAKEBIT \?L19
	SET 'TAKEN,1
	JUMP ?L23
?L19:	EQUAL? WINNER,ADVENTURER /?L21
	SET 'TAKEN,0
	JUMP ?L23
?L21:	BTST IBITS,STAKE \?L22
	CALL ITAKE,0 >STACK
	EQUAL? STACK,1 \?L22
	SET 'TAKEN,0
	JUMP ?L23
?L22:	SET 'TAKEN,1
?L23:	ZERO? TAKEN /?L41
	BTST IBITS,SHAVE \?L24
	EQUAL? WINNER,ADVENTURER \?L24
	EQUAL? OBJ,NOT-HERE-OBJECT \?L26
	PRINTI "You don't have that!"
	CRLF
	RFALSE
?L26:	PRINTI "You don't have the "
	PRINTD OBJ
	PRINTI "."
	CRLF
	RFALSE
?L24:	ZERO? TAKEN \?L3
?L41:	EQUAL? WINNER,ADVENTURER \?L3
	PRINTI "(Taken)"
	CRLF
	JUMP ?L3

	.FUNCT MANY-CHECK,LOSS=0,TMP
	GET P-PRSO,P-MATCHLEN >STACK
	GRTR? STACK,1 \?L1
	GETB P-SYNTAX,P-SLOC1 >STACK
	BTST STACK,SMANY /?L1
	SET 'LOSS,1
	JUMP ?L3
?L1:	GET P-PRSI,P-MATCHLEN >STACK
	GRTR? STACK,1 \?L3
	GETB P-SYNTAX,P-SLOC2 >STACK
	BTST STACK,SMANY /?L3
	SET 'LOSS,2
?L3:	ZERO? LOSS /TRUE
	PRINTI "You can't use multiple "
	EQUAL? LOSS,2 \?L9
	PRINTI "in"
?L9:	PRINTI "direct objects with """
	GET P-ITBL,P-VERBN >TMP
	ZERO? TMP \?L16
	PRINTI "tell"
	JUMP ?L22
?L16:	ZERO? P-OFLAG \?L21
	ZERO? P-MERGED /?L20
?L21:	GET TMP,0 >STACK
	PRINTB STACK
	JUMP ?L22
?L20:	GETB TMP,3 >STACK
	GETB TMP,2 >STACK
	CALL WORD-PRINT,STACK,STACK
?L22:	PRINTI """."
	CRLF
	RFALSE

	.FUNCT ZMEMQ,ITM,TBL,SIZE=-1,CNT=1
	ZERO? TBL /FALSE
	LESS? SIZE,0 /?L4
	SET 'CNT,0
	JUMP ?L6
?L4:	GET TBL,0 >SIZE
?L6:	GET TBL,CNT >STACK
	EQUAL? ITM,STACK \?L9
	MUL CNT,2 >STACK
	ADD TBL,STACK >STACK
	RSTACK
?L9:	IGRTR? 'CNT,SIZE \?L6
	RFALSE

	.FUNCT ZMEMQB,ITM,TBL,SIZE,CNT=0
?L1:	GETB TBL,CNT >STACK
	EQUAL? ITM,STACK /TRUE
	IGRTR? 'CNT,SIZE \?L1
	RFALSE

	.FUNCT LIT?,RM,RMBIT=1,OHERE,LIT?1=0
	ZERO? ALWAYS-LIT /?L1
	EQUAL? WINNER,PLAYER /TRUE
?L1:	SET 'P-GWIMBIT,ONBIT
	SET 'OHERE,HERE
	SET 'HERE,RM
	ZERO? RMBIT /?L4
	FSET? RM,ONBIT \?L4
	SET 'LIT?1,1
	JUMP ?L13
?L4:	PUT P-MERGE,P-MATCHLEN,0
	SET 'P-TABLE,P-MERGE
	SET 'P-SLOCBITS,-1
	EQUAL? OHERE,RM \?L9
	CALL DO-SL,WINNER,1,1
	EQUAL? WINNER,PLAYER /?L9
	IN? PLAYER,RM \?L9
	CALL DO-SL,PLAYER,1,1
?L9:	CALL DO-SL,RM,1,1
	GET P-TABLE,P-MATCHLEN >STACK
	GRTR? STACK,0 \?L13
	SET 'LIT?1,1
?L13:	SET 'HERE,OHERE
	SET 'P-GWIMBIT,0
	RETURN LIT?1

	.FUNCT THIS-IT?,OBJ,TBL,SYNS
	FSET? OBJ,INVISIBLE /FALSE
	ZERO? P-NAM /?L3
	GETPT OBJ,P?SYNONYM >SYNS
	PTSIZE SYNS >STACK
	DIV STACK,2 >STACK
	DEC 'STACK
	CALL ZMEMQ,P-NAM,SYNS,STACK >STACK
	ZERO? STACK /FALSE
?L3:	ZERO? P-ADJ /?L4
	GETPT OBJ,P?ADJECTIVE >SYNS
	ZERO? SYNS /FALSE
	PTSIZE SYNS >STACK
	DEC 'STACK
	CALL ZMEMQB,P-ADJ,SYNS,STACK >STACK
	ZERO? STACK /FALSE
?L4:	ZERO? P-GWIMBIT /TRUE
	FSET? OBJ,P-GWIMBIT /TRUE
	RFALSE

	.FUNCT ACCESSIBLE?,OBJ,L,?TMP
	LOC OBJ >L
	FSET? OBJ,INVISIBLE /FALSE
	ZERO? L /FALSE
	EQUAL? L,GLOBAL-OBJECTS /TRUE
	EQUAL? L,LOCAL-GLOBALS \?L5
	CALL GLOBAL-IN?,OBJ,HERE >STACK
	ZERO? STACK \TRUE
?L5:	CALL META-LOC,OBJ >?TMP
	LOC WINNER >STACK
	EQUAL? ?TMP,HERE,STACK \FALSE
	LOC WINNER >STACK
	EQUAL? L,WINNER,HERE,STACK /TRUE
	FSET? L,OPENBIT \FALSE
	CALL ACCESSIBLE?,L >STACK
	ZERO? STACK /FALSE
	RTRUE

	.FUNCT META-LOC,OBJ
?L1:	ZERO? OBJ /FALSE
	IN? OBJ,GLOBAL-OBJECTS \?L5
	RETURN GLOBAL-OBJECTS
?L5:	IN? OBJ,ROOMS \?L7
	RETURN OBJ
?L7:	LOC OBJ >OBJ
	JUMP ?L1

	.FUNCT ZPROB,BASE
	ZERO? LUCKY /?L1
	RANDOM 100 >STACK
	GRTR? BASE,STACK /TRUE
	RFALSE
?L1:	RANDOM 300 >STACK
	GRTR? BASE,STACK \FALSE
	RTRUE

	.FUNCT RANDOM-ELEMENT,FROB
	GET FROB,0 >STACK
	RANDOM STACK >STACK
	GET FROB,STACK >STACK
	RSTACK

	.FUNCT PICK-ONE,FROB,L,CNT,RND,MSG,RFROB
	GET FROB,0 >L
	GET FROB,1 >CNT
	DEC 'L
	ADD FROB,2 >FROB
	MUL CNT,2 >STACK
	ADD FROB,STACK >RFROB
	SUB L,CNT >STACK
	RANDOM STACK >RND
	GET RFROB,RND >MSG
	GET RFROB,1 >STACK
	PUT RFROB,RND,STACK
	PUT RFROB,1,MSG
	INC 'CNT
	EQUAL? CNT,L \?L1
	SET 'CNT,0
?L1:	PUT FROB,0,CNT
	RETURN MSG

	.FUNCT V-VERBOSE
	SET 'VERBOSE,1
	SET 'SUPER-BRIEF,0
	PRINTR "Maximum verbosity."

	.FUNCT V-BRIEF
	SET 'VERBOSE,0
	SET 'SUPER-BRIEF,0
	PRINTR "Brief descriptions."

	.FUNCT V-SUPER-BRIEF
	SET 'SUPER-BRIEF,1
	PRINTR "Superbrief descriptions."

	.FUNCT V-INVENTORY
	FIRST? WINNER >STACK \?L1
	CALL PRINT-CONT,WINNER >STACK
	RSTACK
?L1:	PRINTR "You are empty-handed."

	.FUNCT FINISH,WRD
	CALL V-SCORE
?L1:	CRLF
	CALL OBJTREE-FINAL-PRINT
	PRINTI "[EVENT: GAME OVER]Would you like to restart the game from the beginning, restore a saved game position, or end this session of the game?
(Type RESTART, RESTORE, or QUIT):
>"
	READ P-INBUF,P-LEXV
	GET P-LEXV,1 >WRD
	EQUAL? WRD,W?RESTART \?L5
	RESTART
?L5:	EQUAL? WRD,W?RESTORE \?L9
	RESTORE \?L10
	PRINTI "Ok."
	CRLF
	JUMP ?L1
?L10:	PRINTI "Failed."
	CRLF
	JUMP ?L1
?L9:	EQUAL? WRD,W?QUIT,W?Q \?L1
	QUIT

	.FUNCT V-QUIT,SCOR
	CALL V-SCORE
	PRINTI "Do you wish to leave the game? (Y is affirmative): "
	CALL YES? >STACK
	ZERO? STACK /?L3
	QUIT
?L3:	PRINTR "Ok."

	.FUNCT V-RESTART
	CALL V-SCORE,1
	PRINTI "Do you wish to restart? (Y is affirmative): "
	CALL YES? >STACK
	ZERO? STACK /FALSE
	PRINTI "Restarting."
	CRLF
	RESTART

	.FUNCT V-RESTORE
	RESTORE \?L1
	PRINTI "Ok."
	CRLF
	CALL V-FIRST-LOOK >STACK
	RSTACK
?L1:	PRINTR "Failed."

	.FUNCT V-SAVE
	SAVE \?L1
	PRINTR "Ok."
?L1:	PRINTR "Failed."

	.FUNCT V-SCRIPT
	GET 0,8 >STACK
	BOR STACK,1 >STACK
	PUT 0,8,STACK
	PRINTI "Here begins a transcript of interaction with"
	CRLF
	CALL V-VERSION
	RTRUE

	.FUNCT V-UNSCRIPT
	PRINTI "Here ends a transcript of interaction with"
	CRLF
	CALL V-VERSION
	GET 0,8 >STACK
	BAND STACK,-2 >STACK
	PUT 0,8,STACK
	RTRUE

	.FUNCT V-VERSION,CNT=17
	PRINTI "ZORK III: The Dungeon Master
Infocom interactive fiction - a fantasy story
Copyright 1982, 1983, 1984, 1986"
	PRINTI " Infocom, Inc. All rights reserved."
	CRLF
	PRINTI "ZORK is a registered trademark of Infocom, Inc.
Release "
	GET 0,1 >STACK
	BAND STACK,2047 >STACK
	PRINTN STACK
	PRINTI " / Serial number "
?L9:	IGRTR? 'CNT,23 /?L10
	GETB 0,CNT >STACK
	PRINTC STACK
	JUMP ?L9
?L10:	CRLF
	RTRUE

	.FUNCT V-VERIFY
	PRINTI "Verifying disk..."
	CRLF
	VERIFY \?L3
	PRINTR "The disk is correct."
?L3:	CRLF
	PRINTR "** Disk Failure **"

	.FUNCT V-COMMAND-FILE
	DIRIN 1
	RTRUE

	.FUNCT V-RANDOM
	EQUAL? PRSO,INTNUM /?L1
	PRINTR "Illegal call to #RND."
?L1:	SUB 0,P-NUMBER >STACK
	RANDOM STACK >STACK
	RTRUE

	.FUNCT V-RECORD
	DIROUT 4
	RTRUE

	.FUNCT V-UNRECORD
	DIROUT -4
	RTRUE

	.FUNCT V-ADVENT
	PRINTR "A hollow voice says ""Fool."""

	.FUNCT V-ALARM
	FSET? PRSO,ACTORBIT \?L1
	CALL NULL-F >STACK
	ZERO? STACK \TRUE
	PRINTR "He's wide awake, or haven't you noticed..."
?L1:	PRINTI "The "
	PRINTD PRSO
	PRINTR " isn't sleeping."

	.FUNCT V-ANSWER
	PRINTI "Nobody seems to be awaiting your answer."
	CRLF
	SET 'P-CONT,0
	SET 'QUOTE-FLAG,0
	RTRUE

	.FUNCT V-ATTACK
	FSET? PRSO,ACTORBIT /?L1
	PRINTI "I've known strange people, but fighting a "
	PRINTD PRSO
	PRINTI "?"
	CRLF
	CALL IS-OBJECT-OR-PROPERTY? >STACK
	CALL PRINT-ID,STR?5,STACK
	CALL IS-ANIMAL? >STACK
	CALL PRINT-ID,STR?6,STACK >STACK
	RSTACK
?L1:	ZERO? PRSI /?L6
	EQUAL? PRSI,HANDS \?L5
?L6:	PRINTI "Trying to attack a "
	PRINTD PRSO
	PRINTI " with your bare hands is suicidal."
	CRLF
	CALL PRINT-ID,STR?7 >STACK
	RSTACK
?L5:	IN? PRSI,WINNER /?L9
	PRINTI "You aren't even holding the "
	PRINTD PRSI
	PRINTI "."
	CRLF
	CALL PRINT-ID,STR?8 >STACK
	RSTACK
?L9:	FSET? PRSI,WEAPONBIT /?L12
	PRINTI "Trying to attack the "
	PRINTD PRSO
	PRINTI " with a "
	PRINTD PRSI
	PRINTI " is suicidal."
	CRLF
	CALL PRINT-ID,STR?9 >STACK
	RSTACK
?L12:	PRINTR "You can't."

	.FUNCT V-BACK
	PRINTR "Sorry, my memory is poor. Please give a direction."

	.FUNCT V-BLAST
	PRINTI "You can't blast anything by using words."
	CRLF
	CALL BOMB?,PRSI >STACK
	ZERO? STACK \?L4
	PUSH 0
	JUMP ?L3
?L4:	CALL IS-PERSON? >STACK
?L3:	CALL PRINT-ID,STR?10,STACK
	CALL BOMB?,PRSI >STACK
	ZERO? STACK \?L6
	PUSH 0
	JUMP ?L5
?L6:	CALL IS-OBJ-PROP-ANIMAL? >STACK
?L5:	CALL PRINT-ID,STR?11,STACK
	CALL BOMB?,PRSI >STACK
	ZERO? STACK \?L8
	PUSH 0
	JUMP ?L7
?L8:	CALL IS-SELF? >STACK
?L7:	CALL PRINT-ID,STR?12,STACK >STACK
	RSTACK

	.FUNCT PRE-BOARD,AV
	LOC WINNER >AV
	EQUAL? PRSO,WATER-CHANNEL,TM-SEAT,LAKE /FALSE
	FSET? PRSO,VEHBIT \?L3
	IN? PRSO,HERE /?L4
	PRINTI "The "
	PRINTD PRSO
	PRINTI " must be on the ground to be boarded."
	CRLF
	RETURN 2
?L4:	FSET? AV,VEHBIT \FALSE
	PRINTI "You are already in the "
	PRINTD AV
	PRINTI "!"
	CRLF
	RETURN 2
?L3:	EQUAL? PRSO,WATER,GLOBAL-WATER \?L12
	CALL PERFORM,V?SWIM,PRSO
	RTRUE
?L12:	PRINTI "You have a theory on how to board a "
	PRINTD PRSO
	PRINTI ", perhaps?"
	CRLF
	RETURN 2

	.FUNCT V-BOARD,AV
	PRINTI "You are now in the "
	PRINTD PRSO
	PRINTI "."
	CRLF
	MOVE WINNER,PRSO
	GETP PRSO,P?ACTION >STACK
	CALL STACK,M-ENTER >STACK
	RTRUE

	.FUNCT V-BREATHE
	CALL PERFORM,V?INFLATE,PRSO,LUNGS >STACK
	RSTACK

	.FUNCT V-BRUSH
	PRINTI "If you wish, but heaven only knows why."
	CRLF
	CALL IS-OBJECT-OR-PROPERTY? >STACK
	CALL PRINT-ID,STR?13,STACK >STACK
	RSTACK

	.FUNCT V-BUG
	PRINTR "Bug? Not in a flawless program like this! (Cough, cough)."

	.FUNCT TELL-NO-PRSI
	PRINTR "You didn't say with what!"

	.FUNCT PRE-BURN
	ZERO? PRSI \?L1
	CALL TELL-NO-PRSI
	CALL IS-PERSON? >STACK
	CALL PRINT-ID,STR?14,STACK
	CALL IS-OBJ-PROP-ANIMAL? >STACK
	CALL PRINT-ID,STR?15,STACK
	CALL IS-PART-OF-SELF-OR-SELF? >STACK
	CALL PRINT-ID,STR?16,STACK >STACK
	RSTACK
?L1:	FSET? PRSI,FLAMEBIT \?L3
	FSET? PRSI,ONBIT /FALSE
?L3:	PRINTI "With a "
	PRINTD PRSI
	PRINTI "??!?"
	CRLF
	CALL IS-PERSON? >STACK
	CALL PRINT-ID,STR?17,STACK
	CALL IS-OBJ-PROP-ANIMAL? >STACK
	CALL PRINT-ID,STR?18,STACK
	CALL IS-PART-OF-SELF-OR-SELF? >STACK
	CALL PRINT-ID,STR?19,STACK >STACK
	RSTACK

	.FUNCT V-BURN
	CALL NULL-F >STACK
	ZERO? STACK \FALSE
	FSET? PRSO,BURNBIT \?L3
	IN? PRSO,WINNER /?L6
	IN? WINNER,PRSO \?L4
?L6:	CALL REMOVE-CAREFULLY,PRSO
	PRINTI "The "
	PRINTD PRSO
	PRINTI " catches fire. Unfortunately, you were "
	IN? WINNER,PRSO \?L11
	PRINTI "in"
	JUMP ?L15
?L11:	PRINTI "holding"
	CALL PRINT-ID,STR?20
?L15:	CALL JIGS-UP,STR?21 >STACK
	RSTACK
?L4:	CALL REMOVE-CAREFULLY,PRSO
	PRINTI "The "
	PRINTD PRSO
	PRINTI " catches fire and is consumed."
	CRLF
	CALL PRINT-ID,STR?22 >STACK
	RSTACK
?L3:	PRINTI "You can't burn a "
	PRINTD PRSO
	PRINTI "."
	CRLF
	CALL IS-PERSON? >STACK
	CALL PRINT-ID,STR?23,STACK
	CALL IS-OBJ-PROP-ANIMAL? >STACK
	CALL PRINT-ID,STR?24,STACK
	CALL IS-PART-OF-SELF-OR-SELF? >STACK
	CALL PRINT-ID,STR?25,STACK >STACK
	RSTACK

	.FUNCT V-CHOMP
	PRINTR "Preposterous!"

	.FUNCT V-CLIMB-DOWN
	CALL V-CLIMB-UP,P?DOWN,PRSO >STACK
	RSTACK

	.FUNCT V-CLIMB-FOO
	EQUAL? PRSO,ROPE,GLOBAL-ROPE \?L1
	PUSH P?DOWN
	JUMP ?L3
?L1:	PUSH P?UP
?L3:	CALL V-CLIMB-UP,STACK,1 >STACK
	RSTACK

	.FUNCT V-CLIMB-ON
	FSET? PRSO,VEHBIT \?L1
	CALL V-CLIMB-UP,P?UP,1
	RTRUE
?L1:	PRINTI "You can't climb onto the "
	PRINTD PRSO
	PRINTR "."

	.FUNCT V-CLIMB-UP,DIR=P?UP,OBJ=0,X,TX
	ZERO? OBJ /?L1
	EQUAL? PRSO,ROOMS /?L1
	SET 'OBJ,PRSO
?L1:	GETPT HERE,DIR >TX
	ZERO? TX /?L4
	ZERO? OBJ /?L8
	PTSIZE TX >X
	EQUAL? X,NEXIT /?L10
	EQUAL? X,CEXIT,DEXIT,UEXIT \?L8
	GETB TX,0 >STACK
	CALL GLOBAL-IN?,PRSO,STACK >STACK
	ZERO? STACK \?L8
?L10:	PRINTI "The "
	PRINTD OBJ
	PRINTI " do"
	EQUAL? OBJ,STAIRS /?L13
	PRINTI "es"
?L13:	PRINTI "n't lead "
	EQUAL? DIR,P?UP \?L20
	PRINTI "up"
	JUMP ?L24
?L20:	PRINTI "down"
?L24:	PRINTR "ward."
?L8:	CALL DO-WALK,DIR
	RTRUE
?L4:	ZERO? OBJ /?L31
	GETPT PRSO,P?SYNONYM >X
	PTSIZE X >STACK
	CALL ZMEMQ,W?WALL,X,STACK >STACK
	ZERO? STACK /?L31
	PRINTR "Climbing the walls is to no avail."
?L31:	CALL NULL-F >STACK
	ZERO? STACK /?L34
	PRINTR "There are no climbable trees here."
?L34:	EQUAL? OBJ,0,ROOMS \?L37
	PRINTR "You can't go that way."
?L37:	PRINTR "You can't do that!"

	.FUNCT V-CLOSE
	FSET? PRSO,CONTBIT /?L1
	FSET? PRSO,DOORBIT /?L1
	PRINTI "You must tell me how to do that to a "
	PRINTD PRSO
	PRINTR "."
?L1:	FSET? PRSO,SURFACEBIT /?L5
	GETP PRSO,P?CAPACITY >STACK
	ZERO? STACK /?L5
	FSET? PRSO,OPENBIT \?L6
	FCLEAR PRSO,OPENBIT
	PRINTI "Closed."
	CRLF
	ZERO? LIT /TRUE
	CALL LIT?,HERE >LIT
	ZERO? LIT \TRUE
	PRINTR "It is now pitch black."
?L6:	PRINTR "It is already closed."
?L5:	FSET? PRSO,DOORBIT \?L18
	FSET? PRSO,OPENBIT \?L19
	FCLEAR PRSO,OPENBIT
	PRINTI "The "
	PRINTD PRSO
	PRINTR " is now closed."
?L19:	PRINTR "It is already closed."
?L18:	PRINTR "You cannot close that."

	.FUNCT V-COMMAND
	FSET? PRSO,ACTORBIT \?L1
	PRINTI "The "
	PRINTD PRSO
	PRINTR " pays no attention."
?L1:	PRINTR "You cannot talk to that!"

	.FUNCT V-COUNT
	EQUAL? PRSO,BLESSINGS \?L1
	PRINTR "Well, for one, you are playing Zork..."
?L1:	PRINTR "You have lost your mind."

	.FUNCT V-CROSS
	PRINTR "You can't cross that!"

	.FUNCT V-CURSES
	ZERO? PRSO /?L1
	FSET? PRSO,ACTORBIT \?L3
	PRINTI "Insults of this nature won't help you."
	CRLF
	CALL PRINT-ID,STR?26
	CALL PRINT-ID,STR?27 >STACK
	RSTACK
?L3:	PRINTI "What a loony!"
	CRLF
	CALL PRINT-ID,STR?28 >STACK
	RSTACK
?L1:	PRINTI "Such language in a high-class establishment like this!"
	CRLF
	CALL PRINT-ID,STR?29 >STACK
	RSTACK

	.FUNCT V-CUT
	FSET? PRSO,ACTORBIT \?L1
	CALL PERFORM,V?ATTACK,PRSO,PRSI >STACK
	RSTACK
?L1:	FSET? PRSO,BURNBIT \?L3
	FSET? PRSI,WEAPONBIT \?L12
	IN? WINNER,PRSO \?L4
	PRINTI "Not a bright idea, especially since you're in it."
	CRLF
	CALL PRINT-ID,STR?30
	RTRUE
?L4:	CALL REMOVE-CAREFULLY,PRSO
	PRINTI "Your skillful "
	PRINTD PRSI
	PRINTI "smanship slices the "
	PRINTD PRSO
	PRINTI " into innumerable slivers which blow away."
	CRLF
	CALL PRINT-ID,STR?31 >STACK
	RSTACK
?L3:	FSET? PRSI,WEAPONBIT /?L11
?L12:	PRINTI "The ""cutting edge"" of a "
	PRINTD PRSI
	PRINTI " is hardly adequate."
	CRLF
	CALL PRINT-ID,STR?32 >STACK
	RSTACK
?L11:	PRINTI "Strange concept, cutting the "
	PRINTD PRSO
	PRINTI "...."
	CRLF
	CALL PRINT-ID,STR?33 >STACK
	RSTACK

	.FUNCT V-DEFLATE
	PRINTR "Come on, now!"

	.FUNCT V-DIG
	ZERO? PRSI \?L1
	SET 'PRSI,HANDS
?L1:	FSET? PRSI,TOOLBIT \?L4
	PRINTI "Digging with the "
	PRINTD PRSI
	PRINTR " is slow and tedious."
?L4:	PRINTI "Digging with a "
	PRINTD PRSI
	PRINTR " is silly."

	.FUNCT V-DISEMBARK
	EQUAL? PRSO,ROOMS \?L1
	LOC WINNER >STACK
	FSET? STACK,VEHBIT \?L1
	LOC WINNER >STACK
	CALL PERFORM,V?DISEMBARK,STACK
	RTRUE
?L1:	LOC WINNER >STACK
	EQUAL? STACK,PRSO /?L3
	PRINTI "You're not in that!"
	CRLF
	RETURN 2
?L3:	FSET? HERE,RLANDBIT \?L8
	PRINTI "You are on your own feet again."
	CRLF
	MOVE WINNER,HERE
	RTRUE
?L8:	PRINTI "You realize that getting out here would be fatal."
	CRLF
	RETURN 2

	.FUNCT V-DISENCHANT
	PRINTR "Nothing happens."

	.FUNCT V-DRINK
	CALL V-EAT >STACK
	RSTACK

	.FUNCT V-DRINK-FROM
	PRINTR "How peculiar!"

	.FUNCT PRE-DROP
	LOC WINNER >STACK
	EQUAL? PRSO,STACK \FALSE
	CALL PERFORM,V?DISEMBARK,PRSO
	RTRUE

	.FUNCT V-DROP
	CALL IDROP >STACK
	ZERO? STACK /FALSE
	PRINTR "Dropped."

	.FUNCT V-EAT,EAT?=0,DRINK?=0,NOBJ=0,?TMP
	FSET? PRSO,FOODBIT /?L3
	SET 'EAT?,0
	JUMP ?L1
?L3:	SET 'EAT?,1
	IN? PRSO,WINNER /?L5
	LOC PRSO >STACK
	IN? STACK,WINNER /?L5
	PRINTI "You're not holding that."
	CRLF
	CRLF
	RTRUE
?L5:	EQUAL? PRSA,V?DRINK \?L9
	PRINTR "How can you drink that?"
?L9:	PRINTI "Thank you very much. It really hit the spot."
	CALL REMOVE-CAREFULLY,PRSO
	CRLF
	RTRUE
?L1:	FSET? PRSO,DRINKBIT \?L15
	SET 'DRINK?,1
	LOC PRSO >NOBJ
	IN? PRSO,GLOBAL-OBJECTS /?L18
	CALL GLOBAL-IN?,GLOBAL-WATER,HERE >STACK
	ZERO? STACK \?L18
	EQUAL? PRSO,PSEUDO-OBJECT \?L16
?L18:	CALL HIT-SPOT >STACK
	RSTACK
?L16:	ZERO? NOBJ /?L20
	CALL ACCESSIBLE?,NOBJ >STACK
	ZERO? STACK \?L19
?L20:	PRINTR "There isn't any water here."
?L19:	CALL ACCESSIBLE?,NOBJ >STACK
	ZERO? STACK /?L23
	IN? NOBJ,WINNER /?L23
	PRINTI "You have to be holding the "
	PRINTD NOBJ
	PRINTR " first."
?L23:	FSET? NOBJ,OPENBIT /?L26
	PRINTI "You'll have to open the "
	PRINTD NOBJ
	PRINTR " first."
?L26:	CALL HIT-SPOT >STACK
	RSTACK
?L15:	ZERO? EAT? \FALSE
	ZERO? DRINK? \FALSE
	PRINTI "I don't think that the "
	PRINTD PRSO
	PRINTI " would agree with you."
	CRLF
	CALL DANGEROUS-FOOD? >?TMP
	ZERO? ?TMP /?L34
	PUSH ?TMP
	JUMP ?L33
?L34:	CALL DANGEROUS-DRINK? >STACK
?L33:	CALL PRINT-ID,STR?34,STACK >STACK
	RSTACK

	.FUNCT HIT-SPOT
	EQUAL? PRSO,WATER \?L1
	CALL GLOBAL-IN?,GLOBAL-WATER,HERE >STACK
	ZERO? STACK \?L1
	CALL REMOVE-CAREFULLY,PRSO
?L1:	PRINTR "Thank you very much. I was rather thirsty (from all this talking, probably)."

	.FUNCT V-ECHO,LST,MAX,ECH=0,CNT
	PRINTR "echo echo ..."

	.FUNCT V-ENCHANT
	CALL NULL-F
	CALL V-DISENCHANT >STACK
	RSTACK

	.FUNCT REMOVE-CAREFULLY,OBJ,OLIT
	EQUAL? OBJ,P-IT-OBJECT \?L1
	SET 'P-IT-OBJECT,0
?L1:	SET 'OLIT,LIT
	REMOVE OBJ
	CALL LIT?,HERE >LIT
	EQUAL? OLIT,0,LIT /TRUE
	PRINTR "You are left in the dark..."

	.FUNCT V-ENTER
	CALL DO-WALK,P?IN >STACK
	RSTACK

	.FUNCT V-EXAMINE
	GETP PRSO,P?TEXT >STACK
	ZERO? STACK /?L1
	GETP PRSO,P?TEXT >STACK
	PRINT STACK
	CRLF
	RTRUE
?L1:	FSET? PRSO,CONTBIT /?L6
	FSET? PRSO,DOORBIT \?L5
?L6:	CALL V-LOOK-INSIDE >STACK
	RSTACK
?L5:	PRINTI "There's nothing special about the "
	PRINTD PRSO
	PRINTR "."

	.FUNCT V-EXIT
	EQUAL? PRSO,0,ROOMS \?L1
	LOC WINNER >STACK
	FSET? STACK,VEHBIT \?L1
	LOC WINNER >STACK
	CALL PERFORM,V?DISEMBARK,STACK
	RTRUE
?L1:	ZERO? PRSO /?L3
	IN? WINNER,PRSO \?L3
	CALL PERFORM,V?DISEMBARK,PRSO
	RTRUE
?L3:	CALL DO-WALK,P?OUT >STACK
	RSTACK

	.FUNCT V-EXORCISE
	PRINTR "What a bizarre concept!"

	.FUNCT PRE-FILL,TX
	ZERO? PRSI \?L6
	GETPT HERE,P?GLOBAL >TX
	ZERO? TX /?L3
	PTSIZE TX >STACK
	DEC 'STACK
	CALL ZMEMQB,GLOBAL-WATER,TX,STACK >STACK
	ZERO? STACK /?L3
	CALL PERFORM,V?FILL,PRSO,GLOBAL-WATER
	RTRUE
?L3:	LOC WINNER >STACK
	IN? WATER,STACK \?L5
	CALL PERFORM,V?FILL,PRSO,WATER
	RTRUE
?L5:	PRINTR "There is nothing to fill it with."
?L6:	EQUAL? PRSI,WATER,GLOBAL-WATER /FALSE
	CALL PERFORM,V?PUT,PRSI,PRSO
	RTRUE

	.FUNCT V-FILL
	ZERO? PRSI \?L1
	CALL GLOBAL-IN?,GLOBAL-WATER,HERE >STACK
	ZERO? STACK /?L3
	CALL PERFORM,V?FILL,PRSO,GLOBAL-WATER
	RTRUE
?L3:	LOC WINNER >STACK
	IN? WATER,STACK \?L5
	CALL PERFORM,V?FILL,PRSO,WATER
	RTRUE
?L5:	PRINTR "There's nothing to fill it with."
?L1:	PRINTR "You may know how to do that, but I don't."

	.FUNCT V-FIND,L
	LOC PRSO >L
	EQUAL? PRSO,HANDS,LUNGS \?L1
	PRINTR "Within six feet of your head, assuming you haven't left that somewhere."
?L1:	EQUAL? PRSO,ME \?L5
	PRINTR "You're around here somewhere..."
?L5:	EQUAL? L,GLOBAL-OBJECTS \?L8
	PRINTR "You find it."
?L8:	IN? PRSO,WINNER \?L11
	PRINTR "You have it."
?L11:	IN? PRSO,HERE /?L15
	CALL GLOBAL-IN?,PRSO,HERE >STACK
	ZERO? STACK \?L15
	EQUAL? PRSO,PSEUDO-OBJECT \?L14
?L15:	PRINTR "It's right here."
?L14:	FSET? L,ACTORBIT \?L18
	PRINTI "The "
	PRINTD L
	PRINTR " has it."
?L18:	FSET? L,SURFACEBIT \?L21
	PRINTI "It's on the "
	PRINTD L
	PRINTR "."
?L21:	FSET? L,CONTBIT \?L24
	PRINTI "It's in the "
	PRINTD L
	PRINTR "."
?L24:	PRINTR "Beats me."

	.FUNCT V-FOLLOW
	PRINTR "You're nuts!"

	.FUNCT V-FROBOZZ
	PRINTR "The FROBOZZ Corporation created, owns, and operates this dungeon."

	.FUNCT PRE-GIVE
	CALL HELD?,PRSO >STACK
	ZERO? STACK \FALSE
	PRINTI "That's easy for you to say since you don't even have the "
	PRINTD PRSO
	PRINTR "."

	.FUNCT V-GIVE
	FSET? PRSI,ACTORBIT /?L1
	PRINTI "You can't give a "
	PRINTD PRSO
	PRINTI " to a "
	PRINTD PRSI
	PRINTR "!"
?L1:	PRINTI "The "
	PRINTD PRSI
	PRINTR " refuses it politely."

	.FUNCT V-HATCH
	PRINTR "Bizarre!"

	.FUNCT V-HELLO
	ZERO? PRSO /?L1
	FSET? PRSO,ACTORBIT \?L3
	PRINTI "The "
	PRINTD PRSO
	PRINTR " bows his head to you in greeting."
?L3:	PRINTI "It's a well known fact that only schizophrenics say ""Hello"" to a "
	PRINTD PRSO
	PRINTR "."
?L1:	CALL PICK-ONE,HELLOS >STACK
	PRINT STACK
	CRLF
	RTRUE

	.FUNCT V-INCANT
	PRINTI "The incantation echoes back faintly, but nothing else happens."
	CRLF
	SET 'QUOTE-FLAG,0
	SET 'P-CONT,0
	RTRUE

	.FUNCT V-INFLATE
	PRINTR "How can you inflate that?"

	.FUNCT V-KICK,?TMP
	CALL IS-PERSON? >?TMP
	ZERO? ?TMP /?L2
	PUSH ?TMP
	JUMP ?L1
?L2:	CALL IS-OBJ-PROP-ANIMAL? >STACK
?L1:	CALL PRINT-ID,STR?35,STACK
	CALL IS-PART-OF-SELF-OR-SELF? >STACK
	CALL PRINT-ID,STR?36,STACK
	CALL HACK-HACK,STR?37 >STACK
	RSTACK

	.FUNCT V-KISS
	PRINTI "I'd sooner kiss a pig."
	CRLF
	CALL IS-PERSON? >STACK
	CALL PRINT-ID,STR?38,STACK >STACK
	RSTACK

	.FUNCT V-KNOCK
	FSET? PRSO,DOORBIT \?L1
	PRINTR "Nobody's home."
?L1:	PRINTI "Why knock on a "
	PRINTD PRSO
	PRINTR "?"

	.FUNCT V-LAMP-OFF
	FSET? PRSO,LIGHTBIT \?L1
	FSET? PRSO,ONBIT /?L3
	PRINTR "It is already off."
?L3:	FCLEAR PRSO,ONBIT
	ZERO? LIT /?L8
	CALL LIT?,HERE >LIT
?L8:	PRINTI "The "
	PRINTD PRSO
	PRINTI " is now off."
	CRLF
	ZERO? LIT \TRUE
	PRINTR "It is now pitch black."
?L1:	PRINTR "You can't turn that off."

	.FUNCT V-LAMP-ON
	FSET? PRSO,LIGHTBIT \?L1
	FSET? PRSO,ONBIT \?L3
	PRINTR "It is already on."
?L3:	FSET PRSO,ONBIT
	PRINTI "The "
	PRINTD PRSO
	PRINTI " is now on."
	CRLF
	ZERO? LIT \TRUE
	CALL LIT?,HERE >LIT
	CRLF
	CALL V-LOOK
	RTRUE
?L1:	FSET? PRSO,BURNBIT \?L13
	PRINTI "If you wish to burn the "
	PRINTD PRSO
	PRINTI ", you should say so."
	CRLF
	CALL IS-OBJECT-OR-PROPERTY? >STACK
	CALL PRINT-ID,STR?39,STACK
	RTRUE
?L13:	PRINTR "You can't turn that on."

	.FUNCT V-LAUNCH
	FSET? PRSO,VEHBIT \?L1
	PRINTR "You can't launch that by saying ""launch""!"
?L1:	PRINTR "That's pretty weird."

	.FUNCT V-LEAN-ON
	PRINTR "Getting tired?"

	.FUNCT V-LEAP,TX,S
	ZERO? PRSO /?L1
	IN? PRSO,HERE \?L3
	FSET? PRSO,ACTORBIT \?L5
	PRINTI "The "
	PRINTD PRSO
	PRINTR " is too big to jump over."
?L5:	CALL V-SKIP >STACK
	RSTACK
?L3:	PRINTR "That would be a good trick."
?L1:	GETPT HERE,P?DOWN >TX
	ZERO? TX /?L13
	PTSIZE TX >S
	EQUAL? S,2 /?L16
	EQUAL? S,4 \?L14
	GETB TX,1 >STACK
	VALUE STACK >STACK
	ZERO? STACK \?L14
?L16:	PRINTI "This was not a very safe place to try jumping."
	CRLF
	CALL PRINT-ID,STR?40
	CALL PICK-ONE,JUMPLOSS >STACK
	CALL JIGS-UP,STACK >STACK
	RSTACK
?L14:	CALL NULL-F >STACK
	ZERO? STACK \TRUE
	CALL V-SKIP >STACK
	RSTACK
?L13:	CALL V-SKIP >STACK
	RSTACK

	.FUNCT V-LEAVE
	CALL DO-WALK,P?OUT >STACK
	RSTACK

	.FUNCT V-LISTEN
	PRINTI "The "
	PRINTD PRSO
	PRINTR " makes no sound."

	.FUNCT V-LOCK
	PRINTR "It doesn't seem to work."

	.FUNCT V-LOOK
	CALL DESCRIBE-ROOM,1 >STACK
	ZERO? STACK /FALSE
	CALL DESCRIBE-OBJECTS,1 >STACK
	RSTACK

	.FUNCT V-LOOK-BEHIND
	PRINTI "There is nothing behind the "
	PRINTD PRSO
	PRINTR "."

	.FUNCT V-LOOK-INSIDE
	FSET? PRSO,DOORBIT \?L1
	FSET? PRSO,OPENBIT \?L3
	PRINTI "The "
	PRINTD PRSO
	PRINTR " is open, but I can't tell what's beyond it."
?L3:	PRINTI "The "
	PRINTD PRSO
	PRINTR " is closed."
?L1:	FSET? PRSO,CONTBIT \?L10
	FSET? PRSO,ACTORBIT \?L11
	PRINTR "There is nothing special to be seen."
?L11:	CALL SEE-INSIDE?,PRSO >STACK
	ZERO? STACK /?L15
	FIRST? PRSO >STACK \?L16
	CALL PRINT-CONT,PRSO >STACK
	ZERO? STACK \TRUE
?L16:	FSET? PRSO,SURFACEBIT \?L18
	PRINTI "There is nothing on the "
	PRINTD PRSO
	PRINTR "."
?L18:	PRINTI "The "
	PRINTD PRSO
	PRINTR " is empty."
?L15:	PRINTI "The "
	PRINTD PRSO
	PRINTR " is closed."
?L10:	PRINTI "You can't look inside a "
	PRINTD PRSO
	PRINTR "."

	.FUNCT V-LOOK-ON
	FSET? PRSO,SURFACEBIT \?L1
	CALL PERFORM,V?LOOK-INSIDE,PRSO
	RTRUE
?L1:	PRINTI "Look on a "
	PRINTD PRSO
	PRINTR "???"

	.FUNCT V-LOOK-UNDER
	PRINTR "There is nothing but dust there."

	.FUNCT V-LOWER
	CALL HACK-HACK,STR?41 >STACK
	RSTACK

	.FUNCT V-MAKE
	PRINTR "You can't do that."

	.FUNCT V-MELT
	PRINTI "It's not clear that a "
	PRINTD PRSO
	PRINTI " can be melted."
	CRLF
	CALL IS-PERSON? >STACK
	CALL PRINT-ID,STR?42,STACK
	CALL IS-OBJ-PROP-ANIMAL? >STACK
	CALL PRINT-ID,STR?43,STACK
	CALL IS-PART-OF-SELF-OR-SELF? >STACK
	CALL PRINT-ID,STR?44,STACK >STACK
	RSTACK

	.FUNCT PRE-MOVE
	CALL HELD?,PRSO >STACK
	ZERO? STACK /FALSE
	PRINTR "You aren't an accomplished enough juggler."

	.FUNCT V-MOVE
	FSET? PRSO,TAKEBIT \?L1
	PRINTI "Moving the "
	PRINTD PRSO
	PRINTR " reveals nothing."
?L1:	PRINTI "You can't move the "
	PRINTD PRSO
	PRINTR "."

	.FUNCT V-MUMBLE
	PRINTR "You'll have to speak up if you expect me to hear you!"

	.FUNCT PRE-MUNG
	EQUAL? PRSO,BEAM /FALSE
	ZERO? PRSI /?L4
	FSET? PRSI,WEAPONBIT /FALSE
?L4:	PRINTI "Trying to destroy the "
	PRINTD PRSO
	PRINTI " with "
	CALL IS-PERSON? >STACK
	CALL PRINT-ID,STR?45,STACK
	CALL IS-OBJ-PROP-ANIMAL? >STACK
	CALL PRINT-ID,STR?46,STACK
	CALL IS-PART-OF-SELF-OR-SELF? >STACK
	CALL PRINT-ID,STR?47,STACK
	ZERO? PRSI \?L7
	PRINTI "your bare hands"
	JUMP ?L11
?L7:	PRINTI "a "
	PRINTD PRSI
?L11:	PRINTR " is futile."

	.FUNCT V-MUNG
	FSET? PRSO,ACTORBIT \?L1
	CALL PERFORM,V?ATTACK,PRSO,PRSI
	RTRUE
?L1:	PRINTI "Nice try."
	CRLF
	CALL IS-OBJECT-OR-PROPERTY? >STACK
	CALL PRINT-ID,STR?48,STACK >STACK
	RSTACK

	.FUNCT V-ODYSSEUS
	CALL NULL-F >STACK
	ZERO? STACK \TRUE
	PRINTR "Wasn't he a sailor?"

	.FUNCT V-OIL
	PRINTR "You probably put spinach in your gas tank, too."

	.FUNCT V-OPEN,F,STR
	FSET? PRSO,CONTBIT \?L1
	GETP PRSO,P?CAPACITY >STACK
	ZERO? STACK /?L1
	FSET? PRSO,OPENBIT \?L3
	PRINTR "It is already open."
?L3:	FSET PRSO,OPENBIT
	FSET PRSO,TOUCHBIT
	FIRST? PRSO >STACK \?L10
	FSET? PRSO,TRANSBIT \?L8
?L10:	PRINTR "Opened."
?L8:	FIRST? PRSO >F \?L13
	NEXT? F >STACK /?L13
	FSET? F,TOUCHBIT /?L13
	GETP F,P?FDESC >STR
	ZERO? STR /?L13
	PRINTI "The "
	PRINTD PRSO
	PRINTI " opens."
	CRLF
	PRINT STR
	CRLF
	RTRUE
?L13:	PRINTI "Opening the "
	PRINTD PRSO
	PRINTI " reveals "
	CALL PRINT-CONTENTS,PRSO
	PRINTR "."
?L1:	FSET? PRSO,DOORBIT \?L23
	FSET? PRSO,OPENBIT \?L24
	PRINTR "It is already open."
?L24:	PRINTI "The "
	PRINTD PRSO
	PRINTI " opens."
	CRLF
	FSET PRSO,OPENBIT
	RTRUE
?L23:	PRINTI "You must tell me how to do that to a "
	PRINTD PRSO
	PRINTR "."

	.FUNCT V-OVERBOARD,LOCN
	CALL NULL-F >STACK
	ZERO? STACK \TRUE
	LOC WINNER >STACK
	FSET? STACK,VEHBIT \?L3
	CALL PERFORM,V?THROW,PRSO
	RTRUE
?L3:	PRINTR "Huh?"

	.FUNCT V-PICK
	PRINTI "You can't pick that."
	CRLF
	CALL IS-BAD-TO-PICK? >STACK
	CALL PRINT-ID,STR?49,STACK >STACK
	RSTACK

	.FUNCT V-PLAY
	FSET? PRSO,ACTORBIT \?L1
	PRINTI "You become so engrossed in the role of the "
	PRINTD PRSO
	PRINTI " that you kill yourself, just as he might have done!"
	CRLF
	CALL PRINT-ID,STR?50
	CALL JIGS-UP,STR?51 >STACK
	RSTACK
?L1:	PRINTR "That's silly!"

	.FUNCT V-PLUG
	PRINTR "This has no effect."

	.FUNCT V-POUR-ON
	EQUAL? PRSO,WATER \?L1
	CALL REMOVE-CAREFULLY,PRSO
	FSET? PRSI,FLAMEBIT \?L3
	FSET? PRSI,ONBIT \?L3
	PRINTI "The "
	PRINTD PRSI
	PRINTI " is extinguished."
	CRLF
	CALL NULL-F
	FCLEAR PRSI,ONBIT
	FCLEAR PRSI,FLAMEBIT
	RTRUE
?L3:	PRINTI "The water spills over the "
	PRINTD PRSI
	PRINTR ", to the floor, and evaporates."
?L1:	CALL NULL-F >STACK
	ZERO? STACK \TRUE
	PRINTR "You can't pour that."

	.FUNCT V-PRAY
	CALL NULL-F >STACK
	ZERO? STACK \TRUE
	PRINTR "If you pray enough, your prayers may be answered."

	.FUNCT V-PUMP
	CALL NULL-F >STACK
	ZERO? STACK \TRUE
	CALL NULL-F >STACK
	ZERO? STACK \TRUE
	PRINTR "It's really not clear how."

	.FUNCT V-PUSH
	CALL HACK-HACK,STR?52 >STACK
	RSTACK

	.FUNCT V-PUSH-TO
	PRINTR "You can't push things to that."

	.FUNCT PRE-PUT
	EQUAL? PRSO,SHORT-POLE /FALSE
	CALL PRE-GIVE >STACK
	RSTACK

	.FUNCT V-PUT,?TMP
	FSET? PRSI,OPENBIT /?L7
	FSET? PRSI,DOORBIT /?L4
	FSET? PRSI,CONTBIT /?L4
	FSET? PRSI,VEHBIT /?L4
	PRINTR "You can't do that."
?L4:	FSET? PRSI,OPENBIT /?L7
	PRINTI "The "
	PRINTD PRSI
	PRINTI " isn't open."
	CRLF
	CALL THIS-IS-IT,PRSI >STACK
	RSTACK
?L7:	EQUAL? PRSI,PRSO \?L11
	PRINTR "How can you do that?"
?L11:	IN? PRSO,PRSI \?L14
	PRINTI "The "
	PRINTD PRSO
	PRINTI " is already in the "
	PRINTD PRSI
	PRINTR "."
?L14:	CALL WEIGHT,PRSI >?TMP
	CALL WEIGHT,PRSO >STACK
	ADD ?TMP,STACK >?TMP
	GETP PRSI,P?SIZE >STACK
	SUB ?TMP,STACK >?TMP
	GETP PRSI,P?CAPACITY >STACK
	GRTR? ?TMP,STACK \?L17
	PRINTR "There's no room."
?L17:	CALL HELD?,PRSO >STACK
	ZERO? STACK \?L20
	FSET? PRSO,TRYTAKEBIT \?L20
	PRINTI "You don't have the "
	PRINTD PRSO
	PRINTR "."
?L20:	CALL HELD?,PRSO >STACK
	ZERO? STACK \?L23
	CALL ITAKE >STACK
	ZERO? STACK /TRUE
?L23:	MOVE PRSO,PRSI
	FSET PRSO,TOUCHBIT
	CALL SCORE-OBJ,PRSO
	PRINTR "Done."

	.FUNCT V-PUT-BEHIND
	PRINTR "That hiding place is too obvious."

	.FUNCT V-PUT-ON
	EQUAL? PRSI,GROUND \?L1
	CALL PERFORM,V?DROP,PRSO
	RTRUE
?L1:	FSET? PRSI,SURFACEBIT \?L3
	CALL V-PUT >STACK
	RSTACK
?L3:	PRINTI "There's no good surface on the "
	PRINTD PRSI
	PRINTR "."

	.FUNCT V-PUT-UNDER
	PRINTR "You can't do that."

	.FUNCT V-RAISE
	CALL V-LOWER >STACK
	RSTACK

	.FUNCT V-RAPE
	PRINTI "What a (ahem!) strange idea."
	CRLF
	CALL IS-PERSON? >STACK
	CALL PRINT-ID,STR?53,STACK
	CALL IS-ANIMAL? >STACK
	CALL PRINT-ID,STR?54,STACK >STACK
	RSTACK

	.FUNCT PRE-READ
	ZERO? LIT \?L1
	PRINTR "It is impossible to read in the dark."
?L1:	ZERO? PRSI /FALSE
	FSET? PRSI,TRANSBIT /FALSE
	PRINTI "How does one look through a "
	PRINTD PRSI
	PRINTR "?"

	.FUNCT V-READ
	FSET? PRSO,READBIT /?L1
	PRINTI "How does one read a "
	PRINTD PRSO
	PRINTR "?"
?L1:	GETP PRSO,P?TEXT >STACK
	PRINT STACK
	CRLF
	RTRUE

	.FUNCT V-READ-PAGE
	CALL PERFORM,V?READ,PRSO
	RTRUE

	.FUNCT V-REPENT
	PRINTR "It could very well be too late!"

	.FUNCT V-REPLY
	PRINTI "It is hardly likely that the "
	PRINTD PRSO
	PRINTI " is interested."
	CRLF
	SET 'P-CONT,0
	SET 'QUOTE-FLAG,0
	RTRUE

	.FUNCT V-RING
	PRINTR "How, exactly, can you ring that?"

	.FUNCT V-RUB
	CALL IS-PERSON? >STACK
	CALL PRINT-ID,STR?55,STACK
	CALL HACK-HACK,STR?56 >STACK
	RSTACK

	.FUNCT V-SAY,V
	FSET? FRONT-DOOR,TOUCHBIT \?L1
	GET P-LEXV,P-CONT >STACK
	EQUAL? STACK,W?FROTZ \?L1
	ADD P-CONT,2 >STACK
	GET P-LEXV,STACK >STACK
	EQUAL? STACK,W?OZMOO \?L1
	SET 'P-CONT,0
	EQUAL? HERE,MSTAIRS \?L3
	CRLF
	CALL GOTO,FRONT-DOOR
	RTRUE
?L3:	PRINTR "Nothing happens."
?L1:	SET 'QUOTE-FLAG,0
	CALL FIND-IN,HERE,ACTORBIT >V
	ZERO? V /?L9
	PRINTI "You must address the "
	PRINTD V
	PRINTI " directly."
	CRLF
	SET 'P-CONT,0
	RTRUE
?L9:	GET P-LEXV,P-CONT >STACK
	EQUAL? STACK,W?HELLO /TRUE
	SET 'P-CONT,0
	PRINTR "Talking to yourself is a sign of impending mental collapse."

	.FUNCT V-SEARCH
	PRINTR "You find nothing unusual."

	.FUNCT V-SEND
	FSET? PRSO,ACTORBIT \?L1
	PRINTI "Why would you send for the "
	PRINTD PRSO
	PRINTR "?"
?L1:	PRINTR "That doesn't make sends."

	.FUNCT PRE-SGIVE
	CALL PERFORM,V?GIVE,PRSI,PRSO
	RTRUE

	.FUNCT V-SGIVE
	PRINTR "Foo!"

	.FUNCT V-SHAKE
	FSET? PRSO,ACTORBIT \?L1
	PRINTR "This seems to have no effect."
?L1:	FSET? PRSO,TAKEBIT /?L5
	PRINTR "You can't take it; thus, you can't shake it!"
?L5:	FSET? PRSO,CONTBIT \?L8
	FSET? PRSO,OPENBIT \?L9
	FIRST? PRSO >STACK \?L11
	CALL SHAKE-LOOP
	PRINTI "The contents of the "
	PRINTD PRSO
	PRINTI " spill "
	FSET? HERE,NONLANDBIT \?L15
	PRINTI "out and disappear"
	JUMP ?L19
?L15:	PRINTI "to the ground"
?L19:	PRINTR "."
?L11:	PRINTR "Shaken."
?L9:	FIRST? PRSO >STACK \?L28
	PRINTI "It sounds like there is something inside the "
	PRINTD PRSO
	PRINTR "."
?L28:	PRINTI "The "
	PRINTD PRSO
	PRINTR " sounds empty."
?L8:	PRINTR "Shaken."

	.FUNCT SHAKE-LOOP,X
?L1:	FIRST? PRSO >X \TRUE
	FSET X,TOUCHBIT
	EQUAL? HERE,ON-LAKE \?L5
	PUSH IN-LAKE
	JUMP ?L7
?L5:	PUSH HERE
?L7:	MOVE X,STACK
	JUMP ?L1

	.FUNCT V-SKIP
	CALL PICK-ONE,WHEEEEE >STACK
	PRINT STACK
	CRLF
	RTRUE

	.FUNCT V-SMELL
	PRINTI "It smells like a "
	PRINTD PRSO
	PRINTR "."

	.FUNCT V-SPIN
	PRINTR "You can't spin that!"

	.FUNCT V-SPRAY
	CALL V-SQUEEZE >STACK
	RSTACK

	.FUNCT V-SQUEEZE
	FSET? PRSO,ACTORBIT \?L1
	PRINTI "The "
	PRINTD PRSO
	PRINTR " does not understand this."
?L1:	PRINTR "How singularly useless."

	.FUNCT V-SSPRAY
	CALL PERFORM,V?SPRAY,PRSI,PRSO >STACK
	RSTACK

	.FUNCT V-STAB,W
	CALL FIND-WEAPON,WINNER >W
	ZERO? W /?L1
	CALL PERFORM,V?ATTACK,PRSO,W
	RTRUE
?L1:	PRINTI "No doubt you propose to stab the "
	PRINTD PRSO
	PRINTI " with your pinky?"
	CRLF
	CALL IS-PERSON? >STACK
	CALL PRINT-ID,STR?57,STACK
	CALL IS-OBJ-PROP-ANIMAL? >STACK
	CALL PRINT-ID,STR?58,STACK
	CALL IS-PART-OF-SELF-OR-SELF? >STACK
	CALL PRINT-ID,STR?59,STACK >STACK
	RSTACK

	.FUNCT V-STAND
	LOC WINNER >STACK
	FSET? STACK,VEHBIT \?L1
	LOC WINNER >STACK
	CALL PERFORM,V?DISEMBARK,STACK
	RTRUE
?L1:	PRINTR "You are already standing, I think."

	.FUNCT V-STAY
	PRINTR "You will be lost without me!"

	.FUNCT V-STRIKE
	FSET? PRSO,ACTORBIT \?L1
	PRINTI "Since you aren't versed in hand-to-hand combat, you'd better attack the "
	PRINTD PRSO
	PRINTI " with a weapon."
	CRLF
	CALL PRINT-ID,STR?60 >STACK
	RSTACK
?L1:	CALL PERFORM,V?LAMP-ON,PRSO
	RTRUE

	.FUNCT V-SWIM
	EQUAL? HERE,ON-LAKE,IN-LAKE \?L1
	PRINTR "What do you think you're doing?"
?L1:	EQUAL? HERE,FLATHEAD-OCEAN \?L5
	PRINTR "Between the rocks and waves, you wouldn't last a minute!"
?L5:	PRINTR "Go jump in a lake!"

	.FUNCT V-SWING
	ZERO? PRSI \?L1
	PRINTR "Whoosh!"
?L1:	CALL PERFORM,V?ATTACK,PRSI,PRSO >STACK
	RSTACK

	.FUNCT PRE-TAKE
	IN? PRSO,WINNER \?L1
	FSET? PRSO,WEARBIT \?L3
	PRINTR "You are already wearing it."
?L3:	PRINTR "You already have that!"
?L1:	LOC PRSO >STACK
	FSET? STACK,CONTBIT \?L10
	LOC PRSO >STACK
	FSET? STACK,OPENBIT /?L10
	PRINTR "You can't reach something that's inside a closed container."
?L10:	ZERO? PRSI /?L13
	EQUAL? PRSI,GROUND \?L14
	SET 'PRSI,0
	RFALSE
?L14:	CALL NULL-F
	LOC PRSO >STACK
	EQUAL? PRSI,STACK /?L17
	PRINTI "The "
	PRINTD PRSO
	PRINTI " isn't in the "
	PRINTD PRSI
	PRINTR "."
?L17:	SET 'PRSI,0
	RFALSE
?L13:	LOC WINNER >STACK
	EQUAL? PRSO,STACK \FALSE
	PRINTR "You're inside of it!"

	.FUNCT V-TAKE
	CALL ITAKE >STACK
	EQUAL? STACK,1 \FALSE
	FSET? PRSO,WEARBIT \?L3
	PRINTI "You are now wearing the "
	PRINTD PRSO
	PRINTR "."
?L3:	PRINTI "Taken."
	CRLF
	CALL IS-THEFT? >STACK
	CALL PRINT-ID,STR?61,STACK >STACK
	RSTACK

	.FUNCT V-TELL
	FSET? PRSO,ACTORBIT \?L1
	ZERO? P-CONT /?L3
	SET 'WINNER,PRSO
	LOC WINNER >HERE
	RETURN HERE
?L3:	PRINTI "The "
	PRINTD PRSO
	PRINTR " pauses for a moment, perhaps thinking that you should reread the manual."
?L1:	PRINTI "You can't talk to the "
	PRINTD PRSO
	PRINTI "!"
	CRLF
	SET 'QUOTE-FLAG,0
	SET 'P-CONT,0
	RETURN 2

	.FUNCT V-THROUGH,OBJ=0,M
	FSET? PRSO,DOORBIT \?L1
	CALL OTHER-SIDE,PRSO >M
	ZERO? M /?L1
	CALL DO-WALK,M
	RTRUE
?L1:	ZERO? OBJ \?L5
	FSET? PRSO,VEHBIT \?L3
	CALL PERFORM,V?BOARD,PRSO
	RTRUE
?L3:	ZERO? OBJ \?L5
	FSET? PRSO,TAKEBIT /?L4
?L5:	CALL NULL-F
	PRINTI "You hit your head against the "
	PRINTD PRSO
	PRINTI " as you attempt this feat."
	CRLF
	CALL IS-OBJECT-OR-PROPERTY? >STACK
	CALL PRINT-ID,STR?62,STACK >STACK
	RSTACK
?L4:	IN? PRSO,WINNER \?L8
	PRINTR "That would involve quite a contortion!"
?L8:	CALL PICK-ONE,YUKS >STACK
	PRINT STACK
	CRLF
	RTRUE

	.FUNCT V-THROW
	CALL IDROP >STACK
	ZERO? STACK /?L1
	EQUAL? PRSI,ME \?L3
	PRINTI "A terrific throw! The "
	PRINTD PRSO
	SET 'WINNER,PLAYER
	CALL PRINT-ID,STR?63
	CALL JIGS-UP,STR?64 >STACK
	RSTACK
?L3:	ZERO? PRSI /?L7
	FSET? PRSI,ACTORBIT \?L7
	PRINTI "The "
	PRINTD PRSI
	PRINTI " ducks as the "
	PRINTD PRSO
	PRINTI " flies by and crashes to the ground."
	CRLF
	FSET? PRSO,WEAPONBIT /?L10
	PUSH 0
	JUMP ?L11
?L10:	PUSH 1
?L11:	CALL PRINT-ID,STR?65,STACK >STACK
	RSTACK
?L7:	PRINTR "Thrown."
?L1:	PRINTR "Huh?"

	.FUNCT V-THROW-OFF
	PRINTR "You can't throw anything off of that!"

	.FUNCT V-TIE
	EQUAL? PRSI,WINNER \?L1
	PRINTR "You can't tie anything to yourself."
?L1:	PRINTI "You can't tie the "
	PRINTD PRSO
	PRINTI " to that."
	CRLF
	CALL IS-PERSON? >STACK
	CALL PRINT-ID,STR?66,STACK >STACK
	RSTACK

	.FUNCT V-TIE-UP
	PRINTI "You could certainly never tie it with that!"
	CRLF
	CALL IS-PERSON? >STACK
	CALL PRINT-ID,STR?67,STACK >STACK
	RSTACK

	.FUNCT V-TREASURE
	CALL NULL-F >STACK
	ZERO? STACK \TRUE
	CALL NULL-F >STACK
	ZERO? STACK \TRUE
	PRINTR "Nothing happens."

	.FUNCT PRE-TURN
	EQUAL? PRSI,0,ROOMS \?L6
	EQUAL? PRSO,DIAL,TM-DIAL,T-BAR \?L1
	PRINTI "You should turn the "
	PRINTD PRSO
	PRINTR " to something."
?L1:	EQUAL? PRSI,0,ROOMS \?L6
	PRINTR "Your bare hands don't appear to be enough."
?L6:	FSET? PRSO,TURNBIT /FALSE
	PRINTR "You can't turn that!"

	.FUNCT V-TURN
	PRINTR "This has no effect."

	.FUNCT V-UNLOCK
	CALL V-LOCK >STACK
	RSTACK

	.FUNCT V-UNTIE
	PRINTR "This cannot be tied, so it cannot be untied!"

	.FUNCT V-WAIT,NUM=3
	PRINTI "Time passes..."
	CRLF
?L3:	DLESS? 'NUM,0 /?L4
	CALL CLOCKER >STACK
	ZERO? STACK /?L3
?L4:	SET 'CLOCK-WAIT,1
	RETURN CLOCK-WAIT

	.FUNCT V-WALK,PT,PTS,STR,OBJ,RM
	ZERO? P-WALK-DIR \?L1
	CALL PERFORM,V?WALK-TO,PRSO
	RTRUE
?L1:	GETPT HERE,PRSO >PT
	ZERO? PT /?L3
	PTSIZE PT >PTS
	EQUAL? PTS,UEXIT \?L4
	GETB PT,REXIT >STACK
	CALL GOTO,STACK >STACK
	RSTACK
?L4:	EQUAL? PTS,NEXIT \?L6
	GET PT,NEXITSTR >STACK
	PRINT STACK
	CRLF
	RETURN 2
?L6:	EQUAL? PTS,FEXIT \?L11
	GET PT,FEXITFCN >STACK
	CALL STACK >RM
	ZERO? RM /?L12
	CALL GOTO,RM >STACK
	RSTACK
?L12:	EQUAL? HERE,CP \?L14
	ZERO? CP-MOVED \TRUE
?L14:	RETURN 2
?L11:	EQUAL? PTS,CEXIT \?L18
	GETB PT,CEXITFLAG >STACK
	VALUE STACK >STACK
	ZERO? STACK /?L19
	GETB PT,REXIT >STACK
	CALL GOTO,STACK >STACK
	RSTACK
?L19:	GET PT,CEXITSTR >STR
	ZERO? STR /?L21
	PRINT STR
	CRLF
	RETURN 2
?L21:	PRINTI "You can't go that way."
	CRLF
	RETURN 2
?L18:	EQUAL? PTS,DEXIT \FALSE
	GETB PT,DEXITOBJ >OBJ
	FSET? OBJ,OPENBIT \?L32
	GETB PT,REXIT >STACK
	CALL GOTO,STACK >STACK
	RSTACK
?L32:	GET PT,DEXITSTR >STR
	ZERO? STR /?L34
	PRINT STR
	CRLF
	RETURN 2
?L34:	PRINTI "The "
	PRINTD OBJ
	PRINTI " is closed."
	CRLF
	CALL THIS-IS-IT,OBJ
	RETURN 2
?L3:	ZERO? LIT \?L45
	RANDOM 100 >STACK
	GRTR? 80,STACK \?L45
	EQUAL? WINNER,ADVENTURER \?L45
	FSET? HERE,NONLANDBIT /?L45
	ZERO? SPRAYED? /?L46
	PRINTI "There are odd noises in the darkness, and there is no exit in that direction."
	CRLF
	RETURN 2
?L46:	EQUAL? HERE,DARK-1,DARK-2 \?L52
	CALL JIGS-UP,STR?68 >STACK
	RSTACK
?L52:	CALL JIGS-UP,STR?69 >STACK
	RSTACK
?L45:	PRINTI "You can't go that way."
	CRLF
	RETURN 2

	.FUNCT V-WALK-AROUND
	PRINTR "Use compass directions for movement."

	.FUNCT V-WALK-TO
	ZERO? PRSO /?L1
	IN? PRSO,HERE /?L3
	CALL GLOBAL-IN?,PRSO,HERE >STACK
	ZERO? STACK /?L1
?L3:	PRINTR "It's here!"
?L1:	PRINTR "You should supply a direction!"

	.FUNCT V-WAVE
	CALL HACK-HACK,STR?70 >STACK
	RSTACK

	.FUNCT V-WEAR
	FSET? PRSO,WEARBIT /?L1
	PRINTI "You can't wear the "
	PRINTD PRSO
	PRINTR "."
?L1:	CALL PERFORM,V?TAKE,PRSO
	RTRUE

	.FUNCT V-WIN
	PRINTR "Naturally!"

	.FUNCT V-WIND
	PRINTI "You cannot wind up a "
	PRINTD PRSO
	PRINTR "."

	.FUNCT V-WISH
	PRINTR "With luck, your wish will come true."

	.FUNCT V-YELL
	PRINTI "Aaaarrrrgggghhhh!"
	CRLF
	CALL PRINT-ID,STR?71 >STACK
	RSTACK

	.FUNCT V-ZORK
	PRINTR "At your service!"

	.FUNCT V-FIRST-LOOK
	CALL DESCRIBE-ROOM >STACK
	ZERO? STACK /FALSE
	ZERO? SUPER-BRIEF \FALSE
	CALL DESCRIBE-OBJECTS >STACK
	RSTACK

	.FUNCT DESCRIBE-ROOM,LOOK?=0,V?,STR,AV
	SET 'V?,LOOK?
	ZERO? V? \?L1
	SET 'V?,VERBOSE
?L1:	ZERO? LIT \?L3
	PRINTI "It is pitch black."
	ZERO? SPRAYED? \?L7
	PRINTI " You are likely to be eaten by a grue."
?L7:	CRLF
	EQUAL? HERE,DARK-2 \FALSE
	PRINTI "The ground continues to slope upwards away from the lake. You can barely detect a dim light from the east."
	CRLF
	RFALSE
?L3:	FSET? HERE,TOUCHBIT /?L18
	FSET HERE,TOUCHBIT
	SET 'V?,1
?L18:	CALL NULL-F
	IN? HERE,ROOMS \?L21
	PRINTD HERE
	LOC WINNER >AV
	FSET? AV,VEHBIT \?L25
	PRINTI ", in the "
	PRINTD AV
?L25:	CRLF
?L21:	ZERO? LOOK? \?L33
	ZERO? SUPER-BRIEF \TRUE
?L33:	LOC WINNER >AV
	ZERO? V? /?L36
	GETP HERE,P?ACTION >STACK
	CALL STACK,M-LOOK >STACK
	ZERO? STACK \TRUE
	ZERO? V? /?L36
	GETP HERE,P?LDESC >STR
	ZERO? STR /?L36
	PRINT STR
	CRLF
	JUMP ?L39
?L36:	GETP HERE,P?ACTION >STACK
	CALL STACK,M-FLASH >STACK
?L39:	EQUAL? HERE,AV /TRUE
	FSET? AV,VEHBIT \TRUE
	GETP AV,P?ACTION >STACK
	CALL STACK,M-LOOK >STACK
	RTRUE

	.FUNCT DESCRIBE-OBJECTS,V?=0
	ZERO? LIT /?L1
	FIRST? HERE >STACK \FALSE
	ZERO? V? \?L5
	SET 'V?,VERBOSE
?L5:	CALL PRINT-CONT,HERE,V?,-1 >STACK
	RSTACK
?L1:	PRINTR "Only bats can see in the dark. And you're not one."

	.FUNCT DESCRIBE-OBJECT,OBJ,V?,LEVEL,STR=0,AV
	SET 'DESC-OBJECT,OBJ
	ZERO? LEVEL \?L8
	GETP OBJ,P?DESCFCN >STACK
	CALL STACK,M-OBJDESC >STACK
	ZERO? STACK \TRUE
	ZERO? LEVEL \?L8
	FSET? OBJ,TOUCHBIT /?L5
	GETP OBJ,P?FDESC >STR
	ZERO? STR \?L4
?L5:	GETP OBJ,P?LDESC >STR
	ZERO? STR /?L3
?L4:	PRINT STR
	JUMP ?L27
?L3:	ZERO? LEVEL \?L8
	PRINTI "There is a "
	PRINTD OBJ
	PRINTI " here"
	FSET? OBJ,ONBIT \?L11
	PRINTI " (providing light)"
?L11:	PRINTI "."
	JUMP ?L27
?L8:	GET INDENTS,LEVEL >STACK
	PRINT STACK
	PRINTI "A "
	PRINTD OBJ
	FSET? OBJ,ONBIT \?L23
	PRINTI " (providing light)"
	JUMP ?L27
?L23:	FSET? OBJ,WEARBIT \?L27
	IN? OBJ,WINNER \?L27
	PRINTI " (being worn)"
?L27:	CALL NULL-F
	ZERO? LEVEL \?L31
	LOC WINNER >AV
	ZERO? AV /?L31
	FSET? AV,VEHBIT \?L31
	PRINTI " (outside the "
	PRINTD AV
	PRINTI ")"
?L31:	CRLF
	CALL SEE-INSIDE?,OBJ >STACK
	ZERO? STACK /FALSE
	FIRST? OBJ >STACK \FALSE
	CALL PRINT-CONT,OBJ,V?,LEVEL >STACK
	RSTACK

	.FUNCT PRINT-CONTENTS,OBJ,F,N,1ST?=1,IT?=0,TWO?=0
	FIRST? OBJ >F \FALSE
?L3:	NEXT? F >N /?L5
?L5:	ZERO? 1ST? /?L6
	SET '1ST?,0
	JUMP ?L11
?L6:	PRINTI ", "
	ZERO? N \?L11
	PRINTI "and "
?L11:	PRINTI "a "
	PRINTD F
	ZERO? IT? \?L18
	ZERO? TWO? \?L18
	SET 'IT?,F
	JUMP ?L20
?L18:	SET 'TWO?,1
	SET 'IT?,0
?L20:	SET 'F,N
	ZERO? F \?L3
	ZERO? IT? /TRUE
	ZERO? TWO? \TRUE
	CALL THIS-IS-IT,IT?
	RTRUE

	.FUNCT PRINT-CONT,OBJ,V?=0,LEVEL=0,Y,1ST?,SHIT,AV,STR,PV?=0,INV?=0
	FIRST? OBJ >Y \TRUE
	LOC WINNER >AV
	ZERO? AV /?L4
	FSET? AV,VEHBIT /?L6
?L4:	SET 'AV,0
?L6:	SET '1ST?,1
	SET 'SHIT,1
	LOC OBJ >STACK
	EQUAL? WINNER,OBJ,STACK \?L7
	SET 'INV?,1
	JUMP ?L11
?L7:	ZERO? Y /?L11
?L12:	EQUAL? Y,AV \?L14
	SET 'PV?,1
	JUMP ?L24
?L14:	EQUAL? Y,WINNER /?L24
	FSET? Y,INVISIBLE /?L24
	FSET? Y,TOUCHBIT /?L24
	GETP Y,P?FDESC >STR
	ZERO? STR /?L24
	FSET? Y,NDESCBIT /?L17
	PRINT STR
	CRLF
	SET 'SHIT,0
?L17:	CALL SEE-INSIDE?,Y >STACK
	ZERO? STACK /?L24
	LOC Y >STACK
	GETP STACK,P?DESCFCN >STACK
	ZERO? STACK \?L24
	FIRST? Y >STACK \?L24
	CALL PRINT-CONT,Y,V?,0 >STACK
	ZERO? STACK /?L24
	SET '1ST?,0
?L24:	NEXT? Y >Y /?L12
?L11:	FIRST? OBJ >Y /?L33
?L62:	ZERO? PV? /?L32
	ZERO? AV /?L32
	FIRST? AV >STACK \?L32
	INC 'LEVEL
	CALL PRINT-CONT,AV,V?,LEVEL
	JUMP ?L32
?L33:	EQUAL? Y,AV,ADVENTURER /?L55
	FSET? Y,INVISIBLE /?L55
	ZERO? INV? \?L40
	FSET? Y,TOUCHBIT /?L40
	GETP Y,P?FDESC >STACK
	ZERO? STACK \?L55
?L40:	FSET? Y,NDESCBIT /?L41
	ZERO? 1ST? /?L43
	CALL FIRSTER,OBJ,LEVEL >STACK
	ZERO? STACK /?L47
	LESS? LEVEL,0 \?L47
	SET 'LEVEL,0
?L47:	INC 'LEVEL
	SET '1ST?,0
?L43:	LESS? LEVEL,0 \?L52
	SET 'LEVEL,0
?L52:	CALL DESCRIBE-OBJECT,Y,V?,LEVEL
	JUMP ?L55
?L41:	FIRST? Y >STACK \?L55
	CALL SEE-INSIDE?,Y >STACK
	ZERO? STACK /?L55
	INC 'LEVEL
	CALL PRINT-CONT,Y,V?,LEVEL
	DEC 'LEVEL
?L55:	NEXT? Y >Y /?L33
	JUMP ?L62
?L32:	ZERO? 1ST? /TRUE
	ZERO? SHIT /TRUE
	RFALSE

	.FUNCT FIRSTER,OBJ,LEVEL
	CALL NULL-F >STACK
	ZERO? STACK \TRUE
	EQUAL? OBJ,WINNER \?L3
	PRINTR "You are carrying:"
?L3:	IN? OBJ,ROOMS /FALSE
	GRTR? LEVEL,0 \?L7
	GET INDENTS,LEVEL >STACK
	PRINT STACK
?L7:	FSET? OBJ,SURFACEBIT \?L12
	PRINTI "Sitting on the "
	PRINTD OBJ
	PRINTR " is: "
?L12:	FSET? OBJ,ACTORBIT \?L16
	PRINTI "The "
	PRINTD OBJ
	PRINTR " is holding: "
?L16:	PRINTI "The "
	PRINTD OBJ
	PRINTR " contains:"

	.FUNCT SEE-INSIDE?,OBJ
	FSET? OBJ,INVISIBLE /FALSE
	FSET? OBJ,TRANSBIT /TRUE
	FSET? OBJ,OPENBIT /TRUE
	RFALSE

	.FUNCT SCORE-UPD,NUM
	ADD BASE-SCORE,NUM >BASE-SCORE
	ADD SCORE,NUM >SCORE
	CALL NULL-F
	RTRUE

	.FUNCT SCORE-OBJ,OBJ,TEMP
	GETP OBJ,P?VALUE >TEMP
	GRTR? TEMP,0 \FALSE
	CALL SCORE-UPD,TEMP
	PUTP OBJ,P?VALUE,0
	RTRUE

	.FUNCT YES?
	PRINTI ">"
	READ P-INBUF,P-LEXV
	GET P-LEXV,1 >STACK
	EQUAL? STACK,W?YES,W?Y \FALSE
	RTRUE

	.FUNCT ITAKE,VB=1,CNT,OBJ,?TMP
	CALL NULL-F >STACK
	ZERO? STACK \FALSE
	FSET? PRSO,TAKEBIT /?L3
	ZERO? VB /FALSE
	CALL PICK-ONE,YUKS >STACK
	PRINT STACK
	CRLF
	RFALSE
?L3:	CALL NULL-F >STACK
	ZERO? STACK \FALSE
	LOC PRSO >STACK
	FSET? STACK,CONTBIT \?L10
	LOC PRSO >STACK
	FSET? STACK,OPENBIT \FALSE
?L10:	LOC PRSO >STACK
	IN? STACK,WINNER /?L11
	CALL WEIGHT,PRSO >?TMP
	CALL WEIGHT,WINNER >STACK
	ADD ?TMP,STACK >STACK
	GRTR? STACK,LOAD-ALLOWED \?L11
	ZERO? VB /?L12
	PRINTI "Your load is too heavy"
	LESS? LOAD-ALLOWED,LOAD-MAX \?L16
	PRINTI ", especially in light of your condition."
	JUMP ?L20
?L16:	PRINTI "."
?L20:	CRLF
?L12:	RETURN 2
?L11:	EQUAL? PRSA,V?TAKE \?L26
	CALL CCOUNT,WINNER >CNT
	GRTR? CNT,FUMBLE-NUMBER \?L26
	MUL CNT,FUMBLE-PROB >?TMP
	RANDOM 100 >STACK
	GRTR? ?TMP,STACK \?L26
	PRINTI "You're holding too many things already!"
	CRLF
	RFALSE
?L26:	MOVE PRSO,WINNER
	FCLEAR PRSO,NDESCBIT
	FSET PRSO,TOUCHBIT
	CALL NULL-F
	CALL NULL-F
	RTRUE

	.FUNCT IDROP
	IN? PRSO,WINNER /?L5
	LOC PRSO >STACK
	IN? STACK,WINNER /?L1
	PRINTI "You're not carrying the "
	PRINTD PRSO
	PRINTI "."
	CRLF
	RFALSE
?L1:	IN? PRSO,WINNER /?L5
	LOC PRSO >STACK
	FSET? STACK,OPENBIT /?L5
	PRINTI "The "
	PRINTD PRSO
	PRINTI " is closed."
	CRLF
	RFALSE
?L5:	LOC WINNER >STACK
	MOVE PRSO,STACK
	RTRUE

	.FUNCT CCOUNT,OBJ,CNT=0,X
	FIRST? OBJ >X \?L4
?L3:	FSET? X,WEARBIT /?L5
	INC 'CNT
?L5:	NEXT? X >X /?L3
?L4:	RETURN CNT

	.FUNCT WEIGHT,OBJ,CONT,WT=0
	FIRST? OBJ >CONT \?L4
?L3:	EQUAL? OBJ,PLAYER \?L5
	FSET? CONT,WEARBIT \?L5
	INC 'WT
	JUMP ?L7
?L5:	CALL WEIGHT,CONT >STACK
	ADD WT,STACK >WT
?L7:	NEXT? CONT >CONT /?L3
?L4:	GETP OBJ,P?SIZE >STACK
	ADD WT,STACK >STACK
	RSTACK

	.FUNCT HACK-HACK,STR
	IN? PRSO,GLOBAL-OBJECTS \?L1
	EQUAL? PRSA,V?LOWER,V?RAISE,V?WAVE \?L1
	PRINTI "The "
	PRINTD PRSO
	PRINTR " isn't here!"
?L1:	PRINT STR
	PRINTD PRSO
	CALL PICK-ONE,HO-HUM >STACK
	PRINT STACK
	CRLF
	RTRUE

	.FUNCT NO-GO-TELL,AV,WLOC
	ZERO? AV /?L1
	PRINTI "You can't go there in a "
	PRINTD WLOC
	PRINTR "."
?L1:	PRINTR "You can't go there without a vehicle."

	.FUNCT GOTO,RM,V?=1,LB,WLOC,AV=0,OLIT,OHERE
	FSET? RM,RLANDBIT /?L1
	SET 'LB,0
	JUMP ?L2
?L1:	SET 'LB,1
?L2:	LOC WINNER >WLOC
	SET 'OLIT,LIT
	SET 'OHERE,HERE
	FSET? WLOC,VEHBIT \?L3
	GETP WLOC,P?VTYPE >AV
?L3:	ZERO? LB \?L8
	ZERO? AV \?L6
	CALL NO-GO-TELL,AV,WLOC
	RFALSE
?L6:	ZERO? LB \?L8
	FSET? RM,AV /?L8
	CALL NO-GO-TELL,AV,WLOC
	RFALSE
?L8:	FSET? HERE,RLANDBIT \?L9
	ZERO? LB /?L9
	EQUAL? AV,0,RLANDBIT /?L9
	FSET? RM,AV /?L9
	CALL NO-GO-TELL,AV,WLOC
	RFALSE
?L9:	FSET? RM,RMUNGBIT \?L10
	GETP RM,P?LDESC >STACK
	PRINT STACK
	CRLF
	RFALSE
?L10:	ZERO? LB /?L16
	FSET? HERE,RLANDBIT /?L16
	ZERO? DEAD \?L16
	FSET? WLOC,VEHBIT \?L16
	FSET? WLOC,VEHBIT \?L16
	PRINTI "The "
	PRINTD WLOC
	PRINTI " comes to a stop."
	CRLF
	CRLF
?L16:	ZERO? AV /?L22
	MOVE WLOC,RM
	JUMP ?L24
?L22:	MOVE WINNER,RM
?L24:	SET 'HERE,RM
	CALL LIT?,HERE >LIT
	ZERO? OLIT \?L32
	ZERO? LIT \?L43
	RANDOM 100 >STACK
	GRTR? 80,STACK \?L32
	ZERO? SPRAYED? /?L27
	PRINTI "There are sinister gurgling noises in the darkness all around you!"
	CRLF
	JUMP ?L32
?L27:	EQUAL? HERE,DARK-1,DARK-2 \?L31
	CALL JIGS-UP,STR?72
	JUMP ?L32
?L31:	PRINTI "Oh, no! A lurking grue slithered into the "
	LOC WINNER >STACK
	FSET? STACK,VEHBIT \?L35
	LOC WINNER >STACK
	PRINTD STACK
	JUMP ?L39
?L35:	PRINTI "room"
?L39:	CALL JIGS-UP,STR?73
	RTRUE
?L32:	ZERO? LIT \?L43
	EQUAL? WINNER,ADVENTURER \?L43
	PRINTI "You have moved into a dark place."
	CRLF
	SET 'P-CONT,0
?L43:	GETP HERE,P?ACTION >STACK
	CALL STACK,M-ENTER >STACK
	CALL SCORE-OBJ,RM
	EQUAL? HERE,RM \TRUE
	EQUAL? ADVENTURER,WINNER /?L50
	IN? ADVENTURER,OHERE \?L50
	PRINTI "The "
	PRINTD WINNER
	PRINTR " leaves the room."
?L50:	CALL NULL-F >STACK
	ZERO? STACK \TRUE
	ZERO? V? /TRUE
	EQUAL? WINNER,ADVENTURER \TRUE
	CALL V-FIRST-LOOK
	RTRUE

	.FUNCT LKP,ITM,TBL,CNT=0,LEN
	GET TBL,0 >LEN
?L1:	IGRTR? 'CNT,LEN /FALSE
	GET TBL,CNT >STACK
	EQUAL? STACK,ITM \?L1
	EQUAL? CNT,LEN /FALSE
	ADD CNT,1 >STACK
	GET TBL,STACK >STACK
	RSTACK

	.FUNCT DO-WALK,DIR
	SET 'P-WALK-DIR,DIR
	CALL PERFORM,V?WALK,DIR >STACK
	RSTACK

	.FUNCT GLOBAL-IN?,OBJ1,OBJ2,TX
	GETPT OBJ2,P?GLOBAL >TX
	ZERO? TX /FALSE
	PTSIZE TX >STACK
	DEC 'STACK
	CALL ZMEMQB,OBJ1,TX,STACK >STACK
	RSTACK

	.FUNCT FIND-IN,WHERE,WHAT,W
	FIRST? WHERE >W \FALSE
?L2:	FSET? W,WHAT \?L7
	EQUAL? W,ADVENTURER /?L7
	RETURN W
?L7:	NEXT? W >W /?L2
	RFALSE

	.FUNCT HELD?,CAN
?L1:	LOC CAN >CAN
	ZERO? CAN /FALSE
	EQUAL? CAN,WINNER \?L1
	RTRUE

	.FUNCT OTHER-SIDE,DOBJ,P=0,TX
?L1:	NEXTP HERE,P >P
	LESS? P,P?CROSS /FALSE
	GETPT HERE,P >TX
	PTSIZE TX >STACK
	EQUAL? STACK,DEXIT \?L1
	GETB TX,DEXITOBJ >STACK
	EQUAL? STACK,DOBJ \?L1
	RETURN P

	.FUNCT MUNG-ROOM,RM,STR
	FSET RM,RMUNGBIT
	PUTP RM,P?LDESC,STR
	RTRUE

	.FUNCT THIS-IS-IT,OBJ
	SET 'P-IT-OBJECT,OBJ
	RETURN P-IT-OBJECT

	.FUNCT NOT-HERE-OBJECT-F,TBL,PRSO?=1,OBJ
	EQUAL? PRSO,NOT-HERE-OBJECT \?L5
	EQUAL? PRSI,NOT-HERE-OBJECT \?L1
	PRINTR "Those things aren't here!"
?L1:	EQUAL? PRSO,NOT-HERE-OBJECT \?L5
	SET 'TBL,P-PRSO
	JUMP ?L6
?L5:	SET 'TBL,P-PRSI
	SET 'PRSO?,0
?L6:	SET 'P-CONT,0
	SET 'QUOTE-FLAG,0
	EQUAL? WINNER,PLAYER \?L7
	PRINTI "You can't see any "
	CALL NOT-HERE-PRINT,PRSO?
	PRINTR " here!"
?L7:	PRINTI "The "
	PRINTD WINNER
	PRINTI " seems confused. ""I don't see any "
	CALL NOT-HERE-PRINT,PRSO?
	PRINTR " here!"""

	.FUNCT NOT-HERE-PRINT,PRSO?
	ZERO? P-OFLAG /?L1
	ZERO? P-XADJ /?L3
	PRINTB P-XADJN
?L3:	ZERO? P-XNAM /FALSE
	PRINTB P-XNAM
	RTRUE
?L1:	ZERO? PRSO? /?L9
	GET P-ITBL,P-NC1L >STACK
	GET P-ITBL,P-NC1 >STACK
	CALL BUFFER-PRINT,STACK,STACK,0 >STACK
	RSTACK
?L9:	GET P-ITBL,P-NC2L >STACK
	GET P-ITBL,P-NC2 >STACK
	CALL BUFFER-PRINT,STACK,STACK,0 >STACK
	RSTACK

	.FUNCT NULL-F,A1,A2
	RFALSE

	.FUNCT STAIRS-F
	EQUAL? PRSA,V?THROUGH \FALSE
	PRINTR "You should say whether you want to go up or down."

	.FUNCT SAILOR-FCN
	EQUAL? PRSA,V?TELL \?L1
	SET 'P-CONT,0
	SET 'QUOTE-FLAG,0
	PRINTR "You can't talk to the sailor that way."
?L1:	EQUAL? PRSA,V?EXAMINE \?L5
	FSET? VIKING-SHIP,INVISIBLE /?L6
	PRINTR "He looks like a sailor."
?L6:	PRINTR "There is no sailor to be seen."
?L5:	EQUAL? PRSA,V?HELLO \FALSE
	INC 'HS
	FSET? VIKING-SHIP,INVISIBLE /?L14
	PRINTI "The seaman looks up and maneuvers the boat toward shore. He cries out ""I have waited three ages for someone to say those words and save me from sailing this endless ocean. Please accept this gift. You may find it useful!"" He throws something which falls near you in the sand, then sails off toward the west, singing a lively, but somewhat uncouth, sailor song."
	CRLF
	FSET VIKING-SHIP,INVISIBLE
	MOVE VIAL,HERE
	RTRUE
?L14:	EQUAL? HERE,FLATHEAD-OCEAN \?L18
	ZERO? SHIP-GONE /?L19
	PRINTR "Nothing happens anymore."
?L19:	PRINTR "Nothing happens yet."
?L18:	PRINTR "Nothing happens here."

	.FUNCT GROUND-FUNCTION
	EQUAL? PRSA,V?PUT-ON,V?PUT \?L1
	EQUAL? PRSI,GROUND \?L1
	CALL PERFORM,V?DROP,PRSO
	RTRUE
?L1:	CALL NULL-F >STACK
	ZERO? STACK \FALSE
	EQUAL? PRSA,V?DIG \FALSE
	PRINTR "The ground is too hard for digging here."

	.FUNCT GRUE-FUNCTION
	EQUAL? PRSA,V?EXAMINE \?L1
	PRINTR "The grue is a sinister, lurking presence in the dark places of the earth. Its favorite diet is adventurers, but its insatiable appetite is tempered by its fear of light. No grue has ever been seen by the light of day, and few have survived its fearsome jaws to tell the tale."
?L1:	EQUAL? PRSA,V?FIND \?L5
	PRINTR "There is no grue here, but I'm sure there is at least one lurking in the darkness nearby. I wouldn't let my light go out if I were you!"
?L5:	EQUAL? PRSA,V?LISTEN \FALSE
	PRINTR "It makes no sound but is always lurking in the darkness nearby."

	.FUNCT CRETIN-FCN
	EQUAL? PRSA,V?TELL \?L1
	SET 'P-CONT,0
	SET 'QUOTE-FLAG,0
	PRINTR "Talking to yourself is said to be a sign of impending mental collapse."
?L1:	EQUAL? PRSA,V?GIVE \?L5
	EQUAL? PRSI,ME \?L5
	CALL PERFORM,V?TAKE,PRSO
	RTRUE
?L5:	EQUAL? PRSA,V?MAKE \?L6
	PRINTR "Only you can do that."
?L6:	EQUAL? PRSA,V?DISEMBARK \?L9
	PRINTR "You'll have to do that on your own."
?L9:	EQUAL? PRSA,V?EAT \?L12
	PRINTI "Auto-cannibalism is not the answer."
	CRLF
	CALL PRINT-ID,STR?74 >STACK
	RSTACK
?L12:	EQUAL? PRSA,V?MUNG,V?ATTACK \?L15
	ZERO? PRSI /?L16
	FSET? PRSI,WEAPONBIT \?L16
	CALL PRINT-ID,STR?75
	CALL JIGS-UP,STR?76 >STACK
	RSTACK
?L16:	PRINTI "Suicide is not the answer."
	CRLF
	CALL PRINT-ID,STR?77 >STACK
	RSTACK
?L15:	EQUAL? PRSA,V?THROW \?L21
	EQUAL? PRSO,ME \FALSE
	PRINTR "Why don't you just walk like normal people?"
?L21:	EQUAL? PRSA,V?TAKE \?L27
	PRINTR "How romantic!"
?L27:	EQUAL? PRSA,V?EXAMINE \FALSE
	ZERO? INVIS /?L31
	PRINTR "A good trick, as you are currently invisible."
?L31:	PRINTR "What you can see looks pretty much as usual, sorry to say."

	.FUNCT PATH-OBJECT
	EQUAL? PRSA,V?FOLLOW,V?TAKE \?L1
	PRINTR "You must specify a direction to go."
?L1:	EQUAL? PRSA,V?FIND \?L5
	PRINTR "I can't help you there...."
?L5:	EQUAL? PRSA,V?DIG \FALSE
	PRINTR "Not a chance."

	.FUNCT ZORKMID-FUNCTION
	EQUAL? PRSA,V?EXAMINE \?L1
	PRINTR "The zorkmid is the unit of currency of the Great Underground Empire."
?L1:	EQUAL? PRSA,V?FIND \FALSE
	PRINTR "The best way to find zorkmids is to go out and look for them."

	.FUNCT PRINT-OBJTREE-NODE,OBJ
	LOC OBJ >STACK
	ZERO? STACK /?L1
	LOC OBJ >STACK
	GETP STACK,P?OBJIDX >STACK
	PRINT STACK
	PRINTI " / "
	JUMP ?L5
?L1:	PRINTI "-1 / "
?L5:	FSET? OBJ,FIGHTBIT \?L8
	PRINTI "0 "
?L8:	FSET? OBJ,FLAMEBIT \?L13
	PRINTI "1 "
?L13:	FSET? OBJ,INVISIBLE \?L18
	PRINTI "2 "
?L18:	FSET? OBJ,LIGHTBIT \?L23
	PRINTI "3 "
?L23:	FSET? OBJ,NDESCBIT \?L28
	PRINTI "4 "
?L28:	FSET? OBJ,ONBIT \?L33
	PRINTI "5 "
?L33:	FSET? OBJ,OPENBIT \?L38
	PRINTI "6 "
?L38:	FSET? OBJ,RMUNGBIT \?L43
	PRINTI "7 "
?L43:	FSET? OBJ,TOUCHBIT \?L48
	PRINTI "8 "
?L48:	CRLF
	RTRUE

	.FUNCT PRINT-OBJTREE0
	CRLF
	PRINTI "<start-otr>"
	CRLF
	CALL PRINT-OBJTREE-NODE,GLOBAL-OBJECTS
	CALL PRINT-OBJTREE-NODE,LOCAL-GLOBALS
	CALL PRINT-OBJTREE-NODE,ROOMS
	CALL PRINT-OBJTREE-NODE,INTNUM
	CALL PRINT-OBJTREE-NODE,PSEUDO-OBJECT
	CALL PRINT-OBJTREE-NODE,IT
	CALL PRINT-OBJTREE-NODE,NOT-HERE-OBJECT
	CALL PRINT-OBJTREE-NODE,BLESSINGS
	CALL PRINT-OBJTREE-NODE,STAIRS
	CALL PRINT-OBJTREE-NODE,SAILOR
	CALL PRINT-OBJTREE-NODE,GROUND
	CALL PRINT-OBJTREE-NODE,GRUE
	CALL PRINT-OBJTREE-NODE,LUNGS
	CALL PRINT-OBJTREE-NODE,ME
	CALL PRINT-OBJTREE-NODE,ADVENTURER
	CALL PRINT-OBJTREE-NODE,PATHOBJ
	CALL PRINT-OBJTREE-NODE,ZORKMID
	CALL PRINT-OBJTREE-NODE,HANDS
	CALL PRINT-OBJTREE-NODE,VOICES
	CALL PRINT-OBJTREE-NODE,CRYSTALS
	CALL PRINT-OBJTREE-NODE,ROYAL-SEAL
	CALL PRINT-OBJTREE-NODE,CLEFT
	CALL PRINT-OBJTREE-NODE,TIME-MACHINE
	CALL PRINT-OBJTREE-NODE,PRESSURIZER
	CALL PRINT-OBJTREE-NODE,SPINNER
	CALL PRINT-OBJTREE-NODE,TM-BUTTON
	CALL PRINT-OBJTREE-NODE,TM-HOLLOW
	CALL PRINT-OBJTREE-NODE,TM-SEAT
	CALL PRINT-OBJTREE-NODE,TM-DIAL
	CALL PRINT-OBJTREE-NODE,IRON-DOOR
	CALL PRINT-OBJTREE-NODE,JEWEL-DOOR
	CALL PRINT-OBJTREE-NODE,WOODEN-DOOR
	CALL PRINT-OBJTREE-NODE,SCEPTRE
	CALL PRINT-OBJTREE-NODE,JEWELLED-KNIFE
	CALL PRINT-OBJTREE-NODE,RING
	CALL PRINT-OBJTREE-NODE,PEDESTAL
	CALL PRINT-OBJTREE-NODE,CAGE
	CALL PRINT-OBJTREE-NODE,TECH-PLAQUE
	CALL PRINT-OBJTREE-NODE,PLAQUE
	CALL PRINT-OBJTREE-NODE,ROBOT
	CALL PRINT-OBJTREE-NODE,SHADOW
	CALL PRINT-OBJTREE-NODE,HOOD
	CALL PRINT-OBJTREE-NODE,CLOAK
	CALL PRINT-OBJTREE-NODE,REEDS
	CALL PRINT-OBJTREE-NODE,VIEWING-TABLE
	CALL PRINT-OBJTREE-NODE,TORCH
	CALL PRINT-OBJTREE-NODE,FRIED-TORCH
	CALL PRINT-OBJTREE-NODE,CLIFF-OBJECT
	CALL PRINT-OBJTREE-NODE,STONE-WALL
	CALL PRINT-OBJTREE-NODE,LAKE
	CALL PRINT-OBJTREE-NODE,AMULET
	CALL PRINT-OBJTREE-NODE,SAND
	CALL PRINT-OBJTREE-NODE,FRIED-LAMP
	CALL PRINT-OBJTREE-NODE,ALGAE
	CALL PRINT-OBJTREE-NODE,SHINY-OBJECT
	CALL PRINT-OBJTREE-NODE,LEDGE
	CALL PRINT-OBJTREE-NODE,WAYBREAD
	CALL PRINT-OBJTREE-NODE,ROPE
	CALL PRINT-OBJTREE-NODE,GLOBAL-ROPE
	CALL PRINT-OBJTREE-NODE,TREE
	CALL PRINT-OBJTREE-NODE,STAFF
	CALL PRINT-OBJTREE-NODE,BROKEN-STAFF
	CALL PRINT-OBJTREE-NODE,CHEST
	CALL PRINT-OBJTREE-NODE,GLOBAL-MAN
	CALL PRINT-OBJTREE-NODE,VALUABLES
	CALL PRINT-OBJTREE-NODE,MAN
	CALL PRINT-OBJTREE-NODE,TIMBERS
	CALL PRINT-OBJTREE-NODE,LADDER
	CALL PRINT-OBJTREE-NODE,REPELLENT
	CALL PRINT-OBJTREE-NODE,AQUEDUCT
	CALL PRINT-OBJTREE-NODE,WATER-CHANNEL
	CALL PRINT-OBJTREE-NODE,MOSS
	CALL PRINT-OBJTREE-NODE,COVER
	CALL PRINT-OBJTREE-NODE,KEY
	CALL PRINT-OBJTREE-NODE,VIEW-INDICATOR
	CALL PRINT-OBJTREE-NODE,VIKING-SHIP
	CALL PRINT-OBJTREE-NODE,VIAL
	CALL PRINT-OBJTREE-NODE,POTION
	CALL PRINT-OBJTREE-NODE,OCEAN
	CALL PRINT-OBJTREE-NODE,STONE
	CALL PRINT-OBJTREE-NODE,FISH
	CALL PRINT-OBJTREE-NODE,RUBBLE
	CALL PRINT-OBJTREE-NODE,DEBRIS
	CALL PRINT-OBJTREE-NODE,CHASM
	CALL PRINT-OBJTREE-NODE,TUNNEL
	CALL PRINT-OBJTREE-NODE,EAST-WALL
	CALL PRINT-OBJTREE-NODE,SOUTH-WALL
	CALL PRINT-OBJTREE-NODE,WEST-WALL
	CALL PRINT-OBJTREE-NODE,NORTH-WALL
	CALL PRINT-OBJTREE-NODE,GLOBAL-WATER
	CALL PRINT-OBJTREE-NODE,WATER
	CALL PRINT-OBJTREE-NODE,BROKEN-LAMP
	CALL PRINT-OBJTREE-NODE,LAMP
	CALL PRINT-OBJTREE-NODE,SWORD
	CALL PRINT-OBJTREE-NODE,WARNING-NOTE
	CALL PRINT-OBJTREE-NODE,CP-SLOT
	CALL PRINT-OBJTREE-NODE,CPDOOR
	CALL PRINT-OBJTREE-NODE,LORE-BOOK
	CALL PRINT-OBJTREE-NODE,CPEWL
	CALL PRINT-OBJTREE-NODE,CPWWL
	CALL PRINT-OBJTREE-NODE,CPSWL
	CALL PRINT-OBJTREE-NODE,CPNWL
	CALL PRINT-OBJTREE-NODE,CPLADDER
	CALL PRINT-OBJTREE-NODE,INTDIR
	CALL PRINT-OBJTREE-NODE,GUARDIAN
	CALL PRINT-OBJTREE-NODE,ROSE
	CALL PRINT-OBJTREE-NODE,MASTER
	CALL PRINT-OBJTREE-NODE,DUNGEON-MASTER
	CALL PRINT-OBJTREE-NODE,MIRROR
	CALL PRINT-OBJTREE-NODE,PANEL
	CALL PRINT-OBJTREE-NODE,CHANNEL
	CALL PRINT-OBJTREE-NODE,WOODEN-WALL
	CALL PRINT-OBJTREE-NODE,RUNES
	CALL PRINT-OBJTREE-NODE,T-BAR
	CALL PRINT-OBJTREE-NODE,BLACK-PANEL
	CALL PRINT-OBJTREE-NODE,BRONZE-DOOR
	CALL PRINT-OBJTREE-NODE,CELL-DOOR
	CALL PRINT-OBJTREE-NODE,COMPASS-ARROW
	CALL PRINT-OBJTREE-NODE,DIAL-BUTTON
	CALL PRINT-OBJTREE-NODE,GOOD-LOCKED-DOOR
	CALL PRINT-OBJTREE-NODE,LOCKED-DOOR
	CALL PRINT-OBJTREE-NODE,LONG-POLE
	CALL PRINT-OBJTREE-NODE,MAHOGANY-PANEL
	CALL PRINT-OBJTREE-NODE,FLAMING-PIT
	CALL PRINT-OBJTREE-NODE,PARAPET-OBJ
	CALL PRINT-OBJTREE-NODE,PINE-PANEL
	CALL PRINT-OBJTREE-NODE,BEAM
	CALL PRINT-OBJTREE-NODE,RED-BUTTON
	CALL PRINT-OBJTREE-NODE,RED-PANEL
	CALL PRINT-OBJTREE-NODE,SHORT-POLE
	CALL PRINT-OBJTREE-NODE,SUNDIAL
	CALL PRINT-OBJTREE-NODE,YELLOW-PANEL
	CALL PRINT-OBJTREE-NODE,WHITE-PANEL
	CALL PRINT-OBJTREE-NODE,WOODEN-BAR
	CALL PRINT-OBJTREE-NODE,DUNGEON-PANEL
	CALL PRINT-OBJTREE-NODE,DUNGEON-DOOR
	CALL PRINT-OBJTREE-NODE,SECRET-DOOR
	CALL PRINT-OBJTREE-NODE,OLD-MAN
	CALL PRINT-OBJTREE-NODE,CP-HOLE
	PRINTI "<gbl>"
	CRLF
	PRINTN ACTIVE-VIEW
	CRLF
	PRINTN AQ-FLAG
	CRLF
	PRINTN ATTACK-MODE
	CRLF
	PRINTN BASE-SCORE
	CRLF
	PRINTN BEAM-BREAKER
	CRLF
	PRINTN BLOCKED-DIR
	CRLF
	PRINTN BOAT-SEEN
	CRLF
	PRINTN BRONZE-DOOR-LOCKED
	CRLF
	PRINTN CHEST-LIFTED
	CRLF
	PRINTN CHEST-OPENED
	CRLF
	PRINTN CHEST-TIED
	CRLF
	PRINTN CLEFT-FLAG
	CRLF
	PRINTN CLUMSY-ROBBERY
	CRLF
	PRINTN COVER-MOVED
	CRLF
	PRINTN CP-FLAG
	CRLF
	PRINTN CP-MOVED
	CRLF
	PRINTN CPBLOCK-FLAG
	CRLF
	PRINTN CPHERE
	CRLF
	PRINTN CPPUSH-FLAG
	CRLF
	PRINTN CPSOLVE-FLAG
	CRLF
	PRINTN CURRENT-LAMP
	CRLF
	PRINTN DEATHS
	CRLF
	PRINTN DESC-OBJECT
	CRLF
	PRINTN DM-SEEN
	CRLF
	PRINTN EMPTY-HANDED
	CRLF
	PRINTN FLATHEAD-HEARD
	CRLF
	PRINTN FOLFLAG
	CRLF
	PRINTN GUARDIANS-SEEN
	CRLF
	PRINTN GUARDS-PRESENT
	CRLF
	PRINTN HOLDING-ROPE
	CRLF
	PRINTN HS
	CRLF
	PRINTN IN-DUNGEON
	CRLF
	PRINTN INVIS
	CRLF
	PRINTN LAKE-POINT
	CRLF
	PRINTN LAKE-TIME
	CRLF
	PRINTN LAST-MOVES
	CRLF
	PRINTN LCELL
	CRLF
	PRINTN LIFT-WAIT
	CRLF
	PRINTN LIT
	CRLF
	PRINTN MACHINE-DAMAGED
	CRLF
	PRINTN MAN-FLAG
	CRLF
	PRINTN MAN-GONE
	CRLF
	PRINTN MAN-POINT
	CRLF
	PRINTN MAN-SEEN
	CRLF
	PRINTN MAN-WAITING
	CRLF
	PRINTN MDIR
	CRLF
	PRINTN MIRROR-OPEN-FLAG
	CRLF
	PRINTN MIRROR-OPENED
	CRLF
	PRINTN MLOC
	CRLF
	PRINTN MOVES
	CRLF
	PRINTN MR1-FLAG
	CRLF
	PRINTN MR2-FLAG
	CRLF
	PRINTN MRSWPUSH-FLAG
	CRLF
	PRINTN MYSTERY
	CRLF
	PRINTN OLD-MAN-AWAKE
	CRLF
	PRINTN OLD-MAN-GONE
	CRLF
	PRINTN P-STRENGTH
	CRLF
	PRINTN PNUMB
	CRLF
	PRINTN POLEUP-FLAG
	CRLF
	PRINTN RING-CONCEALED
	CRLF
	PRINTN RING-STOLEN
	CRLF
	PRINTN ROPE-FLAG
	CRLF
	PRINTN S-STRENGTH
	CRLF
	PRINTN SCORE
	CRLF
	PRINTN SHADOW-GONE
	CRLF
	PRINTN SHADOW-POINT-1
	CRLF
	PRINTN SHADOW-POINT-2
	CRLF
	PRINTN SHIP-GONE
	CRLF
	PRINTN SNAP-LOC
	CRLF
	PRINTN SPRAY-USED?
	CRLF
	PRINTN SPRAYED?
	CRLF
	PRINTN SUPER-BRIEF
	CRLF
	PRINTN SWORD-IN-STONE?
	CRLF
	PRINTN SWORD-STATE
	CRLF
	PRINTN TM-POINT
	CRLF
	PRINTN TM-YEAR
	CRLF
	PRINTN VERBOSE
	CRLF
	PRINTN VIEW-POINT
	CRLF
	PRINTN WON-FLAG
	CRLF
	PRINTN WOOD-OPEN-FLAG
	CRLF
	PRINTN YEAR
	CRLF
	LOC HERE >STACK
	ZERO? STACK /?L167
	GETP HERE,P?OBJIDX >STACK
	PRINT STACK
	CRLF
	JUMP ?L171
?L167:	PRINTI "-1"
	CRLF
?L171:	PRINTI "<end-otr>"
	RTRUE

	.FUNCT V-OBJTREE0
	CALL PRINT-OBJTREE0 >STACK
	RSTACK

	.FUNCT V-SET-OBJECT-TREE-FLAG
	SET 'PRINT-OBJTREE-FLAG,1
	RETURN PRINT-OBJTREE-FLAG

	.FUNCT V-UNSET-OBJECT-TREE-FLAG
	SET 'PRINT-OBJTREE-FLAG,0
	RETURN PRINT-OBJTREE-FLAG

	.FUNCT OBJTREE-FINAL-PRINT
	ZERO? PRINT-OBJTREE-FLAG /FALSE
	CALL PRINT-OBJTREE0 >STACK
	RSTACK

	.FUNCT PRINT-DESC1,OBJ
	ZERO? OBJ /FALSE
	PRINTD OBJ
	RTRUE

	.FUNCT PRINT-ID,ID,CONDITION=1
	ZERO? CONDITION /FALSE
	PRINTI "[ID: "
	PRINT ID
	PRINTI ", PRSO: "
	CALL PRINT-DESC1,PRSO
	PRINTI ", PRSI: "
	CALL PRINT-DESC1,PRSI
	PRINTI "]"
	RTRUE

	.FUNCT PRINT-DEBUG,TEXT,CONDITION=1
	ZERO? CONDITION /FALSE
	PRINTI "DEBUG FLAG: "
	PRINT TEXT
	RTRUE

	.FUNCT IS-THEFT?
	EQUAL? PRSO,CHEST,CLOAK,COVER /TRUE
	EQUAL? PRSO,CPLADDER,DIAL-BUTTON,HOOD /TRUE
	EQUAL? PRSO,JEWELLED-KNIFE,KEY,LADDER /TRUE
	EQUAL? PRSO,MIRROR,PEDESTAL,PLAQUE /TRUE
	EQUAL? PRSO,PRESSURIZER,RED-BUTTON,RING /TRUE
	EQUAL? PRSO,ROYAL-SEAL,RUNES,SCEPTRE /TRUE
	EQUAL? PRSO,SPINNER,STAFF,SUNDIAL /TRUE
	EQUAL? PRSO,TECH-PLAQUE,TIME-MACHINE,TM-BUTTON /TRUE
	EQUAL? PRSO,TM-DIAL,TORCH,VALUABLES /TRUE
	EQUAL? PRSO,VIEW-INDICATOR,VIEWING-TABLE,WARNING-NOTE /TRUE
	EQUAL? PRSO,WAYBREAD \FALSE
	RTRUE

	.FUNCT IS-OBJECT-OR-PROPERTY?
	EQUAL? PRSO,ALGAE,AQUEDUCT,AMULET /TRUE
	EQUAL? PRSO,BEAM,BLACK-PANEL,BROKEN-LAMP /TRUE
	EQUAL? PRSO,BROKEN-STAFF,BRONZE-DOOR,CAGE /TRUE
	EQUAL? PRSO,CELL-DOOR,CHEST,CLIFF-OBJECT /TRUE
	EQUAL? PRSO,CLOAK,COMPASS-ARROW,COVER /TRUE
	EQUAL? PRSO,CPDOOR,CPEWL,CPLADDER /TRUE
	EQUAL? PRSO,CPNWL,CPSWL,CPWWL /TRUE
	EQUAL? PRSO,CRYSTALS,DEBRIS,DIAL-BUTTON /TRUE
	EQUAL? PRSO,DUNGEON-DOOR,DUNGEON-PANEL,EAST-WALL /TRUE
	EQUAL? PRSO,FLAMING-PIT,FRIED-LAMP,FRIED-TORCH /TRUE
	EQUAL? PRSO,GLOBAL-ROPE,GOOD-LOCKED-DOOR,HOOD /TRUE
	EQUAL? PRSO,IRON-DOOR,JEWEL-DOOR,JEWELLED-KNIFE /TRUE
	EQUAL? PRSO,KEY,LADDER,LAKE /TRUE
	EQUAL? PRSO,LAMP,LEDGE,LOCKED-DOOR /TRUE
	EQUAL? PRSO,LONG-POLE,LORE-BOOK,MAHOGANY-PANEL /TRUE
	EQUAL? PRSO,MIRROR,MOSS,NORTH-WALL /TRUE
	EQUAL? PRSO,PANEL,PARAPET-OBJ,PEDESTAL /TRUE
	EQUAL? PRSO,PINE-PANEL,PLAQUE,POTION /TRUE
	EQUAL? PRSO,PRESSURIZER,RED-BUTTON,RED-PANEL /TRUE
	EQUAL? PRSO,REEDS,REPELLENT,RING /TRUE
	EQUAL? PRSO,ROPE,ROSE,ROYAL-SEAL /TRUE
	EQUAL? PRSO,RUBBLE,RUNES,SCEPTRE /TRUE
	EQUAL? PRSO,SECRET-DOOR,SHADOW,SHINY-OBJECT /TRUE
	EQUAL? PRSO,SHORT-POLE,SOUTH-WALL,SPINNER /TRUE
	EQUAL? PRSO,STAFF,STONE,STONE-WALL /TRUE
	EQUAL? PRSO,SUNDIAL,SWORD,T-BAR /TRUE
	EQUAL? PRSO,TECH-PLAQUE,TIMBERS,TIME-MACHINE /TRUE
	EQUAL? PRSO,TM-BUTTON,TM-DIAL,TM-SEAT /TRUE
	EQUAL? PRSO,TORCH,TREE,TUNNEL /TRUE
	EQUAL? PRSO,VALUABLES,VIAL,VIEW-INDICATOR /TRUE
	EQUAL? PRSO,VIEWING-TABLE,VIKING-SHIP,WARNING-NOTE /TRUE
	EQUAL? PRSO,WAYBREAD,WEST-WALL,WHITE-PANEL /TRUE
	EQUAL? PRSO,WOODEN-BAR,WOODEN-DOOR,WOODEN-WALL /TRUE
	EQUAL? PRSO,YELLOW-PANEL \FALSE
	RTRUE

	.FUNCT IS-PERSON?
	EQUAL? PRSO,GLOBAL-MAN,GUARDIAN,MAN /TRUE
	EQUAL? PRSO,OLD-MAN,SAILOR,DUNGEON-MASTER /TRUE
	EQUAL? PRSO,MASTER \FALSE
	RTRUE

	.FUNCT IS-BAD-TO-PICK?
	RFALSE

	.FUNCT BOMB?,TMP
	RFALSE

	.FUNCT DANGEROUS-DRINK?
	EQUAL? PRSO,SAND \FALSE
	RTRUE

	.FUNCT DANGEROUS-FOOD?
	CALL IS-PART-OF-SELF? >STACK
	ZERO? STACK \?L1
	CALL IS-OBJECT-OR-PROPERTY?
?L1:	EQUAL? PRSO,WAYBREAD \TRUE
	RFALSE

	.FUNCT IS-ANIMAL?
	EQUAL? PRSO,FISH,GRUE,ROBOT \FALSE
	RTRUE

	.FUNCT IS-OBJ-PROP-ANIMAL?,?TMP
	CALL IS-OBJECT-OR-PROPERTY? >?TMP
	ZERO? ?TMP /?L2
	RETURN ?TMP
?L2:	CALL IS-ANIMAL? >STACK
	RSTACK

	.FUNCT IS-SELF?
	EQUAL? PRSO,ME,ADVENTURER \FALSE
	RTRUE

	.FUNCT IS-PART-OF-SELF?
	EQUAL? PRSO,HANDS,LUNGS \FALSE
	RTRUE

	.FUNCT IS-PART-OF-SELF-OR-SELF?,?TMP
	CALL IS-SELF? >?TMP
	ZERO? ?TMP /?L2
	RETURN ?TMP
?L2:	CALL IS-PART-OF-SELF? >STACK
	RSTACK

	.FUNCT GO
START::
?L0:	CALL QUEUE,I-LANTERN,200
	SET 'CURRENT-LAMP,LAMP
	PUT CPOBJS,168,1
	PUT CPOBJS,169,LORE-BOOK
	PUT CPOBJS,256,1
	PUT CPOBJS,257,CP-SLOT
	SET 'LIT,1
	SET 'WINNER,ADVENTURER
	SET 'PLAYER,WINNER
	SET 'MLOC,MRB
	SET 'HERE,ZORK2-STAIR
	MOVE WINNER,HERE
	CALL QUEUE,I-VIEW-CHANGE,4 >STACK
	PUT STACK,0,1
	SET 'P-IT-OBJECT,0
	FSET? HERE,TOUCHBIT /?L1
	PRINTI "As in a dream, you see yourself tumbling down a great, dark staircase. All about you are shadowy images of struggles against fierce opponents and diabolical traps. These give way to another round of images: of imposing stone figures, a cool, clear lake, and, now, of an old, yet oddly youthful man. He turns toward you slowly, his long, silver hair dancing about him in a fresh breeze. ""You have reached the final test, my friend! You are proved clever and powerful, but this is not yet enough! Seek me when you feel yourself worthy!"" The dream dissolves around you as his last words echo through the void...."
	CRLF
	CRLF
	CALL V-VERSION
	CRLF
?L1:	MOVE WINNER,HERE
	MOVE LAMP,HERE
	CALL V-LOOK
	CALL MAIN-LOOP
	JUMP ?L0

	.FUNCT I-SWORD,DEM,NG=0,P,T,L
	CALL INT,I-SWORD >DEM
	IN? SWORD,ADVENTURER \?L1
	EQUAL? HERE,CLIFF \?L3
	ZERO? MAN-GONE \?L3
	SET 'NG,1
	JUMP ?L12
?L3:	EQUAL? HERE,CLIFF-LEDGE \?L5
	ZERO? MAN-FLAG /?L5
	SET 'NG,1
	JUMP ?L12
?L5:	CALL INFESTED?,HERE >STACK
	ZERO? STACK /?L6
	SET 'NG,2
	JUMP ?L12
?L6:	EQUAL? MLOC,MRG \?L9
	EQUAL? HERE,IN-MIRROR /?L8
?L9:	EQUAL? HERE,MRGE,MRG,MRGW \?L7
?L8:	SET 'NG,1
	JUMP ?L12
?L7:	SET 'P,0
?L11:	NEXTP HERE,P >P
	ZERO? P /?L12
	LESS? P,P?CROSS /?L11
	GETPT HERE,P >T
	PTSIZE T >L
	EQUAL? L,UEXIT,CEXIT,DEXIT \?L11
	GETB T,0 >STACK
	CALL INFESTED?,STACK >STACK
	ZERO? STACK /?L11
	SET 'NG,1
?L12:	EQUAL? NG,SWORD-STATE /FALSE
	EQUAL? NG,2 \?L25
	PRINTI "Your sword has begun to glow very brightly."
	CRLF
	JUMP ?L31
?L25:	EQUAL? NG,1 \?L28
	PRINTI "Your sword is glowing with a faint blue glow."
	CRLF
	JUMP ?L31
?L28:	ZERO? NG \?L31
	PRINTI "Your sword is no longer glowing."
	CRLF
?L31:	SET 'SWORD-STATE,NG
	RTRUE
?L1:	PUT DEM,0,0
	RFALSE

	.FUNCT INFESTED?,R,F
	FIRST? R >F \FALSE
?L4:	FSET? F,ACTORBIT \?L6
	FSET? F,INVISIBLE /?L6
	RETURN F
?L6:	NEXT? F >F /?L4
	RFALSE

	.FUNCT FIND-WEAPON,O,W
	FIRST? O >W \FALSE
?L2:	EQUAL? W,SWORD \?L7
	RETURN W
?L7:	NEXT? W >W /?L2
	RFALSE

	.FUNCT SWORD-FCN
	ZERO? SWORD-IN-STONE? /?L1
	EQUAL? PRSA,V?MOVE,V?TAKE \FALSE
	RANDOM 100 >STACK
	GRTR? 10,STACK \?L5
	PRINTR "Who do you think you are? Arthur?"
?L5:	PRINTR "The sword is deeply imbedded in the rock. You can't budge it."
?L1:	EQUAL? PRSA,V?TAKE \FALSE
	EQUAL? WINNER,ADVENTURER \FALSE
	CALL QUEUE,I-SWORD,-1 >STACK
	PUT STACK,0,1
	RFALSE

	.FUNCT LANTERN
	EQUAL? PRSA,V?THROW \?L1
	PRINTI "The lamp smashes. The light is now out."
	CRLF
	CALL PRINT-ID,STR?78
	CALL INT,I-LANTERN >STACK
	PUT STACK,0,0
	REMOVE LAMP
	SET 'CURRENT-LAMP,BROKEN-LAMP
	MOVE BROKEN-LAMP,HERE
	RTRUE
?L1:	EQUAL? PRSA,V?LAMP-ON \?L5
	FSET? LAMP,LIGHTBIT /?L6
	PRINTR "A burned-out lamp won't light."
?L6:	CALL INT,I-LANTERN >STACK
	PUT STACK,0,1
	RFALSE
?L5:	EQUAL? PRSA,V?LAMP-OFF \?L11
	FSET? LAMP,LIGHTBIT /?L12
	PRINTR "The lamp has already burned out."
?L12:	CALL INT,I-LANTERN >STACK
	PUT STACK,0,0
	RFALSE
?L11:	EQUAL? PRSA,V?EXAMINE \FALSE
	FSET? LAMP,LIGHTBIT /?L18
	PRINTR "The lamp has burned out."
?L18:	FSET? LAMP,ONBIT \?L22
	PRINTR "The lamp is on."
?L22:	PRINTR "The lamp is turned off."

	.FUNCT LIGHT-INT,OBJ,TBL,TICK
	ZERO? TICK \?L1
	FCLEAR OBJ,ONBIT
	FSET OBJ,RMUNGBIT
?L1:	CALL HELD?,OBJ >STACK
	ZERO? STACK \?L6
	IN? OBJ,HERE \FALSE
?L6:	ZERO? TICK \?L7
	PRINTI "You'd better have more light than from the "
	PRINTD OBJ
	PRINTR "."
?L7:	GET TBL,1 >STACK
	PRINT STACK
	CRLF
	RTRUE

	.FUNCT I-LANTERN,TICK,TBL
	SET 'TBL,LAMP-TABLE
	GET TBL,0 >TICK
	CALL QUEUE,I-LANTERN,TICK >STACK
	PUT STACK,0,1
	CALL LIGHT-INT,LAMP,TBL,TICK
	ZERO? TICK /FALSE
	ADD TBL,4 >LAMP-TABLE
	RETURN LAMP-TABLE

	.FUNCT CHASM-FCN
	EQUAL? PRSA,V?LEAP /?L3
	EQUAL? PRSA,V?PUT \?L1
	EQUAL? PRSO,ME \?L1
?L3:	PRINTI "You look before leaping and realize you would never survive."
	CRLF
	CALL PRINT-ID,STR?79 >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?CROSS \?L6
	PRINTR "You'll have to find a bridge."
?L6:	EQUAL? PRSA,V?PUT \FALSE
	EQUAL? PRSI,PSEUDO-OBJECT \FALSE
	PRINTI "The "
	PRINTD PRSO
	PRINTI " drops out of sight into the chasm."
	CRLF
	CALL PRINT-ID,STR?80
	REMOVE PRSO
	RTRUE

	.FUNCT TUNNEL-OBJECT
	EQUAL? PRSA,V?THROUGH \?L1
	GETP HERE,P?IN >STACK
	ZERO? STACK /?L1
	CALL DO-WALK,P?IN
	RTRUE
?L1:	CALL PATH-OBJECT >STACK
	RSTACK

	.FUNCT CPEXIT,FX,NFX
	SET 'CP-MOVED,0
	EQUAL? PRSO,P?UP \?L1
	EQUAL? CPHERE,1 \?L3
	GET CPTABLE,2 >STACK
	EQUAL? STACK,-2 \?L5
	PRINTI "With the help of the ladder, you exit the puzzle."
	CRLF
	RETURN CP-ANTE
?L5:	PRINTI "The exit is too far above your head."
	CRLF
	RFALSE
?L3:	PRINTI "There is no way up."
	CRLF
	RFALSE
?L1:	EQUAL? CPHERE,33 \?L15
	EQUAL? PRSO,P?WEST \?L15
	ZERO? CP-FLAG /?L15
	FCLEAR CP,TOUCHBIT
	RETURN CP-OUT
?L15:	EQUAL? PRSO,P?DOWN \?L16
	PRINTI "There's no way down here."
	CRLF
	RFALSE
?L16:	EQUAL? CPHERE,33 \?L19
	EQUAL? PRSO,P?WEST \?L19
	PRINTI "The metal door bars the way."
	CRLF
	RFALSE
?L19:	CALL LKP,PRSO,CPEXITS >FX
	ADD FX,CPHERE >NFX
	GRTR? NFX,36 /?L25
	LESS? NFX,0 /?L25
	CALL ILLCP,CPHERE,FX >STACK
	ZERO? STACK /?L23
?L25:	PRINTI "There is a wall there."
	CRLF
	RFALSE
?L23:	LESS? FX,0 \?L29
	SUB 0,FX >STACK
	JUMP ?L31
?L29:	PUSH FX
?L31:	EQUAL? STACK,1,6 \?L28
	CALL CPMOVE,FX
	RFALSE
?L28:	GRTR? FX,0 \?L32
	SUB FX,6 >STACK
	ADD CPHERE,STACK >STACK
	GET CPTABLE,STACK >STACK
	ADD CPHERE,6 >STACK
	GET CPTABLE,STACK >STACK
	EQUAL? 0,STACK,STACK \?L32
	CALL CPMOVE,FX
	RFALSE
?L32:	LESS? FX,0 \?L33
	ADD CPHERE,6 >STACK
	ADD STACK,FX >STACK
	GET CPTABLE,STACK >STACK
	SUB CPHERE,6 >STACK
	GET CPTABLE,STACK >STACK
	EQUAL? 0,STACK,STACK \?L33
	CALL CPMOVE,FX
	RFALSE
?L33:	PRINTI "There is a wall there."
	CRLF
	RFALSE

	.FUNCT ILLCP,ONE,TWO
	MOD ONE,6 >STACK
	ZERO? STACK \?L1
	EQUAL? TWO,MINUS-FIVE,1,7 /TRUE
?L1:	MOD ONE,6 >STACK
	EQUAL? STACK,1 \?L3
	EQUAL? TWO,MINUS-SEVEN,MINUS-ONE,5 /TRUE
?L3:	LESS? ONE,7 \?L4
	LESS? TWO,MINUS-FOUR /TRUE
?L4:	GRTR? ONE,30 \FALSE
	GRTR? TWO,4 /TRUE
	RFALSE

	.FUNCT CPMOVE,FX
	ADD CPHERE,FX >FX
	GET CPTABLE,FX >STACK
	ZERO? STACK \?L1
	CALL CPGOTO,FX >STACK
	RSTACK
?L1:	PRINTR "There is a wall there."

	.FUNCT CPENTER
	EQUAL? YEAR,YEAR-PRESENT \?L3
	ZERO? CPBLOCK-FLAG /?L1
?L3:	PRINTI "The hole is blocked by sandstone."
	CRLF
	RFALSE
?L1:	SET 'CPHERE,1
	RETURN CP

	.FUNCT CPANT-ROOM,RARG
	EQUAL? RARG,M-LOOK \FALSE
	PRINTI "This is a small square room, in the middle of which is a round hole"
	ZERO? CPBLOCK-FLAG \?L7
	EQUAL? YEAR,YEAR-PRESENT /?L5
?L7:	PRINTR " which is blocked by smooth sandstone."
?L5:	PRINTR " through which you can discern the floor some ten feet below. The area under the hole is dark, but it appears to be completely enclosed in rock. In any event, it doesn't seem likely that you could climb back up. Exits are west and, up a few steps, north."

	.FUNCT CPLADDER-OBJECT
	SUB CPHERE,1 >STACK
	GET CPTABLE,STACK >STACK
	EQUAL? STACK,-3 \?L1
	CALL CPLADDER-JUNK,0 >STACK
	RSTACK
?L1:	ADD CPHERE,1 >STACK
	GET CPTABLE,STACK >STACK
	EQUAL? STACK,-2 \?L3
	CALL CPLADDER-JUNK,1 >STACK
	RSTACK
?L3:	PRINTR "You can't see any ladder here."

	.FUNCT CPLADDER-JUNK,FLG
	EQUAL? PRSA,V?CLIMB-FOO,V?CLIMB-UP \?L1
	ZERO? FLG /?L3
	EQUAL? CPHERE,1 \?L3
	SET 'CPSOLVE-FLAG,1
	CALL GOTO,CP-ANTE >STACK
	RSTACK
?L3:	PRINTI "You hit your head on the ceiling and fall off the ladder."
	CRLF
	CALL PRINT-ID,STR?81 >STACK
	RSTACK
?L1:	PRINTR "Come, come!"

	.FUNCT CPWALL-OBJECT,WL,NWL,NXT,NNXT,CNT,TOP,SNAP=0
	EQUAL? PRSA,V?MOVE \?L1
	PRINTR "You can't grab the wall to pull it."
?L1:	EQUAL? PRSA,V?PUSH \FALSE
	CALL CPNEXT,CPHERE,PRSO >NXT
	ZERO? NXT \?L6
	PRINTR "The wall doesn't budge."
?L6:	GET CPTABLE,NXT >WL
	ZERO? WL \?L11
	PRINTR "There is only a passage in that direction."
?L11:	EQUAL? WL,1 \?L15
	PRINTR "The wall doesn't budge."
?L15:	CALL CPNEXT,NXT,PRSO >NNXT
	ZERO? NNXT \?L18
	PRINTR "The wall barely gives."
?L18:	GET CPTABLE,NNXT >NWL
	ZERO? NWL /?L21
	PRINTR "The wall barely gives."
?L21:	PRINTI "The wall slides forward and you follow it"
	ZERO? CPPUSH-FLAG /?L27
	PRINTI " to this position:"
	CRLF
	JUMP ?L31
?L27:	INC 'SCORE
	PRINTI "....
The architecture of this region is getting complex, so that further descriptions will be diagrams of the immediate vicinity in a 3x3 grid. The walls here are rock, but of two different types - sandstone and marble. The following notations will be used:
"
	CALL FIXED-FONT-ON
	PRINTI "
  .. = your position (middle of grid)
  MM = marble wall
  SS = sandstone wall
  ?? = unknown (blocked by walls)

"
	CALL FIXED-FONT-OFF
?L31:	SET 'CPPUSH-FLAG,1
	PUT CPTABLE,NXT,0
	PUT CPTABLE,NNXT,WL
	ZERO? NNXT /?L39
	SUB NNXT,1 >STACK
	MUL 8,STACK >TOP
	GET CPOBJS,TOP >CNT
?L38:	ZERO? CNT /?L39
	INC 'TOP
	GET CPOBJS,TOP >STACK
	MOVE STACK,CP-OUT
	ZERO? SNAP \?L43
	SET 'SNAP,1
	PRINTI "You hear a soft ""snap"" from behind the wall you were pushing."
	CRLF
?L43:	DEC 'CNT
	JUMP ?L38
?L39:	EQUAL? NNXT,1 \?L49
	SET 'CPBLOCK-FLAG,1
?L49:	CALL CPGOTO,NXT >STACK
	RSTACK

	.FUNCT FIXED-FONT-ON
	GET 0,8 >STACK
	BOR STACK,2 >STACK
	PUT 0,8,STACK
	RTRUE

	.FUNCT FIXED-FONT-OFF
	GET 0,8 >STACK
	BAND STACK,-3 >STACK
	PUT 0,8,STACK
	RTRUE

	.FUNCT CPGOTO,FX,F,X,CNT,TOP
	SET 'CP-MOVED,1
	FCLEAR HERE,TOUCHBIT
	SUB CPHERE,1 >STACK
	MUL 8,STACK >TOP
	ADD TOP,1 >CNT
	FIRST? CP >F /?L1
?L1:	NEXT? F >X /?L4
?L4:	ZERO? F /?L3
	EQUAL? F,ADVENTURER /?L8
	PUT CPOBJS,CNT,F
	REMOVE F
	INC 'CNT
?L8:	ZERO? X /?L3
	SET 'F,X
	JUMP ?L1
?L3:	SUB CNT,TOP >STACK
	DEC 'STACK
	PUT CPOBJS,TOP,STACK
	SET 'CPHERE,FX
	SUB CPHERE,1 >STACK
	MUL 8,STACK >TOP
	GET CPOBJS,TOP >CNT
?L12:	ZERO? CNT /?L13
	INC 'TOP
	GET CPOBJS,TOP >STACK
	MOVE STACK,CP
	DEC 'CNT
	JUMP ?L12
?L13:	CALL PERFORM,V?LOOK
	RTRUE

	.FUNCT CPNEXT,RM,OBJ,FX
	CALL LKP,OBJ,CPWALLS >FX
	CALL ILLCP,RM,FX >STACK
	ZERO? STACK \FALSE
	ADD RM,FX >STACK
	RSTACK

	.FUNCT CPDOOR-F
	EQUAL? HERE,CP \?L1
	EQUAL? CPHERE,33 /?L1
	PRINTR "You can't see any steel door here."
?L1:	EQUAL? PRSA,V?OPEN \?L5
	ZERO? CP-FLAG /?L6
	PRINTR "The steel door has already opened."
?L6:	PRINTR "You can't force it open."
?L5:	EQUAL? PRSA,V?CLOSE \?L13
	ZERO? CP-FLAG /?L14
	PRINTR "There doesn't seem to be any way to close it."
?L14:	PRINTR "Do you think it isn't already?"
?L13:	EQUAL? PRSA,V?MUNG \?L21
	PRINTI "The door is, to a first approximation, indestructible."
	CRLF
	CALL PRINT-ID,STR?82 >STACK
	RSTACK
?L21:	EQUAL? PRSA,V?KNOCK \FALSE
	PRINTR "Besides a great amount of reverberation, nothing happens."

	.FUNCT CP-ROOM,RARG
	EQUAL? RARG,M-ENTER \?L1
	EQUAL? PRSO,P?DOWN \?L3
	SET 'CPHERE,1
	RETURN CPHERE
?L3:	SET 'CPHERE,33
	RETURN CPHERE
?L1:	EQUAL? RARG,M-LOOK \FALSE
	ZERO? CPPUSH-FLAG /?L7
	CALL CPWHERE >STACK
	RSTACK
?L7:	PRINTR "You are in a small square room bounded to the north and west with marble walls and to the east and south with sandstone walls."

	.FUNCT CPNS,NUM
	GRTR? NUM,36 /TRUE
	LESS? NUM,1 /TRUE
	GET CPTABLE,NUM >STACK
	RSTACK

	.FUNCT CPEW,NUM,FOO
	MOD NUM,6 >STACK
	EQUAL? STACK,FOO /TRUE
	GET CPTABLE,NUM >STACK
	RSTACK

	.FUNCT CPWHERE,N,S,E,W
	ADD CPHERE,-6 >STACK
	CALL CPNS,STACK >N
	ADD CPHERE,6 >STACK
	CALL CPNS,STACK >S
	ADD CPHERE,1 >STACK
	CALL CPEW,STACK,1 >E
	ADD CPHERE,-1 >STACK
	CALL CPEW,STACK,0 >W
	CALL FIXED-FONT-ON
	PRINTI "      +"
	CALL CP-CORNER,MINUS-SEVEN,N,W
	PRINTI " "
	CALL CP-ORTHO,N
	PRINTI " "
	CALL CP-CORNER,MINUS-FIVE,N,E
	PRINTI "+"
	CRLF
	PRINTI "West  +"
	CALL CP-ORTHO,W
	PRINTI " .. "
	CALL CP-ORTHO,E
	PRINTI "+  East"
	CRLF
	PRINTI "      +"
	CALL CP-CORNER,5,S,W
	PRINTI " "
	CALL CP-ORTHO,S
	PRINTI " "
	CALL CP-CORNER,7,S,E
	PRINTI "+"
	CRLF
	CALL FIXED-FONT-OFF
	EQUAL? CPHERE,1 \?L23
	PRINTI "In the ceiling above you is a large circular opening."
	CRLF
	JUMP ?L30
?L23:	EQUAL? CPHERE,22 \?L27
	PRINTI "The center of the floor here is noticeably depressed."
	CRLF
	JUMP ?L30
?L27:	EQUAL? CPHERE,33 \?L30
	PRINTI "In the center of the west wall is a steel door which is "
	ZERO? CP-FLAG /?L33
	PRINTI "open"
	JUMP ?L37
?L33:	PRINTI "closed"
?L37:	PRINTI ". On one side of the door is a narrow slot."
	CRLF
?L30:	EQUAL? E,-2 \?L43
	PRINTI "There is a ladder here, firmly attached to the east wall."
	CRLF
?L43:	EQUAL? W,-3 \FALSE
	PRINTR "There is a ladder here, firmly attached to the west wall."

	.FUNCT CP-ORTHO,CONTENTS
	ZERO? CONTENTS \?L1
	PRINTI "  "
	RTRUE
?L1:	EQUAL? CONTENTS,1 \?L5
	PRINTI "MM"
	RTRUE
?L5:	PRINTI "SS"
	RTRUE

	.FUNCT CP-CORNER,DIR,COL,ROW,LOCN
	ADD CPHERE,DIR >LOCN
	ZERO? COL /?L1
	ZERO? ROW /?L1
	PRINTI "??"
	RTRUE
?L1:	CALL ILLCP,CPHERE,DIR >STACK
	ZERO? STACK /?L5
	PRINTI "MM"
	RTRUE
?L5:	LESS? LOCN,1 /?L11
	GRTR? LOCN,36 \?L9
?L11:	SET 'COL,1
	JUMP ?L12
?L9:	GET CPTABLE,LOCN >COL
?L12:	ZERO? COL \?L8
	PRINTI "  "
	RTRUE
?L8:	EQUAL? COL,1 \?L15
	PRINTI "MM"
	RTRUE
?L15:	PRINTI "SS"
	RTRUE

	.FUNCT CP-SLOT-FCN
	EQUAL? PRSA,V?PUT \FALSE
	GETP PRSO,P?SIZE >STACK
	GRTR? STACK,10 \?L3
	PRINTR "It doesn't fit."
?L3:	REMOVE PRSO
	EQUAL? PRSO,LORE-BOOK \?L8
	SET 'CP-FLAG,1
	PRINTR "The book drops into the slot and vanishes. The metal door slides open, revealing a passageway to the west, and a sign flashes:
    ""Royal Puzzle Exit Fee Paid
          Item Confiscated"""
?L8:	FSET? PRSO,ACTORBIT \?L12
	CALL PICK-ONE,YUKS >STACK
	PRINT STACK
	CRLF
	RTRUE
?L12:	PRINTI "The item vanishes into the slot. A moment later, a previously unseen sign flashes ""Garbage In, Garbage Out"" and spews out the "
	PRINTD PRSO
	PRINTR " (now atomized)."

	.FUNCT CPOUT-ROOM,RARG
	EQUAL? RARG,M-LOOK \FALSE
	PRINTI "You are in a narrow room, lit from above. A flight of steps leads up to the north, and a "
	ZERO? CP-FLAG /?L5
	PRINTI "passage"
	JUMP ?L9
?L5:	PRINTI "metal door"
?L9:	PRINTR " leads to the east."

	.FUNCT MRGO,TORM
	EQUAL? PRSO,P?NORTH,P?NW,P?NE \?L1
	CALL LKP,HERE,R-NORTHS >TORM
	JUMP ?L3
?L1:	CALL LKP,HERE,R-SOUTHS >TORM
?L3:	EQUAL? PRSO,P?NORTH,P?SOUTH \?L4
	EQUAL? MLOC,TORM \?L6
	MOD MDIR,180 >STACK
	ZERO? STACK \?L8
	PRINTI "There is a wooden wall blocking your way."
	CRLF
	RFALSE
?L8:	CALL MIRIN,0 >STACK
	ZERO? STACK /?L12
	RETURN IN-MIRROR
?L12:	CALL MIRBLOCK
	RFALSE
?L6:	RETURN TORM
?L4:	EQUAL? MLOC,TORM \?L15
	MOD MDIR,180 >STACK
	ZERO? STACK \?L16
	CALL GO-E-W,TORM >STACK
	RSTACK
?L16:	CALL MIRBLOCK
	RFALSE
?L15:	RETURN TORM

	.FUNCT MIRBLOCK,MD
	SET 'MD,MDIR
	EQUAL? PRSO,P?SOUTH \?L1
	ADD MDIR,180 >STACK
	MOD STACK,360 >MD
?L1:	EQUAL? MD,270 \?L7
	ZERO? MR1-FLAG /?L6
?L7:	EQUAL? MD,90 \?L4
	ZERO? MR2-FLAG \?L4
?L6:	PRINTR "There is a large broken mirror blocking your way."
?L4:	PRINTR "There is a large mirror blocking your way."

	.FUNCT GO-E-W,RM
	EQUAL? PRSO,P?NE,P?SE \?L1
	CALL LKP,RM,R-EASTS >STACK
	RSTACK
?L1:	CALL LKP,RM,R-WESTS >STACK
	RSTACK

	.FUNCT EWTELL,RM,EAST?=0,M1?=0,MWIN
	EQUAL? RM,MRAE,MRBE,MRCE /?L3
	EQUAL? RM,MRGE,MRCE \?L1
?L3:	SET 'EAST?,1
?L1:	ZERO? EAST? /?L7
	PUSH 0
	JUMP ?L9
?L7:	PUSH 180
?L9:	ADD MDIR,STACK >STACK
	EQUAL? STACK,180 \?L5
	SET 'M1?,1
?L5:	ZERO? M1? /?L11
	SET 'MWIN,MR1-FLAG
	JUMP ?L13
?L11:	SET 'MWIN,MR2-FLAG
?L13:	PRINTI "You are in a narrow room, whose "
	ZERO? EAST? /?L16
	PUSH STR?83
	JUMP ?L18
?L16:	PUSH STR?84
?L18:	PRINT STACK
	PRINTI " wall is a large "
	ZERO? MWIN /?L19
	PUSH STR?85
	JUMP ?L21
?L19:	PUSH STR?86
?L21:	PRINT STACK
	CRLF
	ZERO? M1? /?L22
	ZERO? MIRROR-OPEN-FLAG /?L22
	ZERO? MWIN /?L26
	PUSH STR?87
	JUMP ?L28
?L26:	PUSH STR?88
?L28:	PRINT STACK
	CRLF
?L22:	PRINTR "The opposite wall is solid rock."

	.FUNCT MRDEW,RARG=0
	EQUAL? RARG,M-LOOK \FALSE
	CALL EWTELL,HERE
	SET 'GUARDIANS-SEEN,1
	PRINTI "Somewhat to the south"
	PRINT GUARDSTR
	CRLF
	RTRUE

	.FUNCT MRCEW,RARG=0
	EQUAL? RARG,M-LOOK \FALSE
	CALL EWTELL,HERE
	SET 'GUARDIANS-SEEN,1
	PRINTI "Somewhat to the north"
	PRINT GUARDSTR
	CRLF
	RTRUE

	.FUNCT MRBEW,RARG=0
	EQUAL? RARG,M-LOOK \FALSE
	CALL EWTELL,HERE
	PRINTR "To the north and south are large hallways."

	.FUNCT MRAEW,RARG=0
	EQUAL? RARG,M-LOOK \FALSE
	CALL EWTELL,HERE
	PRINTR "To the north is a large hallway."

	.FUNCT LOOK-TO,RMN,RMS,NORTH?=0,NTELL=0,STELL=0,MIR?,M1?=0,DIR
	EQUAL? HERE,MREYE,FRONT-DOOR /?L1
	PRINTI "This is a part of the long hallway. The east and west walls are dressed stone. In the center of the hall is a shallow stone channel. In the center of the room the channel widens into a large hole around which is engraved a compass rose."
	CRLF
?L1:	EQUAL? HERE,MRG \?L6
	SET 'GUARDIANS-SEEN,1
	PRINTI "On either side of you are identical stone statues holding bludgeons. They appear ready to strike, though, for the moment, they remain impassive."
	CRLF
	JUMP ?L19
?L6:	EQUAL? HERE,MRC \?L10
	SET 'GUARDIANS-SEEN,1
	PRINTI "Somewhat to the north"
	PRINT GUARDSTR
	CRLF
	SET 'NTELL,1
	JUMP ?L19
?L10:	EQUAL? HERE,FRONT-DOOR \?L13
	PRINTI "You are in a north-south hallway which ends, to the north, at a large wooden door."
	CRLF
	SET 'NTELL,1
	JUMP ?L19
?L13:	EQUAL? HERE,MRD \?L16
	SET 'GUARDIANS-SEEN,1
	PRINTI "Somewhat to the south"
	PRINT GUARDSTR
	CRLF
	SET 'STELL,1
	JUMP ?L19
?L16:	EQUAL? HERE,MRA \?L19
	PRINTI "The hallway continues to the south."
	CRLF
	SET 'STELL,1
?L19:	EQUAL? MLOC,RMN,RMS \?L46
	EQUAL? MLOC,RMN \?L25
	SET 'NORTH?,1
	SET 'NTELL,1
	SET 'DIR,STR?89
	JUMP ?L27
?L25:	SET 'STELL,1
	SET 'DIR,STR?90
?L27:	ZERO? NORTH? /?L66
	GRTR? MDIR,180 \?L28
	LESS? MDIR,359 \?L28
	SET 'M1?,1
	SET 'MIR?,MR1-FLAG
	JUMP ?L31
?L28:	ZERO? NORTH? \?L30
?L66:	GRTR? MDIR,0 \?L30
	LESS? MDIR,179 \?L30
	SET 'M1?,1
	SET 'MIR?,MR1-FLAG
	JUMP ?L31
?L30:	SET 'MIR?,MR2-FLAG
?L31:	MOD MDIR,180 >STACK
	ZERO? STACK \?L32
	PRINTI "The "
	PRINT DIR
	PRINTI "th side of the room is divided by a wooden wall into small hallways to the "
	PRINT DIR
	PRINTI "theast and "
	PRINT DIR
	PRINTI "thwest."
	CRLF
	JUMP ?L46
?L32:	ZERO? MIR? /?L43
	PUSH STR?91
	JUMP ?L45
?L43:	PUSH STR?92
?L45:	PRINT STACK
	PRINT DIR
	PRINTI "th side of the hallway."
	CRLF
	ZERO? M1? /?L46
	ZERO? MIRROR-OPEN-FLAG /?L46
	ZERO? MIR? /?L50
	PUSH STR?87
	JUMP ?L52
?L50:	PUSH STR?88
?L52:	PRINT STACK
	CRLF
?L46:	ZERO? NTELL \?L59
	ZERO? STELL \?L55
	PRINTR "The corridor continues north and south."
?L55:	ZERO? NTELL \?L59
	PRINTR "The corridor continues north."
?L59:	ZERO? STELL \TRUE
	PRINTR "The corridor continues south."

	.FUNCT MRDF,RARG=0
	EQUAL? RARG,M-LOOK \FALSE
	CALL LOOK-TO,FRONT-DOOR,MRG >STACK
	RSTACK

	.FUNCT MRCF,RARG=0
	EQUAL? RARG,M-LOOK \FALSE
	CALL LOOK-TO,MRG,MRB >STACK
	RSTACK

	.FUNCT MRBF,RARG=0
	EQUAL? RARG,M-LOOK \FALSE
	CALL LOOK-TO,MRC,MRA >STACK
	RSTACK

	.FUNCT MRAF,RARG=0
	EQUAL? RARG,M-LOOK \FALSE
	CALL LOOK-TO,MRB,0 >STACK
	RSTACK

	.FUNCT GUARDIANS,RARG=0
	EQUAL? RARG,M-LOOK \?L1
	EQUAL? HERE,MRG \?L3
	CALL LOOK-TO,MRD,MRC >STACK
	RSTACK
?L3:	CALL EWTELL,HERE
	PRINTR "To the east and west are the Guardians of Zork, in perfect symmetry. From here, it's hard to tell which of the two is a reflection!"
?L1:	EQUAL? RARG,M-ENTER \?L8
	ZERO? INVIS \?L8
	CALL PRINT-ID,STR?93
	CALL JIGS-UP,STR?94 >STACK
	RSTACK
?L8:	EQUAL? RARG,M-END \FALSE
	EQUAL? PRSA,V?EXAMINE \?L10
	EQUAL? HERE,IN-MIRROR \?L11
	PRINTR "You can't see them from here."
?L11:	PRINTR "The Guardians are quite impressive. I wouldn't get in their way if I were you!"
?L10:	EQUAL? PRSA,V?THROW \?L18
	EQUAL? PRSI,GUARDIAN \?L18
	EQUAL? PRSO,ME \?L19
	PRINTI "You step"
	JUMP ?L23
?L19:	PRINTI "The "
	PRINTD PRSO
	PRINTI " falls"
	REMOVE PRSO
?L23:	PRINTI " in front of the Guardians, who "
	EQUAL? PRSO,ME \?L28
	PRINTI "decimate you"
	CALL PRINT-ID,STR?95
	JUMP ?L32
?L28:	PRINTI "destroy it"
?L32:	PRINTR " in perfect unison. Satisfied, they resume their posts."
?L18:	EQUAL? PRSA,V?ATTACK \?L37
	PRINTI "You aren't close enough, and even if you were, the fight would be a bit one-sided."
	CRLF
	CALL PRINT-ID,STR?96 >STACK
	RSTACK
?L37:	EQUAL? PRSA,V?HELLO \FALSE
	PRINTR "The statues are impassive."

	.FUNCT MIRROR-DIR?,DIR,RM,TBL,?TMP
	EQUAL? DIR,P?NORTH \?L1
	SET 'TBL,R-NORTHS
	JUMP ?L3
?L1:	SET 'TBL,R-SOUTHS
?L3:	GETPT RM,DIR >STACK
	ZERO? STACK /FALSE
	SET '?TMP,MLOC
	CALL LKP,RM,TBL >STACK
	EQUAL? ?TMP,STACK \FALSE
	EQUAL? DIR,P?NORTH \?L6
	GRTR? MDIR,180 \?L6
	LESS? MDIR,360 /TRUE
?L6:	EQUAL? DIR,P?SOUTH \?L8
	GRTR? MDIR,0 \?L8
	LESS? MDIR,180 /TRUE
?L8:	RETURN 2

	.FUNCT WOODEN-WALL-F
	MOD MDIR,180 >STACK
	ZERO? STACK \?L1
	CALL MIRROR-DIR?,P?NORTH,HERE >STACK
	ZERO? STACK \?L3
	CALL MIRROR-DIR?,P?SOUTH,HERE >STACK
	ZERO? STACK /?L1
?L3:	EQUAL? PRSA,V?PUSH \FALSE
	PRINTR "The structure won't budge."
?L1:	PRINTR "You can't see any wooden wall here."

	.FUNCT MIRROR-HERE?,RM,TMP
	EQUAL? HERE,MRAE,MRAW,MRBE /?L3
	EQUAL? HERE,MRBW,MRCE,MRCW /?L3
	EQUAL? HERE,MRGE,MRGW,MRDE /?L3
	EQUAL? HERE,MRDW \?L1
?L3:	EQUAL? RM,MRAE,MRBE,MRCE /?L8
	EQUAL? RM,MRGE,MRDE \?L6
?L8:	PUSH 0
	JUMP ?L9
?L6:	PUSH 180
?L9:	ADD MDIR,STACK >STACK
	EQUAL? 180,STACK /TRUE
	RETURN 2
?L1:	MOD MDIR,180 >STACK
	ZERO? STACK /FALSE
	CALL MIRROR-DIR?,P?NORTH,RM >TMP
	ZERO? TMP /?L12
	RETURN TMP
?L12:	CALL MIRROR-DIR?,P?SOUTH,RM >TMP
	ZERO? TMP /FALSE
	RETURN TMP

	.FUNCT MIRROR-FUNCTION,MIRROR?1
	CALL MIRROR-HERE?,HERE >MIRROR?1
	ZERO? MIRROR?1 \?L1
	PRINTR "You can't see any mirror here."
?L1:	EQUAL? PRSA,V?MOVE,V?OPEN \?L5
	PRINTR "You don't see a way to open the mirror here."
?L5:	EQUAL? PRSA,V?LOOK-INSIDE \?L8
	EQUAL? MIRROR?1,1 \?L12
	ZERO? MR1-FLAG \?L11
?L12:	ZERO? MR2-FLAG /?L9
?L11:	ZERO? INVIS /?L13
	PRINTR "Amazingly, you have no reflection!"
?L13:	PRINTR "A disheveled adventurer stares back at you."
?L9:	PRINTR "You have destroyed the mirror, or have you forgotten?"
?L8:	EQUAL? PRSA,V?MUNG \?L23
	EQUAL? MIRROR?1,1 \?L24
	ZERO? MR1-FLAG /?L26
	SET 'MR1-FLAG,0
	PRINTI "The mirror breaks, revealing a wooden panel behind it. The glistening fragments of mirror quietly sparkle into nonexistence."
	CRLF
	CALL PRINT-ID,STR?97 >STACK
	RSTACK
?L26:	PRINTR "The mirror has already been broken."
?L24:	ZERO? MR2-FLAG /?L33
	SET 'MR2-FLAG,0
	PRINTI "The mirror breaks, revealing a wooden panel behind it. The glistening fragments of mirror quietly sparkle into nonexistence."
	CRLF
	CALL PRINT-ID,STR?98 >STACK
	RSTACK
?L33:	PRINTI "The mirror has already been broken."
	CRLF
	CALL PRINT-ID,STR?99 >STACK
	RSTACK
?L23:	EQUAL? MIRROR?1,1 \?L41
	ZERO? MR1-FLAG /?L40
?L41:	ZERO? MR2-FLAG \?L39
?L40:	PRINTR "There's no mirror left."
?L39:	EQUAL? PRSA,V?PUSH \FALSE
	EQUAL? MIRROR?1,1 \?L47
	PUSH STR?100
	JUMP ?L49
?L47:	PUSH STR?101
?L49:	PRINT STACK
	CRLF
	RTRUE

	.FUNCT PANEL-FUNCTION,MIRROR?1
	CALL MIRROR-HERE?,HERE >MIRROR?1
	ZERO? MIRROR?1 \?L1
	PRINTR "You can't see any panel here."
?L1:	EQUAL? PRSA,V?MOVE,V?OPEN \?L5
	PRINTR "You don't see a way to open the panel here."
?L5:	EQUAL? PRSA,V?MUNG \?L8
	CALL PRINT-ID,STR?102
	EQUAL? MIRROR?1,1 \?L9
	ZERO? MR1-FLAG /?L11
	PRINT MIRROR-FIRST
	CRLF
	RTRUE
?L11:	PRINTR "The panel is not that easily destroyed."
?L9:	ZERO? MR2-FLAG /?L18
	PRINT MIRROR-FIRST
	CRLF
	RTRUE
?L18:	PRINTR "The panel is not that easily destroyed."
?L8:	EQUAL? PRSA,V?PUSH \FALSE
	EQUAL? MIRROR?1,1 \?L27
	PUSH STR?103
	JUMP ?L29
?L27:	PUSH STR?104
?L29:	PRINT STACK
	CRLF
	RTRUE

	.FUNCT MIROUT,DIR,RM
	EQUAL? PRSO,P?OUT \?L1
	SET 'DIR,1
	JUMP ?L3
?L1:	CALL LKP,PRSO,DIRVEC >DIR
?L3:	ZERO? MIRROR-OPEN-FLAG /?L4
	EQUAL? DIR,1 /?L8
	ADD MDIR,270 >STACK
	MOD STACK,360 >STACK
	EQUAL? STACK,DIR \?L6
?L8:	MOD MDIR,180 >STACK
	ZERO? STACK \?L9
	CALL MIREW >STACK
	RSTACK
?L9:	LESS? MDIR,180 /?L12
	PUSH 0
	JUMP ?L13
?L12:	PUSH 1
?L13:	CALL MIRNS,STACK,1 >STACK
	RSTACK
?L6:	PRINTI "There's a wall there."
	CRLF
	RFALSE
?L4:	ZERO? WOOD-OPEN-FLAG /?L17
	EQUAL? DIR,1 /?L20
	ADD MDIR,180 >STACK
	MOD STACK,360 >STACK
	EQUAL? STACK,DIR \?L18
?L20:	ZERO? MDIR \?L21
	SET 'RM,0
	JUMP ?L23
?L21:	SET 'RM,1
?L23:	CALL MIRNS,RM,1 >RM
	ZERO? RM /?L24
	PRINTI "As you leave, the door swings shut."
	CRLF
	SET 'WOOD-OPEN-FLAG,0
	RETURN RM
?L24:	PRINTI "You can't go that way."
	CRLF
	RFALSE
?L18:	PRINTI "You would hit one of the panels."
	CRLF
	RFALSE
?L17:	PRINTI "You are inside a closed box!"
	CRLF
	RFALSE

	.FUNCT MIRNS,NORTH?,EXIT?=0,S,T
	ZERO? EXIT? \?L5
	ZERO? NORTH? /?L18
	EQUAL? MLOC,MRD /FALSE
	ZERO? NORTH? \?L19
?L18:	EQUAL? MLOC,MRA /FALSE
?L5:	ZERO? NORTH? /?L10
?L19:	PUSH P?NORTH
	JUMP ?L12
?L10:	PUSH P?SOUTH
?L12:	GETPT MLOC,STACK >T
	ZERO? T /FALSE
	PTSIZE T >S
	EQUAL? S,UEXIT \?L13
	GETB T,0 >STACK
	RSTACK
?L13:	ZERO? NORTH? /?L15
	CALL LKP,MLOC,R-NORTHS >STACK
	RSTACK
?L15:	CALL LKP,MLOC,R-SOUTHS >STACK
	RSTACK

	.FUNCT MIREW
	ZERO? MDIR \?L1
	CALL LKP,MLOC,R-WESTS >STACK
	RSTACK
?L1:	CALL LKP,MLOC,R-EASTS >STACK
	RSTACK

	.FUNCT MIRIN,VRB=1
	CALL MIRROR-HERE?,HERE >STACK
	EQUAL? STACK,1 \?L1
	ZERO? MIRROR-OPEN-FLAG /?L1
	RETURN IN-MIRROR
?L1:	ZERO? VRB /FALSE
	CALL MIRROR-HERE?,HERE >STACK
	EQUAL? STACK,1 \?L4
	ZERO? MIRROR-OPENED \?L5
	ZERO? MR1-FLAG /?L5
	PRINTI "A mirror blocks your way."
	CRLF
	RFALSE
?L5:	PRINTI "The panel is closed."
	CRLF
	RFALSE
?L4:	PRINTI "The structure blocks your way."
	CRLF
	RFALSE

	.FUNCT MREYE-ROOM,RARG=0,O
	EQUAL? RARG,M-BEG \?L1
	EQUAL? PRSA,V?DROP \?L1
	IN? PRSO,WINNER \?L1
	CALL BEAM-STOPPED? >STACK
	ZERO? STACK \?L1
	MOVE PRSO,HERE
	PRINTI "You conveniently drop the "
	PRINTD PRSO
	PRINTR " in position to block the beam of light."
?L1:	EQUAL? RARG,M-LOOK \FALSE
	PRINTI "You are in the middle of a long north-south corridor whose walls are polished stone. A narrow red beam of light crosses the room at the north end, inches above the floor."
	CRLF
	CALL BEAM-STOPPED? >O
	ZERO? O /?L8
	PRINTI "The beam is blocked by a "
	PRINTD O
	PRINTI " lying on the floor."
	CRLF
?L8:	CALL LOOK-TO,MRA,0 >STACK
	RSTACK

	.FUNCT BEAM-STOPPED?,N
	FIRST? MREYE >N /?L1
?L1:	EQUAL? N,PLAYER,BEAM /?L4
	SET 'BEAM-BREAKER,N
	RETURN N
?L4:	NEXT? N >N /?L1
	RFALSE

	.FUNCT BEAM-FUNCTION,PRO,PRI
	EQUAL? PRSA,V?LEAP \?L1
	PRINTI "You jump over the beam and into the hallway."
	CRLF
	CALL GOTO,MRA
	RTRUE
?L1:	EQUAL? PRSA,V?FOLLOW \?L5
	PRINTR "It simply crosses the northern end of the room, so there's nowhere to follow it."
?L5:	EQUAL? PRSA,V?EXAMINE \?L8
	PRINTI "The red beam of light crosses the north end of the room only an inch or so above the floor."
	CALL BEAM-STOPPED? >STACK
	ZERO? STACK /?L11
	PRINTI " The beam is broken by a "
	PRINTD BEAM-BREAKER
	PRINTI " lying on the ground."
?L11:	CRLF
	RTRUE
?L8:	EQUAL? PRSA,V?MUNG,V?PUT \?L16
	EQUAL? PRSA,V?PUT \?L17
	SET 'PRI,PRSO
	SET 'PRO,PRSI
	JUMP ?L19
?L17:	SET 'PRI,PRSI
	SET 'PRO,PRSO
?L19:	ZERO? PRI /FALSE
	EQUAL? PRO,BEAM \FALSE
	IN? PRI,WINNER \?L23
	MOVE PRI,HERE
	SET 'BEAM-BREAKER,PRI
	PRINTI "The beam is now interrupted by a "
	PRINTD PRI
	PRINTR " lying on the floor."
?L23:	IN? PRI,HERE \?L26
	PRINTI "The "
	PRINTD PRI
	PRINTR " already breaks the beam."
?L26:	EQUAL? PRI,HANDS \?L29
	PRINTR "The beam is broken briefly as it passes through."
?L29:	PRINTI "You're not holding the "
	PRINTD PRI
	PRINTR "."
?L16:	EQUAL? PRSA,V?TAKE \FALSE
	EQUAL? PRSO,BEAM \FALSE
	PRINTR "No doubt you have a bottle of moonbeams as well."

	.FUNCT MRSWITCH
	EQUAL? PRSA,V?PUSH \FALSE
	ZERO? MRSWPUSH-FLAG /?L3
	PRINTR "Click."
?L3:	CALL BEAM-STOPPED? >STACK
	ZERO? STACK /?L8
	PRINTI "Click. Snap!"
	CRLF
	CALL QUEUE,I-MRINT,7 >STACK
	PUT STACK,0,1
	SET 'MRSWPUSH-FLAG,1
	SET 'MIRROR-OPEN-FLAG,1
	SET 'MIRROR-OPENED,1
	FCLEAR MRA,TOUCHBIT
	RTRUE
?L8:	PRINTR "Click."

	.FUNCT I-MRINT
	SET 'MRSWPUSH-FLAG,0
	SET 'MIRROR-OPEN-FLAG,0
	CALL MIRROR-HERE?,HERE >STACK
	EQUAL? STACK,1 /?L3
	EQUAL? HERE,IN-MIRROR \?L1
?L3:	PRINTR "The mirror quietly swings shut."
?L1:	EQUAL? HERE,MR-ANTE \FALSE
	PRINTR "The button pops back to its original position."

	.FUNCT MAGIC-MIRROR,RARG=0
	EQUAL? RARG,M-LOOK \FALSE
	PRINTI "You are inside a rectangular box of wood whose structure is rather complicated. Four sides and the roof are filled in, and the floor is open.

As you face the side opposite the entrance, two short sides of carved and polished wood are to your left and right. The left panel is mahogany, the right pine. The wall you face is red on its left half and black on its right. On the entrance side, the wall is white opposite the red part of the wall it faces, and yellow opposite the black section. The painted walls are at least twice the length of the unpainted ones. The ceiling is painted blue.

In the floor is a stone channel about six inches wide and a foot deep. The channel is oriented in a north-south direction. In the exact center of the room the channel widens into a circular depression perhaps two feet wide. Incised in the stone around this area is a compass rose.

Running from one short wall to the other at about waist height is a wooden bar, carefully carved and drilled. This bar is pierced in two places. The first hole is in the center of the bar (and thus the center of the room). The second is at the left end of the room (as you face opposite the entrance). Through each hole runs a wooden pole.

The pole at the left end of the bar is short, extending about a foot above the bar, and ends in a hand grip. The pole "
	EQUAL? MLOC,MRB \?L5
	EQUAL? MDIR,270 \?L5
	ZERO? POLEUP-FLAG /?L7
	PRINTI "has been lifted out of a hole carved in the stone floor. There is evidently enough friction to keep the pole from dropping back down."
	JUMP ?L22
?L7:	PRINTI "has been dropped into a hole carved in the stone floor."
	JUMP ?L22
?L5:	EQUAL? MDIR,0,180 \?L14
	ZERO? POLEUP-FLAG /?L15
	PRINTI "is positioned above the stone channel in the floor."
	JUMP ?L22
?L15:	PRINTI "has been dropped into the stone channel incised in the floor."
	JUMP ?L22
?L14:	PRINTI "is resting on the stone floor."
?L22:	PRINTI "

The long pole at the center of the bar extends from the ceiling through the bar to the circular area in the stone channel. This bottom end of the pole has a T-bar a bit less than two feet long attached to it, and on the T-bar is carved an arrow. The arrow and T-bar are pointing "
	DIV MDIR,45 >STACK
	GET LONGDIRS,STACK >STACK
	PRINT STACK
	PRINTI "."
	ZERO? WOOD-OPEN-FLAG /?L27
	PRINTI "
The pine panel has been opened outward."
?L27:	CRLF
	RTRUE

	.FUNCT MPANELS,MD
	EQUAL? PRSA,V?PUSH \FALSE
	ZERO? POLEUP-FLAG /?L3
	EQUAL? MLOC,MRG \?L9
	ZERO? GUARDIANS-SEEN /?L7
	CALL PRINT-ID,STR?105
	CALL JIGS-UP,STR?106
	RTRUE
?L7:	CALL PRINT-ID,STR?107
	CALL JIGS-UP,STR?108
	RTRUE
?L9:	EQUAL? PRSO,RED-PANEL,YELLOW-PANEL \?L11
	ADD MDIR,45 >STACK
	MOD STACK,360 >MD
	PRINTI "The structure rotates clockwise."
	CRLF
	JUMP ?L15
?L11:	ADD MDIR,315 >STACK
	MOD STACK,360 >MD
	PRINTI "The structure rotates counterclockwise."
	CRLF
?L15:	PRINTI "The arrow on the compass rose now indicates "
	DIV MD,45 >STACK
	GET LONGDIRS,STACK >STACK
	PRINT STACK
	PRINTI "."
	CRLF
	ZERO? WOOD-OPEN-FLAG /?L20
	SET 'WOOD-OPEN-FLAG,0
	PRINTI "The pine wall closes quietly."
	CRLF
?L20:	SET 'MDIR,MD
	RTRUE
?L3:	MOD MDIR,180 >STACK
	ZERO? STACK \?L25
	PRINTR "The short pole prevents the structure from rotating."
?L25:	PRINTR "The structure shakes slightly but doesn't move."

	.FUNCT MENDS,RM
	EQUAL? PRSA,V?CLOSE \?L1
	PRINTR "You can't do that to the panel."
?L1:	EQUAL? PRSA,V?PUSH /?L6
	EQUAL? PRSA,V?OPEN \FALSE
	EQUAL? PRSO,PINE-PANEL \FALSE
?L6:	MOD MDIR,180 >STACK
	ZERO? STACK /?L7
	PRINTR "The structure rocks back and forth slightly but doesn't move."
?L7:	EQUAL? PRSO,MAHOGANY-PANEL \?L11
	LESS? MDIR,180 /?L14
	PUSH 0
	JUMP ?L15
?L14:	PUSH 1
?L15:	CALL MIRNS,STACK >RM
	ZERO? RM /?L12
	ZERO? MDIR /?L16
	PUSH 0
	JUMP ?L17
?L16:	PUSH 1
?L17:	CALL MIRMOVE,STACK,RM >STACK
	RSTACK
?L12:	PRINTR "The structure has reached the end of the stone channel and won't budge."
?L11:	PRINTI "The pine wall swings open."
	CRLF
	EQUAL? MLOC,MRD \?L27
	ZERO? MDIR /?L26
?L27:	EQUAL? MLOC,MRC \?L28
	EQUAL? MDIR,180 /?L26
?L28:	EQUAL? MLOC,MRG \?L24
?L26:	ZERO? GUARDIANS-SEEN /?L29
	PRINTI "The pine door opens into the field of view of the Guardians."
	CRLF
	JUMP ?L33
?L29:	PRINTI "The pine door opens into the field of view of the Guardians of Zork, represented by two identical stone statues carrying bludgeons."
	CRLF
?L33:	CALL PRINT-ID,STR?109
	CALL JIGS-UP,STR?106
	RTRUE
?L24:	SET 'WOOD-OPEN-FLAG,1
	CALL QUEUE,I-PININ,5 >STACK
	PUT STACK,0,1
	RTRUE

	.FUNCT I-PININ
	ZERO? WOOD-OPEN-FLAG /FALSE
	SET 'WOOD-OPEN-FLAG,0
	PRINTR "The pine wall closes quietly."

	.FUNCT MIRMOVE,NORTH?,RM,PU?=0,LOSE=0
	ZERO? POLEUP-FLAG /?L1
	SET 'PU?,1
?L1:	ZERO? PU? /?L6
	PUSH STR?110
	JUMP ?L8
?L6:	PUSH STR?111
?L8:	PRINT STACK
	ZERO? NORTH? /?L9
	PUSH STR?112
	JUMP ?L11
?L9:	PUSH STR?113
?L11:	PRINT STACK
	PRINTI " and stops over another compass rose."
	CRLF
	SET 'MLOC,RM
	EQUAL? RM,MRG \TRUE
	EQUAL? HERE,IN-MIRROR \TRUE
	ZERO? PU? /?L14
	SET 'LOSE,1
	JUMP ?L18
?L14:	ZERO? MR1-FLAG /?L17
	ZERO? MR2-FLAG \?L16
?L17:	SET 'LOSE,1
	JUMP ?L18
?L16:	ZERO? MIRROR-OPEN-FLAG \?L19
	ZERO? WOOD-OPEN-FLAG /?L18
?L19:	SET 'LOSE,1
?L18:	ZERO? LOSE /TRUE
	ZERO? GUARDIANS-SEEN /?L23
	CALL PRINT-ID,STR?114
	CALL JIGS-UP,STR?115
	RTRUE
?L23:	CALL PRINT-ID,STR?116
	CALL JIGS-UP,STR?117
	RTRUE

	.FUNCT SHORT-POLE-F
	EQUAL? PRSA,V?MOVE,V?RAISE \?L1
	EQUAL? POLEUP-FLAG,2 \?L3
	PRINTR "The pole cannot be raised further."
?L3:	SET 'POLEUP-FLAG,2
	PRINTR "The pole is now slightly above the floor."
?L1:	EQUAL? PRSA,V?PUT \?L12
	EQUAL? PRSI,CHANNEL /?L11
?L12:	EQUAL? PRSA,V?LOWER,V?PUSH \FALSE
?L11:	ZERO? POLEUP-FLAG \?L13
	PRINTR "The pole cannot be lowered further."
?L13:	MOD MDIR,180 >STACK
	ZERO? STACK \?L17
	PRINTI "The pole is lowered into the channel."
	CRLF
	SET 'POLEUP-FLAG,0
	RTRUE
?L17:	EQUAL? MDIR,270 \?L20
	EQUAL? MLOC,MRB \?L20
	SET 'POLEUP-FLAG,0
	PRINTR "The pole is lowered into the stone hole."
?L20:	EQUAL? POLEUP-FLAG,1 \?L23
	PRINTR "The pole is already resting on the floor."
?L23:	SET 'POLEUP-FLAG,1
	PRINTR "The pole now rests on the stone floor."

	.FUNCT DUNGEON-MASTER-F,RARG=0
	EQUAL? RARG,M-OBJDESC /FALSE
	EQUAL? WINNER,DUNGEON-MASTER \?L3
	EQUAL? PRSA,V?FOLLOW \?L4
	LOC PLAYER >STACK
	IN? DUNGEON-MASTER,STACK \?L6
	CALL QUEUE,I-FOLIN,-1 >STACK
	PUT STACK,0,1
	PRINTR "The dungeon master answers, ""I will follow."""
?L6:	PRINTR "The dungeon master's voice replies, ""You must come here first!"""
?L4:	EQUAL? PRSA,V?WAIT,V?STAY \?L13
	CALL QUEUE,I-FOLIN,0
	PRINTR "The dungeon master answers, ""I will stay."""
?L13:	EQUAL? PRSA,V?WALK \?L16
	EQUAL? PRSO,P?SOUTH,P?ENTER \?L17
	EQUAL? HERE,NORTH-CORRIDOR \?L17
	PRINTR """I am not permitted to enter the prison cell."""
?L17:	EQUAL? PRSO,P?NORTH \?L21
	EQUAL? HERE,NORTH-CORRIDOR \?L21
	MOVE DUNGEON-MASTER,PARAPET
	SET 'HERE,PARAPET
	PRINTI """Very well. I am at the parapet!"""
	CRLF
	CALL QUEUE,I-FOLIN,0 >STACK
	RSTACK
?L21:	EQUAL? PRSO,P?NORTH,P?ENTER \?L24
	EQUAL? HERE,SOUTH-CORRIDOR \?L24
	PRINTR """I am not permitted to enter the prison cell."""
?L24:	PRINTR """I prefer to stay where I am, thank you."""
?L16:	EQUAL? PRSA,V?WALK-TO \?L30
	EQUAL? PRSO,PARAPET-OBJ \?L30
	MOVE DUNGEON-MASTER,PARAPET
	SET 'HERE,PARAPET
	CALL QUEUE,I-FOLIN,0
	PRINTR """Very well!"""
?L30:	EQUAL? PRSA,V?TAKE \?L33
	PRINTR """I will have no use for that, I am afraid."""
?L33:	EQUAL? PRSA,V?OPEN \?L36
	EQUAL? PRSO,DUNGEON-DOOR \?L36
	ZERO? IN-DUNGEON /?L36
	PRINTR "The dungeon master appears angered. ""Do not run from your quest: you are nearing the end!"""
?L36:	EQUAL? PRSA,V?SPIN,V?TURN,V?PUSH /?L40
	EQUAL? PRSA,V?OPEN,V?STAY,V?FOLLOW /?L40
	EQUAL? PRSA,V?ATTACK,V?WAIT,V?CLOSE /?L40
	EQUAL? PRSA,V?WALK-TO \?L39
?L40:	EQUAL? PRSA,V?WAIT,V?FOLLOW,V?STAY /FALSE
	PRINTI """If you wish,"" he replies."
	CRLF
	RFALSE
?L39:	PRINTR """Do not be foolish! Consider the end of your quest!"""
?L3:	EQUAL? PRSA,V?EXAMINE \?L49
	PRINTR "He is dressed simply in a hood and cloak, wearing an amulet and ring, carrying an old book under one arm, and leaning on a wooden staff. A single key, as if to a prison cell, hangs from his belt."
?L49:	EQUAL? PRSA,V?MUNG,V?ATTACK \?L52
	CALL PRINT-ID,STR?118
	CALL REALLY-DEAD,STR?119 >STACK
	RSTACK
?L52:	EQUAL? PRSA,V?TAKE \?L53
	PRINTR """I'm willing to accompany you, but not ride in your pocket!"""
?L53:	EQUAL? PRSA,V?GIVE \FALSE
	EQUAL? PRSI,DUNGEON-MASTER \FALSE
	PRINTR """I have no need for those things."""

	.FUNCT MASTER-F
	EQUAL? HERE,PRISON-CELL,GOOD-CELL \?L1
	CALL HELLO?,MASTER >STACK
	ZERO? STACK /?L3
	PRINTR "He can't hear you."
?L3:	PRINTR "He is not here."
?L1:	EQUAL? PRSA,V?TELL \?L10
	ZERO? IN-DUNGEON /?L11
	SET 'PRSO,DUNGEON-MASTER
	RFALSE
?L11:	SET 'P-CONT,0
	SET 'QUOTE-FLAG,0
	PRINTR "The dungeon master isn't here."
?L10:	EQUAL? PRSA,V?SGIVE,V?GIVE \?L16
	IN? DUNGEON-MASTER,HERE \?L16
	PRINTR "He politely refuses your offer."
?L16:	EQUAL? PRSA,V?EXAMINE \?L19
	EQUAL? HERE,CELL,NORTH-CORRIDOR \?L19
	IN? DUNGEON-MASTER,PARAPET \?L19
	PRINTR "The dungeon master is standing on the parapet."
?L19:	PRINTR "The dungeon master isn't here."

	.FUNCT BEHIND-DOOR-F,RARG=0
	EQUAL? RARG,M-ENTER \?L1
	ZERO? DM-SEEN \?L1
	CALL QUEUE,I-FOLIN,-1 >STACK
	PUT STACK,0,1
	SET 'DM-SEEN,1
	RETURN DM-SEEN
?L1:	EQUAL? RARG,M-LOOK \FALSE
	PRINTI "You are in a narrow north-south corridor. At the south end is a door and at the north end is an east-west corridor. The door is "
	CALL DPR,DUNGEON-DOOR >STACK
	RSTACK

	.FUNCT FRONT-DOOR-F,RARG=0
	EQUAL? RARG,M-ENTER \?L1
	CALL QUEUE,I-FOLIN,0 >STACK
	RSTACK
?L1:	EQUAL? RARG,M-LOOK \FALSE
	CALL LOOK-TO,0,MRD
	PRINTI "The wooden door has a barred panel in it at about head height. The door itself is "
	CALL DPR,DUNGEON-DOOR >STACK
	RSTACK

	.FUNCT LOOK-LIKE-DM?
	IN? CLOAK,WINNER \FALSE
	IN? HOOD,WINNER \FALSE
	IN? AMULET,WINNER \FALSE
	IN? STAFF,WINNER \FALSE
	IN? RING,WINNER \FALSE
	IN? LORE-BOOK,WINNER \FALSE
	IN? KEY,WINNER \FALSE
	RTRUE

	.FUNCT DUNGEON-PANEL-F
	EQUAL? PRSA,V?OPEN \?L1
	PRINTR "You can't open the panel. It's set into the door."
?L1:	EQUAL? PRSA,V?LOOK-INSIDE \FALSE
	PRINTR "There's not much to be seen."

	.FUNCT DUNGEON-DOOR-F,?TMP
	EQUAL? PRSA,V?CLOSE,V?OPEN \?L1
	PRINTR "The door won't budge."
?L1:	EQUAL? PRSA,V?KNOCK \FALSE
	EQUAL? HERE,FRONT-DOOR \FALSE
	PRINTI "The knock reverberates along the hall. For a time it seems there will be no answer. Then you hear someone unlatching the small panel. Through the bars of the great door, the wrinkled face of an old man appears."
	ZERO? INVIS /?L8
	PRINTI " He seems not to notice you for a brief moment, then recovers."
?L8:	CALL LOOK-LIKE-DM? >STACK
	ZERO? STACK /?L13
	PRINTI " He starts to smile broadly and opens the massive door without a sound. The old man motions and you feel yourself drawn toward him.
""I am the Master of the Dungeon!"" he booms. ""I have been watching you closely during your journey through the Great Underground Empire. Yes!,"" he says, as if recalling some almost forgotten time, ""we have met before, although I may not appear as I did then."" You look closely into his deeply lined face and see the faces of the old man by the secret door, your ""friend"" at the cliff, and the hooded figure. ""You have shown kindness to the old man, and compassion toward the hooded one. You displayed patience in the puzzle and trust at the cliff. You have demonstrated strength, ingenuity, and valor. However, one final test awaits you. Now! Command me as you will, and complete your quest!""
"
	CRLF
	CALL GOTO,BEHIND-DOOR
	SET 'IN-DUNGEON,1
	RETURN IN-DUNGEON
?L13:	PRINTI " He looks you over with a piercing gaze and then speaks gravely. ""I have been waiting a long time for you, "
	SET '?TMP,DM-REASONS
	CALL DMISH >STACK
	GET ?TMP,STACK >STACK
	PRINT STACK
	PRINTI " I will remain here. When you feel you are ready, go to the secret door and 'SAY ""FROTZ OZMOO""'! Go, now!"" He wags his finger in warning. ""Do not forget the double quotes!"" A moment later, you find yourself in the Button Room."
	CRLF
	CALL GOTO,MR-ANTE,0
	RTRUE

	.FUNCT DMISH,CNT=0
	IN? AMULET,WINNER \?L1
	INC 'CNT
?L1:	IN? LORE-BOOK,WINNER \?L4
	INC 'CNT
?L4:	IN? HOOD,WINNER \?L7
	INC 'CNT
?L7:	IN? CLOAK,WINNER \?L10
	INC 'CNT
?L10:	IN? RING,WINNER \?L13
	INC 'CNT
?L13:	IN? KEY,WINNER \?L16
	INC 'CNT
?L16:	IN? STAFF,WINNER \?L19
	INC 'CNT
?L19:	RETURN CNT

	.FUNCT I-FOLIN
	IN? DUNGEON-MASTER,HERE /FALSE
	EQUAL? HERE,PRISON-CELL,CELL \?L3
	ZERO? FOLFLAG /?L3
	PRINTI "You notice that the dungeon master doesn't follow you."
	CRLF
	SET 'FOLFLAG,0
	RTRUE
?L3:	LOC PLAYER >STACK
	EQUAL? STACK,PRISON-CELL,CELL /FALSE
	ZERO? FOLFLAG \?L7
	SET 'FOLFLAG,1
	PRINTI "The dungeon master rejoins you."
	CRLF
	MOVE DUNGEON-MASTER,HERE
	RTRUE
?L7:	PRINTI "The dungeon master follows you."
	CRLF
	MOVE DUNGEON-MASTER,HERE
	RTRUE

	.FUNCT MOVE-CELL-OBJECTS,TOP,CNT,F,X
	SUB LCELL,1 >STACK
	MUL 8,STACK >TOP
	ADD TOP,1 >CNT
	FIRST? CELL >F \?L5
?L4:	NEXT? F >X /?L6
?L6:	ZERO? F /?L5
	PUT CELLOBJS,CNT,F
	REMOVE F
	INC 'CNT
	ZERO? X /?L5
	SET 'F,X
	JUMP ?L4
?L5:	SUB CNT,TOP >STACK
	DEC 'STACK
	PUT CELLOBJS,TOP,STACK
	SUB PNUMB,1 >STACK
	MUL 8,STACK >TOP
	GET CELLOBJS,TOP >CNT
?L14:	ZERO? CNT /TRUE
	INC 'TOP
	GET CELLOBJS,TOP >STACK
	MOVE STACK,CELL
	DEC 'CNT
	JUMP ?L14

	.FUNCT CELL-MOVE,F,X
	FCLEAR CELL-DOOR,OPENBIT
	FCLEAR BRONZE-DOOR,OPENBIT
	EQUAL? PNUMB,LCELL /FALSE
	EQUAL? PNUMB,4 \?L3
	FCLEAR BRONZE-DOOR,INVISIBLE
	JUMP ?L5
?L3:	FSET BRONZE-DOOR,INVISIBLE
?L5:	IN? PLAYER,CELL \?L6
	SET 'WINNER,PLAYER
	FCLEAR GOOD-CELL,TOUCHBIT
	FCLEAR PRISON-CELL,TOUCHBIT
	EQUAL? LCELL,4 \?L8
	FCLEAR BRONZE-DOOR,INVISIBLE
	PUSH GOOD-CELL
	JUMP ?L10
?L8:	PUSH PRISON-CELL
?L10:	CALL GOTO,STACK
	FIRST? CELL >F \?L24
?L14:	NEXT? F >X /?L16
?L16:	ZERO? F /?L24
	MOVE F,HERE
	ZERO? X /?L24
	SET 'F,X
	JUMP ?L14
?L6:	CALL MOVE-CELL-OBJECTS
?L24:	SET 'LCELL,PNUMB
	RETURN LCELL

	.FUNCT PARAPET-F,RARG
	EQUAL? RARG,M-LOOK \FALSE
	PRINTI "You are standing behind a stone retaining wall which rims a parapet overlooking a fiery pit. It is difficult to see through the smoke and flame which fills the pit, but it seems to be bottomless. The pit itself is circular, about two hundred feet in diameter, and is fashioned of roughly hewn stone. The flames generate considerable heat, so it is rather uncomfortable standing here.
There is an object here which looks like a sundial. On it are an indicator arrow surrounding a large button. On the face of the dial are numbers 1 through 8. The indicator points to the number "
	PRINTN PNUMB
	PRINTI "."
	CRLF
	PRINTR "To the south, across a narrow corridor, is a prison cell."

	.FUNCT DIAL,N
	EQUAL? PRSA,V?EXAMINE \?L1
	PRINTI "The dial points to "
	PRINTN PNUMB
	PRINTR "."
?L1:	EQUAL? PRSA,V?TURN \?L5
	EQUAL? PRSI,INTNUM \?L6
	ZERO? P-NUMBER /?L10
	GRTR? P-NUMBER,8 \?L8
?L10:	PRINTR "There is no such setting."
?L8:	SET 'PNUMB,P-NUMBER
	EQUAL? WINNER,PLAYER \TRUE
	PRINTI "The dial now points to "
	PRINTN PNUMB
	PRINTR "."
?L6:	ZERO? PRSI \?L19
	PRINTR "You must specify what to set the dial to."
?L19:	PRINTR "The dial face only contains numbers."
?L5:	EQUAL? PRSA,V?SPIN \FALSE
	RANDOM 8 >PNUMB
	EQUAL? WINNER,PLAYER \TRUE
	PRINTI "The dial spins and comes to a stop pointing at "
	PRINTN PNUMB
	PRINTI "."
	RTRUE

	.FUNCT DIALBUTTON,C
	FSET? CELL-DOOR,OPENBIT /?L1
	SET 'C,0
	JUMP ?L2
?L1:	SET 'C,1
?L2:	FCLEAR CELL,TOUCHBIT
	EQUAL? PRSA,V?PUSH \FALSE
	EQUAL? WINNER,PLAYER \?L5
	PRINTI "The button depresses with a slight click, and pops back."
	CRLF
?L5:	CALL CELL-MOVE
	ZERO? C /TRUE
	PRINTR "You notice that the cell door is now closed."

	.FUNCT CELL-ROOM,RARG
	EQUAL? RARG,M-LOOK \FALSE
	PRINTI "You are in a featureless prison cell. You can see "
	FSET? CELL-DOOR,OPENBIT \?L5
	PRINTI "an east-west corridor outside the cell door. Your view also takes in the parapet and a large, fiery pit."
	CRLF
	JUMP ?L9
?L5:	PRINTI "through the small window in the closed door the parapet, and, behind that, smoke and flames rising from a fiery pit."
	CRLF
?L9:	IN? DUNGEON-MASTER,PARAPET \?L12
	PRINTI "The dungeon master is at the parapet, leaning on his staff. His keen gaze is fixed on you and he looks tense, as if waiting for something to happen."
	CRLF
?L12:	EQUAL? LCELL,4 \TRUE
	PRINTI "Behind you, to the south, is a bronze door which is "
	CALL DPR,BRONZE-DOOR
	RTRUE

	.FUNCT NCELL-ROOM,RARG
	EQUAL? RARG,M-LOOK \FALSE
	PRINTI "You are in a bare prison cell. Its wooden door is securely fastened, and you can see only flames and smoke through its small window. On the south wall is a bronze door which seems to be "
	CALL DPR,BRONZE-DOOR >STACK
	RSTACK

	.FUNCT DPR,OBJ
	FSET? OBJ,OPENBIT \?L1
	PRINTR "open."
?L1:	PRINTR "closed."

	.FUNCT NORTH-CORRIDOR-F,RARG
	EQUAL? RARG,M-LOOK \FALSE
	PRINTI "This is a wide east-west corridor which opens onto a northern parapet at its center. You can see flames and smoke as you peer towards the parapet. The corridor turns south at either end, and in the center of the south wall is a heavy wooden door with a small barred window. The door is "
	CALL DPR,CELL-DOOR >STACK
	RSTACK

	.FUNCT SOUTH-CORRIDOR-F,RARG
	EQUAL? RARG,M-LOOK \FALSE
	PRINTI "You are in an east-west corridor which turns north at its eastern and western ends. The walls are made of the finest marble. Another hall leads south at the center of the corridor."
	CRLF
	EQUAL? LCELL,4 \TRUE
	PRINTI "In the center of the north wall is a bronze door which is "
	CALL DPR,BRONZE-DOOR
	RTRUE

	.FUNCT BRONZE-DOOR-F
	EQUAL? PRSA,V?OPEN \FALSE
	FSET? BRONZE-DOOR,OPENBIT /?L1
	EQUAL? HERE,GOOD-CELL \?L1
	ZERO? BRONZE-DOOR-LOCKED \?L1
	PRINTI "On the other side of the bronze door is a narrow passage which opens out into a larger area."
	CRLF
	FSET BRONZE-DOOR,OPENBIT
	RTRUE
?L1:	EQUAL? PRSA,V?OPEN \FALSE
	ZERO? BRONZE-DOOR-LOCKED /FALSE
	PRINTR "The bronze door is locked."

	.FUNCT LOCKED-DOOR-F
	EQUAL? PRSA,V?UNLOCK,V?OPEN \FALSE
	PRINTR "The door is securely fastened."

	.FUNCT NIRVANA-F,RARG
	EQUAL? RARG,M-END \FALSE
	PRINTI "As you examine your new-found riches, the Dungeon Master materializes beside you, and says, ""Now that you have solved all the mysteries of the Dungeon, it is time for you to assume your rightly earned place in the scheme of things. Long have I waited for one capable of releasing me from my burden!"" He taps you lightly on the head with his staff, mumbling a few well-chosen spells, and you feel yourself changing, growing older and more stooped. For a moment there are two identical mages standing among the treasure, then your counterpart dissolves into a mist and disappears, a sardonic grin on his face.

For a moment you are relieved, safe in the knowledge that you have at last completed your quest in ZORK. You begin to feel the vast powers and lore at your command and thirst for an opportunity to use them.

"
	INC 'SCORE
	CALL PRINT-ID,STR?120
	CALL FINISH >STACK
	RSTACK

	.FUNCT BRONZE-DOOR-EXIT
	FSET? BRONZE-DOOR,INVISIBLE \?L1
	PRINTI "You can't go that way."
	CRLF
	RFALSE
?L1:	FSET? BRONZE-DOOR,OPENBIT \?L5
	RETURN CELL
?L5:	PRINTI "The bronze door is closed."
	CRLF
	RFALSE

	.FUNCT SECRET-DOOR-F
	EQUAL? PRSA,V?OPEN \FALSE
	FSET? SECRET-DOOR,OPENBIT /FALSE
	PRINTI "The massive stone door opens noiselessly. "
	PRINT SECRET-DOOR-DESC
	CRLF
	FSET SECRET-DOOR,OPENBIT
	RTRUE

	.FUNCT MSTAIRS-F,RARG
	EQUAL? RARG,M-ENTER \?L1
	RANDOM 100 >STACK
	GRTR? 30,STACK \?L1
	ZERO? OLD-MAN-FED \?L1
	ZERO? OLD-MAN-GONE \?L1
	MOVE OLD-MAN,HERE
	RTRUE
?L1:	EQUAL? RARG,M-LOOK \FALSE
	PRINTI "You are in a room with passages heading southwest and southeast. The north wall is ornately carved, filled with strange runes and writing in an unfamiliar language."
	CRLF
	FSET? SECRET-DOOR,OPENBIT \?L6
	PRINT SECRET-DOOR-DESC
	CRLF
	RTRUE
?L6:	FSET? SECRET-DOOR,INVISIBLE /FALSE
	PRINTR "The outline of a door is barely visible among the runes."

	.FUNCT HELLO?,WHO
	EQUAL? WINNER,WHO /?L4
	EQUAL? PRSA,V?REPLY,V?ANSWER,V?TELL /?L4
	EQUAL? PRSA,V?INCANT,V?HELLO,V?SAY \FALSE
?L4:	EQUAL? PRSA,V?SAY,V?ANSWER,V?TELL /?L7
	EQUAL? PRSA,V?REPLY,V?INCANT \TRUE
?L7:	SET 'P-CONT,0
	SET 'QUOTE-FLAG,0
	RTRUE

	.FUNCT OLD-MAN-F,RARG=0
	EQUAL? RARG,M-OBJDESC \?L1
	ZERO? OLD-MAN-AWAKE /?L3
	PRINTR "There is an old man huddled in the corner, eyeing you cautiously. He looks weak and tired."
?L3:	PRINTR "An old and wizened man is huddled, asleep, in the corner. He is snoring loudly, and looks quite weak and frail."
?L1:	EQUAL? PRSA,V?GIVE \?L10
	EQUAL? PRSI,OLD-MAN \?L10
	ZERO? OLD-MAN-AWAKE /?L11
	EQUAL? PRSO,WAYBREAD \?L13
	REMOVE WAYBREAD
	PRINTI "He looks up at you and takes the waybread. Slowly, he eats the bread and pauses when he is finished. He starts to speak: ""Perhaps what you seek is through there!"" He points at the carved wall to the north, where you now notice the bare outline of a secret door. When you turn back, the old man is gone!"
	CRLF
	FCLEAR SECRET-DOOR,INVISIBLE
	SET 'OLD-MAN-GONE,1
	REMOVE OLD-MAN
	RTRUE
?L13:	IN? WAYBREAD,WINNER \?L17
	PRINTR "He refuses your offer but motions with his arm to the waybread in your hand."
?L17:	PRINTI "The old man refuses the "
	PRINTD PRSO
	PRINTR " with a wave of his hand."
?L11:	PRINTR "He is asleep!"
?L10:	EQUAL? PRSA,V?EXAMINE \?L26
	ZERO? OLD-MAN-AWAKE /?L27
	PRINTR "The old man is barely awake and appears to nod off every few moments. He has bright eyes, which appear to see right through your body."
?L27:	PRINTR "The man is very, very old and wizened. He has a long, stringy beard and is snoring quite loudly."
?L26:	EQUAL? PRSA,V?LISTEN \?L34
	ZERO? OLD-MAN-AWAKE /?L35
	PRINTR "He isn't talking."
?L35:	PRINTR "He is snoring like a buzz saw."
?L34:	CALL HELLO?,OLD-MAN >STACK
	ZERO? STACK /?L42
	ZERO? OLD-MAN-AWAKE /?L43
	PRINTR "He nods at you without seeming to have understood."
?L43:	PRINTR "He is sleeping soundly and does not respond."
?L42:	EQUAL? PRSA,V?ALARM,V?SHAKE \?L50
	PRINTI "The old man is roused to consciousness. He peers at you through eyes which appear much younger and stronger than his frail body and waits, as if expecting something to happen."
	CRLF
	SET 'OLD-MAN-AWAKE,1
	CALL QUEUE,I-OLD-MAN-SLEEPS,3 >STACK
	PUT STACK,0,1
	RTRUE
?L50:	EQUAL? PRSA,V?MUNG,V?ATTACK \FALSE
	PRINTI "The attack seems to have left the old man unharmed! You watch in awe as he rises to his feet and seems to tower above you. He peers down menacingly, then sadly and wearily. ""Not yet,"" he mourns, and vanishes in a puff of smoke."
	CRLF
	CALL PRINT-ID,STR?121
	SET 'OLD-MAN-GONE,1
	REMOVE OLD-MAN
	RTRUE

	.FUNCT I-OLD-MAN-SLEEPS
	SET 'OLD-MAN-AWAKE,0
	IN? OLD-MAN,HERE \FALSE
	PRINTR "You notice that the old man has fallen asleep."

	.FUNCT RUNES-F
	EQUAL? PRSA,V?READ,V?EXAMINE \FALSE
	PRINTR "The runes are in an ancient language. Some pictures among the runes depict flames, stone statues, and an old man."

	.FUNCT T-BAR-F
	EQUAL? PRSA,V?TURN \FALSE
	PRINTR "You don't have enough leverage to turn the T-bar. You might be able to turn the whole structure, however."

	.FUNCT FLAMING-PIT-F
	EQUAL? PRSA,V?EXAMINE \?L1
	PRINTR "The flaming pit is a seemingly bottomless abyss filled with smoke and flame."
?L1:	EQUAL? PRSA,V?PUT \FALSE
	EQUAL? PRSI,FLAMING-PIT \FALSE
	EQUAL? HERE,PARAPET,NORTH-CORRIDOR \?L6
	EQUAL? PRSO,ME \?L8
	PRINTI "It would be a pity to end your life so near the end of your quest!"
	CRLF
	CALL PRINT-ID,STR?122 >STACK
	RSTACK
?L8:	PRINTI "You cast the "
	PRINTD PRSO
	PRINTI " into the pit, where it is lost forever."
	CRLF
	CALL PRINT-ID,STR?123
	REMOVE PRSO
	RTRUE
?L6:	PRINTR "You're not close enough."

	.FUNCT PARAPET-OBJ-F
	EQUAL? PRSA,V?EXAMINE \FALSE
	EQUAL? HERE,CELL,NORTH-CORRIDOR \?L3
	PRINTI "You can see the parapet and sundial from here."
	IN? DUNGEON-MASTER,PARAPET \?L7
	PRINTI " The dungeon master is there also, leaning on his staff."
?L7:	CRLF
	RTRUE
?L3:	CALL V-LOOK >STACK
	RSTACK

	.FUNCT ROSE-F
	EQUAL? PRSA,V?MOVE,V?TURN \FALSE
	PRINTR "The compass rose is made of stone and is imbedded in the ground. You could not possibly turn it or move it."

	.FUNCT CELL-DOOR-F
	EQUAL? PRSA,V?PUT \?L1
	EQUAL? PRSI,CELL-DOOR \?L1
	PRINTR "You will have to enter the cell first."
?L1:	EQUAL? PRSA,V?THROUGH \FALSE
	EQUAL? HERE,CELL \?L6
	PRINTR "Look around."
?L6:	CALL DO-WALK,P?SOUTH
	RTRUE

	.FUNCT LORE-BOOK-F
	EQUAL? PRSA,V?BURN \?L1
	IN? LORE-BOOK,WINNER /?L1
	PRINTI "The book is consumed in a dazzling display of color."
	CRLF
	REMOVE PRSO
	RTRUE
?L1:	ZERO? IN-DUNGEON /?L5
	EQUAL? PRSA,V?READ,V?EXAMINE,V?OPEN \?L5
	PRINTR "The book seems to will itself open to a specific page. It shows a picture of eight small rooms located around a great circle of flame. All are identical save one, which has a bronze door leading to a room bathed in golden light. A legend beneath the picture says ""The Dungeon and Treasury of Zork."""
?L5:	EQUAL? PRSA,V?OPEN \FALSE
	PRINTR "The book can be perused but not left open."

	.FUNCT CP-HOLE-F
	EQUAL? PRSA,V?THROUGH \FALSE
	CALL DO-WALK,P?DOWN
	RTRUE

	.FUNCT TORCH-PSEUDO
	PRINTR "The torches are out of reach."

	.FUNCT WATER-FCN,AV,PI?
	EQUAL? PRSA,V?SGIVE /FALSE
	EQUAL? PRSA,V?THROUGH \?L3
	CALL PERFORM,V?SWIM,PRSO
	RTRUE
?L3:	EQUAL? PRSA,V?FILL \?L4
	SET 'PRSA,V?PUT
	SET 'PRSI,PRSO
	SET 'PRSO,GLOBAL-WATER
	SET 'PI?,0
	JUMP ?L6
?L4:	EQUAL? PRSO,GLOBAL-WATER \?L5
	SET 'PI?,0
	JUMP ?L6
?L5:	ZERO? PRSI /?L6
	SET 'PI?,1
?L6:	ZERO? PI? /?L8
	SET 'PRSI,GLOBAL-WATER
	JUMP ?L10
?L8:	SET 'PRSO,GLOBAL-WATER
?L10:	EQUAL? PRSA,V?PUT,V?TAKE \?L11
	ZERO? PI? \?L16
	PRINTR "The water slips through your fingers."
?L11:	ZERO? PI? /?L15
?L16:	PRINTR "You can't do that."
?L15:	EQUAL? PRSA,V?THROW,V?GIVE,V?DROP \FALSE
	PRINTR "You don't have any water."

	.FUNCT RANDOM-WALL
	EQUAL? PRSA,V?PUSH \FALSE
	EQUAL? HERE,IN-MIRROR \?L3
	PRINTR "You should specify which panel you want to push."
?L3:	PRINTR "You can't budge it; at least from here."

	.FUNCT V-DIAGNOSE
	GET DIAG,P-STRENGTH >STACK
	PRINT STACK
	CRLF
	RTRUE

	.FUNCT JIGS-UP,DESC,PLAYER?=0
	SET 'SWORD-STATE,0
	SET 'P-STRENGTH,5
	SET 'S-STRENGTH,5
	PRINT DESC
	CRLF
	EQUAL? YEAR,YEAR-PRESENT /?L3
	QUIT
?L3:	EQUAL? ADVENTURER,WINNER /?L6
	PRINTI " 
   ****  The "
	PRINTD WINNER
	PRINTI " has died  **** 

"
	REMOVE WINNER
	SET 'WINNER,ADVENTURER
	LOC WINNER >HERE
	RETURN 2
?L6:	PRINTI "
    ****  You have died  ****

"
	IGRTR? 'DEATHS,3 \?L15
	PRINTI "You feel yourself disembodied in a deep blackness. A voice from the void speaks:  ""I have waited a long age for you, my friend, but perhaps it has been another that I have been seeking. Good night, oh worthy adventurer!"" It is the last you hear."
	CRLF
	CALL PRINT-ID,STR?124
	QUIT
?L15:	PRINTI "You find yourself deep within the earth in a barren prison cell. Outside the iron-barred window, you can see a great, fiery pit. Flames leap up and very nearly sear your flesh. After a while, footfalls can be heard in the distance, then closer and closer.... The door swings open, and in walks an old man.

He is dressed simply in a hood and cloak, wearing an amulet and ring, carrying an old book under one arm, and leaning on a wooden staff. A single key, as if to a massive prison cell, hangs from his belt.

He raises the staff toward you and you hear him speak, as if in a dream: ""I await you, though your journey be long and full of peril. Go then, and let me not wait long!"" You feel some great power well up inside you and you fall to the floor. The next moment, you are awakening, as if from a deep slumber."
	CRLF
	CALL PRINT-ID,STR?125
	MOVE CURRENT-LAMP,ZORK2-STAIR
	IN? KEY,WINNER \?L22
	EQUAL? HERE,DARK-1,DARK-2,KEY-ROOM /?L24
	EQUAL? HERE,AQ-1,AQ-2 \?L22
?L24:	MOVE KEY,KEY-ROOM
?L22:	CRLF
	CALL GOTO,ZORK2-STAIR
	SET 'P-CONT,0
	CALL RANDOMIZE-OBJECTS
	CALL KILL-INTERRUPTS
	RETURN 2

	.FUNCT RANDOMIZE-OBJECTS,R=0,F,N,L
	FIRST? WINNER >N /?L1
?L1:	SET 'F,N
	ZERO? F /TRUE
	NEXT? F >N /?L7
?L7:	CALL RANDOM-ELEMENT,DEAD-OBJ-LOCS >STACK
	MOVE F,STACK
	JUMP ?L1

	.FUNCT KILL-INTERRUPTS
	CALL INT,I-MAN-LEAVES >STACK
	PUT STACK,0,0
	CALL INT,I-MAN-RETURNS >STACK
	PUT STACK,0,0
	CALL INT,I-VIEW-SNAP >STACK
	PUT STACK,0,0
	CALL INT,I-FOLIN >STACK
	PUT STACK,0,0
	RTRUE

	.FUNCT V-SCORE,ASK?=1
	PRINTI "Your potential is "
	PRINTN SCORE
	PRINTI " of a possible "
	PRINTN SCORE-MAX
	PRINTI ", in "
	PRINTN MOVES
	EQUAL? MOVES,1 \?L7
	PRINTI " move."
	JUMP ?L11
?L7:	PRINTI " moves."
?L11:	CRLF
	RETURN SCORE

	.FUNCT TM-HOLLOW-F
	EQUAL? PRSA,V?PUT \?L1
	EQUAL? PRSI,TM-HOLLOW \?L1
	CALL PERFORM,V?PUT-UNDER,PRSO,TM-SEAT
	RTRUE
?L1:	EQUAL? PRSA,V?LOOK-INSIDE \?L3
	CALL PERFORM,V?LOOK-UNDER,TM-SEAT
	RTRUE
?L3:	EQUAL? PRSO,TM-HOLLOW \?L4
	CALL PERFORM,PRSA,TM-SEAT,PRSI
	RTRUE
?L4:	EQUAL? PRSI,TM-HOLLOW \FALSE
	CALL PERFORM,PRSA,PRSO,TM-SEAT
	RTRUE

	.FUNCT IRON-DOOR-F
	EQUAL? PRSA,V?THROUGH,V?UNLOCK,V?OPEN \FALSE
	LESS? YEAR,YEAR-PRESENT \?L3
	PRINTR "The iron door is locked from the outside."
?L3:	PRINTR "The iron door is rusted shut and cannot be opened."

	.FUNCT I-CLEFT
	EQUAL? HERE,ZORK-IV,ROOM-8,TIMBER-ROOM /?L3
	EQUAL? HERE,LOWER-SHAFT,LADDER-BOTTOM,LADDER-TOP \?L1
?L3:	PRINTI "You feel a mild tremor from within the earth which passes quickly."
	CRLF
	JUMP ?L6
?L1:	PRINTI "There is a great tremor from within the earth. The entire dungeon shakes violently and loose debris falls from above you."
	CRLF
?L6:	EQUAL? HERE,MUSEUM-ANTE \?L9
	PRINTI "To the east, next to the great iron door, a cleft opens up, revealing an open area behind!"
	CRLF
	JUMP ?L16
?L9:	EQUAL? HERE,AQ-VIEW \?L13
	PRINTI "One of the giant pillars supporting the aqueduct collapses in a pile of smoke and rubble!"
	CRLF
	JUMP ?L16
?L13:	EQUAL? HERE,AQ-2,AQ-3 \?L16
	PRINTI "The channel beneath your feet trembles. Then the channel just to the "
	EQUAL? HERE,AQ-2 \?L19
	PRINTI "north"
	JUMP ?L23
?L19:	PRINTI "south"
?L23:	PRINTI " collapses and falls into the chasm!"
	CRLF
?L16:	SET 'CLEFT-FLAG,1
	FCLEAR CLEFT,INVISIBLE
	SET 'AQ-FLAG,0
	RTRUE

	.FUNCT CLEFT-F
	EQUAL? YEAR,YEAR-PRESENT /FALSE
	PRINTR "There is no cleft here."

	.FUNCT MUSEUM-ANTE-F,RARG
	EQUAL? RARG,M-LOOK \FALSE
	ZERO? CLEFT-FLAG /?L3
	PRINTR "This is the south end of a monumental hall, full of debris from a recent earthquake. To the east is a great iron door, rusted shut. To its right, however, is a gaping cleft in the rock and behind, a cleared area."
?L3:	PRINTR "You are in the southern half of a monumental hall. To the east lies a tremendous iron door which appears to be rusted shut."

	.FUNCT DDESC,STR1,DOOR,STR2
	PRINT STR1
	FSET? DOOR,OPENBIT \?L3
	PRINTI "open"
	JUMP ?L7
?L3:	PRINTI "closed"
?L7:	PRINT STR2
	CRLF
	RTRUE

	.FUNCT MUSEUM-ENTRANCE-F,RARG
	EQUAL? RARG,M-LOOK \FALSE
	FSET? CAGE,INVISIBLE \?L3
	PRINTR "This is an entrance hall of some sort, judging by the grand iron door to the west, and the ornate stone and wooden doors which lead to the east and north, respectively. A few wide steps lead south."
?L3:	PRINTI "This is the entrance to the Royal Museum, the finest and grandest in the Great Underground Empire. To the south, down a few steps, is the entrance to the Royal Puzzle and to the east, through a stone door, is the Royal Jewel Collection. A wooden door to the north is "
	FSET? WOODEN-DOOR,OPENBIT \?L12
	PUSH STR?126
	JUMP ?L14
?L12:	PUSH STR?127
?L14:	PRINT STACK
	PRINTI " and leads to the Museum of Technology. "
	EQUAL? YEAR,YEAR-PRESENT \?L15
	PRINTR "To the west is a great iron door, rusted shut. To its left, however, is a cleft in the rock providing an exit from the museum."
?L15:	LESS? YEAR,YEAR-PRESENT \?L19
	PRINTR "To the west is a great iron door, rusted shut."
?L19:	PRINTR "To the west is a great iron door, rusted shut. The cleft in the rock, present when you started, has filled in with rubble."

	.FUNCT TIME-MACHINE-F,RARG=0
	EQUAL? RARG,M-OBJDESC \?L1
	PRINTI "Directly in front of you is a large golden machine, which has a seat with a console in front. On the console is a single button and a dial connected to a three-digit display which reads "
	PRINTN TM-YEAR
	PRINTR ". The machine is surprisingly shiny and shows few signs of age."
?L1:	EQUAL? RARG,M-BEG \?L5
	EQUAL? PRSA,V?MOVE \?L6
	PRINTR "You might be able to move the machine by pushing it."
?L6:	EQUAL? PRSA,V?PUSH-TO \?L10
	EQUAL? PRSO,TIME-MACHINE \?L10
	PRINTR "That would be a good trick from inside it."
?L10:	EQUAL? PRSA,V?WALK \?L13
	PRINTR "You're not going anywhere in this heap."
?L13:	EQUAL? PRSA,V?MOVE,V?PUT,V?TAKE /?L17
	EQUAL? PRSA,V?CLOSE,V?OPEN,V?PUSH \FALSE
?L17:	CALL HELD?,PRSO >STACK
	ZERO? STACK \FALSE
	IN? PRSO,TIME-MACHINE /FALSE
	PRINTR "You can't do that from inside the machine."
?L5:	ZERO? RARG \FALSE
	EQUAL? PRSA,V?PUT \?L22
	EQUAL? PRSI,TIME-MACHINE \?L22
	PRINTR "You can't put anything on or inside the machine itself."
?L22:	EQUAL? PRSO,TIME-MACHINE \FALSE
	EQUAL? PRSA,V?CLOSE,V?OPEN \?L27
	PRINTR "This is a machine, not a box."
?L27:	EQUAL? PRSA,V?EXAMINE \?L31
	PRINTI "The machine consists of a seat and a console containing one small button and a dial connected to a display which reads "
	PRINTN TM-YEAR
	PRINTR "."
?L31:	EQUAL? PRSA,V?BOARD \?L34
	FIRST? TM-SEAT >STACK \?L34
	PRINTR "That will be somewhat uncomfortable!"
?L34:	EQUAL? PRSA,V?RAISE,V?TAKE \?L37
	PRINTR "The machine must weigh hundreds of pounds and cannot be carried."
?L37:	EQUAL? PRSA,V?MOVE,V?PUSH \?L40
	PRINTR "You should specify in which direction to push the machine."
?L40:	EQUAL? PRSA,V?PUSH-TO \FALSE
	CALL DO-WALK,P-DIRECTION >STACK
	EQUAL? STACK,M-FATAL /TRUE
	PRINTI "With some effort, you push the machine into the room with you."
	CRLF
	EQUAL? HERE,CP-ANTE,MID-CP-ANTE \?L48
	PRINTI "However, the machine seems to have sustained some damage as a result of going over the stairs."
	CRLF
	CALL PRINT-ID,STR?128
	SET 'MACHINE-DAMAGED,1
	JUMP ?L52
?L48:	EQUAL? HERE,MUSEUM-ANTE \?L52
	PRINTI "Pushing the machine through the cleft seems to have damaged it."
	CRLF
	CALL PRINT-ID,STR?129
	SET 'MACHINE-DAMAGED,1
?L52:	MOVE TIME-MACHINE,HERE
	RTRUE

	.FUNCT TM-SEAT-F
	EQUAL? PRSA,V?BOARD,V?CLIMB-ON \?L1
	CALL PERFORM,V?BOARD,TIME-MACHINE
	RTRUE
?L1:	EQUAL? PRSA,V?PUT-BEHIND,V?PUT-UNDER \?L3
	EQUAL? PRSI,TM-SEAT \?L3
	EQUAL? PRSO,RING \?L4
	PRINTI "The ring is concealed underneath the seat."
	CRLF
	SET 'RING-CONCEALED,1
	REMOVE RING
	RTRUE
?L4:	PRINTR "It's too big to hide under the seat."
?L3:	EQUAL? PRSA,V?RUB \?L11
	PRINTR "There's nothing odd about the feel of the seat."
?L11:	EQUAL? PRSA,V?MOVE,V?RAISE,V?LOOK-UNDER \FALSE
	ZERO? RING-CONCEALED /?L15
	PRINTI "You find the ring under the seat and put it on your finger."
	CRLF
	MOVE RING,WINNER
	SET 'RING-CONCEALED,0
	RTRUE
?L15:	PRINTR "You notice a small hollow area under the seat."

	.FUNCT TM-DIAL-F
	EQUAL? PRSA,V?EXAMINE \?L1
	PRINTI "The dial is set to "
	PRINTN TM-YEAR
	PRINTR "."
?L1:	EQUAL? PRSA,V?TURN \FALSE
	EQUAL? PRSI,INTNUM \?L6
	GRTR? P-NUMBER,999 \?L8
	PRINTR "You can't set it beyond 999."
?L8:	SET 'TM-YEAR,P-NUMBER
	PRINTI "The dial is set to "
	PRINTN TM-YEAR
	PRINTR "."
?L6:	ZERO? PRSI \?L15
	PRINTR "You have to say what to turn it to!"
?L15:	PRINTR "You can't do that!"

	.FUNCT TM-BUTTON-F
	EQUAL? PRSA,V?PUSH \FALSE
	EQUAL? TM-YEAR,YEAR-BUILT \?L3
	ZERO? TM-POINT \?L3
	INC 'SCORE
	SET 'TM-POINT,1
?L3:	ZERO? MACHINE-DAMAGED \?L8
	IN? WINNER,TIME-MACHINE /?L6
?L8:	PRINTR "Nothing seems to have happened."
?L6:	LESS? TM-YEAR,YEAR-BUILT \?L11
	CALL PRINT-ID,STR?130
	CALL REALLY-DEAD,STR?131 >STACK
	RSTACK
?L11:	EQUAL? YEAR,TM-YEAR \?L12
	PRINTR "Nothing seems to have happened."
?L12:	LESS? TM-YEAR,YEAR-CLOSED \?L15
	PRINTI "You experience a brief period of disorientation. When your vision returns, "
	EQUAL? HERE,MUSEUM-ENTRANCE,MID-MUSEUM-ENTRANCE,OLD-MUSEUM-ENTRANCE \?L18
	EQUAL? TM-YEAR,YEAR-CAGED \?L20
	PRINTI "you are surrounded by a number of heavily armed guards, the dress and speech of which seem strange and unfamiliar. A commotion starts at a door to the east and a person with a flat head, wearing a gaudy crown and a purple robe, bursts into the room."
	CRLF
	CALL FLATHEAD-SENTENCE >STACK
	RSTACK
?L20:	CALL GUARDS-KILL >STACK
	RSTACK
?L18:	EQUAL? HERE,JEWEL-ROOM,MID-JEWEL-ROOM,OLD-JEWEL-ROOM \?L25
	EQUAL? TM-YEAR,YEAR-CAGED \?L26
	PRINTI "you find yourself in the middle of some kind of ceremony, with a strange flat-headed man wearing royal vestments about to break a bottle on the bars of an iron cage containing magnificent jewels. He appears pleased by your presence. "
	CALL FLATHEAD-SENTENCE >STACK
	RSTACK
?L26:	GRTR? TM-YEAR,YEAR-CAGED \?L30
	CALL GUARDS-KILL >STACK
	RSTACK
?L30:	PRINT SURROUNDINGS-CHANGED
	CRLF
	CALL TGOTO,OLD-JEWEL-ROOM >STACK
	RSTACK
?L25:	EQUAL? HERE,TECH-MUSEUM,MID-TECH-MUSEUM,OLD-TECH-MUSEUM \FALSE
	EQUAL? TM-YEAR,YEAR-BUILT /?L35
	CALL GUARDS-KILL >STACK
	RSTACK
?L35:	PRINT SURROUNDINGS-CHANGED
	CRLF
	CALL TGOTO,OLD-TECH-MUSEUM >STACK
	RSTACK
?L15:	CALL HAPPY-NEW-YEAR >STACK
	RSTACK

	.FUNCT HAPPY-NEW-YEAR
	PRINTI "You experience a brief period of disorientation. When your vision returns, your surroundings appear somewhat altered."
	CRLF
	EQUAL? HERE,OLD-JEWEL-ROOM,MID-JEWEL-ROOM,JEWEL-ROOM \?L3
	LESS? TM-YEAR,YEAR-PRESENT \?L5
	CALL TGOTO,MID-JEWEL-ROOM >STACK
	RSTACK
?L5:	CALL TGOTO,JEWEL-ROOM >STACK
	RSTACK
?L3:	EQUAL? HERE,OLD-TECH-MUSEUM,MID-TECH-MUSEUM,TECH-MUSEUM \?L8
	LESS? TM-YEAR,YEAR-PRESENT \?L9
	CALL TGOTO,MID-TECH-MUSEUM >STACK
	RSTACK
?L9:	CALL TGOTO,TECH-MUSEUM >STACK
	RSTACK
?L8:	LESS? TM-YEAR,YEAR-PRESENT \?L12
	CALL TGOTO,MID-MUSEUM-ENTRANCE >STACK
	RSTACK
?L12:	CALL TGOTO,MUSEUM-ENTRANCE >STACK
	RSTACK

	.FUNCT I-SNAP
	EQUAL? YEAR,YEAR-PRESENT /FALSE
	SET 'TM-YEAR,YEAR-PRESENT
	PRINTI "You start to feel light-headed and quickly become completely disoriented. When your head clears, you realize that your surroundings have changed."
	CRLF
	CALL TGOTO,SNAP-LOC,1 >STACK
	RSTACK

	.FUNCT MOVE-JEWELS
	EQUAL? TM-YEAR,YEAR-BUILT \?L1
	MOVE PEDESTAL,OLD-JEWEL-ROOM
	JUMP ?L4
?L1:	LESS? TM-YEAR,YEAR-PRESENT \?L3
	MOVE PEDESTAL,MID-JEWEL-ROOM
	JUMP ?L4
?L3:	MOVE PEDESTAL,JEWEL-ROOM
?L4:	ZERO? RING-STOLEN \TRUE
	MOVE SCEPTRE,PEDESTAL
	FSET SCEPTRE,NDESCBIT
	MOVE JEWELLED-KNIFE,PEDESTAL
	FSET JEWELLED-KNIFE,NDESCBIT
	ZERO? RING-CONCEALED \FALSE
	MOVE RING,PEDESTAL
	FSET RING,NDESCBIT
	RTRUE

	.FUNCT TGOTO,RM=0,SNAP=0
	INC 'MOVES
	CALL QUEUE,I-GUARDS-LEAVE,0
	SET 'INVIS,0
	GRTR? YEAR,YEAR-BUILT \?L1
	SET 'GUARDS-PRESENT,1
?L1:	EQUAL? YEAR,YEAR-PRESENT \?L4
	SET 'SNAP-LOC,HERE
	CALL QUEUE,I-SNAP,40 >STACK
	PUT STACK,0,1
?L4:	EQUAL? TM-YEAR,YEAR-PRESENT \?L7
	SET 'CLEFT-FLAG,1
	JUMP ?L9
?L7:	SET 'CLEFT-FLAG,0
?L9:	FCLEAR JEWEL-DOOR,OPENBIT
	FCLEAR WOODEN-DOOR,OPENBIT
	FCLEAR IRON-DOOR,OPENBIT
	EQUAL? YEAR,YEAR-BUILT \?L16
	ZERO? RING-CONCEALED /?L12
	IN? TIME-MACHINE,OLD-TECH-MUSEUM \?L15
	IN? SCEPTRE,PEDESTAL \?L12
	IN? JEWELLED-KNIFE,PEDESTAL \?L12
	SET 'RING-STOLEN,1
	FSET CAGE,INVISIBLE
	REMOVE SCEPTRE
	REMOVE JEWELLED-KNIFE
	JUMP ?L16
?L12:	IN? TIME-MACHINE,OLD-TECH-MUSEUM \?L15
	ZERO? RING-CONCEALED /?L14
?L15:	SET 'CLUMSY-ROBBERY,1
	REMOVE TIME-MACHINE
	JUMP ?L16
?L14:	IN? RING,PEDESTAL \?L17
	IN? SCEPTRE,PEDESTAL \?L17
	IN? JEWELLED-KNIFE,PEDESTAL /?L16
?L17:	SET 'MYSTERY,1
?L16:	EQUAL? TM-YEAR,YEAR-BUILT \?L20
	SET 'MYSTERY,0
	SET 'CLUMSY-ROBBERY,0
?L20:	SET 'YEAR,TM-YEAR
	CALL MOVE-TM-OBJECTS
	CALL MOVE-JEWELS
	MOVE WINNER,HERE
	CALL GOTO,RM,0
	EQUAL? YEAR,YEAR-BUILT \?L23
	MOVE TIME-MACHINE,OLD-TECH-MUSEUM
	MOVE SPINNER,OLD-TECH-MUSEUM
	MOVE PRESSURIZER,OLD-TECH-MUSEUM
	MOVE TECH-PLAQUE,OLD-TECH-MUSEUM
	JUMP ?L29
?L23:	LESS? YEAR,YEAR-PRESENT \?L25
	ZERO? CLUMSY-ROBBERY \?L26
	MOVE TIME-MACHINE,MID-TECH-MUSEUM
?L26:	MOVE SPINNER,MID-TECH-MUSEUM
	MOVE PRESSURIZER,MID-TECH-MUSEUM
	MOVE TECH-PLAQUE,MID-TECH-MUSEUM
	MOVE CAGE,MID-JEWEL-ROOM
	JUMP ?L29
?L25:	MOVE TIME-MACHINE,TECH-MUSEUM
	MOVE SPINNER,TECH-MUSEUM
	MOVE PRESSURIZER,TECH-MUSEUM
	MOVE TECH-PLAQUE,TECH-MUSEUM
	MOVE CAGE,JEWEL-ROOM
?L29:	ZERO? CLUMSY-ROBBERY \?L32
	EQUAL? HERE,TECH-MUSEUM,MID-TECH-MUSEUM,OLD-TECH-MUSEUM /?L30
?L32:	ZERO? SNAP \?L38
	PRINTI "You notice that the golden machine has disappeared!"
	CRLF
	JUMP ?L38
?L30:	MOVE WINNER,TIME-MACHINE
?L38:	ZERO? CLUMSY-ROBBERY /TRUE
	REMOVE TIME-MACHINE
	RTRUE

	.FUNCT MOVE-TM-OBJECTS,F,MFLG=0,WFLG=0,N
	FIRST? TIME-MACHINE >F \?L5
?L4:	EQUAL? F,TM-DIAL,TM-SEAT,TM-BUTTON /?L9
	EQUAL? F,PLAYER /?L9
	ZERO? MFLG \?L9
	SET 'MFLG,1
	PRINTI "You notice that everything in the machine is gone"
?L9:	NEXT? F >N /?L13
?L13:	EQUAL? F,TM-DIAL,TM-SEAT,TM-BUTTON /?L14
	MOVE F,HERE
?L14:	SET 'F,N
	ZERO? F \?L4
?L5:	FIRST? WINNER >F \?L25
?L24:	ZERO? WFLG \?L32
	SET 'WFLG,1
	ZERO? MFLG /?L28
	PRINTI ": come to mention it, everything you were holding has vanished too"
	CALL PRINT-ID,STR?132
	JUMP ?L32
?L28:	PRINTI "You notice that everything you were holding is gone"
	CALL PRINT-ID,STR?133
?L32:	NEXT? F >N /?L36
?L36:	MOVE F,HERE
	SET 'F,N
	ZERO? F \?L24
?L25:	ZERO? MFLG \?L43
	ZERO? WFLG /FALSE
?L43:	PRINTR "!"

	.FUNCT GUARDS-KILL
	CALL PICK-ONE,GUARD-KILLERS >STACK
	PRINT STACK
	CRLF
	CALL PRINT-ID,STR?134
	CALL REALLY-DEAD,STR?135 >STACK
	RSTACK

	.FUNCT FLATHEAD-SENTENCE
	CALL PRINT-ID,STR?136
	CALL REALLY-DEAD,STR?137 >STACK
	RSTACK

	.FUNCT REALLY-DEAD,STR
	PRINT STR
	PRINTI "

****  You have died  ****

"
	CALL FINISH >STACK
	RSTACK

	.FUNCT HEAR-FLATHEAD
	SET 'FLATHEAD-HEARD,1
	PRINTR "One particularly loud and grating voice can be heard above the others outside the room. ""Very nice! Very nice! Not enough security, but very nice! Now, Lord Feepness, pay attention! I've been thinking that what we need is a dam, a tremendous dam to control the Frigid River, with thousands of gates. We shall call it ... Flood Control Dam #2. No, not quite right. Aha! Flood Control Dam #3."" ""Pardon me, my Lord, but wouldn't that be just a tad excessive?"" ""Nonsense! Now, let me tell you my idea for hollowing out volcanoes..."" With that, the voices trail out nothingness."

	.FUNCT OLD-TECH-MUSEUM-F,RARG
	EQUAL? RARG,M-LOOK \?L25
	EQUAL? HERE,OLD-JEWEL-ROOM \?L1
	PRINTI "You are in a high-ceilinged chamber, in the center of which is a pedestal which "
	ZERO? RING-STOLEN \?L5
	PRINTI "is the intended home of the Crown Jewels of the Great Underground Empire: a jewelled knife, a golden ring, and the royal sceptre."
	IN? SCEPTRE,PEDESTAL \?L11
	IN? RING,PEDESTAL \?L11
	IN? JEWELLED-KNIFE,PEDESTAL /?L15
?L11:	PRINTI " Not all of the jewels are in place, however."
	JUMP ?L15
?L5:	PRINTI "is bare."
?L15:	PRINTI " The room is, by appearances, unfinished."
	CRLF
	ZERO? GUARDS-PRESENT /TRUE
	PRINT HEAR-VOICES
	CRLF
	RTRUE
?L1:	EQUAL? RARG,M-LOOK \?L25
	EQUAL? HERE,OLD-TECH-MUSEUM \?L26
	PRINTI "You are in a large, unfinished room, probably intended to be a part of the Royal Museum."
	CRLF
	JUMP ?L30
?L26:	PRINTI "This appears to be an unfinished entranceway to the Royal Museum. There are doors to the east and north, and a blind stairway to the south. A heavy iron door to the west is closed and locked."
	CRLF
?L30:	ZERO? GUARDS-PRESENT /TRUE
	PRINT HEAR-VOICES
	CRLF
	RTRUE
?L25:	EQUAL? RARG,M-END \?L38
	ZERO? FLATHEAD-HEARD \?L38
	ZERO? GUARDS-PRESENT /?L38
	RANDOM 100 >STACK
	GRTR? 6,STACK \?L38
	CALL HEAR-FLATHEAD >STACK
	RSTACK
?L38:	EQUAL? RARG,M-ENTER \?L39
	ZERO? GUARDS-PRESENT /?L39
	RANDOM 12 >STACK
	ADD 3,STACK >STACK
	CALL QUEUE,I-GUARDS-LEAVE,STACK >STACK
	PUT STACK,0,1
	RTRUE
?L39:	EQUAL? RARG,M-BEG \FALSE
	EQUAL? PRSA,V?OPEN \?L40
	EQUAL? PRSO,WOODEN-DOOR,JEWEL-DOOR \?L40
	ZERO? GUARDS-PRESENT /?L40
	PRINTI "You open the door ever so slightly and see dozens of armed officials. You shut the door quickly, realizing that you would be killed in an instant if you left the room."
	CRLF
	CALL PRINT-ID,STR?138 >STACK
	RSTACK
?L40:	EQUAL? RARG,M-BEG \FALSE
	ZERO? GUARDS-PRESENT /FALSE
	RANDOM 100 >STACK
	GRTR? 3,STACK \FALSE
	CALL GUARD-CAUGHT >STACK
	RSTACK

	.FUNCT I-GUARDS-LEAVE
	SET 'GUARDS-PRESENT,0
	PRINTR "You hear, from outside the door, guards marching away, their voices fading. After a few moments, a booming crash signals the close of what must be a tremendous door. Then there is silence."

	.FUNCT GUARD-CAUGHT
	CALL PRINT-ID,STR?139
	CALL REALLY-DEAD,STR?140 >STACK
	RSTACK

	.FUNCT ROBOT-F
	EQUAL? PRSA,V?FOLLOW \?L1
	PRINTR "It moved quickly and left the door closed."
?L1:	PRINTR "There is no robot here."

	.FUNCT JEWEL-ROOM-F,RARG
	EQUAL? RARG,M-END \?L1
	IN? TIME-MACHINE,HERE \?L1
	RANDOM 100 >STACK
	GRTR? 4,STACK \?L1
	PRINTI "An odd robot-like device glides in, dusting the floor as it moves. Its head gyrates briefly as it scans the machine. ""Shame. Shame,"" it says, rather tinnily. ""Someone has been tampering with the machines again."" Six beady mechanical eyes focus on you as the robot picks up the gold machine. ""Hands off, adventurer!"" it says as it leaves the room, closing the door behind it."
	CRLF
	FCLEAR JEWEL-DOOR,OPENBIT
	FCLEAR WOODEN-DOOR,OPENBIT
	MOVE TIME-MACHINE,TECH-MUSEUM
	RTRUE
?L1:	EQUAL? RARG,M-LOOK \FALSE
	PRINTI "You are in a high-ceilinged chamber"
	FSET? CAGE,INVISIBLE /?L8
	PRINTR " in the middle of which sits a tall, round steel cage, which is securely locked. In the middle of the cage is a pedestal on which sit the Crown Jewels of the Great Underground Empire: a sceptre, a jewelled knife, and a golden ring. A small bronze plaque, now tarnished, is on the cage."
?L8:	PRINTR " in the middle of which is a bare pedestal. The room is unfinished with no indication of its purpose. A small plaque is fastened to a wall."

	.FUNCT CROWN-JEWELS-F
	EQUAL? PRSA,V?TAKE \?L1
	CALL HELD?,PRSO >STACK
	ZERO? STACK \FALSE
	EQUAL? YEAR,YEAR-BUILT /?L6
	FSET? CAGE,INVISIBLE \?L5
?L6:	FCLEAR PRSO,NDESCBIT
	RFALSE
?L5:	PRINTR "The jewels are inside a locked cage."
?L1:	EQUAL? PRSA,V?PUT \FALSE
	EQUAL? PRSI,PEDESTAL \?L10
	IN? PRSO,WINNER \?L10
	PRINTI "The "
	PRINTD PRSO
	PRINTI " is now resting on the pedestal."
	CRLF
	MOVE PRSO,PEDESTAL
	FSET PRSO,NDESCBIT
	RTRUE
?L10:	EQUAL? PRSA,V?PUT \FALSE
	CALL HELD?,PRSO >STACK
	ZERO? STACK \FALSE
	PRINTI "You don't have the "
	PRINTD PRSO
	PRINTR "."

	.FUNCT TECH-MUSEUM-F,RARG
	EQUAL? RARG,M-LOOK \FALSE
	FSET? CAGE,INVISIBLE \?L3
	CALL DDESC,STR?142,WOODEN-DOOR,STR?141 >STACK
	RSTACK
?L3:	CALL DDESC,STR?143,WOODEN-DOOR,STR?141 >STACK
	RSTACK

	.FUNCT PLAQUE-F
	EQUAL? PRSA,V?READ,V?EXAMINE \FALSE
	ZERO? RING-STOLEN /?L3
	PRINTR "The plaque explains that this room was to be the home of the Crown Jewels of the Empire. However, following the unexplained disappearance of a priceless ring during the final stages of construction, Lord Flathead decided to place the remaining jewels in a safer location. Interestingly, he placed his most prized possession, an incredibly gaudy crown, in a locked safe in a volcano specifically hollowed out for that purpose."
?L3:	CALL FIXED-FONT-ON
	PRINTI "
         Crown Jewels

  Presented To The Royal Museum
      By His Gracious Lord

        DIMWIT FLATHEAD

          Dedicated
         * 777 GUE *"
	CALL FIXED-FONT-OFF
	ZERO? CLUMSY-ROBBERY /?L10
	CRLF
	CRLF
	PRINTR "Underneath the plaque, in small lettering, is a description of a clumsy attempt to steal the jewels using a time machine from the Technological Museum which the curators were surprised to discover was not a nonworking model. After the attempt, the machine was removed from the exhibit."
?L10:	ZERO? MYSTERY /?L14
	CRLF
	CRLF
	PRINTI "Underneath the plaque, in small lettering, is a description of a mysterious happening during the final stages of construction of the Museum, in which some of the crown jewels were found displaced from their proper positions. Fortunately, nothing was missing. The mystery was never solved and the museum was opened despite the objections of Lord Flathead that security was too lax."
?L14:	CRLF
	RTRUE

	.FUNCT WOODEN-DOOR-F
	EQUAL? PRSA,V?LISTEN \?L1
	ZERO? GUARDS-PRESENT /?L1
	CALL PERFORM,V?LISTEN,VOICES
	RTRUE
?L1:	EQUAL? PRSA,V?KNOCK \FALSE
	ZERO? GUARDS-PRESENT /FALSE
	PRINTI "You realize that calling attention to yourself would be fatal."
	CRLF
	CALL PRINT-ID,STR?144 >STACK
	RSTACK

	.FUNCT JEWEL-DOOR-F
	EQUAL? PRSA,V?KNOCK \?L1
	ZERO? GUARDS-PRESENT /?L1
	CALL PERFORM,V?KNOCK,WOODEN-DOOR
	RTRUE
?L1:	EQUAL? PRSA,V?UNLOCK,V?OPEN \FALSE
	FSET? JEWEL-DOOR,OPENBIT \?L4
	PRINTR "It is already open."
?L4:	EQUAL? YEAR,YEAR-BUILT \?L8
	EQUAL? HERE,OLD-MUSEUM-ENTRANCE \?L8
	PRINTR "The door is locked, probably by the guards on their way out."
?L8:	PRINTI "The door is now open."
	CRLF
	FSET JEWEL-DOOR,OPENBIT
	RTRUE

	.FUNCT CAGE-F
	EQUAL? PRSA,V?OPEN \?L1
	PRINTR "The cage is locked."
?L1:	EQUAL? PRSA,V?CLOSE \FALSE
	PRINTR "The cage is already closed."

	.FUNCT VOICES-F
	ZERO? GUARDS-PRESENT /?L1
	EQUAL? YEAR,YEAR-BUILT \?L1
	PRINTI "The voices are muffled by the door which (fortunately for you) separates you. They seem to be in heated debate on the topic of "
	CALL PRINT-ID,STR?145
	CALL PICK-ONE,BLATHER >STACK
	PRINT STACK
	PRINTR "."
?L1:	PRINTR "Are you hearing things now?"

	.FUNCT MUSEUM-PIECES,RARG=0
	EQUAL? RARG,M-OBJDESC \?L1
	EQUAL? DESC-OBJECT,SPINNER /TRUE
	PRINTI "A strange grey machine, shaped somewhat like a clothes dryer, is on one side of the room. On the other side of the hall is a powerful-looking black machine, a tight tangle of wires, pipes, and motors.
A plaque is mounted near the door."
	LESS? YEAR,YEAR-CLOSED \?L8
	PRINTR " The grey machine, it turns out, is a Frobozz Magic Pressurizer, used in the coal mines of the Empire. The black machine is a Frobozz Magic Room Spinner. The golden machine is referred to as a Temporizer. All are nonworking models donated by Frobozzco president John D. Flathead."
?L8:	PRINTR " The writing is faded, however, and cannot be made out clearly. The two machines seem to be in bad shape, rusting in many spots."
?L1:	EQUAL? PRSA,V?MOVE,V?TAKE \?L15
	PRINTR "It's massive and cannot even be moved."
?L15:	EQUAL? PRSA,V?PUSH-TO,V?PUSH \?L18
	PRINTR "It's too heavy to be pushed."
?L18:	EQUAL? PRSA,V?MUNG \?L21
	PRINTI "It seems quite indestructible."
	CRLF
	CALL PRINT-ID,STR?146 >STACK
	RSTACK
?L21:	EQUAL? PRSA,V?PUT \FALSE
	EQUAL? PRSI,SPINNER,PRESSURIZER \FALSE
	PRINTR "There's no good place to put anything there."

	.FUNCT TECH-PLAQUE-F
	EQUAL? PRSA,V?TAKE \?L1
	PRINTR "It's bolted to the wall."
?L1:	EQUAL? PRSA,V?READ,V?EXAMINE \FALSE
	LESS? YEAR,YEAR-CLOSED \?L6
	PRINTR "The plaque merely identifies the machines and names their donor. They are nonworking models of existing state-of-the-art machinery."
?L6:	PRINTR "The words cannot be made out."

	.FUNCT PEDESTAL-F
	EQUAL? PRSA,V?LOOK-ON,V?EXAMINE \?L1
	FIRST? PEDESTAL >STACK \FALSE
	PRINTR "The Royal Jewels are on the pedestal."
?L1:	EQUAL? PRSA,V?TAKE,V?PUT-ON,V?PUT \FALSE
	FSET? CAGE,INVISIBLE /FALSE
	PRINTR "You can't reach it through the cage."

	.FUNCT PICK-DIRECTION,RM,NXT=0,CNT=0,OFFS=0
?L1:	NEXTP RM,NXT >NXT
	ZERO? NXT /?L2
	LESS? NXT,P?CROSS /?L1
	EQUAL? NXT,P?UP,P?DOWN /?L1
	INC 'OFFS
	PUT DIR-TBL,OFFS,NXT
	INC 'CNT
	JUMP ?L1
?L2:	RANDOM CNT >STACK
	GET DIR-TBL,STACK >STACK
	RSTACK

	.FUNCT SHADOW-F,RARG=0
	EQUAL? RARG,M-OBJDESC \?L1
	ZERO? BLOCKED-DIR \?L3
	CALL PICK-DIRECTION,HERE >BLOCKED-DIR
?L3:	PRINTI "A cloaked and hooded person, carrying a sword not unlike your own,"
	GRTR? S-STRENGTH,3 \?L8
	PRINTI " is standing blocking the way to the "
	CALL LKP,BLOCKED-DIR,DIRS >STACK
	PRINT STACK
	PRINTI "."
	CRLF
	JUMP ?L14
?L8:	PRINTI " is here."
	CRLF
?L14:	PRINTI "The hooded figure"
	GET SHADOW-DIAG,S-STRENGTH >STACK
	PRINT STACK
	CRLF
	RTRUE
?L1:	EQUAL? PRSA,V?GIVE \?L19
	EQUAL? PRSI,SHADOW \?L19
	PRINTR "The hooded figure isn't interested in your gifts."
?L19:	CALL HELLO?,SHADOW >STACK
	ZERO? STACK /?L22
	PRINTR "The hooded figure does not respond to your words."
?L22:	EQUAL? PRSA,V?ATTACK \FALSE
	EQUAL? PRSI,SWORD \?L25
	ZERO? SHADOW-POINT-2 \?L26
	INC 'SCORE
	SET 'SHADOW-POINT-2,1
?L26:	CALL SHADOW-ATTACK >STACK
	RSTACK
?L25:	EQUAL? PRSA,V?ATTACK \FALSE
	PRINTI "The hooded figure ignores your feeble attack."
	CRLF
	CALL PRINT-ID,STR?147
	SET 'ATTACK-MODE,1
	CALL QUEUE,I-CURE,10 >STACK
	PUT STACK,0,1
	CALL QUEUE,I-SHADOW-REPLY,-1 >STACK
	PUT STACK,0,1
	RTRUE

	.FUNCT I-CURE
	EQUAL? P-STRENGTH,5 /?L1
	INC 'P-STRENGTH
?L1:	EQUAL? S-STRENGTH,5 /?L4
	INC 'S-STRENGTH
?L4:	ADD P-STRENGTH,S-STRENGTH >STACK
	EQUAL? STACK,10 /FALSE
	CALL QUEUE,I-CURE,10
	RFALSE

	.FUNCT SHADOW-ATTACK,?TMP
	ZERO? ATTACK-MODE \?L1
	CALL QUEUE,I-CURE,10 >STACK
	PUT STACK,0,1
	SET 'ATTACK-MODE,1
	CALL QUEUE,I-SHADOW-REPLY,-1 >STACK
	PUT STACK,0,1
?L1:	MUL P-STRENGTH,10 >STACK
	ADD STACK,10 >?TMP
	RANDOM 100 >STACK
	GRTR? ?TMP,STACK \?L4
	RANDOM 100 >STACK
	GRTR? 85,STACK \?L6
	DEC 'S-STRENGTH
	ZERO? S-STRENGTH \?L8
	CALL SHADOW-DIES
	RTRUE
?L8:	CALL PICK-ONE,P-HITS >STACK
	PRINT STACK
	CRLF
	PRINTI "The figure"
	GET SHADOW-DIAG,S-STRENGTH >STACK
	PRINT STACK
	CRLF
	RTRUE
?L6:	SUB S-STRENGTH,2 >S-STRENGTH
	ZERO? S-STRENGTH \?L16
	SET 'S-STRENGTH,1
	JUMP ?L18
?L16:	LESS? S-STRENGTH,1 \?L18
	CALL SHADOW-DIES
	RTRUE
?L18:	PRINTI "A sharp thrust and the hooded figure is badly wounded!"
	CRLF
	CALL PRINT-ID,STR?148
	PRINTI "The figure"
	GET SHADOW-DIAG,S-STRENGTH >STACK
	PRINT STACK
	CRLF
	RTRUE
?L4:	LESS? S-STRENGTH,2 \?L25
	PRINTI "Your opponent blocks your attack with its sword."
	CRLF
	CALL PRINT-ID,STR?149 >STACK
	RSTACK
?L25:	CALL PICK-ONE,P-MISSES >STACK
	PRINT STACK
	CRLF
	RTRUE

	.FUNCT I-SHADOW-REPLY,?TMP
	ZERO? ATTACK-MODE /?L3
	IN? SHADOW,HERE /?L1
?L3:	CALL QUEUE,I-SHADOW-REPLY,0
	SET 'ATTACK-MODE,0
	RFALSE
?L1:	IN? SWORD,WINNER /?L5
	MOVE SWORD,WINNER
	PRINTI "Your sword, glowing wildly, leaps into your hand!"
	CRLF
?L5:	MUL S-STRENGTH,10 >STACK
	ADD STACK,10 >?TMP
	RANDOM 100 >STACK
	GRTR? ?TMP,STACK \?L10
	GRTR? S-STRENGTH,1 \?L10
	RANDOM 100 >STACK
	GRTR? 90,STACK \?L12
	DLESS? 'P-STRENGTH,1 \?L14
	SET 'P-STRENGTH,1
	PRINTR "The hooded figure swings its sword and sends yours flying to the ground. Although you are defenseless, the figure reaches for your sword and hands it back to you, nodding grimly."
?L14:	CALL PICK-ONE,S-HITS >STACK
	PRINT STACK
	CRLF
	RTRUE
?L12:	SUB P-STRENGTH,2 >P-STRENGTH
	LESS? P-STRENGTH,1 \?L22
	CALL PRINT-ID,STR?150
	CALL JIGS-UP,STR?151 >STACK
	RSTACK
?L22:	PRINTI "A brilliant feint puts you off guard, and the hooded figure slips its sword between your ribs. You are hurt very badly."
	CRLF
	CALL PRINT-ID,STR?152 >STACK
	RSTACK
?L10:	LESS? S-STRENGTH,3 \?L27
	PRINTR "The hooded figure attempts a thrust, but its weakened state prevents hitting you."
?L27:	CALL PICK-ONE,S-MISSES >STACK
	PRINT STACK
	CRLF
	RTRUE

	.FUNCT SHADOW-DIES
	PRINTI "The hooded figure, fatally wounded, slumps to the ground. It gazes up at you once, and you catch a brief glimpse of deep and sorrowful eyes. Before you can react, the figure vanishes in a cloud of fetid vapor."
	CRLF
	REMOVE SHADOW
	SET 'SHADOW-GONE,1
	SET 'BLOCKED-DIR,0
	RETURN BLOCKED-DIR

	.FUNCT HOOD-F
	EQUAL? PRSA,V?LOOK-UNDER \?L1
	IN? HOOD,SHADOW \?L1
	PRINTR "The figure's hood casts a dark shadow over its face. There is no way from where you stand to look beneath it."
?L1:	EQUAL? PRSA,V?PUT,V?TAKE \FALSE
	IN? HOOD,SHADOW \FALSE
	EQUAL? S-STRENGTH,1 \?L6
	PRINTI "You slowly remove the hood from your badly wounded opponent and recoil in horror at the sight of your own face, weary and wounded. A faint smile comes to the lips and then the face starts to change, very slowly, into that of an old, wizened person. The image fades and with it the body of your hooded opponent. The cloak remains on the ground."
	CRLF
	REMOVE SHADOW
	SET 'SHADOW-GONE,1
	MOVE HOOD,WINNER
	FCLEAR HOOD,NDESCBIT
	MOVE CLOAK,HERE
	FCLEAR CLOAK,NDESCBIT
	RTRUE
?L6:	EQUAL? S-STRENGTH,2 \?L10
	PRINTR "The hooded figure, though recovering from wounds, is strong enough to force you back."
?L10:	PRINTI "You cannot get close enough to the hooded figure to remove the hood."
	CRLF
	CALL PRINT-ID,STR?153 >STACK
	RSTACK

	.FUNCT CLOAK-F
	EQUAL? PRSA,V?LOOK-UNDER \?L1
	IN? CLOAK,SHADOW \?L1
	PRINTR "You cannot get close enough to look underneath the cloak."
?L1:	EQUAL? PRSA,V?TAKE \FALSE
	IN? CLOAK,SHADOW \FALSE
	PRINTR "The cloak is fastened around the neck of the hooded figure. It would be difficult to remove."

	.FUNCT SHADOW-ROOMS,RARG
	EQUAL? RARG,M-BEG \?L1
	EQUAL? PRSA,V?WALK \?L1
	EQUAL? PRSO,BLOCKED-DIR \?L1
	PRINTR "Your way is blocked by the hooded figure."
?L1:	EQUAL? RARG,M-END \FALSE
	IN? SHADOW,HERE /?L6
	SET 'BLOCKED-DIR,0
	REMOVE SHADOW
?L6:	ZERO? SHADOW-GONE \FALSE
	IN? SHADOW,HERE \?L11
	RANDOM 100 >STACK
	GRTR? 30,STACK \FALSE
	ZERO? ATTACK-MODE \FALSE
	SET 'ATTACK-MODE,1
	CALL QUEUE,I-CURE,10 >STACK
	PUT STACK,0,1
	CALL QUEUE,I-SHADOW-REPLY,-1 >STACK
	PUT STACK,0,1
	RTRUE
?L11:	RANDOM 100 >STACK
	GRTR? 30,STACK \?L15
	PRINTR "You can hear quiet footsteps nearby."
?L15:	RANDOM 100 >STACK
	GRTR? 30,STACK \FALSE
	ZERO? LIT /FALSE
	GRTR? S-STRENGTH,3 \FALSE
	CALL PICK-DIRECTION,HERE >BLOCKED-DIR
	PRINTI "Through the shadows, a cloaked and hooded figure appears before you, blocking the "
	CALL LKP,BLOCKED-DIR,DIRS >STACK
	PRINT STACK
	PRINTI "ern exit from the room and carrying a brightly glowing sword."
	CRLF
	CALL SHADOW-ARRIVAL
	RTRUE

	.FUNCT SHADOW-ARRIVAL
	MOVE SHADOW,HERE
	ZERO? SHADOW-POINT-1 \?L1
	INC 'SCORE
	SET 'SHADOW-POINT-1,1
?L1:	IN? SWORD,WINNER /FALSE
	MOVE SWORD,WINNER
	ZERO? SWORD-IN-STONE? /?L6
	PRINTI "From nowhere, the sword from the junction appears in your hand, wildly glowing!"
	CRLF
	JUMP ?L10
?L6:	PRINTI "Your sword, glowing wildly, appears in your hand!"
	CRLF
?L10:	SET 'SWORD-IN-STONE?,0
	RETURN SWORD-IN-STONE?

	.FUNCT CREEPY-CRAWL-F,RARG
	EQUAL? RARG,M-END \FALSE
	SET 'BLOCKED-DIR,0
	RTRUE

	.FUNCT LEDGE-F
	EQUAL? HERE,CLIFF-LEDGE \FALSE
	EQUAL? PRSA,V?THROW-OFF \FALSE
	EQUAL? PRSI,LEDGE \FALSE
	IN? PRSO,WINNER /?L3
	PRINTR "You're not holding that!"
?L3:	MOVE PRSO,CLIFF-BASE
	PRINTI "The "
	PRINTD PRSO
	PRINTI " falls to the base of the cliff below."
	CRLF
	CALL PRINT-ID,STR?154 >STACK
	RSTACK

	.FUNCT WAYBREAD-F
	EQUAL? PRSA,V?CUT \FALSE
	EQUAL? PRSI,SWORD \FALSE
	PRINTI "The bread is crushed rather than cut by your sword, and the crumbs scatter to the wind."
	CRLF
	REMOVE WAYBREAD
	RTRUE

	.FUNCT STAFF-F
	EQUAL? PRSA,V?BURN \FALSE
	EQUAL? PRSI,TORCH \FALSE
	REMOVE PRSO
	CALL PRINT-ID,STR?155
	CALL JIGS-UP,STR?156 >STACK
	RSTACK

	.FUNCT I-MAN-APPEARS
	EQUAL? HERE,CLIFF-LEDGE \FALSE
	LOC CHEST >STACK
	EQUAL? STACK,CLIFF-LEDGE,WINNER \FALSE
	ZERO? CHEST-TIED /?L4
	SET 'MAN-SEEN,1
	PRINTI "All at once, the chest is lifted from you. Looking up, you see a man at the top of the cliff, pulling intently at the rope. ""That is uncommonly good of you, I do say!"" He chuckles unpleasantly. ""Oh, you are stuck, aren't you. Well, I'll be right back to get you!"" He leaves your sight."
	CRLF
	CALL PRINT-ID,STR?157
	SET 'CHEST-LIFTED,1
	MOVE CHEST,MAN
	FSET CHEST,TOUCHBIT
	SET 'ROPE-FLAG,0
	SET 'CHEST-TIED,0
	CALL QUEUE,I-MAN-RETURNS,10 >STACK
	PUT STACK,0,1
	RTRUE
?L4:	PRINTI "At the edge of the cliff above you, a man appears. He looks down at you and speaks. ""Hello, down there! You seem to have a problem. Maybe I can help you."" He chuckles in an unsettling sort of way. ""Perhaps if you tied that chest to the end of the rope I might be able to drag it up for you. Then, I'll be more than happy to help you up!"" He laughs again."
	CRLF
	SET 'MAN-FLAG,1
	SET 'MAN-SEEN,1
	CALL QUEUE,I-MAN-PRESENT,-1 >STACK
	PUT STACK,0,1
	RTRUE

	.FUNCT I-MAN-PRESENT
	EQUAL? HERE,CLIFF-LEDGE \?L3
	ZERO? MAN-FLAG /?L3
	IN? CHEST,MAN \?L1
?L3:	CALL QUEUE,I-MAN-PRESENT,0
	SET 'MAN-FLAG,0
	RFALSE
?L1:	IGRTR? 'MAN-WAITING,10 \?L4
	PRINTI "The man looks quite displeased. ""All right, then. I guess someone else can always help me! See you around, sport!"" He disappears."
	CRLF
	CALL PRINT-ID,STR?158
	CALL QUEUE,I-MAN-PRESENT,0
	SET 'MAN-FLAG,0
	RTRUE
?L4:	CALL PICK-ONE,MAN-WAITS >STACK
	PRINT STACK
	CRLF
	RTRUE

	.FUNCT CLIFF-BASE-F,RARG
	EQUAL? RARG,M-ENTER \FALSE
	ZERO? CHEST-TIED /FALSE
	SET 'CHEST-TIED,0
	SET 'ROPE-FLAG,0
	CALL QUEUE,I-MAN-APPEARS,0 >STACK
	RSTACK

	.FUNCT CLIFF-LEDGE-F,RARG
	EQUAL? RARG,M-BEG \?L1
	EQUAL? PRSA,V?WALK \?L1
	IN? CHEST,WINNER \?L1
	ZERO? CHEST-TIED /?L1
	PRINTR "You can't go anywhere holding that chest. The rope is tied around it!"
?L1:	EQUAL? RARG,M-ENTER \?L5
	ZERO? MAN-SEEN \?L5
	ZERO? MAN-FLAG \?L5
	ZERO? MAN-GONE \?L5
	ZERO? MAN-POINT \?L6
	INC 'SCORE
	SET 'MAN-POINT,1
?L6:	CALL QUEUE,I-MAN-APPEARS,5 >STACK
	PUT STACK,0,1
	RTRUE
?L5:	EQUAL? RARG,M-LOOK \FALSE
	PRINTI "This is a rock-strewn ledge near the base of a tall cliff. The bottom of the cliff is another fifteen feet below. You have little hope of climbing up the cliff face, but you might be able to scramble down from here (though it's doubtful you could return)."
	CRLF
	ZERO? ROPE-FLAG /TRUE
	PRINTR "A long piece of rope is dangling down from the top of the cliff and is within your reach."

	.FUNCT CLIFF-F,RARG
	EQUAL? RARG,M-ENTER \?L1
	IN? CHEST,MAN \?L1
	CALL QUEUE,I-MAN-RETURNS,0
	MOVE CHEST,HERE
	FSET CHEST,OPENBIT
	SET 'ROPE-FLAG,1
	SET 'CHEST-TIED,0
	SET 'CHEST-OPENED,1
	RFALSE
?L1:	EQUAL? RARG,M-LOOK \?L3
	PRINTI "This is a remarkable spot in the dungeon. Perhaps two hundred feet above you is a gaping hole in the earth's surface through which pours bright sunshine! A few seedlings from the world above, nurtured by the sunlight and occasional rains, have grown into giant trees, making this a virtual oasis in the desert of the Underground Empire. To the west is a sheer precipice, dropping nearly fifty feet to jagged rocks below. The way south is barred by a forbidding stone wall, crumbling from age. There is a jagged opening in the wall to the southwest, through which leaks a fine mist. The land to the east looks lifeless and barren."
	CRLF
	ZERO? ROPE-FLAG /TRUE
	PRINTR "A rope is tied to one of the large trees here and is dangling over the side of the cliff, reaching down to the shelf below."
?L3:	EQUAL? RARG,M-END \FALSE
	RANDOM 100 >STACK
	GRTR? 15,STACK \?L11
	FSET? CLIFF-LEDGE,TOUCHBIT /?L11
	PRINTR "You catch, out of the corner of your eye, some movement among the trees."
?L11:	EQUAL? RARG,M-END \FALSE
	RANDOM 100 >STACK
	GRTR? 20,STACK \FALSE
	PRINTR "You seem to hear, from the southwest, the sounds of the sea."

	.FUNCT GLOBAL-ROPE-F
	ZERO? ROPE-FLAG \?L1
	PRINTR "You can't see any rope here."
?L1:	EQUAL? PRSA,V?CLIMB-FOO \?L5
	CALL V-CLIMB-UP,P?DOWN,1 >STACK
	RSTACK
?L5:	EQUAL? PRSA,V?CLIMB-ON,V?MOVE,V?TAKE \?L6
	ZERO? MAN-FLAG \?L7
	PRINTR "A short tug on the rope convinces you that it is securely fastened from above."
?L7:	IN? CHEST,MAN \?L11
	SET 'HOLDING-ROPE,1
	PRINTR "You grab securely on to the rope."
?L11:	PRINTI "The man scowls. ""I may help you up, but not before I have that chest."" He points to the chest near you on the ledge."
	CRLF
	CALL PRINT-ID,STR?159 >STACK
	RSTACK
?L6:	EQUAL? PRSA,V?CLIMB-UP \?L17
	PRINTR "You try to climb the rope, but you cannot reach the top even with your best effort."
?L17:	EQUAL? PRSA,V?TIE \?L20
	EQUAL? CHEST,PRSO,PRSI \?L21
	PRINTI "The chest is now tied to the rope."
	CRLF
	SET 'CHEST-TIED,1
	ZERO? MAN-FLAG /TRUE
	ZERO? MAN-GONE \TRUE
	PRINTI "The man above you looks pleased. ""Now there's a good friend! Thank you very much, indeed!"" He pulls on the rope and the chest is lifted to the top of the cliff and out of sight. With a short laugh, he disappears. ""I'll be back in a short while!"" are his last words."
	CRLF
	MOVE CHEST,MAN
	FSET CHEST,TOUCHBIT
	SET 'CHEST-TIED,0
	SET 'ROPE-FLAG,0
	CALL QUEUE,I-MAN-RETURNS,10 >STACK
	PUT STACK,0,1
	SET 'MAN-FLAG,0
	RTRUE
?L21:	EQUAL? ME,PRSI,PRSO \?L30
	ZERO? MAN-FLAG /?L35
	IN? CHEST,MAN \?L31
	PRINTR """Just grab onto it!"", the man bellows."
?L31:	ZERO? MAN-FLAG /?L35
	PRINTI "The man looks cross. ""I want the chest, not you!"" he snaps. ""Now stop fooling around and pass it up!"""
	CRLF
	CALL PRINT-ID,STR?160 >STACK
	RSTACK
?L35:	PRINTR "You're unable to tie the rope around yourself."
?L30:	PRINTR "You're unable to tie the rope to that."
?L20:	EQUAL? PRSA,V?UNTIE \FALSE
	ZERO? CHEST-TIED /?L45
	SET 'CHEST-TIED,0
	PRINTR "The chest is now disconnected from the rope."
?L45:	PRINTR "The rope isn't tied to anything."

	.FUNCT I-MAN-RETURNS
	SET 'ROPE-FLAG,1
	EQUAL? HERE,CLIFF-LEDGE \FALSE
	PRINTI "A familiar voice calls down to you. ""Are you still there?"" he bellows with a coarse laugh. ""Well, then, grab onto the rope and we'll see what we can do."" The rope drops to within your reach."
	CRLF
	SET 'MAN-FLAG,1
	CALL QUEUE,I-MAN-LIFT,-1 >STACK
	PUT STACK,0,1
	RTRUE

	.FUNCT I-MAN-LIFT
	EQUAL? HERE,CLIFF-LEDGE /?L1
	CALL QUEUE,I-MAN-LIFT,0
	MOVE CHEST,CLIFF
	FSET CHEST,OPENBIT
	SET 'CHEST-OPENED,1
	REMOVE MAN
	RFALSE
?L1:	ZERO? HOLDING-ROPE /?L3
	PRINTI "The man starts to heave on the rope and within a few moments you arrive at the top of the cliff. The man removes the last few valuables from the chest and prepares to leave. ""You've been a good sport! Here, take this, for whatever good it is! I can't see that I'll be needing one!"" He hands you a plain wooden staff from the bottom of the chest and begins examining his valuables."
	CRLF
	CALL QUEUE,I-MAN-LIFT,0
	MOVE STAFF,WINNER
	SET 'HOLDING-ROPE,0
	SET 'ROPE-FLAG,1
	MOVE WINNER,CLIFF
	MOVE CHEST,CLIFF
	FSET CHEST,OPENBIT
	PRINTI "The chest, open and empty, is at your feet."
	CRLF
	SET 'CHEST-OPENED,1
	MOVE MAN,CLIFF
	CALL QUEUE,I-MAN-LEAVES,-1 >STACK
	PUT STACK,0,1
	RTRUE
?L3:	IGRTR? 'LIFT-WAIT,4 \?L8
	PRINTI """Well, I don't have all day. See you around sometime."" Showering you with gravel, he disappears from sight."
	CRLF
	CALL PRINT-ID,STR?161
	SET 'MAN-FLAG,0
	MOVE CHEST,CLIFF
	FSET CHEST,OPENBIT
	SET 'CHEST-OPENED,1
	CALL QUEUE,I-MAN-LIFT,0 >STACK
	RSTACK
?L8:	PRINTI "The man appears impatient. ""Are you coming up then, or not?"""
	CRLF
	CALL PRINT-ID,STR?162 >STACK
	RSTACK

	.FUNCT CHEST-F
	ZERO? CHEST-OPENED /?L1
	EQUAL? PRSA,V?TIE \?L3
	EQUAL? ROPE,PRSO,PRSI \?L3
	PRINTR "What's the point?"
?L3:	EQUAL? PRSA,V?PUT \FALSE
	EQUAL? PRSO,STAFF,LAMP,TORCH \FALSE
	PRINTI "It doesn't fit."
	EQUAL? PRSO,STAFF \?L10
	PRINTI " Awfully peculiar, though, since it's where the staff came from."
?L10:	CRLF
	RTRUE
?L1:	EQUAL? PRSA,V?UNLOCK,V?OPEN \FALSE
	ZERO? MAN-FLAG /?L17
	PRINTR "The man calls down to you. ""Is this what you're looking for?"" he cackles, waving a small key over his head. You try to open the chest, but it is locked."
?L17:	PRINTR "The chest is locked and cannot be opened."

	.FUNCT I-MAN-LEAVES
	EQUAL? HERE,CLIFF /?L1
	REMOVE MAN
	SET 'MAN-GONE,1
	SET 'MAN-FLAG,0
	SET 'ROPE-FLAG,1
	CALL QUEUE,I-MAN-LEAVES,0
	RFALSE
?L1:	RANDOM 100 >STACK
	GRTR? 40,STACK \?L3
	PRINTI "Your ""friend"", moving quickly, dodges behind some trees and is lost from sight."
	CRLF
	REMOVE MAN
	SET 'MAN-FLAG,0
	SET 'MAN-GONE,1
	SET 'ROPE-FLAG,1
	CALL QUEUE,I-MAN-LEAVES,0
	RTRUE
?L3:	PRINTR "Your ""friend"" examines his valuables with great pride."

	.FUNCT MAN-F
	EQUAL? PRSA,V?HELLO \?L1
	PRINTR "He responds cheerfully. ""It is a wonderful day, isn't it?"""
?L1:	CALL HELLO?,MAN >STACK
	ZERO? STACK /?L5
	PRINTR "The man is thoroughly engrossed in the examination of his booty and doesn't seem to hear you."
?L5:	EQUAL? PRSA,V?EXAMINE \?L8
	PRINTR "The man is stocky and of medium height, with several days' growth of stubble on his face. He is carrying a number of valuables under his arm, presumably from the now-open chest."
?L8:	EQUAL? PRSA,V?ATTACK \FALSE
	EQUAL? PRSI,SWORD \?L12
	PRINTI "The man is taken by surprise and is hit with the sword. He grabs you and throws you to the ground"
	LOC STAFF >STACK
	EQUAL? STACK,WINNER,HERE \?L16
	PRINTI ", breaking the staff in the process"
	REMOVE STAFF
	MOVE BROKEN-STAFF,HERE
?L16:	PRINTI ", but you finish him off with a quick thrust to the chest. He dies, and disappears without ceremony in the usual style of the Great Underground Empire. His assorted valuables remain behind."
	CRLF
	CALL PRINT-ID,STR?163
	REMOVE MAN
	MOVE VALUABLES,HERE
	FCLEAR VALUABLES,NDESCBIT
	CALL QUEUE,I-MAN-LEAVES,0
	SET 'MAN-GONE,1
	RETURN MAN-GONE
?L12:	PRINTI "You wouldn't hurt him with that!"
	CRLF
	CALL PRINT-ID,STR?164 >STACK
	RSTACK

	.FUNCT VALUABLES-F
	EQUAL? PRSA,V?MOVE,V?PUT,V?TAKE \?L1
	IN? MAN,CLIFF \?L1
	PRINTI "The man recoils sharply. ""These here things are mine. It's my chest and they're my valuables. You've a lot of nerve trying to take them from me after me saving you like that!"""
	CRLF
	CALL PRINT-ID,STR?165 >STACK
	RSTACK
?L1:	ZERO? MAN-GONE /FALSE
	IN? VALUABLES,MAN \FALSE
	PRINTR "What valuables?"

	.FUNCT ROPE-F
	EQUAL? PRSA,V?MOVE,V?TAKE \?L1
	ZERO? ROPE-FLAG /FALSE
	PRINTR "The rope is tied to a tree."
?L1:	EQUAL? PRSA,V?CLIMB-FOO \?L8
	CALL V-CLIMB-UP,P?DOWN,1 >STACK
	RSTACK
?L8:	EQUAL? PRSA,V?BURN \?L9
	PRINTI "The rope won't catch fire."
	CRLF
	CALL PRINT-ID,STR?166 >STACK
	RSTACK
?L9:	EQUAL? PRSA,V?UNTIE \?L12
	PRINTR "The rope is very securely tied and cannot be undone."
?L12:	EQUAL? PRSA,V?CUT \FALSE
	EQUAL? PRSI,SWORD \FALSE
	PRINTI "The rope is made of pretty tough stuff and won't cut."
	CRLF
	CALL PRINT-ID,STR?167 >STACK
	RSTACK

	.FUNCT GLOBAL-MAN-F
	EQUAL? HERE,CLIFF \?L1
	ZERO? MAN-GONE /?L3
	PRINTR "You've lost him among the trees."
?L3:	PRINTR "You can't see any man here."
?L1:	ZERO? MAN-FLAG \?L10
	PRINTR "You can't see any man here."
?L10:	EQUAL? PRSA,V?GIVE \?L13
	PRINTR "You aren't even close to him!"
?L13:	EQUAL? PRSA,V?HELLO \?L16
	PRINTR "The man waves back in a friendly way."
?L16:	CALL HELLO?,GLOBAL-MAN >STACK
	ZERO? STACK /?L19
	PRINTI "He yells back, ""What's that you say? I can't hear you very well."
	ZERO? CHEST-LIFTED \?L22
	PRINTR " Just tie the rope to the chest and we can chat afterwards!"" He smiles broadly."
?L22:	PRINTR """"
?L19:	EQUAL? PRSA,V?MUNG,V?ATTACK \?L29
	PRINTI "It's unlikely you'll succeed at this distance."
	CRLF
	CALL PRINT-ID,STR?168 >STACK
	RSTACK
?L29:	EQUAL? PRSA,V?THROW \FALSE
	EQUAL? PRSI,GLOBAL-MAN \FALSE
	IN? PRSO,WINNER \FALSE
	PRINTI "The "
	PRINTD PRSO
	PRINTI " flies upward, but not nearly far enough to hit the man. It does seem to amuse him, however, especially as it passes within inches of your head. ""We're wasting time now. Be a good fellow and tie the rope!"""
	CRLF
	CALL PRINT-ID,STR?169
	MOVE PRSO,HERE
	RTRUE

	.FUNCT LAKE-F
	EQUAL? PRSA,V?BOARD,V?LEAP,V?THROUGH \?L1
	EQUAL? HERE,LAKE-SHORE,FAR-SHORE,SOUTH-SHORE \?L3
	CALL GO-ON-LAKE >STACK
	RSTACK
?L3:	EQUAL? HERE,ON-LAKE \?L5
	CALL GOTO,IN-LAKE >STACK
	RSTACK
?L5:	PRINTR "Just where do you think you are?"
?L1:	EQUAL? PRSA,V?LOOK-UNDER \FALSE
	EQUAL? HERE,ON-LAKE \?L10
	PRINTR "You can't quite make out the bottom of the lake from here..."
?L10:	PRINTR "You can't see under the surface from here."

	.FUNCT IN-LAKE-F,RARG
	EQUAL? RARG,M-ENTER \?L1
	CALL QUEUE,I-IN-LAKE,3 >STACK
	PUT STACK,0,1
	RTRUE
?L1:	EQUAL? RARG,M-BEG \?L3
	EQUAL? PRSA,V?TAKE \?L3
	EQUAL? PRSO,SHINY-OBJECT /?L3
	CALL WEIGHT,WINNER >STACK
	GRTR? STACK,25 \?L4
	PRINTR "You can't carry that much underwater."
?L4:	FSET? PRSO,TAKEBIT /?L8
	PRINTR "You can't take that!"
?L8:	RANDOM 100 >STACK
	GRTR? 30,STACK \FALSE
	PRINTI "The "
	PRINTD PRSO
	PRINTR " is yours for a moment, but drops from your grasp."
?L3:	EQUAL? RARG,M-END \FALSE
	RANDOM 100 >STACK
	GRTR? 10,STACK \?L16
	PRINTR "A large and hungry-looking fish is swimming in the neighborhood."
?L16:	RANDOM 100 >STACK
	GRTR? 4,STACK \?L20
	ZERO? INVIS \?L20
	CALL QUEUE,I-ROC,0
	CALL QUEUE,I-ON-LAKE,0
	CALL PRINT-ID,STR?170
	CALL JIGS-UP,STR?171 >STACK
	RSTACK
?L20:	IN? SHINY-OBJECT,HERE \FALSE
	EQUAL? MOVES,LAST-MOVES /TRUE
	RANDOM 100 >STACK
	GRTR? 40,STACK \?L24
	PRINTI "Out of the corner of your eye, a small, shiny object appears in the sand. A moment later, it is gone!"
	CRLF
	JUMP ?L30
?L24:	RANDOM 100 >STACK
	GRTR? 70,STACK \?L27
	PRINTI "You catch a brief glimpse of something shiny in the sand."
	CRLF
	JUMP ?L30
?L27:	PRINTI "Something sparkling in the sand catches your eye for a moment."
	CRLF
?L30:	SET 'LAST-MOVES,MOVES
	RETURN LAST-MOVES

	.FUNCT I-IN-LAKE
	EQUAL? HERE,IN-LAKE \FALSE
	PRINTI "You run out of air and return to the surface."
	CRLF
	CALL GOTO,ON-LAKE >STACK
	RSTACK

	.FUNCT ON-LAKE-F,RARG
	EQUAL? RARG,M-ENTER \?L1
	CALL QUEUE,I-IN-LAKE,0
	ZERO? LAKE-POINT \FALSE
	INC 'SCORE
	SET 'LAKE-POINT,1
	RETURN LAKE-POINT
?L1:	EQUAL? RARG,M-BEG \FALSE
	EQUAL? PRSA,V?LEAP \FALSE
	ZERO? PRSO \FALSE
	CALL DO-WALK,P?DOWN
	RTRUE

	.FUNCT GO-ON-LAKE,F,N,TOLD=0
	FIRST? WINNER >F \?L4
?L3:	NEXT? F >N /?L5
?L5:	FSET? F,WEARBIT /?L13
	MOVE F,IN-LAKE
	EQUAL? F,TORCH \?L8
	REMOVE TORCH
	MOVE FRIED-TORCH,IN-LAKE
	JUMP ?L11
?L8:	EQUAL? F,LAMP \?L10
	MOVE LAMP,LOCAL-GLOBALS
	MOVE FRIED-LAMP,IN-LAKE
	SET 'CURRENT-LAMP,FRIED-LAMP
	JUMP ?L11
?L10:	EQUAL? F,WAYBREAD \?L11
	REMOVE WAYBREAD
?L11:	ZERO? TOLD \?L13
	SET 'TOLD,1
	PRINTI "The shock of entering the frigid water has made you drop all your possessions into the lake!"
	CRLF
	CALL PRINT-ID,STR?172
?L13:	ZERO? N /?L4
	SET 'F,N
	JUMP ?L3
?L4:	ZERO? TOLD \?L23
	PRINTI "You are nearly paralyzed by the icy waters as you swim into the center of the lake."
	CRLF
?L23:	CRLF
	CALL GOTO,ON-LAKE
	SET 'LAKE-TIME,0
	CALL QUEUE,I-ON-LAKE,-1 >STACK
	PUT STACK,0,1
	RTRUE

	.FUNCT I-ON-LAKE
	INC 'LAKE-TIME
	RANDOM 100 >STACK
	GRTR? 10,STACK \?L1
	EQUAL? HERE,ON-LAKE \?L1
	ZERO? INVIS \?L1
	PRINTI "A giant roc, previously hidden among the rocks, is heading right toward you, its mouth gaping wide!"
	CRLF
	CALL QUEUE,I-ROC,2 >STACK
	PUT STACK,0,1
	RTRUE
?L1:	EQUAL? HERE,ON-LAKE,IN-LAKE /?L5
	CALL QUEUE,I-ON-LAKE,0
	CALL QUEUE,I-IN-LAKE,0
	CALL QUEUE,I-ROC,0
	RFALSE
?L5:	EQUAL? LAKE-TIME,4 \?L6
	PRINTR "The icy waters are taking their toll. You will not be able to hold out much longer."
?L6:	EQUAL? LAKE-TIME,6 \?L9
	PRINTR "You are becoming very weak. You had better leave the water before you drown!"
?L9:	EQUAL? LAKE-TIME,8 \FALSE
	CALL QUEUE,I-ON-LAKE,0
	CALL QUEUE,I-IN-LAKE,0
	CALL QUEUE,I-ROC,0
	CALL PRINT-ID,STR?173
	CALL JIGS-UP,STR?174 >STACK
	RSTACK

	.FUNCT I-ROC
	EQUAL? HERE,ON-LAKE \FALSE
	ZERO? INVIS \FALSE
	CALL QUEUE,I-ON-LAKE,0
	CALL QUEUE,I-IN-LAKE,0
	CALL PRINT-ID,STR?175
	CALL JIGS-UP,STR?176 >STACK
	RSTACK

	.FUNCT SHINY-OBJECT-F
	EQUAL? PRSA,V?FIND,V?TAKE \FALSE
	IN? AMULET,WINNER /FALSE
	RANDOM 100 >STACK
	GRTR? 50,STACK \?L3
	REMOVE SHINY-OBJECT
	MOVE AMULET,WINNER
	CALL THIS-IS-IT,AMULET
	FCLEAR AMULET,NDESCBIT
	PRINTR "You reach the shiny object. It is a simple golden amulet!"
?L3:	PRINTR "The shiny object slips from your grasp and back onto the floor of the lake, where it is covered in sand."

	.FUNCT SAND-F
	EQUAL? PRSA,V?DIG \?L1
	PRINTR "You don't come across anything unusual."
?L1:	EQUAL? PRSA,V?EXAMINE \?L5
	PRINTR "There is nothing notable on the floor of the lake, except some plants and algae."
?L5:	EQUAL? PRSA,V?TAKE \FALSE
	PRINTR "It slips through your fingers."

	.FUNCT ALGAE-F
	EQUAL? PRSA,V?EAT \FALSE
	PRINTI "Yeecchhhh!"
	CRLF
	CALL PRINT-ID,STR?177 >STACK
	RSTACK

	.FUNCT FRIED-LAMP-F
	EQUAL? PRSA,V?LAMP-ON \FALSE
	PRINTR "The lamp isn't functioning (probably from having gotten wet)."

	.FUNCT I-VIEW-SNAP
	PRINTI "You suddenly find yourself back in the viewing room!"
	CRLF
	CALL GOTO,VIEW-ROOM,0
	RTRUE

	.FUNCT VIEWING-TABLE-F,L
	EQUAL? PRSA,V?RUB \?L1
	ADD SCORE,VIEW-POINT >SCORE
	SET 'VIEW-POINT,0
	PRINTI "You touch the table and are instantly transported to another place!"
	CRLF
	CRLF
	CALL QUEUE,I-VIEW-SNAP,3 >STACK
	PUT STACK,0,1
	GET VIEW-ROOMS,ACTIVE-VIEW >STACK
	CALL GOTO,STACK
	RTRUE
?L1:	EQUAL? PRSA,V?LOOK-INSIDE,V?EXAMINE \FALSE
	PRINTI "The surface is pale and featureless, but slowly, an image takes shape!"
	CRLF
	GET VIEWS,ACTIVE-VIEW >STACK
	PRINT STACK
	CRLF
	PRINTR "The image slowly fades."

	.FUNCT I-VIEW-CHANGE
	INC 'ACTIVE-VIEW
	EQUAL? ACTIVE-VIEW,5 \?L1
	SET 'ACTIVE-VIEW,1
?L1:	CALL QUEUE,I-VIEW-CHANGE,4
	EQUAL? HERE,VIEW-ROOM \FALSE
	PRINTI "The indicator above the table flickers briefly, then changes to """
	GET VIEW-ROMANS,ACTIVE-VIEW >STACK
	PRINT STACK
	PRINTR """."

	.FUNCT VIEW-ROOM-F,RARG
	EQUAL? RARG,M-LOOK \FALSE
	PRINTI "You are in a small chamber carved in the rock, with the sole exit to the north. Mounted on one wall is a table labelled ""Scenic Vista,"" whose featureless surface is angled toward you. One might believe that the table was used to indicate points of interest in the view from this spot, like those found in many parks. On the other hand, your surroundings are far from spacious and by no stretch of the imagination could this spot be considered scenic. An indicator above the table reads """
	GET VIEW-ROMANS,ACTIVE-VIEW >STACK
	PRINT STACK
	PRINTR """."

	.FUNCT CLIFF-OBJECT-F
	EQUAL? HERE,CLIFF \?L1
	EQUAL? PRSA,V?LEAP \?L3
	CALL PRINT-ID,STR?178
	CALL JIGS-UP,STR?179 >STACK
	RSTACK
?L3:	EQUAL? PRSA,V?CLIMB-DOWN \?L5
	ZERO? ROPE-FLAG /?L6
	CALL GOTO,CLIFF-LEDGE
	RTRUE
?L6:	PRINTI "The fall would kill you."
	CRLF
	CALL PRINT-ID,STR?180 >STACK
	RSTACK
?L5:	EQUAL? PRSA,V?THROW-OFF \FALSE
	EQUAL? PRSI,CLIFF-OBJECT \FALSE
	EQUAL? PRSO,ROPE \?L12
	PRINTR "The rope is dangling over the side of the cliff already."
?L12:	IN? PRSO,WINNER /?L16
	PRINTI "You aren't holding the "
	PRINTD PRSO
	PRINTR "."
?L16:	MOVE PRSO,CLIFF-LEDGE
	PRINTI "The "
	PRINTD PRSO
	PRINTI " goes over the cliff and lands among the rocks below."
	CRLF
	EQUAL? PRSO,LAMP \?L22
	REMOVE PRSO
	MOVE BROKEN-LAMP,CLIFF-LEDGE
	SET 'CURRENT-LAMP,BROKEN-LAMP
	RTRUE
?L22:	EQUAL? PRSO,STAFF \TRUE
	REMOVE PRSO
	MOVE BROKEN-STAFF,CLIFF-LEDGE
	RTRUE
?L1:	EQUAL? PRSA,V?CLIMB-UP \?L27
	PRINTR "You haven't enough strength to climb the cliff."
?L27:	PRINTR "The cliff is above you!"

	.FUNCT TREE-F
	EQUAL? PRSA,V?CLIMB-FOO,V?CLIMB-UP \?L1
	PRINTR "The trunks are too large for you to climb them."
?L1:	EQUAL? PRSA,V?LOOK-INSIDE,V?EXAMINE \?L5
	ZERO? MAN-SEEN \?L5
	PRINTR "There seems to be nobody there, but it's hard to tell."
?L5:	EQUAL? PRSA,V?BURN \FALSE
	CALL PRINT-ID,STR?181
	CALL JIGS-UP,STR?182 >STACK
	RSTACK

	.FUNCT FRIED-TORCH-F
	EQUAL? PRSA,V?LAMP-ON \FALSE
	PRINTR "It's hopeless. The torch is wet."

	.FUNCT TORCH-F
	EQUAL? PRSA,V?LAMP-ON \?L1
	FSET? TORCH,ONBIT \?L3
	PRINTR "It's already lit."
?L3:	PRINTR "You have nothing to light it with."
?L1:	EQUAL? PRSA,V?LAMP-OFF \FALSE
	FSET? TORCH,ONBIT \?L11
	PRINTI "You manage to extinguish the flame."
	CRLF
	FCLEAR TORCH,ONBIT
	RTRUE
?L11:	PRINTR "It has already been extinguished."

	.FUNCT NO-OBJS,RARG,F
	EQUAL? RARG,M-BEG \FALSE
	FIRST? WINNER >F /?L3
?L3:	SET 'EMPTY-HANDED,1
	ZERO? F /FALSE
?L6:	CALL WEIGHT,F >STACK
	GRTR? STACK,4 \?L8
	SET 'EMPTY-HANDED,0
	RFALSE
?L8:	NEXT? F >F /?L6
	RFALSE

	.FUNCT REPELLENT-FCN
	EQUAL? PRSA,V?SHAKE \?L1
	ZERO? SPRAY-USED? /?L3
	PRINTR "The can seems empty."
?L3:	PRINTR "There is a sloshing sound from inside."
?L1:	EQUAL? PRSA,V?BURN \?L10
	CALL PRINT-ID,STR?183
	CALL JIGS-UP,STR?184 >STACK
	RSTACK
?L10:	EQUAL? PRSA,V?PUT-ON,V?SPRAY \FALSE
	EQUAL? PRSO,REPELLENT \FALSE
	ZERO? SPRAY-USED? /?L12
	PRINTR "The repellent is all gone."
?L12:	ZERO? PRSI \?L16
	SET 'SPRAY-USED?,1
	PRINTR "The spray stinks amazingly for a few moments, then drifts away."
?L16:	EQUAL? PRSI,ME \?L20
	CALL QUEUE,I-SPRAY,5 >STACK
	PUT STACK,0,1
	SET 'SPRAYED?,1
?L20:	SET 'SPRAY-USED?,1
	PRINTR "The spray smells like a mixture of old socks and burning rubber. If I were a grue I'd sure stay clear!"

	.FUNCT I-SPRAY
	SET 'SPRAYED?,0
	PRINTR "That horrible smell is much less pungent now."

	.FUNCT ZORK-IV-F,RARG
	EQUAL? RARG,M-ENTER \FALSE
	CALL PRINT-ID,STR?185
	CALL JIGS-UP,STR?186 >STACK
	RSTACK

	.FUNCT AQUEDUCT-F
	EQUAL? PRSA,V?EXAMINE \?L1
	PRINTR "The aqueduct is large and impressive. It was probably the major method of water transport in the Empire."
?L1:	EQUAL? PRSA,V?LEAP \FALSE
	CALL PRINT-ID,STR?187
	CALL JIGS-UP,STR?188 >STACK
	RSTACK

	.FUNCT WATER-CHANNEL-F
	EQUAL? PRSA,V?EXAMINE \?L1
	PRINTR "The channel is a few feet deep and ten feet wide, rounded on the bottom."
?L1:	EQUAL? PRSA,V?BOARD \FALSE
	EQUAL? HERE,DAMP-PASSAGE \?L6
	PRINTR "Getting into the channel wouldn't be of much use."
?L6:	PRINTR "You're standing in it. Otherwise, you would be floating in midair above some very nasty rocks."

	.FUNCT MOSS-F
	EQUAL? PRSA,V?MOVE,V?TAKE \FALSE
	PRINTI "Don't be silly."
	CRLF
	CALL PRINT-ID,STR?189 >STACK
	RSTACK

	.FUNCT AQ-2-F,RARG
	EQUAL? RARG,M-LOOK \FALSE
	PRINTI "You are now on one of the tallest arches of the aqueduct, hundreds of feet above a rocky chasm. The immensity of the aqueduct project is apparent from here. Stone supports rise from the rock floor to form massive arches, which traverse the region from north to south. The water-carrying channel here is wide and deep. To the west and far below, you can make out a balcony which must command a wide view of the aqueduct."
	CRLF
	ZERO? AQ-FLAG \FALSE
	PRINTR "The channel ends abruptly to your north where a supporting pillar has crumbled, casting the arch into the chasm."

	.FUNCT AQ-3-F,RARG
	EQUAL? RARG,M-LOOK \FALSE
	PRINTI "You are near the northern end of this segment of the aqueduct system. To the south and slightly uphill, the bulk of the aqueduct looms ominously, towering above a gorge. To the north, the water channel drops precipitously and enters a rocky hole. The damp moss and lichen would certainly make that a one-way trip."
	CRLF
	ZERO? AQ-FLAG \FALSE
	PRINTR "The southern part of the aqueduct system is inaccessible due to the collapse of one of the water-bearing arches."

	.FUNCT COVER-F
	EQUAL? PRSA,V?OPEN,V?RAISE,V?MOVE \?L1
	PRINTI "The cover is moved a bit to one side, revealing a small hole leading into darkness."
	CRLF
	SET 'COVER-MOVED,1
	RETURN COVER-MOVED
?L1:	EQUAL? PRSA,V?TAKE \FALSE
	PRINTR "The cover is far too heavy to take."

	.FUNCT KEY-ROOM-F,RARG
	EQUAL? RARG,M-LOOK \FALSE
	PRINTI "You are between some rock and a dark place. The room is lit dimly from above, revealing a lone, dark path sloping down to the west."
	CRLF
	ZERO? COVER-MOVED /?L5
	PRINTR "A heavy manhole cover has been moved to reveal a dark passage below."
?L5:	PRINTR "To one side of the room is a large manhole cover."

	.FUNCT KEY-F
	EQUAL? PRSA,V?UNLOCK \?L1
	EQUAL? PRSI,KEY \?L1
	EQUAL? PRSO,BRONZE-DOOR \?L12
	EQUAL? HERE,GOOD-CELL \?L3
	ZERO? BRONZE-DOOR-LOCKED /?L5
	PRINTI "The key seems to mold itself to the shape of the lock. With a mere twist of your hand, the massive bolt gives way."
	CRLF
	JUMP ?L9
?L5:	PRINTI "It already is."
	CRLF
?L9:	SET 'BRONZE-DOOR-LOCKED,0
	RTRUE
?L3:	EQUAL? PRSO,BRONZE-DOOR \?L12
	PRINTR "The key molds itself to the lock but will not turn."
?L12:	EQUAL? PRSO,CHEST /?L16
	FSET? PRSO,DOORBIT \FALSE
?L16:	PRINTR "The key, which initially seemed certain to fit the lock, seems to change shape and will not enter the keyhole."
?L1:	EQUAL? PRSA,V?EXAMINE \FALSE
	CALL PICK-ONE,KEY-DESCS >STACK
	PRINT STACK
	CRLF
	PRINTR "Strange, though. The key seems to change shape constantly."

	.FUNCT VIEW-INDICATOR-F
	EQUAL? PRSA,V?READ,V?EXAMINE \FALSE
	PRINTI "The indicator reads """
	GET VIEW-ROMANS,ACTIVE-VIEW >STACK
	PRINT STACK
	PRINTR """."

	.FUNCT FLATHEAD-OCEAN-F,RARG
	EQUAL? RARG,M-LOOK \?L1
	PRINTI "You are at the shore of an amazing underground sea, the topic of many a legend among adventurers. Few were known to have arrived at this spot, and fewer to return. There is a heavy surf and a breeze is blowing onshore. The land rises steeply to the east and quicksand prevents movement to the south. A thick mist covers the ocean and extends over the hills to the east. A path heads north along the beach."
	CRLF
	FSET? VIKING-SHIP,INVISIBLE /TRUE
	PRINTR "An ancient Viking ship is passing along the shore, an old and crusty sailor at the helm."
?L1:	EQUAL? RARG,M-END \FALSE
	RANDOM 100 >STACK
	GRTR? 20,STACK \FALSE
	ZERO? BOAT-SEEN \FALSE
	ZERO? LIT /FALSE
	SET 'BOAT-SEEN,1
	CALL QUEUE,I-BOAT-DISAPPEAR,2 >STACK
	PUT STACK,0,1
	PRINTI "Passing alongside the shore now is an old boat, reminiscent of an ancient Viking ship. Standing on the prow of the ship is an old and crusty sailor, peering out over the misty ocean."
	CRLF
	FCLEAR VIKING-SHIP,INVISIBLE
	RTRUE

	.FUNCT I-BOAT-DISAPPEAR
	FSET VIKING-SHIP,INVISIBLE
	SET 'SHIP-GONE,1
	EQUAL? HERE,FLATHEAD-OCEAN \FALSE
	PRINTR "The boat sails silently through the mist and out of sight."

	.FUNCT I-VISIBLE
	SET 'INVIS,0
	EQUAL? HERE,MRG,MRGE,MRGW \FALSE
	CALL PRINT-ID,STR?190
	CALL JIGS-UP,STR?191
	RFALSE

	.FUNCT POTION-F
	EQUAL? PRSA,V?DRINK \?L1
	REMOVE POTION
	SET 'INVIS,1
	CALL QUEUE,I-VISIBLE,3 >STACK
	PUT STACK,0,1
	PRINTR "You ""drink"" the contents in one gulp, but nothing unusual seems to have happened as a result."
?L1:	EQUAL? PRSA,V?POUR-ON \?L5
	EQUAL? PRSO,POTION \?L5
	REMOVE POTION
	PRINTI "It spills onto the "
	PRINTD PRSI
	PRINTI " and vanishes."
	CRLF
	CALL PRINT-ID,STR?192 >STACK
	RSTACK
?L5:	EQUAL? PRSA,V?EXAMINE \?L8
	PRINTR "It feels like there's something inside, but you can't see anything even though the vial is transparent."
?L8:	EQUAL? PRSA,V?SMELL \?L11
	PRINTR "The vial (or something in it) smells sweet."
?L11:	EQUAL? PRSA,V?TAKE,V?DROP \FALSE
	PRINTI "Nothing seems to come out, although the sweet smell disappears from the vial, seeming to permeate the air briefly before fading entirely."
	CRLF
	REMOVE POTION
	RTRUE

	.FUNCT VIAL-F
	EQUAL? PRSA,V?FILL \?L1
	PRINTR "You can't seem to put anything in it."
?L1:	EQUAL? PRSA,V?DRINK-FROM \?L5
	IN? POTION,VIAL \?L5
	CALL PERFORM,V?DRINK,POTION
	RTRUE
?L5:	EQUAL? PRSA,V?SMELL \?L6
	IN? POTION,VIAL \?L6
	CALL PERFORM,V?SMELL,POTION
	RTRUE
?L6:	EQUAL? PRSA,V?SHAKE \?L7
	IN? POTION,VIAL \?L7
	FSET? VIAL,OPENBIT \?L7
	PRINTI "Nothing seems to come out, although the vial is lighter now."
	CRLF
	REMOVE POTION
	RTRUE
?L7:	EQUAL? PRSA,V?OPEN \?L10
	FSET VIAL,OPENBIT
	PRINTI "The vial is open."
	IN? POTION,VIAL \?L13
	PRINTI " There is a sweet odor from within the vial, apparently coming from a heavy but invisible liquid."
?L13:	CRLF
	RTRUE
?L10:	EQUAL? PRSA,V?EXAMINE \FALSE
	PRINTI "It is a small, transparent vial "
	IN? POTION,VIAL \?L21
	PRINTR "which looks empty but is strangely heavy."
?L21:	PRINTR "which is light and empty."

	.FUNCT OCEAN-F
	EQUAL? HERE,FLATHEAD-OCEAN /?L1
	PRINTR "There is no ocean here."
?L1:	EQUAL? PRSA,V?BOARD,V?THROUGH \?L5
	PRINTI "You would be killed by the pounding surf!"
	CRLF
	CALL PRINT-ID,STR?193 >STACK
	RSTACK
?L5:	EQUAL? PRSA,V?THROW,V?PUT \FALSE
	EQUAL? PRSI,OCEAN \FALSE
	PRINTI "The "
	PRINTD PRSO
	PRINTI " falls into the ocean and is lost forever."
	CRLF
	REMOVE PRSO
	RTRUE

	.FUNCT STONE-DESC,FOO
	PRINTI "Standing before you is a great rock."
	ZERO? SWORD-IN-STONE? /?L3
	PRINTI " Imbedded within it is an Elvish sword."
?L3:	CRLF
	RTRUE

	.FUNCT STONE-F
	EQUAL? PRSA,V?CLOSE,V?OPEN \?L1
	PRINTR "You can't be serious."
?L1:	EQUAL? PRSA,V?PUT \?L5
	EQUAL? PRSI,STONE \?L5
	PRINTR "You can't force anything into the stone."
?L5:	EQUAL? PRSA,V?PUSH,V?TAKE,V?MOVE \?L8
	EQUAL? PRSO,STONE \?L8
	PRINTR "The stone is far too massive to be moved."
?L8:	EQUAL? PRSA,V?LOOK-UNDER \FALSE
	PRINTR "Since it can't be moved, it's hard to know what's there."

	.FUNCT FISH-F
	PRINTR "There is no fish visible now."

	.FUNCT QUICKSAND-PSEUDO
	EQUAL? PRSA,V?LEAP,V?THROUGH \?L1
	CALL PRINT-ID,STR?194
	CALL JIGS-UP,STR?195 >STACK
	RSTACK
?L1:	EQUAL? PRSA,V?RUB \?L3
	PRINTR "It's quicksand all right!"
?L3:	EQUAL? PRSA,V?LOOK-INSIDE \FALSE
	PRINTR "It's hard to tell what's in there."

	.FUNCT SWAMP-PSEUDO
	EQUAL? PRSA,V?THROUGH \FALSE
	PRINTI "Yucko."
	CRLF
	CALL PRINT-ID,STR?196 >STACK
	RSTACK

	.FUNCT MIST-PSEUDO
	EQUAL? PRSA,V?LOOK-INSIDE \?L1
	PRINTR "You can't make anything out through the mist."
?L1:	EQUAL? PRSA,V?SMELL \FALSE
	PRINTR "It smells vaguely salty."

	.FUNCT SHORE-PSEUDO
	EQUAL? PRSA,V?DIG \FALSE
	PRINTR "There's nothing there."

	.FUNCT WATERFALL-PSEUDO
	EQUAL? PRSA,V?CLIMB-UP \FALSE
	PRINTR "It's much too slippery."

	.FUNCT ARCH-PSEUDO
	EQUAL? PRSA,V?EXAMINE \FALSE
	ZERO? AQ-FLAG /?L3
	PRINTR "The arches all show some signs of decay."
?L3:	PRINTR "The arch before you is broken. The others show signs of decay."

	.INSERT "./new_experimental_env/testing_games/zork3/zork3_str"
	.END
